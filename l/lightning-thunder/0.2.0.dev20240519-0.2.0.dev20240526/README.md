# Comparing `tmp/lightning_thunder-0.2.0.dev20240519.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240526.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240519.tar", last modified: Sun May 19 00:21:01 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240526.tar", last modified: Sun May 26 00:21:05 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240519.tar` & `lightning_thunder-0.2.0.dev20240526.tar`

### file list

```diff
@@ -1,103 +1,103 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.943939 lightning_thunder-0.2.0.dev20240519/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-19 00:21:01.943939 lightning_thunder-0.2.0.dev20240519/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.939939 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2503 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.923939 lightning_thunder-0.2.0.dev20240519/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-19 00:21:01.943939 lightning_thunder-0.2.0.dev20240519/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.923939 lightning_thunder-0.2.0.dev20240519/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-19 00:21:01.000000 lightning_thunder-0.2.0.dev20240519/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    34699 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.927939 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   102923 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22406 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    25820 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11229 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.927939 lightning_thunder-0.2.0.dev20240519/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    64679 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2555 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    32604 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.931939 lightning_thunder-0.2.0.dev20240519/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    15070 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    59518 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4484 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     5045 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/module.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   124824 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    50626 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    12551 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   141486 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37505 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.931939 lightning_thunder-0.2.0.dev20240519/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.931939 lightning_thunder-0.2.0.dev20240519/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    26699 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    11729 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.931939 lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    33464 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4629 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/fsdp_v2.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.935939 lightning_thunder-0.2.0.dev20240519/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.935939 lightning_thunder-0.2.0.dev20240519/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    75956 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    14135 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    13057 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    85148 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24891 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.935939 lightning_thunder-0.2.0.dev20240519/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.939939 lightning_thunder-0.2.0.dev20240519/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-19 00:21:01.939939 lightning_thunder-0.2.0.dev20240519/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   162697 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2889 2024-05-19 00:20:59.000000 lightning_thunder-0.2.0.dev20240519/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2503 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.471341 lightning_thunder-0.2.0.dev20240526/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.471341 lightning_thunder-0.2.0.dev20240526/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34699 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.475341 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102923 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23134 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25820 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11229 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.475341 lightning_thunder-0.2.0.dev20240526/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    64679 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2555 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32604 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15070 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59756 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4484 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5045 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/module.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   124800 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    50019 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12551 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   142273 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37505 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    26793 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11729 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.483341 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33464 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4629 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp_v2.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.483341 lightning_thunder-0.2.0.dev20240526/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    76235 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14135 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13131 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    85990 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24891 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   166423 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2889 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240519/LICENSE` & `lightning_thunder-0.2.0.dev20240526/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240526/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/PKG-INFO` & `lightning_thunder-0.2.0.dev20240526/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240519
+Version: 0.2.0.dev20240526
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -54,16 +54,16 @@
 Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240519
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240526
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
```

### Comparing `lightning_thunder-0.2.0.dev20240519/README.md` & `lightning_thunder-0.2.0.dev20240526/README.md`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240519
+Version: 0.2.0.dev20240526
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -54,16 +54,16 @@
 Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240519/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240519
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240526
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
```

### Comparing `lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240526/requirements/test.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/setup.py` & `lightning_thunder-0.2.0.dev20240526/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 2% similar despite different names*

```diff
@@ -40,20 +40,25 @@
     use_fused = fused_available and device_type == "cuda"
     optimizer = torch.optim.AdamW(
         model.parameters(), lr=learning_rate, weight_decay=weight_decay, betas=betas, fused=use_fused
     )
     return optimizer
 
 
-def run_fwd_bwd_one_microbatch(
+# NOTE(crcrpar): Calling this method seems to bloat the memory consumption to some extent.
+# e.g. ref: https://github.com/Lightning-AI/lightning-thunder/issues/439
+def _run_fwd_bwd_one_microbatch(
     model: torch.nn.Module,
     input_ids: torch.Tensor,
     targets: torch.Tensor,
     gradient_accumulation_steps: int,
+    device: torch.device,
 ) -> torch.Tensor:
+    input_ids = input_ids.to(device)
+    targets = targets.to(device)
     logits = model(input_ids)
     logits = logits.reshape(-1, logits.size(-1))
     targets = targets.reshape(-1)
     loss = torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1) / gradient_accumulation_steps
     loss.backward()
     return loss
 
@@ -390,23 +395,35 @@
             if self.nsys_enabled and i == self.profiler_start and global_rank in [0, None]:
                 print("=====Start NSYS Profiling======")
                 torch.cuda.cudart().cudaProfilerStart()
 
             with data_sync_ctx():
                 for step_idx in range(self.gradient_accumulation_steps - 1):
                     input_ids, targets = next(self.train_data_iter)
-                    input_ids = input_ids.to(device=self.device)
-                    targets = targets.to(device=self.device)
-
-                    loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps)
+                    input_ids = input_ids.to(self.device)
+                    targets = targets.to(self.device)
+                    logits = self.model(input_ids)
+                    logits = logits.reshape(-1, logits.size(-1))
+                    targets = targets.reshape(-1)
+                    loss = (
+                        torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1)
+                        / self.gradient_accumulation_steps
+                    )
+                    loss.backward()
 
             input_ids, targets = next(self.train_data_iter)
-            input_ids = input_ids.to(device=self.device)
-            targets = targets.to(device=self.device)
-            loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps)
+            input_ids = input_ids.to(self.device)
+            targets = targets.to(self.device)
+            logits = self.model(input_ids)
+            logits = logits.reshape(-1, logits.size(-1))
+            targets = targets.reshape(-1)
+            loss = (
+                torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1) / self.gradient_accumulation_steps
+            )
+            loss.backward()
 
             # Simple Gradient Accumulation Implementation
             self.optimizer.step()
             self.optimizer.zero_grad(set_to_none=True)
 
             if self.nsys_enabled and i == self.profiler_stop and global_rank in [0, None]:
                 print("=====Stop NSYS Profiling======")
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/targets.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/clang/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240526/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/common.py` & `lightning_thunder-0.2.0.dev20240526/thunder/common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/interpreter.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/jit_ext.py`

 * *Files 1% similar despite different names*

```diff
@@ -549,16 +549,18 @@
 
     def add_constraint(self, constraint):
         self._constraints.append(constraint)
 
     def proxify(self, value: WrappedValue) -> Any:
         assert isinstance(value, WrappedValue)
         uvalue = value.value
-        if isinstance(uvalue, Proxy):
-            return p
+        # Sequence / dict is not registered as Proxy
+        # avoid double registration by skipping if value has a registered proxy.
+        if isinstance(uvalue, Proxy) or value.original_value is not value.nothing:
+            return uvalue
         elif isinstance(uvalue, torch.Tensor):
             # we always want to proxy torch.Tensor, even const
 
             name_postfix = _infer_name_postfix_from_provenance(value.provenance)
             if name_postfix:
                 name = f"t{name_postfix}"
             else:
@@ -613,25 +615,27 @@
             for an, av in value.attribute_wrappers.items():
                 if callable(av.value):
                     av.register_proxy(getattr(proxy_d, an))
                 else:
                     raise NotImplementedError(
                         f"proxify {type(uvalue).__name__} with attribute {an} of type {type(av.value).__name__}"
                     )
+            return proxy_d
         elif isinstance(uvalue, Sequence):
             value.track_items()
             proxy_s = type(uvalue)(i.value for i in value.item_wrappers)
             value.register_proxy(proxy_s)
             for an, av in value.attribute_wrappers.items():
                 if callable(av.value):
                     av.register_proxy(getattr(proxy_s, an))
                 else:
                     raise NotImplementedError(
                         f"proxify {type(uvalue).__name__} with attribute {an} of type {type(av.value).__name__}"
                     )
+            return proxy_s
         else:
             raise ValueError("cannot proxify value of {type(uvalue).__type} objects")
 
 
 general_jit_callbacks: dict[INTERPRETER_CALLBACKS, Callable] = {}
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/module.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/module.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/prims.py`

 * *Files 0% similar despite different names*

```diff
@@ -251,15 +251,14 @@
     MATMUL = auto()
     # NN prims (Experimental!)
     CONVOLUTION = auto()
     EMBEDDING = auto()
     EMBEDDING_BACKWARD = auto()
     LINEAR = auto()
     PAD = auto()
-    BATCH_NORM = auto()
     # Memory access methods
     ITEM = auto()
     COPY_ = auto()
 
 
 class OpTags(Enum):
     # TODO -- Consider renaming this tag
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/proxies.py`

 * *Files 2% similar despite different names*

```diff
@@ -13,15 +13,15 @@
 import torch
 
 from thunder.core.compile_data import using_symbolic_values, using_jit
 from thunder.core.interpreter import is_jitting
 from thunder.core.trace import VariableInterface, get_tracectx, TraceCtx
 from thunder.core.baseutils import ProxyInterface, NumberProxyInterface, TensorProxyInterface
 import thunder.core.baseutils as baseutils
-from thunder.core.langctxs import resolve_method, get_langctx, LanguageContext
+from thunder.core.langctxs import resolve_method, get_langctx
 import thunder.core.devices as devices
 import thunder.core.dtypes as dtypes
 
 ShapeLike = Sequence[int]
 
 
 # TODO Document this class
@@ -588,51 +588,34 @@
     # Elementwise unary operators
     #
 
     # name is the name of the operation in the number language context to perform
     # fn is the function to call if executing outside a language context
     @staticmethod
     def _elementwise_unary_helper(a, name, fn, type_promotion_kind=None):
-        trace: None | TraceCtx = get_tracectx()
-
-        langctx: None | LanguageContext
-        try:
-            langctx = get_langctx()
-        except LookupError as le:
-            langctx = None
 
         vala = pyval(a)
 
-        if trace is None:
-            # Outside of a trace context, operations on NumberProxies are executed by the
-            #   Python interpreter
-
+        trace: None | TraceCtx = get_tracectx()
+        lang: None | LangCtx = None
+        try:
+            lang = get_langctx()
+        except LookupError:
+            pass
+        if trace is None or lang is None:
+            # Outside of a trace or language context, operations on NumberProxies are
+            #   executed by the Python interpreter
             baseutils.check(
                 vala is not None,
                 lambda: f"Trying to {name} a number with an unknown value",
                 exception_type=AssertionError,
             )
             return fn(vala)
 
-        if using_jit():
-            method: Callable = resolve_method(name, a)
-            return method(a)
-
-        # NOTE not using_jit
-        #   This is a legacy path to temporarily support developing older components, and will be removed
-        #   in the near future. It fallsback to executing the operation using the Python interpreter
-        #   if no method can be found.
-        try:
-            method = resolve_method(name, a)
-        except Exception as e:
-            return fn(vala)
-
-        if method is None:
-            return fn(vala)
-
+        method = resolve_method(name, a)
         return method(a)
 
     def __abs__(self):
         return self._elementwise_unary_helper(self, "abs", builtins.abs)
 
     # See https://docs.python.org/3/reference/datamodel.html#object.__ceil__
     def __ceil__(self):
@@ -667,38 +650,34 @@
     def _elementwise_binary_helper(a, b, name, fn, type_promotion_kind=None):
         baseutils.check_type(b, (Number, NumberProxy, TensorProxy))
 
         vala = pyval(a)
         valb = pyval(b) if isinstance(b, NumberProxy) else b
 
         trace: None | TraceCtx = get_tracectx()
-        if trace is None:
+        lang: None | LangCtx = None
+        try:
+            lang = get_langctx()
+        except LookupError:
+            pass
+        if trace is None or lang is None:
             # Outside of a trace or language context, binary operations on NumberProxies are
             #   executed by the Python interpreter
+            baseutils.check(
+                vala is not None and valb is not None,
+                lambda: f"Trying to {name} numbers with unknown values",
+                exception_type=AssertionError,
+            )
             return fn(vala, valb)
 
         if is_jitting():
             fn: Callable = resolve_method(name, a, b)
             return fn(a, b)
 
-        # NOTE not using_jit
-        #   This is a legacy path to temporarily support developing older components, and will be removed
-        #   in the near future
-        if isinstance(b, TensorProxy):
-            tensor_fn = resolve_method(name, a, b)
-            return tensor_fn(a, b)
-
-        try:
-            method = resolve_method(name, a, b)
-        except Exception as e:
-            return fn(vala, valb)
-
-        if method is None:
-            return fn(vala, valb)
-
+        method = resolve_method(name, a, b)
         return method(a, b)
 
     def __add__(self, other):
         return self._elementwise_binary_helper(self, other, "add", operator.add)
 
     def __radd__(self, other):
         return self._elementwise_binary_helper(other, self, "add", operator.add)
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/rematerialization.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/trace.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/transforms.py`

 * *Files 1% similar despite different names*

```diff
@@ -1774,7070 +1774,7120 @@
 00006ed0: 2067 2c20 6469 6d29 0a20 2020 2070 7574   g, dim).    put
 00006ee0: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
 00006ef0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
 00006f00: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
 00006f10: 2870 6964 732e 4741 5448 4552 2c20 5f67  (pids.GATHER, _g
 00006f20: 6174 6865 725f 7072 696d 5f67 7261 6429  ather_prim_grad)
 00006f30: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00006f40: 205f 7461 6b65 5f61 6c6f 6e67 5f61 7869   _take_along_axi
-00006f50: 735f 7072 696d 5f67 7261 6428 613a 2054  s_prim_grad(a: T
-00006f60: 656e 736f 7250 726f 7879 2c20 696e 6465  ensorProxy, inde
-00006f70: 783a 2054 656e 736f 7250 726f 7879 2c20  x: TensorProxy, 
-00006f80: 6469 6d3a 2069 6e74 2920 2d3e 2054 656e  dim: int) -> Ten
-00006f90: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-00006fa0: 6420 3d20 7072 696d 732e 7461 6b65 5f61  d = prims.take_a
-00006fb0: 6c6f 6e67 5f61 7869 7328 612c 2069 6e64  long_axis(a, ind
-00006fc0: 6578 2c20 6469 6d29 0a0a 2020 2020 6720  ex, dim)..    g 
-00006fd0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00006fe0: 2020 2020 2320 4e4f 5445 2049 6e74 656e      # NOTE Inten
-00006ff0: 7469 6f6e 616c 6c79 206e 6f74 2063 616c  tionally not cal
-00007000: 6c69 6e67 207a 6572 6f73 5f6c 696b 6520  ling zeros_like 
-00007010: 746f 2061 766f 6964 2070 7265 7365 7276  to avoid preserv
-00007020: 696e 6720 5465 6e73 6f72 5072 6f78 7920  ing TensorProxy 
-00007030: 612e 0a20 2020 2023 2054 4f44 4f20 5570  a..    # TODO Up
-00007040: 6461 7465 2074 6f20 6361 6c6c 206c 746f  date to call lto
-00007050: 7263 682e 7a65 726f 730a 2020 2020 7a65  rch.zeros.    ze
-00007060: 726f 7320 3d20 7072 696d 732e 6675 6c6c  ros = prims.full
-00007070: 2861 2e73 6861 7065 2c20 6669 6c6c 5f76  (a.shape, fill_v
-00007080: 616c 7565 3d30 2c20 6465 7669 6365 3d61  alue=0, device=a
-00007090: 2e64 6576 6963 652c 2064 7479 7065 3d61  .device, dtype=a
-000070a0: 2e64 7479 7065 290a 2020 2020 615f 6772  .dtype).    a_gr
-000070b0: 6164 203d 2070 7269 6d73 2e73 6361 7474  ad = prims.scatt
-000070c0: 6572 5f61 6464 287a 6572 6f73 2c20 696e  er_add(zeros, in
-000070d0: 6465 782c 2067 2c20 6469 6d29 0a20 2020  dex, g, dim).   
-000070e0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-000070f0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-00007100: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00007110: 6772 6164 2870 6964 732e 5441 4b45 5f41  grad(pids.TAKE_A
-00007120: 4c4f 4e47 5f41 5849 532c 205f 7461 6b65  LONG_AXIS, _take
-00007130: 5f61 6c6f 6e67 5f61 7869 735f 7072 696d  _along_axis_prim
-00007140: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
-00007150: 7478 0a64 6566 205f 7472 616e 7370 6f73  tx.def _transpos
-00007160: 655f 7072 696d 5f67 7261 6428 613a 2054  e_prim_grad(a: T
-00007170: 656e 736f 7250 726f 7879 2c20 7065 726d  ensorProxy, perm
-00007180: 7574 6174 696f 6e3a 2074 7570 6c65 5b69  utation: tuple[i
-00007190: 6e74 2c20 2e2e 2e5d 2920 2d3e 2054 656e  nt, ...]) -> Ten
-000071a0: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-000071b0: 6420 3d20 7072 696d 732e 7472 616e 7370  d = prims.transp
-000071c0: 6f73 6528 612c 2074 7570 6c65 2870 6572  ose(a, tuple(per
-000071d0: 6d75 7461 7469 6f6e 2929 0a0a 2020 2020  mutation))..    
-000071e0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-000071f0: 290a 2020 2020 756e 646f 203d 205f 6172  ).    undo = _ar
-00007200: 6773 6f72 7428 7065 726d 7574 6174 696f  gsort(permutatio
-00007210: 6e29 0a20 2020 2061 5f67 7261 6420 3d20  n).    a_grad = 
-00007220: 7072 696d 732e 7472 616e 7370 6f73 6528  prims.transpose(
-00007230: 672c 2074 7570 6c65 2875 6e64 6f29 290a  g, tuple(undo)).
-00007240: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00007250: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00007260: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00007270: 6572 5f67 7261 6428 7069 6473 2e54 5241  er_grad(pids.TRA
-00007280: 4e53 504f 5345 2c20 5f74 7261 6e73 706f  NSPOSE, _transpo
-00007290: 7365 5f70 7269 6d5f 6772 6164 290a 0a23  se_prim_grad)..#
-000072a0: 0a23 204d 656d 6f72 7920 6c61 796f 7574  .# Memory layout
-000072b0: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
-000072c0: 230a 0a0a 4074 6f72 6368 6374 780a 6465  #...@torchctx.de
-000072d0: 6620 5f73 7472 6964 655f 6f72 6465 725f  f _stride_order_
-000072e0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-000072f0: 736f 7250 726f 7879 2c20 2f2c 206f 7264  sorProxy, /, ord
-00007300: 6572 3a20 5365 7175 656e 6365 5b69 6e74  er: Sequence[int
-00007310: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
-00007320: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00007330: 6d73 2e73 7472 6964 655f 6f72 6465 7228  ms.stride_order(
-00007340: 612c 206f 7264 6572 290a 0a20 2020 2067  a, order)..    g
-00007350: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00007360: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00007370: 2067 290a 0a20 2020 2072 6574 7572 6e20   g)..    return 
-00007380: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00007390: 7261 6428 7069 6473 2e53 5452 4944 455f  rad(pids.STRIDE_
-000073a0: 4f52 4445 522c 205f 7374 7269 6465 5f6f  ORDER, _stride_o
-000073b0: 7264 6572 5f70 7269 6d5f 6772 6164 290a  rder_prim_grad).
-000073c0: 0a0a 230a 2320 456c 656d 656e 7477 6973  ..#.# Elementwis
-000073d0: 6520 756e 6172 7920 6f70 6572 6174 6f72  e unary operator
-000073e0: 2067 7261 6473 0a23 0a40 746f 7263 6863   grads.#.@torchc
-000073f0: 7478 0a64 6566 205f 6162 735f 7072 696d  tx.def _abs_prim
-00007400: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
-00007410: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-00007420: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
-00007430: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00007440: 3d20 7072 696d 732e 6162 7328 6129 0a0a  = prims.abs(a)..
-00007450: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007460: 2866 7764 290a 2020 2020 7075 745f 6772  (fwd).    put_gr
-00007470: 6164 2861 2c20 6720 2a20 6c74 6f72 6368  ad(a, g * ltorch
-00007480: 2e73 6967 6e28 6129 290a 0a20 2020 2072  .sign(a))..    r
-00007490: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-000074a0: 7374 6572 5f67 7261 6428 7069 6473 2e41  ster_grad(pids.A
-000074b0: 4253 2c20 5f61 6273 5f70 7269 6d5f 6772  BS, _abs_prim_gr
-000074c0: 6164 290a 0a0a 6465 6620 5f63 6f73 5f70  ad)...def _cos_p
-000074d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-000074e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000074f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007500: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007510: 7764 203d 2070 7269 6d73 2e63 6f73 2861  wd = prims.cos(a
-00007520: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00007530: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
-00007540: 5f67 7261 6428 612c 2067 202a 2028 2d70  _grad(a, g * (-p
-00007550: 7269 6d73 2e73 696e 2861 2929 290a 0a20  rims.sin(a))).. 
-00007560: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00007570: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007580: 6473 2e43 4f53 2c20 5f63 6f73 5f70 7269  ds.COS, _cos_pri
-00007590: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
-000075a0: 6374 780a 6465 6620 5f65 7266 5f70 7269  ctx.def _erf_pri
-000075b0: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
-000075c0: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
-000075d0: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
-000075e0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-000075f0: 203d 2070 7269 6d73 2e65 7266 2861 290a   = prims.erf(a).
-00007600: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00007610: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00007620: 6420 3d20 3220 2f20 6d61 7468 2e73 7172  d = 2 / math.sqr
-00007630: 7428 6d61 7468 2e70 6929 202a 206c 746f  t(math.pi) * lto
-00007640: 7263 682e 6578 7028 2d28 612a 2a32 2929  rch.exp(-(a**2))
-00007650: 202a 2067 0a20 2020 2070 7574 5f67 7261   * g.    put_gra
-00007660: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-00007670: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00007680: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00007690: 732e 4552 462c 205f 6572 665f 7072 696d  s.ERF, _erf_prim
-000076a0: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
-000076b0: 7478 0a64 6566 205f 6578 705f 7072 696d  tx.def _exp_prim
-000076c0: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
-000076d0: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-000076e0: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
-000076f0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00007700: 3d20 7072 696d 732e 6578 7028 6129 0a0a  = prims.exp(a)..
-00007710: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007720: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
-00007730: 203d 2067 202a 2066 7764 0a20 2020 2070   = g * fwd.    p
-00007740: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-00007750: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-00007760: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00007770: 6164 2870 6964 732e 4558 502c 205f 6578  ad(pids.EXP, _ex
-00007780: 705f 7072 696d 5f67 7261 6429 0a0a 0a40  p_prim_grad)...@
-00007790: 746f 7263 6863 7478 0a64 6566 205f 6c6f  torchctx.def _lo
-000077a0: 675f 7072 696d 5f67 7261 6428 613a 204e  g_prim_grad(a: N
-000077b0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-000077c0: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
-000077d0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-000077e0: 2020 6677 6420 3d20 7072 696d 732e 6c6f    fwd = prims.lo
-000077f0: 6728 6129 0a0a 2020 2020 6720 3d20 6765  g(a)..    g = ge
-00007800: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00007810: 615f 6772 6164 203d 2067 202f 2061 0a20  a_grad = g / a. 
-00007820: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
-00007830: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
-00007840: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00007850: 725f 6772 6164 2870 6964 732e 4c4f 472c  r_grad(pids.LOG,
-00007860: 205f 6c6f 675f 7072 696d 5f67 7261 6429   _log_prim_grad)
-00007870: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00007880: 205f 6e65 675f 7072 696d 5f67 7261 6428   _neg_prim_grad(
-00007890: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-000078a0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-000078b0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000078c0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-000078d0: 732e 6e65 6728 6129 0a0a 2020 2020 6720  s.neg(a)..    g 
-000078e0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-000078f0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00007900: 2d67 290a 0a20 2020 2072 6574 7572 6e20  -g)..    return 
-00007910: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00007920: 7261 6428 7069 6473 2e4e 4547 2c20 5f6e  rad(pids.NEG, _n
-00007930: 6567 5f70 7269 6d5f 6772 6164 290a 0a0a  eg_prim_grad)...
-00007940: 4074 6f72 6368 6374 780a 6465 6620 5f72  @torchctx.def _r
-00007950: 7371 7274 5f70 7269 6d5f 6772 6164 2861  sqrt_prim_grad(a
-00007960: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-00007970: 7250 726f 7879 2c20 2f29 202d 3e20 4e75  rProxy, /) -> Nu
-00007980: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007990: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-000079a0: 696d 732e 7273 7172 7428 6129 0a0a 2020  ims.rsqrt(a)..  
-000079b0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-000079c0: 7764 290a 2020 2020 2320 416e 2061 6c74  wd).    # An alt
-000079d0: 6572 6e61 7469 7665 2064 6572 6976 6174  ernative derivat
-000079e0: 696f 6e20 7573 6564 2062 7920 4a41 5820  ion used by JAX 
-000079f0: 6973 202d 302e 3520 2a20 6720 2a20 7273  is -0.5 * g * rs
-00007a00: 7172 7428 7829 202f 2078 0a20 2020 2023  qrt(x) / x.    #
-00007a10: 2077 6865 7265 2072 7371 7274 2878 2920   where rsqrt(x) 
-00007a20: 616e 6420 7820 6172 6520 7361 7665 6420  and x are saved 
-00007a30: 666f 7220 7468 6520 6261 636b 7761 7264  for the backward
-00007a40: 7320 7061 7373 2e0a 2020 2020 2320 5468  s pass..    # Th
-00007a50: 6973 2064 6572 6976 6174 696f 6e20 7761  is derivation wa
-00007a60: 7320 7365 6c65 6374 6564 2062 6563 6175  s selected becau
-00007a70: 7365 2069 7420 6176 6f69 6473 2073 6176  se it avoids sav
-00007a80: 696e 6720 7468 6520 696e 7075 7420 7465  ing the input te
-00007a90: 6e73 6f72 2e0a 2020 2020 615f 6772 6164  nsor..    a_grad
-00007aa0: 203d 202d 302e 3520 2a20 6720 2a20 6677   = -0.5 * g * fw
-00007ab0: 642a 2a33 2e30 0a20 2020 2070 7574 5f67  d**3.0.    put_g
-00007ac0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-00007ad0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00007ae0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00007af0: 6964 732e 5253 5152 542c 205f 7273 7172  ids.RSQRT, _rsqr
-00007b00: 745f 7072 696d 5f67 7261 6429 0a0a 0a64  t_prim_grad)...d
-00007b10: 6566 205f 7369 6e5f 7072 696d 5f67 7261  ef _sin_prim_gra
-00007b20: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007b30: 6e73 6f72 5072 6f78 7929 202d 3e20 4e75  nsorProxy) -> Nu
-00007b40: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007b50: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-00007b60: 696d 732e 7369 6e28 6129 0a0a 2020 2020  ims.sin(a)..    
-00007b70: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00007b80: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
-00007b90: 2c20 6720 2a20 7072 696d 732e 636f 7328  , g * prims.cos(
-00007ba0: 6129 290a 0a20 2020 2072 6574 7572 6e20  a))..    return 
-00007bb0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00007bc0: 7261 6428 7069 6473 2e53 494e 2c20 5f73  rad(pids.SIN, _s
-00007bd0: 696e 5f70 7269 6d5f 6772 6164 290a 0a0a  in_prim_grad)...
-00007be0: 4074 6f72 6368 6374 780a 6465 6620 5f74  @torchctx.def _t
-00007bf0: 616e 685f 7072 696d 5f67 7261 6428 613a  anh_prim_grad(a:
-00007c00: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007c10: 5072 6f78 792c 202f 2920 2d3e 204e 756d  Proxy, /) -> Num
-00007c20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007c30: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00007c40: 6d73 2e74 616e 6828 6129 0a0a 2020 2020  ms.tanh(a)..    
-00007c50: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00007c60: 290a 2020 2020 615f 6772 6164 203d 2067  ).    a_grad = g
-00007c70: 202a 2028 3120 2d20 6677 6420 2a20 6677   * (1 - fwd * fw
-00007c80: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
-00007c90: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00007ca0: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00007cb0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00007cc0: 5441 4e48 2c20 5f74 616e 685f 7072 696d  TANH, _tanh_prim
-00007cd0: 5f67 7261 6429 0a0a 230a 2320 456c 656d  _grad)..#.# Elem
-00007ce0: 656e 7477 6973 6520 6269 6e61 7279 206f  entwise binary o
-00007cf0: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-00007d00: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-00007d10: 5f61 6464 5f70 7269 6d5f 6772 6164 2861  _add_prim_grad(a
-00007d20: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-00007d30: 7250 726f 7879 2c20 623a 204e 756d 6265  rProxy, b: Numbe
-00007d40: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-00007d50: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
-00007d60: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007d70: 2066 7764 203d 2061 202b 2062 0a0a 2020   fwd = a + b..  
-00007d80: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007d90: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00007da0: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
-00007db0: 670a 2020 2020 7075 745f 6772 6164 7328  g.    put_grads(
-00007dc0: 2861 2c20 6229 2c20 2861 5f67 7261 642c  (a, b), (a_grad,
-00007dd0: 2062 5f67 7261 6429 290a 0a20 2020 2072   b_grad))..    r
-00007de0: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00007df0: 7374 6572 5f67 7261 6428 7069 6473 2e41  ster_grad(pids.A
-00007e00: 4444 2c20 5f61 6464 5f70 7269 6d5f 6772  DD, _add_prim_gr
-00007e10: 6164 290a 0a0a 2320 4e4f 5445 2054 6865  ad)...# NOTE The
-00007e20: 2066 6f6c 6c6f 7769 6e67 2067 7261 6420   following grad 
-00007e30: 6465 6669 6e69 7469 6f6e 2072 656c 6965  definition relie
-00007e40: 7320 6f6e 2074 6865 2066 6163 7420 7468  s on the fact th
-00007e50: 6174 206f 6e6c 7920 696e 6578 6163 7420  at only inexact 
-00007e60: 6474 7970 6573 2061 7265 2064 6966 6665  dtypes are diffe
-00007e70: 7265 6e74 6961 626c 652c 0a23 2020 2061  rentiable,.#   a
-00007e80: 6e64 2074 6f72 6368 2773 2074 7275 6520  nd torch's true 
-00007e90: 6469 7669 7369 6f6e 206f 7065 7261 746f  division operato
-00007ea0: 7220 616e 6420 7468 6520 6469 7669 7369  r and the divisi
-00007eb0: 6f6e 2070 7269 6d69 7469 7665 2061 6772  on primitive agr
-00007ec0: 6565 206f 6e20 7468 6f73 6520 7479 7065  ee on those type
-00007ed0: 730a 4074 6f72 6368 6374 780a 6465 6620  s.@torchctx.def 
-00007ee0: 5f64 6976 5f70 7269 6d5f 6772 6164 2861  _div_prim_grad(a
-00007ef0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-00007f00: 7250 726f 7879 2c20 623a 204e 756d 6265  rProxy, b: Numbe
-00007f10: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-00007f20: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
-00007f30: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007f40: 2066 7764 203d 2061 202f 2062 0a0a 2020   fwd = a / b..  
-00007f50: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007f60: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00007f70: 2067 202f 2062 0a20 2020 2062 5f67 7261   g / b.    b_gra
-00007f80: 6420 3d20 2d67 202a 2028 2861 202f 2062  d = -g * ((a / b
-00007f90: 2920 2f20 6229 0a20 2020 2070 7574 5f67  ) / b).    put_g
-00007fa0: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
-00007fb0: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
-00007fc0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00007fd0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00007fe0: 6964 732e 4449 562c 205f 6469 765f 7072  ids.DIV, _div_pr
-00007ff0: 696d 5f67 7261 6429 0a0a 2320 436f 6d70  im_grad)..# Comp
-00008000: 6172 6973 6f6e 206f 7065 7261 746f 7273  arison operators
-00008010: 202d 2d20 7468 6573 6520 6372 6561 7465   -- these create
-00008020: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
-00008030: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
-00008040: 7261 6428 7069 6473 2e45 512c 2070 7269  rad(pids.EQ, pri
-00008050: 6d73 2e65 7129 0a72 6567 6973 7465 725f  ms.eq).register_
-00008060: 6772 6164 2870 6964 732e 4745 2c20 7072  grad(pids.GE, pr
-00008070: 696d 732e 6765 290a 7265 6769 7374 6572  ims.ge).register
-00008080: 5f67 7261 6428 7069 6473 2e4c 542c 2070  _grad(pids.LT, p
-00008090: 7269 6d73 2e6c 7429 0a72 6567 6973 7465  rims.lt).registe
-000080a0: 725f 6772 6164 2870 6964 732e 4e45 2c20  r_grad(pids.NE, 
-000080b0: 7072 696d 732e 6e65 290a 7265 6769 7374  prims.ne).regist
-000080c0: 6572 5f67 7261 6428 7069 6473 2e47 542c  er_grad(pids.GT,
-000080d0: 2070 7269 6d73 2e67 7429 0a72 6567 6973   prims.gt).regis
-000080e0: 7465 725f 6772 6164 2870 6964 732e 4c45  ter_grad(pids.LE
-000080f0: 2c20 7072 696d 732e 6c65 290a 0a0a 4074  , prims.le)...@t
-00008100: 6f72 6368 6374 780a 6465 6620 5f6d 756c  orchctx.def _mul
-00008110: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
-00008120: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00008130: 7879 2c20 623a 204e 756d 6265 7220 7c20  xy, b: Number | 
-00008140: 5465 6e73 6f72 5072 6f78 792c 202f 2920  TensorProxy, /) 
-00008150: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
-00008160: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00008170: 203d 2061 202a 2062 0a0a 2020 2020 6720   = a * b..    g 
-00008180: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00008190: 2020 2020 615f 6772 6164 203d 2062 202a      a_grad = b *
-000081a0: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
-000081b0: 6120 2a20 670a 2020 2020 7075 745f 6772  a * g.    put_gr
-000081c0: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
-000081d0: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
-000081e0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-000081f0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00008200: 6473 2e4d 554c 2c20 5f6d 756c 5f70 7269  ds.MUL, _mul_pri
-00008210: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
-00008220: 6374 780a 6465 6620 5f73 7562 5f70 7269  ctx.def _sub_pri
-00008230: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
-00008240: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
-00008250: 623a 204e 756d 6265 7220 7c20 5465 6e73  b: Number | Tens
-00008260: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-00008270: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00008280: 3a0a 2020 2020 6677 6420 3d20 6120 2d20  :.    fwd = a - 
-00008290: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
-000082a0: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-000082b0: 7261 6420 3d20 670a 2020 2020 625f 6772  rad = g.    b_gr
-000082c0: 6164 203d 202d 670a 2020 2020 7075 745f  ad = -g.    put_
-000082d0: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
-000082e0: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
-000082f0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00008300: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00008310: 7069 6473 2e53 5542 2c20 5f73 7562 5f70  pids.SUB, _sub_p
-00008320: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
-00008330: 436f 6e64 6974 696f 6e61 6c20 6f70 6572  Conditional oper
-00008340: 6174 6f72 2067 7261 6473 0a23 0a0a 0a64  ator grads.#...d
-00008350: 6566 205f 7768 6572 655f 7072 696d 5f67  ef _where_prim_g
-00008360: 7261 6428 7072 6564 3a20 4e75 6d62 6572  rad(pred: Number
-00008370: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
-00008380: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-00008390: 6f72 5072 6f78 792c 2062 3a20 4e75 6d62  orProxy, b: Numb
-000083a0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000083b0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-000083c0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-000083d0: 732e 7768 6572 6528 7072 6564 2c20 612c  s.where(pred, a,
-000083e0: 2062 290a 0a20 2020 2067 203d 2067 6574   b)..    g = get
-000083f0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-00008400: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
-00008410: 6865 7265 2870 7265 642c 2067 2c20 3029  here(pred, g, 0)
-00008420: 0a20 2020 2062 5f67 7261 6420 3d20 6c74  .    b_grad = lt
-00008430: 6f72 6368 2e77 6865 7265 2870 7265 642c  orch.where(pred,
-00008440: 2030 2c20 6729 0a20 2020 2070 7574 5f67   0, g).    put_g
-00008450: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
-00008460: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
-00008470: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008480: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008490: 6964 732e 5748 4552 452c 205f 7768 6572  ids.WHERE, _wher
-000084a0: 655f 7072 696d 5f67 7261 6429 0a0a 230a  e_prim_grad)..#.
-000084b0: 2320 5265 6475 6374 696f 6e20 6f70 6572  # Reduction oper
-000084c0: 6174 6f72 2067 7261 6473 0a23 0a0a 0a23  ator grads.#...#
-000084d0: 2054 4f44 4f20 5265 7669 6577 2074 7765   TODO Review twe
-000084e0: 616b 696e 6720 6772 6164 5f63 686f 6f73  aking grad_choos
-000084f0: 6572 5f70 756c 6c62 6163 6b20 696e 7465  er_pullback inte
-00008500: 7266 6163 650a 6465 6620 5f61 6d61 785f  rface.def _amax_
-00008510: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-00008520: 736f 7250 726f 7879 2c20 2f2c 2064 696d  sorProxy, /, dim
-00008530: 733a 2053 6571 7565 6e63 655b 696e 745d  s: Sequence[int]
-00008540: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00008550: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00008560: 732e 616d 6178 2861 2c20 6469 6d73 290a  s.amax(a, dims).
-00008570: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00008580: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00008590: 6420 3d20 6772 6164 5f63 686f 6f73 6572  d = grad_chooser
-000085a0: 5f62 6163 6b77 6172 6428 6677 642c 2061  _backward(fwd, a
-000085b0: 2c20 612e 7368 6170 652c 2064 696d 732c  , a.shape, dims,
-000085c0: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
-000085d0: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
-000085e0: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
-000085f0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00008600: 2e41 4d41 582c 205f 616d 6178 5f70 7269  .AMAX, _amax_pri
-00008610: 6d5f 6772 6164 290a 0a0a 6465 6620 5f73  m_grad)...def _s
-00008620: 756d 5f70 7269 6d5f 6772 6164 2861 3a20  um_prim_grad(a: 
-00008630: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-00008640: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
-00008650: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
-00008660: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00008670: 7269 6d73 2e73 756d 2861 2c20 6469 6d73  rims.sum(a, dims
-00008680: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00008690: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-000086a0: 7261 6420 3d20 7265 7374 6f72 655f 7265  rad = restore_re
-000086b0: 6475 6365 645f 6469 6d73 2867 2c20 6469  duced_dims(g, di
-000086c0: 6d73 2c20 612e 7368 6170 6529 0a20 2020  ms, a.shape).   
-000086d0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-000086e0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-000086f0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00008700: 6772 6164 2870 6964 732e 5355 4d2c 205f  grad(pids.SUM, _
-00008710: 7375 6d5f 7072 696d 5f67 7261 6429 0a0a  sum_prim_grad)..
-00008720: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00008730: 746f 706b 5f70 7269 6d5f 6772 6164 280a  topk_prim_grad(.
-00008740: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
-00008750: 7879 2c20 2f2c 206b 3a20 696e 742c 2064  xy, /, k: int, d
-00008760: 696d 3a20 4e6f 6e65 207c 2069 6e74 203d  im: None | int =
-00008770: 204e 6f6e 652c 206c 6172 6765 7374 3a20   None, largest: 
-00008780: 626f 6f6c 203d 2054 7275 652c 2073 6f72  bool = True, sor
-00008790: 7465 643a 2062 6f6f 6c20 3d20 5472 7565  ted: bool = True
-000087a0: 2c20 2a2c 206f 7574 3d4e 6f6e 650a 293a  , *, out=None.):
-000087b0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-000087c0: 2e74 6f70 6b28 612c 206b 2c20 6469 6d2c  .topk(a, k, dim,
-000087d0: 206c 6172 6765 7374 2c20 736f 7274 6564   largest, sorted
-000087e0: 2c20 6f75 743d 6f75 7429 0a20 2020 2076  , out=out).    v
-000087f0: 616c 2c20 6964 7820 3d20 6677 640a 0a20  al, idx = fwd.. 
-00008800: 2020 2076 616c 5f67 7261 6420 3d20 6765     val_grad = ge
-00008810: 745f 6772 6164 2876 616c 290a 0a20 2020  t_grad(val)..   
-00008820: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
-00008830: 2e7a 6572 6f73 5f6c 696b 6528 6129 0a20  .zeros_like(a). 
-00008840: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
-00008850: 6365 2077 6974 6820 7363 6174 7465 7220  ce with scatter 
-00008860: 6f6e 6365 2077 6520 6861 7665 2069 742e  once we have it.
-00008870: 0a20 2020 2023 2073 6361 7474 6572 5f61  .    # scatter_a
-00008880: 6464 2069 7320 6120 7072 696d 2061 6e64  dd is a prim and
-00008890: 2069 7420 7265 6c69 6573 206f 6e20 6174   it relies on at
-000088a0: 6f6d 6963 206f 7073 2e0a 2020 2020 615f  omic ops..    a_
-000088b0: 6772 6164 203d 206c 746f 7263 682e 7363  grad = ltorch.sc
-000088c0: 6174 7465 725f 6164 6428 615f 6772 6164  atter_add(a_grad
-000088d0: 2c20 6469 6d2c 2069 6478 2c20 7661 6c5f  , dim, idx, val_
-000088e0: 6772 6164 290a 2020 2020 7075 745f 6772  grad).    put_gr
-000088f0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
-00008900: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00008910: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00008920: 6473 2e54 4f50 4b2c 205f 746f 706b 5f70  ds.TOPK, _topk_p
-00008930: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
-00008940: 444f 2046 6978 2064 6976 6973 696f 6e20  DO Fix division 
-00008950: 6279 207a 6572 6f20 7768 656e 206e 5f65  by zero when n_e
-00008960: 6c65 6d5f 7265 6475 6365 6420 3d3d 2030  lem_reduced == 0
-00008970: 206f 7220 7768 656e 206d 6561 6e2e 6e75   or when mean.nu
-00008980: 6d65 6c20 3d3d 2030 0a23 2020 2062 7920  mel == 0.#   by 
-00008990: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
-000089a0: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
-000089b0: 6172 2e0a 2320 544f 444f 2046 6978 2067  ar..# TODO Fix g
-000089c0: 7261 6420 7768 656e 2063 6f72 7265 6374  rad when correct
-000089d0: 696f 6e20 3e20 6e5f 656c 656d 5f72 6564  ion > n_elem_red
-000089e0: 7563 6564 2e0a 4074 6f72 6368 6374 780a  uced..@torchctx.
-000089f0: 6465 6620 5f76 6172 5f6d 6561 6e5f 7072  def _var_mean_pr
-00008a00: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-00008a10: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
-00008a20: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
-00008a30: 2a2c 2063 6f72 7265 6374 696f 6e3a 204e  *, correction: N
-00008a40: 756d 6265 7229 202d 3e20 5465 6e73 6f72  umber) -> Tensor
-00008a50: 5072 6f78 793a 0a20 2020 2076 2c20 6d20  Proxy:.    v, m 
-00008a60: 3d20 7072 696d 732e 7661 725f 6d65 616e  = prims.var_mean
-00008a70: 2861 2c20 6469 6d73 2c20 636f 7272 6563  (a, dims, correc
-00008a80: 7469 6f6e 3d63 6f72 7265 6374 696f 6e29  tion=correction)
-00008a90: 0a0a 2020 2020 6776 203d 2067 6574 5f67  ..    gv = get_g
-00008aa0: 7261 6428 7629 0a20 2020 2067 6d20 3d20  rad(v).    gm = 
-00008ab0: 6765 745f 6772 6164 286d 290a 0a20 2020  get_grad(m)..   
-00008ac0: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
-00008ad0: 3d20 612e 6e75 6d65 6c28 2920 2f2f 206d  = a.numel() // m
-00008ae0: 2e6e 756d 656c 2829 2069 6620 612e 6e75  .numel() if a.nu
-00008af0: 6d65 6c28 2920 213d 2030 2065 6c73 6520  mel() != 0 else 
-00008b00: 310a 0a20 2020 2023 2043 6f6d 7075 7465  1..    # Compute
-00008b10: 7320 6d65 616e 2062 7764 0a20 2020 206d  s mean bwd.    m
-00008b20: 6561 6e5f 7363 616c 6520 3d20 312e 3020  ean_scale = 1.0 
-00008b30: 2f20 6e5f 656c 656d 5f72 6564 7563 6564  / n_elem_reduced
-00008b40: 0a20 2020 206d 6561 6e5f 6772 6164 203d  .    mean_grad =
-00008b50: 206d 6561 6e5f 7363 616c 6520 2a20 7265   mean_scale * re
-00008b60: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
-00008b70: 6d73 2867 6d2c 2064 696d 732c 2061 2e73  ms(gm, dims, a.s
-00008b80: 6861 7065 290a 0a20 2020 2023 2043 6f6d  hape)..    # Com
-00008b90: 7075 7465 7320 7661 7220 6277 640a 2020  putes var bwd.  
-00008ba0: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
-00008bb0: 7363 616c 6172 203d 206e 5f65 6c65 6d5f  scalar = n_elem_
-00008bc0: 7265 6475 6365 6420 2d20 636f 7272 6563  reduced - correc
-00008bd0: 7469 6f6e 0a20 2020 2072 6573 746f 7265  tion.    restore
-00008be0: 645f 6776 203d 2072 6573 746f 7265 5f72  d_gv = restore_r
-00008bf0: 6564 7563 6564 5f64 696d 7328 6776 2c20  educed_dims(gv, 
-00008c00: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
-00008c10: 2020 2023 2049 6e73 6572 7469 6e67 2061     # Inserting a
-00008c20: 2063 6f6e 7665 7273 696f 6e20 746f 2074   conversion to t
-00008c30: 6865 2073 616d 6520 6474 7970 6520 746f  he same dtype to
-00008c40: 2064 6973 6162 6c65 206e 7646 7573 6572   disable nvFuser
-00008c50: 2065 7865 6375 746f 7273 2773 0a20 2020   executors's.   
-00008c60: 2023 2062 6f6f 6b65 6e64 206f 7074 696d   # bookend optim
-00008c70: 697a 6174 696f 6e20 286e 765f 656e 6162  ization (nv_enab
-00008c80: 6c65 5f62 6f6f 6b65 6e64 292c 2077 6869  le_bookend), whi
-00008c90: 6368 2063 616e 2063 6175 7365 2074 6865  ch can cause the
-00008ca0: 2062 6163 6b77 6172 640a 2020 2020 2320   backward.    # 
-00008cb0: 7061 7373 2074 6f20 6765 6e65 7261 7465  pass to generate
-00008cc0: 2074 776f 206b 6572 6e65 6c73 0a20 2020   two kernels.   
-00008cd0: 206d 6561 6e5f 6d64 7479 7065 203d 2070   mean_mdtype = p
-00008ce0: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
-00008cf0: 6d65 6e74 5f74 7970 6528 6d2c 206d 2e64  ment_type(m, m.d
-00008d00: 7479 7065 290a 2020 2020 7265 7374 6f72  type).    restor
-00008d10: 6564 5f6d 6561 6e20 3d20 7265 7374 6f72  ed_mean = restor
-00008d20: 655f 7265 6475 6365 645f 6469 6d73 286d  e_reduced_dims(m
-00008d30: 6561 6e5f 6d64 7479 7065 2c20 6469 6d73  ean_mdtype, dims
-00008d40: 2c20 612e 7368 6170 6529 0a20 2020 2076  , a.shape).    v
-00008d50: 6172 5f67 7261 6420 3d20 2832 202a 2072  ar_grad = (2 * r
-00008d60: 6573 746f 7265 645f 6776 202a 2028 6120  estored_gv * (a 
-00008d70: 2d20 7265 7374 6f72 6564 5f6d 6561 6e29  - restored_mean)
-00008d80: 2920 2f20 6e6f 726d 616c 697a 6174 696f  ) / normalizatio
-00008d90: 6e5f 7363 616c 6172 0a0a 2020 2020 7075  n_scalar..    pu
-00008da0: 745f 6772 6164 2861 2c20 6d65 616e 5f67  t_grad(a, mean_g
-00008db0: 7261 6420 2b20 7661 725f 6772 6164 290a  rad + var_grad).
-00008dc0: 0a20 2020 2072 6574 7572 6e20 762c 206d  .    return v, m
-00008dd0: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00008de0: 2870 6964 732e 5641 525f 4d45 414e 2c20  (pids.VAR_MEAN, 
-00008df0: 5f76 6172 5f6d 6561 6e5f 7072 696d 5f67  _var_mean_prim_g
-00008e00: 7261 6429 0a0a 0a23 0a23 204c 696e 6561  rad)...#.# Linea
-00008e10: 7220 616c 6765 6272 6120 6f70 6572 6174  r algebra operat
-00008e20: 6f72 2067 7261 6473 0a23 0a40 746f 7263  or grads.#.@torc
-00008e30: 6863 7478 0a64 6566 205f 6c69 6e65 6172  hctx.def _linear
-00008e40: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00008e50: 6e73 6f72 5072 6f78 792c 2077 3a20 5465  nsorProxy, w: Te
-00008e60: 6e73 6f72 5072 6f78 792c 2062 6961 733a  nsorProxy, bias:
-00008e70: 204e 6f6e 6520 7c20 5465 6e73 6f72 5072   None | TensorPr
-00008e80: 6f78 7929 202d 3e20 5465 6e73 6f72 5072  oxy) -> TensorPr
-00008e90: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00008ea0: 7269 6d73 2e6c 696e 6561 7228 612c 2077  rims.linear(a, w
-00008eb0: 2c20 6269 6173 290a 0a20 2020 2067 203d  , bias)..    g =
-00008ec0: 2067 6574 5f67 7261 6428 6677 6429 0a0a   get_grad(fwd)..
-00008ed0: 2020 2020 6669 7273 745f 6469 6d20 3d20      first_dim = 
-00008ee0: 2d32 0a20 2020 2067 7261 645f 6120 3d20  -2.    grad_a = 
-00008ef0: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
-00008f00: 7265 7368 6170 6528 2d31 2c20 672e 7368  reshape(-1, g.sh
-00008f10: 6170 655b 2d31 5d29 2c20 7729 2e72 6573  ape[-1]), w).res
-00008f20: 6861 7065 2861 2e73 6861 7065 290a 0a20  hape(a.shape).. 
-00008f30: 2020 2067 7261 645f 773a 2054 656e 736f     grad_w: Tenso
-00008f40: 7250 726f 7879 0a20 2020 2069 6620 612e  rProxy.    if a.
-00008f50: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-00008f60: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
-00008f70: 6368 2e6d 6174 6d75 6c28 672e 756e 7371  ch.matmul(g.unsq
-00008f80: 7565 657a 6528 6669 7273 745f 6469 6d29  ueeze(first_dim)
-00008f90: 2e6d 542c 2061 2e75 6e73 7175 6565 7a65  .mT, a.unsqueeze
-00008fa0: 2866 6972 7374 5f64 696d 2929 0a20 2020  (first_dim)).   
-00008fb0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
-00008fc0: 7261 645f 7720 3d20 6c74 6f72 6368 2e6d  rad_w = ltorch.m
-00008fd0: 6174 6d75 6c28 672e 7265 7368 6170 6528  atmul(g.reshape(
-00008fe0: 2d31 2c20 672e 7368 6170 655b 2d31 5d29  -1, g.shape[-1])
-00008ff0: 2e6d 542c 2061 2e72 6573 6861 7065 282d  .mT, a.reshape(-
-00009000: 312c 2061 2e73 6861 7065 5b2d 315d 2929  1, a.shape[-1]))
-00009010: 0a0a 2020 2020 7075 745f 6772 6164 7328  ..    put_grads(
-00009020: 2861 2c20 7729 2c20 2867 7261 645f 612c  (a, w), (grad_a,
-00009030: 2067 7261 645f 7729 290a 0a20 2020 2069   grad_w))..    i
-00009040: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
-00009050: 6e65 3a0a 2020 2020 2020 2020 6966 2067  ne:.        if g
-00009060: 2e6e 6469 6d20 3e20 313a 0a20 2020 2020  .ndim > 1:.     
-00009070: 2020 2020 2020 2067 7261 645f 6269 6173         grad_bias
-00009080: 203d 206c 746f 7263 682e 7375 6d28 672c   = ltorch.sum(g,
-00009090: 2074 7570 6c65 2872 616e 6765 2867 2e6e   tuple(range(g.n
-000090a0: 6469 6d20 2d20 3129 2929 0a20 2020 2020  dim - 1))).     
-000090b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000090c0: 2020 2020 2067 7261 645f 6269 6173 203d       grad_bias =
-000090d0: 2067 0a20 2020 2020 2020 2070 7574 5f67   g.        put_g
-000090e0: 7261 6428 6269 6173 2c20 6772 6164 5f62  rad(bias, grad_b
-000090f0: 6961 7329 0a0a 2020 2020 7265 7475 726e  ias)..    return
-00009100: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00009110: 6772 6164 2870 6964 732e 4c49 4e45 4152  grad(pids.LINEAR
-00009120: 2c20 5f6c 696e 6561 725f 7072 696d 5f67  , _linear_prim_g
-00009130: 7261 6429 0a0a 0a23 2054 4f44 4f20 4164  rad)...# TODO Ad
-00009140: 6420 6578 706c 6963 6974 206c 746f 7263  d explicit ltorc
-00009150: 6820 7673 2063 6c61 6e67 206d 6f64 756c  h vs clang modul
-00009160: 6520 746f 2074 6865 2074 656e 736f 7220  e to the tensor 
-00009170: 6f70 6572 6174 696f 6e73 2062 656c 6f77  operations below
-00009180: 0a23 2054 4f44 4f20 636f 756c 6420 7765  .# TODO could we
-00009190: 2067 6574 2072 6964 206f 6620 7468 6520   get rid of the 
-000091a0: 6669 6e61 6c20 7371 7565 657a 6573 2069  final squeezes i
-000091b0: 6e20 7468 6520 622e 6e64 696d 203d 3d20  n the b.ndim == 
-000091c0: 3120 6361 7365 2061 6e64 2074 6865 2061  1 case and the a
-000091d0: 2e6e 6469 6d20 3d3d 2031 2063 6173 653f  .ndim == 1 case?
-000091e0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-000091f0: 6d61 746d 756c 5f70 7269 6d5f 6772 6164  matmul_prim_grad
-00009200: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
-00009210: 2062 3a20 5465 6e73 6f72 5072 6f78 792c   b: TensorProxy,
-00009220: 202f 2920 2d3e 2054 656e 736f 7250 726f   /) -> TensorPro
-00009230: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-00009240: 696d 732e 6d61 746d 756c 2861 2c20 6229  ims.matmul(a, b)
-00009250: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00009260: 6428 6677 6429 0a0a 2020 2020 6c61 7374  d(fwd)..    last
-00009270: 5f64 696d 203d 2028 2d31 2c29 0a20 2020  _dim = (-1,).   
-00009280: 2066 6972 7374 5f64 696d 203d 2028 2d32   first_dim = (-2
-00009290: 2c29 0a20 2020 2069 6620 612e 6e64 696d  ,).    if a.ndim
-000092a0: 203d 3d20 3120 616e 6420 622e 6e64 696d   == 1 and b.ndim
-000092b0: 203d 3d20 313a 0a20 2020 2020 2020 2070   == 1:.        p
-000092c0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
-000092d0: 2028 6720 2a20 622c 2067 202a 2061 2929   (g * b, g * a))
-000092e0: 0a20 2020 2065 6c69 6620 622e 6e64 696d  .    elif b.ndim
-000092f0: 203d 3d20 313a 0a20 2020 2020 2020 2067   == 1:.        g
-00009300: 6120 3d20 756e 7371 7565 657a 6528 672c  a = unsqueeze(g,
-00009310: 206c 6173 745f 6469 6d29 2040 2075 6e73   last_dim) @ uns
-00009320: 7175 6565 7a65 2862 2c20 6c61 7374 5f64  queeze(b, last_d
-00009330: 696d 292e 6d54 0a20 2020 2020 2020 2067  im).mT.        g
-00009340: 6220 3d20 612e 6d54 2040 2075 6e73 7175  b = a.mT @ unsqu
-00009350: 6565 7a65 2867 2c20 6c61 7374 5f64 696d  eeze(g, last_dim
-00009360: 290a 2020 2020 2020 2020 6966 2067 2e6e  ).        if g.n
-00009370: 6469 6d20 3e20 313a 0a20 2020 2020 2020  dim > 1:.       
-00009380: 2020 2020 2067 6220 3d20 7371 7565 657a       gb = squeez
-00009390: 6528 6762 2c20 6c61 7374 5f64 696d 290a  e(gb, last_dim).
-000093a0: 2020 2020 2020 2020 2020 2020 6762 203d              gb =
-000093b0: 206c 746f 7263 682e 7375 6d28 6762 2c20   ltorch.sum(gb, 
-000093c0: 7475 706c 6528 7261 6e67 6528 6762 2e6e  tuple(range(gb.n
-000093d0: 6469 6d20 2d20 3129 2929 0a20 2020 2020  dim - 1))).     
-000093e0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-000093f0: 2062 292c 2028 6761 2c20 6762 2e73 7175   b), (ga, gb.squ
-00009400: 6565 7a65 2829 2929 0a20 2020 2065 6c69  eeze())).    eli
-00009410: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
-00009420: 2020 2020 2020 2067 6120 3d20 756e 7371         ga = unsq
-00009430: 7565 657a 6528 672c 2066 6972 7374 5f64  ueeze(g, first_d
-00009440: 696d 2920 4020 622e 6d54 0a20 2020 2020  im) @ b.mT.     
-00009450: 2020 2069 6620 672e 6e64 696d 203e 2031     if g.ndim > 1
-00009460: 3a0a 2020 2020 2020 2020 2020 2020 6761  :.            ga
-00009470: 203d 206c 746f 7263 682e 7375 6d28 6761   = ltorch.sum(ga
-00009480: 2c20 7475 706c 6528 7261 6e67 6528 6761  , tuple(range(ga
-00009490: 2e6e 6469 6d20 2d20 3129 2929 0a20 2020  .ndim - 1))).   
-000094a0: 2020 2020 2067 6220 3d20 756e 7371 7565       gb = unsque
-000094b0: 657a 6528 612c 2066 6972 7374 5f64 696d  eze(a, first_dim
-000094c0: 292e 6d54 2040 2075 6e73 7175 6565 7a65  ).mT @ unsqueeze
-000094d0: 2867 2c20 6669 7273 745f 6469 6d29 0a20  (g, first_dim). 
-000094e0: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
-000094f0: 2828 612c 2062 292c 2028 6761 2e73 7175  ((a, b), (ga.squ
-00009500: 6565 7a65 2829 2c20 6762 2929 0a20 2020  eeze(), gb)).   
-00009510: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
-00009520: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
-00009530: 2028 6720 4020 622e 6d54 2c20 612e 6d54   (g @ b.mT, a.mT
-00009540: 2040 2067 2929 0a0a 2020 2020 7265 7475   @ g))..    retu
-00009550: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00009560: 725f 6772 6164 2870 6964 732e 4d41 544d  r_grad(pids.MATM
-00009570: 554c 2c20 5f6d 6174 6d75 6c5f 7072 696d  UL, _matmul_prim
-00009580: 5f67 7261 6429 0a0a 230a 2320 4e4e 206f  _grad)..#.# NN o
-00009590: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-000095a0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-000095b0: 5f65 6d62 6564 6469 6e67 5f70 7269 6d5f  _embedding_prim_
-000095c0: 6772 6164 280a 2020 2020 613a 2054 656e  grad(.    a: Ten
-000095d0: 736f 7250 726f 7879 2c20 2f2c 2077 6569  sorProxy, /, wei
-000095e0: 6768 742c 202a 2c20 7061 6464 696e 675f  ght, *, padding_
-000095f0: 6964 783d 2d31 2c20 6d61 785f 6e6f 726d  idx=-1, max_norm
-00009600: 3d4e 6f6e 652c 206e 6f72 6d5f 7479 7065  =None, norm_type
-00009610: 3d32 2e30 2c20 7363 616c 655f 6772 6164  =2.0, scale_grad
-00009620: 5f62 795f 6672 6571 3d46 616c 7365 2c20  _by_freq=False, 
-00009630: 7370 6172 7365 3d46 616c 7365 0a29 202d  sparse=False.) -
-00009640: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00009650: 2020 2066 7764 203d 2070 7269 6d73 2e65     fwd = prims.e
-00009660: 6d62 6564 6469 6e67 280a 2020 2020 2020  mbedding(.      
-00009670: 2020 612c 0a20 2020 2020 2020 2077 6569    a,.        wei
-00009680: 6768 742c 0a20 2020 2020 2020 2070 6164  ght,.        pad
-00009690: 6469 6e67 5f69 6478 3d70 6164 6469 6e67  ding_idx=padding
-000096a0: 5f69 6478 2c0a 2020 2020 2020 2020 6d61  _idx,.        ma
-000096b0: 785f 6e6f 726d 3d6d 6178 5f6e 6f72 6d2c  x_norm=max_norm,
-000096c0: 0a20 2020 2020 2020 206e 6f72 6d5f 7479  .        norm_ty
-000096d0: 7065 3d6e 6f72 6d5f 7479 7065 2c0a 2020  pe=norm_type,.  
-000096e0: 2020 2020 2020 7363 616c 655f 6772 6164        scale_grad
-000096f0: 5f62 795f 6672 6571 3d73 6361 6c65 5f67  _by_freq=scale_g
-00009700: 7261 645f 6279 5f66 7265 712c 0a20 2020  rad_by_freq,.   
-00009710: 2020 2020 2073 7061 7273 653d 7370 6172       sparse=spar
-00009720: 7365 2c0a 2020 2020 290a 0a20 2020 2067  se,.    )..    g
-00009730: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00009740: 0a20 2020 2061 5f67 7261 6420 3d20 7072  .    a_grad = pr
-00009750: 696d 732e 656d 6265 6464 696e 675f 6261  ims.embedding_ba
-00009760: 636b 7761 7264 2867 2c20 612c 2077 6569  ckward(g, a, wei
-00009770: 6768 742e 7368 6170 655b 305d 2c20 7061  ght.shape[0], pa
-00009780: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
-00009790: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
-000097a0: 7061 7273 6529 0a20 2020 2070 7574 5f67  parse).    put_g
-000097b0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-000097c0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-000097d0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-000097e0: 6964 732e 454d 4245 4444 494e 472c 205f  ids.EMBEDDING, _
-000097f0: 656d 6265 6464 696e 675f 7072 696d 5f67  embedding_prim_g
-00009800: 7261 6429 0a0a 230a 2320 5068 616e 746f  rad)..#.# Phanto
-00009810: 6d20 6772 6164 2074 7261 6e73 666f 726d  m grad transform
-00009820: 2068 656c 7065 7273 0a23 0a0a 0a64 6566   helpers.#...def
-00009830: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
-00009840: 5f65 7865 6375 746f 7228 0a20 2020 2062  _executor(.    b
-00009850: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
-00009860: 2c20 2a2c 2065 7865 6375 746f 7273 5f6c  , *, executors_l
-00009870: 6973 743a 2053 6571 7565 6e63 655b 416e  ist: Sequence[An
-00009880: 795d 203d 2074 7570 6c65 2829 0a29 202d  y] = tuple().) -
-00009890: 3e20 7475 706c 655b 4361 6c6c 6162 6c65  > tuple[Callable
-000098a0: 207c 204e 6f6e 652c 2045 7865 6375 746f   | None, Executo
-000098b0: 7220 7c20 4e6f 6e65 5d3a 0a20 2020 2063  r | None]:.    c
-000098c0: 6420 3d20 6765 745f 636f 6d70 696c 655f  d = get_compile_
-000098d0: 6461 7461 2829 0a20 2020 2065 7865 6375  data().    execu
-000098e0: 746f 7273 5f6c 6973 7420 3d20 6364 2e65  tors_list = cd.e
-000098f0: 7865 6375 746f 7273 5f6c 6973 7420 6966  xecutors_list if
-00009900: 2063 6420 6973 206e 6f74 204e 6f6e 6520   cd is not None 
-00009910: 656c 7365 2065 7865 6375 746f 7273 5f6c  else executors_l
-00009920: 6973 740a 2020 2020 2320 4368 6563 6b73  ist.    # Checks
-00009930: 2069 6620 7468 6520 6578 6563 7574 6f72   if the executor
-00009940: 2077 6869 6368 2068 6173 2070 7269 6f72   which has prior
-00009950: 6974 7920 666f 7220 7468 6973 206f 7065  ity for this ope
-00009960: 7261 7469 6f6e 2068 6173 2061 2073 7065  ration has a spe
-00009970: 6369 6669 6320 6772 6164 2074 7261 6e73  cific grad trans
-00009980: 666f 726d 2066 6f72 2069 740a 2020 2020  form for it.    
-00009990: 666f 7220 6578 2069 6e20 6578 6563 7574  for ex in execut
-000099a0: 6f72 735f 6c69 7374 3a0a 2020 2020 2020  ors_list:.      
-000099b0: 2020 6966 2065 782e 6361 6e5f 6578 6563    if ex.can_exec
-000099c0: 7574 655f 6f72 5f66 7573 6528 6273 796d  ute_or_fuse(bsym
-000099d0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-000099e0: 785f 6772 6164 5f74 7261 6e73 666f 726d  x_grad_transform
-000099f0: 3a20 4e6f 6e65 207c 2043 616c 6c61 626c  : None | Callabl
-00009a00: 6520 3d20 6578 2e67 6574 5f67 7261 645f  e = ex.get_grad_
-00009a10: 7472 616e 7366 6f72 6d28 6273 796d 2e73  transform(bsym.s
-00009a20: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
-00009a30: 6966 2065 785f 6772 6164 5f74 7261 6e73  if ex_grad_trans
-00009a40: 666f 726d 2069 7320 6e6f 7420 4e6f 6e65  form is not None
-00009a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009a60: 2020 7265 7475 726e 2065 785f 6772 6164    return ex_grad
-00009a70: 5f74 7261 6e73 666f 726d 2c20 6578 0a20  _transform, ex. 
-00009a80: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00009a90: 0a0a 2020 2020 2320 4966 2074 6865 2065  ..    # If the e
-00009aa0: 7865 6375 746f 7220 646f 6573 6e27 7420  xecutor doesn't 
-00009ab0: 6465 6669 6e65 2069 7473 206f 776e 2067  define its own g
-00009ac0: 7261 6420 7472 616e 7366 6f72 6d2c 2074  rad transform, t
-00009ad0: 6869 7320 6a75 7374 2072 6574 7572 6e73  his just returns
-00009ae0: 2074 6865 2064 6566 6175 6c74 2067 7261   the default gra
-00009af0: 6420 7472 616e 7366 6f72 6d20 666f 7220  d transform for 
-00009b00: 7468 6520 6273 796d 0a20 2020 2067 7261  the bsym.    gra
-00009b10: 6466 6e20 3d20 5f67 7261 645f 666e 5f6d  dfn = _grad_fn_m
-00009b20: 6170 2e67 6574 2862 7379 6d2e 7379 6d2e  ap.get(bsym.sym.
-00009b30: 6964 2c20 4e6f 6e65 290a 2020 2020 7265  id, None).    re
-00009b40: 7475 726e 2067 7261 6466 6e2c 204e 6f6e  turn gradfn, Non
-00009b50: 650a 0a0a 2320 5468 6520 6465 6661 756c  e...# The defaul
-00009b60: 7420 6772 6164 2073 7065 6369 6669 6572  t grad specifier
-00009b70: 2066 6f72 2074 6865 2067 7261 6420 7472   for the grad tr
-00009b80: 616e 7366 6f72 6d0a 2320 2020 466f 7220  ansform.#   For 
-00009b90: 6561 6368 2074 656e 736f 7220 6f75 7470  each tensor outp
-00009ba0: 7574 2022 6f22 2072 6571 7569 7269 6e67  ut "o" requiring
-00009bb0: 2067 7261 642c 2073 7065 6369 6669 6573   grad, specifies
-00009bc0: 2061 2067 7261 6420 6f66 206f 6e65 735f   a grad of ones_
-00009bd0: 6c69 6b65 286f 290a 6465 6620 5f67 7261  like(o).def _gra
-00009be0: 645f 7370 6563 6966 6965 725f 6465 6661  d_specifier_defa
-00009bf0: 756c 7428 7079 7472 6565 3a20 416e 7929  ult(pytree: Any)
-00009c00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 666c   -> None:.    fl
-00009c10: 6174 732c 205f 203d 2074 7265 655f 666c  ats, _ = tree_fl
-00009c20: 6174 7465 6e28 7079 7472 6565 290a 0a20  atten(pytree).. 
-00009c30: 2020 2066 6f72 2066 2069 6e20 666c 6174     for f in flat
-00009c40: 733a 0a20 2020 2020 2020 2069 6620 6973  s:.        if is
-00009c50: 696e 7374 616e 6365 2866 2c20 5465 6e73  instance(f, Tens
-00009c60: 6f72 5072 6f78 7929 2061 6e64 2066 2e72  orProxy) and f.r
-00009c70: 6571 7569 7265 735f 6772 6164 3a0a 2020  equires_grad:.  
-00009c80: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-00009c90: 2054 6869 7320 7573 6573 2063 6c61 6e67   This uses clang
-00009ca0: 2e6f 6e65 735f 6c69 6b65 2066 6f72 206e  .ones_like for n
-00009cb0: 6f77 2062 6563 6175 7365 206c 746f 7263  ow because ltorc
-00009cc0: 682e 6f6e 6573 5f6c 696b 6520 7769 6c6c  h.ones_like will
-00009cd0: 2065 7874 656e 6420 7468 650a 2020 2020   extend the.    
-00009ce0: 2020 2020 2020 2020 2320 2020 6c69 6665          #   life
-00009cf0: 7469 6d65 206f 6620 662c 2077 6869 6c65  time of f, while
-00009d00: 2063 6c61 6e67 2e6f 6e65 735f 6c69 6b65   clang.ones_like
-00009d10: 2077 696c 6c20 6578 7472 6163 7420 7468   will extract th
-00009d20: 6520 6d65 7461 6461 7461 206f 6620 6620  e metadata of f 
-00009d30: 6174 2074 7261 6365 2074 696d 650a 2020  at trace time.  
-00009d40: 2020 2020 2020 2020 2020 7072 696d 732e            prims.
-00009d50: 7075 745f 6772 6164 2866 2c20 636c 616e  put_grad(f, clan
-00009d60: 672e 6675 6c6c 5f6c 696b 6528 662c 2031  g.full_like(f, 1
-00009d70: 2e30 2929 0a0a 0a23 2054 4f44 4f20 5465  .0))...# TODO Te
-00009d80: 7374 2077 6974 6820 6275 6666 6572 730a  st with buffers.
-00009d90: 6465 6620 5f67 7261 645f 6f75 745f 7370  def _grad_out_sp
-00009da0: 6563 6966 6965 725f 6465 6661 756c 7428  ecifier_default(
-00009db0: 7079 7472 6565 3a20 416e 7929 202d 3e20  pytree: Any) -> 
-00009dc0: 6c69 7374 5b54 656e 736f 7250 726f 7879  list[TensorProxy
-00009dd0: 5d3a 0a20 2020 2066 6c61 7473 2c20 5f20  ]:.    flats, _ 
-00009de0: 3d20 7472 6565 5f66 6c61 7474 656e 2870  = tree_flatten(p
-00009df0: 7974 7265 6529 0a20 2020 2067 7261 6473  ytree).    grads
-00009e00: 203d 206c 6973 7428 5b70 7269 6d73 2e67   = list([prims.g
-00009e10: 6574 5f67 7261 6428 6629 2066 6f72 2066  et_grad(f) for f
-00009e20: 2069 6e20 666c 6174 7320 6966 2069 7369   in flats if isi
-00009e30: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
-00009e40: 7250 726f 7879 2920 616e 6420 662e 7265  rProxy) and f.re
-00009e50: 7175 6972 6573 5f67 7261 645d 290a 2020  quires_grad]).  
-00009e60: 2020 7265 7475 726e 2067 7261 6473 0a0a    return grads..
-00009e70: 0a23 2054 4f44 4f20 466f 726d 616c 6c79  .# TODO Formally
-00009e80: 2064 6566 696e 6520 7468 6520 2267 7261   define the "gra
-00009e90: 6469 656e 7422 206f 6620 6120 7465 6e73  dient" of a tens
-00009ea0: 6f72 0a23 2054 4f44 4f20 4966 206e 6f6e  or.# TODO If non
-00009eb0: 6520 6f66 2074 6865 2069 6e70 7574 7320  e of the inputs 
-00009ec0: 746f 2061 6e20 6f70 6572 6174 696f 6e20  to an operation 
-00009ed0: 7265 7175 6972 6520 6772 6164 2c20 7468  require grad, th
-00009ee0: 656e 2077 6520 636f 756c 6420 6c65 6176  en we could leav
-00009ef0: 6520 7468 6174 206f 7065 7261 7469 6f6e  e that operation
-00009f00: 2061 6c6f 6e65 0a23 2020 2054 6869 7320   alone.#   This 
-00009f10: 636f 756c 6420 6163 7475 616c 6c79 2069  could actually i
-00009f20: 6d70 726f 7665 2070 6572 666f 726d 616e  mprove performan
-00009f30: 6365 2069 6620 7468 6520 6f70 6572 6174  ce if the operat
-00009f40: 696f 6e20 7065 7266 6f72 6d73 2065 7874  ion performs ext
-00009f50: 7261 2063 6f6d 7075 7461 7469 6f6e 7320  ra computations 
-00009f60: 696e 2069 7473 2067 7261 6420 7472 616e  in its grad tran
-00009f70: 7366 6f72 6d0a 2320 2020 4120 776f 726b  sform.#   A work
-00009f80: 6172 6f75 6e64 2066 6f72 2074 6869 7320  around for this 
-00009f90: 776f 756c 6420 6265 2066 6f72 2074 6865  would be for the
-00009fa0: 206f 7065 7261 7469 6f6e 2069 7473 656c   operation itsel
-00009fb0: 6620 746f 2063 6865 636b 2069 6620 6974  f to check if it
-00009fc0: 7320 696e 7075 7420 7265 7175 6972 6573  s input requires
-00009fd0: 2067 7261 6420 6f72 206e 6f74 0a23 2054   grad or not.# T
-00009fe0: 7261 6e73 666f 726d 7320 6120 6675 6e63  ransforms a func
-00009ff0: 7469 6f6e 2074 6f20 636f 6d70 7574 6520  tion to compute 
-0000a000: 7468 6520 2267 7261 6469 656e 7422 206f  the "gradient" o
-0000a010: 6620 6974 7320 696e 7075 7473 2072 6571  f its inputs req
-0000a020: 7569 7269 6e67 2067 7261 642c 2070 6f73  uiring grad, pos
-0000a030: 7369 626c 790a 2320 2020 6d6f 6469 6669  sibly.#   modifi
-0000a040: 6564 2062 7920 7468 6520 6772 6164 2073  ed by the grad s
-0000a050: 7065 6369 6669 6572 7320 2873 6565 2062  pecifiers (see b
-0000a060: 656c 6f77 292e 0a23 2054 6865 206f 7074  elow)..# The opt
-0000a070: 696f 6e61 6c20 6772 6164 5f73 7065 6369  ional grad_speci
-0000a080: 6669 6572 2061 7267 756d 656e 7420 6163  fier argument ac
-0000a090: 6365 7074 7320 7468 6520 6675 6e63 7469  cepts the functi
-0000a0a0: 6f6e 2773 206f 7574 7075 742c 2072 756e  on's output, run
-0000a0b0: 7320 696e 2061 206e 6f2d 6772 6164 2063  s in a no-grad c
-0000a0c0: 6f6e 7465 7874 2c0a 2320 2020 616e 6420  ontext,.#   and 
-0000a0d0: 6361 6e20 7075 7420 6772 6164 7320 2875  can put grads (u
-0000a0e0: 7369 6e67 2070 7269 6d73 2e70 7574 5f67  sing prims.put_g
-0000a0f0: 7261 6428 2929 2066 6f72 2074 656e 736f  rad()) for tenso
-0000a100: 7273 2e20 4279 2064 6566 6175 6c74 2c20  rs. By default, 
-0000a110: 666f 7220 6576 6572 7920 7465 6e73 6f72  for every tensor
-0000a120: 206f 7574 7075 7420 226f 220a 2320 2020   output "o".#   
-0000a130: 7468 6174 2072 6571 7569 7265 7320 6772  that requires gr
-0000a140: 6164 2c20 6120 6772 6164 206f 6620 6f6e  ad, a grad of on
-0000a150: 6573 5f6c 696b 6528 6f29 2069 7320 7075  es_like(o) is pu
-0000a160: 742e 0a23 2054 6865 206f 7074 696f 6e61  t..# The optiona
-0000a170: 6c20 6772 6164 5f6f 7574 5f73 7065 6369  l grad_out_speci
-0000a180: 6669 6572 2061 6363 6570 7473 2074 6865  fier accepts the
-0000a190: 2066 756e 6374 696f 6e27 7320 696e 7075   function's inpu
-0000a1a0: 7420 616e 6420 6361 6e20 6361 6c6c 2070  t and can call p
-0000a1b0: 7269 6d73 2e67 6574 5f67 7261 6428 2920  rims.get_grad() 
-0000a1c0: 746f 0a23 2020 2061 6371 7569 7265 2061  to.#   acquire a
-0000a1d0: 6e64 2072 6574 7572 6e20 6772 6164 6965  nd return gradie
-0000a1e0: 6e74 7320 6173 2064 6573 6972 6564 2e20  nts as desired. 
-0000a1f0: 4279 2064 6566 6175 6c74 2c20 7468 6520  By default, the 
-0000a200: 696e 7075 7420 6973 2066 6c61 7474 656e  input is flatten
-0000a210: 6564 0a23 2020 2028 7472 6565 5f66 6c61  ed.#   (tree_fla
-0000a220: 7474 656e 2861 7267 732c 206b 7761 7267  tten(args, kwarg
-0000a230: 7329 2920 616e 6420 6120 666c 6174 206c  s)) and a flat l
-0000a240: 6973 7420 6f66 2067 7261 6473 2066 6f72  ist of grads for
-0000a250: 2061 6c6c 2074 656e 736f 7273 2072 6571   all tensors req
-0000a260: 7569 7269 6e67 2067 7261 640a 2320 2020  uiring grad.#   
-0000a270: 616e 6420 4e6f 6e65 2066 6f72 206f 7468  and None for oth
-0000a280: 6572 2069 6e70 7574 7320 6973 2072 6574  er inputs is ret
-0000a290: 7572 6e65 642e 0a23 2054 6865 2061 6c67  urned..# The alg
-0000a2a0: 6f72 6974 686d 2066 6f72 206d 6f64 6966  orithm for modif
-0000a2b0: 7969 6e67 2074 6865 2070 726f 6772 616d  ying the program
-0000a2c0: 2068 6173 2074 6865 2066 6f6c 6c6f 7769   has the followi
-0000a2d0: 6e67 2073 7465 7073 3a0a 2320 2020 3129  ng steps:.#   1)
-0000a2e0: 2046 6c61 7474 656e 7320 7468 6520 6f72   Flattens the or
-0000a2f0: 6967 696e 616c 2074 7261 6365 2066 6f72  iginal trace for
-0000a300: 2074 6865 2067 7261 6420 7472 616e 7366   the grad transf
-0000a310: 6f72 6d20 2d2d 2065 6e73 7569 6e67 2074  orm -- ensuing t
-0000a320: 6861 7420 616c 6c20 746f 702d 6c65 7665  hat all top-leve
-0000a330: 6c20 7379 6d62 6f6c 7320 6861 7665 0a23  l symbols have.#
-0000a340: 2020 2020 2020 2061 2067 7261 6420 6675         a grad fu
-0000a350: 6e63 7469 6f6e 2e0a 6465 6620 5f5f 6772  nction..def __gr
-0000a360: 6164 280a 2020 2020 6366 6e2c 2067 7261  ad(.    cfn, gra
-0000a370: 645f 7370 6563 6966 6965 723a 2043 616c  d_specifier: Cal
-0000a380: 6c61 626c 6520 3d20 5f67 7261 645f 7370  lable = _grad_sp
-0000a390: 6563 6966 6965 725f 6465 6661 756c 742c  ecifier_default,
-0000a3a0: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
-0000a3b0: 6965 723a 2043 616c 6c61 626c 6520 3d20  ier: Callable = 
-0000a3c0: 5f67 7261 645f 6f75 745f 7370 6563 6966  _grad_out_specif
-0000a3d0: 6965 725f 6465 6661 756c 740a 2920 2d3e  ier_default.) ->
-0000a3e0: 2043 616c 6c61 626c 653a 0a20 2020 2023   Callable:.    #
-0000a3f0: 2043 7265 6174 6573 2061 2063 7573 746f   Creates a custo
-0000a400: 6d20 7472 616e 7366 6f72 6d20 6361 6c6c  m transform call
-0000a410: 6162 6c65 2074 6861 7420 6269 6e64 7320  able that binds 
-0000a420: 7468 6520 6164 6469 7469 6f6e 616c 2061  the additional a
-0000a430: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0000a440: 6772 6164 2074 7261 6e73 666f 726d 0a20  grad transform. 
-0000a450: 2020 2040 6c61 6e67 6374 7828 4c61 6e67     @langctx(Lang
-0000a460: 7561 6765 732e 434c 414e 4729 0a20 2020  uages.CLANG).   
-0000a470: 2064 6566 205f 6772 6164 5f74 7261 6e73   def _grad_trans
-0000a480: 666f 726d 2874 7263 3a20 5472 6163 652c  form(trc: Trace,
-0000a490: 202a 2c20 6578 6563 7574 6f72 735f 6c69   *, executors_li
-0000a4a0: 7374 3a20 5365 7175 656e 6365 5b41 6e79  st: Sequence[Any
-0000a4b0: 5d29 202d 3e20 5472 6163 653a 0a20 2020  ]) -> Trace:.   
-0000a4c0: 2020 2020 2073 7461 7274 5f74 696d 655f       start_time_
-0000a4d0: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
-0000a4e0: 7328 290a 0a20 2020 2020 2020 2023 2053  s()..        # S
-0000a4f0: 5445 5020 4f4e 4520 2d2d 2046 6c61 7474  TEP ONE -- Flatt
-0000a500: 656e 7320 616e 6420 6463 6573 0a0a 2020  ens and dces..  
-0000a510: 2020 2020 2020 2320 5265 7475 726e 7320        # Returns 
-0000a520: 5472 7565 2069 6620 7468 6520 6273 796d  True if the bsym
-0000a530: 2068 6173 206e 6f20 6772 6164 2066 756e   has no grad fun
-0000a540: 6374 696f 6e2c 2061 6e64 2073 6f20 6d75  ction, and so mu
-0000a550: 7374 2062 6520 666c 6174 7465 6e65 6420  st be flattened 
-0000a560: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
-0000a570: 6e73 666f 726d 0a20 2020 2020 2020 206e  nsform.        n
-0000a580: 6576 6572 5f66 6c61 7474 656e 3a20 7365  ever_flatten: se
-0000a590: 745b 4861 7368 6162 6c65 5d20 3d20 7b70  t[Hashable] = {p
-0000a5a0: 7269 6d73 2e50 7269 6d49 4473 2e52 4554  rims.PrimIDs.RET
-0000a5b0: 5552 4e2c 2070 7269 6d73 2e50 7269 6d49  URN, prims.PrimI
-0000a5c0: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
-0000a5d0: 4c7d 0a0a 2020 2020 2020 2020 6465 6620  L}..        def 
-0000a5e0: 7368 6f75 6c64 5f66 6c61 7474 656e 5f66  should_flatten_f
-0000a5f0: 6f72 5f67 7261 6428 6273 796d 3a20 426f  or_grad(bsym: Bo
-0000a600: 756e 6453 796d 626f 6c29 202d 3e20 626f  undSymbol) -> bo
-0000a610: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-0000a620: 6966 2062 7379 6d2e 7379 6d2e 6964 2069  if bsym.sym.id i
-0000a630: 6e20 6e65 7665 725f 666c 6174 7465 6e3a  n never_flatten:
-0000a640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a650: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-0000a660: 2020 2020 2020 2020 2020 2067 7261 6466             gradf
-0000a670: 6e3a 204e 6f6e 6520 7c20 4361 6c6c 6162  n: None | Callab
-0000a680: 6c65 0a20 2020 2020 2020 2020 2020 2067  le.            g
-0000a690: 7261 6466 6e2c 205f 203d 205f 6765 745f  radfn, _ = _get_
-0000a6a0: 6772 6164 666e 5f61 6e64 5f65 7865 6375  gradfn_and_execu
-0000a6b0: 746f 7228 6273 796d 2c20 6578 6563 7574  tor(bsym, execut
-0000a6c0: 6f72 735f 6c69 7374 3d65 7865 6375 746f  ors_list=executo
-0000a6d0: 7273 5f6c 6973 7429 0a20 2020 2020 2020  rs_list).       
-0000a6e0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
-0000a6f0: 666e 2069 7320 4e6f 6e65 0a0a 2020 2020  fn is None..    
-0000a700: 2020 2020 2320 544f 444f 2052 4331 3a20      # TODO RC1: 
-0000a710: 6d61 7962 6520 6d6f 7665 2074 6f20 7072  maybe move to pr
-0000a720: 6f64 7563 6520 7468 6573 6520 616c 7761  oduce these alwa
-0000a730: 7973 206f 6e20 6372 6561 7469 6f6e 0a20  ys on creation. 
-0000a740: 2020 2020 2020 2069 6620 7472 632e 6b77         if trc.kw
-0000a750: 6172 6773 2069 7320 4e6f 6e65 3a0a 2020  args is None:.  
-0000a760: 2020 2020 2020 2020 2020 7472 632e 6b77            trc.kw
-0000a770: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
-0000a780: 2020 6966 2074 7263 2e66 6e20 6973 204e    if trc.fn is N
-0000a790: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000a7a0: 2074 7263 2e66 6e20 3d20 7472 632e 7079   trc.fn = trc.py
-0000a7b0: 7468 6f6e 5f63 616c 6c61 626c 6528 290a  thon_callable().
-0000a7c0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000a7d0: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
-0000a7e0: 6329 0a20 2020 2020 2020 2066 6c61 7474  c).        flatt
-0000a7f0: 656e 6564 5f62 7379 6d73 3a20 6c69 7374  ened_bsyms: list
-0000a800: 5b42 6f75 6e64 5379 6d62 6f6c 5d20 3d20  [BoundSymbol] = 
-0000a810: 666c 6174 7465 6e5f 666f 725f 7472 616e  flatten_for_tran
-0000a820: 7366 6f72 6d28 7368 6f75 6c64 5f66 6c61  sform(should_fla
-0000a830: 7474 656e 5f66 6f72 5f67 7261 642c 2074  tten_for_grad, t
-0000a840: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000a850: 290a 2020 2020 2020 2020 6772 6164 7472  ).        gradtr
-0000a860: 632e 626f 756e 645f 7379 6d62 6f6c 7320  c.bound_symbols 
-0000a870: 3d20 666c 6174 7465 6e65 645f 6273 796d  = flattened_bsym
-0000a880: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
-0000a890: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
-0000a8a0: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
-0000a8b0: 2054 574f 202d 2d20 5265 706c 6163 6573   TWO -- Replaces
-0000a8c0: 206f 7269 6769 6e61 6c20 6361 6c6c 7320   original calls 
-0000a8d0: 7769 7468 2067 7261 6420 6361 6c6c 730a  with grad calls.
-0000a8e0: 0a20 2020 2020 2020 2023 2044 6566 696e  .        # Defin
-0000a8f0: 6573 2074 6865 2076 6973 6974 6f72 2070  es the visitor p
-0000a900: 6174 7465 726e 2066 6f72 2074 6865 2066  attern for the f
-0000a910: 6972 7374 2070 6173 7320 6f66 2074 6865  irst pass of the
-0000a920: 2067 7261 6420 7472 616e 7366 6f72 6d2c   grad transform,
-0000a930: 0a20 2020 2020 2020 2023 2020 2077 6869  .        #   whi
-0000a940: 6368 2073 7761 7073 2042 6f75 6e64 5379  ch swaps BoundSy
-0000a950: 6d62 6f6c 7320 7769 7468 2074 6865 6972  mbols with their
-0000a960: 2067 7261 6420 6675 6e63 7469 6f6e 730a   grad functions.
-0000a970: 2020 2020 2020 2020 6465 6620 7669 7369          def visi
-0000a980: 745f 2862 7379 6d3a 2042 6f75 6e64 5379  t_(bsym: BoundSy
-0000a990: 6d62 6f6c 2920 2d3e 2043 616c 6c61 626c  mbol) -> Callabl
-0000a9a0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-0000a9b0: 7261 6466 6e3a 204e 6f6e 6520 7c20 4361  radfn: None | Ca
-0000a9c0: 6c6c 6162 6c65 0a20 2020 2020 2020 2020  llable.         
-0000a9d0: 2020 2067 7261 6466 6e2c 205f 203d 205f     gradfn, _ = _
-0000a9e0: 6765 745f 6772 6164 666e 5f61 6e64 5f65  get_gradfn_and_e
-0000a9f0: 7865 6375 746f 7228 6273 796d 2c20 6578  xecutor(bsym, ex
-0000aa00: 6563 7574 6f72 735f 6c69 7374 3d65 7865  ecutors_list=exe
-0000aa10: 6375 746f 7273 5f6c 6973 7429 0a20 2020  cutors_list).   
-0000aa20: 2020 2020 2020 2020 2063 6865 636b 280a           check(.
-0000aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa40: 6772 6164 666e 2069 7320 6e6f 7420 4e6f  gradfn is not No
-0000aa50: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0000aa60: 2020 2020 6c61 6d62 6461 3a20 6622 4661      lambda: f"Fa
-0000aa70: 696c 6564 2074 6f20 6669 6e64 2061 2067  iled to find a g
-0000aa80: 7261 6466 6e20 666f 7220 7b62 7379 6d3d  radfn for {bsym=
-0000aa90: 7d20 6166 7465 7220 666c 6174 7465 6e69  } after flatteni
-0000aaa0: 6e67 222c 0a20 2020 2020 2020 2020 2020  ng",.           
-0000aab0: 2020 2020 2065 7863 6570 7469 6f6e 5f74       exception_t
-0000aac0: 7970 653d 4173 7365 7274 696f 6e45 7272  ype=AssertionErr
-0000aad0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0000aae0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000aaf0: 7475 726e 2067 7261 6466 6e0a 0a20 2020  turn gradfn..   
-0000ab00: 2020 2020 2040 7772 6170 7328 7472 632e       @wraps(trc.
-0000ab10: 666e 2e6d 6574 6120 6966 2069 7369 6e73  fn.meta if isins
-0000ab20: 7461 6e63 6528 7472 632e 666e 2c20 5379  tance(trc.fn, Sy
-0000ab30: 6d62 6f6c 2920 656c 7365 2074 7263 2e66  mbol) else trc.f
-0000ab40: 6e29 0a20 2020 2020 2020 2064 6566 2069  n).        def i
-0000ab50: 6e74 6572 7072 6574 696e 675f 666e 282a  nterpreting_fn(*
-0000ab60: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0000ab70: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000ab80: 756c 7420 3d20 6576 616c 5f74 7261 6365  ult = eval_trace
-0000ab90: 2867 7261 6474 7263 2c20 2a61 7267 732c  (gradtrc, *args,
-0000aba0: 2073 796d 626f 6c5f 6d61 7070 6572 3d76   symbol_mapper=v
-0000abb0: 6973 6974 5f2c 202a 2a6b 7761 7267 7329  isit_, **kwargs)
-0000abc0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0000abd0: 6574 7320 6772 6164 7320 666f 7220 6f75  ets grads for ou
-0000abe0: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-0000abf0: 2023 2054 4f44 4f20 5468 6973 2065 6666   # TODO This eff
-0000ac00: 6563 7469 7665 6c79 2072 756e 7320 696e  ectively runs in
-0000ac10: 2061 206e 6f20 6772 6164 2063 6f6e 7465   a no grad conte
-0000ac20: 7874 202d 2d20 7368 6f75 6c64 2069 7420  xt -- should it 
-0000ac30: 7275 6e20 696e 2061 2067 7261 6420 636f  run in a grad co
-0000ac40: 6e74 6578 742c 0a20 2020 2020 2020 2020  ntext,.         
-0000ac50: 2020 2023 2020 206f 7220 7368 6f75 6c64     #   or should
-0000ac60: 2074 6865 7265 2062 6520 7468 6520 6f70   there be the op
-0000ac70: 7469 6f6e 2074 6f20 7275 6e20 6974 2069  tion to run it i
-0000ac80: 6e20 6120 6772 6164 2063 6f6e 7465 7874  n a grad context
-0000ac90: 3f0a 2020 2020 2020 2020 2020 2020 6772  ?.            gr
-0000aca0: 6164 5f73 7065 6369 6669 6572 2872 6573  ad_specifier(res
-0000acb0: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-0000acc0: 2023 2043 6f6e 7374 7275 6374 7320 7265   # Constructs re
-0000acd0: 7475 726e 2076 616c 7565 0a20 2020 2020  turn value.     
-0000ace0: 2020 2020 2020 2066 6c61 745f 6772 6164         flat_grad
-0000acf0: 7320 3d20 6772 6164 5f6f 7574 5f73 7065  s = grad_out_spe
-0000ad00: 6369 6669 6572 2828 6172 6773 2c20 6b77  cifier((args, kw
-0000ad10: 6172 6773 2929 0a20 2020 2020 2020 2020  args)).         
-0000ad20: 2020 2072 6574 7572 6e20 666c 6174 5f67     return flat_g
-0000ad30: 7261 6473 0a0a 2020 2020 2020 2020 2320  rads..        # 
-0000ad40: 4e4f 5445 2041 6674 6572 2074 6869 7320  NOTE After this 
-0000ad50: 6361 6c6c 2074 6865 2067 7261 6474 7263  call the gradtrc
-0000ad60: 2069 7320 696e 7661 6c69 642c 2062 6563   is invalid, bec
-0000ad70: 6175 7365 3a0a 2020 2020 2020 2020 2320  ause:.        # 
-0000ad80: 2020 3129 2054 6865 206e 6f6e 2d65 7865    1) The non-exe
-0000ad90: 6375 7461 626c 6520 7075 745f 6772 6164  cutable put_grad
-0000ada0: 206f 7065 7261 7469 6f6e 7320 6172 6520   operations are 
-0000adb0: 7374 696c 6c20 696e 2074 6865 2074 7261  still in the tra
-0000adc0: 6365 2c20 616e 6420 6d75 6c74 6970 6c65  ce, and multiple
-0000add0: 2063 616c 6c73 2074 6f20 7075 7420 6772   calls to put gr
-0000ade0: 6164 2061 7265 206e 6f74 2061 6363 756d  ad are not accum
-0000adf0: 756c 6174 6564 0a20 2020 2020 2020 2023  ulated.        #
-0000ae00: 2020 2032 2920 5468 6520 6e6f 6e2d 6578     2) The non-ex
-0000ae10: 6563 7574 6162 6c65 2067 6574 5f67 7261  ecutable get_gra
-0000ae20: 6420 6f70 6572 6174 696f 6e73 2061 7265  d operations are
-0000ae30: 2073 7469 6c6c 2069 6e20 7468 6520 7472   still in the tr
-0000ae40: 6163 652c 2061 6e64 2074 6865 7920 6d61  ace, and they ma
-0000ae50: 7920 7072 6f64 7563 6520 6469 6666 6572  y produce differ
-0000ae60: 656e 7420 7072 6f78 6965 7320 7768 656e  ent proxies when
-0000ae70: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
-0000ae80: 2063 616c 6c65 6420 6f6e 2074 6865 2073   called on the s
-0000ae90: 616d 6520 696e 7075 7473 0a20 2020 2020  ame inputs.     
-0000aea0: 2020 2023 2020 2033 2920 5468 6520 6f70     #   3) The op
-0000aeb0: 6572 6174 696f 6e73 2061 7265 206e 6f74  erations are not
-0000aec0: 2069 6e20 6120 7661 6c69 6420 6f72 6465   in a valid orde
-0000aed0: 720a 2020 2020 2020 2020 6772 6164 7472  r.        gradtr
-0000aee0: 6320 3d20 636f 6e73 7472 7563 745f 7472  c = construct_tr
-0000aef0: 6163 6528 0a20 2020 2020 2020 2020 2020  ace(.           
-0000af00: 2072 656e 616d 655f 7072 6f78 6965 733d   rename_proxies=
-0000af10: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-0000af20: 2020 2075 7365 5f64 6365 3d46 616c 7365     use_dce=False
-0000af30: 2c0a 2020 2020 2020 2020 2928 696e 7465  ,.        )(inte
-0000af40: 7270 7265 7469 6e67 5f66 6e2c 202a 6772  rpreting_fn, *gr
-0000af50: 6164 7472 632e 6172 6773 2c20 2a2a 6772  adtrc.args, **gr
-0000af60: 6164 7472 632e 6b77 6172 6773 290a 2020  adtrc.kwargs).  
-0000af70: 2020 2020 2020 6772 6164 7472 632e 7363        gradtrc.sc
-0000af80: 6f70 6573 203d 205b 6772 6164 7472 632e  opes = [gradtrc.
-0000af90: 626f 756e 645f 7379 6d62 6f6c 735d 0a20  bound_symbols]. 
-0000afa0: 2020 2020 2020 2067 7261 6474 7263 2e5f         gradtrc._
-0000afb0: 636f 6d70 6c65 7465 203d 2046 616c 7365  complete = False
-0000afc0: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
-0000afd0: 2054 4852 4545 202d 2d20 4861 6e64 6c65   THREE -- Handle
-0000afe0: 7320 7075 745f 6772 6164 2061 6e64 2067  s put_grad and g
-0000aff0: 6574 5f67 7261 6420 6f70 6572 6174 696f  et_grad operatio
-0000b000: 6e73 2061 6e64 2061 6363 756d 756c 6174  ns and accumulat
-0000b010: 6573 2067 7261 6469 656e 7473 0a0a 2020  es gradients..  
-0000b020: 2020 2020 2020 2320 4163 6375 6d75 6c61        # Accumula
-0000b030: 7465 7320 6772 6164 6965 6e74 732c 2063  tes gradients, c
-0000b040: 7265 6174 696e 6720 7468 6520 7072 696d  reating the prim
-0000b050: 616c 202d 3e20 6163 6375 6d75 6c61 7465  al -> accumulate
-0000b060: 6420 6772 6164 206d 6170 7069 6e67 0a20  d grad mapping. 
-0000b070: 2020 2020 2020 2023 2053 6574 7320 7468         # Sets th
-0000b080: 6520 7472 6163 696e 6720 636f 6e74 6578  e tracing contex
-0000b090: 7420 736f 2061 6363 756d 756c 6174 696f  t so accumulatio
-0000b0a0: 6e20 6f70 6572 6174 696f 6e73 2061 7265  n operations are
-0000b0b0: 2072 6563 6f72 6465 6420 696e 746f 2074   recorded into t
-0000b0c0: 6865 2074 7261 6365 0a20 2020 2020 2020  he trace.       
-0000b0d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000b0e0: 2020 7472 6163 6563 7478 5f74 6f6b 203d    tracectx_tok =
-0000b0f0: 2073 6574 5f74 7261 6365 6374 7828 6772   set_tracectx(gr
-0000b100: 6164 7472 6329 0a0a 2020 2020 2020 2020  adtrc)..        
-0000b110: 2020 2020 2320 4d61 7073 2070 7269 6d61      # Maps prima
-0000b120: 6c73 2074 6f20 7468 6569 7220 6772 6164  ls to their grad
-0000b130: 6965 6e74 7320 2877 6869 6368 2061 7265  ients (which are
-0000b140: 2072 6574 7572 6e65 6420 6672 6f6d 2063   returned from c
-0000b150: 616c 6c69 6e67 2067 6574 5f67 7261 6420  alling get_grad 
-0000b160: 6f6e 2074 6865 2070 7269 6d61 6c29 0a20  on the primal). 
-0000b170: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000b180: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
-0000b190: 3a20 6469 6374 5b56 6172 6961 626c 652c  : dict[Variable,
-0000b1a0: 2054 656e 736f 7250 726f 7879 5d20 3d20   TensorProxy] = 
-0000b1b0: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
-0000b1c0: 2320 4861 6e64 6c65 7320 7075 745f 6772  # Handles put_gr
-0000b1d0: 6164 206f 7065 7261 7469 6f6e 730a 2020  ad operations.  
-0000b1e0: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-0000b1f0: 2054 6869 7320 6d6f 6469 6669 6573 2061   This modifies a
-0000b200: 206c 6973 7420 7468 6174 2069 7320 6265   list that is be
-0000b210: 696e 6720 656e 756d 6572 6174 6564 206f  ing enumerated o
-0000b220: 7665 722c 2062 7574 2069 7427 7320 4f4b  ver, but it's OK
-0000b230: 2062 6563 6175 7365 2077 6527 7265 206f   because we're o
-0000b240: 6e6c 790a 2020 2020 2020 2020 2020 2020  nly.            
-0000b250: 2320 2020 6170 7065 6e64 696e 6720 746f  #   appending to
-0000b260: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
-0000b270: 6c69 7374 0a20 2020 2020 2020 2020 2020  list.           
-0000b280: 2062 7379 6d3a 2042 6f75 6e64 5379 6d62   bsym: BoundSymb
-0000b290: 6f6c 0a20 2020 2020 2020 2020 2020 2066  ol.            f
-0000b2a0: 6f72 2062 7379 6d20 696e 2067 7261 6474  or bsym in gradt
-0000b2b0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000b2c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b2d0: 2020 6964 3a20 4861 7368 6162 6c65 203d    id: Hashable =
-0000b2e0: 2062 7379 6d2e 7379 6d2e 6964 0a20 2020   bsym.sym.id.   
-0000b2f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000b300: 6964 2069 7320 7069 6473 2e50 5554 5f47  id is pids.PUT_G
-0000b310: 5241 443a 0a20 2020 2020 2020 2020 2020  RAD:.           
-0000b320: 2020 2020 2020 2020 2070 7269 6d61 6c3a           primal:
-0000b330: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-0000b340: 5072 6f78 790a 2020 2020 2020 2020 2020  Proxy.          
-0000b350: 2020 2020 2020 2020 2020 6772 6164 3a20            grad: 
-0000b360: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-0000b370: 726f 7879 0a20 2020 2020 2020 2020 2020  roxy.           
-0000b380: 2020 2020 2020 2020 2070 7269 6d61 6c2c           primal,
-0000b390: 2067 7261 6420 3d20 6273 796d 2e66 6c61   grad = bsym.fla
-0000b3a0: 745f 6172 6773 0a0a 2020 2020 2020 2020  t_args..        
-0000b3b0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0000b3c0: 444f 2053 7570 706f 7274 2061 7574 6f67  DO Support autog
-0000b3d0: 7261 6420 6f6e 206e 756d 6265 7273 0a20  rad on numbers. 
-0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3f0: 2020 2023 2046 696c 7465 7273 2063 616c     # Filters cal
-0000b400: 6c73 2074 6f20 7075 745f 6772 6164 2074  ls to put_grad t
-0000b410: 6861 7420 776f 756c 6420 7075 7420 6120  hat would put a 
-0000b420: 6772 6164 206f 6e20 6120 6e6f 6e2d 7465  grad on a non-te
-0000b430: 6e73 6f72 206f 7220 6120 7465 6e73 6f72  nsor or a tensor
-0000b440: 2074 6861 7420 646f 6573 6e27 7420 7265   that doesn't re
-0000b450: 7175 6972 6520 6772 6164 0a20 2020 2020  quire grad.     
-0000b460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b470: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0000b480: 2870 7269 6d61 6c2c 2054 656e 736f 7250  (primal, TensorP
-0000b490: 726f 7879 2920 6f72 206e 6f74 2070 7269  roxy) or not pri
-0000b4a0: 6d61 6c2e 7265 7175 6972 6573 5f67 7261  mal.requires_gra
-0000b4b0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-0000b4c0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0000b4d0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0000b4e0: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
-0000b4f0: 5375 7070 6f72 7420 636f 6d70 6c65 7820  Support complex 
-0000b500: 6175 746f 6772 6164 0a20 2020 2020 2020  autograd.       
-0000b510: 2020 2020 2020 2020 2020 2020 2063 6865               che
-0000b520: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
-0000b530: 2020 2020 2020 2020 2020 2020 6e6f 7420              not 
-0000b540: 6474 7970 6573 2e69 735f 636f 6d70 6c65  dtypes.is_comple
-0000b550: 785f 6474 7970 6528 6474 7970 6573 2e74  x_dtype(dtypes.t
-0000b560: 6f5f 6474 7970 6528 7072 696d 616c 2929  o_dtype(primal))
-0000b570: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b580: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-0000b590: 3a20 6622 436f 6d70 6c65 7820 6772 6164  : f"Complex grad
-0000b5a0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-0000b5b0: 6420 7965 7422 2c0a 2020 2020 2020 2020  d yet",.        
-0000b5c0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5e0: 2020 2076 7072 696d 616c 3a20 5661 7269     vprimal: Vari
-0000b5f0: 6162 6c65 203d 2076 6172 6961 626c 6569  able = variablei
-0000b600: 6679 2870 7269 6d61 6c29 0a20 2020 2020  fy(primal).     
-0000b610: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000b620: 6363 756d 3a20 4e6f 6e65 207c 2054 656e  ccum: None | Ten
-0000b630: 736f 7250 726f 7879 203d 2070 7269 6d61  sorProxy = prima
-0000b640: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
-0000b650: 2e67 6574 2876 7072 696d 616c 2c20 4e6f  .get(vprimal, No
-0000b660: 6e65 290a 0a20 2020 2020 2020 2020 2020  ne)..           
-0000b670: 2020 2020 2020 2020 2069 6620 6163 6375           if accu
-0000b680: 6d20 6973 204e 6f6e 653a 0a20 2020 2020  m is None:.     
-0000b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6a0: 2020 2070 7269 6d61 6c73 5f74 6f5f 6769     primals_to_gi
-0000b6b0: 6e70 7574 5f6d 6170 5b76 7072 696d 616c  nput_map[vprimal
-0000b6c0: 5d20 3d20 6772 6164 0a20 2020 2020 2020  ] = grad.       
-0000b6d0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000b6e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000b6f0: 2020 2020 2020 2020 2020 2061 6363 756d             accum
-0000b700: 203d 2061 6363 756d 202b 2067 7261 640a   = accum + grad.
-0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b720: 2020 2020 2020 2020 7072 696d 616c 735f          primals_
-0000b730: 746f 5f67 696e 7075 745f 6d61 705b 7670  to_ginput_map[vp
-0000b740: 7269 6d61 6c5d 203d 2061 6363 756d 0a0a  rimal] = accum..
-0000b750: 2020 2020 2020 2020 2020 2020 2320 4861              # Ha
-0000b760: 6e64 6c65 7320 6765 745f 6772 6164 206f  ndles get_grad o
-0000b770: 7065 7261 7469 6f6e 730a 0a20 2020 2020  perations..     
-0000b780: 2020 2020 2020 2023 2052 6573 6574 7320         # Resets 
-0000b790: 7468 6520 7377 6170 6d61 7020 666f 7220  the swapmap for 
-0000b7a0: 6772 6164 730a 2020 2020 2020 2020 2020  grads.          
-0000b7b0: 2020 7377 6170 6d61 703a 2064 6963 745b    swapmap: dict[
-0000b7c0: 5661 7269 6162 6c65 2c20 5072 6f78 795d  Variable, Proxy]
-0000b7d0: 203d 207b 7d0a 0a20 2020 2020 2020 2020   = {}..         
-0000b7e0: 2020 2066 6f72 2062 7379 6d20 696e 2067     for bsym in g
-0000b7f0: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
-0000b800: 626f 6c73 3a0a 2020 2020 2020 2020 2020  bols:.          
-0000b810: 2020 2020 2020 6964 3a20 4861 7368 6162        id: Hashab
-0000b820: 6c65 203d 2062 7379 6d2e 7379 6d2e 6964  le = bsym.sym.id
-0000b830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b840: 2069 6620 6964 2069 7320 7069 6473 2e47   if id is pids.G
-0000b850: 4554 5f47 5241 443a 0a20 2020 2020 2020  ET_GRAD:.       
-0000b860: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0000b870: 6d61 6c3a 204e 756d 6265 7220 7c20 5465  mal: Number | Te
-0000b880: 6e73 6f72 5072 6f78 790a 2020 2020 2020  nsorProxy.      
-0000b890: 2020 2020 2020 2020 2020 2020 2020 2870                (p
-0000b8a0: 7269 6d61 6c2c 2920 3d20 6273 796d 2e66  rimal,) = bsym.f
-0000b8b0: 6c61 745f 6172 6773 0a20 2020 2020 2020  lat_args.       
-0000b8c0: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-0000b8d0: 643a 204e 756d 6265 7220 7c20 5465 6e73  d: Number | Tens
-0000b8e0: 6f72 5072 6f78 7920 3d20 6273 796d 2e6f  orProxy = bsym.o
-0000b8f0: 7574 7075 740a 0a20 2020 2020 2020 2020  utput..         
-0000b900: 2020 2020 2020 2020 2020 2076 7072 696d             vprim
-0000b910: 616c 3a20 5661 7269 6162 6c65 0a20 2020  al: Variable.   
+00006f40: 205f 7363 6174 7465 725f 6164 645f 7072   _scatter_add_pr
+00006f50: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
+00006f60: 7250 726f 7879 2c20 2f2c 2069 6e64 6578  rProxy, /, index
+00006f70: 3a20 5465 6e73 6f72 5072 6f78 792c 2076  : TensorProxy, v
+00006f80: 616c 7565 3a20 5465 6e73 6f72 5072 6f78  alue: TensorProx
+00006f90: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
+00006fa0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00006fb0: 2075 7469 6c73 2e63 6865 636b 280a 2020   utils.check(.  
+00006fc0: 2020 2020 2020 6e6f 7420 7661 6c75 652e        not value.
+00006fd0: 5f72 6571 7569 7265 735f 6772 6164 206f  _requires_grad o
+00006fe0: 7220 7661 6c75 652e 7368 6170 6520 3d3d  r value.shape ==
+00006ff0: 2069 6e64 6578 2e73 6861 7065 2c0a 2020   index.shape,.  
+00007000: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+00007010: 5468 6520 6772 6164 6965 6e74 2066 6f72  The gradient for
+00007020: 2074 6865 2076 616c 7565 2054 656e 736f   the value Tenso
+00007030: 7220 6973 2069 6d70 6c65 6d65 6e74 6564  r is implemented
+00007040: 206f 6e6c 7920 7768 656e 2076 616c 7565   only when value
+00007050: 2e73 6861 7065 203d 3d20 696e 6465 782e  .shape == index.
+00007060: 7368 6170 652e 2022 0a20 2020 2020 2020  shape. ".       
+00007070: 2022 7661 6c75 6520 7368 6170 6520 6973   "value shape is
+00007080: 207b 7661 6c75 652e 7368 6170 657d 2077   {value.shape} w
+00007090: 6869 6c65 2069 6e64 6578 2073 6861 7065  hile index shape
+000070a0: 2069 7320 7b69 6e64 6578 2e73 6861 7065   is {index.shape
+000070b0: 7d22 2c0a 2020 2020 290a 0a20 2020 2066  }",.    )..    f
+000070c0: 7764 203d 2070 7269 6d73 2e73 6361 7474  wd = prims.scatt
+000070d0: 6572 5f61 6464 2861 2c20 696e 6465 782c  er_add(a, index,
+000070e0: 2076 616c 7565 2c20 6469 6d29 0a0a 2020   value, dim)..  
+000070f0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007100: 7764 290a 2020 2020 2320 4e4f 5445 2054  wd).    # NOTE T
+00007110: 6865 2076 616c 7565 2067 7261 6469 656e  he value gradien
+00007120: 7420 6973 206f 6e6c 7920 636f 7272 6563  t is only correc
+00007130: 7420 7768 656e 2073 7263 2e73 6861 7065  t when src.shape
+00007140: 203d 3d20 696e 6465 782e 7368 6170 652e   == index.shape.
+00007150: 0a20 2020 2023 2053 6565 2068 7474 7073  .    # See https
+00007160: 3a2f 2f67 6974 6875 622e 636f 6d2f 7079  ://github.com/py
+00007170: 746f 7263 682f 7079 746f 7263 682f 6973  torch/pytorch/is
+00007180: 7375 6573 2f32 3736 3134 2369 7373 7565  sues/27614#issue
+00007190: 636f 6d6d 656e 742d 3536 3436 3438 3831  comment-56464881
+000071a0: 390a 2020 2020 7661 6c75 655f 6772 6164  9.    value_grad
+000071b0: 203d 2070 7269 6d73 2e67 6174 6865 7228   = prims.gather(
+000071c0: 672c 2069 6e64 6578 2c20 6469 6d29 0a20  g, index, dim). 
+000071d0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+000071e0: 2076 616c 7565 292c 2028 672c 2076 616c   value), (g, val
+000071f0: 7565 5f67 7261 6429 290a 0a20 2020 2072  ue_grad))..    r
+00007200: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00007210: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
+00007220: 4341 5454 4552 5f41 4444 2c20 5f73 6361  CATTER_ADD, _sca
+00007230: 7474 6572 5f61 6464 5f70 7269 6d5f 6772  tter_add_prim_gr
+00007240: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00007250: 6465 6620 5f74 616b 655f 616c 6f6e 675f  def _take_along_
+00007260: 6178 6973 5f70 7269 6d5f 6772 6164 2861  axis_prim_grad(a
+00007270: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
+00007280: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
+00007290: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
+000072a0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+000072b0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
+000072c0: 655f 616c 6f6e 675f 6178 6973 2861 2c20  e_along_axis(a, 
+000072d0: 696e 6465 782c 2064 696d 290a 0a20 2020  index, dim)..   
+000072e0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+000072f0: 6429 0a20 2020 2023 204e 4f54 4520 496e  d).    # NOTE In
+00007300: 7465 6e74 696f 6e61 6c6c 7920 6e6f 7420  tentionally not 
+00007310: 6361 6c6c 696e 6720 7a65 726f 735f 6c69  calling zeros_li
+00007320: 6b65 2074 6f20 6176 6f69 6420 7072 6573  ke to avoid pres
+00007330: 6572 7669 6e67 2054 656e 736f 7250 726f  erving TensorPro
+00007340: 7879 2061 2e0a 2020 2020 2320 544f 444f  xy a..    # TODO
+00007350: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
+00007360: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
+00007370: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
+00007380: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
+00007390: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
+000073a0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
+000073b0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
+000073c0: 5f67 7261 6420 3d20 7072 696d 732e 7363  _grad = prims.sc
+000073d0: 6174 7465 725f 6164 6428 7a65 726f 732c  atter_add(zeros,
+000073e0: 2069 6e64 6578 2c20 672c 2064 696d 290a   index, g, dim).
+000073f0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00007400: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00007410: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007420: 6572 5f67 7261 6428 7069 6473 2e54 414b  er_grad(pids.TAK
+00007430: 455f 414c 4f4e 475f 4158 4953 2c20 5f74  E_ALONG_AXIS, _t
+00007440: 616b 655f 616c 6f6e 675f 6178 6973 5f70  ake_along_axis_p
+00007450: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+00007460: 6368 6374 780a 6465 6620 5f74 7261 6e73  chctx.def _trans
+00007470: 706f 7365 5f70 7269 6d5f 6772 6164 2861  pose_prim_grad(a
+00007480: 3a20 5465 6e73 6f72 5072 6f78 792c 2070  : TensorProxy, p
+00007490: 6572 6d75 7461 7469 6f6e 3a20 7475 706c  ermutation: tupl
+000074a0: 655b 696e 742c 202e 2e2e 5d29 202d 3e20  e[int, ...]) -> 
+000074b0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+000074c0: 2066 7764 203d 2070 7269 6d73 2e74 7261   fwd = prims.tra
+000074d0: 6e73 706f 7365 2861 2c20 7475 706c 6528  nspose(a, tuple(
+000074e0: 7065 726d 7574 6174 696f 6e29 290a 0a20  permutation)).. 
+000074f0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007500: 6677 6429 0a20 2020 2075 6e64 6f20 3d20  fwd).    undo = 
+00007510: 5f61 7267 736f 7274 2870 6572 6d75 7461  _argsort(permuta
+00007520: 7469 6f6e 290a 2020 2020 615f 6772 6164  tion).    a_grad
+00007530: 203d 2070 7269 6d73 2e74 7261 6e73 706f   = prims.transpo
+00007540: 7365 2867 2c20 7475 706c 6528 756e 646f  se(g, tuple(undo
+00007550: 2929 0a20 2020 2070 7574 5f67 7261 6428  )).    put_grad(
+00007560: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00007570: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00007580: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00007590: 5452 414e 5350 4f53 452c 205f 7472 616e  TRANSPOSE, _tran
+000075a0: 7370 6f73 655f 7072 696d 5f67 7261 6429  spose_prim_grad)
+000075b0: 0a0a 230a 2320 4d65 6d6f 7279 206c 6179  ..#.# Memory lay
+000075c0: 6f75 7420 6f70 6572 6174 6f72 2067 7261  out operator gra
+000075d0: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
+000075e0: 0a64 6566 205f 7374 7269 6465 5f6f 7264  .def _stride_ord
+000075f0: 6572 5f70 7269 6d5f 6772 6164 2861 3a20  er_prim_grad(a: 
+00007600: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+00007610: 6f72 6465 723a 2053 6571 7565 6e63 655b  order: Sequence[
+00007620: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
+00007630: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00007640: 7072 696d 732e 7374 7269 6465 5f6f 7264  prims.stride_ord
+00007650: 6572 2861 2c20 6f72 6465 7229 0a0a 2020  er(a, order)..  
+00007660: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007670: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
+00007680: 2861 2c20 6729 0a0a 2020 2020 7265 7475  (a, g)..    retu
+00007690: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+000076a0: 725f 6772 6164 2870 6964 732e 5354 5249  r_grad(pids.STRI
+000076b0: 4445 5f4f 5244 4552 2c20 5f73 7472 6964  DE_ORDER, _strid
+000076c0: 655f 6f72 6465 725f 7072 696d 5f67 7261  e_order_prim_gra
+000076d0: 6429 0a0a 0a23 0a23 2045 6c65 6d65 6e74  d)...#.# Element
+000076e0: 7769 7365 2075 6e61 7279 206f 7065 7261  wise unary opera
+000076f0: 746f 7220 6772 6164 730a 230a 4074 6f72  tor grads.#.@tor
+00007700: 6368 6374 780a 6465 6620 5f61 6273 5f70  chctx.def _abs_p
+00007710: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+00007720: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007730: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
+00007740: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00007750: 7764 203d 2070 7269 6d73 2e61 6273 2861  wd = prims.abs(a
+00007760: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007770: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
+00007780: 5f67 7261 6428 612c 2067 202a 206c 746f  _grad(a, g * lto
+00007790: 7263 682e 7369 676e 2861 2929 0a0a 2020  rch.sign(a))..  
+000077a0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+000077b0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000077c0: 732e 4142 532c 205f 6162 735f 7072 696d  s.ABS, _abs_prim
+000077d0: 5f67 7261 6429 0a0a 0a64 6566 205f 636f  _grad)...def _co
+000077e0: 735f 7072 696d 5f67 7261 6428 613a 204e  s_prim_grad(a: N
+000077f0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007800: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
+00007810: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00007820: 2020 6677 6420 3d20 7072 696d 732e 636f    fwd = prims.co
+00007830: 7328 6129 0a0a 2020 2020 6720 3d20 6765  s(a)..    g = ge
+00007840: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007850: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
+00007860: 282d 7072 696d 732e 7369 6e28 6129 2929  (-prims.sin(a)))
+00007870: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00007880: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00007890: 2870 6964 732e 434f 532c 205f 636f 735f  (pids.COS, _cos_
+000078a0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+000078b0: 7263 6863 7478 0a64 6566 205f 6572 665f  rchctx.def _erf_
+000078c0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+000078d0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+000078e0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+000078f0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00007900: 6677 6420 3d20 7072 696d 732e 6572 6628  fwd = prims.erf(
+00007910: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
+00007920: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00007930: 6772 6164 203d 2032 202f 206d 6174 682e  grad = 2 / math.
+00007940: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
+00007950: 6c74 6f72 6368 2e65 7870 282d 2861 2a2a  ltorch.exp(-(a**
+00007960: 3229 2920 2a20 670a 2020 2020 7075 745f  2)) * g.    put_
+00007970: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
+00007980: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00007990: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+000079a0: 7069 6473 2e45 5246 2c20 5f65 7266 5f70  pids.ERF, _erf_p
+000079b0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+000079c0: 6368 6374 780a 6465 6620 5f65 7870 5f70  chctx.def _exp_p
+000079d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+000079e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000079f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
+00007a00: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00007a10: 7764 203d 2070 7269 6d73 2e65 7870 2861  wd = prims.exp(a
+00007a20: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007a30: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+00007a40: 7261 6420 3d20 6720 2a20 6677 640a 2020  rad = g * fwd.  
+00007a50: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
+00007a60: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
+00007a70: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00007a80: 5f67 7261 6428 7069 6473 2e45 5850 2c20  _grad(pids.EXP, 
+00007a90: 5f65 7870 5f70 7269 6d5f 6772 6164 290a  _exp_prim_grad).
+00007aa0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
+00007ab0: 5f6c 6f67 5f70 7269 6d5f 6772 6164 2861  _log_prim_grad(a
+00007ac0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+00007ad0: 7250 726f 7879 2920 2d3e 204e 756d 6265  rProxy) -> Numbe
+00007ae0: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
+00007af0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00007b00: 2e6c 6f67 2861 290a 0a20 2020 2067 203d  .log(a)..    g =
+00007b10: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
+00007b20: 2020 2061 5f67 7261 6420 3d20 6720 2f20     a_grad = g / 
+00007b30: 610a 2020 2020 7075 745f 6772 6164 2861  a.    put_grad(a
+00007b40: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00007b50: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00007b60: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
+00007b70: 4f47 2c20 5f6c 6f67 5f70 7269 6d5f 6772  OG, _log_prim_gr
+00007b80: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00007b90: 6465 6620 5f6e 6567 5f70 7269 6d5f 6772  def _neg_prim_gr
+00007ba0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00007bb0: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
+00007bc0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007bd0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00007be0: 7269 6d73 2e6e 6567 2861 290a 0a20 2020  rims.neg(a)..   
+00007bf0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00007c00: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
+00007c10: 612c 202d 6729 0a0a 2020 2020 7265 7475  a, -g)..    retu
+00007c20: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00007c30: 725f 6772 6164 2870 6964 732e 4e45 472c  r_grad(pids.NEG,
+00007c40: 205f 6e65 675f 7072 696d 5f67 7261 6429   _neg_prim_grad)
+00007c50: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00007c60: 205f 7273 7172 745f 7072 696d 5f67 7261   _rsqrt_prim_gra
+00007c70: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007c80: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00007c90: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007ca0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007cb0: 2070 7269 6d73 2e72 7371 7274 2861 290a   prims.rsqrt(a).
+00007cc0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007cd0: 6428 6677 6429 0a20 2020 2023 2041 6e20  d(fwd).    # An 
+00007ce0: 616c 7465 726e 6174 6976 6520 6465 7269  alternative deri
+00007cf0: 7661 7469 6f6e 2075 7365 6420 6279 204a  vation used by J
+00007d00: 4158 2069 7320 2d30 2e35 202a 2067 202a  AX is -0.5 * g *
+00007d10: 2072 7371 7274 2878 2920 2f20 780a 2020   rsqrt(x) / x.  
+00007d20: 2020 2320 7768 6572 6520 7273 7172 7428    # where rsqrt(
+00007d30: 7829 2061 6e64 2078 2061 7265 2073 6176  x) and x are sav
+00007d40: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
+00007d50: 6172 6473 2070 6173 732e 0a20 2020 2023  ards pass..    #
+00007d60: 2054 6869 7320 6465 7269 7661 7469 6f6e   This derivation
+00007d70: 2077 6173 2073 656c 6563 7465 6420 6265   was selected be
+00007d80: 6361 7573 6520 6974 2061 766f 6964 7320  cause it avoids 
+00007d90: 7361 7669 6e67 2074 6865 2069 6e70 7574  saving the input
+00007da0: 2074 656e 736f 722e 0a20 2020 2061 5f67   tensor..    a_g
+00007db0: 7261 6420 3d20 2d30 2e35 202a 2067 202a  rad = -0.5 * g *
+00007dc0: 2066 7764 2a2a 332e 300a 2020 2020 7075   fwd**3.0.    pu
+00007dd0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+00007de0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00007df0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00007e00: 6428 7069 6473 2e52 5351 5254 2c20 5f72  d(pids.RSQRT, _r
+00007e10: 7371 7274 5f70 7269 6d5f 6772 6164 290a  sqrt_prim_grad).
+00007e20: 0a0a 6465 6620 5f73 696e 5f70 7269 6d5f  ..def _sin_prim_
+00007e30: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
+00007e40: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+00007e50: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007e60: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007e70: 2070 7269 6d73 2e73 696e 2861 290a 0a20   prims.sin(a).. 
+00007e80: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007e90: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
+00007ea0: 6428 612c 2067 202a 2070 7269 6d73 2e63  d(a, g * prims.c
+00007eb0: 6f73 2861 2929 0a0a 2020 2020 7265 7475  os(a))..    retu
+00007ec0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00007ed0: 725f 6772 6164 2870 6964 732e 5349 4e2c  r_grad(pids.SIN,
+00007ee0: 205f 7369 6e5f 7072 696d 5f67 7261 6429   _sin_prim_grad)
+00007ef0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00007f00: 205f 7461 6e68 5f70 7269 6d5f 6772 6164   _tanh_prim_grad
+00007f10: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
+00007f20: 736f 7250 726f 7879 2c20 2f29 202d 3e20  sorProxy, /) -> 
+00007f30: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00007f40: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
+00007f50: 7072 696d 732e 7461 6e68 2861 290a 0a20  prims.tanh(a).. 
+00007f60: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007f70: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+00007f80: 3d20 6720 2a20 2831 202d 2066 7764 202a  = g * (1 - fwd *
+00007f90: 2066 7764 290a 2020 2020 7075 745f 6772   fwd).    put_gr
+00007fa0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
+00007fb0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00007fc0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007fd0: 6473 2e54 414e 482c 205f 7461 6e68 5f70  ds.TANH, _tanh_p
+00007fe0: 7269 6d5f 6772 6164 290a 0a23 0a23 2045  rim_grad)..#.# E
+00007ff0: 6c65 6d65 6e74 7769 7365 2062 696e 6172  lementwise binar
+00008000: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
+00008010: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
+00008020: 6566 205f 6164 645f 7072 696d 5f67 7261  ef _add_prim_gra
+00008030: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00008040: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
+00008050: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00008060: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
+00008070: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
+00008080: 2020 2020 6677 6420 3d20 6120 2b20 620a      fwd = a + b.
+00008090: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+000080a0: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+000080b0: 6420 3d20 670a 2020 2020 625f 6772 6164  d = g.    b_grad
+000080c0: 203d 2067 0a20 2020 2070 7574 5f67 7261   = g.    put_gra
+000080d0: 6473 2828 612c 2062 292c 2028 615f 6772  ds((a, b), (a_gr
+000080e0: 6164 2c20 625f 6772 6164 2929 0a0a 2020  ad, b_grad))..  
+000080f0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00008100: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00008110: 732e 4144 442c 205f 6164 645f 7072 696d  s.ADD, _add_prim
+00008120: 5f67 7261 6429 0a0a 0a23 204e 4f54 4520  _grad)...# NOTE 
+00008130: 5468 6520 666f 6c6c 6f77 696e 6720 6772  The following gr
+00008140: 6164 2064 6566 696e 6974 696f 6e20 7265  ad definition re
+00008150: 6c69 6573 206f 6e20 7468 6520 6661 6374  lies on the fact
+00008160: 2074 6861 7420 6f6e 6c79 2069 6e65 7861   that only inexa
+00008170: 6374 2064 7479 7065 7320 6172 6520 6469  ct dtypes are di
+00008180: 6666 6572 656e 7469 6162 6c65 2c0a 2320  fferentiable,.# 
+00008190: 2020 616e 6420 746f 7263 6827 7320 7472    and torch's tr
+000081a0: 7565 2064 6976 6973 696f 6e20 6f70 6572  ue division oper
+000081b0: 6174 6f72 2061 6e64 2074 6865 2064 6976  ator and the div
+000081c0: 6973 696f 6e20 7072 696d 6974 6976 6520  ision primitive 
+000081d0: 6167 7265 6520 6f6e 2074 686f 7365 2074  agree on those t
+000081e0: 7970 6573 0a40 746f 7263 6863 7478 0a64  ypes.@torchctx.d
+000081f0: 6566 205f 6469 765f 7072 696d 5f67 7261  ef _div_prim_gra
+00008200: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00008210: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
+00008220: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00008230: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
+00008240: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
+00008250: 2020 2020 6677 6420 3d20 6120 2f20 620a      fwd = a / b.
+00008260: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00008270: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00008280: 6420 3d20 6720 2f20 620a 2020 2020 625f  d = g / b.    b_
+00008290: 6772 6164 203d 202d 6720 2a20 2828 6120  grad = -g * ((a 
+000082a0: 2f20 6229 202f 2062 290a 2020 2020 7075  / b) / b).    pu
+000082b0: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
+000082c0: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
+000082d0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+000082e0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+000082f0: 6428 7069 6473 2e44 4956 2c20 5f64 6976  d(pids.DIV, _div
+00008300: 5f70 7269 6d5f 6772 6164 290a 0a23 2043  _prim_grad)..# C
+00008310: 6f6d 7061 7269 736f 6e20 6f70 6572 6174  omparison operat
+00008320: 6f72 7320 2d2d 2074 6865 7365 2063 7265  ors -- these cre
+00008330: 6174 6520 6e6f 2067 7261 6420 6173 736f  ate no grad asso
+00008340: 6369 6174 696f 6e73 0a72 6567 6973 7465  ciations.registe
+00008350: 725f 6772 6164 2870 6964 732e 4551 2c20  r_grad(pids.EQ, 
+00008360: 7072 696d 732e 6571 290a 7265 6769 7374  prims.eq).regist
+00008370: 6572 5f67 7261 6428 7069 6473 2e47 452c  er_grad(pids.GE,
+00008380: 2070 7269 6d73 2e67 6529 0a72 6567 6973   prims.ge).regis
+00008390: 7465 725f 6772 6164 2870 6964 732e 4c54  ter_grad(pids.LT
+000083a0: 2c20 7072 696d 732e 6c74 290a 7265 6769  , prims.lt).regi
+000083b0: 7374 6572 5f67 7261 6428 7069 6473 2e4e  ster_grad(pids.N
+000083c0: 452c 2070 7269 6d73 2e6e 6529 0a72 6567  E, prims.ne).reg
+000083d0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+000083e0: 4754 2c20 7072 696d 732e 6774 290a 7265  GT, prims.gt).re
+000083f0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00008400: 2e4c 452c 2070 7269 6d73 2e6c 6529 0a0a  .LE, prims.le)..
+00008410: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+00008420: 6d75 6c5f 7072 696d 5f67 7261 6428 613a  mul_prim_grad(a:
+00008430: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00008440: 5072 6f78 792c 2062 3a20 4e75 6d62 6572  Proxy, b: Number
+00008450: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00008460: 2f29 202d 3e20 4e75 6d62 6572 207c 2054  /) -> Number | T
+00008470: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00008480: 6677 6420 3d20 6120 2a20 620a 0a20 2020  fwd = a * b..   
+00008490: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+000084a0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
+000084b0: 6220 2a20 670a 2020 2020 625f 6772 6164  b * g.    b_grad
+000084c0: 203d 2061 202a 2067 0a20 2020 2070 7574   = a * g.    put
+000084d0: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
+000084e0: 615f 6772 6164 2c20 625f 6772 6164 2929  a_grad, b_grad))
+000084f0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00008500: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00008510: 2870 6964 732e 4d55 4c2c 205f 6d75 6c5f  (pids.MUL, _mul_
+00008520: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+00008530: 7263 6863 7478 0a64 6566 205f 7375 625f  rchctx.def _sub_
+00008540: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+00008550: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00008560: 792c 2062 3a20 4e75 6d62 6572 207c 2054  y, b: Number | T
+00008570: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
+00008580: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00008590: 6f78 793a 0a20 2020 2066 7764 203d 2061  oxy:.    fwd = a
+000085a0: 202d 2062 0a0a 2020 2020 6720 3d20 6765   - b..    g = ge
+000085b0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+000085c0: 615f 6772 6164 203d 2067 0a20 2020 2062  a_grad = g.    b
+000085d0: 5f67 7261 6420 3d20 2d67 0a20 2020 2070  _grad = -g.    p
+000085e0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
+000085f0: 2028 615f 6772 6164 2c20 625f 6772 6164   (a_grad, b_grad
+00008600: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
+00008610: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00008620: 6164 2870 6964 732e 5355 422c 205f 7375  ad(pids.SUB, _su
+00008630: 625f 7072 696d 5f67 7261 6429 0a0a 0a23  b_prim_grad)...#
+00008640: 0a23 2043 6f6e 6469 7469 6f6e 616c 206f  .# Conditional o
+00008650: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+00008660: 0a0a 6465 6620 5f77 6865 7265 5f70 7269  ..def _where_pri
+00008670: 6d5f 6772 6164 2870 7265 643a 204e 756d  m_grad(pred: Num
+00008680: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00008690: 792c 2061 3a20 4e75 6d62 6572 207c 2054  y, a: Number | T
+000086a0: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
+000086b0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+000086c0: 6f78 7929 202d 3e20 5465 6e73 6f72 5072  oxy) -> TensorPr
+000086d0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+000086e0: 7269 6d73 2e77 6865 7265 2870 7265 642c  rims.where(pred,
+000086f0: 2061 2c20 6229 0a0a 2020 2020 6720 3d20   a, b)..    g = 
+00008700: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00008710: 2020 615f 6772 6164 203d 206c 746f 7263    a_grad = ltorc
+00008720: 682e 7768 6572 6528 7072 6564 2c20 672c  h.where(pred, g,
+00008730: 2030 290a 2020 2020 625f 6772 6164 203d   0).    b_grad =
+00008740: 206c 746f 7263 682e 7768 6572 6528 7072   ltorch.where(pr
+00008750: 6564 2c20 302c 2067 290a 2020 2020 7075  ed, 0, g).    pu
+00008760: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
+00008770: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
+00008780: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00008790: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+000087a0: 6428 7069 6473 2e57 4845 5245 2c20 5f77  d(pids.WHERE, _w
+000087b0: 6865 7265 5f70 7269 6d5f 6772 6164 290a  here_prim_grad).
+000087c0: 0a23 0a23 2052 6564 7563 7469 6f6e 206f  .#.# Reduction o
+000087d0: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+000087e0: 0a0a 2320 544f 444f 2052 6576 6965 7720  ..# TODO Review 
+000087f0: 7477 6561 6b69 6e67 2067 7261 645f 6368  tweaking grad_ch
+00008800: 6f6f 7365 725f 7075 6c6c 6261 636b 2069  ooser_pullback i
+00008810: 6e74 6572 6661 6365 0a64 6566 205f 616d  nterface.def _am
+00008820: 6178 5f70 7269 6d5f 6772 6164 2861 3a20  ax_prim_grad(a: 
+00008830: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+00008840: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
+00008850: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
+00008860: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00008870: 7269 6d73 2e61 6d61 7828 612c 2064 696d  rims.amax(a, dim
+00008880: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
+00008890: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+000088a0: 6772 6164 203d 2067 7261 645f 6368 6f6f  grad = grad_choo
+000088b0: 7365 725f 6261 636b 7761 7264 2866 7764  ser_backward(fwd
+000088c0: 2c20 612c 2061 2e73 6861 7065 2c20 6469  , a, a.shape, di
+000088d0: 6d73 2c20 6729 0a20 2020 2070 7574 5f67  ms, g).    put_g
+000088e0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+000088f0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008900: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008910: 6964 732e 414d 4158 2c20 5f61 6d61 785f  ids.AMAX, _amax_
+00008920: 7072 696d 5f67 7261 6429 0a0a 0a64 6566  prim_grad)...def
+00008930: 205f 7375 6d5f 7072 696d 5f67 7261 6428   _sum_prim_grad(
+00008940: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+00008950: 2f2c 2064 696d 733a 2053 6571 7565 6e63  /, dims: Sequenc
+00008960: 655b 696e 745d 2920 2d3e 2054 656e 736f  e[int]) -> Tenso
+00008970: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00008980: 3d20 7072 696d 732e 7375 6d28 612c 2064  = prims.sum(a, d
+00008990: 696d 7329 0a0a 2020 2020 6720 3d20 6765  ims)..    g = ge
+000089a0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+000089b0: 615f 6772 6164 203d 2072 6573 746f 7265  a_grad = restore
+000089c0: 5f72 6564 7563 6564 5f64 696d 7328 672c  _reduced_dims(g,
+000089d0: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
+000089e0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+000089f0: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00008a00: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00008a10: 6572 5f67 7261 6428 7069 6473 2e53 554d  er_grad(pids.SUM
+00008a20: 2c20 5f73 756d 5f70 7269 6d5f 6772 6164  , _sum_prim_grad
+00008a30: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00008a40: 6620 5f74 6f70 6b5f 7072 696d 5f67 7261  f _topk_prim_gra
+00008a50: 6428 0a20 2020 2061 3a20 5465 6e73 6f72  d(.    a: Tensor
+00008a60: 5072 6f78 792c 202f 2c20 6b3a 2069 6e74  Proxy, /, k: int
+00008a70: 2c20 6469 6d3a 204e 6f6e 6520 7c20 696e  , dim: None | in
+00008a80: 7420 3d20 4e6f 6e65 2c20 6c61 7267 6573  t = None, larges
+00008a90: 743a 2062 6f6f 6c20 3d20 5472 7565 2c20  t: bool = True, 
+00008aa0: 736f 7274 6564 3a20 626f 6f6c 203d 2054  sorted: bool = T
+00008ab0: 7275 652c 202a 2c20 6f75 743d 4e6f 6e65  rue, *, out=None
+00008ac0: 0a29 3a0a 2020 2020 6677 6420 3d20 7072  .):.    fwd = pr
+00008ad0: 696d 732e 746f 706b 2861 2c20 6b2c 2064  ims.topk(a, k, d
+00008ae0: 696d 2c20 6c61 7267 6573 742c 2073 6f72  im, largest, sor
+00008af0: 7465 642c 206f 7574 3d6f 7574 290a 2020  ted, out=out).  
+00008b00: 2020 7661 6c2c 2069 6478 203d 2066 7764    val, idx = fwd
+00008b10: 0a0a 2020 2020 7661 6c5f 6772 6164 203d  ..    val_grad =
+00008b20: 2067 6574 5f67 7261 6428 7661 6c29 0a0a   get_grad(val)..
+00008b30: 2020 2020 615f 6772 6164 203d 206c 746f      a_grad = lto
+00008b40: 7263 682e 7a65 726f 735f 6c69 6b65 2861  rch.zeros_like(a
+00008b50: 290a 2020 2020 2320 544f 444f 3a20 7265  ).    # TODO: re
+00008b60: 706c 6163 6520 7769 7468 2073 6361 7474  place with scatt
+00008b70: 6572 206f 6e63 6520 7765 2068 6176 6520  er once we have 
+00008b80: 6974 2e0a 2020 2020 2320 7363 6174 7465  it..    # scatte
+00008b90: 725f 6164 6420 6973 2061 2070 7269 6d20  r_add is a prim 
+00008ba0: 616e 6420 6974 2072 656c 6965 7320 6f6e  and it relies on
+00008bb0: 2061 746f 6d69 6320 6f70 732e 0a20 2020   atomic ops..   
+00008bc0: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
+00008bd0: 2e73 6361 7474 6572 5f61 6464 2861 5f67  .scatter_add(a_g
+00008be0: 7261 642c 2064 696d 2c20 6964 782c 2076  rad, dim, idx, v
+00008bf0: 616c 5f67 7261 6429 0a20 2020 2070 7574  al_grad).    put
+00008c00: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
+00008c10: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00008c20: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00008c30: 2870 6964 732e 544f 504b 2c20 5f74 6f70  (pids.TOPK, _top
+00008c40: 6b5f 7072 696d 5f67 7261 6429 0a0a 0a23  k_prim_grad)...#
+00008c50: 2054 4f44 4f20 4669 7820 6469 7669 7369   TODO Fix divisi
+00008c60: 6f6e 2062 7920 7a65 726f 2077 6865 6e20  on by zero when 
+00008c70: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
+00008c80: 3d20 3020 6f72 2077 6865 6e20 6d65 616e  = 0 or when mean
+00008c90: 2e6e 756d 656c 203d 3d20 300a 2320 2020  .numel == 0.#   
+00008ca0: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
+00008cb0: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
+00008cc0: 6d69 6c61 722e 0a23 2054 4f44 4f20 4669  milar..# TODO Fi
+00008cd0: 7820 6772 6164 2077 6865 6e20 636f 7272  x grad when corr
+00008ce0: 6563 7469 6f6e 203e 206e 5f65 6c65 6d5f  ection > n_elem_
+00008cf0: 7265 6475 6365 642e 0a40 746f 7263 6863  reduced..@torchc
+00008d00: 7478 0a64 6566 205f 7661 725f 6d65 616e  tx.def _var_mean
+00008d10: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00008d20: 6e73 6f72 5072 6f78 792c 202f 2c20 6469  nsorProxy, /, di
+00008d30: 6d73 3a20 5365 7175 656e 6365 5b69 6e74  ms: Sequence[int
+00008d40: 5d2c 202a 2c20 636f 7272 6563 7469 6f6e  ], *, correction
+00008d50: 3a20 4e75 6d62 6572 2920 2d3e 2054 656e  : Number) -> Ten
+00008d60: 736f 7250 726f 7879 3a0a 2020 2020 762c  sorProxy:.    v,
+00008d70: 206d 203d 2070 7269 6d73 2e76 6172 5f6d   m = prims.var_m
+00008d80: 6561 6e28 612c 2064 696d 732c 2063 6f72  ean(a, dims, cor
+00008d90: 7265 6374 696f 6e3d 636f 7272 6563 7469  rection=correcti
+00008da0: 6f6e 290a 0a20 2020 2067 7620 3d20 6765  on)..    gv = ge
+00008db0: 745f 6772 6164 2876 290a 2020 2020 676d  t_grad(v).    gm
+00008dc0: 203d 2067 6574 5f67 7261 6428 6d29 0a0a   = get_grad(m)..
+00008dd0: 2020 2020 6e5f 656c 656d 5f72 6564 7563      n_elem_reduc
+00008de0: 6564 203d 2061 2e6e 756d 656c 2829 202f  ed = a.numel() /
+00008df0: 2f20 6d2e 6e75 6d65 6c28 2920 6966 2061  / m.numel() if a
+00008e00: 2e6e 756d 656c 2829 2021 3d20 3020 656c  .numel() != 0 el
+00008e10: 7365 2031 0a0a 2020 2020 2320 436f 6d70  se 1..    # Comp
+00008e20: 7574 6573 206d 6561 6e20 6277 640a 2020  utes mean bwd.  
+00008e30: 2020 6d65 616e 5f73 6361 6c65 203d 2031    mean_scale = 1
+00008e40: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
+00008e50: 6365 640a 2020 2020 6d65 616e 5f67 7261  ced.    mean_gra
+00008e60: 6420 3d20 6d65 616e 5f73 6361 6c65 202a  d = mean_scale *
+00008e70: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
+00008e80: 5f64 696d 7328 676d 2c20 6469 6d73 2c20  _dims(gm, dims, 
+00008e90: 612e 7368 6170 6529 0a0a 2020 2020 2320  a.shape)..    # 
+00008ea0: 436f 6d70 7574 6573 2076 6172 2062 7764  Computes var bwd
+00008eb0: 0a20 2020 206e 6f72 6d61 6c69 7a61 7469  .    normalizati
+00008ec0: 6f6e 5f73 6361 6c61 7220 3d20 6e5f 656c  on_scalar = n_el
+00008ed0: 656d 5f72 6564 7563 6564 202d 2063 6f72  em_reduced - cor
+00008ee0: 7265 6374 696f 6e0a 2020 2020 7265 7374  rection.    rest
+00008ef0: 6f72 6564 5f67 7620 3d20 7265 7374 6f72  ored_gv = restor
+00008f00: 655f 7265 6475 6365 645f 6469 6d73 2867  e_reduced_dims(g
+00008f10: 762c 2064 696d 732c 2061 2e73 6861 7065  v, dims, a.shape
+00008f20: 290a 2020 2020 2320 496e 7365 7274 696e  ).    # Insertin
+00008f30: 6720 6120 636f 6e76 6572 7369 6f6e 2074  g a conversion t
+00008f40: 6f20 7468 6520 7361 6d65 2064 7479 7065  o the same dtype
+00008f50: 2074 6f20 6469 7361 626c 6520 6e76 4675   to disable nvFu
+00008f60: 7365 7220 6578 6563 7574 6f72 7327 730a  ser executors's.
+00008f70: 2020 2020 2320 626f 6f6b 656e 6420 6f70      # bookend op
+00008f80: 7469 6d69 7a61 7469 6f6e 2028 6e76 5f65  timization (nv_e
+00008f90: 6e61 626c 655f 626f 6f6b 656e 6429 2c20  nable_bookend), 
+00008fa0: 7768 6963 6820 6361 6e20 6361 7573 6520  which can cause 
+00008fb0: 7468 6520 6261 636b 7761 7264 0a20 2020  the backward.   
+00008fc0: 2023 2070 6173 7320 746f 2067 656e 6572   # pass to gener
+00008fd0: 6174 6520 7477 6f20 6b65 726e 656c 730a  ate two kernels.
+00008fe0: 2020 2020 6d65 616e 5f6d 6474 7970 6520      mean_mdtype 
+00008ff0: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
+00009000: 656c 656d 656e 745f 7479 7065 286d 2c20  element_type(m, 
+00009010: 6d2e 6474 7970 6529 0a20 2020 2072 6573  m.dtype).    res
+00009020: 746f 7265 645f 6d65 616e 203d 2072 6573  tored_mean = res
+00009030: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
+00009040: 7328 6d65 616e 5f6d 6474 7970 652c 2064  s(mean_mdtype, d
+00009050: 696d 732c 2061 2e73 6861 7065 290a 2020  ims, a.shape).  
+00009060: 2020 7661 725f 6772 6164 203d 2028 3220    var_grad = (2 
+00009070: 2a20 7265 7374 6f72 6564 5f67 7620 2a20  * restored_gv * 
+00009080: 2861 202d 2072 6573 746f 7265 645f 6d65  (a - restored_me
+00009090: 616e 2929 202f 206e 6f72 6d61 6c69 7a61  an)) / normaliza
+000090a0: 7469 6f6e 5f73 6361 6c61 720a 0a20 2020  tion_scalar..   
+000090b0: 2070 7574 5f67 7261 6428 612c 206d 6561   put_grad(a, mea
+000090c0: 6e5f 6772 6164 202b 2076 6172 5f67 7261  n_grad + var_gra
+000090d0: 6429 0a0a 2020 2020 7265 7475 726e 2076  d)..    return v
+000090e0: 2c20 6d0a 0a0a 7265 6769 7374 6572 5f67  , m...register_g
+000090f0: 7261 6428 7069 6473 2e56 4152 5f4d 4541  rad(pids.VAR_MEA
+00009100: 4e2c 205f 7661 725f 6d65 616e 5f70 7269  N, _var_mean_pri
+00009110: 6d5f 6772 6164 290a 0a0a 230a 2320 4c69  m_grad)...#.# Li
+00009120: 6e65 6172 2061 6c67 6562 7261 206f 7065  near algebra ope
+00009130: 7261 746f 7220 6772 6164 730a 230a 4074  rator grads.#.@t
+00009140: 6f72 6368 6374 780a 6465 6620 5f6c 696e  orchctx.def _lin
+00009150: 6561 725f 7072 696d 5f67 7261 6428 613a  ear_prim_grad(a:
+00009160: 2054 656e 736f 7250 726f 7879 2c20 773a   TensorProxy, w:
+00009170: 2054 656e 736f 7250 726f 7879 2c20 6269   TensorProxy, bi
+00009180: 6173 3a20 4e6f 6e65 207c 2054 656e 736f  as: None | Tenso
+00009190: 7250 726f 7879 2920 2d3e 2054 656e 736f  rProxy) -> Tenso
+000091a0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+000091b0: 3d20 7072 696d 732e 6c69 6e65 6172 2861  = prims.linear(a
+000091c0: 2c20 772c 2062 6961 7329 0a0a 2020 2020  , w, bias)..    
+000091d0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+000091e0: 290a 0a20 2020 2066 6972 7374 5f64 696d  )..    first_dim
+000091f0: 203d 202d 320a 2020 2020 6772 6164 5f61   = -2.    grad_a
+00009200: 203d 206c 746f 7263 682e 6d61 746d 756c   = ltorch.matmul
+00009210: 2867 2e72 6573 6861 7065 282d 312c 2067  (g.reshape(-1, g
+00009220: 2e73 6861 7065 5b2d 315d 292c 2077 292e  .shape[-1]), w).
+00009230: 7265 7368 6170 6528 612e 7368 6170 6529  reshape(a.shape)
+00009240: 0a0a 2020 2020 6772 6164 5f77 3a20 5465  ..    grad_w: Te
+00009250: 6e73 6f72 5072 6f78 790a 2020 2020 6966  nsorProxy.    if
+00009260: 2061 2e6e 6469 6d20 3d3d 2031 3a0a 2020   a.ndim == 1:.  
+00009270: 2020 2020 2020 6772 6164 5f77 203d 206c        grad_w = l
+00009280: 746f 7263 682e 6d61 746d 756c 2867 2e75  torch.matmul(g.u
+00009290: 6e73 7175 6565 7a65 2866 6972 7374 5f64  nsqueeze(first_d
+000092a0: 696d 292e 6d54 2c20 612e 756e 7371 7565  im).mT, a.unsque
+000092b0: 657a 6528 6669 7273 745f 6469 6d29 290a  eze(first_dim)).
+000092c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000092d0: 2020 6772 6164 5f77 203d 206c 746f 7263    grad_w = ltorc
+000092e0: 682e 6d61 746d 756c 2867 2e72 6573 6861  h.matmul(g.resha
+000092f0: 7065 282d 312c 2067 2e73 6861 7065 5b2d  pe(-1, g.shape[-
+00009300: 315d 292e 6d54 2c20 612e 7265 7368 6170  1]).mT, a.reshap
+00009310: 6528 2d31 2c20 612e 7368 6170 655b 2d31  e(-1, a.shape[-1
+00009320: 5d29 290a 0a20 2020 2070 7574 5f67 7261  ]))..    put_gra
+00009330: 6473 2828 612c 2077 292c 2028 6772 6164  ds((a, w), (grad
+00009340: 5f61 2c20 6772 6164 5f77 2929 0a0a 2020  _a, grad_w))..  
+00009350: 2020 6966 2062 6961 7320 6973 206e 6f74    if bias is not
+00009360: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00009370: 6620 672e 6e64 696d 203e 2031 3a0a 2020  f g.ndim > 1:.  
+00009380: 2020 2020 2020 2020 2020 6772 6164 5f62            grad_b
+00009390: 6961 7320 3d20 6c74 6f72 6368 2e73 756d  ias = ltorch.sum
+000093a0: 2867 2c20 7475 706c 6528 7261 6e67 6528  (g, tuple(range(
+000093b0: 672e 6e64 696d 202d 2031 2929 290a 2020  g.ndim - 1))).  
+000093c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000093d0: 2020 2020 2020 2020 6772 6164 5f62 6961          grad_bia
+000093e0: 7320 3d20 670a 2020 2020 2020 2020 7075  s = g.        pu
+000093f0: 745f 6772 6164 2862 6961 732c 2067 7261  t_grad(bias, gra
+00009400: 645f 6269 6173 290a 0a20 2020 2072 6574  d_bias)..    ret
+00009410: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00009420: 6572 5f67 7261 6428 7069 6473 2e4c 494e  er_grad(pids.LIN
+00009430: 4541 522c 205f 6c69 6e65 6172 5f70 7269  EAR, _linear_pri
+00009440: 6d5f 6772 6164 290a 0a0a 2320 544f 444f  m_grad)...# TODO
+00009450: 2041 6464 2065 7870 6c69 6369 7420 6c74   Add explicit lt
+00009460: 6f72 6368 2076 7320 636c 616e 6720 6d6f  orch vs clang mo
+00009470: 6475 6c65 2074 6f20 7468 6520 7465 6e73  dule to the tens
+00009480: 6f72 206f 7065 7261 7469 6f6e 7320 6265  or operations be
+00009490: 6c6f 770a 2320 544f 444f 2063 6f75 6c64  low.# TODO could
+000094a0: 2077 6520 6765 7420 7269 6420 6f66 2074   we get rid of t
+000094b0: 6865 2066 696e 616c 2073 7175 6565 7a65  he final squeeze
+000094c0: 7320 696e 2074 6865 2062 2e6e 6469 6d20  s in the b.ndim 
+000094d0: 3d3d 2031 2063 6173 6520 616e 6420 7468  == 1 case and th
+000094e0: 6520 612e 6e64 696d 203d 3d20 3120 6361  e a.ndim == 1 ca
+000094f0: 7365 3f0a 4074 6f72 6368 6374 780a 6465  se?.@torchctx.de
+00009500: 6620 5f6d 6174 6d75 6c5f 7072 696d 5f67  f _matmul_prim_g
+00009510: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
+00009520: 7879 2c20 623a 2054 656e 736f 7250 726f  xy, b: TensorPro
+00009530: 7879 2c20 2f29 202d 3e20 5465 6e73 6f72  xy, /) -> Tensor
+00009540: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00009550: 2070 7269 6d73 2e6d 6174 6d75 6c28 612c   prims.matmul(a,
+00009560: 2062 290a 2020 2020 6720 3d20 6765 745f   b).    g = get_
+00009570: 6772 6164 2866 7764 290a 0a20 2020 206c  grad(fwd)..    l
+00009580: 6173 745f 6469 6d20 3d20 282d 312c 290a  ast_dim = (-1,).
+00009590: 2020 2020 6669 7273 745f 6469 6d20 3d20      first_dim = 
+000095a0: 282d 322c 290a 2020 2020 6966 2061 2e6e  (-2,).    if a.n
+000095b0: 6469 6d20 3d3d 2031 2061 6e64 2062 2e6e  dim == 1 and b.n
+000095c0: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
+000095d0: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
+000095e0: 6229 2c20 2867 202a 2062 2c20 6720 2a20  b), (g * b, g * 
+000095f0: 6129 290a 2020 2020 656c 6966 2062 2e6e  a)).    elif b.n
+00009600: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
+00009610: 2020 6761 203d 2075 6e73 7175 6565 7a65    ga = unsqueeze
+00009620: 2867 2c20 6c61 7374 5f64 696d 2920 4020  (g, last_dim) @ 
+00009630: 756e 7371 7565 657a 6528 622c 206c 6173  unsqueeze(b, las
+00009640: 745f 6469 6d29 2e6d 540a 2020 2020 2020  t_dim).mT.      
+00009650: 2020 6762 203d 2061 2e6d 5420 4020 756e    gb = a.mT @ un
+00009660: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
+00009670: 6469 6d29 0a20 2020 2020 2020 2069 6620  dim).        if 
+00009680: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
+00009690: 2020 2020 2020 2020 6762 203d 2073 7175          gb = squ
+000096a0: 6565 7a65 2867 622c 206c 6173 745f 6469  eeze(gb, last_di
+000096b0: 6d29 0a20 2020 2020 2020 2020 2020 2067  m).            g
+000096c0: 6220 3d20 6c74 6f72 6368 2e73 756d 2867  b = ltorch.sum(g
+000096d0: 622c 2074 7570 6c65 2872 616e 6765 2867  b, tuple(range(g
+000096e0: 622e 6e64 696d 202d 2031 2929 290a 2020  b.ndim - 1))).  
+000096f0: 2020 2020 2020 7075 745f 6772 6164 7328        put_grads(
+00009700: 2861 2c20 6229 2c20 2867 612c 2067 622e  (a, b), (ga, gb.
+00009710: 7371 7565 657a 6528 2929 290a 2020 2020  squeeze())).    
+00009720: 656c 6966 2061 2e6e 6469 6d20 3d3d 2031  elif a.ndim == 1
+00009730: 3a0a 2020 2020 2020 2020 6761 203d 2075  :.        ga = u
+00009740: 6e73 7175 6565 7a65 2867 2c20 6669 7273  nsqueeze(g, firs
+00009750: 745f 6469 6d29 2040 2062 2e6d 540a 2020  t_dim) @ b.mT.  
+00009760: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
+00009770: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00009780: 2067 6120 3d20 6c74 6f72 6368 2e73 756d   ga = ltorch.sum
+00009790: 2867 612c 2074 7570 6c65 2872 616e 6765  (ga, tuple(range
+000097a0: 2867 612e 6e64 696d 202d 2031 2929 290a  (ga.ndim - 1))).
+000097b0: 2020 2020 2020 2020 6762 203d 2075 6e73          gb = uns
+000097c0: 7175 6565 7a65 2861 2c20 6669 7273 745f  queeze(a, first_
+000097d0: 6469 6d29 2e6d 5420 4020 756e 7371 7565  dim).mT @ unsque
+000097e0: 657a 6528 672c 2066 6972 7374 5f64 696d  eze(g, first_dim
+000097f0: 290a 2020 2020 2020 2020 7075 745f 6772  ).        put_gr
+00009800: 6164 7328 2861 2c20 6229 2c20 2867 612e  ads((a, b), (ga.
+00009810: 7371 7565 657a 6528 292c 2067 6229 290a  squeeze(), gb)).
+00009820: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00009830: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
+00009840: 6229 2c20 2867 2040 2062 2e6d 542c 2061  b), (g @ b.mT, a
+00009850: 2e6d 5420 4020 6729 290a 0a20 2020 2072  .mT @ g))..    r
+00009860: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00009870: 7374 6572 5f67 7261 6428 7069 6473 2e4d  ster_grad(pids.M
+00009880: 4154 4d55 4c2c 205f 6d61 746d 756c 5f70  ATMUL, _matmul_p
+00009890: 7269 6d5f 6772 6164 290a 0a23 0a23 204e  rim_grad)..#.# N
+000098a0: 4e20 6f70 6572 6174 6f72 2067 7261 6473  N operator grads
+000098b0: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
+000098c0: 6566 205f 656d 6265 6464 696e 675f 7072  ef _embedding_pr
+000098d0: 696d 5f67 7261 6428 0a20 2020 2061 3a20  im_grad(.    a: 
+000098e0: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+000098f0: 7765 6967 6874 2c20 2a2c 2070 6164 6469  weight, *, paddi
+00009900: 6e67 5f69 6478 3d2d 312c 206d 6178 5f6e  ng_idx=-1, max_n
+00009910: 6f72 6d3d 4e6f 6e65 2c20 6e6f 726d 5f74  orm=None, norm_t
+00009920: 7970 653d 322e 302c 2073 6361 6c65 5f67  ype=2.0, scale_g
+00009930: 7261 645f 6279 5f66 7265 713d 4661 6c73  rad_by_freq=Fals
+00009940: 652c 2073 7061 7273 653d 4661 6c73 650a  e, sparse=False.
+00009950: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00009960: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00009970: 732e 656d 6265 6464 696e 6728 0a20 2020  s.embedding(.   
+00009980: 2020 2020 2061 2c0a 2020 2020 2020 2020       a,.        
+00009990: 7765 6967 6874 2c0a 2020 2020 2020 2020  weight,.        
+000099a0: 7061 6464 696e 675f 6964 783d 7061 6464  padding_idx=padd
+000099b0: 696e 675f 6964 782c 0a20 2020 2020 2020  ing_idx,.       
+000099c0: 206d 6178 5f6e 6f72 6d3d 6d61 785f 6e6f   max_norm=max_no
+000099d0: 726d 2c0a 2020 2020 2020 2020 6e6f 726d  rm,.        norm
+000099e0: 5f74 7970 653d 6e6f 726d 5f74 7970 652c  _type=norm_type,
+000099f0: 0a20 2020 2020 2020 2073 6361 6c65 5f67  .        scale_g
+00009a00: 7261 645f 6279 5f66 7265 713d 7363 616c  rad_by_freq=scal
+00009a10: 655f 6772 6164 5f62 795f 6672 6571 2c0a  e_grad_by_freq,.
+00009a20: 2020 2020 2020 2020 7370 6172 7365 3d73          sparse=s
+00009a30: 7061 7273 652c 0a20 2020 2029 0a0a 2020  parse,.    )..  
+00009a40: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00009a50: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
+00009a60: 2070 7269 6d73 2e65 6d62 6564 6469 6e67   prims.embedding
+00009a70: 5f62 6163 6b77 6172 6428 672c 2061 2c20  _backward(g, a, 
+00009a80: 7765 6967 6874 2e73 6861 7065 5b30 5d2c  weight.shape[0],
+00009a90: 2070 6164 6469 6e67 5f69 6478 2c20 7363   padding_idx, sc
+00009aa0: 616c 655f 6772 6164 5f62 795f 6672 6571  ale_grad_by_freq
+00009ab0: 2c20 7370 6172 7365 290a 2020 2020 7075  , sparse).    pu
+00009ac0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+00009ad0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00009ae0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00009af0: 6428 7069 6473 2e45 4d42 4544 4449 4e47  d(pids.EMBEDDING
+00009b00: 2c20 5f65 6d62 6564 6469 6e67 5f70 7269  , _embedding_pri
+00009b10: 6d5f 6772 6164 290a 0a23 0a23 2050 6861  m_grad)..#.# Pha
+00009b20: 6e74 6f6d 2067 7261 6420 7472 616e 7366  ntom grad transf
+00009b30: 6f72 6d20 6865 6c70 6572 730a 230a 0a0a  orm helpers.#...
+00009b40: 6465 6620 5f67 6574 5f67 7261 6466 6e5f  def _get_gradfn_
+00009b50: 616e 645f 6578 6563 7574 6f72 280a 2020  and_executor(.  
+00009b60: 2020 6273 796d 3a20 426f 756e 6453 796d    bsym: BoundSym
+00009b70: 626f 6c2c 202a 2c20 6578 6563 7574 6f72  bol, *, executor
+00009b80: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
+00009b90: 5b41 6e79 5d20 3d20 7475 706c 6528 290a  [Any] = tuple().
+00009ba0: 2920 2d3e 2074 7570 6c65 5b43 616c 6c61  ) -> tuple[Calla
+00009bb0: 626c 6520 7c20 4e6f 6e65 2c20 4578 6563  ble | None, Exec
+00009bc0: 7574 6f72 207c 204e 6f6e 655d 3a0a 2020  utor | None]:.  
+00009bd0: 2020 6364 203d 2067 6574 5f63 6f6d 7069    cd = get_compi
+00009be0: 6c65 5f64 6174 6128 290a 2020 2020 6578  le_data().    ex
+00009bf0: 6563 7574 6f72 735f 6c69 7374 203d 2063  ecutors_list = c
+00009c00: 642e 6578 6563 7574 6f72 735f 6c69 7374  d.executors_list
+00009c10: 2069 6620 6364 2069 7320 6e6f 7420 4e6f   if cd is not No
+00009c20: 6e65 2065 6c73 6520 6578 6563 7574 6f72  ne else executor
+00009c30: 735f 6c69 7374 0a20 2020 2023 2043 6865  s_list.    # Che
+00009c40: 636b 7320 6966 2074 6865 2065 7865 6375  cks if the execu
+00009c50: 746f 7220 7768 6963 6820 6861 7320 7072  tor which has pr
+00009c60: 696f 7269 7479 2066 6f72 2074 6869 7320  iority for this 
+00009c70: 6f70 6572 6174 696f 6e20 6861 7320 6120  operation has a 
+00009c80: 7370 6563 6966 6963 2067 7261 6420 7472  specific grad tr
+00009c90: 616e 7366 6f72 6d20 666f 7220 6974 0a20  ansform for it. 
+00009ca0: 2020 2066 6f72 2065 7820 696e 2065 7865     for ex in exe
+00009cb0: 6375 746f 7273 5f6c 6973 743a 0a20 2020  cutors_list:.   
+00009cc0: 2020 2020 2069 6620 6578 2e63 616e 5f65       if ex.can_e
+00009cd0: 7865 6375 7465 5f6f 725f 6675 7365 2862  xecute_or_fuse(b
+00009ce0: 7379 6d29 3a0a 2020 2020 2020 2020 2020  sym):.          
+00009cf0: 2020 6578 5f67 7261 645f 7472 616e 7366    ex_grad_transf
+00009d00: 6f72 6d3a 204e 6f6e 6520 7c20 4361 6c6c  orm: None | Call
+00009d10: 6162 6c65 203d 2065 782e 6765 745f 6772  able = ex.get_gr
+00009d20: 6164 5f74 7261 6e73 666f 726d 2862 7379  ad_transform(bsy
+00009d30: 6d2e 7379 6d29 0a20 2020 2020 2020 2020  m.sym).         
+00009d40: 2020 2069 6620 6578 5f67 7261 645f 7472     if ex_grad_tr
+00009d50: 616e 7366 6f72 6d20 6973 206e 6f74 204e  ansform is not N
+00009d60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00009d70: 2020 2020 2072 6574 7572 6e20 6578 5f67       return ex_g
+00009d80: 7261 645f 7472 616e 7366 6f72 6d2c 2065  rad_transform, e
+00009d90: 780a 2020 2020 2020 2020 2020 2020 6272  x.            br
+00009da0: 6561 6b0a 0a20 2020 2023 2049 6620 7468  eak..    # If th
+00009db0: 6520 6578 6563 7574 6f72 2064 6f65 736e  e executor doesn
+00009dc0: 2774 2064 6566 696e 6520 6974 7320 6f77  't define its ow
+00009dd0: 6e20 6772 6164 2074 7261 6e73 666f 726d  n grad transform
+00009de0: 2c20 7468 6973 206a 7573 7420 7265 7475  , this just retu
+00009df0: 726e 7320 7468 6520 6465 6661 756c 7420  rns the default 
+00009e00: 6772 6164 2074 7261 6e73 666f 726d 2066  grad transform f
+00009e10: 6f72 2074 6865 2062 7379 6d0a 2020 2020  or the bsym.    
+00009e20: 6772 6164 666e 203d 205f 6772 6164 5f66  gradfn = _grad_f
+00009e30: 6e5f 6d61 702e 6765 7428 6273 796d 2e73  n_map.get(bsym.s
+00009e40: 796d 2e69 642c 204e 6f6e 6529 0a20 2020  ym.id, None).   
+00009e50: 2072 6574 7572 6e20 6772 6164 666e 2c20   return gradfn, 
+00009e60: 4e6f 6e65 0a0a 0a23 2054 6865 2064 6566  None...# The def
+00009e70: 6175 6c74 2067 7261 6420 7370 6563 6966  ault grad specif
+00009e80: 6965 7220 666f 7220 7468 6520 6772 6164  ier for the grad
+00009e90: 2074 7261 6e73 666f 726d 0a23 2020 2046   transform.#   F
+00009ea0: 6f72 2065 6163 6820 7465 6e73 6f72 206f  or each tensor o
+00009eb0: 7574 7075 7420 226f 2220 7265 7175 6972  utput "o" requir
+00009ec0: 696e 6720 6772 6164 2c20 7370 6563 6966  ing grad, specif
+00009ed0: 6965 7320 6120 6772 6164 206f 6620 6f6e  ies a grad of on
+00009ee0: 6573 5f6c 696b 6528 6f29 0a64 6566 205f  es_like(o).def _
+00009ef0: 6772 6164 5f73 7065 6369 6669 6572 5f64  grad_specifier_d
+00009f00: 6566 6175 6c74 2870 7974 7265 653a 2041  efault(pytree: A
+00009f10: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
+00009f20: 2066 6c61 7473 2c20 5f20 3d20 7472 6565   flats, _ = tree
+00009f30: 5f66 6c61 7474 656e 2870 7974 7265 6529  _flatten(pytree)
+00009f40: 0a0a 2020 2020 666f 7220 6620 696e 2066  ..    for f in f
+00009f50: 6c61 7473 3a0a 2020 2020 2020 2020 6966  lats:.        if
+00009f60: 2069 7369 6e73 7461 6e63 6528 662c 2054   isinstance(f, T
+00009f70: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
+00009f80: 662e 7265 7175 6972 6573 5f67 7261 643a  f.requires_grad:
+00009f90: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+00009fa0: 4f54 4520 5468 6973 2075 7365 7320 636c  OTE This uses cl
+00009fb0: 616e 672e 6f6e 6573 5f6c 696b 6520 666f  ang.ones_like fo
+00009fc0: 7220 6e6f 7720 6265 6361 7573 6520 6c74  r now because lt
+00009fd0: 6f72 6368 2e6f 6e65 735f 6c69 6b65 2077  orch.ones_like w
+00009fe0: 696c 6c20 6578 7465 6e64 2074 6865 0a20  ill extend the. 
+00009ff0: 2020 2020 2020 2020 2020 2023 2020 206c             #   l
+0000a000: 6966 6574 696d 6520 6f66 2066 2c20 7768  ifetime of f, wh
+0000a010: 696c 6520 636c 616e 672e 6f6e 6573 5f6c  ile clang.ones_l
+0000a020: 696b 6520 7769 6c6c 2065 7874 7261 6374  ike will extract
+0000a030: 2074 6865 206d 6574 6164 6174 6120 6f66   the metadata of
+0000a040: 2066 2061 7420 7472 6163 6520 7469 6d65   f at trace time
+0000a050: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000a060: 6d73 2e70 7574 5f67 7261 6428 662c 2063  ms.put_grad(f, c
+0000a070: 6c61 6e67 2e66 756c 6c5f 6c69 6b65 2866  lang.full_like(f
+0000a080: 2c20 312e 3029 290a 0a0a 2320 544f 444f  , 1.0))...# TODO
+0000a090: 2054 6573 7420 7769 7468 2062 7566 6665   Test with buffe
+0000a0a0: 7273 0a64 6566 205f 6772 6164 5f6f 7574  rs.def _grad_out
+0000a0b0: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
+0000a0c0: 6c74 2870 7974 7265 653a 2041 6e79 2920  lt(pytree: Any) 
+0000a0d0: 2d3e 206c 6973 745b 5465 6e73 6f72 5072  -> list[TensorPr
+0000a0e0: 6f78 795d 3a0a 2020 2020 666c 6174 732c  oxy]:.    flats,
+0000a0f0: 205f 203d 2074 7265 655f 666c 6174 7465   _ = tree_flatte
+0000a100: 6e28 7079 7472 6565 290a 2020 2020 6772  n(pytree).    gr
+0000a110: 6164 7320 3d20 6c69 7374 285b 7072 696d  ads = list([prim
+0000a120: 732e 6765 745f 6772 6164 2866 2920 666f  s.get_grad(f) fo
+0000a130: 7220 6620 696e 2066 6c61 7473 2069 6620  r f in flats if 
+0000a140: 6973 696e 7374 616e 6365 2866 2c20 5465  isinstance(f, Te
+0000a150: 6e73 6f72 5072 6f78 7929 2061 6e64 2066  nsorProxy) and f
+0000a160: 2e72 6571 7569 7265 735f 6772 6164 5d29  .requires_grad])
+0000a170: 0a20 2020 2072 6574 7572 6e20 6772 6164  .    return grad
+0000a180: 730a 0a0a 2320 544f 444f 2046 6f72 6d61  s...# TODO Forma
+0000a190: 6c6c 7920 6465 6669 6e65 2074 6865 2022  lly define the "
+0000a1a0: 6772 6164 6965 6e74 2220 6f66 2061 2074  gradient" of a t
+0000a1b0: 656e 736f 720a 2320 544f 444f 2049 6620  ensor.# TODO If 
+0000a1c0: 6e6f 6e65 206f 6620 7468 6520 696e 7075  none of the inpu
+0000a1d0: 7473 2074 6f20 616e 206f 7065 7261 7469  ts to an operati
+0000a1e0: 6f6e 2072 6571 7569 7265 2067 7261 642c  on require grad,
+0000a1f0: 2074 6865 6e20 7765 2063 6f75 6c64 206c   then we could l
+0000a200: 6561 7665 2074 6861 7420 6f70 6572 6174  eave that operat
+0000a210: 696f 6e20 616c 6f6e 650a 2320 2020 5468  ion alone.#   Th
+0000a220: 6973 2063 6f75 6c64 2061 6374 7561 6c6c  is could actuall
+0000a230: 7920 696d 7072 6f76 6520 7065 7266 6f72  y improve perfor
+0000a240: 6d61 6e63 6520 6966 2074 6865 206f 7065  mance if the ope
+0000a250: 7261 7469 6f6e 2070 6572 666f 726d 7320  ration performs 
+0000a260: 6578 7472 6120 636f 6d70 7574 6174 696f  extra computatio
+0000a270: 6e73 2069 6e20 6974 7320 6772 6164 2074  ns in its grad t
+0000a280: 7261 6e73 666f 726d 0a23 2020 2041 2077  ransform.#   A w
+0000a290: 6f72 6b61 726f 756e 6420 666f 7220 7468  orkaround for th
+0000a2a0: 6973 2077 6f75 6c64 2062 6520 666f 7220  is would be for 
+0000a2b0: 7468 6520 6f70 6572 6174 696f 6e20 6974  the operation it
+0000a2c0: 7365 6c66 2074 6f20 6368 6563 6b20 6966  self to check if
+0000a2d0: 2069 7473 2069 6e70 7574 2072 6571 7569   its input requi
+0000a2e0: 7265 7320 6772 6164 206f 7220 6e6f 740a  res grad or not.
+0000a2f0: 2320 5472 616e 7366 6f72 6d73 2061 2066  # Transforms a f
+0000a300: 756e 6374 696f 6e20 746f 2063 6f6d 7075  unction to compu
+0000a310: 7465 2074 6865 2022 6772 6164 6965 6e74  te the "gradient
+0000a320: 2220 6f66 2069 7473 2069 6e70 7574 7320  " of its inputs 
+0000a330: 7265 7175 6972 696e 6720 6772 6164 2c20  requiring grad, 
+0000a340: 706f 7373 6962 6c79 0a23 2020 206d 6f64  possibly.#   mod
+0000a350: 6966 6965 6420 6279 2074 6865 2067 7261  ified by the gra
+0000a360: 6420 7370 6563 6966 6965 7273 2028 7365  d specifiers (se
+0000a370: 6520 6265 6c6f 7729 2e0a 2320 5468 6520  e below)..# The 
+0000a380: 6f70 7469 6f6e 616c 2067 7261 645f 7370  optional grad_sp
+0000a390: 6563 6966 6965 7220 6172 6775 6d65 6e74  ecifier argument
+0000a3a0: 2061 6363 6570 7473 2074 6865 2066 756e   accepts the fun
+0000a3b0: 6374 696f 6e27 7320 6f75 7470 7574 2c20  ction's output, 
+0000a3c0: 7275 6e73 2069 6e20 6120 6e6f 2d67 7261  runs in a no-gra
+0000a3d0: 6420 636f 6e74 6578 742c 0a23 2020 2061  d context,.#   a
+0000a3e0: 6e64 2063 616e 2070 7574 2067 7261 6473  nd can put grads
+0000a3f0: 2028 7573 696e 6720 7072 696d 732e 7075   (using prims.pu
+0000a400: 745f 6772 6164 2829 2920 666f 7220 7465  t_grad()) for te
+0000a410: 6e73 6f72 732e 2042 7920 6465 6661 756c  nsors. By defaul
+0000a420: 742c 2066 6f72 2065 7665 7279 2074 656e  t, for every ten
+0000a430: 736f 7220 6f75 7470 7574 2022 6f22 0a23  sor output "o".#
+0000a440: 2020 2074 6861 7420 7265 7175 6972 6573     that requires
+0000a450: 2067 7261 642c 2061 2067 7261 6420 6f66   grad, a grad of
+0000a460: 206f 6e65 735f 6c69 6b65 286f 2920 6973   ones_like(o) is
+0000a470: 2070 7574 2e0a 2320 5468 6520 6f70 7469   put..# The opti
+0000a480: 6f6e 616c 2067 7261 645f 6f75 745f 7370  onal grad_out_sp
+0000a490: 6563 6966 6965 7220 6163 6365 7074 7320  ecifier accepts 
+0000a4a0: 7468 6520 6675 6e63 7469 6f6e 2773 2069  the function's i
+0000a4b0: 6e70 7574 2061 6e64 2063 616e 2063 616c  nput and can cal
+0000a4c0: 6c20 7072 696d 732e 6765 745f 6772 6164  l prims.get_grad
+0000a4d0: 2829 2074 6f0a 2320 2020 6163 7175 6972  () to.#   acquir
+0000a4e0: 6520 616e 6420 7265 7475 726e 2067 7261  e and return gra
+0000a4f0: 6469 656e 7473 2061 7320 6465 7369 7265  dients as desire
+0000a500: 642e 2042 7920 6465 6661 756c 742c 2074  d. By default, t
+0000a510: 6865 2069 6e70 7574 2069 7320 666c 6174  he input is flat
+0000a520: 7465 6e65 640a 2320 2020 2874 7265 655f  tened.#   (tree_
+0000a530: 666c 6174 7465 6e28 6172 6773 2c20 6b77  flatten(args, kw
+0000a540: 6172 6773 2929 2061 6e64 2061 2066 6c61  args)) and a fla
+0000a550: 7420 6c69 7374 206f 6620 6772 6164 7320  t list of grads 
+0000a560: 666f 7220 616c 6c20 7465 6e73 6f72 7320  for all tensors 
+0000a570: 7265 7175 6972 696e 6720 6772 6164 0a23  requiring grad.#
+0000a580: 2020 2061 6e64 204e 6f6e 6520 666f 7220     and None for 
+0000a590: 6f74 6865 7220 696e 7075 7473 2069 7320  other inputs is 
+0000a5a0: 7265 7475 726e 6564 2e0a 2320 5468 6520  returned..# The 
+0000a5b0: 616c 676f 7269 7468 6d20 666f 7220 6d6f  algorithm for mo
+0000a5c0: 6469 6679 696e 6720 7468 6520 7072 6f67  difying the prog
+0000a5d0: 7261 6d20 6861 7320 7468 6520 666f 6c6c  ram has the foll
+0000a5e0: 6f77 696e 6720 7374 6570 733a 0a23 2020  owing steps:.#  
+0000a5f0: 2031 2920 466c 6174 7465 6e73 2074 6865   1) Flattens the
+0000a600: 206f 7269 6769 6e61 6c20 7472 6163 6520   original trace 
+0000a610: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
+0000a620: 6e73 666f 726d 202d 2d20 656e 7375 696e  nsform -- ensuin
+0000a630: 6720 7468 6174 2061 6c6c 2074 6f70 2d6c  g that all top-l
+0000a640: 6576 656c 2073 796d 626f 6c73 2068 6176  evel symbols hav
+0000a650: 650a 2320 2020 2020 2020 6120 6772 6164  e.#       a grad
+0000a660: 2066 756e 6374 696f 6e2e 0a64 6566 205f   function..def _
+0000a670: 5f67 7261 6428 0a20 2020 2063 666e 2c20  _grad(.    cfn, 
+0000a680: 6772 6164 5f73 7065 6369 6669 6572 3a20  grad_specifier: 
+0000a690: 4361 6c6c 6162 6c65 203d 205f 6772 6164  Callable = _grad
+0000a6a0: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
+0000a6b0: 6c74 2c20 6772 6164 5f6f 7574 5f73 7065  lt, grad_out_spe
+0000a6c0: 6369 6669 6572 3a20 4361 6c6c 6162 6c65  cifier: Callable
+0000a6d0: 203d 205f 6772 6164 5f6f 7574 5f73 7065   = _grad_out_spe
+0000a6e0: 6369 6669 6572 5f64 6566 6175 6c74 0a29  cifier_default.)
+0000a6f0: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
+0000a700: 2020 2320 4372 6561 7465 7320 6120 6375    # Creates a cu
+0000a710: 7374 6f6d 2074 7261 6e73 666f 726d 2063  stom transform c
+0000a720: 616c 6c61 626c 6520 7468 6174 2062 696e  allable that bin
+0000a730: 6473 2074 6865 2061 6464 6974 696f 6e61  ds the additiona
+0000a740: 6c20 6172 6775 6d65 6e74 7320 746f 2074  l arguments to t
+0000a750: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
+0000a760: 6d0a 2020 2020 406c 616e 6763 7478 284c  m.    @langctx(L
+0000a770: 616e 6775 6167 6573 2e43 4c41 4e47 290a  anguages.CLANG).
+0000a780: 2020 2020 6465 6620 5f67 7261 645f 7472      def _grad_tr
+0000a790: 616e 7366 6f72 6d28 7472 633a 2054 7261  ansform(trc: Tra
+0000a7a0: 6365 2c20 2a2c 2065 7865 6375 746f 7273  ce, *, executors
+0000a7b0: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
+0000a7c0: 416e 795d 2920 2d3e 2054 7261 6365 3a0a  Any]) -> Trace:.
+0000a7d0: 2020 2020 2020 2020 7374 6172 745f 7469          start_ti
+0000a7e0: 6d65 5f6e 7320 3d20 7469 6d65 2e74 696d  me_ns = time.tim
+0000a7f0: 655f 6e73 2829 0a0a 2020 2020 2020 2020  e_ns()..        
+0000a800: 2320 5354 4550 204f 4e45 202d 2d20 466c  # STEP ONE -- Fl
+0000a810: 6174 7465 6e73 2061 6e64 2064 6365 730a  attens and dces.
+0000a820: 0a20 2020 2020 2020 2023 2052 6574 7572  .        # Retur
+0000a830: 6e73 2054 7275 6520 6966 2074 6865 2062  ns True if the b
+0000a840: 7379 6d20 6861 7320 6e6f 2067 7261 6420  sym has no grad 
+0000a850: 6675 6e63 7469 6f6e 2c20 616e 6420 736f  function, and so
+0000a860: 206d 7573 7420 6265 2066 6c61 7474 656e   must be flatten
+0000a870: 6564 2066 6f72 2074 6865 2067 7261 6420  ed for the grad 
+0000a880: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
+0000a890: 2020 6e65 7665 725f 666c 6174 7465 6e3a    never_flatten:
+0000a8a0: 2073 6574 5b48 6173 6861 626c 655d 203d   set[Hashable] =
+0000a8b0: 207b 7072 696d 732e 5072 696d 4944 732e   {prims.PrimIDs.
+0000a8c0: 5245 5455 524e 2c20 7072 696d 732e 5072  RETURN, prims.Pr
+0000a8d0: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
+0000a8e0: 5649 414c 7d0a 0a20 2020 2020 2020 2064  VIAL}..        d
+0000a8f0: 6566 2073 686f 756c 645f 666c 6174 7465  ef should_flatte
+0000a900: 6e5f 666f 725f 6772 6164 2862 7379 6d3a  n_for_grad(bsym:
+0000a910: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
+0000a920: 2062 6f6f 6c3a 0a20 2020 2020 2020 2020   bool:.         
+0000a930: 2020 2069 6620 6273 796d 2e73 796d 2e69     if bsym.sym.i
+0000a940: 6420 696e 206e 6576 6572 5f66 6c61 7474  d in never_flatt
+0000a950: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
+0000a960: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+0000a970: 0a0a 2020 2020 2020 2020 2020 2020 6772  ..            gr
+0000a980: 6164 666e 3a20 4e6f 6e65 207c 2043 616c  adfn: None | Cal
+0000a990: 6c61 626c 650a 2020 2020 2020 2020 2020  lable.          
+0000a9a0: 2020 6772 6164 666e 2c20 5f20 3d20 5f67    gradfn, _ = _g
+0000a9b0: 6574 5f67 7261 6466 6e5f 616e 645f 6578  et_gradfn_and_ex
+0000a9c0: 6563 7574 6f72 2862 7379 6d2c 2065 7865  ecutor(bsym, exe
+0000a9d0: 6375 746f 7273 5f6c 6973 743d 6578 6563  cutors_list=exec
+0000a9e0: 7574 6f72 735f 6c69 7374 290a 2020 2020  utors_list).    
+0000a9f0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0000aa00: 7261 6466 6e20 6973 204e 6f6e 650a 0a20  radfn is None.. 
+0000aa10: 2020 2020 2020 2023 2054 4f44 4f20 5243         # TODO RC
+0000aa20: 313a 206d 6179 6265 206d 6f76 6520 746f  1: maybe move to
+0000aa30: 2070 726f 6475 6365 2074 6865 7365 2061   produce these a
+0000aa40: 6c77 6179 7320 6f6e 2063 7265 6174 696f  lways on creatio
+0000aa50: 6e0a 2020 2020 2020 2020 6966 2074 7263  n.        if trc
+0000aa60: 2e6b 7761 7267 7320 6973 204e 6f6e 653a  .kwargs is None:
+0000aa70: 0a20 2020 2020 2020 2020 2020 2074 7263  .            trc
+0000aa80: 2e6b 7761 7267 7320 3d20 7b7d 0a20 2020  .kwargs = {}.   
+0000aa90: 2020 2020 2069 6620 7472 632e 666e 2069       if trc.fn i
+0000aaa0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000aab0: 2020 2020 7472 632e 666e 203d 2074 7263      trc.fn = trc
+0000aac0: 2e70 7974 686f 6e5f 6361 6c6c 6162 6c65  .python_callable
+0000aad0: 2829 0a0a 2020 2020 2020 2020 6772 6164  ()..        grad
+0000aae0: 7472 6320 3d20 6672 6f6d 5f74 7261 6365  trc = from_trace
+0000aaf0: 2874 7263 290a 2020 2020 2020 2020 666c  (trc).        fl
+0000ab00: 6174 7465 6e65 645f 6273 796d 733a 206c  attened_bsyms: l
+0000ab10: 6973 745b 426f 756e 6453 796d 626f 6c5d  ist[BoundSymbol]
+0000ab20: 203d 2066 6c61 7474 656e 5f66 6f72 5f74   = flatten_for_t
+0000ab30: 7261 6e73 666f 726d 2873 686f 756c 645f  ransform(should_
+0000ab40: 666c 6174 7465 6e5f 666f 725f 6772 6164  flatten_for_grad
+0000ab50: 2c20 7472 632e 626f 756e 645f 7379 6d62  , trc.bound_symb
+0000ab60: 6f6c 7329 0a20 2020 2020 2020 2067 7261  ols).        gra
+0000ab70: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000ab80: 6c73 203d 2066 6c61 7474 656e 6564 5f62  ls = flattened_b
+0000ab90: 7379 6d73 0a20 2020 2020 2020 2067 7261  syms.        gra
+0000aba0: 6474 7263 203d 2064 6365 2867 7261 6474  dtrc = dce(gradt
+0000abb0: 7263 290a 0a20 2020 2020 2020 2023 2053  rc)..        # S
+0000abc0: 5445 5020 5457 4f20 2d2d 2052 6570 6c61  TEP TWO -- Repla
+0000abd0: 6365 7320 6f72 6967 696e 616c 2063 616c  ces original cal
+0000abe0: 6c73 2077 6974 6820 6772 6164 2063 616c  ls with grad cal
+0000abf0: 6c73 0a0a 2020 2020 2020 2020 2320 4465  ls..        # De
+0000ac00: 6669 6e65 7320 7468 6520 7669 7369 746f  fines the visito
+0000ac10: 7220 7061 7474 6572 6e20 666f 7220 7468  r pattern for th
+0000ac20: 6520 6669 7273 7420 7061 7373 206f 6620  e first pass of 
+0000ac30: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
+0000ac40: 726d 2c0a 2020 2020 2020 2020 2320 2020  rm,.        #   
+0000ac50: 7768 6963 6820 7377 6170 7320 426f 756e  which swaps Boun
+0000ac60: 6453 796d 626f 6c73 2077 6974 6820 7468  dSymbols with th
+0000ac70: 6569 7220 6772 6164 2066 756e 6374 696f  eir grad functio
+0000ac80: 6e73 0a20 2020 2020 2020 2064 6566 2076  ns.        def v
+0000ac90: 6973 6974 5f28 6273 796d 3a20 426f 756e  isit_(bsym: Boun
+0000aca0: 6453 796d 626f 6c29 202d 3e20 4361 6c6c  dSymbol) -> Call
+0000acb0: 6162 6c65 3a0a 2020 2020 2020 2020 2020  able:.          
+0000acc0: 2020 6772 6164 666e 3a20 4e6f 6e65 207c    gradfn: None |
+0000acd0: 2043 616c 6c61 626c 650a 2020 2020 2020   Callable.      
+0000ace0: 2020 2020 2020 6772 6164 666e 2c20 5f20        gradfn, _ 
+0000acf0: 3d20 5f67 6574 5f67 7261 6466 6e5f 616e  = _get_gradfn_an
+0000ad00: 645f 6578 6563 7574 6f72 2862 7379 6d2c  d_executor(bsym,
+0000ad10: 2065 7865 6375 746f 7273 5f6c 6973 743d   executors_list=
+0000ad20: 6578 6563 7574 6f72 735f 6c69 7374 290a  executors_list).
+0000ad30: 2020 2020 2020 2020 2020 2020 6368 6563              chec
+0000ad40: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
+0000ad50: 2020 2067 7261 6466 6e20 6973 206e 6f74     gradfn is not
+0000ad60: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0000ad70: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0000ad80: 2246 6169 6c65 6420 746f 2066 696e 6420  "Failed to find 
+0000ad90: 6120 6772 6164 666e 2066 6f72 207b 6273  a gradfn for {bs
+0000ada0: 796d 3d7d 2061 6674 6572 2066 6c61 7474  ym=} after flatt
+0000adb0: 656e 696e 6722 2c0a 2020 2020 2020 2020  ening",.        
+0000adc0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0000add0: 6e5f 7479 7065 3d41 7373 6572 7469 6f6e  n_type=Assertion
+0000ade0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+0000adf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000ae00: 2072 6574 7572 6e20 6772 6164 666e 0a0a   return gradfn..
+0000ae10: 2020 2020 2020 2020 4077 7261 7073 2874          @wraps(t
+0000ae20: 7263 2e66 6e2e 6d65 7461 2069 6620 6973  rc.fn.meta if is
+0000ae30: 696e 7374 616e 6365 2874 7263 2e66 6e2c  instance(trc.fn,
+0000ae40: 2053 796d 626f 6c29 2065 6c73 6520 7472   Symbol) else tr
+0000ae50: 632e 666e 290a 2020 2020 2020 2020 6465  c.fn).        de
+0000ae60: 6620 696e 7465 7270 7265 7469 6e67 5f66  f interpreting_f
+0000ae70: 6e28 2a61 7267 732c 202a 2a6b 7761 7267  n(*args, **kwarg
+0000ae80: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000ae90: 7265 7375 6c74 203d 2065 7661 6c5f 7472  result = eval_tr
+0000aea0: 6163 6528 6772 6164 7472 632c 202a 6172  ace(gradtrc, *ar
+0000aeb0: 6773 2c20 7379 6d62 6f6c 5f6d 6170 7065  gs, symbol_mappe
+0000aec0: 723d 7669 7369 745f 2c20 2a2a 6b77 6172  r=visit_, **kwar
+0000aed0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0000aee0: 2320 5365 7473 2067 7261 6473 2066 6f72  # Sets grads for
+0000aef0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0000af00: 2020 2020 2320 544f 444f 2054 6869 7320      # TODO This 
+0000af10: 6566 6665 6374 6976 656c 7920 7275 6e73  effectively runs
+0000af20: 2069 6e20 6120 6e6f 2067 7261 6420 636f   in a no grad co
+0000af30: 6e74 6578 7420 2d2d 2073 686f 756c 6420  ntext -- should 
+0000af40: 6974 2072 756e 2069 6e20 6120 6772 6164  it run in a grad
+0000af50: 2063 6f6e 7465 7874 2c0a 2020 2020 2020   context,.      
+0000af60: 2020 2020 2020 2320 2020 6f72 2073 686f        #   or sho
+0000af70: 756c 6420 7468 6572 6520 6265 2074 6865  uld there be the
+0000af80: 206f 7074 696f 6e20 746f 2072 756e 2069   option to run i
+0000af90: 7420 696e 2061 2067 7261 6420 636f 6e74  t in a grad cont
+0000afa0: 6578 743f 0a20 2020 2020 2020 2020 2020  ext?.           
+0000afb0: 2067 7261 645f 7370 6563 6966 6965 7228   grad_specifier(
+0000afc0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
+0000afd0: 2020 2020 2320 436f 6e73 7472 7563 7473      # Constructs
+0000afe0: 2072 6574 7572 6e20 7661 6c75 650a 2020   return value.  
+0000aff0: 2020 2020 2020 2020 2020 666c 6174 5f67            flat_g
+0000b000: 7261 6473 203d 2067 7261 645f 6f75 745f  rads = grad_out_
+0000b010: 7370 6563 6966 6965 7228 2861 7267 732c  specifier((args,
+0000b020: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
+0000b030: 2020 2020 2020 7265 7475 726e 2066 6c61        return fla
+0000b040: 745f 6772 6164 730a 0a20 2020 2020 2020  t_grads..       
+0000b050: 2023 204e 4f54 4520 4166 7465 7220 7468   # NOTE After th
+0000b060: 6973 2063 616c 6c20 7468 6520 6772 6164  is call the grad
+0000b070: 7472 6320 6973 2069 6e76 616c 6964 2c20  trc is invalid, 
+0000b080: 6265 6361 7573 653a 0a20 2020 2020 2020  because:.       
+0000b090: 2023 2020 2031 2920 5468 6520 6e6f 6e2d   #   1) The non-
+0000b0a0: 6578 6563 7574 6162 6c65 2070 7574 5f67  executable put_g
+0000b0b0: 7261 6420 6f70 6572 6174 696f 6e73 2061  rad operations a
+0000b0c0: 7265 2073 7469 6c6c 2069 6e20 7468 6520  re still in the 
+0000b0d0: 7472 6163 652c 2061 6e64 206d 756c 7469  trace, and multi
+0000b0e0: 706c 6520 6361 6c6c 7320 746f 2070 7574  ple calls to put
+0000b0f0: 2067 7261 6420 6172 6520 6e6f 7420 6163   grad are not ac
+0000b100: 6375 6d75 6c61 7465 640a 2020 2020 2020  cumulated.      
+0000b110: 2020 2320 2020 3229 2054 6865 206e 6f6e    #   2) The non
+0000b120: 2d65 7865 6375 7461 626c 6520 6765 745f  -executable get_
+0000b130: 6772 6164 206f 7065 7261 7469 6f6e 7320  grad operations 
+0000b140: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
+0000b150: 2074 7261 6365 2c20 616e 6420 7468 6579   trace, and they
+0000b160: 206d 6179 2070 726f 6475 6365 2064 6966   may produce dif
+0000b170: 6665 7265 6e74 2070 726f 7869 6573 2077  ferent proxies w
+0000b180: 6865 6e0a 2020 2020 2020 2020 2320 2020  hen.        #   
+0000b190: 2020 2020 6361 6c6c 6564 206f 6e20 7468      called on th
+0000b1a0: 6520 7361 6d65 2069 6e70 7574 730a 2020  e same inputs.  
+0000b1b0: 2020 2020 2020 2320 2020 3329 2054 6865        #   3) The
+0000b1c0: 206f 7065 7261 7469 6f6e 7320 6172 6520   operations are 
+0000b1d0: 6e6f 7420 696e 2061 2076 616c 6964 206f  not in a valid o
+0000b1e0: 7264 6572 0a20 2020 2020 2020 2067 7261  rder.        gra
+0000b1f0: 6474 7263 203d 2063 6f6e 7374 7275 6374  dtrc = construct
+0000b200: 5f74 7261 6365 280a 2020 2020 2020 2020  _trace(.        
+0000b210: 2020 2020 7265 6e61 6d65 5f70 726f 7869      rename_proxi
+0000b220: 6573 3d46 616c 7365 2c0a 2020 2020 2020  es=False,.      
+0000b230: 2020 2020 2020 7573 655f 6463 653d 4661        use_dce=Fa
+0000b240: 6c73 652c 0a20 2020 2020 2020 2029 2869  lse,.        )(i
+0000b250: 6e74 6572 7072 6574 696e 675f 666e 2c20  nterpreting_fn, 
+0000b260: 2a67 7261 6474 7263 2e61 7267 732c 202a  *gradtrc.args, *
+0000b270: 2a67 7261 6474 7263 2e6b 7761 7267 7329  *gradtrc.kwargs)
+0000b280: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000b290: 2e73 636f 7065 7320 3d20 5b67 7261 6474  .scopes = [gradt
+0000b2a0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
+0000b2b0: 5d0a 2020 2020 2020 2020 6772 6164 7472  ].        gradtr
+0000b2c0: 632e 5f63 6f6d 706c 6574 6520 3d20 4661  c._complete = Fa
+0000b2d0: 6c73 650a 0a20 2020 2020 2020 2023 2053  lse..        # S
+0000b2e0: 5445 5020 5448 5245 4520 2d2d 2048 616e  TEP THREE -- Han
+0000b2f0: 646c 6573 2070 7574 5f67 7261 6420 616e  dles put_grad an
+0000b300: 6420 6765 745f 6772 6164 206f 7065 7261  d get_grad opera
+0000b310: 7469 6f6e 7320 616e 6420 6163 6375 6d75  tions and accumu
+0000b320: 6c61 7465 7320 6772 6164 6965 6e74 730a  lates gradients.
+0000b330: 0a20 2020 2020 2020 2023 2041 6363 756d  .        # Accum
+0000b340: 756c 6174 6573 2067 7261 6469 656e 7473  ulates gradients
+0000b350: 2c20 6372 6561 7469 6e67 2074 6865 2070  , creating the p
+0000b360: 7269 6d61 6c20 2d3e 2061 6363 756d 756c  rimal -> accumul
+0000b370: 6174 6564 2067 7261 6420 6d61 7070 696e  ated grad mappin
+0000b380: 670a 2020 2020 2020 2020 2320 5365 7473  g.        # Sets
+0000b390: 2074 6865 2074 7261 6369 6e67 2063 6f6e   the tracing con
+0000b3a0: 7465 7874 2073 6f20 6163 6375 6d75 6c61  text so accumula
+0000b3b0: 7469 6f6e 206f 7065 7261 7469 6f6e 7320  tion operations 
+0000b3c0: 6172 6520 7265 636f 7264 6564 2069 6e74  are recorded int
+0000b3d0: 6f20 7468 6520 7472 6163 650a 2020 2020  o the trace.    
+0000b3e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000b3f0: 2020 2020 2074 7261 6365 6374 785f 746f       tracectx_to
+0000b400: 6b20 3d20 7365 745f 7472 6163 6563 7478  k = set_tracectx
+0000b410: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
+0000b420: 2020 2020 2020 2023 204d 6170 7320 7072         # Maps pr
+0000b430: 696d 616c 7320 746f 2074 6865 6972 2067  imals to their g
+0000b440: 7261 6469 656e 7473 2028 7768 6963 6820  radients (which 
+0000b450: 6172 6520 7265 7475 726e 6564 2066 726f  are returned fro
+0000b460: 6d20 6361 6c6c 696e 6720 6765 745f 6772  m calling get_gr
+0000b470: 6164 206f 6e20 7468 6520 7072 696d 616c  ad on the primal
+0000b480: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0000b490: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
+0000b4a0: 6d61 703a 2064 6963 745b 5661 7269 6162  map: dict[Variab
+0000b4b0: 6c65 2c20 5465 6e73 6f72 5072 6f78 795d  le, TensorProxy]
+0000b4c0: 203d 207b 7d0a 0a20 2020 2020 2020 2020   = {}..         
+0000b4d0: 2020 2023 2048 616e 646c 6573 2070 7574     # Handles put
+0000b4e0: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
+0000b4f0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0000b500: 4f54 4520 5468 6973 206d 6f64 6966 6965  OTE This modifie
+0000b510: 7320 6120 6c69 7374 2074 6861 7420 6973  s a list that is
+0000b520: 2062 6569 6e67 2065 6e75 6d65 7261 7465   being enumerate
+0000b530: 6420 6f76 6572 2c20 6275 7420 6974 2773  d over, but it's
+0000b540: 204f 4b20 6265 6361 7573 6520 7765 2772   OK because we'r
+0000b550: 6520 6f6e 6c79 0a20 2020 2020 2020 2020  e only.         
+0000b560: 2020 2023 2020 2061 7070 656e 6469 6e67     #   appending
+0000b570: 2074 6f20 7468 6520 656e 6420 6f66 2074   to the end of t
+0000b580: 6865 206c 6973 740a 2020 2020 2020 2020  he list.        
+0000b590: 2020 2020 6273 796d 3a20 426f 756e 6453      bsym: BoundS
+0000b5a0: 796d 626f 6c0a 2020 2020 2020 2020 2020  ymbol.          
+0000b5b0: 2020 666f 7220 6273 796d 2069 6e20 6772    for bsym in gr
+0000b5c0: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
+0000b5d0: 6f6c 733a 0a20 2020 2020 2020 2020 2020  ols:.           
+0000b5e0: 2020 2020 2069 643a 2048 6173 6861 626c       id: Hashabl
+0000b5f0: 6520 3d20 6273 796d 2e73 796d 2e69 640a  e = bsym.sym.id.
+0000b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b610: 6966 2069 6420 6973 2070 6964 732e 5055  if id is pids.PU
+0000b620: 545f 4752 4144 3a0a 2020 2020 2020 2020  T_GRAD:.        
+0000b630: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+0000b640: 616c 3a20 4e75 6d62 6572 207c 2054 656e  al: Number | Ten
+0000b650: 736f 7250 726f 7879 0a20 2020 2020 2020  sorProxy.       
+0000b660: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+0000b670: 643a 204e 756d 6265 7220 7c20 5465 6e73  d: Number | Tens
+0000b680: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
+0000b690: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+0000b6a0: 616c 2c20 6772 6164 203d 2062 7379 6d2e  al, grad = bsym.
+0000b6b0: 666c 6174 5f61 7267 730a 0a20 2020 2020  flat_args..     
+0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000b6d0: 2054 4f44 4f20 5375 7070 6f72 7420 6175   TODO Support au
+0000b6e0: 746f 6772 6164 206f 6e20 6e75 6d62 6572  tograd on number
+0000b6f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0000b700: 2020 2020 2020 2320 4669 6c74 6572 7320        # Filters 
+0000b710: 6361 6c6c 7320 746f 2070 7574 5f67 7261  calls to put_gra
+0000b720: 6420 7468 6174 2077 6f75 6c64 2070 7574  d that would put
+0000b730: 2061 2067 7261 6420 6f6e 2061 206e 6f6e   a grad on a non
+0000b740: 2d74 656e 736f 7220 6f72 2061 2074 656e  -tensor or a ten
+0000b750: 736f 7220 7468 6174 2064 6f65 736e 2774  sor that doesn't
+0000b760: 2072 6571 7569 7265 2067 7261 640a 2020   require grad.  
+0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b780: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+0000b790: 6e63 6528 7072 696d 616c 2c20 5465 6e73  nce(primal, Tens
+0000b7a0: 6f72 5072 6f78 7929 206f 7220 6e6f 7420  orProxy) or not 
+0000b7b0: 7072 696d 616c 2e72 6571 7569 7265 735f  primal.requires_
+0000b7c0: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
+0000b7d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000b7e0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+0000b7f0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+0000b800: 444f 2053 7570 706f 7274 2063 6f6d 706c  DO Support compl
+0000b810: 6578 2061 7574 6f67 7261 640a 2020 2020  ex autograd.    
+0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b830: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
+0000b840: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000b850: 6f74 2064 7479 7065 732e 6973 5f63 6f6d  ot dtypes.is_com
+0000b860: 706c 6578 5f64 7479 7065 2864 7479 7065  plex_dtype(dtype
+0000b870: 732e 746f 5f64 7479 7065 2870 7269 6d61  s.to_dtype(prima
+0000b880: 6c29 292c 0a20 2020 2020 2020 2020 2020  l)),.           
+0000b890: 2020 2020 2020 2020 2020 2020 206c 616d               lam
+0000b8a0: 6264 613a 2066 2243 6f6d 706c 6578 2067  bda: f"Complex g
+0000b8b0: 7261 6420 6973 206e 6f74 2073 7570 706f  rad is not suppo
+0000b8c0: 7274 6564 2079 6574 222c 0a20 2020 2020  rted yet",.     
+0000b8d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000b8e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b8f0: 2020 2020 2020 7670 7269 6d61 6c3a 2056        vprimal: V
+0000b900: 6172 6961 626c 6520 3d20 7661 7269 6162  ariable = variab
+0000b910: 6c65 6966 7928 7072 696d 616c 290a 2020  leify(primal).  
 0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2076 6772 6164 3a20 5661 7269 6162 6c65   vgrad: Variable
-0000b940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b950: 2020 2020 2076 7072 696d 616c 2c20 7667       vprimal, vg
-0000b960: 7261 6420 3d20 7661 7269 6162 6c65 6966  rad = variableif
-0000b970: 7928 7072 696d 616c 292c 2076 6172 6961  y(primal), varia
-0000b980: 626c 6569 6679 2867 7261 6429 0a0a 2020  bleify(grad)..  
-0000b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9a0: 2020 6163 7475 616c 5f67 7261 643a 204e    actual_grad: N
-0000b9b0: 6f6e 6520 7c20 5465 6e73 6f72 5072 6f78  one | TensorProx
-0000b9c0: 7920 3d20 7072 696d 616c 735f 746f 5f67  y = primals_to_g
-0000b9d0: 696e 7075 745f 6d61 702e 6765 7428 7670  input_map.get(vp
-0000b9e0: 7269 6d61 6c2c 204e 6f6e 6529 0a0a 2020  rimal, None)..  
-0000b9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba00: 2020 2320 4e4f 5445 2049 6620 6163 7475    # NOTE If actu
-0000ba10: 616c 5f67 7261 6420 6973 204e 6f6e 6520  al_grad is None 
-0000ba20: 7468 656e 2074 6865 7265 2773 2061 2067  then there's a g
-0000ba30: 6574 5f67 7261 6428 2920 7265 7175 6573  et_grad() reques
-0000ba40: 7420 666f 7220 6120 7465 6e73 6f72 2077  t for a tensor w
-0000ba50: 6869 6368 0a20 2020 2020 2020 2020 2020  hich.           
-0000ba60: 2020 2020 2020 2020 2023 2020 2068 6173           #   has
-0000ba70: 206e 6f20 7075 745f 6772 6164 2829 2c20   no put_grad(), 
-0000ba80: 736f 2077 6520 7265 7475 726e 207a 6572  so we return zer
-0000ba90: 6f73 2066 6f72 2074 6865 2067 7261 640a  os for the grad.
-0000baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bab0: 2020 2020 2320 544f 444f 2052 6576 6973      # TODO Revis
-0000bac0: 6974 2074 6869 7320 2d2d 2063 616e 2077  it this -- can w
-0000bad0: 6520 7265 6d6f 7665 2074 6865 7365 2063  e remove these c
-0000bae0: 6f6d 7075 7461 7469 6f6e 732c 206f 7220  omputations, or 
-0000baf0: 7573 6520 6120 7370 6563 6961 6c20 5a65  use a special Ze
-0000bb00: 726f 5465 6e73 6f72 0a20 2020 2020 2020  roTensor.       
-0000bb10: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0000bb20: 2074 6f20 7369 6d70 6c69 6679 2074 6865   to simplify the
-0000bb30: 6d3f 0a20 2020 2020 2020 2020 2020 2020  m?.             
-0000bb40: 2020 2020 2020 2069 6620 6163 7475 616c         if actual
-0000bb50: 5f67 7261 6420 6973 204e 6f6e 653a 0a20  _grad is None:. 
-0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb70: 2020 2020 2020 2061 6374 7561 6c5f 6772         actual_gr
-0000bb80: 6164 203d 206c 746f 7263 682e 7a65 726f  ad = ltorch.zero
-0000bb90: 735f 6c69 6b65 2870 7269 6d61 6c29 0a20  s_like(primal). 
+0000b930: 2020 6163 6375 6d3a 204e 6f6e 6520 7c20    accum: None | 
+0000b940: 5465 6e73 6f72 5072 6f78 7920 3d20 7072  TensorProxy = pr
+0000b950: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
+0000b960: 6d61 702e 6765 7428 7670 7269 6d61 6c2c  map.get(vprimal,
+0000b970: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
+0000b980: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0000b990: 6363 756d 2069 7320 4e6f 6e65 3a0a 2020  ccum is None:.  
+0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9b0: 2020 2020 2020 7072 696d 616c 735f 746f        primals_to
+0000b9c0: 5f67 696e 7075 745f 6d61 705b 7670 7269  _ginput_map[vpri
+0000b9d0: 6d61 6c5d 203d 2067 7261 640a 2020 2020  mal] = grad.    
+0000b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ba00: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+0000ba10: 6375 6d20 3d20 6163 6375 6d20 2b20 6772  cum = accum + gr
+0000ba20: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
+0000ba30: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000ba40: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
+0000ba50: 5b76 7072 696d 616c 5d20 3d20 6163 6375  [vprimal] = accu
+0000ba60: 6d0a 0a20 2020 2020 2020 2020 2020 2023  m..            #
+0000ba70: 2048 616e 646c 6573 2067 6574 5f67 7261   Handles get_gra
+0000ba80: 6420 6f70 6572 6174 696f 6e73 0a0a 2020  d operations..  
+0000ba90: 2020 2020 2020 2020 2020 2320 5265 7365            # Rese
+0000baa0: 7473 2074 6865 2073 7761 706d 6170 2066  ts the swapmap f
+0000bab0: 6f72 2067 7261 6473 0a20 2020 2020 2020  or grads.       
+0000bac0: 2020 2020 2073 7761 706d 6170 3a20 6469       swapmap: di
+0000bad0: 6374 5b56 6172 6961 626c 652c 2050 726f  ct[Variable, Pro
+0000bae0: 7879 5d20 3d20 7b7d 0a0a 2020 2020 2020  xy] = {}..      
+0000baf0: 2020 2020 2020 666f 7220 6273 796d 2069        for bsym i
+0000bb00: 6e20 6772 6164 7472 632e 626f 756e 645f  n gradtrc.bound_
+0000bb10: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
+0000bb20: 2020 2020 2020 2020 2069 643a 2048 6173           id: Has
+0000bb30: 6861 626c 6520 3d20 6273 796d 2e73 796d  hable = bsym.sym
+0000bb40: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
+0000bb50: 2020 2020 6966 2069 6420 6973 2070 6964      if id is pid
+0000bb60: 732e 4745 545f 4752 4144 3a0a 2020 2020  s.GET_GRAD:.    
+0000bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb80: 7072 696d 616c 3a20 4e75 6d62 6572 207c  primal: Number |
+0000bb90: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
 0000bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bbb0: 2020 2020 2020 2070 7269 6d61 6c73 5f74         primals_t
-0000bbc0: 6f5f 6769 6e70 7574 5f6d 6170 5b76 7072  o_ginput_map[vpr
-0000bbd0: 696d 616c 5d20 3d20 6163 7475 616c 5f67  imal] = actual_g
-0000bbe0: 7261 640a 0a20 2020 2020 2020 2020 2020  rad..           
-0000bbf0: 2020 2020 2020 2020 2023 2055 7064 6174           # Updat
-0000bc00: 6573 2074 6865 2067 7261 6420 616c 6961  es the grad alia
-0000bc10: 7320 6d61 700a 2020 2020 2020 2020 2020  s map.          
-0000bc20: 2020 2020 2020 2020 2020 7661 6374 7561            vactua
-0000bc30: 6c5f 6772 6164 3a20 5661 7269 6162 6c65  l_grad: Variable
-0000bc40: 203d 2076 6172 6961 626c 6569 6679 2861   = variableify(a
-0000bc50: 6374 7561 6c5f 6772 6164 290a 2020 2020  ctual_grad).    
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 6966 2076 6163 7475 616c 5f67 7261 6420  if vactual_grad 
-0000bc80: 213d 2076 6772 6164 3a0a 2020 2020 2020  != vgrad:.      
-0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bca0: 2020 7377 6170 6d61 705b 7667 7261 645d    swapmap[vgrad]
-0000bcb0: 203d 2061 6374 7561 6c5f 6772 6164 0a0a   = actual_grad..
-0000bcc0: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-0000bcd0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-0000bce0: 6573 746f 7265 7320 7363 6f70 650a 2020  estores scope.  
-0000bcf0: 2020 2020 2020 2020 2020 7265 7365 745f            reset_
-0000bd00: 7472 6163 6563 7478 2874 7261 6365 6374  tracectx(tracect
-0000bd10: 785f 746f 6b29 0a0a 2020 2020 2020 2020  x_tok)..        
-0000bd20: 2320 4669 6c74 6572 7320 7075 745f 6772  # Filters put_gr
-0000bd30: 6164 2061 6e64 2067 6574 5f67 7261 6420  ad and get_grad 
-0000bd40: 6f70 6572 6174 696f 6e73 2061 6e64 2061  operations and a
-0000bd50: 7070 6c69 6573 2074 6865 2073 7761 706d  pplies the swapm
-0000bd60: 6170 0a20 2020 2020 2020 2064 6566 205f  ap.        def _
-0000bd70: 6669 6c74 6572 2862 7379 6d3a 2042 6f75  filter(bsym: Bou
-0000bd80: 6e64 5379 6d62 6f6c 2920 2d3e 2062 6f6f  ndSymbol) -> boo
-0000bd90: 6c3a 0a20 2020 2020 2020 2020 2020 2069  l:.            i
-0000bda0: 643a 2048 6173 6861 626c 6520 3d20 6273  d: Hashable = bs
-0000bdb0: 796d 2e73 796d 2e69 640a 2020 2020 2020  ym.sym.id.      
-0000bdc0: 2020 2020 2020 7265 7475 726e 2069 6420        return id 
-0000bdd0: 696e 2028 7069 6473 2e50 5554 5f47 5241  in (pids.PUT_GRA
-0000bde0: 442c 2070 6964 732e 4745 545f 4752 4144  D, pids.GET_GRAD
-0000bdf0: 290a 0a20 2020 2020 2020 2067 7261 6474  )..        gradt
-0000be00: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000be10: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0000be20: 2062 7379 6d2e 6672 6f6d 5f62 7379 6d5f   bsym.from_bsym_
-0000be30: 7377 6170 5f70 726f 7869 6573 2873 7761  swap_proxies(swa
-0000be40: 706d 6170 2920 666f 7220 6273 796d 2069  pmap) for bsym i
-0000be50: 6e20 6772 6164 7472 632e 626f 756e 645f  n gradtrc.bound_
-0000be60: 7379 6d62 6f6c 7320 6966 206e 6f74 205f  symbols if not _
-0000be70: 6669 6c74 6572 2862 7379 6d29 0a20 2020  filter(bsym).   
-0000be80: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-0000be90: 2320 5354 4550 2046 4f55 5220 2d2d 2d20  # STEP FOUR --- 
-0000bea0: 4f72 6465 7273 2074 6865 206f 7065 7261  Orders the opera
-0000beb0: 7469 6f6e 730a 2020 2020 2020 2020 2320  tions.        # 
-0000bec0: 544f 444f 2043 6f6e 7369 6465 7220 616c  TODO Consider al
-0000bed0: 7465 726e 6174 6976 6520 7363 6865 6475  ternative schedu
-0000bee0: 6c69 6e67 2061 6c67 6f72 6974 686d 732c  ling algorithms,
-0000bef0: 206d 6179 6265 2062 7920 7573 696e 6720   maybe by using 
-0000bf00: 6772 6170 6820 6665 6174 7572 6573 0a20  graph features. 
-0000bf10: 2020 2020 2020 2023 2020 2053 6f6d 6520         #   Some 
-0000bf20: 6964 6561 7320 6172 6520 6c6f 6f6b 696e  ideas are lookin
-0000bf30: 6720 6174 206d 656d 6f72 792d 7361 7669  g at memory-savi
-0000bf40: 6e67 206e 6f64 6573 2c20 616e 6420 6e6f  ng nodes, and no
-0000bf50: 6465 7320 7769 7468 2061 2068 6967 6820  des with a high 
-0000bf60: 696e 2d64 6567 7265 6520 6f72 2068 6967  in-degree or hig
-0000bf70: 6820 6f75 742d 6465 6772 6565 0a0a 2020  h out-degree..  
-0000bf80: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0000bf90: 616e 2069 6e69 7469 616c 2076 616c 6964  an initial valid
-0000bfa0: 206f 7264 6572 696e 6720 746f 2044 4345   ordering to DCE
-0000bfb0: 2c20 736f 2074 6861 7420 6164 6469 7469  , so that additi
-0000bfc0: 6f6e 616c 206f 7264 6572 696e 6720 616e  onal ordering an
-0000bfd0: 616c 7973 6973 2064 6f65 736e 2774 206e  alysis doesn't n
-0000bfe0: 6565 6420 746f 2063 6f6e 7369 6465 7220  eed to consider 
-0000bff0: 616c 6c20 7379 6d62 6f6c 730a 2020 2020  all symbols.    
-0000c000: 2020 2020 726f 6f74 732c 206c 6561 7665      roots, leave
-0000c010: 7320 3d20 6273 796d 5f6c 6973 745f 746f  s = bsym_list_to
-0000c020: 5f64 6167 2867 7261 6474 7263 2e62 6f75  _dag(gradtrc.bou
-0000c030: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
-0000c040: 2020 2020 6f72 6465 7265 645f 6273 796d      ordered_bsym
-0000c050: 7320 3d20 746f 706f 736f 7274 5f62 7379  s = toposort_bsy
-0000c060: 6d5f 6461 6728 726f 6f74 732c 2054 4f50  m_dag(roots, TOP
-0000c070: 4f53 4f52 545f 4f52 4445 522e 544f 505f  OSORT_ORDER.TOP_
-0000c080: 444f 574e 290a 2020 2020 2020 2020 6772  DOWN).        gr
-0000c090: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
-0000c0a0: 6f6c 7320 3d20 6f72 6465 7265 645f 6273  ols = ordered_bs
-0000c0b0: 796d 730a 2020 2020 2020 2020 6772 6164  yms.        grad
-0000c0c0: 7472 6320 3d20 6463 6528 6772 6164 7472  trc = dce(gradtr
-0000c0d0: 6329 0a0a 2020 2020 2020 2020 2320 4964  c)..        # Id
-0000c0e0: 656e 7469 6669 6573 2074 6865 206f 7264  entifies the ord
-0000c0f0: 6572 206f 6620 426f 756e 6453 796d 626f  er of BoundSymbo
-0000c100: 6c73 2075 7369 6e67 2061 2022 4446 5320  ls using a "DFS 
-0000c110: 616e 6420 6368 6169 6e22 2061 6c67 6f72  and chain" algor
-0000c120: 6974 686d 0a20 2020 2020 2020 2023 2054  ithm.        # T
-0000c130: 4f44 4f20 456c 6162 6f72 6174 6520 6f6e  ODO Elaborate on
-0000c140: 2074 6869 7320 616c 676f 7269 7468 6d20   this algorithm 
-0000c150: 616e 6420 7468 6520 696d 706c 656d 656e  and the implemen
-0000c160: 7461 7469 6f6e 0a20 2020 2020 2020 2072  tation.        r
-0000c170: 6f6f 7473 2c20 6c65 6176 6573 203d 2062  oots, leaves = b
-0000c180: 7379 6d5f 6c69 7374 5f74 6f5f 6461 6728  sym_list_to_dag(
-0000c190: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
-0000c1a0: 6d62 6f6c 7329 0a20 2020 2020 2020 2063  mbols).        c
-0000c1b0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
-0000c1c0: 2020 6c65 6e28 6c65 6176 6573 2920 3d3d    len(leaves) ==
-0000c1d0: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-0000c1e0: 6c61 6d62 6461 3a20 6622 4578 7065 6374  lambda: f"Expect
-0000c1f0: 6564 206f 6e6c 7920 6f6e 6520 6c65 6166  ed only one leaf
-0000c200: 206e 6f64 6520 7768 656e 2073 6f72 7469   node when sorti
-0000c210: 6e67 2066 6f72 2067 7261 642c 2066 6f75  ng for grad, fou
-0000c220: 6e64 2074 6865 7265 2077 6572 6520 7b6c  nd there were {l
-0000c230: 656e 286c 6561 7665 7329 7d20 6c65 6176  en(leaves)} leav
-0000c240: 6573 222c 0a20 2020 2020 2020 2029 0a20  es",.        ). 
-0000c250: 2020 2020 2020 2028 6c65 6166 2c29 203d         (leaf,) =
-0000c260: 206c 6561 7665 730a 0a20 2020 2020 2020   leaves..       
-0000c270: 2023 2043 6f6d 7075 7465 7320 7468 6520   # Computes the 
-0000c280: 7465 6e73 6f72 206d 656d 6f72 7920 7573  tensor memory us
-0000c290: 6564 2062 7920 7468 6520 6769 7665 6e20  ed by the given 
-0000c2a0: 7079 7472 6565 0a20 2020 2020 2020 2064  pytree.        d
-0000c2b0: 6566 206d 656d 6f72 795f 7573 6564 2870  ef memory_used(p
-0000c2c0: 7974 7265 6529 202d 3e20 696e 743a 0a20  ytree) -> int:. 
-0000c2d0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-0000c2e0: 795f 7573 653a 2069 6e74 203d 2030 0a0a  y_use: int = 0..
-0000c2f0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-0000c300: 636f 756e 745f 6d65 6d6f 7279 5f75 7365  count_memory_use
-0000c310: 2878 293a 0a20 2020 2020 2020 2020 2020  (x):.           
-0000c320: 2020 2020 206e 6f6e 6c6f 6361 6c20 6d65       nonlocal me
-0000c330: 6d6f 7279 5f75 7365 0a20 2020 2020 2020  mory_use.       
-0000c340: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-0000c350: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-0000c360: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
-0000c370: 2020 2020 2020 2020 2020 2020 6d65 6d6f              memo
-0000c380: 7279 5f75 7365 202b 3d20 782e 6474 7970  ry_use += x.dtyp
-0000c390: 652e 5f62 7974 6573 202a 2078 2e6e 756d  e._bytes * x.num
-0000c3a0: 656c 0a0a 2020 2020 2020 2020 2020 2020  el..            
-0000c3b0: 7472 6565 5f6d 6170 2863 6f75 6e74 5f6d  tree_map(count_m
-0000c3c0: 656d 6f72 795f 7573 652c 2070 7974 7265  emory_use, pytre
-0000c3d0: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
-0000c3e0: 6574 7572 6e20 6d65 6d6f 7279 5f75 7365  eturn memory_use
-0000c3f0: 0a0a 2020 2020 2020 2020 2320 5472 7565  ..        # True
-0000c400: 2077 6865 6e20 6120 6e6f 6465 2069 7320   when a node is 
-0000c410: 6120 226c 696e 6b22 202d 2d20 6120 6e6f  a "link" -- a no
-0000c420: 6465 2077 6974 6820 6f6e 6c79 206f 6e65  de with only one
-0000c430: 2063 6869 6c64 2061 6e64 2061 7420 6d6f   child and at mo
-0000c440: 7374 206f 6e65 2070 6172 656e 740a 2020  st one parent.  
-0000c450: 2020 2020 2020 2320 2020 436f 6e63 6570        #   Concep
-0000c460: 7475 616c 6c79 2074 6865 206e 6f64 6520  tually the node 
-0000c470: 6973 2061 2022 6c69 6e6b 2220 696e 2061  is a "link" in a
-0000c480: 2063 6861 696e 206f 6620 6e6f 6465 7320   chain of nodes 
-0000c490: 6c69 6b65 2041 202d 3e20 4220 2d3e 2043  like A -> B -> C
-0000c4a0: 0a20 2020 2020 2020 2064 6566 2069 735f  .        def is_
-0000c4b0: 6c69 6e6b 286e 3a20 4e6f 6465 2920 2d3e  link(n: Node) ->
-0000c4c0: 2062 6f6f 6c3a 0a20 2020 2020 2020 2020   bool:.         
-0000c4d0: 2020 205f 6973 5f6c 696e 6b20 3d20 6c65     _is_link = le
-0000c4e0: 6e28 6e2e 6368 696c 6472 656e 2920 3d3d  n(n.children) ==
-0000c4f0: 2031 2061 6e64 206c 656e 286e 2e70 6172   1 and len(n.par
-0000c500: 656e 7473 2920 3c3d 2031 0a20 2020 2020  ents) <= 1.     
-0000c510: 2020 2020 2020 2072 6574 7572 6e20 5f69         return _i
-0000c520: 735f 6c69 6e6b 0a0a 2020 2020 2020 2020  s_link..        
-0000c530: 636f 756e 7465 723a 2069 6e74 203d 2030  counter: int = 0
-0000c540: 0a0a 2020 2020 2020 2020 6465 6620 5f63  ..        def _c
-0000c550: 6861 696e 2863 3a20 6c69 7374 5b4e 6f64  hain(c: list[Nod
-0000c560: 655d 2c20 656e 643a 204e 6f64 6529 202d  e], end: Node) -
-0000c570: 3e20 6c69 7374 5b4e 6f64 655d 3a0a 2020  > list[Node]:.  
-0000c580: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
-0000c590: 616c 2063 6f75 6e74 6572 0a0a 2020 2020  al counter..    
-0000c5a0: 2020 2020 2020 2020 2320 544f 444f 2045          # TODO E
-0000c5b0: 7870 6572 696d 656e 7420 7769 7468 206e  xperiment with n
-0000c5c0: 6f74 2061 6c77 6179 7320 6675 7369 6e67  ot always fusing
-0000c5d0: 2074 6869 7320 696e 746f 2074 6865 2063   this into the c
-0000c5e0: 6f6e 7375 6d65 7220 2d2d 2074 6865 7265  onsumer -- there
-0000c5f0: 2063 6f75 6c64 2062 6520 616e 0a20 2020   could be an.   
-0000c600: 2020 2020 2020 2020 2023 2020 2069 6e74           #   int
-0000c610: 6572 6573 7469 6e67 206d 696e 6375 740a  eresting mincut.
-0000c620: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-0000c630: 5445 2049 6e20 7468 6973 2063 6173 6520  TE In this case 
-0000c640: 7468 6520 6368 6169 6e20 6361 6e6e 6f74  the chain cannot
-0000c650: 2062 6520 6578 7465 6e64 6564 2c20 616e   be extended, an
-0000c660: 6420 6974 7320 6f72 6967 696e 2069 7320  d its origin is 
-0000c670: 696e 7075 7420 746f 2074 6865 2066 756e  input to the fun
-0000c680: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-0000c690: 2020 2320 2020 736f 2074 6869 7320 6a75    #   so this ju
-0000c6a0: 7374 2066 7573 6573 2069 7420 696e 746f  st fuses it into
-0000c6b0: 2074 6865 2063 6f6e 7375 6d65 720a 2020   the consumer.  
-0000c6c0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0000c6d0: 2865 6e64 2e70 6172 656e 7473 2920 3d3d  (end.parents) ==
-0000c6e0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0000c6f0: 2020 2020 666f 7220 6e20 696e 2063 3a0a      for n in c:.
-0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c710: 2020 2020 6e2e 6e75 6d62 6572 203d 2063      n.number = c
-0000c720: 6f75 6e74 6572 0a20 2020 2020 2020 2020  ounter.         
-0000c730: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
-0000c740: 6572 202b 3d20 310a 2020 2020 2020 2020  er += 1.        
-0000c750: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-0000c760: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-0000c770: 204e 4f54 4520 6c65 6e28 656e 642e 7061   NOTE len(end.pa
-0000c780: 7265 6e74 7329 203d 3d20 3120 6f6e 2074  rents) == 1 on t
-0000c790: 6869 7320 7061 7468 0a20 2020 2020 2020  his path.       
-0000c7a0: 2020 2020 2028 7061 7265 6e74 2c29 203d       (parent,) =
-0000c7b0: 2065 6e64 2e70 6172 656e 7473 0a0a 2020   end.parents..  
-0000c7c0: 2020 2020 2020 2020 2020 2320 4578 7465            # Exte
-0000c7d0: 6e64 7320 7468 6520 6368 6169 6e20 6966  nds the chain if
-0000c7e0: 2074 6865 2070 6172 656e 7420 6973 2061   the parent is a
-0000c7f0: 206c 696e 6b0a 2020 2020 2020 2020 2020   link.          
-0000c800: 2020 6966 2069 735f 6c69 6e6b 2870 6172    if is_link(par
-0000c810: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-0000c820: 2020 2020 2020 632e 6170 7065 6e64 2870        c.append(p
-0000c830: 6172 656e 7429 0a20 2020 2020 2020 2020  arent).         
-0000c840: 2020 2020 2020 2072 6574 7572 6e20 5f63         return _c
-0000c850: 6861 696e 2863 2c20 7061 7265 6e74 290a  hain(c, parent).
-0000c860: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-0000c870: 4f54 4520 496e 2074 6869 7320 6361 7365  OTE In this case
-0000c880: 2074 6865 2063 6861 696e 2068 6173 2061   the chain has a
-0000c890: 2070 6172 656e 7420 7468 6174 2069 7320   parent that is 
-0000c8a0: 6e6f 7420 6120 6c69 6e6b 0a20 2020 2020  not a link.     
-0000c8b0: 2020 2020 2020 2023 2046 696e 6473 2074         # Finds t
-0000c8c0: 6865 206d 696e 6375 740a 2020 2020 2020  he mincut.      
-0000c8d0: 2020 2020 2020 6d69 6e63 7574 5f69 6478        mincut_idx
-0000c8e0: 3a20 696e 7420 3d20 6c65 6e28 6329 0a20  : int = len(c). 
-0000c8f0: 2020 2020 2020 2020 2020 206d 696e 5f6d             min_m
-0000c900: 656d 6f72 795f 7573 6167 653a 2069 6e74  emory_usage: int
-0000c910: 203d 206d 656d 6f72 795f 7573 6564 2870   = memory_used(p
-0000c920: 6172 656e 742e 6273 796d 2e6f 7574 7075  arent.bsym.outpu
-0000c930: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-0000c940: 666f 7220 6964 782c 206e 2069 6e20 656e  for idx, n in en
-0000c950: 756d 6572 6174 6528 6329 3a0a 2020 2020  umerate(c):.    
-0000c960: 2020 2020 2020 2020 2020 2020 6d65 6d20              mem 
-0000c970: 3d20 6d65 6d6f 7279 5f75 7365 6428 6e2e  = memory_used(n.
-0000c980: 6273 796d 2e6f 7574 7075 7429 0a20 2020  bsym.output).   
-0000c990: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000c9a0: 6d65 6d20 3c20 6d69 6e5f 6d65 6d6f 7279  mem < min_memory
-0000c9b0: 5f75 7361 6765 3a0a 2020 2020 2020 2020  _usage:.        
-0000c9c0: 2020 2020 2020 2020 2020 2020 6d69 6e63              minc
-0000c9d0: 7574 5f69 6478 203d 2069 6478 0a20 2020  ut_idx = idx.   
-0000c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9f0: 206d 696e 5f6d 656d 6f72 795f 7573 6167   min_memory_usag
-0000ca00: 6520 3d20 6d65 6d0a 0a20 2020 2020 2020  e = mem..       
-0000ca10: 2020 2020 2066 6f72 2069 6478 2c20 6e20       for idx, n 
-0000ca20: 696e 2065 6e75 6d65 7261 7465 2863 293a  in enumerate(c):
-0000ca30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ca40: 2069 6620 6964 7820 3c20 6d69 6e63 7574   if idx < mincut
-0000ca50: 5f69 6478 3a0a 2020 2020 2020 2020 2020  _idx:.          
-0000ca60: 2020 2020 2020 2020 2020 6e2e 6e75 6d62            n.numb
-0000ca70: 6572 203d 2063 6f75 6e74 6572 0a20 2020  er = counter.   
-0000ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca90: 2063 6f75 6e74 6572 202b 3d20 310a 0a20   counter += 1.. 
-0000caa0: 2020 2020 2020 2020 2020 2023 2052 6574             # Ret
-0000cab0: 7572 6e73 2074 6865 2070 726f 6475 6365  urns the produce
-0000cac0: 722d 7369 6465 2063 6861 696e 2063 7574  r-side chain cut
-0000cad0: 2069 6620 6974 2065 7869 7374 730a 2020   if it exists.  
-0000cae0: 2020 2020 2020 2020 2020 6966 206d 696e            if min
-0000caf0: 6375 745f 6964 7820 3c20 6c65 6e28 6329  cut_idx < len(c)
-0000cb00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cb10: 2020 7265 7475 726e 205b 635b 6d69 6e63    return [c[minc
-0000cb20: 7574 5f69 6478 5d5d 0a20 2020 2020 2020  ut_idx]].       
-0000cb30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000cb40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000cb50: 7420 6d69 6e63 7574 5f69 6478 203d 3d20  t mincut_idx == 
-0000cb60: 6c65 6e28 6329 0a20 2020 2020 2020 2020  len(c).         
-0000cb70: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
-0000cb80: 642e 7061 7265 6e74 730a 0a20 2020 2020  d.parents..     
-0000cb90: 2020 2064 6566 2063 6861 696e 5f6f 7574     def chain_out
-0000cba0: 286e 3a20 4e6f 6465 2c20 7374 6163 6b3a  (n: Node, stack:
-0000cbb0: 206c 6973 745b 4e6f 6465 5d29 202d 3e20   list[Node]) -> 
-0000cbc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000cbd0: 2020 2320 5368 6f72 742d 6369 7263 7569    # Short-circui
-0000cbe0: 7473 2069 6620 7468 6520 6f72 6967 696e  ts if the origin
-0000cbf0: 616c 206e 6f64 6520 6e20 6361 6e6e 6f74  al node n cannot
-0000cc00: 2062 6520 7061 7274 206f 6620 6120 6368   be part of a ch
-0000cc10: 6169 6e0a 2020 2020 2020 2020 2020 2020  ain.            
-0000cc20: 6966 206e 6f74 2069 735f 6c69 6e6b 286e  if not is_link(n
-0000cc30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000cc40: 2020 2073 7461 636b 2e61 7070 656e 6428     stack.append(
-0000cc50: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-0000cc60: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-0000cc70: 2020 2020 2020 2023 204e 4f54 4520 6973         # NOTE is
-0000cc80: 5f6c 696e 6b28 6e29 203d 3d20 5472 7565  _link(n) == True
-0000cc90: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
-0000cca0: 745f 6368 6169 6e3a 206c 6973 745b 4e6f  t_chain: list[No
-0000ccb0: 6465 5d20 3d20 5f63 6861 696e 285b 6e5d  de] = _chain([n]
-0000ccc0: 2c20 6e29 0a0a 2020 2020 2020 2020 2020  , n)..          
-0000ccd0: 2020 666f 7220 7063 2069 6e20 706f 7374    for pc in post
-0000cce0: 5f63 6861 696e 3a0a 2020 2020 2020 2020  _chain:.        
-0000ccf0: 2020 2020 2020 2020 7374 6163 6b2e 6170          stack.ap
-0000cd00: 7065 6e64 2870 6329 0a0a 2020 2020 2020  pend(pc)..      
-0000cd10: 2020 7374 6163 6b3a 206c 6973 745b 4e6f    stack: list[No
-0000cd20: 6465 5d20 3d20 5b6c 6561 665d 0a20 2020  de] = [leaf].   
-0000cd30: 2020 2020 2077 6869 6c65 206c 656e 2873       while len(s
-0000cd40: 7461 636b 2920 3e20 303a 0a20 2020 2020  tack) > 0:.     
-0000cd50: 2020 2020 2020 206e 3a20 4e6f 6465 203d         n: Node =
-0000cd60: 2073 7461 636b 2e70 6f70 2829 0a0a 2020   stack.pop()..  
-0000cd70: 2020 2020 2020 2020 2020 6966 206e 2e6e            if n.n
-0000cd80: 756d 6265 7220 6973 206e 6f74 204e 6f6e  umber is not Non
-0000cd90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000cda0: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0000cdb0: 2020 2020 2020 2020 206e 2e6e 756d 6265           n.numbe
-0000cdc0: 7220 3d20 636f 756e 7465 720a 2020 2020  r = counter.    
-0000cdd0: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
-0000cde0: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-0000cdf0: 2020 666f 7220 7020 696e 206e 2e70 6172    for p in n.par
-0000ce00: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-0000ce10: 2020 2020 2020 6368 6169 6e5f 6f75 7428        chain_out(
-0000ce20: 702c 2073 7461 636b 290a 0a20 2020 2020  p, stack)..     
-0000ce30: 2020 2064 6566 205f 7365 6c65 6374 6f72     def _selector
-0000ce40: 2865 6c69 6769 626c 655f 6e6f 6465 733a  (eligible_nodes:
-0000ce50: 206c 6973 745b 4e6f 6465 5d29 202d 3e20   list[Node]) -> 
-0000ce60: 696e 743a 0a20 2020 2020 2020 2020 2020  int:.           
-0000ce70: 206d 696e 5f69 6478 3a20 696e 7420 3d20   min_idx: int = 
-0000ce80: 300a 2020 2020 2020 2020 2020 2020 6d69  0.            mi
-0000ce90: 6e5f 6e75 6d62 6572 3a20 696e 7420 3d20  n_number: int = 
-0000cea0: 656c 6967 6962 6c65 5f6e 6f64 6573 5b30  eligible_nodes[0
-0000ceb0: 5d2e 6e75 6d62 6572 0a0a 2020 2020 2020  ].number..      
-0000cec0: 2020 2020 2020 2320 4e4f 5445 2041 6c74        # NOTE Alt
-0000ced0: 686f 7567 6820 7765 2776 6520 616c 7265  hough we've alre
-0000cee0: 6164 7920 7072 6f63 6573 7365 6420 7468  ady processed th
-0000cef0: 6520 6669 7273 7420 656c 656d 656e 7420  e first element 
-0000cf00: 6865 7265 2c20 7468 6973 2073 7469 6c6c  here, this still
-0000cf10: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000cf20: 2065 6e75 6d65 7261 7465 7320 7468 6520   enumerates the 
-0000cf30: 656e 7469 7265 206c 6973 7420 6320 746f  entire list c to
-0000cf40: 2061 6c69 676e 2074 6865 2065 6e75 6d65   align the enume
-0000cf50: 7261 7469 6f6e 2069 6478 2070 726f 7065  ration idx prope
-0000cf60: 726c 790a 2020 2020 2020 2020 2020 2020  rly.            
-0000cf70: 666f 7220 6964 782c 206e 2069 6e20 656e  for idx, n in en
-0000cf80: 756d 6572 6174 6528 656c 6967 6962 6c65  umerate(eligible
-0000cf90: 5f6e 6f64 6573 293a 0a20 2020 2020 2020  _nodes):.       
-0000cfa0: 2020 2020 2020 2020 2063 6865 636b 286e           check(n
-0000cfb0: 2e6e 756d 6265 7220 6973 206e 6f74 204e  .number is not N
-0000cfc0: 6f6e 652c 206c 616d 6264 613a 2066 2245  one, lambda: f"E
-0000cfd0: 7870 6563 7465 6420 6561 6368 206e 6f64  xpected each nod
-0000cfe0: 6520 746f 2062 6520 6e75 6d62 6572 6564  e to be numbered
-0000cff0: 2c20 6275 7420 7b6e 7d20 7761 7320 6e6f  , but {n} was no
-0000d000: 7422 290a 0a20 2020 2020 2020 2020 2020  t")..           
-0000d010: 2020 2020 2069 6620 6e2e 6e75 6d62 6572       if n.number
-0000d020: 203c 206d 696e 5f6e 756d 6265 723a 0a20   < min_number:. 
-0000d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d040: 2020 206d 696e 5f69 6478 203d 2069 6478     min_idx = idx
-0000d050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d060: 2020 2020 206d 696e 5f6e 756d 6265 7220       min_number 
-0000d070: 3d20 6e2e 6e75 6d62 6572 0a0a 2020 2020  = n.number..    
-0000d080: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0000d090: 696e 5f69 6478 0a0a 2020 2020 2020 2020  in_idx..        
-0000d0a0: 736f 7274 6564 5f62 7379 6d73 203d 2074  sorted_bsyms = t
-0000d0b0: 6f70 6f73 6f72 745f 6273 796d 5f64 6167  oposort_bsym_dag
-0000d0c0: 286c 6561 7665 732c 2074 6f70 6f73 6f72  (leaves, toposor
-0000d0d0: 745f 6f72 6465 723d 544f 504f 534f 5254  t_order=TOPOSORT
-0000d0e0: 5f4f 5244 4552 2e42 4f54 544f 4d5f 5550  _ORDER.BOTTOM_UP
-0000d0f0: 2c20 7365 6c65 6374 6f72 3d5f 7365 6c65  , selector=_sele
-0000d100: 6374 6f72 290a 2020 2020 2020 2020 6772  ctor).        gr
-0000d110: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
-0000d120: 6f6c 7320 3d20 736f 7274 6564 5f62 7379  ols = sorted_bsy
-0000d130: 6d73 0a20 2020 2020 2020 2067 7261 6474  ms.        gradt
-0000d140: 7263 203d 2064 6365 2867 7261 6474 7263  rc = dce(gradtrc
-0000d150: 290a 0a20 2020 2020 2020 2023 2054 4f44  )..        # TOD
-0000d160: 4f20 436f 6e73 6964 6572 2068 6f77 2074  O Consider how t
-0000d170: 6f20 6861 6e64 6c65 2067 7261 6420 772e  o handle grad w.
-0000d180: 722e 742e 206f 6e6c 7920 736f 6d65 206f  r.t. only some o
-0000d190: 7574 7075 7473 202d 2d20 7368 6f75 6c64  utputs -- should
-0000d1a0: 2061 6c6c 2067 7261 640a 2020 2020 2020   all grad.      
-0000d1b0: 2020 2320 2020 6f70 6572 6174 696f 6e73    #   operations
-0000d1c0: 2075 7369 6e67 2074 6865 206f 7468 6572   using the other
-0000d1d0: 206f 7574 7075 7420 6265 2072 656d 6f76   output be remov
-0000d1e0: 6564 3f20 5768 6174 206b 696e 6420 6f66  ed? What kind of
-0000d1f0: 2061 7373 756d 7074 696f 6e20 646f 6573   assumption does
-0000d200: 2074 6861 740a 2020 2020 2020 2020 2320   that.        # 
-0000d210: 2020 6d61 6b65 2061 626f 7574 2074 6865    make about the
-0000d220: 2067 7261 6420 7374 7275 6374 7572 653f   grad structure?
-0000d230: 2050 726f 6261 626c 7920 736f 6d65 206b   Probably some k
-0000d240: 696e 6420 6f66 2069 6e64 6570 656e 6465  ind of independe
-0000d250: 6e63 6520 6173 7375 6d70 7469 6f6e 3f20  nce assumption? 
-0000d260: 4172 650a 2020 2020 2020 2020 2320 2020  Are.        #   
-0000d270: 7468 6572 6520 7072 6163 7469 6361 6c20  there practical 
-0000d280: 6578 616d 706c 6573 2077 6865 7265 2074  examples where t
-0000d290: 6861 7427 7320 616e 2069 7373 7565 3f0a  hat's an issue?.
-0000d2a0: 0a20 2020 2020 2020 2065 6e64 5f74 696d  .        end_tim
-0000d2b0: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
-0000d2c0: 5f6e 7328 290a 2020 2020 2020 2020 656c  _ns().        el
-0000d2d0: 6170 7365 645f 7469 6d65 5f6e 7320 3d20  apsed_time_ns = 
-0000d2e0: 656e 645f 7469 6d65 5f6e 7320 2d20 7374  end_time_ns - st
-0000d2f0: 6172 745f 7469 6d65 5f6e 730a 2020 2020  art_time_ns.    
-0000d300: 2020 2020 656c 6170 7365 645f 7469 6d65      elapsed_time
-0000d310: 5f6d 696c 6c69 7320 3d20 656c 6170 7365  _millis = elapse
-0000d320: 645f 7469 6d65 5f6e 7320 2f2f 2031 3030  d_time_ns // 100
-0000d330: 3030 3030 0a20 2020 2020 2020 2067 7261  0000.        gra
-0000d340: 6474 7263 2e73 6574 5f70 726f 7665 6e61  dtrc.set_provena
-0000d350: 6e63 6528 5472 6163 6550 726f 7665 6e61  nce(TraceProvena
-0000d360: 6e63 6528 6622 4772 6164 2028 746f 6f6b  nce(f"Grad (took
-0000d370: 207b 656c 6170 7365 645f 7469 6d65 5f6d   {elapsed_time_m
-0000d380: 696c 6c69 737d 206d 696c 6c69 7365 636f  illis} milliseco
-0000d390: 6e64 7329 2229 290a 0a20 2020 2020 2020  nds)"))..       
-0000d3a0: 2072 6574 7572 6e20 6772 6164 7472 630a   return gradtrc.
-0000d3b0: 0a20 2020 2023 204e 4f54 4520 5468 6973  .    # NOTE This
-0000d3c0: 2069 7320 6120 6b6c 7564 6765 2074 6f20   is a kludge to 
-0000d3d0: 696e 6469 6361 7465 2074 6861 7420 7765  indicate that we
-0000d3e0: 2073 686f 756c 646e 2774 2075 7365 2050   shouldn't use P
-0000d3f0: 7954 6f72 6368 2773 2061 7574 6f67 7261  yTorch's autogra
-0000d400: 6420 6265 6361 7573 650a 2020 2020 2320  d because.    # 
-0000d410: 2020 7765 2772 6520 7573 696e 6720 6f75    we're using ou
-0000d420: 7220 6f77 6e20 6175 746f 6772 6164 2074  r own autograd t
-0000d430: 7261 6e73 666f 726d 0a20 2020 2063 666e  ransform.    cfn
-0000d440: 2e5f 7573 696e 675f 6772 6164 5f74 7261  ._using_grad_tra
-0000d450: 6e73 666f 726d 203d 2054 7275 650a 0a20  nsform = True.. 
-0000d460: 2020 2072 6574 7572 6e20 6164 645f 7472     return add_tr
-0000d470: 616e 7366 6f72 6d28 6366 6e2c 2074 7261  ansform(cfn, tra
-0000d480: 6e73 666f 726d 3d5f 6772 6164 5f74 7261  nsform=_grad_tra
-0000d490: 6e73 666f 726d 2c20 6469 7361 626c 655f  nsform, disable_
-0000d4a0: 746f 7263 685f 6175 746f 6772 6164 5f73  torch_autograd_s
-0000d4b0: 7570 706f 7274 3d54 7275 6529 0a0a 0a64  upport=True)...d
-0000d4c0: 6566 2067 7261 6428 0a20 2020 2063 666e  ef grad(.    cfn
-0000d4d0: 2c0a 2920 2d3e 2043 616c 6c61 626c 653a  ,.) -> Callable:
-0000d4e0: 0a20 2020 2064 6566 2067 7261 6428 6675  .    def grad(fu
-0000d4f0: 6e63 293a 0a0a 2020 2020 2020 2020 4077  nc):..        @w
-0000d500: 7261 7073 2866 756e 6329 0a20 2020 2020  raps(func).     
-0000d510: 2020 2064 6566 2067 7261 645f 6675 6e63     def grad_func
-0000d520: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-0000d530: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
-0000d540: 2c20 6772 6164 7320 3d20 7661 6c75 655f  , grads = value_
-0000d550: 616e 645f 6772 6164 2866 756e 6329 282a  and_grad(func)(*
-0000d560: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
-0000d570: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-0000d580: 7320 3d20 7472 6565 5f66 6c61 7474 656e  s = tree_flatten
-0000d590: 2867 7261 6473 295b 305d 0a20 2020 2020  (grads)[0].     
-0000d5a0: 2020 2020 2020 2067 7261 6473 203d 205b         grads = [
-0000d5b0: 6720 666f 7220 6720 696e 2067 7261 6473  g for g in grads
-0000d5c0: 2069 6620 6720 6973 206e 6f74 204e 6f6e   if g is not Non
-0000d5d0: 655d 0a20 2020 2020 2020 2020 2020 2072  e].            r
-0000d5e0: 6574 7572 6e20 6772 6164 730a 0a20 2020  eturn grads..   
-0000d5f0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
-0000d600: 5f66 756e 630a 0a20 2020 2064 6566 205f  _func..    def _
-0000d610: 6772 6164 5f74 7261 6e73 666f 726d 2874  grad_transform(t
-0000d620: 7263 3a20 5472 6163 652c 202a 2c20 6578  rc: Trace, *, ex
-0000d630: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
-0000d640: 7175 656e 6365 5b41 6e79 5d29 202d 3e20  quence[Any]) -> 
-0000d650: 5472 6163 653a 0a20 2020 2020 2020 2023  Trace:.        #
-0000d660: 2055 7369 6e67 2074 7263 2e70 7974 686f   Using trc.pytho
-0000d670: 6e5f 6361 6c6c 6162 6c65 2829 206d 616b  n_callable() mak
-0000d680: 6573 2069 7420 696d 706f 7373 6962 6c65  es it impossible
-0000d690: 2074 6f20 7265 7472 6163 6520 7468 650a   to retrace the.
-0000d6a0: 2020 2020 2020 2020 2320 6675 6e63 7469          # functi
-0000d6b0: 6f6e 2062 6563 6175 7365 2074 6865 2070  on because the p
-0000d6c0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2075  ython_callable u
-0000d6d0: 7365 7320 7079 7468 6f6e 5f63 7478 2077  ses python_ctx w
-0000d6e0: 6869 6368 2072 6570 6c61 6365 730a 2020  hich replaces.  
-0000d6f0: 2020 2020 2020 2320 7379 6d62 6f6c 206f        # symbol o
-0000d700: 6363 7572 7265 6e63 6573 2077 6974 6820  ccurrences with 
-0000d710: 6974 7320 7379 6d62 6f6c 2e5f 6361 6c6c  its symbol._call
-0000d720: 5f63 7478 2066 756e 6374 696f 6e0a 2020  _ctx function.  
-0000d730: 2020 2020 2020 4077 7261 7073 2874 7263        @wraps(trc
-0000d740: 2e70 7974 686f 6e5f 6361 6c6c 6162 6c65  .python_callable
-0000d750: 2829 290a 2020 2020 2020 2020 6465 6620  ()).        def 
-0000d760: 7079 7468 6f6e 5f63 616c 6c61 626c 6528  python_callable(
-0000d770: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0000d780: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000d790: 7475 726e 2065 7661 6c5f 7472 6163 6528  turn eval_trace(
-0000d7a0: 7472 632c 202a 6172 6773 2c20 2a2a 6b77  trc, *args, **kw
-0000d7b0: 6172 6773 290a 0a20 2020 2020 2020 2067  args)..        g
-0000d7c0: 7261 6474 7263 203d 2063 6f6e 7374 7275  radtrc = constru
-0000d7d0: 6374 5f74 7261 6365 2829 2867 7261 6428  ct_trace()(grad(
-0000d7e0: 7079 7468 6f6e 5f63 616c 6c61 626c 6529  python_callable)
-0000d7f0: 2c20 2a74 7263 2e61 7267 732c 202a 2a74  , *trc.args, **t
-0000d800: 7263 2e6b 7761 7267 7329 0a20 2020 2020  rc.kwargs).     
-0000d810: 2020 2072 6574 7572 6e20 6772 6164 7472     return gradtr
-0000d820: 630a 0a20 2020 2063 666e 2e5f 7573 696e  c..    cfn._usin
-0000d830: 675f 6772 6164 5f74 7261 6e73 666f 726d  g_grad_transform
-0000d840: 203d 2054 7275 650a 2020 2020 7265 7475   = True.    retu
-0000d850: 726e 2061 6464 5f74 7261 6e73 666f 726d  rn add_transform
-0000d860: 2863 666e 2c20 7472 616e 7366 6f72 6d3d  (cfn, transform=
-0000d870: 5f67 7261 645f 7472 616e 7366 6f72 6d2c  _grad_transform,
-0000d880: 2064 6973 6162 6c65 5f74 6f72 6368 5f61   disable_torch_a
-0000d890: 7574 6f67 7261 645f 7375 7070 6f72 743d  utograd_support=
-0000d8a0: 5472 7565 290a 0a0a 636c 6173 7320 5472  True)...class Tr
-0000d8b0: 616e 7366 6f72 6d73 2845 6e75 6d29 3a0a  ansforms(Enum):.
-0000d8c0: 2020 2020 4964 656e 7469 7479 4f70 203d      IdentityOp =
-0000d8d0: 2061 7574 6f28 290a 2020 2020 566d 6170   auto().    Vmap
-0000d8e0: 4f70 203d 2061 7574 6f28 290a 2020 2020  Op = auto().    
-0000d8f0: 4a76 704f 7020 3d20 6175 746f 2829 0a20  JvpOp = auto(). 
-0000d900: 2020 2056 6a70 4f70 203d 2061 7574 6f28     VjpOp = auto(
-0000d910: 290a 0a0a 406c 7275 5f63 6163 6865 286d  )...@lru_cache(m
-0000d920: 6178 7369 7a65 3d4e 6f6e 6529 0a64 6566  axsize=None).def
-0000d930: 2073 796d 626f 6c5f 746f 5f65 7661 6c28   symbol_to_eval(
-0000d940: 626f 756e 645f 7379 6d62 6f6c 293a 0a20  bound_symbol):. 
-0000d950: 2020 2022 2222 4d61 7020 6120 426f 756e     """Map a Boun
-0000d960: 6453 796d 626f 6c20 746f 2061 2066 756e  dSymbol to a fun
-0000d970: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
-0000d980: 6174 6573 2069 742e 0a0a 2020 2020 4172  ates it...    Ar
-0000d990: 6773 3a0a 2020 2020 2020 2020 626f 756e  gs:.        boun
-0000d9a0: 645f 7379 6d62 6f6c 3a20 426f 756e 6453  d_symbol: BoundS
-0000d9b0: 796d 626f 6c20 746f 206d 6170 0a20 2020  ymbol to map.   
-0000d9c0: 2022 2222 0a20 2020 2023 2053 796d 626f   """.    # Symbo
-0000d9d0: 6c20 6973 2063 616c 6c61 626c 650a 2020  l is callable.  
-0000d9e0: 2020 7265 7475 726e 2062 6f75 6e64 5f73    return bound_s
-0000d9f0: 796d 626f 6c2e 7379 6d0a 0a0a 2320 544f  ymbol.sym...# TO
-0000da00: 444f 3a20 4375 7272 656e 746c 7920 7765  DO: Currently we
-0000da10: 2075 7365 2074 7261 6365 2e61 7267 7320   use trace.args 
-0000da20: 616e 6420 7472 6163 652e 6b77 6172 6773  and trace.kwargs
-0000da30: 2074 6f20 6765 7420 7468 6520 6172 6775   to get the argu
-0000da40: 6d65 6e74 730a 2320 4d61 7962 6520 7765  ments.# Maybe we
-0000da50: 2073 686f 756c 6420 7573 6520 7468 6573   should use thes
-0000da60: 6520 696e 7374 6561 640a 7472 616e 7366  e instead.transf
-0000da70: 6f72 6d5f 736b 6970 5f6c 6973 7420 3d20  orm_skip_list = 
-0000da80: 280a 2020 2020 7072 696d 732e 5072 696d  (.    prims.Prim
-0000da90: 4944 732e 554e 5041 434b 5f45 4d50 5459  IDs.UNPACK_EMPTY
-0000daa0: 5f44 4943 542c 0a20 2020 2070 7269 6d73  _DICT,.    prims
-0000dab0: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
-0000dac0: 4b45 592c 0a20 2020 2070 7269 6d73 2e50  KEY,.    prims.P
-0000dad0: 7269 6d49 4473 2e55 4e50 4143 4b5f 5345  rimIDs.UNPACK_SE
-0000dae0: 5155 454e 4345 2c0a 2020 2020 7072 696d  QUENCE,.    prim
-0000daf0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
-0000db00: 5f54 5249 5649 414c 2c0a 2020 2020 7072  _TRIVIAL,.    pr
-0000db10: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
-0000db20: 524e 2c0a 290a 0a0a 6465 6620 6576 616c  RN,.)...def eval
-0000db30: 5f74 7261 6365 2874 7261 6365 2c20 2a61  _trace(trace, *a
-0000db40: 7267 732c 2073 796d 626f 6c5f 6d61 7070  rgs, symbol_mapp
-0000db50: 6572 3d73 796d 626f 6c5f 746f 5f65 7661  er=symbol_to_eva
-0000db60: 6c2c 2077 6974 685f 656e 763d 4661 6c73  l, with_env=Fals
-0000db70: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
-0000db80: 2020 2222 2245 7661 6c75 6174 6520 6120    """Evaluate a 
-0000db90: 7472 6163 652e 0a0a 2020 2020 4172 6773  trace...    Args
-0000dba0: 3a0a 2020 2020 2020 2020 7472 6163 653a  :.        trace:
-0000dbb0: 2074 7261 6365 2074 6f20 6576 616c 7561   trace to evalua
-0000dbc0: 7465 0a20 2020 2020 2020 202a 6172 6773  te.        *args
-0000dbd0: 3a20 6172 6775 6d65 6e74 7320 746f 2065  : arguments to e
-0000dbe0: 7661 6c75 6174 6520 7468 6520 7472 6163  valuate the trac
-0000dbf0: 6520 7769 7468 0a20 2020 2020 2020 2073  e with.        s
-0000dc00: 796d 626f 6c5f 6d61 7070 6572 3a20 6675  ymbol_mapper: fu
-0000dc10: 6e63 7469 6f6e 2074 6861 7420 6d61 7073  nction that maps
-0000dc20: 2061 2073 796d 626f 6c20 746f 2061 2066   a symbol to a f
-0000dc30: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
-0000dc40: 6c75 6174 6573 2069 740a 2020 2020 2020  luates it.      
-0000dc50: 2020 2a2a 6b77 6172 6773 3a20 6b65 7977    **kwargs: keyw
-0000dc60: 6f72 6420 6172 6775 6d65 6e74 7320 746f  ord arguments to
-0000dc70: 2065 7661 6c75 6174 6520 7468 6520 7472   evaluate the tr
-0000dc80: 6163 6520 7769 7468 0a0a 2020 2020 5265  ace with..    Re
-0000dc90: 7475 726e 733a 0a20 2020 2020 2020 2072  turns:.        r
-0000dca0: 6573 756c 7420 6f66 2065 7661 6c75 6174  esult of evaluat
-0000dcb0: 696e 6720 7468 6520 7472 6163 650a 2020  ing the trace.  
-0000dcc0: 2020 2222 220a 2020 2020 656e 7620 3d20    """.    env = 
-0000dcd0: 7b7d 0a0a 2020 2020 6465 6620 7265 6164  {}..    def read
-0000dce0: 2878 3a20 5661 7269 6162 6c65 293a 0a20  (x: Variable):. 
-0000dcf0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000dd00: 616e 6365 2878 2c20 5661 7269 6162 6c65  ance(x, Variable
-0000dd10: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000dd20: 6574 7572 6e20 656e 765b 782e 6e61 6d65  eturn env[x.name
-0000dd30: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-0000dd40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000dd50: 726e 2078 0a0a 2020 2020 6465 6620 7772  rn x..    def wr
-0000dd60: 6974 6528 763a 2056 6172 6961 626c 652c  ite(v: Variable,
-0000dd70: 2076 616c 3a20 416e 792c 2061 6c6c 6f77   val: Any, allow
-0000dd80: 5f64 7570 6c69 6361 7465 733d 4661 6c73  _duplicates=Fals
-0000dd90: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0000dda0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-0000ddb0: 7461 6e63 6528 762c 2056 6172 6961 626c  tance(v, Variabl
-0000ddc0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000ddd0: 7265 7475 726e 0a20 2020 2020 2020 2023  return.        #
-0000dde0: 2044 7570 6c69 6361 7465 7320 6172 6520   Duplicates are 
-0000ddf0: 616c 6c6f 7765 6420 616e 6420 6f76 6572  allowed and over
-0000de00: 7772 6974 7465 6e0a 2020 2020 2020 2020  written.        
-0000de10: 6966 2076 2e6e 616d 6520 696e 2065 6e76  if v.name in env
-0000de20: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000de30: 2061 6c6c 6f77 5f64 7570 6c69 6361 7465   allow_duplicate
-0000de40: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000de50: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0000de60: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0000de70: 6545 7272 6f72 2866 2256 6172 6961 626c  eError(f"Variabl
-0000de80: 6520 7b76 2e6e 616d 657d 2069 7320 6265  e {v.name} is be
-0000de90: 696e 6720 6f76 6572 7772 6974 7465 6e20  ing overwritten 
-0000dea0: 7468 6973 2069 7320 6e6f 7420 616c 6c6f  this is not allo
-0000deb0: 7765 6422 290a 2020 2020 2020 2020 656e  wed").        en
-0000dec0: 765b 762e 6e61 6d65 5d20 3d20 7661 6c0a  v[v.name] = val.
-0000ded0: 0a20 2020 2073 6166 655f 6d61 705f 666c  .    safe_map_fl
-0000dee0: 6174 2877 7269 7465 2c20 6c69 7374 2874  at(write, list(t
-0000def0: 7261 6365 2e61 7267 7329 2c20 6c69 7374  race.args), list
-0000df00: 2861 7267 7329 290a 2020 2020 7361 6665  (args)).    safe
-0000df10: 5f6d 6170 5f66 6c61 7428 7772 6974 652c  _map_flat(write,
-0000df20: 206c 6973 7428 7472 6163 652e 6b77 6172   list(trace.kwar
-0000df30: 6773 2e76 616c 7565 7328 2929 2c20 6c69  gs.values()), li
-0000df40: 7374 286b 7761 7267 732e 7661 6c75 6573  st(kwargs.values
-0000df50: 2829 2929 0a0a 2020 2020 666f 7220 7379  ()))..    for sy
-0000df60: 6d62 6f6c 2069 6e20 7472 6163 652e 626f  mbol in trace.bo
-0000df70: 756e 645f 7379 6d62 6f6c 733a 0a20 2020  und_symbols:.   
-0000df80: 2020 2020 2069 6620 7379 6d62 6f6c 2e73       if symbol.s
-0000df90: 796d 2e69 6420 696e 2074 7261 6e73 666f  ym.id in transfo
-0000dfa0: 726d 5f73 6b69 705f 6c69 7374 3a0a 2020  rm_skip_list:.  
-0000dfb0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0000dfc0: 7565 0a20 2020 2020 2020 2061 7267 7320  ue.        args 
-0000dfd0: 3d20 7472 6565 5f6d 6170 2872 6561 642c  = tree_map(read,
-0000dfe0: 2073 796d 626f 6c2e 6172 6773 290a 2020   symbol.args).  
-0000dff0: 2020 2020 2020 6b77 6172 6773 203d 2074        kwargs = t
-0000e000: 7265 655f 6d61 7028 7265 6164 2c20 7379  ree_map(read, sy
-0000e010: 6d62 6f6c 2e6b 7761 7267 7329 0a20 2020  mbol.kwargs).   
-0000e020: 2020 2020 2070 7269 6d5f 6675 6e63 203d       prim_func =
-0000e030: 2073 796d 626f 6c5f 6d61 7070 6572 2873   symbol_mapper(s
-0000e040: 796d 626f 6c29 0a20 2020 2020 2020 2069  ymbol).        i
-0000e050: 6620 7072 696d 5f66 756e 6320 6973 204e  f prim_func is N
-0000e060: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000e070: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0000e080: 2020 7265 7375 6c74 203d 2070 7269 6d5f    result = prim_
-0000e090: 6675 6e63 282a 6172 6773 2c20 2a2a 6b77  func(*args, **kw
-0000e0a0: 6172 6773 290a 2020 2020 2020 2020 7361  args).        sa
-0000e0b0: 6665 5f6d 6170 5f66 6c61 7428 7772 6974  fe_map_flat(writ
-0000e0c0: 652c 206c 6973 7428 7365 7175 656e 6369  e, list(sequenci
-0000e0d0: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
-0000e0e0: 2929 2c20 6c69 7374 2873 6571 7565 6e63  )), list(sequenc
-0000e0f0: 6966 7928 7265 7375 6c74 2929 290a 0a20  ify(result))).. 
-0000e100: 2020 2069 6620 7769 7468 5f65 6e76 3a0a     if with_env:.
-0000e110: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0000e120: 7265 655f 6d61 7028 7265 6164 2c20 7472  ree_map(read, tr
-0000e130: 6163 652e 6f75 7470 7574 292c 2065 6e76  ace.output), env
-0000e140: 0a0a 2020 2020 7265 7475 726e 2074 7265  ..    return tre
-0000e150: 655f 6d61 7028 7265 6164 2c20 7472 6163  e_map(read, trac
-0000e160: 652e 6f75 7470 7574 290a 0a0a 6465 6620  e.output)...def 
-0000e170: 5f69 6465 6e74 6974 795f 6361 6c6c 5f6d  _identity_call_m
-0000e180: 6574 6166 756e 6328 2a61 7267 732c 2074  etafunc(*args, t
-0000e190: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
-0000e1a0: 7761 7267 7329 3a0a 2020 2020 7769 7468  wargs):.    with
-0000e1b0: 2064 6574 6163 6865 645f 7472 6163 6528   detached_trace(
-0000e1c0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000e1d0: 6e20 6576 616c 5f74 7261 6365 2874 7261  n eval_trace(tra
-0000e1e0: 6365 2c20 2a61 7267 732c 202a 2a6b 7761  ce, *args, **kwa
-0000e1f0: 7267 7329 0a0a 0a69 6465 6e74 6974 795f  rgs)...identity_
-0000e200: 6361 6c6c 203d 2053 796d 626f 6c28 6964  call = Symbol(id
-0000e210: 3d54 7261 6e73 666f 726d 732e 4964 656e  =Transforms.Iden
-0000e220: 7469 7479 4f70 2c20 6e61 6d65 3d22 6964  tityOp, name="id
-0000e230: 656e 7469 7479 5f63 616c 6c22 2c20 6d65  entity_call", me
-0000e240: 7461 3d5f 6964 656e 7469 7479 5f63 616c  ta=_identity_cal
-0000e250: 6c5f 6d65 7461 6675 6e63 290a 0a0a 6465  l_metafunc)...de
-0000e260: 6620 6964 656e 7469 7479 2866 756e 6329  f identity(func)
-0000e270: 3a0a 2020 2020 2222 2249 6465 6e74 6974  :.    """Identit
-0000e280: 7920 7472 616e 7366 6f72 6d20 666f 7220  y transform for 
-0000e290: 6120 5468 756e 6465 7220 6675 6e63 7469  a Thunder functi
-0000e2a0: 6f6e 2e0a 0a20 2020 2041 7267 733a 0a20  on...    Args:. 
-0000e2b0: 2020 2020 2020 2066 756e 6320 2843 616c         func (Cal
-0000e2c0: 6c61 626c 6529 3a20 4120 5468 756e 6465  lable): A Thunde
-0000e2d0: 7220 6675 6e63 7469 6f6e 2074 6f20 6265  r function to be
-0000e2e0: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
-0000e2f0: 2020 2222 220a 0a20 2020 2064 6566 2077    """..    def w
-0000e300: 7261 7070 6572 282a 6172 6773 2c20 2a2a  rapper(*args, **
-0000e310: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000e320: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
-0000e330: 6374 5f74 7261 6365 2829 2866 756e 632c  ct_trace()(func,
-0000e340: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-0000e350: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000e360: 2069 6465 6e74 6974 795f 6361 6c6c 282a   identity_call(*
-0000e370: 6172 6773 2c20 2a2a 6b77 6172 6773 2c20  args, **kwargs, 
-0000e380: 7472 6163 653d 7472 6163 6529 0a0a 2020  trace=trace)..  
-0000e390: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
-0000e3a0: 0a0a 0a64 6566 205f 6964 656e 7469 7479  ...def _identity
-0000e3b0: 5f63 616c 6c5f 7079 746f 7263 6828 2a61  _call_pytorch(*a
-0000e3c0: 7267 732c 2074 7261 6365 3a20 5472 6163  rgs, trace: Trac
-0000e3d0: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
-0000e3e0: 2020 696d 706f 7274 2074 6f72 6368 0a0a    import torch..
-0000e3f0: 2020 2020 6465 6620 7379 6d62 6f6c 5f6d      def symbol_m
-0000e400: 6170 7065 7228 6f70 293a 0a20 2020 2020  apper(op):.     
-0000e410: 2020 2069 6620 6f70 2e6f 7020 3d3d 2054     if op.op == T
-0000e420: 7261 6e73 666f 726d 732e 4964 656e 7469  ransforms.Identi
-0000e430: 7479 4f70 3a0a 2020 2020 2020 2020 2020  tyOp:.          
-0000e440: 2020 7265 7475 726e 205f 6964 656e 7469    return _identi
-0000e450: 7479 5f63 616c 6c5f 7079 746f 7263 680a  ty_call_pytorch.
-0000e460: 0a20 2020 2020 2020 2074 6f72 6368 5f6f  .        torch_o
-0000e470: 7020 3d20 6f70 735f 746f 5f74 6f72 6368  p = ops_to_torch
-0000e480: 5f6f 7073 5f6d 6170 5b6f 702e 6f70 5d0a  _ops_map[op.op].
-0000e490: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000e4a0: 7461 6e63 6528 746f 7263 685f 6f70 2c20  tance(torch_op, 
-0000e4b0: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
-0000e4c0: 2020 7265 7475 726e 2067 6574 6174 7472    return getattr
-0000e4d0: 2874 6f72 6368 2c20 746f 7263 685f 6f70  (torch, torch_op
-0000e4e0: 2e73 7472 6970 2822 7079 746f 7263 682e  .strip("pytorch.
-0000e4f0: 2229 290a 2020 2020 2020 2020 7265 7475  ")).        retu
-0000e500: 726e 2074 6f72 6368 5f6f 700a 0a20 2020  rn torch_op..   
-0000e510: 2077 6974 6820 6465 7461 6368 6564 5f74   with detached_t
-0000e520: 7261 6365 2829 3a0a 2020 2020 2020 2020  race():.        
-0000e530: 7265 7475 726e 2065 7661 6c5f 7472 6163  return eval_trac
-0000e540: 6528 7472 6163 652c 202a 6172 6773 2c20  e(trace, *args, 
-0000e550: 2a2a 6b77 6172 6773 2c20 7379 6d62 6f6c  **kwargs, symbol
-0000e560: 5f6d 6170 7065 723d 7379 6d62 6f6c 5f6d  _mapper=symbol_m
-0000e570: 6170 7065 7229 0a0a 0a23 2052 6567 6973  apper)...# Regis
-0000e580: 7465 7220 7468 6520 6964 656e 7469 7479  ter the identity
-0000e590: 2063 616c 6c20 666f 7220 5079 546f 7263   call for PyTorc
-0000e5a0: 6820 6578 6563 7574 6f72 2e0a 2320 6f70  h executor..# op
-0000e5b0: 735f 746f 5f74 6f72 6368 5f6f 7073 5f6d  s_to_torch_ops_m
-0000e5c0: 6170 5b54 7261 6e73 666f 726d 732e 4964  ap[Transforms.Id
-0000e5d0: 656e 7469 7479 4f70 5d20 3d20 5f69 6465  entityOp] = _ide
-0000e5e0: 6e74 6974 795f 6361 6c6c 5f70 7974 6f72  ntity_call_pytor
-0000e5f0: 6368 0a0a 0a23 2056 4d41 5020 7472 616e  ch...# VMAP tran
-0000e600: 7366 6f72 6d0a 2320 2d2d 2d2d 2d2d 2d2d  sform.# --------
-0000e610: 2d2d 2d2d 2d0a 0a0a 636c 6173 7320 4e6f  -----...class No
-0000e620: 744d 6170 7065 643a 0a20 2020 2022 2222  tMapped:.    """
-0000e630: 5265 7072 6573 656e 7473 2061 206e 6f6e  Represents a non
-0000e640: 2d62 6174 6368 6564 2064 696d 656e 7369  -batched dimensi
-0000e650: 6f6e 2e22 2222 0a0a 2020 2020 6465 6620  on."""..    def 
-0000e660: 5f5f 7265 7072 5f5f 2873 656c 6629 3a0a  __repr__(self):.
-0000e670: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-0000e680: 6e6f 745f 6d61 7070 6564 220a 0a0a 4064  not_mapped"...@d
-0000e690: 6174 6163 6c61 7373 2866 726f 7a65 6e3d  ataclass(frozen=
-0000e6a0: 5472 7565 290a 636c 6173 7320 4261 7463  True).class Batc
-0000e6b0: 6865 6456 616c 7565 3a0a 2020 2020 2222  hedValue:.    ""
-0000e6c0: 2242 6174 6368 6564 2076 616c 7565 2066  "Batched value f
-0000e6d0: 6f72 2074 6865 2076 6d61 7020 7472 616e  or the vmap tran
-0000e6e0: 7366 6f72 6d2e 0a0a 2020 2020 4174 7472  sform...    Attr
-0000e6f0: 6962 7574 6573 3a0a 2020 2020 2020 2020  ibutes:.        
-0000e700: 7661 6c75 653a 2042 6174 6368 6564 2076  value: Batched v
-0000e710: 616c 7565 2e0a 2020 2020 2020 2020 6261  alue..        ba
-0000e720: 7463 685f 6469 6d3a 2042 6174 6368 696e  tch_dim: Batchin
-0000e730: 6720 6469 6d65 6e73 696f 6e20 6f72 206e  g dimension or n
-0000e740: 6f74 5f6d 6170 7065 640a 2020 2020 2222  ot_mapped.    ""
-0000e750: 220a 0a20 2020 2076 616c 7565 3a20 416e  "..    value: An
-0000e760: 790a 2020 2020 6261 7463 685f 6469 6d3a  y.    batch_dim:
-0000e770: 2069 6e74 207c 204e 6f74 4d61 7070 6564   int | NotMapped
-0000e780: 0a0a 2020 2020 6465 6620 5f5f 6974 6572  ..    def __iter
-0000e790: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-0000e7a0: 2020 7969 656c 6420 7365 6c66 2e76 616c    yield self.val
-0000e7b0: 7565 0a20 2020 2020 2020 2079 6965 6c64  ue.        yield
-0000e7c0: 2073 656c 662e 6261 7463 685f 6469 6d0a   self.batch_dim.
-0000e7d0: 0a0a 6465 6620 7061 6972 5f74 6f5f 6261  ..def pair_to_ba
-0000e7e0: 7463 6865 645f 7661 6c75 6528 7061 6972  tched_value(pair
-0000e7f0: 293a 0a20 2020 2022 2222 436f 6e76 6572  ):.    """Conver
-0000e800: 7473 2061 2070 6169 7220 746f 2061 2042  ts a pair to a B
-0000e810: 6174 6368 6564 5661 6c75 652e 0a0a 2020  atchedValue...  
-0000e820: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000e830: 7061 6972 2028 5365 7175 656e 6365 293a  pair (Sequence):
-0000e840: 2050 6169 7220 746f 2063 6f6e 7665 7274   Pair to convert
-0000e850: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0000e860: 2020 2020 2020 2020 4261 7463 6865 6456          BatchedV
-0000e870: 616c 7565 3a20 4261 7463 6865 6456 616c  alue: BatchedVal
-0000e880: 7565 2072 6570 7265 7365 6e74 6174 696f  ue representatio
-0000e890: 6e20 6f66 2074 6865 2070 6169 722e 0a20  n of the pair.. 
-0000e8a0: 2020 2022 2222 0a20 2020 2069 6620 6973     """.    if is
-0000e8b0: 696e 7374 616e 6365 2870 6169 722c 2042  instance(pair, B
-0000e8c0: 6174 6368 6564 5661 6c75 6529 3a0a 2020  atchedValue):.  
-0000e8d0: 2020 2020 2020 7265 7475 726e 2070 6169        return pai
-0000e8e0: 720a 2020 2020 656c 7365 3a0a 2020 2020  r.    else:.    
-0000e8f0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000e900: 7461 6e63 6528 7061 6972 2c20 5365 7175  tance(pair, Sequ
-0000e910: 656e 6365 2920 616e 6420 6c65 6e28 7061  ence) and len(pa
-0000e920: 6972 2920 3d3d 2032 0a20 2020 2020 2020  ir) == 2.       
-0000e930: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-0000e940: 616c 7565 282a 7061 6972 290a 0a0a 6465  alue(*pair)...de
-0000e950: 6620 7665 6374 6f72 697a 6564 5f62 6174  f vectorized_bat
-0000e960: 6368 6572 2870 7269 6d2c 2061 7869 735f  cher(prim, axis_
-0000e970: 7369 7a65 2c20 6261 7463 6865 645f 7661  size, batched_va
-0000e980: 6c75 6573 2c20 2a2a 6b77 6172 6773 293a  lues, **kwargs):
-0000e990: 0a20 2020 2062 6174 6368 5f64 696d 203d  .    batch_dim =
-0000e9a0: 2062 6174 6368 6564 5f76 616c 7565 735b   batched_values[
-0000e9b0: 305d 2e62 6174 6368 5f64 696d 0a20 2020  0].batch_dim.   
-0000e9c0: 2061 7373 6572 7420 616c 6c28 0a20 2020   assert all(.   
-0000e9d0: 2020 2020 2062 6174 6368 5f64 696d 203d       batch_dim =
-0000e9e0: 3d20 6276 2e62 6174 6368 5f64 696d 2066  = bv.batch_dim f
-0000e9f0: 6f72 2062 7620 696e 2062 6174 6368 6564  or bv in batched
-0000ea00: 5f76 616c 7565 735b 313a 5d0a 2020 2020  _values[1:].    
-0000ea10: 292c 2066 2260 7665 6374 6f72 697a 6564  ), f"`vectorized
-0000ea20: 5f62 6174 6368 6572 6020 676f 7420 6469  _batcher` got di
-0000ea30: 6666 6572 656e 7420 6261 7463 6865 6420  fferent batched 
-0000ea40: 6469 6d65 6e73 696f 6e73 207b 5b62 762e  dimensions {[bv.
-0000ea50: 6261 7463 685f 6469 6d20 666f 7220 6276  batch_dim for bv
-0000ea60: 2069 6e20 6261 7463 6865 645f 7661 6c75   in batched_valu
-0000ea70: 6573 5d7d 220a 2020 2020 7265 7475 726e  es]}".    return
-0000ea80: 2042 6174 6368 6564 5661 6c75 6528 7072   BatchedValue(pr
-0000ea90: 696d 282a 5b62 762e 7661 6c75 6520 666f  im(*[bv.value fo
-0000eaa0: 7220 6276 2069 6e20 6261 7463 6865 645f  r bv in batched_
-0000eab0: 7661 6c75 6573 5d2c 202a 2a6b 7761 7267  values], **kwarg
-0000eac0: 7329 2c20 6261 7463 685f 6469 6d29 0a0a  s), batch_dim)..
-0000ead0: 0a6e 6f74 5f6d 6170 7065 6420 3d20 4e6f  .not_mapped = No
-0000eae0: 744d 6170 7065 6428 290a 0a0a 6465 6620  tMapped()...def 
-0000eaf0: 6d6f 7665 6469 6d28 782c 2073 7263 3a20  movedim(x, src: 
-0000eb00: 696e 742c 2064 7374 3a20 696e 7429 3a0a  int, dst: int):.
-0000eb10: 2020 2020 7065 726d 203d 205b 6920 666f      perm = [i fo
-0000eb20: 7220 6920 696e 2072 616e 6765 2878 2e6e  r i in range(x.n
-0000eb30: 6469 6d29 2069 6620 6920 213d 2073 7263  dim) if i != src
-0000eb40: 5d0a 2020 2020 7065 726d 2e69 6e73 6572  ].    perm.inser
-0000eb50: 7428 6473 742c 2073 7263 290a 2020 2020  t(dst, src).    
-0000eb60: 7265 7475 726e 2070 7269 6d73 2e74 7261  return prims.tra
-0000eb70: 6e73 706f 7365 2878 2c20 7475 706c 6528  nspose(x, tuple(
-0000eb80: 7065 726d 2929 0a0a 0a64 6566 206d 6f76  perm))...def mov
-0000eb90: 655f 6261 7463 685f 6469 6d28 6178 6973  e_batch_dim(axis
-0000eba0: 5f73 697a 652c 2073 7263 2c20 6473 742c  _size, src, dst,
-0000ebb0: 2078 293a 0a20 2020 2069 6620 7372 6320   x):.    if src 
-0000ebc0: 6973 206e 6f74 5f6d 6170 7065 643a 0a20  is not_mapped:. 
-0000ebd0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000ebe0: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
-0000ebf0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000ec00: 7572 6e20 780a 2020 2020 2020 2020 7461  urn x.        ta
-0000ec10: 7267 6574 5f73 6861 7065 203d 206c 6973  rget_shape = lis
-0000ec20: 7428 782e 7368 6170 6529 0a20 2020 2020  t(x.shape).     
-0000ec30: 2020 2074 6172 6765 745f 7368 6170 652e     target_shape.
-0000ec40: 696e 7365 7274 2864 7374 2c20 6178 6973  insert(dst, axis
-0000ec50: 5f73 697a 6529 0a20 2020 2020 2020 2062  _size).        b
-0000ec60: 6361 7374 5f64 696d 7320 3d20 6c69 7374  cast_dims = list
-0000ec70: 2872 616e 6765 286c 656e 2874 6172 6765  (range(len(targe
-0000ec80: 745f 7368 6170 6529 2929 0a20 2020 2020  t_shape))).     
-0000ec90: 2020 2062 6361 7374 5f64 696d 732e 706f     bcast_dims.po
-0000eca0: 7028 6473 7429 0a20 2020 2020 2020 2072  p(dst).        r
-0000ecb0: 6574 7572 6e20 7072 696d 732e 6272 6f61  eturn prims.broa
-0000ecc0: 6463 6173 745f 696e 5f64 696d 2878 2c20  dcast_in_dim(x, 
-0000ecd0: 7461 7267 6574 5f73 6861 7065 2c20 6263  target_shape, bc
-0000ece0: 6173 745f 6469 6d73 290a 2020 2020 656c  ast_dims).    el
-0000ecf0: 6966 2073 7263 203d 3d20 6473 743a 0a20  if src == dst:. 
-0000ed00: 2020 2020 2020 2072 6574 7572 6e20 780a         return x.
-0000ed10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ed20: 2020 7265 7475 726e 206d 6f76 6564 696d    return movedim
-0000ed30: 2878 2c20 7372 632c 2064 7374 290a 0a0a  (x, src, dst)...
-0000ed40: 6465 6620 6269 6e61 7279 5f6f 705f 6261  def binary_op_ba
-0000ed50: 7463 6869 6e67 5f72 756c 6528 6f70 3a20  tching_rule(op: 
-0000ed60: 7072 696d 732e 5072 696d 4944 732c 2061  prims.PrimIDs, a
-0000ed70: 7869 735f 7369 7a65 3a20 696e 742c 2076  xis_size: int, v
-0000ed80: 616c 735f 696e 3a20 4261 7463 6865 6456  als_in: BatchedV
-0000ed90: 616c 7565 293a 0a20 2020 2028 2878 2c20  alue):.    ((x, 
-0000eda0: 785f 6264 696d 292c 2028 792c 2079 5f62  x_bdim), (y, y_b
-0000edb0: 6469 6d29 2920 3d20 7661 6c73 5f69 6e0a  dim)) = vals_in.
-0000edc0: 2020 2020 6966 2078 5f62 6469 6d20 213d      if x_bdim !=
-0000edd0: 2079 5f62 6469 6d3a 0a20 2020 2020 2020   y_bdim:.       
-0000ede0: 2069 6620 785f 6264 696d 2069 7320 6e6f   if x_bdim is no
-0000edf0: 745f 6d61 7070 6564 3a0a 2020 2020 2020  t_mapped:.      
-0000ee00: 2020 2020 2020 7820 3d20 6d6f 7665 5f62        x = move_b
-0000ee10: 6174 6368 5f64 696d 2861 7869 735f 7369  atch_dim(axis_si
-0000ee20: 7a65 2c20 785f 6264 696d 2c20 795f 6264  ze, x_bdim, y_bd
-0000ee30: 696d 2c20 7829 0a20 2020 2020 2020 2020  im, x).         
-0000ee40: 2020 2078 5f62 6469 6d20 3d20 795f 6264     x_bdim = y_bd
-0000ee50: 696d 0a20 2020 2020 2020 2065 6c73 653a  im.        else:
-0000ee60: 0a20 2020 2020 2020 2020 2020 2079 203d  .            y =
-0000ee70: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
-0000ee80: 6178 6973 5f73 697a 652c 2079 5f62 6469  axis_size, y_bdi
-0000ee90: 6d2c 2078 5f62 6469 6d2c 2079 290a 2020  m, x_bdim, y).  
-0000eea0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000eeb0: 5661 6c75 6528 6f70 2878 2c20 7929 2c20  Value(op(x, y), 
-0000eec0: 785f 6264 696d 290a 0a0a 6465 6620 7369  x_bdim)...def si
-0000eed0: 6e5f 766d 6170 2861 7869 735f 7369 7a65  n_vmap(axis_size
-0000eee0: 3a20 696e 742c 2061 3a20 4261 7463 6865  : int, a: Batche
-0000eef0: 6456 616c 7565 2920 2d3e 2042 6174 6368  dValue) -> Batch
-0000ef00: 6564 5661 6c75 653a 0a20 2020 2072 6574  edValue:.    ret
-0000ef10: 7572 6e20 7665 6374 6f72 697a 6564 5f62  urn vectorized_b
-0000ef20: 6174 6368 6572 2870 7269 6d73 2e73 696e  atcher(prims.sin
-0000ef30: 2c20 6178 6973 5f73 697a 652c 2028 612c  , axis_size, (a,
-0000ef40: 2929 0a0a 0a64 6566 2063 6f73 5f76 6d61  ))...def cos_vma
-0000ef50: 7028 6178 6973 5f73 697a 653a 2069 6e74  p(axis_size: int
-0000ef60: 2c20 613a 2042 6174 6368 6564 5661 6c75  , a: BatchedValu
-0000ef70: 6529 202d 3e20 4261 7463 6865 6456 616c  e) -> BatchedVal
-0000ef80: 7565 3a0a 2020 2020 7265 7475 726e 2076  ue:.    return v
-0000ef90: 6563 746f 7269 7a65 645f 6261 7463 6865  ectorized_batche
-0000efa0: 7228 7072 696d 732e 636f 732c 2061 7869  r(prims.cos, axi
-0000efb0: 735f 7369 7a65 2c20 2861 2c29 290a 0a0a  s_size, (a,))...
-0000efc0: 6465 6620 6d75 6c5f 766d 6170 2861 7869  def mul_vmap(axi
-0000efd0: 735f 7369 7a65 3a20 696e 742c 2061 3a20  s_size: int, a: 
-0000efe0: 4261 7463 6865 6456 616c 7565 2c20 623a  BatchedValue, b:
-0000eff0: 2042 6174 6368 6564 5661 6c75 6529 202d   BatchedValue) -
-0000f000: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
-0000f010: 2020 2020 7265 7475 726e 2062 696e 6172      return binar
-0000f020: 795f 6f70 5f62 6174 6368 696e 675f 7275  y_op_batching_ru
-0000f030: 6c65 2870 7269 6d73 2e6d 756c 2c20 6178  le(prims.mul, ax
-0000f040: 6973 5f73 697a 652c 2028 612c 2062 2929  is_size, (a, b))
-0000f050: 0a0a 0a64 6566 2061 6464 5f76 6d61 7028  ...def add_vmap(
-0000f060: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
-0000f070: 613a 2042 6174 6368 6564 5661 6c75 652c  a: BatchedValue,
-0000f080: 2062 3a20 4261 7463 6865 6456 616c 7565   b: BatchedValue
-0000f090: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
-0000f0a0: 653a 0a20 2020 2072 6574 7572 6e20 6269  e:.    return bi
-0000f0b0: 6e61 7279 5f6f 705f 6261 7463 6869 6e67  nary_op_batching
-0000f0c0: 5f72 756c 6528 7072 696d 732e 6164 642c  _rule(prims.add,
-0000f0d0: 2061 7869 735f 7369 7a65 2c20 2861 2c20   axis_size, (a, 
-0000f0e0: 6229 290a 0a0a 6465 6620 7375 6d5f 766d  b))...def sum_vm
-0000f0f0: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
-0000f100: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
-0000f110: 7565 2c20 6469 6d73 3a20 5365 7175 656e  ue, dims: Sequen
-0000f120: 6365 5b69 6e74 5d2c 202a 2a6b 7761 7267  ce[int], **kwarg
-0000f130: 7329 202d 3e20 4261 7463 6865 6456 616c  s) -> BatchedVal
-0000f140: 7565 3a0a 2020 2020 6264 696d 203d 2061  ue:.    bdim = a
-0000f150: 2e62 6174 6368 5f64 696d 0a20 2020 2023  .batch_dim.    #
-0000f160: 2054 4f44 4f3a 2072 656d 6f76 6520 7468   TODO: remove th
-0000f170: 6973 2077 6865 6e20 6469 6d73 2062 6563  is when dims bec
-0000f180: 6f6d 6573 2061 206d 616e 6461 746f 7279  omes a mandatory
-0000f190: 206b 7761 7267 0a20 2020 2069 6620 6c65   kwarg.    if le
-0000f1a0: 6e28 6469 6d73 2920 3e20 303a 0a20 2020  n(dims) > 0:.   
-0000f1b0: 2020 2020 2064 696d 732c 205f 203d 2073       dims, _ = s
-0000f1c0: 6166 655f 7a69 7028 2a64 696d 7329 0a20  afe_zip(*dims). 
-0000f1d0: 2020 2064 696d 735f 6265 666f 7265 203d     dims_before =
-0000f1e0: 2074 7570 6c65 2865 6c20 666f 7220 656c   tuple(el for el
-0000f1f0: 2069 6e20 6469 6d73 2069 6620 656c 203c   in dims if el <
-0000f200: 2062 6469 6d29 0a20 2020 2064 696d 735f   bdim).    dims_
-0000f210: 6166 7465 7220 3d20 7475 706c 6528 656c  after = tuple(el
-0000f220: 202b 2031 2066 6f72 2065 6c20 696e 2064   + 1 for el in d
-0000f230: 696d 7320 6966 2065 6c20 3e3d 2062 6469  ims if el >= bdi
-0000f240: 6d29 0a20 2020 2062 6174 6368 6564 5f64  m).    batched_d
-0000f250: 696d 7320 3d20 6469 6d73 5f62 6566 6f72  ims = dims_befor
-0000f260: 6520 2b20 6469 6d73 5f61 6674 6572 0a20  e + dims_after. 
-0000f270: 2020 2072 6574 7572 6e20 7665 6374 6f72     return vector
-0000f280: 697a 6564 5f62 6174 6368 6572 2870 7269  ized_batcher(pri
-0000f290: 6d73 2e73 756d 2c20 6178 6973 5f73 697a  ms.sum, axis_siz
-0000f2a0: 652c 2028 612c 292c 2064 696d 733d 6261  e, (a,), dims=ba
-0000f2b0: 7463 6865 645f 6469 6d73 2c20 2a2a 6b77  tched_dims, **kw
-0000f2c0: 6172 6773 290a 0a0a 2320 544f 444f 3a20  args)...# TODO: 
-0000f2d0: 506c 6561 7365 2074 6573 7420 7468 6973  Please test this
-0000f2e0: 2065 7874 656e 7369 7665 6c79 0a64 6566   extensively.def
-0000f2f0: 2062 726f 6164 6361 7374 5f69 6e5f 6469   broadcast_in_di
-0000f300: 6d5f 766d 6170 280a 2020 2020 6178 6973  m_vmap(.    axis
-0000f310: 5f73 697a 653a 2069 6e74 2c20 613a 2042  _size: int, a: B
-0000f320: 6174 6368 6564 5661 6c75 652c 2073 6861  atchedValue, sha
-0000f330: 7065 3a20 5365 7175 656e 6365 5b42 6174  pe: Sequence[Bat
-0000f340: 6368 6564 5661 6c75 655d 2c20 6272 6f61  chedValue], broa
-0000f350: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000f360: 3a20 5365 7175 656e 6365 5b42 6174 6368  : Sequence[Batch
-0000f370: 6564 5661 6c75 655d 0a29 202d 3e20 4261  edValue].) -> Ba
-0000f380: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000f390: 6264 696d 203d 2061 2e62 6174 6368 5f64  bdim = a.batch_d
-0000f3a0: 696d 0a20 2020 2023 2054 4f44 4f3a 2072  im.    # TODO: r
-0000f3b0: 656d 6f76 6520 7468 6973 2077 6865 6e20  emove this when 
-0000f3c0: 7368 6170 6520 616e 6420 6272 6f61 6463  shape and broadc
-0000f3d0: 6173 745f 6469 6d65 6e73 696f 6e73 2062  ast_dimensions b
-0000f3e0: 6563 6f6d 6520 6d61 6e64 6174 6f72 7920  ecome mandatory 
-0000f3f0: 6b77 6172 6773 0a20 2020 2073 6861 7065  kwargs.    shape
-0000f400: 2c20 5f20 3d20 7361 6665 5f7a 6970 282a  , _ = safe_zip(*
-0000f410: 7368 6170 6529 0a20 2020 2069 6620 6c65  shape).    if le
-0000f420: 6e28 6272 6f61 6463 6173 745f 6469 6d65  n(broadcast_dime
-0000f430: 6e73 696f 6e73 2920 3e20 303a 0a20 2020  nsions) > 0:.   
-0000f440: 2020 2020 2062 726f 6164 6361 7374 5f64       broadcast_d
-0000f450: 696d 656e 7369 6f6e 732c 205f 203d 2073  imensions, _ = s
-0000f460: 6166 655f 7a69 7028 2a62 726f 6164 6361  afe_zip(*broadca
-0000f470: 7374 5f64 696d 656e 7369 6f6e 7329 0a20  st_dimensions). 
-0000f480: 2020 2069 6620 6264 696d 2069 7320 6e6f     if bdim is no
-0000f490: 745f 6d61 7070 6564 3a0a 2020 2020 2020  t_mapped:.      
-0000f4a0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000f4b0: 5661 6c75 6528 7072 696d 732e 6272 6f61  Value(prims.broa
-0000f4c0: 6463 6173 745f 696e 5f64 696d 2861 2e76  dcast_in_dim(a.v
-0000f4d0: 616c 7565 2c20 7368 6170 652c 2062 726f  alue, shape, bro
-0000f4e0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000f4f0: 7329 2c20 6264 696d 290a 2020 2020 656c  s), bdim).    el
-0000f500: 7365 3a0a 2020 2020 2020 2020 6e65 775f  se:.        new_
-0000f510: 6264 696d 203d 2062 6469 6d20 2b20 7375  bdim = bdim + su
-0000f520: 6d28 3120 666f 7220 6469 6d20 696e 2062  m(1 for dim in b
-0000f530: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000f540: 6f6e 7320 6966 2064 696d 203c 2062 6469  ons if dim < bdi
-0000f550: 6d29 0a20 2020 2020 2020 206e 6577 5f73  m).        new_s
-0000f560: 6861 7065 203d 206c 6973 7428 7368 6170  hape = list(shap
-0000f570: 6529 0a20 2020 2020 2020 206e 6577 5f73  e).        new_s
-0000f580: 6861 7065 2e69 6e73 6572 7428 6e65 775f  hape.insert(new_
-0000f590: 6264 696d 2c20 6178 6973 5f73 697a 6529  bdim, axis_size)
-0000f5a0: 0a20 2020 2020 2020 206e 6577 5f62 726f  .        new_bro
-0000f5b0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000f5c0: 7320 3d20 2830 2c29 202b 2074 7570 6c65  s = (0,) + tuple
-0000f5d0: 2864 696d 202b 2031 2069 6620 6469 6d20  (dim + 1 if dim 
-0000f5e0: 3e3d 2062 6469 6d20 656c 7365 2064 696d  >= bdim else dim
-0000f5f0: 2066 6f72 2064 696d 2069 6e20 6272 6f61   for dim in broa
-0000f600: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000f610: 290a 2020 2020 2020 2020 6966 2062 726f  ).        if bro
-0000f620: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000f630: 7320 3d3d 2028 293a 0a20 2020 2020 2020  s == ():.       
-0000f640: 2020 2020 206e 6577 5f62 726f 6164 6361       new_broadca
-0000f650: 7374 5f64 696d 656e 7369 6f6e 7320 3d20  st_dimensions = 
-0000f660: 2829 0a20 2020 2020 2020 2072 6574 7572  ().        retur
-0000f670: 6e20 4261 7463 6865 6456 616c 7565 2870  n BatchedValue(p
-0000f680: 7269 6d73 2e62 726f 6164 6361 7374 5f69  rims.broadcast_i
-0000f690: 6e5f 6469 6d28 612e 7661 6c75 652c 206e  n_dim(a.value, n
-0000f6a0: 6577 5f73 6861 7065 2c20 6e65 775f 6272  ew_shape, new_br
-0000f6b0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000f6c0: 6e73 292c 206e 6577 5f62 6469 6d29 0a0a  ns), new_bdim)..
-0000f6d0: 0a76 6d61 705f 696d 706c 733a 2064 6963  .vmap_impls: dic
-0000f6e0: 745b 7072 696d 732e 5379 6d62 6f6c 2c20  t[prims.Symbol, 
-0000f6f0: 4361 6c6c 6162 6c65 5d20 3d20 6469 6374  Callable] = dict
-0000f700: 2829 0a0a 0a64 6566 2075 6e77 7261 705f  ()...def unwrap_
-0000f710: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
-0000f720: 7379 6d62 6f6c 7328 7472 6163 6529 3a0a  symbols(trace):.
-0000f730: 2020 2020 6e65 775f 7379 6d62 6f6c 735f      new_symbols_
-0000f740: 6974 6572 203d 2028 0a20 2020 2020 2020  iter = (.       
-0000f750: 2062 6f75 6e64 5f73 796d 626f 6c2e 7375   bound_symbol.su
-0000f760: 6273 796d 626f 6c73 2069 6620 6c65 6e28  bsymbols if len(
-0000f770: 626f 756e 645f 7379 6d62 6f6c 2e73 7562  bound_symbol.sub
-0000f780: 7379 6d62 6f6c 7329 203e 2030 2065 6c73  symbols) > 0 els
-0000f790: 6520 5b62 6f75 6e64 5f73 796d 626f 6c5d  e [bound_symbol]
-0000f7a0: 0a20 2020 2020 2020 2066 6f72 2062 6f75  .        for bou
-0000f7b0: 6e64 5f73 796d 626f 6c20 696e 2074 7261  nd_symbol in tra
-0000f7c0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-0000f7d0: 0a20 2020 2029 0a20 2020 206e 6577 5f73  .    ).    new_s
-0000f7e0: 796d 626f 6c73 203d 206c 6973 7428 6368  ymbols = list(ch
-0000f7f0: 6169 6e2e 6672 6f6d 5f69 7465 7261 626c  ain.from_iterabl
-0000f800: 6528 6e65 775f 7379 6d62 6f6c 735f 6974  e(new_symbols_it
-0000f810: 6572 2929 0a20 2020 2074 7261 6365 2e62  er)).    trace.b
-0000f820: 6f75 6e64 5f73 796d 626f 6c73 203d 206e  ound_symbols = n
-0000f830: 6577 5f73 796d 626f 6c73 0a20 2020 2072  ew_symbols.    r
-0000f840: 6574 7572 6e20 7472 6163 650a 0a0a 6465  eturn trace...de
-0000f850: 6620 6465 636f 6d70 6f73 6564 5f66 6e5f  f decomposed_fn_
-0000f860: 766d 6170 5f72 756c 6528 6178 6973 5f73  vmap_rule(axis_s
-0000f870: 697a 652c 202a 6172 6773 2c20 666e 2c20  ize, *args, fn, 
-0000f880: 2a2a 6b77 6172 6773 293a 0a20 2020 2061  **kwargs):.    a
-0000f890: 7267 732c 2069 6e5f 6469 6d73 203d 2075  rgs, in_dims = u
-0000f8a0: 6e7a 6970 3228 6172 6773 290a 2020 2020  nzip2(args).    
-0000f8b0: 756e 6261 7463 6865 645f 6172 6773 203d  unbatched_args =
-0000f8c0: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0000f8d0: 2078 3a20 7265 6d6f 7665 5f62 6174 6368   x: remove_batch
-0000f8e0: 5f64 696d 2878 2920 6966 2069 7369 6e73  _dim(x) if isins
-0000f8f0: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-0000f900: 726f 7879 2920 656c 7365 2078 2c20 6172  roxy) else x, ar
-0000f910: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
-0000f920: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-0000f930: 2928 666e 2c20 2a75 6e62 6174 6368 6564  )(fn, *unbatched
-0000f940: 5f61 7267 732c 202a 2a6b 7761 7267 7329  _args, **kwargs)
-0000f950: 0a20 2020 2074 7261 6365 203d 2075 6e77  .    trace = unw
-0000f960: 7261 705f 6f6e 655f 6c65 7665 6c5f 6f66  rap_one_level_of
-0000f970: 5f73 7562 7379 6d62 6f6c 7328 7472 6163  _subsymbols(trac
-0000f980: 6529 0a20 2020 206f 7574 7320 3d20 5f76  e).    outs = _v
-0000f990: 6d61 705f 6361 6c6c 5f6d 6574 6166 756e  map_call_metafun
-0000f9a0: 6328 4661 6c73 652c 2061 7267 732c 2069  c(False, args, i
-0000f9b0: 6e5f 6469 6d73 2c20 302c 2061 7869 735f  n_dims, 0, axis_
-0000f9c0: 7369 7a65 2c20 6675 6e63 7469 6f6e 5f74  size, function_t
-0000f9d0: 7261 6365 3d74 7261 6365 2c20 2a2a 6b77  race=trace, **kw
-0000f9e0: 6172 6773 290a 2020 2020 6966 2069 7369  args).    if isi
-0000f9f0: 6e73 7461 6e63 6528 6f75 7473 2c20 5365  nstance(outs, Se
-0000fa00: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-0000fa10: 206f 7574 5f64 696d 7320 3d20 2830 2c29   out_dims = (0,)
-0000fa20: 202a 206c 656e 286f 7574 7329 0a20 2020   * len(outs).   
-0000fa30: 2020 2020 2072 6574 7572 6e20 7361 6665       return safe
-0000fa40: 5f6d 6170 2870 6169 725f 746f 5f62 6174  _map(pair_to_bat
-0000fa50: 6368 6564 5f76 616c 7565 2c20 7361 6665  ched_value, safe
-0000fa60: 5f7a 6970 286f 7574 732c 206f 7574 5f64  _zip(outs, out_d
-0000fa70: 696d 7329 290a 2020 2020 7265 7475 726e  ims)).    return
-0000fa80: 2042 6174 6368 6564 5661 6c75 6528 6f75   BatchedValue(ou
-0000fa90: 7473 2c20 3029 0a0a 0a76 6d61 705f 696d  ts, 0)...vmap_im
-0000faa0: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-0000fab0: 732e 5349 4e5d 203d 2073 696e 5f76 6d61  s.SIN] = sin_vma
-0000fac0: 700a 766d 6170 5f69 6d70 6c73 5b70 7269  p.vmap_impls[pri
-0000fad0: 6d73 2e50 7269 6d49 4473 2e43 4f53 5d20  ms.PrimIDs.COS] 
-0000fae0: 3d20 636f 735f 766d 6170 0a76 6d61 705f  = cos_vmap.vmap_
-0000faf0: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-0000fb00: 4944 732e 4d55 4c5d 203d 206d 756c 5f76  IDs.MUL] = mul_v
-0000fb10: 6d61 700a 766d 6170 5f69 6d70 6c73 5b70  map.vmap_impls[p
-0000fb20: 7269 6d73 2e50 7269 6d49 4473 2e41 4444  rims.PrimIDs.ADD
-0000fb30: 5d20 3d20 6164 645f 766d 6170 0a76 6d61  ] = add_vmap.vma
-0000fb40: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-0000fb50: 696d 4944 732e 5355 4d5d 203d 2073 756d  imIDs.SUM] = sum
-0000fb60: 5f76 6d61 700a 766d 6170 5f69 6d70 6c73  _vmap.vmap_impls
-0000fb70: 5b70 7269 6d73 2e50 7269 6d49 4473 2e42  [prims.PrimIDs.B
-0000fb80: 524f 4144 4341 5354 5f49 4e5f 4449 4d5d  ROADCAST_IN_DIM]
-0000fb90: 203d 2062 726f 6164 6361 7374 5f69 6e5f   = broadcast_in_
-0000fba0: 6469 6d5f 766d 6170 0a0a 0a64 6566 2076  dim_vmap...def v
-0000fbb0: 6d61 705f 7379 6d62 6f6c 5f6d 6170 7065  map_symbol_mappe
-0000fbc0: 7228 7379 6d62 6f6c 3a20 7072 696d 732e  r(symbol: prims.
-0000fbd0: 5379 6d62 6f6c 2c20 2a2c 2061 7869 735f  Symbol, *, axis_
-0000fbe0: 7369 7a65 3a20 696e 7429 3a0a 2020 2020  size: int):.    
-0000fbf0: 2222 224d 6170 7320 6120 7379 6d62 6f6c  """Maps a symbol
-0000fc00: 2074 6f20 6120 766d 6170 2066 756e 6374   to a vmap funct
-0000fc10: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
-0000fc20: 6573 2069 742e 0a0a 2020 2020 4172 6773  es it...    Args
-0000fc30: 3a0a 2020 2020 2020 2020 7379 6d62 6f6c  :.        symbol
-0000fc40: 2028 7072 696d 732e 5379 6d62 6f6c 293a   (prims.Symbol):
-0000fc50: 2053 796d 626f 6c20 746f 2065 7661 6c75   Symbol to evalu
-0000fc60: 6174 652e 0a0a 2020 2020 5261 6973 6573  ate...    Raises
-0000fc70: 3a0a 2020 2020 2020 2020 4e6f 7449 6d70  :.        NotImp
-0000fc80: 6c65 6d65 6e74 6564 4572 726f 723a 2049  lementedError: I
-0000fc90: 6620 7468 6520 766d 6170 2066 6f72 2074  f the vmap for t
-0000fca0: 6865 2073 796d 626f 6c20 6973 206e 6f74  he symbol is not
-0000fcb0: 2069 6d70 6c65 6d65 6e74 6564 2e0a 0a20   implemented... 
-0000fcc0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0000fcd0: 2020 2020 4361 6c6c 6162 6c65 3a20 766d      Callable: vm
-0000fce0: 6170 2066 756e 6374 696f 6e20 7468 6174  ap function that
-0000fcf0: 2065 7661 6c75 6174 6573 2074 6865 2073   evaluates the s
-0000fd00: 796d 626f 6c2e 0a20 2020 2022 2222 0a0a  ymbol..    """..
-0000fd10: 2020 2020 6465 6620 7772 6170 5f61 7267      def wrap_arg
-0000fd20: 2878 293a 0a20 2020 2020 2020 2069 6620  (x):.        if 
-0000fd30: 6973 696e 7374 616e 6365 2878 2c20 4261  isinstance(x, Ba
-0000fd40: 7463 6865 6456 616c 7565 293a 0a20 2020  tchedValue):.   
-0000fd50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000fd60: 780a 2020 2020 2020 2020 656c 6966 2069  x.        elif i
-0000fd70: 7369 6e73 7461 6e63 6528 782c 2028 4e75  sinstance(x, (Nu
-0000fd80: 6d62 6572 2c20 4e75 6d62 6572 5072 6f78  mber, NumberProx
-0000fd90: 7929 293a 0a20 2020 2020 2020 2020 2020  y)):.           
-0000fda0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-0000fdb0: 616c 7565 2878 2c20 6e6f 745f 6d61 7070  alue(x, not_mapp
-0000fdc0: 6564 290a 2020 2020 2020 2020 656c 7365  ed).        else
-0000fdd0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000fde0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0000fdf0: 2276 6d61 7020 7772 6170 5f61 7267 2067  "vmap wrap_arg g
-0000fe00: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
-0000fe10: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
-0000fe20: 2229 0a0a 2020 2020 6966 2073 796d 626f  ")..    if symbo
-0000fe30: 6c2e 6172 655f 616c 6c5f 6172 6773 5f63  l.are_all_args_c
-0000fe40: 6f6e 7374 616e 743a 0a0a 2020 2020 2020  onstant:..      
-0000fe50: 2020 6465 6620 5f76 6d61 705f 696d 706c    def _vmap_impl
-0000fe60: 5f63 6f6e 7374 2873 796d 626f 6c2c 202a  _const(symbol, *
-0000fe70: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0000fe80: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0000fe90: 203d 2073 796d 626f 6c5f 746f 5f65 7661   = symbol_to_eva
-0000fea0: 6c28 7379 6d62 6f6c 2928 2a61 7267 732c  l(symbol)(*args,
-0000feb0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
-0000fec0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000fed0: 7461 6e63 6528 6f75 742c 2053 6571 7565  tance(out, Seque
-0000fee0: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
-0000fef0: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
-0000ff00: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
-0000ff10: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
-0000ff20: 655f 7a69 7028 6172 6773 2c20 5b6e 6f74  e_zip(args, [not
-0000ff30: 5f6d 6170 7065 645d 202a 206c 656e 286f  _mapped] * len(o
-0000ff40: 7574 2929 290a 0a20 2020 2020 2020 2020  ut)))..         
-0000ff50: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000ff60: 6456 616c 7565 286f 7574 2c20 6e6f 745f  dValue(out, not_
-0000ff70: 6d61 7070 6564 290a 0a20 2020 2020 2020  mapped)..       
-0000ff80: 2072 6574 7572 6e20 7061 7274 6961 6c28   return partial(
-0000ff90: 5f76 6d61 705f 696d 706c 5f63 6f6e 7374  _vmap_impl_const
-0000ffa0: 2c20 7379 6d62 6f6c 290a 0a20 2020 2076  , symbol)..    v
-0000ffb0: 6d61 705f 696d 706c 203d 2076 6d61 705f  map_impl = vmap_
-0000ffc0: 696d 706c 732e 6765 7428 7379 6d62 6f6c  impls.get(symbol
-0000ffd0: 2e73 796d 2e69 6429 0a20 2020 2069 6620  .sym.id).    if 
-0000ffe0: 766d 6170 5f69 6d70 6c20 6973 204e 6f6e  vmap_impl is Non
-0000fff0: 653a 0a20 2020 2020 2020 2069 6620 6c65  e:.        if le
-00010000: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
-00010010: 6f6c 7329 203e 2030 3a0a 2020 2020 2020  ols) > 0:.      
-00010020: 2020 2020 2020 766d 6170 5f69 6d70 6c20        vmap_impl 
-00010030: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
-00010040: 6f73 6564 5f66 6e5f 766d 6170 5f72 756c  osed_fn_vmap_rul
-00010050: 652c 2066 6e3d 7379 6d62 6f6c 2e73 796d  e, fn=symbol.sym
-00010060: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00010070: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010080: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
-00010090: 4572 726f 7228 6622 766d 6170 2066 6f72  Error(f"vmap for
-000100a0: 207b 7379 6d62 6f6c 2e73 796d 2e69 647d   {symbol.sym.id}
-000100b0: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
-000100c0: 7465 6422 290a 0a20 2020 2064 6566 205f  ted")..    def _
-000100d0: 766d 6170 5f69 6d70 6c28 2a61 7267 732c  vmap_impl(*args,
-000100e0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-000100f0: 2020 2020 6172 6773 203d 2074 7265 655f      args = tree_
-00010100: 6d61 7028 7772 6170 5f61 7267 2c20 6172  map(wrap_arg, ar
-00010110: 6773 290a 2020 2020 2020 2020 6173 7365  gs).        asse
-00010120: 7274 2061 6c6c 2869 7369 6e73 7461 6e63  rt all(isinstanc
-00010130: 6528 6172 672c 2042 6174 6368 6564 5661  e(arg, BatchedVa
-00010140: 6c75 6529 2066 6f72 2061 7267 2069 6e20  lue) for arg in 
-00010150: 7472 6565 5f66 6c61 7474 656e 2861 7267  tree_flatten(arg
-00010160: 7329 5b30 5d29 0a20 2020 2020 2020 2072  s)[0]).        r
-00010170: 6574 7572 6e20 766d 6170 5f69 6d70 6c28  eturn vmap_impl(
-00010180: 6178 6973 5f73 697a 652c 202a 6172 6773  axis_size, *args
-00010190: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-000101a0: 2072 6574 7572 6e20 5f76 6d61 705f 696d   return _vmap_im
-000101b0: 706c 0a0a 0a64 6566 2072 656d 6f76 655f  pl...def remove_
-000101c0: 6261 7463 685f 6469 6d28 7465 6e73 6f72  batch_dim(tensor
-000101d0: 3a20 5465 6e73 6f72 5072 6f78 792c 2062  : TensorProxy, b
-000101e0: 6174 6368 5f64 696d 3a20 696e 7420 3d20  atch_dim: int = 
-000101f0: 3029 202d 3e20 5465 6e73 6f72 5072 6f78  0) -> TensorProx
-00010200: 793a 0a20 2020 2022 2222 5265 6d6f 7665  y:.    """Remove
-00010210: 7320 7468 6520 6261 7463 6820 6469 6d65  s the batch dime
-00010220: 6e73 696f 6e20 6672 6f6d 2061 2074 656e  nsion from a ten
-00010230: 736f 722e 0a0a 2020 2020 4172 6773 3a0a  sor...    Args:.
-00010240: 2020 2020 2020 2020 7465 6e73 6f72 2028          tensor (
-00010250: 5465 6e73 6f72 5072 6f78 7929 3a20 5465  TensorProxy): Te
-00010260: 6e73 6f72 2074 6f20 7265 6d6f 7665 2074  nsor to remove t
-00010270: 6865 2062 6174 6368 2064 696d 656e 7369  he batch dimensi
-00010280: 6f6e 2066 726f 6d2e 0a0a 2020 2020 5265  on from...    Re
-00010290: 7475 726e 733a 0a20 2020 2020 2020 2054  turns:.        T
-000102a0: 656e 736f 7250 726f 7879 3a20 5465 6e73  ensorProxy: Tens
-000102b0: 6f72 2077 6974 6820 7468 6520 6261 7463  or with the batc
-000102c0: 6820 6469 6d65 6e73 696f 6e20 7265 6d6f  h dimension remo
-000102d0: 7665 642e 0a20 2020 2022 2222 0a20 2020  ved..    """.   
-000102e0: 206e 6577 5f73 6861 7065 203d 2074 656e   new_shape = ten
-000102f0: 736f 722e 7368 6170 655b 3a62 6174 6368  sor.shape[:batch
-00010300: 5f64 696d 5d20 2b20 7465 6e73 6f72 2e73  _dim] + tensor.s
-00010310: 6861 7065 5b62 6174 6368 5f64 696d 202b  hape[batch_dim +
-00010320: 2031 203a 5d0a 2020 2020 7265 7475 726e   1 :].    return
-00010330: 2054 656e 736f 7250 726f 7879 286c 696b   TensorProxy(lik
-00010340: 653d 7465 6e73 6f72 2c20 7368 6170 653d  e=tensor, shape=
-00010350: 6e65 775f 7368 6170 6529 0a0a 0a23 2054  new_shape)...# T
-00010360: 4f44 4f3a 2069 6e20 4a41 5820 6172 6773  ODO: in JAX args
-00010370: 2c20 696e 5f64 696d 7320 6172 6520 666c  , in_dims are fl
-00010380: 6174 7465 6e65 6420 7468 6520 7361 6d65  attened the same
-00010390: 2077 6179 0a23 2054 4f44 4f3a 2069 6e20   way.# TODO: in 
-000103a0: 4a41 5820 6f75 745f 6469 6d73 2061 7265  JAX out_dims are
-000103b0: 2066 6c61 7474 656e 6564 2061 7320 7765   flattened as we
-000103c0: 6c6c 0a64 6566 205f 766d 6170 5f63 616c  ll.def _vmap_cal
-000103d0: 6c5f 6d65 7461 6675 6e63 2864 6574 6163  l_metafunc(detac
-000103e0: 6865 643a 2062 6f6f 6c2c 2061 7267 732c  hed: bool, args,
-000103f0: 2069 6e5f 6469 6d73 2c20 6f75 745f 6469   in_dims, out_di
-00010400: 6d73 2c20 6178 6973 5f73 697a 652c 2066  ms, axis_size, f
-00010410: 756e 6374 696f 6e5f 7472 6163 653a 2054  unction_trace: T
-00010420: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
-00010430: 0a20 2020 2022 2222 4d65 7461 6675 6e63  .    """Metafunc
-00010440: 7469 6f6e 2066 6f72 2076 6d61 7020 6361  tion for vmap ca
-00010450: 6c6c 2e0a 0a20 2020 2041 7267 733a 0a20  ll...    Args:. 
-00010460: 2020 2020 2020 2064 6574 6163 6865 6420         detached 
-00010470: 2862 6f6f 6c29 3a20 5768 6574 6865 7220  (bool): Whether 
-00010480: 746f 2064 6574 6163 6820 7468 6520 7472  to detach the tr
-00010490: 6163 652e 0a20 2020 2020 2020 2061 7267  ace..        arg
-000104a0: 7320 2854 7570 6c65 5b50 726f 7879 5d29  s (Tuple[Proxy])
-000104b0: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
-000104c0: 6865 2066 756e 6374 696f 6e2e 0a20 2020  he function..   
-000104d0: 2020 2020 2069 6e5f 6469 6d73 2028 5475       in_dims (Tu
-000104e0: 706c 655b 696e 745d 293a 2042 6174 6368  ple[int]): Batch
-000104f0: 2064 696d 656e 7369 6f6e 2066 6f72 2065   dimension for e
-00010500: 6163 6820 6172 6775 6d65 6e74 2e0a 2020  ach argument..  
-00010510: 2020 2020 2020 6f75 745f 6469 6d73 2028        out_dims (
-00010520: 5475 706c 655b 696e 745d 293a 2042 6174  Tuple[int]): Bat
-00010530: 6368 2064 696d 656e 7369 6f6e 2066 6f72  ch dimension for
-00010540: 2072 6574 7572 6e20 7661 6c75 6573 2e0a   return values..
-00010550: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-00010560: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
-00010570: 5472 6163 6520 746f 2075 7365 2066 6f72  Trace to use for
-00010580: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
-00010590: 2020 2020 2020 206b 7761 7267 733a 204b         kwargs: K
-000105a0: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-000105b0: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
-000105c0: 2020 2020 2020 2041 7373 6572 7469 6f6e         Assertion
-000105d0: 4572 726f 723a 2049 6620 7468 6520 766d  Error: If the vm
-000105e0: 6170 2066 6f72 206b 6579 776f 7264 2061  ap for keyword a
-000105f0: 7267 756d 656e 7473 2069 7320 6e6f 7420  rguments is not 
-00010600: 696d 706c 656d 656e 7465 642e 0a0a 2020  implemented...  
-00010610: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00010620: 2020 2052 6573 756c 7420 6f66 2074 6865     Result of the
-00010630: 2076 6d61 7020 7472 616e 7366 6f72 6d2e   vmap transform.
-00010640: 0a20 2020 2022 2222 0a20 2020 2063 6f6d  .    """.    com
-00010650: 6d6f 6e5f 6465 7669 6365 203d 207b 782e  mon_device = {x.
-00010660: 6465 7669 6365 2066 6f72 2078 2069 6e20  device for x in 
-00010670: 6172 6773 2069 6620 6973 696e 7374 616e  args if isinstan
-00010680: 6365 2878 2c20 5465 6e73 6f72 5072 6f78  ce(x, TensorProx
-00010690: 7929 7d0a 2020 2020 6173 7365 7274 206c  y)}.    assert l
-000106a0: 656e 2863 6f6d 6d6f 6e5f 6465 7669 6365  en(common_device
-000106b0: 2920 3c3d 2031 2c20 2276 6d61 7020 666f  ) <= 1, "vmap fo
-000106c0: 7220 6d75 6c74 6970 6c65 2064 6576 6963  r multiple devic
-000106d0: 6573 2069 7320 6e6f 7420 696d 706c 656d  es is not implem
-000106e0: 656e 7465 6422 0a20 2020 2028 636f 6d6d  ented".    (comm
-000106f0: 6f6e 5f64 6576 6963 652c 2920 3d20 636f  on_device,) = co
-00010700: 6d6d 6f6e 5f64 6576 6963 6520 6966 206c  mmon_device if l
-00010710: 656e 2863 6f6d 6d6f 6e5f 6465 7669 6365  en(common_device
-00010720: 2920 3d3d 2031 2065 6c73 6520 2863 7075  ) == 1 else (cpu
-00010730: 2c29 0a0a 2020 2020 6966 2061 7869 735f  ,)..    if axis_
-00010740: 7369 7a65 2069 7320 4e6f 6e65 3a0a 2020  size is None:.  
-00010750: 2020 2020 2020 2861 7869 735f 7369 7a65        (axis_size
-00010760: 2c29 203d 207b 782e 7368 6170 655b 6178  ,) = {x.shape[ax
-00010770: 5d20 666f 7220 782c 2061 7820 696e 207a  ] for x, ax in z
-00010780: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
-00010790: 2920 6966 2061 7820 6973 206e 6f74 206e  ) if ax is not n
-000107a0: 6f74 5f6d 6170 7065 647d 0a20 2020 2069  ot_mapped}.    i
-000107b0: 6e5f 6469 6d73 203d 2069 6e5f 6469 6d73  n_dims = in_dims
-000107c0: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-000107d0: 6e5f 6469 6d73 2c20 5365 7175 656e 6365  n_dims, Sequence
-000107e0: 2920 656c 7365 2028 696e 5f64 696d 732c  ) else (in_dims,
-000107f0: 290a 2020 2020 696e 5f64 696d 7320 3d20  ).    in_dims = 
-00010800: 7475 706c 6528 6e6f 745f 6d61 7070 6564  tuple(not_mapped
-00010810: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00010820: 2c20 284e 756d 6265 722c 204e 756d 6265  , (Number, Numbe
-00010830: 7250 726f 7879 2929 2065 6c73 6520 6420  rProxy)) else d 
-00010840: 666f 7220 612c 2064 2069 6e20 7361 6665  for a, d in safe
-00010850: 5f7a 6970 2861 7267 732c 2069 6e5f 6469  _zip(args, in_di
-00010860: 6d73 2929 0a20 2020 206f 7574 5f64 696d  ms)).    out_dim
-00010870: 7320 3d20 6f75 745f 6469 6d73 2069 6620  s = out_dims if 
-00010880: 6973 696e 7374 616e 6365 286f 7574 5f64  isinstance(out_d
-00010890: 696d 732c 2053 6571 7565 6e63 6529 2065  ims, Sequence) e
-000108a0: 6c73 6520 286f 7574 5f64 696d 732c 290a  lse (out_dims,).
-000108b0: 0a20 2020 2063 7478 203d 2064 6574 6163  .    ctx = detac
-000108c0: 6865 645f 7472 6163 6528 2920 6966 2064  hed_trace() if d
-000108d0: 6574 6163 6865 6420 656c 7365 206e 756c  etached else nul
-000108e0: 6c63 6f6e 7465 7874 2829 0a20 2020 2077  lcontext().    w
-000108f0: 6974 6820 6374 783a 0a20 2020 2020 2020  ith ctx:.       
-00010900: 2023 2057 6520 7072 6f70 6167 6174 6520   # We propagate 
-00010910: 7468 6520 4261 7463 6856 616c 7565 2074  the BatchValue t
-00010920: 6872 6f75 6768 2074 6865 2074 7261 6365  hrough the trace
-00010930: 2c20 616e 6420 7468 656e 2075 6e77 7261  , and then unwra
-00010940: 7020 6974 2061 7420 7468 6520 656e 640a  p it at the end.
-00010950: 2020 2020 2020 2020 6261 7463 6865 645f          batched_
-00010960: 6172 6773 203d 2073 6166 655f 6d61 7028  args = safe_map(
-00010970: 7061 6972 5f74 6f5f 6261 7463 6865 645f  pair_to_batched_
-00010980: 7661 6c75 652c 2073 6166 655f 7a69 7028  value, safe_zip(
-00010990: 6172 6773 2c20 696e 5f64 696d 7329 290a  args, in_dims)).
-000109a0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-000109b0: 2065 7661 6c5f 7472 6163 6528 0a20 2020   eval_trace(.   
-000109c0: 2020 2020 2020 2020 2066 756e 6374 696f           functio
-000109d0: 6e5f 7472 6163 652c 202a 6261 7463 6865  n_trace, *batche
-000109e0: 645f 6172 6773 2c20 7379 6d62 6f6c 5f6d  d_args, symbol_m
-000109f0: 6170 7065 723d 7061 7274 6961 6c28 766d  apper=partial(vm
-00010a00: 6170 5f73 796d 626f 6c5f 6d61 7070 6572  ap_symbol_mapper
-00010a10: 2c20 6178 6973 5f73 697a 653d 6178 6973  , axis_size=axis
-00010a20: 5f73 697a 6529 2c20 2a2a 6b77 6172 6773  _size), **kwargs
-00010a30: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00010a40: 2020 2023 2055 6e77 7261 7070 696e 6720     # Unwrapping 
-00010a50: 7468 6520 4261 7463 6865 6456 616c 7565  the BatchedValue
-00010a60: 2773 0a20 2020 2020 2020 2069 6620 6973  's.        if is
-00010a70: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-00010a80: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-00010a90: 2020 2020 2020 2020 666c 6174 5f72 6573          flat_res
-00010aa0: 756c 742c 2073 7065 6320 3d20 7472 6565  ult, spec = tree
-00010ab0: 5f66 6c61 7474 656e 2872 6573 756c 7429  _flatten(result)
-00010ac0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00010ad0: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
-00010ae0: 6365 2878 2c20 4261 7463 6865 6456 616c  ce(x, BatchedVal
-00010af0: 7565 2920 666f 7220 7820 696e 2066 6c61  ue) for x in fla
-00010b00: 745f 7265 7375 6c74 290a 2020 2020 2020  t_result).      
-00010b10: 2020 2020 2020 6f75 7473 2c20 6264 696d        outs, bdim
-00010b20: 7320 3d20 756e 7a69 7032 2866 6c61 745f  s = unzip2(flat_
-00010b30: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
-00010b40: 2020 2020 2320 544f 444f 3a20 6861 6e64      # TODO: hand
-00010b50: 6c65 2074 6865 2063 6173 6520 7768 6572  le the case wher
-00010b60: 6520 6f75 745f 6469 6d73 2069 7320 6120  e out_dims is a 
-00010b70: 7369 6e67 6c65 2076 616c 7565 2062 6574  single value bet
-00010b80: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-00010b90: 6966 206c 656e 286f 7574 5f64 696d 7329  if len(out_dims)
-00010ba0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-00010bb0: 2020 2020 2020 206f 7574 5f64 696d 7320         out_dims 
-00010bc0: 3d20 6f75 745f 6469 6d73 202a 206c 656e  = out_dims * len
-00010bd0: 286f 7574 7329 0a20 2020 2020 2020 2020  (outs).         
-00010be0: 2020 206f 7574 7320 3d20 7361 6665 5f6d     outs = safe_m
-00010bf0: 6170 2870 6172 7469 616c 286d 6f76 655f  ap(partial(move_
-00010c00: 6261 7463 685f 6469 6d2c 2061 7869 735f  batch_dim, axis_
-00010c10: 7369 7a65 292c 2062 6469 6d73 2c20 6f75  size), bdims, ou
-00010c20: 745f 6469 6d73 2c20 6f75 7473 290a 2020  t_dims, outs).  
-00010c30: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00010c40: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
-00010c50: 6f75 7473 2c20 7370 6563 290a 2020 2020  outs, spec).    
-00010c60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00010c70: 6528 7265 7375 6c74 2c20 284e 756d 6265  e(result, (Numbe
-00010c80: 722c 204e 756d 6265 7250 726f 7879 2929  r, NumberProxy))
-00010c90: 2061 6e64 2061 7869 735f 7369 7a65 2069   and axis_size i
-00010ca0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00010cb0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
-00010cc0: 6665 7463 6820 7468 6520 6465 6661 756c  fetch the defaul
-00010cd0: 7420 6465 7669 6365 2066 726f 6d20 7468  t device from th
-00010ce0: 6520 636f 6e74 6578 740a 2020 2020 2020  e context.      
-00010cf0: 2020 2020 2020 7265 7375 6c74 203d 2066        result = f
-00010d00: 756c 6c28 7368 6170 653d 2829 2c20 6669  ull(shape=(), fi
-00010d10: 6c6c 5f76 616c 7565 3d72 6573 756c 742c  ll_value=result,
-00010d20: 2064 6576 6963 653d 636f 6d6d 6f6e 5f64   device=common_d
-00010d30: 6576 6963 6529 0a20 2020 2020 2020 2020  evice).         
-00010d40: 2020 2072 6573 756c 7420 3d20 4261 7463     result = Batc
-00010d50: 6865 6456 616c 7565 2872 6573 756c 742c  hedValue(result,
-00010d60: 206e 6f74 5f6d 6170 7065 6429 0a20 2020   not_mapped).   
-00010d70: 2020 2020 2065 6c69 6620 280a 2020 2020       elif (.    
-00010d80: 2020 2020 2020 2020 6973 696e 7374 616e          isinstan
-00010d90: 6365 2872 6573 756c 742c 2042 6174 6368  ce(result, Batch
-00010da0: 6564 5661 6c75 6529 0a20 2020 2020 2020  edValue).       
-00010db0: 2020 2020 2061 6e64 2069 7369 6e73 7461       and isinsta
-00010dc0: 6e63 6528 7265 7375 6c74 2e76 616c 7565  nce(result.value
-00010dd0: 2c20 284e 756d 6265 722c 204e 756d 6265  , (Number, Numbe
-00010de0: 7250 726f 7879 2929 0a20 2020 2020 2020  rProxy)).       
-00010df0: 2020 2020 2061 6e64 2061 7869 735f 7369       and axis_si
-00010e00: 7a65 2069 7320 6e6f 7420 4e6f 6e65 0a20  ze is not None. 
-00010e10: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00010e20: 2020 2020 2020 7265 7375 6c74 203d 2042        result = B
-00010e30: 6174 6368 6564 5661 6c75 6528 6675 6c6c  atchedValue(full
-00010e40: 2873 6861 7065 3d28 292c 2066 696c 6c5f  (shape=(), fill_
-00010e50: 7661 6c75 653d 7265 7375 6c74 2e76 616c  value=result.val
-00010e60: 7565 2c20 6465 7669 6365 3d63 6f6d 6d6f  ue, device=commo
-00010e70: 6e5f 6465 7669 6365 292c 2072 6573 756c  n_device), resul
-00010e80: 742e 6261 7463 685f 6469 6d29 0a20 2020  t.batch_dim).   
-00010e90: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00010ea0: 7374 616e 6365 2872 6573 756c 742c 2042  stance(result, B
-00010eb0: 6174 6368 6564 5661 6c75 6529 0a20 2020  atchedValue).   
-00010ec0: 2020 2020 206f 7574 203d 206d 6f76 655f       out = move_
-00010ed0: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
-00010ee0: 697a 652c 2072 6573 756c 742e 6261 7463  ize, result.batc
-00010ef0: 685f 6469 6d2c 206f 7574 5f64 696d 735b  h_dim, out_dims[
-00010f00: 305d 2c20 7265 7375 6c74 2e76 616c 7565  0], result.value
-00010f10: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00010f20: 206f 7574 0a0a 0a76 6d61 705f 6361 6c6c   out...vmap_call
-00010f30: 203d 2053 796d 626f 6c28 6964 3d54 7261   = Symbol(id=Tra
-00010f40: 6e73 666f 726d 732e 566d 6170 4f70 2c20  nsforms.VmapOp, 
-00010f50: 6e61 6d65 3d22 766d 6170 5f63 616c 6c22  name="vmap_call"
-00010f60: 2c20 6d65 7461 3d70 6172 7469 616c 285f  , meta=partial(_
-00010f70: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
-00010f80: 6e63 2c20 4661 6c73 6529 290a 0a0a 2320  nc, False))...# 
-00010f90: 544f 444f 3a20 686f 7720 7368 6f75 6c64  TODO: how should
-00010fa0: 2077 6520 6861 6e64 6c65 206f 7574 5f64   we handle out_d
-00010fb0: 696d 7320 6865 7265 3f0a 2320 616c 7468  ims here?.# alth
-00010fc0: 6f75 6768 2068 6572 6520 7765 2061 7265  ough here we are
-00010fd0: 2063 616c 6c69 6e67 2076 6d61 7020 6f66   calling vmap of
-00010fe0: 2069 6465 6e74 6974 792c 2073 6f20 7765   identity, so we
-00010ff0: 2073 686f 756c 6420 6b6e 6f77 2066 726f   should know fro
-00011000: 6d20 7468 6520 6361 6c6c 2074 6f20 766d  m the call to vm
-00011010: 6170 0a23 2054 6869 7320 7368 6f75 6c64  ap.# This should
-00011020: 2062 6520 6669 6e65 2e20 4966 2077 6520   be fine. If we 
-00011030: 6861 7665 2076 6d61 7028 6964 656e 7469  have vmap(identi
-00011040: 7479 2866 756e 6329 2c20 6f75 745f 6469  ty(func), out_di
-00011050: 6d73 3d4e 2920 7468 656e 2074 6869 7320  ms=N) then this 
-00011060: 7275 6c65 2069 7320 6669 7273 7420 7573  rule is first us
-00011070: 6564 0a23 2074 6f20 6765 7420 7468 6520  ed.# to get the 
-00011080: 766d 6170 7065 6420 7265 7375 6c74 206f  vmapped result o
-00011090: 6620 6964 656e 7469 7479 2866 756e 6329  f identity(func)
-000110a0: 2069 6e20 766d 6170 5f73 796d 626f 6c5f   in vmap_symbol_
-000110b0: 6d61 7070 6572 2c20 616e 6420 6f75 745f  mapper, and out_
-000110c0: 6469 6d73 2069 7320 6861 6e64 6c65 640a  dims is handled.
-000110d0: 2320 6166 7465 7220 7468 6174 2069 6e20  # after that in 
-000110e0: 7468 6520 6f75 7465 7220 5f76 6d61 705f  the outer _vmap_
-000110f0: 6361 6c6c 5f6d 6574 6166 756e 632e 0a64  call_metafunc..d
-00011100: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
-00011110: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
-00011120: 2c20 2a62 6174 6368 6564 5f61 7267 732c  , *batched_args,
-00011130: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-00011140: 2a6b 7761 7267 7329 3a0a 2020 2020 6172  *kwargs):.    ar
-00011150: 6773 2c20 696e 5f64 696d 7320 3d20 756e  gs, in_dims = un
-00011160: 7a69 7032 2862 6174 6368 6564 5f61 7267  zip2(batched_arg
-00011170: 7329 0a20 2020 206f 7574 5f64 696d 7320  s).    out_dims 
-00011180: 3d20 3020 2023 2046 6978 6d65 0a20 2020  = 0  # Fixme.   
-00011190: 206f 7574 732c 206f 7574 5f64 696d 7320   outs, out_dims 
-000111a0: 3d20 5f76 6d61 705f 6361 6c6c 5f6d 6574  = _vmap_call_met
-000111b0: 6166 756e 6328 4661 6c73 652c 2061 7267  afunc(False, arg
-000111c0: 732c 2069 6e5f 6469 6d73 2c20 6f75 745f  s, in_dims, out_
-000111d0: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
-000111e0: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
-000111f0: 7472 6163 652c 202a 2a6b 7761 7267 7329  trace, **kwargs)
-00011200: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00011210: 6365 286f 7574 732c 2053 6571 7565 6e63  ce(outs, Sequenc
-00011220: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00011230: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-00011240: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
-00011250: 652c 2073 6166 655f 7a69 7028 6f75 7473  e, safe_zip(outs
-00011260: 2c20 6f75 745f 6469 6d73 2929 0a20 2020  , out_dims)).   
-00011270: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-00011280: 616c 7565 286f 7574 732c 206f 7574 5f64  alue(outs, out_d
-00011290: 696d 7329 0a0a 0a76 6d61 705f 696d 706c  ims)...vmap_impl
-000112a0: 735b 5472 616e 7366 6f72 6d73 2e49 6465  s[Transforms.Ide
-000112b0: 6e74 6974 794f 705d 203d 205f 6964 656e  ntityOp] = _iden
-000112c0: 7469 7479 5f63 616c 6c5f 766d 6170 0a0a  tity_call_vmap..
-000112d0: 0a64 6566 205f 6a76 705f 6361 6c6c 5f76  .def _jvp_call_v
-000112e0: 6d61 7028 6178 6973 5f73 697a 652c 2062  map(axis_size, b
-000112f0: 6174 6368 6564 5f70 7269 6d61 6c73 2c20  atched_primals, 
-00011300: 6261 7463 6865 645f 7461 6e67 656e 7473  batched_tangents
-00011310: 2c20 2a2c 2066 756e 6374 696f 6e5f 7472  , *, function_tr
-00011320: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-00011330: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
-00011340: 6c73 2c20 7072 696d 616c 735f 6264 696d  ls, primals_bdim
-00011350: 7320 3d20 7361 6665 5f7a 6970 282a 6261  s = safe_zip(*ba
-00011360: 7463 6865 645f 7072 696d 616c 7329 0a20  tched_primals). 
-00011370: 2020 2074 616e 6765 6e74 732c 2074 616e     tangents, tan
-00011380: 6765 6e74 735f 6264 696d 7320 3d20 7361  gents_bdims = sa
-00011390: 6665 5f7a 6970 282a 6261 7463 6865 645f  fe_zip(*batched_
-000113a0: 7461 6e67 656e 7473 290a 2020 2020 6a76  tangents).    jv
-000113b0: 705f 6675 6e63 203d 2070 6172 7469 616c  p_func = partial
-000113c0: 285f 6a76 705f 6361 6c6c 5f6d 6574 6166  (_jvp_call_metaf
-000113d0: 756e 632c 2046 616c 7365 2c20 6675 6e63  unc, False, func
-000113e0: 7469 6f6e 5f74 7261 6365 3d66 756e 6374  tion_trace=funct
-000113f0: 696f 6e5f 7472 6163 6529 0a20 2020 2076  ion_trace).    v
-00011400: 6d61 7070 6564 5f6a 7670 5f66 756e 6320  mapped_jvp_func 
-00011410: 3d20 766d 6170 286a 7670 5f66 756e 632c  = vmap(jvp_func,
-00011420: 2069 6e5f 6469 6d73 3d28 7072 696d 616c   in_dims=(primal
-00011430: 735f 6264 696d 732c 2074 616e 6765 6e74  s_bdims, tangent
-00011440: 735f 6264 696d 7329 2c20 6178 6973 5f73  s_bdims), axis_s
-00011450: 697a 653d 6178 6973 5f73 697a 6529 0a20  ize=axis_size). 
-00011460: 2020 2072 6573 756c 7420 3d20 766d 6170     result = vmap
-00011470: 7065 645f 6a76 705f 6675 6e63 2870 7269  ped_jvp_func(pri
-00011480: 6d61 6c73 2c20 7461 6e67 656e 7473 2c20  mals, tangents, 
-00011490: 2a2a 6b77 6172 6773 290a 2020 2020 7265  **kwargs).    re
-000114a0: 7475 726e 2074 7265 655f 6d61 7028 6c61  turn tree_map(la
-000114b0: 6d62 6461 2078 3a20 4261 7463 6865 6456  mbda x: BatchedV
-000114c0: 616c 7565 2878 2c20 3029 2c20 7265 7375  alue(x, 0), resu
-000114d0: 6c74 290a 0a0a 766d 6170 5f69 6d70 6c73  lt)...vmap_impls
-000114e0: 5b54 7261 6e73 666f 726d 732e 4a76 704f  [Transforms.JvpO
-000114f0: 705d 203d 205f 6a76 705f 6361 6c6c 5f76  p] = _jvp_call_v
-00011500: 6d61 700a 0a0a 6465 6620 766d 6170 2866  map...def vmap(f
-00011510: 756e 632c 2069 6e5f 6469 6d73 3d30 2c20  unc, in_dims=0, 
-00011520: 6f75 745f 6469 6d73 3d30 2c20 6178 6973  out_dims=0, axis
-00011530: 5f73 697a 653d 4e6f 6e65 293a 0a20 2020  _size=None):.   
-00011540: 2022 2222 5665 6374 6f72 697a 696e 6720   """Vectorizing 
-00011550: 7472 616e 7366 6f72 6d20 666f 7220 6120  transform for a 
-00011560: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
-00011570: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00011580: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
-00011590: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
-000115a0: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
-000115b0: 7261 6e73 666f 726d 6564 2e0a 0a20 2020  ransformed...   
-000115c0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-000115d0: 2020 4361 6c6c 6162 6c65 3a20 4120 766d    Callable: A vm
-000115e0: 6170 7065 6420 7665 7273 696f 6e20 6f66  apped version of
-000115f0: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
-00011600: 2020 2022 2222 0a0a 2020 2020 2320 544f     """..    # TO
-00011610: 444f 3a20 666c 6174 7465 6e0a 2020 2020  DO: flatten.    
-00011620: 2320 496e 204a 4158 2066 6c61 7474 656e  # In JAX flatten
-00011630: 696e 6720 6f66 2069 6e5f 6469 6d73 2069  ing of in_dims i
-00011640: 7320 7261 7468 6572 2063 6f6d 706c 6963  s rather complic
-00011650: 6174 6564 2062 6563 6175 7365 2069 7420  ated because it 
-00011660: 6361 6e20 6f70 7469 6f6e 616c 6c79 2062  can optionally b
-00011670: 650a 2020 2020 2320 7370 6563 6966 6965  e.    # specifie
-00011680: 6420 6173 2061 20e2 809c 7072 6566 6978  d as a ...prefix
-00011690: e280 9d20 7079 7472 6565 2c20 6d65 616e  ... pytree, mean
-000116a0: 696e 6720 7468 6174 2061 2073 696e 676c  ing that a singl
-000116b0: 6520 6c65 6166 2076 616c 7565 2063 616e  e leaf value can
-000116c0: 2062 6520 6170 706c 6965 640a 2020 2020   be applied.    
-000116d0: 2320 746f 2061 6e20 656e 7469 7265 2073  # to an entire s
-000116e0: 7562 2d70 7974 7265 652e 0a0a 2020 2020  ub-pytree...    
-000116f0: 6465 6620 666c 6174 7465 6e5f 6675 6e63  def flatten_func
-00011700: 5f66 6f72 5f76 6d61 7028 6675 6e63 2c20  _for_vmap(func, 
-00011710: 6172 6773 2c20 6b77 6172 6773 293a 0a20  args, kwargs):. 
-00011720: 2020 2020 2020 2066 6c61 745f 6172 6773         flat_args
-00011730: 2c20 7370 6563 203d 2074 7265 655f 666c  , spec = tree_fl
-00011740: 6174 7465 6e28 2861 7267 732c 206b 7761  atten((args, kwa
-00011750: 7267 7329 290a 0a20 2020 2020 2020 2064  rgs))..        d
-00011760: 6566 2066 6c61 745f 6675 6e63 282a 666c  ef flat_func(*fl
-00011770: 6174 5f61 7267 7329 3a0a 2020 2020 2020  at_args):.      
-00011780: 2020 2020 2020 666e 5f61 7267 732c 2066        fn_args, f
-00011790: 6e5f 6b77 6172 6773 203d 2074 7265 655f  n_kwargs = tree_
-000117a0: 756e 666c 6174 7465 6e28 666c 6174 5f61  unflatten(flat_a
-000117b0: 7267 732c 2073 7065 6329 0a20 2020 2020  rgs, spec).     
-000117c0: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
-000117d0: 6e63 282a 666e 5f61 7267 732c 202a 2a66  nc(*fn_args, **f
-000117e0: 6e5f 6b77 6172 6773 290a 0a20 2020 2020  n_kwargs)..     
-000117f0: 2020 2072 6574 7572 6e20 666c 6174 5f66     return flat_f
-00011800: 756e 632c 2066 6c61 745f 6172 6773 2c20  unc, flat_args, 
-00011810: 7370 6563 0a0a 2020 2020 6465 6620 7772  spec..    def wr
-00011820: 6170 7065 7228 2a61 7267 732c 202a 2a6b  apper(*args, **k
-00011830: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00011840: 6675 6e63 5f66 6c61 742c 2061 7267 735f  func_flat, args_
-00011850: 666c 6174 2c20 6172 6773 5f73 7065 6320  flat, args_spec 
-00011860: 3d20 666c 6174 7465 6e5f 6675 6e63 5f66  = flatten_func_f
-00011870: 6f72 5f76 6d61 7028 6675 6e63 2c20 6172  or_vmap(func, ar
-00011880: 6773 2c20 6b77 6172 6773 290a 2020 2020  gs, kwargs).    
-00011890: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000118a0: 6528 696e 5f64 696d 732c 2069 6e74 293a  e(in_dims, int):
-000118b0: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
-000118c0: 6469 6d73 5f66 6c61 7420 3d20 2869 6e5f  dims_flat = (in_
-000118d0: 6469 6d73 2c29 202a 206c 656e 2861 7267  dims,) * len(arg
-000118e0: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
-000118f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00011900: 2020 696e 5f64 696d 735f 666c 6174 2c20    in_dims_flat, 
-00011910: 696e 5f64 696d 735f 7370 6563 203d 2074  in_dims_spec = t
-00011920: 7265 655f 666c 6174 7465 6e28 696e 5f64  ree_flatten(in_d
-00011930: 696d 7329 0a20 2020 2020 2020 2020 2020  ims).           
-00011940: 2061 7373 6572 7420 6c65 6e28 696e 5f64   assert len(in_d
-00011950: 696d 735f 666c 6174 2920 3d3d 206c 656e  ims_flat) == len
-00011960: 2861 7267 735f 666c 6174 292c 2022 696e  (args_flat), "in
-00011970: 5f64 696d 7320 6d75 7374 2068 6176 6520  _dims must have 
-00011980: 7468 6520 7361 6d65 206c 656e 6774 6820  the same length 
-00011990: 6173 2061 7267 732c 206b 7761 7267 7322  as args, kwargs"
-000119a0: 0a20 2020 2020 2020 2075 6e62 6174 6368  .        unbatch
-000119b0: 6564 5f61 7267 735f 666c 6174 203d 205b  ed_args_flat = [
-000119c0: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
-000119d0: 2861 7267 2920 6966 2069 7369 6e73 7461  (arg) if isinsta
-000119e0: 6e63 6528 6172 672c 2054 656e 736f 7250  nce(arg, TensorP
-000119f0: 726f 7879 2920 656c 7365 2061 7267 2066  roxy) else arg f
-00011a00: 6f72 2061 7267 2069 6e20 6172 6773 5f66  or arg in args_f
-00011a10: 6c61 745d 0a20 2020 2020 2020 2074 7261  lat].        tra
-00011a20: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-00011a30: 7261 6365 2829 2866 756e 635f 666c 6174  race()(func_flat
-00011a40: 2c20 2a75 6e62 6174 6368 6564 5f61 7267  , *unbatched_arg
-00011a50: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
-00011a60: 6f75 7473 203d 2076 6d61 705f 6361 6c6c  outs = vmap_call
-00011a70: 2861 7267 735f 666c 6174 2c20 696e 5f64  (args_flat, in_d
-00011a80: 696d 735f 666c 6174 2c20 6f75 745f 6469  ims_flat, out_di
-00011a90: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
-00011aa0: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
-00011ab0: 6e5f 7472 6163 653d 7472 6163 6529 0a20  n_trace=trace). 
-00011ac0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00011ad0: 7473 0a0a 2020 2020 7265 7475 726e 2077  ts..    return w
-00011ae0: 7261 7070 6572 0a0a 0a23 2054 4f44 4f20  rapper...# TODO 
-00011af0: 5468 6973 2066 756e 6374 696f 6e20 636f  This function co
-00011b00: 6d6d 656e 7465 6420 6f75 7420 6265 6361  mmented out beca
-00011b10: 7573 6520 6974 2063 616c 6c73 206d 616b  use it calls mak
-00011b20: 655f 7472 6163 6564 2c20 7768 6963 6820  e_traced, which 
-00011b30: 646f 6573 206e 6f74 2065 7869 7374 0a23  does not exist.#
-00011b40: 2064 6566 2076 6d61 705f 6561 6765 7228   def vmap_eager(
-00011b50: 6675 6e63 2c20 6172 6773 2c20 696e 5f64  func, args, in_d
-00011b60: 696d 733d 302c 206f 7574 5f64 696d 733d  ims=0, out_dims=
-00011b70: 302c 2061 7869 735f 7369 7a65 3d4e 6f6e  0, axis_size=Non
-00011b80: 652c 2065 7865 6375 746f 723d 2274 6f72  e, executor="tor
-00011b90: 6368 2229 3a0a 2320 2020 2020 2222 2243  ch"):.#     """C
-00011ba0: 6f6d 7075 7465 7320 7468 6520 766d 6170  omputes the vmap
-00011bb0: 206f 6620 6120 5468 756e 6465 7220 6675   of a Thunder fu
-00011bc0: 6e63 7469 6f6e 2e0a 0a23 2020 2020 2041  nction...#     A
-00011bd0: 7267 733a 0a23 2020 2020 2020 2020 2066  rgs:.#         f
-00011be0: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
-00011bf0: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
-00011c00: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
-00011c10: 726d 6564 2e0a 2320 2020 2020 2020 2020  rmed..#         
-00011c20: 6172 6773 2028 5f74 7970 655f 293a 2041  args (_type_): A
-00011c30: 7267 7320 6f66 2074 6865 2066 756e 6374  rgs of the funct
-00011c40: 696f 6e2e 0a23 2020 2020 2020 2020 2065  ion..#         e
-00011c50: 7865 6375 746f 7220 2873 7472 2c20 6f70  xecutor (str, op
-00011c60: 7469 6f6e 616c 293a 2045 7865 6375 746f  tional): Executo
-00011c70: 7220 746f 2075 7365 2e20 4465 6661 756c  r to use. Defaul
-00011c80: 7473 2074 6f20 2274 6f72 6368 222e 0a0a  ts to "torch"...
-00011c90: 2320 2020 2020 5265 7475 726e 733a 0a23  #     Returns:.#
-00011ca0: 2020 2020 2020 2020 2054 6865 2072 6573           The res
-00011cb0: 756c 7420 6f66 2074 6865 2076 6d61 7070  ult of the vmapp
-00011cc0: 6564 2066 756e 6374 696f 6e2e 0a23 2020  ed function..#  
-00011cd0: 2020 2022 2222 0a23 2020 2020 2023 2054     """.#     # T
-00011ce0: 4f44 4f3a 2066 6978 2074 6869 7320 2d20  ODO: fix this - 
-00011cf0: 6e6f 7420 616c 6c20 6172 6773 206d 6179  not all args may
-00011d00: 2062 6520 6261 7463 6865 640a 2320 2020   be batched.#   
-00011d10: 2020 2320 544f 444f 3a20 6865 7265 2077    # TODO: here w
-00011d20: 6520 6173 7375 6d65 2062 6174 6368 2061  e assume batch a
-00011d30: 7869 7320 6973 2030 0a23 2020 2020 2076  xis is 0.#     v
-00011d40: 6d61 705f 7472 6163 6520 3d20 6d61 6b65  map_trace = make
-00011d50: 5f74 7261 6365 280a 2320 2020 2020 2020  _trace(.#       
-00011d60: 2020 766d 6170 2866 756e 632c 2069 6e5f    vmap(func, in_
-00011d70: 6469 6d73 3d69 6e5f 6469 6d73 2c20 6f75  dims=in_dims, ou
-00011d80: 745f 6469 6d73 3d6f 7574 5f64 696d 732c  t_dims=out_dims,
-00011d90: 2061 7869 735f 7369 7a65 3d61 7869 735f   axis_size=axis_
-00011da0: 7369 7a65 292c 2065 7865 6375 746f 723d  size), executor=
-00011db0: 6578 6563 7574 6f72 2c0a 2320 2020 2020  executor,.#     
-00011dc0: 2020 2020 2a61 7267 7329 0a23 2020 2020      *args).#    
-00011dd0: 2076 6d61 705f 7472 6163 6564 203d 206d   vmap_traced = m
-00011de0: 616b 655f 7472 6163 6564 2870 6172 7469  ake_traced(parti
-00011df0: 616c 2865 7661 6c5f 7472 6163 652c 2076  al(eval_trace, v
-00011e00: 6d61 705f 7472 6163 6529 2c20 6578 6563  map_trace), exec
-00011e10: 7574 6f72 3d65 7865 6375 746f 7229 0a23  utor=executor).#
-00011e20: 2020 2020 2072 6574 7572 6e20 766d 6170       return vmap
-00011e30: 5f74 7261 6365 6428 2a61 7267 7329 0a0a  _traced(*args)..
-00011e40: 0a23 204a 5650 2074 7261 6e73 666f 726d  .# JVP transform
-00011e50: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  .# -------------
-00011e60: 0a0a 0a40 6461 7461 636c 6173 7328 6672  ...@dataclass(fr
-00011e70: 6f7a 656e 3d54 7275 6529 0a63 6c61 7373  ozen=True).class
-00011e80: 204a 5650 4475 616c 3a0a 2020 2020 2222   JVPDual:.    ""
-00011e90: 2244 7561 6c20 6e75 6d62 6572 2066 6f72  "Dual number for
-00011ea0: 2074 6865 204a 5650 2074 7261 6e73 666f   the JVP transfo
-00011eb0: 726d 2e0a 0a20 2020 2041 7474 7269 6275  rm...    Attribu
-00011ec0: 7465 733a 0a20 2020 2020 2020 2070 7269  tes:.        pri
-00011ed0: 6d61 6c3a 2050 7269 6d61 6c20 7661 6c75  mal: Primal valu
-00011ee0: 652e 0a20 2020 2020 2020 2074 616e 6765  e..        tange
-00011ef0: 6e74 3a20 5461 6e67 656e 7420 7661 6c75  nt: Tangent valu
-00011f00: 652e 0a20 2020 2022 2222 0a0a 2020 2020  e..    """..    
-00011f10: 7072 696d 616c 3a20 416e 790a 2020 2020  primal: Any.    
-00011f20: 7461 6e67 656e 743a 2041 6e79 0a0a 2020  tangent: Any..  
-00011f30: 2020 6465 6620 5f5f 6974 6572 5f5f 2873    def __iter__(s
-00011f40: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
-00011f50: 656c 6420 7365 6c66 2e70 7269 6d61 6c0a  eld self.primal.
-00011f60: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-00011f70: 6c66 2e74 616e 6765 6e74 0a0a 0a64 6566  lf.tangent...def
-00011f80: 2070 6169 725f 746f 5f6a 7670 5f64 7561   pair_to_jvp_dua
-00011f90: 6c28 7061 6972 293a 0a20 2020 2022 2222  l(pair):.    """
-00011fa0: 436f 6e76 6572 7473 2061 2070 6169 7220  Converts a pair 
-00011fb0: 746f 2061 204a 5650 4475 616c 2e0a 0a20  to a JVPDual... 
-00011fc0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00011fd0: 2070 6169 7220 2853 6571 7565 6e63 6529   pair (Sequence)
-00011fe0: 3a20 5061 6972 2074 6f20 636f 6e76 6572  : Pair to conver
-00011ff0: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
-00012000: 0a20 2020 2020 2020 204a 5650 4475 616c  .        JVPDual
-00012010: 3a20 4a56 5044 7561 6c20 7265 7072 6573  : JVPDual repres
-00012020: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
-00012030: 7061 6972 2e0a 2020 2020 2222 220a 2020  pair..    """.  
-00012040: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012050: 7061 6972 2c20 4a56 5044 7561 6c29 3a0a  pair, JVPDual):.
-00012060: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-00012070: 6169 720a 2020 2020 656c 7365 3a0a 2020  air.    else:.  
-00012080: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00012090: 6e73 7461 6e63 6528 7061 6972 2c20 5365  nstance(pair, Se
-000120a0: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
-000120b0: 7061 6972 2920 3d3d 2032 0a20 2020 2020  pair) == 2.     
-000120c0: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-000120d0: 6c28 2a70 6169 7229 0a0a 0a64 6566 2073  l(*pair)...def s
-000120e0: 696e 5f6a 7670 2861 3a20 4a56 5044 7561  in_jvp(a: JVPDua
-000120f0: 6c29 3a0a 2020 2020 782c 2078 6420 3d20  l):.    x, xd = 
-00012100: 610a 2020 2020 7265 7475 726e 204a 5650  a.    return JVP
-00012110: 4475 616c 2870 7269 6d73 2e73 696e 2878  Dual(prims.sin(x
-00012120: 292c 2070 7269 6d73 2e63 6f73 2878 2920  ), prims.cos(x) 
-00012130: 2a20 7864 290a 0a0a 6465 6620 6d75 6c5f  * xd)...def mul_
-00012140: 6a76 7028 613a 204a 5650 4475 616c 2c20  jvp(a: JVPDual, 
-00012150: 623a 204a 5650 4475 616c 293a 0a20 2020  b: JVPDual):.   
-00012160: 2078 2c20 7864 203d 2061 0a20 2020 2079   x, xd = a.    y
-00012170: 2c20 7964 203d 2062 0a20 2020 2072 6574  , yd = b.    ret
-00012180: 7572 6e20 4a56 5044 7561 6c28 7820 2a20  urn JVPDual(x * 
-00012190: 792c 2078 202a 2079 6420 2b20 7920 2a20  y, x * yd + y * 
-000121a0: 7864 290a 0a0a 6465 6620 6164 645f 6a76  xd)...def add_jv
-000121b0: 7028 613a 204a 5650 4475 616c 2c20 623a  p(a: JVPDual, b:
-000121c0: 204a 5650 4475 616c 293a 0a20 2020 2078   JVPDual):.    x
-000121d0: 2c20 7864 203d 2061 0a20 2020 2079 2c20  , xd = a.    y, 
-000121e0: 7964 203d 2062 0a20 2020 2072 6574 7572  yd = b.    retur
-000121f0: 6e20 4a56 5044 7561 6c28 7820 2b20 792c  n JVPDual(x + y,
-00012200: 2078 6420 2b20 7964 290a 0a0a 6465 6620   xd + yd)...def 
-00012210: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-00012220: 5f6a 7670 2861 3a20 4a56 5044 7561 6c2c  _jvp(a: JVPDual,
-00012230: 2073 6861 7065 3a20 7475 706c 655b 4a56   shape: tuple[JV
-00012240: 5044 7561 6c2c 202e 2e2e 5d2c 2062 726f  PDual, ...], bro
-00012250: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00012260: 733a 2074 7570 6c65 5b4a 5650 4475 616c  s: tuple[JVPDual
-00012270: 2c20 2e2e 2e5d 2920 2d3e 204a 5650 4475  , ...]) -> JVPDu
-00012280: 616c 3a0a 2020 2020 782c 2078 6420 3d20  al:.    x, xd = 
-00012290: 610a 2020 2020 2320 544f 444f 3a20 7368  a.    # TODO: sh
-000122a0: 6170 6520 616e 6420 6272 6f61 6463 6173  ape and broadcas
-000122b0: 745f 6469 6d65 6e73 696f 6e73 2073 686f  t_dimensions sho
-000122c0: 756c 6420 6265 2074 7570 6c65 7320 6f66  uld be tuples of
-000122d0: 2069 6e74 730a 2020 2020 2320 6275 7420   ints.    # but 
-000122e0: 666f 7220 6e6f 7720 6974 2773 2061 2074  for now it's a t
-000122f0: 7570 6c65 206f 6620 4a56 5044 7561 6c73  uple of JVPDuals
-00012300: 0a20 2020 2069 6620 6c65 6e28 7368 6170  .    if len(shap
-00012310: 6529 203e 2030 2061 6e64 2069 7369 6e73  e) > 0 and isins
-00012320: 7461 6e63 6528 7368 6170 655b 305d 2c20  tance(shape[0], 
-00012330: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
-00012340: 2020 7368 6170 652c 205f 203d 2073 6166    shape, _ = saf
-00012350: 655f 7a69 7028 2a73 6861 7065 290a 2020  e_zip(*shape).  
-00012360: 2020 6966 206c 656e 2862 726f 6164 6361    if len(broadca
-00012370: 7374 5f64 696d 656e 7369 6f6e 7329 203e  st_dimensions) >
-00012380: 2030 2061 6e64 2069 7369 6e73 7461 6e63   0 and isinstanc
-00012390: 6528 6272 6f61 6463 6173 745f 6469 6d65  e(broadcast_dime
-000123a0: 6e73 696f 6e73 5b30 5d2c 204a 5650 4475  nsions[0], JVPDu
-000123b0: 616c 293a 0a20 2020 2020 2020 2062 726f  al):.        bro
-000123c0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-000123d0: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
-000123e0: 2a62 726f 6164 6361 7374 5f64 696d 656e  *broadcast_dimen
-000123f0: 7369 6f6e 7329 0a20 2020 2072 6574 7572  sions).    retur
-00012400: 6e20 4a56 5044 7561 6c28 0a20 2020 2020  n JVPDual(.     
-00012410: 2020 2070 7269 6d73 2e62 726f 6164 6361     prims.broadca
-00012420: 7374 5f69 6e5f 6469 6d28 782c 2073 6861  st_in_dim(x, sha
-00012430: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
-00012440: 6d65 6e73 696f 6e73 292c 2070 7269 6d73  mensions), prims
-00012450: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
-00012460: 6d28 7864 2c20 7368 6170 652c 2062 726f  m(xd, shape, bro
-00012470: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00012480: 7329 0a20 2020 2029 0a0a 0a64 6566 2075  s).    )...def u
-00012490: 6e70 6163 6b5f 7365 7175 656e 6365 5f6a  npack_sequence_j
-000124a0: 7670 2873 6571 7565 6e63 653a 204a 5650  vp(sequence: JVP
-000124b0: 4475 616c 2c20 6c65 6e67 7468 3a20 4a56  Dual, length: JV
-000124c0: 5044 7561 6c29 202d 3e20 4a56 5044 7561  PDual) -> JVPDua
-000124d0: 6c3a 0a20 2020 2078 203d 2074 7265 655f  l:.    x = tree_
-000124e0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-000124f0: 7072 696d 616c 2c20 7365 7175 656e 6365  primal, sequence
-00012500: 290a 2020 2020 7864 203d 2074 7265 655f  ).    xd = tree_
-00012510: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-00012520: 7461 6e67 656e 742c 2073 6571 7565 6e63  tangent, sequenc
-00012530: 6529 0a20 2020 206c 656e 6774 682c 205f  e).    length, _
-00012540: 203d 206c 656e 6774 680a 2020 2020 7072   = length.    pr
-00012550: 696d 616c 7320 3d20 7072 696d 732e 756e  imals = prims.un
-00012560: 7061 636b 5f73 6571 7565 6e63 6528 782c  pack_sequence(x,
-00012570: 206c 656e 6774 6829 0a20 2020 2074 616e   length).    tan
-00012580: 6765 6e74 7320 3d20 7072 696d 732e 756e  gents = prims.un
-00012590: 7061 636b 5f73 6571 7565 6e63 6528 7864  pack_sequence(xd
-000125a0: 2c20 6c65 6e67 7468 290a 2020 2020 7265  , length).    re
-000125b0: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
-000125c0: 6972 5f74 6f5f 6a76 705f 6475 616c 2c20  ir_to_jvp_dual, 
-000125d0: 7361 6665 5f7a 6970 2870 7269 6d61 6c73  safe_zip(primals
-000125e0: 2c20 7461 6e67 656e 7473 2929 0a0a 0a64  , tangents))...d
-000125f0: 6566 2075 6e70 6163 6b5f 7472 6976 6961  ef unpack_trivia
-00012600: 6c5f 6a76 7028 783a 204a 5650 4475 616c  l_jvp(x: JVPDual
-00012610: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
-00012620: 2020 7265 7475 726e 2078 0a0a 0a6a 7670    return x...jvp
-00012630: 5f69 6d70 6c73 3a20 6469 6374 5b70 7269  _impls: dict[pri
-00012640: 6d73 2e53 796d 626f 6c2c 2043 616c 6c61  ms.Symbol, Calla
-00012650: 626c 655d 203d 2064 6963 7428 290a 0a6a  ble] = dict()..j
-00012660: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
-00012670: 7269 6d49 4473 2e53 494e 5d20 3d20 7369  rimIDs.SIN] = si
-00012680: 6e5f 6a76 700a 6a76 705f 696d 706c 735b  n_jvp.jvp_impls[
-00012690: 7072 696d 732e 5072 696d 4944 732e 4d55  prims.PrimIDs.MU
-000126a0: 4c5d 203d 206d 756c 5f6a 7670 0a6a 7670  L] = mul_jvp.jvp
-000126b0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-000126c0: 6d49 4473 2e41 4444 5d20 3d20 6164 645f  mIDs.ADD] = add_
-000126d0: 6a76 700a 6a76 705f 696d 706c 735b 7072  jvp.jvp_impls[pr
-000126e0: 696d 732e 5072 696d 4944 732e 4252 4f41  ims.PrimIDs.BROA
-000126f0: 4443 4153 545f 494e 5f44 494d 5d20 3d20  DCAST_IN_DIM] = 
-00012700: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-00012710: 5f6a 7670 0a23 206a 7670 5f69 6d70 6c73  _jvp.# jvp_impls
-00012720: 5b70 7269 6d73 2e50 7269 6d49 4473 2e55  [prims.PrimIDs.U
-00012730: 4e50 4143 4b5f 5345 5155 454e 4345 5d20  NPACK_SEQUENCE] 
-00012740: 3d20 756e 7061 636b 5f73 6571 7565 6e63  = unpack_sequenc
-00012750: 655f 6a76 700a 2320 6a76 705f 696d 706c  e_jvp.# jvp_impl
-00012760: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-00012770: 554e 5041 434b 5f54 5249 5649 414c 5d20  UNPACK_TRIVIAL] 
-00012780: 3d20 756e 7061 636b 5f74 7269 7669 616c  = unpack_trivial
-00012790: 5f6a 7670 0a0a 0a64 6566 206a 7670 5f73  _jvp...def jvp_s
-000127a0: 796d 626f 6c5f 6d61 7070 6572 2873 796d  ymbol_mapper(sym
-000127b0: 626f 6c3a 2070 7269 6d73 2e53 796d 626f  bol: prims.Symbo
-000127c0: 6c29 3a0a 2020 2020 2222 224d 6170 7320  l):.    """Maps 
-000127d0: 6120 7379 6d62 6f6c 2074 6f20 6120 4a56  a symbol to a JV
-000127e0: 5020 6675 6e63 7469 6f6e 2074 6861 7420  P function that 
-000127f0: 6576 616c 7561 7465 7320 6974 2e0a 0a20  evaluates it... 
-00012800: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00012810: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
-00012820: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
-00012830: 6f20 6576 616c 7561 7465 2e0a 0a20 2020  o evaluate...   
-00012840: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-00012850: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-00012860: 7272 6f72 3a20 4966 2074 6865 204a 5650  rror: If the JVP
-00012870: 2066 6f72 2074 6865 2073 796d 626f 6c20   for the symbol 
-00012880: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-00012890: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
-000128a0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-000128b0: 6c65 3a20 4a56 5020 6675 6e63 7469 6f6e  le: JVP function
-000128c0: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
-000128d0: 7468 6520 7379 6d62 6f6c 2e0a 2020 2020  the symbol..    
-000128e0: 2222 220a 0a20 2020 2064 6566 2077 7261  """..    def wra
-000128f0: 705f 6172 6728 7829 3a0a 2020 2020 2020  p_arg(x):.      
-00012900: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012910: 782c 204a 5650 4475 616c 293a 0a20 2020  x, JVPDual):.   
-00012920: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00012930: 780a 2020 2020 2020 2020 656c 6966 2069  x.        elif i
-00012940: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
-00012950: 6265 7229 3a0a 2020 2020 2020 2020 2020  ber):.          
-00012960: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
-00012970: 2878 2c20 7479 7065 2878 2928 3029 290a  (x, type(x)(0)).
-00012980: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012990: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000129a0: 5661 6c75 6545 7272 6f72 2866 224a 5650  ValueError(f"JVP
-000129b0: 2077 7261 705f 6172 6720 676f 7420 616e   wrap_arg got an
-000129c0: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-000129d0: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
-000129e0: 2020 2023 2049 6620 7379 6d62 6f6c 2e61     # If symbol.a
-000129f0: 7267 7320 646f 6573 6e27 7420 6861 7665  rgs doesn't have
-00012a00: 2073 7562 636c 6173 7365 7320 6f66 2056   subclasses of V
-00012a10: 6172 6961 626c 652c 2074 6865 6e20 7765  ariable, then we
-00012a20: 206e 6565 6420 746f 2072 6574 7572 6e20   need to return 
-00012a30: 6120 7a65 726f 2074 616e 6765 6e74 0a20  a zero tangent. 
-00012a40: 2020 2023 2054 4f44 4f3a 2074 6865 7265     # TODO: there
-00012a50: 206d 6179 2062 6520 6120 6265 7474 6572   may be a better
-00012a60: 2077 6179 2074 6f20 6465 7465 6374 2063   way to detect c
-00012a70: 6f6e 7374 616e 7473 2069 6e20 7468 6520  onstants in the 
-00012a80: 7472 6163 650a 2020 2020 6966 2073 796d  trace.    if sym
-00012a90: 626f 6c2e 6172 655f 616c 6c5f 6172 6773  bol.are_all_args
-00012aa0: 5f63 6f6e 7374 616e 743a 0a0a 2020 2020  _constant:..    
-00012ab0: 2020 2020 6465 6620 7a65 726f 735f 6c69      def zeros_li
-00012ac0: 6b65 2878 293a 0a20 2020 2020 2020 2020  ke(x):.         
-00012ad0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00012ae0: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
-00012af0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012b00: 2020 7265 7475 726e 2066 756c 6c5f 6c69    return full_li
-00012b10: 6b65 2878 2c20 6669 6c6c 5f76 616c 7565  ke(x, fill_value
-00012b20: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-00012b30: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00012b40: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
-00012b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b60: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
-00012b70: 616c 7565 2928 3029 0a20 2020 2020 2020  alue)(0).       
-00012b80: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00012b90: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
-00012ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012bb0: 2072 6574 7572 6e20 7479 7065 2878 2928   return type(x)(
-00012bc0: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
-00012bd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012be0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00012bf0: 4572 726f 7228 6622 7a65 726f 735f 6c69  Error(f"zeros_li
-00012c00: 6b65 2069 6e73 6964 6520 4a56 5020 676f  ke inside JVP go
-00012c10: 7420 616e 2075 6e73 7570 706f 7274 6564  t an unsupported
-00012c20: 2074 7970 6520 7b74 7970 6528 7829 7d22   type {type(x)}"
-00012c30: 290a 0a20 2020 2020 2020 2064 6566 206a  )..        def j
-00012c40: 7670 5f69 6d70 6c5f 636f 6e73 7428 7379  vp_impl_const(sy
-00012c50: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
-00012c60: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00012c70: 2020 2020 7072 696d 616c 7320 3d20 7379      primals = sy
-00012c80: 6d62 6f6c 5f74 6f5f 6576 616c 2873 796d  mbol_to_eval(sym
-00012c90: 626f 6c29 282a 6172 6773 2c20 2a2a 6b77  bol)(*args, **kw
-00012ca0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-00012cb0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012cc0: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-00012cd0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00012ce0: 2020 2020 7461 6e67 656e 7473 203d 2074      tangents = t
-00012cf0: 7570 6c65 287a 6572 6f73 5f6c 696b 6528  uple(zeros_like(
-00012d00: 7029 2066 6f72 2070 2069 6e20 7072 696d  p) for p in prim
-00012d10: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
-00012d20: 2020 2020 2072 6574 7572 6e20 7361 6665       return safe
-00012d30: 5f6d 6170 2870 6169 725f 746f 5f6a 7670  _map(pair_to_jvp
-00012d40: 5f64 7561 6c2c 2073 6166 655f 7a69 7028  _dual, safe_zip(
-00012d50: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00012d60: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-00012d70: 7265 7475 726e 204a 5650 4475 616c 2870  return JVPDual(p
-00012d80: 7269 6d61 6c73 2c20 7a65 726f 735f 6c69  rimals, zeros_li
-00012d90: 6b65 2870 7269 6d61 6c73 2929 0a0a 2020  ke(primals))..  
-00012da0: 2020 2020 2020 7265 7475 726e 2070 6172        return par
-00012db0: 7469 616c 286a 7670 5f69 6d70 6c5f 636f  tial(jvp_impl_co
-00012dc0: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
-00012dd0: 2020 2320 4e6f 726d 616c 2063 6173 652c    # Normal case,
-00012de0: 2077 6520 6861 7665 2061 2070 726f 7879   we have a proxy
-00012df0: 2074 616e 6765 6e74 0a20 2020 206a 7670   tangent.    jvp
-00012e00: 5f69 6d70 6c20 3d20 6a76 705f 696d 706c  _impl = jvp_impl
-00012e10: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
-00012e20: 2e69 6429 0a20 2020 2069 6620 6a76 705f  .id).    if jvp_
-00012e30: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
-00012e40: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-00012e50: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-00012e60: 6622 4a56 5020 666f 7220 7b73 796d 626f  f"JVP for {symbo
-00012e70: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
-00012e80: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
-00012e90: 2020 2020 6465 6620 5f6a 7670 5f69 6d70      def _jvp_imp
-00012ea0: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-00012eb0: 7329 3a0a 2020 2020 2020 2020 6172 6773  s):.        args
-00012ec0: 203d 2074 7265 655f 6d61 7028 7772 6170   = tree_map(wrap
-00012ed0: 5f61 7267 2c20 6172 6773 290a 2020 2020  _arg, args).    
-00012ee0: 2020 2020 2320 4578 7065 6374 696e 6720      # Expecting 
-00012ef0: 4a56 5044 7561 6c73 2077 7261 7070 696e  JVPDuals wrappin
-00012f00: 6720 7061 6972 7320 6f66 2070 7269 6d61  g pairs of prima
-00012f10: 6c73 2061 6e64 2074 616e 6765 6e74 730a  ls and tangents.
-00012f20: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-00012f30: 6c6c 2869 7369 6e73 7461 6e63 6528 6172  ll(isinstance(ar
-00012f40: 672c 204a 5650 4475 616c 2920 666f 7220  g, JVPDual) for 
-00012f50: 6172 6720 696e 2074 7265 655f 666c 6174  arg in tree_flat
-00012f60: 7465 6e28 6172 6773 295b 305d 290a 2020  ten(args)[0]).  
-00012f70: 2020 2020 2020 7265 7475 726e 206a 7670        return jvp
-00012f80: 5f69 6d70 6c28 2a61 7267 732c 202a 2a6b  _impl(*args, **k
-00012f90: 7761 7267 7329 0a0a 2020 2020 7265 7475  wargs)..    retu
-00012fa0: 726e 205f 6a76 705f 696d 706c 0a0a 0a64  rn _jvp_impl...d
-00012fb0: 6566 205f 6a76 705f 6361 6c6c 5f6d 6574  ef _jvp_call_met
-00012fc0: 6166 756e 6328 6465 7461 6368 6564 3a20  afunc(detached: 
-00012fd0: 626f 6f6c 2c20 7072 696d 616c 732c 2074  bool, primals, t
-00012fe0: 616e 6765 6e74 732c 202a 2c20 6675 6e63  angents, *, func
-00012ff0: 7469 6f6e 5f74 7261 6365 3a20 5472 6163  tion_trace: Trac
-00013000: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
-00013010: 2020 2222 224d 6574 6166 756e 6374 696f    """Metafunctio
-00013020: 6e20 666f 7220 7468 6520 4a56 5020 7472  n for the JVP tr
-00013030: 616e 7366 6f72 6d2e 0a0a 2020 2020 4172  ansform...    Ar
-00013040: 6773 3a0a 2020 2020 2020 2020 6465 7461  gs:.        deta
-00013050: 6368 6564 2028 626f 6f6c 293a 2057 6865  ched (bool): Whe
-00013060: 7468 6572 2074 6f20 6465 7461 6368 2074  ther to detach t
-00013070: 6865 2074 7261 6365 2e0a 2020 2020 2020  he trace..      
-00013080: 2020 7072 696d 616c 7320 2854 7570 6c65    primals (Tuple
-00013090: 5b50 726f 7879 5d29 3a20 5072 696d 616c  [Proxy]): Primal
-000130a0: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
-000130b0: 2074 616e 6765 6e74 7320 2854 7570 6c65   tangents (Tuple
-000130c0: 5b50 726f 7879 5d29 3a20 5461 6e67 656e  [Proxy]): Tangen
-000130d0: 7420 7661 6c75 6573 2e0a 2020 2020 2020  t values..      
-000130e0: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
-000130f0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-00013100: 6f66 2074 6865 2066 756e 6374 696f 6e20  of the function 
-00013110: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
-00013120: 642e 0a20 2020 2020 2020 206b 7761 7267  d..        kwarg
-00013130: 733a 204b 6579 776f 7264 2061 7267 756d  s: Keyword argum
-00013140: 656e 7473 2e0a 0a20 2020 2052 6169 7365  ents...    Raise
-00013150: 733a 0a20 2020 2020 2020 2041 7373 6572  s:.        Asser
-00013160: 7469 6f6e 4572 726f 723a 2049 6620 7468  tionError: If th
-00013170: 6520 4a56 5020 666f 7220 6b65 7977 6f72  e JVP for keywor
-00013180: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
-00013190: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-000131a0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-000131b0: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
-000131c0: 7468 6520 4a56 5020 7472 616e 7366 6f72  the JVP transfor
-000131d0: 6d2e 0a20 2020 2022 2222 0a20 2020 2061  m..    """.    a
-000131e0: 7373 6572 7420 6c65 6e28 6b77 6172 6773  ssert len(kwargs
-000131f0: 2920 3d3d 2030 2c20 224a 5650 2066 6f72  ) == 0, "JVP for
-00013200: 206b 7761 7267 7320 6973 206e 6f74 2069   kwargs is not i
-00013210: 6d70 6c65 6d65 6e74 6564 220a 0a20 2020  mplemented"..   
-00013220: 2063 7478 203d 2064 6574 6163 6865 645f   ctx = detached_
-00013230: 7472 6163 6528 2920 6966 2064 6574 6163  trace() if detac
-00013240: 6865 6420 656c 7365 206e 756c 6c63 6f6e  hed else nullcon
-00013250: 7465 7874 2829 0a20 2020 2077 6974 6820  text().    with 
-00013260: 6374 783a 0a20 2020 2020 2020 2023 2057  ctx:.        # W
-00013270: 7261 7070 696e 6720 7468 6520 7072 696d  rapping the prim
-00013280: 616c 7320 616e 6420 7461 6e67 656e 7473  als and tangents
-00013290: 2069 6e20 4a56 5044 7561 6c73 2069 7320   in JVPDuals is 
-000132a0: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
-000132b0: 6573 7361 7279 2c20 6275 7420 6974 206d  essary, but it m
-000132c0: 616b 6573 0a20 2020 2020 2020 2023 2074  akes.        # t
-000132d0: 6865 2063 6f64 6520 6d6f 7265 2072 6561  he code more rea
-000132e0: 6461 626c 650a 2020 2020 2020 2020 2320  dable.        # 
-000132f0: 5765 2070 726f 7061 6761 7465 2074 6865  We propagate the
-00013300: 204a 5650 4475 616c 7320 7468 726f 7567   JVPDuals throug
-00013310: 6820 7468 6520 7472 6163 652c 2061 6e64  h the trace, and
-00013320: 2074 6865 6e20 756e 7772 6170 2074 6865   then unwrap the
-00013330: 6d20 6174 2074 6865 2065 6e64 0a20 2020  m at the end.   
-00013340: 2020 2020 2070 7269 6d61 6c73 5f74 616e       primals_tan
-00013350: 6765 6e74 735f 6475 616c 7320 3d20 7361  gents_duals = sa
-00013360: 6665 5f6d 6170 2870 6169 725f 746f 5f6a  fe_map(pair_to_j
-00013370: 7670 5f64 7561 6c2c 2073 6166 655f 7a69  vp_dual, safe_zi
-00013380: 7028 7072 696d 616c 732c 2074 616e 6765  p(primals, tange
-00013390: 6e74 7329 290a 2020 2020 2020 2020 7265  nts)).        re
-000133a0: 7375 6c74 203d 2065 7661 6c5f 7472 6163  sult = eval_trac
-000133b0: 6528 6675 6e63 7469 6f6e 5f74 7261 6365  e(function_trace
-000133c0: 2c20 2a70 7269 6d61 6c73 5f74 616e 6765  , *primals_tange
-000133d0: 6e74 735f 6475 616c 732c 2073 796d 626f  nts_duals, symbo
-000133e0: 6c5f 6d61 7070 6572 3d6a 7670 5f73 796d  l_mapper=jvp_sym
-000133f0: 626f 6c5f 6d61 7070 6572 290a 2020 2020  bol_mapper).    
-00013400: 2020 2020 2320 556e 7772 6170 7069 6e67      # Unwrapping
-00013410: 2074 6865 204a 5650 4475 616c 730a 2020   the JVPDuals.  
-00013420: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00013430: 6e63 6528 7265 7375 6c74 2c20 5365 7175  nce(result, Sequ
-00013440: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-00013450: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
-00013460: 696e 7374 616e 6365 2878 2c20 4a56 5044  instance(x, JVPD
-00013470: 7561 6c29 2066 6f72 2078 2069 6e20 7265  ual) for x in re
-00013480: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00013490: 2020 7072 696d 616c 732c 2074 616e 6765    primals, tange
-000134a0: 6e74 7320 3d20 756e 7a69 7032 2872 6573  nts = unzip2(res
-000134b0: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-000134c0: 2072 6574 7572 6e20 7072 696d 616c 732c   return primals,
-000134d0: 2074 616e 6765 6e74 730a 2020 2020 2020   tangents.      
-000134e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000134f0: 6e63 6528 7265 7375 6c74 2c20 4a56 5044  nce(result, JVPD
-00013500: 7561 6c29 0a20 2020 2020 2020 2072 6574  ual).        ret
-00013510: 7572 6e20 7265 7375 6c74 2e70 7269 6d61  urn result.prima
-00013520: 6c2c 2072 6573 756c 742e 7461 6e67 656e  l, result.tangen
-00013530: 740a 0a0a 6a76 705f 6361 6c6c 203d 2053  t...jvp_call = S
-00013540: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
-00013550: 726d 732e 4a76 704f 702c 206e 616d 653d  rms.JvpOp, name=
-00013560: 226a 7670 5f63 616c 6c22 2c20 6d65 7461  "jvp_call", meta
-00013570: 3d70 6172 7469 616c 285f 6a76 705f 6361  =partial(_jvp_ca
-00013580: 6c6c 5f6d 6574 6166 756e 632c 2046 616c  ll_metafunc, Fal
-00013590: 7365 2929 0a0a 0a64 6566 205f 6964 656e  se))...def _iden
-000135a0: 7469 7479 5f63 616c 6c5f 6a76 7028 2a61  tity_call_jvp(*a
-000135b0: 7267 733a 204a 5650 4475 616c 2c20 7472  rgs: JVPDual, tr
-000135c0: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-000135d0: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
-000135e0: 6c73 2c20 7461 6e67 656e 7473 203d 2075  ls, tangents = u
-000135f0: 6e7a 6970 3228 6172 6773 290a 2020 2020  nzip2(args).    
-00013600: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
-00013610: 5f74 616e 6765 6e74 7320 3d20 5f6a 7670  _tangents = _jvp
-00013620: 5f63 616c 6c5f 6d65 7461 6675 6e63 2846  _call_metafunc(F
-00013630: 616c 7365 2c20 7072 696d 616c 732c 2074  alse, primals, t
-00013640: 616e 6765 6e74 732c 2074 7261 6365 2c20  angents, trace, 
-00013650: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
-00013660: 2069 7369 6e73 7461 6e63 6528 6f75 745f   isinstance(out_
-00013670: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-00013680: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00013690: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-000136a0: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
-000136b0: 6665 5f7a 6970 286f 7574 5f70 7269 6d61  fe_zip(out_prima
-000136c0: 6c73 2c20 6f75 745f 7461 6e67 656e 7473  ls, out_tangents
-000136d0: 2929 0a20 2020 2072 6574 7572 6e20 4a56  )).    return JV
-000136e0: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-000136f0: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
-00013700: 0a0a 0a6a 7670 5f69 6d70 6c73 5b54 7261  ...jvp_impls[Tra
-00013710: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
-00013720: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
-00013730: 6361 6c6c 5f6a 7670 0a0a 0a64 6566 205f  call_jvp...def _
-00013740: 766d 6170 5f63 616c 6c5f 6a76 7028 6172  vmap_call_jvp(ar
-00013750: 6773 3a20 4a56 5044 7561 6c2c 2069 6e5f  gs: JVPDual, in_
-00013760: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
-00013770: 6178 6973 5f73 697a 652c 2074 7261 6365  axis_size, trace
-00013780: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-00013790: 7329 3a0a 2020 2020 7072 696d 616c 732c  s):.    primals,
-000137a0: 2074 616e 6765 6e74 7320 3d20 7361 6665   tangents = safe
-000137b0: 5f7a 6970 282a 6172 6773 290a 2020 2020  _zip(*args).    
-000137c0: 696e 5f64 696d 732c 205f 203d 2073 6166  in_dims, _ = saf
-000137d0: 655f 7a69 7028 2a69 6e5f 6469 6d73 290a  e_zip(*in_dims).
-000137e0: 2020 2020 6f75 745f 6469 6d73 2c20 5f20      out_dims, _ 
-000137f0: 3d20 7361 6665 5f7a 6970 282a 6f75 745f  = safe_zip(*out_
-00013800: 6469 6d73 290a 2020 2020 766d 6170 7065  dims).    vmappe
-00013810: 645f 7472 6163 6520 3d20 636f 6e73 7472  d_trace = constr
-00013820: 7563 745f 7472 6163 6528 2928 0a20 2020  uct_trace()(.   
-00013830: 2020 2020 2076 6d61 7028 7061 7274 6961       vmap(partia
-00013840: 6c28 6576 616c 5f74 7261 6365 2c20 7472  l(eval_trace, tr
-00013850: 6163 6529 2c20 696e 5f64 696d 733d 696e  ace), in_dims=in
-00013860: 5f64 696d 732c 206f 7574 5f64 696d 733d  _dims, out_dims=
-00013870: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
-00013880: 697a 653d 6178 6973 5f73 697a 6529 2c20  ize=axis_size), 
-00013890: 2a70 7269 6d61 6c73 0a20 2020 2029 0a20  *primals.    ). 
-000138a0: 2020 2076 6d61 7070 6564 5f66 756e 6320     vmapped_func 
-000138b0: 3d20 7061 7274 6961 6c28 6576 616c 5f74  = partial(eval_t
-000138c0: 7261 6365 2c20 766d 6170 7065 645f 7472  race, vmapped_tr
-000138d0: 6163 6529 0a20 2020 206f 7574 5f70 7269  ace).    out_pri
-000138e0: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
-000138f0: 7473 203d 206a 7670 2876 6d61 7070 6564  ts = jvp(vmapped
-00013900: 5f66 756e 6329 2870 7269 6d61 6c73 2c20  _func)(primals, 
-00013910: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
-00013920: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
-00013930: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
-00013940: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
-00013950: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
-00013960: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
-00013970: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
-00013980: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
-00013990: 745f 7461 6e67 656e 7473 2929 0a20 2020  t_tangents)).   
-000139a0: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
-000139b0: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
-000139c0: 5f74 616e 6765 6e74 7329 0a0a 0a6a 7670  _tangents)...jvp
-000139d0: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
-000139e0: 732e 566d 6170 4f70 5d20 3d20 5f76 6d61  s.VmapOp] = _vma
-000139f0: 705f 6361 6c6c 5f6a 7670 0a0a 0a64 6566  p_call_jvp...def
-00013a00: 206a 7670 2866 756e 6329 3a0a 2020 2020   jvp(func):.    
-00013a10: 2222 224a 6163 6f62 6961 6e2d 7665 6374  """Jacobian-vect
-00013a20: 6f72 2070 726f 6475 6374 2074 7261 6e73  or product trans
-00013a30: 666f 726d 2066 6f72 2061 2054 6875 6e64  form for a Thund
-00013a40: 6572 2066 756e 6374 696f 6e2e 0a0a 2020  er function...  
-00013a50: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00013a60: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
-00013a70: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
-00013a80: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
-00013a90: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
-00013aa0: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00013ab0: 6c61 626c 653a 2041 2066 756e 6374 696f  lable: A functio
-00013ac0: 6e20 7468 6174 2063 6f6d 7075 7465 7320  n that computes 
-00013ad0: 7468 6520 4a61 636f 6269 616e 2d76 6563  the Jacobian-vec
-00013ae0: 746f 7220 7072 6f64 7563 740a 2020 2020  tor product.    
-00013af0: 2020 2020 2020 2020 7461 6b69 6e67 2070          taking p
-00013b00: 7269 6d61 6c73 2061 6e64 2074 616e 6765  rimals and tange
-00013b10: 6e74 7320 6173 2061 7267 756d 656e 7473  nts as arguments
-00013b20: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-00013b30: 6566 2077 7261 7070 6572 2870 7269 6d61  ef wrapper(prima
-00013b40: 6c73 2c20 7461 6e67 656e 7473 293a 0a20  ls, tangents):. 
-00013b50: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
-00013b60: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
-00013b70: 2866 756e 632c 202a 7072 696d 616c 7329  (func, *primals)
-00013b80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013b90: 6a76 705f 6361 6c6c 2870 7269 6d61 6c73  jvp_call(primals
-00013ba0: 2c20 7461 6e67 656e 7473 2c20 6675 6e63  , tangents, func
-00013bb0: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
-00013bc0: 290a 0a20 2020 2072 6574 7572 6e20 7772  )..    return wr
-00013bd0: 6170 7065 720a 0a0a 2320 544f 444f 2054  apper...# TODO T
-00013be0: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
-00013bf0: 6d65 6e74 6564 206f 7574 2062 6563 6175  mented out becau
-00013c00: 7365 2069 7420 6361 6c6c 7320 6d61 6b65  se it calls make
-00013c10: 5f74 7261 6365 642c 2077 6869 6368 2064  _traced, which d
-00013c20: 6f65 7320 6e6f 7420 6578 6973 740a 2320  oes not exist.# 
-00013c30: 6465 6620 6a76 705f 6561 6765 7228 6675  def jvp_eager(fu
-00013c40: 6e63 2c20 7072 696d 616c 732c 2074 616e  nc, primals, tan
-00013c50: 6765 6e74 732c 2065 7865 6375 746f 723d  gents, executor=
-00013c60: 2274 6f72 6368 2229 3a0a 2320 2020 2020  "torch"):.#     
-00013c70: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
-00013c80: 4a61 636f 6269 616e 2d76 6563 746f 7220  Jacobian-vector 
-00013c90: 7072 6f64 7563 7420 6f66 2061 2054 6875  product of a Thu
-00013ca0: 6e64 6572 2066 756e 6374 696f 6e2e 0a0a  nder function...
-00013cb0: 2320 2020 2020 4172 6773 3a0a 2320 2020  #     Args:.#   
-00013cc0: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
-00013cd0: 6162 6c65 293a 2041 2054 6875 6e64 6572  able): A Thunder
-00013ce0: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
-00013cf0: 7472 616e 7366 6f72 6d65 642e 0a23 2020  transformed..#  
-00013d00: 2020 2020 2020 2070 7269 6d61 6c73 2028         primals (
-00013d10: 5f74 7970 655f 293a 2050 7269 6d61 6c73  _type_): Primals
-00013d20: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-00013d30: 2e0a 2320 2020 2020 2020 2020 7461 6e67  ..#         tang
-00013d40: 656e 7473 2028 5f74 7970 655f 293a 2054  ents (_type_): T
-00013d50: 616e 6765 6e74 7320 6f66 2074 6865 2066  angents of the f
-00013d60: 756e 6374 696f 6e2e 0a23 2020 2020 2020  unction..#      
-00013d70: 2020 2065 7865 6375 746f 7220 2873 7472     executor (str
-00013d80: 2c20 6f70 7469 6f6e 616c 293a 2045 7865  , optional): Exe
-00013d90: 6375 746f 7220 746f 2075 7365 2e20 4465  cutor to use. De
-00013da0: 6661 756c 7473 2074 6f20 2274 6f72 6368  faults to "torch
-00013db0: 222e 0a0a 2320 2020 2020 5265 7475 726e  "...#     Return
-00013dc0: 733a 0a23 2020 2020 2020 2020 2054 6865  s:.#         The
-00013dd0: 2072 6573 756c 7420 6f66 2074 6865 204a   result of the J
-00013de0: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
-00013df0: 726f 6475 6374 2e0a 2320 2020 2020 2222  roduct..#     ""
-00013e00: 220a 2320 2020 2020 7472 6163 6520 3d20  ".#     trace = 
-00013e10: 6d61 6b65 5f74 7261 6365 2866 756e 632c  make_trace(func,
-00013e20: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
-00013e30: 6f72 2c20 2a70 7269 6d61 6c73 290a 0a23  or, *primals)..#
-00013e40: 2020 2020 2064 6566 206a 7670 5f66 756e       def jvp_fun
-00013e50: 6328 2a70 7269 6d61 6c73 5f61 6e64 5f74  c(*primals_and_t
-00013e60: 616e 6765 6e74 7329 3a0a 2320 2020 2020  angents):.#     
-00013e70: 2020 2020 5f70 7269 6d61 6c73 2c20 5f74      _primals, _t
-00013e80: 616e 6765 6e74 7320 3d20 7072 696d 616c  angents = primal
-00013e90: 735f 616e 645f 7461 6e67 656e 7473 5b3a  s_and_tangents[:
-00013ea0: 206c 656e 2870 7269 6d61 6c73 295d 2c20   len(primals)], 
-00013eb0: 7072 696d 616c 735f 616e 645f 7461 6e67  primals_and_tang
-00013ec0: 656e 7473 5b6c 656e 2870 7269 6d61 6c73  ents[len(primals
-00013ed0: 2920 3a5d 0a23 2020 2020 2020 2020 2072  ) :].#         r
-00013ee0: 6574 7572 6e20 5f6a 7670 5f63 616c 6c5f  eturn _jvp_call_
-00013ef0: 6d65 7461 6675 6e63 285f 7072 696d 616c  metafunc(_primal
-00013f00: 732c 205f 7461 6e67 656e 7473 2c20 7472  s, _tangents, tr
-00013f10: 6163 652c 2064 6574 6163 6865 643d 4661  ace, detached=Fa
-00013f20: 6c73 6529 0a0a 2320 2020 2020 6a76 705f  lse)..#     jvp_
-00013f30: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
-00013f40: 6365 286a 7670 5f66 756e 632c 2065 7865  ce(jvp_func, exe
-00013f50: 6375 746f 723d 6578 6563 7574 6f72 2928  cutor=executor)(
-00013f60: 2a70 7269 6d61 6c73 2c20 2a74 616e 6765  *primals, *tange
-00013f70: 6e74 7329 0a23 2020 2020 206a 7670 5f74  nts).#     jvp_t
-00013f80: 7261 6365 6420 3d20 6d61 6b65 5f74 7261  raced = make_tra
-00013f90: 6365 6428 7061 7274 6961 6c28 6576 616c  ced(partial(eval
-00013fa0: 5f74 7261 6365 2c20 6a76 705f 7472 6163  _trace, jvp_trac
-00013fb0: 6529 2c20 6578 6563 7574 6f72 3d65 7865  e), executor=exe
-00013fc0: 6375 746f 7229 0a23 2020 2020 2072 6574  cutor).#     ret
-00013fd0: 7572 6e20 6a76 705f 7472 6163 6564 282a  urn jvp_traced(*
-00013fe0: 7072 696d 616c 732c 202a 7461 6e67 656e  primals, *tangen
-00013ff0: 7473 290a 0a0a 2320 564a 5020 7472 616e  ts)...# VJP tran
-00014000: 7366 6f72 6d0a 2320 3d3d 3d3d 3d3d 3d3d  sform.# ========
-00014010: 3d3d 3d3d 3d0a 4064 6174 6163 6c61 7373  =====.@dataclass
-00014020: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
-00014030: 6173 7320 564a 5044 7561 6c3a 0a20 2020  ass VJPDual:.   
-00014040: 2022 2222 4120 7061 6972 206f 6620 7072   """A pair of pr
-00014050: 696d 616c 2061 6e64 2073 6176 6564 2069  imal and saved i
-00014060: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2062  nformation for b
-00014070: 6163 6b77 6172 6420 2872 6573 6964 7561  ackward (residua
-00014080: 6c73 292e 0a0a 2020 2020 4172 6773 3a0a  ls)...    Args:.
-00014090: 2020 2020 2020 2020 7072 696d 616c 2028          primal (
-000140a0: 556e 696f 6e5b 5072 6f78 792c 204e 756d  Union[Proxy, Num
-000140b0: 6265 725d 293a 2050 7269 6d61 6c20 7661  ber]): Primal va
-000140c0: 6c75 652c 2069 2e65 2e2c 2074 6865 2076  lue, i.e., the v
-000140d0: 616c 7565 2062 6569 6e67 2064 6966 6665  alue being diffe
-000140e0: 7265 6e74 6961 7465 642e 0a20 2020 2020  rentiated..     
-000140f0: 2020 2072 6573 6964 7561 6c73 2028 5475     residuals (Tu
-00014100: 706c 655b 5072 6f78 792c 202e 2e2e 5d29  ple[Proxy, ...])
-00014110: 3a20 5265 7369 6475 616c 732c 2069 2e65  : Residuals, i.e
-00014120: 2e2c 2074 6865 2076 616c 7565 7320 7468  ., the values th
-00014130: 6174 2061 7265 0a20 2020 2020 2020 2020  at are.         
-00014140: 2020 2073 6176 6564 2066 6f72 2074 6865     saved for the
-00014150: 2062 6163 6b77 6172 642e 0a0a 2020 2020   backward...    
-00014160: 5969 656c 6473 3a0a 2020 2020 2020 2020  Yields:.        
-00014170: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
-00014180: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
-00014190: 2e2e 2e5d 2c20 4361 6c6c 6162 6c65 5d3a  ...], Callable]:
-000141a0: 2050 7269 6d61 6c20 616e 6420 7265 7369   Primal and resi
-000141b0: 6475 616c 730a 2020 2020 2222 220a 0a20  duals.    """.. 
-000141c0: 2020 2070 7269 6d61 6c3a 2050 726f 7879     primal: Proxy
-000141d0: 207c 204e 756d 6265 720a 2020 2020 7265   | Number.    re
-000141e0: 7369 6475 616c 733a 2074 7570 6c65 5b50  siduals: tuple[P
-000141f0: 726f 7879 2c20 2e2e 2e5d 0a0a 2020 2020  roxy, ...]..    
-00014200: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
-00014210: 6629 3a0a 2020 2020 2020 2020 7969 656c  f):.        yiel
-00014220: 6420 7365 6c66 2e70 7269 6d61 6c0a 2020  d self.primal.  
-00014230: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
-00014240: 2e72 6573 6964 7561 6c73 0a0a 0a63 6c61  .residuals...cla
-00014250: 7373 204e 6f50 756c 6c62 6163 6b3a 0a20  ss NoPullback:. 
-00014260: 2020 2022 2222 4120 6475 6d6d 7920 7075     """A dummy pu
-00014270: 6c6c 6261 636b 2066 756e 6374 696f 6e20  llback function 
-00014280: 7468 6174 2072 6574 7572 6e73 204e 6f6e  that returns Non
-00014290: 6520 6f72 2072 6169 7365 7320 616e 2065  e or raises an e
-000142a0: 7272 6f72 2e22 2222 0a0a 2020 2020 6465  rror."""..    de
-000142b0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-000142c0: 206e 756d 5f61 7267 733d 3029 3a0a 2020   num_args=0):.  
-000142d0: 2020 2020 2020 7365 6c66 2e6e 756d 5f61        self.num_a
-000142e0: 7267 7320 3d20 6e75 6d5f 6172 6773 0a0a  rgs = num_args..
-000142f0: 2020 2020 6465 6620 5f5f 6361 6c6c 5f5f      def __call__
-00014300: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
-00014310: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00014320: 2069 6620 7365 6c66 2e6e 756d 5f61 7267   if self.num_arg
-00014330: 7320 3e20 303a 0a20 2020 2020 2020 2020  s > 0:.         
-00014340: 2020 2072 6574 7572 6e20 284e 6f6e 652c     return (None,
-00014350: 2920 2a20 7365 6c66 2e6e 756d 5f61 7267  ) * self.num_arg
-00014360: 730a 2020 2020 2020 2020 7261 6973 6520  s.        raise 
-00014370: 5275 6e74 696d 6545 7272 6f72 2822 5075  RuntimeError("Pu
-00014380: 6c6c 6261 636b 2063 616c 6c65 6420 6f6e  llback called on
-00014390: 2061 206e 6f6e 2d64 6966 6665 7265 6e74   a non-different
-000143a0: 6961 626c 6520 7379 6d62 6f6c 206f 7220  iable symbol or 
-000143b0: 6120 636f 6e73 7461 6e74 2e22 290a 0a0a  a constant.")...
-000143c0: 636c 6173 7320 5a65 726f 4261 636b 7761  class ZeroBackwa
-000143d0: 7264 3a0a 2020 2020 2222 2241 2068 656c  rd:.    """A hel
-000143e0: 7065 7220 6261 636b 7761 7264 2066 756e  per backward fun
-000143f0: 6374 696f 6e20 7468 6174 2072 6574 7572  ction that retur
-00014400: 6e73 207a 6572 6f73 2e22 2222 0a0a 2020  ns zeros."""..  
-00014410: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00014420: 656c 662c 206e 756d 5f61 7267 7329 3a0a  elf, num_args):.
-00014430: 2020 2020 2020 2020 7365 6c66 2e6e 756d          self.num
-00014440: 5f61 7267 7320 3d20 6e75 6d5f 6172 6773  _args = num_args
-00014450: 0a0a 2020 2020 6465 6620 5f5f 6361 6c6c  ..    def __call
-00014460: 5f5f 2873 656c 662c 202a 6172 6773 2c20  __(self, *args, 
-00014470: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00014480: 2020 2023 2041 7373 756d 696e 6720 7468     # Assuming th
-00014490: 6174 2074 6865 2066 6972 7374 2061 7267  at the first arg
-000144a0: 756d 656e 7473 2061 7265 2074 6865 2066  uments are the f
-000144b0: 6f72 7761 7264 2061 7267 756d 656e 7473  orward arguments
-000144c0: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-000144d0: 5f61 7267 7320 3d20 6172 6773 5b3a 2073  _args = args[: s
-000144e0: 656c 662e 6e75 6d5f 6172 6773 5d0a 0a20  elf.num_args].. 
-000144f0: 2020 2020 2020 2064 6566 207a 6572 6f73         def zeros
-00014500: 5f6c 696b 6528 7829 3a0a 2020 2020 2020  _like(x):.      
-00014510: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00014520: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-00014530: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-00014540: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
-00014550: 5f6c 696b 6528 782c 2066 696c 6c5f 7661  _like(x, fill_va
-00014560: 6c75 653d 3029 0a20 2020 2020 2020 2020  lue=0).         
-00014570: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00014580: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
-00014590: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
-000145a0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-000145b0: 782e 7661 6c75 6529 2830 290a 2020 2020  x.value)(0).    
-000145c0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-000145d0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-000145e0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000145f0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-00014600: 7829 2830 290a 2020 2020 2020 2020 2020  x)(0).          
-00014610: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014620: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00014630: 6c75 6545 7272 6f72 2866 227a 6572 6f73  lueError(f"zeros
-00014640: 5f6c 696b 6520 696e 7369 6465 205a 6572  _like inside Zer
-00014650: 6f42 6163 6b77 6172 6420 676f 7420 616e  oBackward got an
-00014660: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-00014670: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
-00014680: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
-00014690: 706c 6528 7a65 726f 735f 6c69 6b65 2861  ple(zeros_like(a
-000146a0: 7267 2920 666f 7220 6172 6720 696e 2066  rg) for arg in f
-000146b0: 6f72 7761 7264 5f61 7267 7329 0a0a 0a23  orward_args)...#
-000146c0: 204d 6170 7069 6e67 2066 726f 6d20 7379   Mapping from sy
-000146d0: 6d62 6f6c 7320 746f 2061 7567 6d65 6e74  mbols to augment
-000146e0: 6564 2070 7269 6d61 6c20 2866 6f72 7761  ed primal (forwa
-000146f0: 7264 2920 6675 6e63 7469 6f6e 7320 7573  rd) functions us
-00014700: 6564 2069 6e20 564a 500a 2320 5468 6520  ed in VJP.# The 
-00014710: 6175 676d 656e 7465 645f 7072 696d 616c  augmented_primal
-00014720: 2066 756e 6374 696f 6e20 7461 6b65 7320   function takes 
-00014730: 7468 6520 7072 696d 616c 2076 616c 7565  the primal value
-00014740: 7320 616e 6420 7265 7475 726e 7320 7468  s and returns th
-00014750: 6520 7072 696d 616c 0a23 2072 6573 756c  e primal.# resul
-00014760: 7420 616e 6420 7468 6520 7265 7369 6475  t and the residu
-00014770: 616c 7320 2873 6176 6564 2076 616c 7565  als (saved value
-00014780: 7320 666f 7220 7468 6520 6261 636b 7761  s for the backwa
-00014790: 7264 292e 0a61 7567 6d65 6e74 6564 5f66  rd)..augmented_f
-000147a0: 6f72 7761 7264 5f69 6d70 6c73 203d 207b  orward_impls = {
-000147b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000147c0: 4473 2e41 434f 533a 206c 616d 6264 6120  Ds.ACOS: lambda 
-000147d0: 783a 2028 7072 696d 732e 6163 6f73 2878  x: (prims.acos(x
-000147e0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-000147f0: 696d 732e 5072 696d 4944 732e 4143 4f53  ims.PrimIDs.ACOS
-00014800: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
-00014810: 696d 732e 6163 6f73 6828 7829 2c20 2878  ims.acosh(x), (x
-00014820: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014830: 7269 6d49 4473 2e41 5349 4e3a 206c 616d  rimIDs.ASIN: lam
-00014840: 6264 6120 783a 2028 7072 696d 732e 6173  bda x: (prims.as
-00014850: 696e 2878 292c 2028 782c 2929 2c0a 2020  in(x), (x,)),.  
-00014860: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014870: 4153 494e 483a 206c 616d 6264 6120 783a  ASINH: lambda x:
-00014880: 2028 7072 696d 732e 6173 696e 6828 7829   (prims.asinh(x)
-00014890: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-000148a0: 6d73 2e50 7269 6d49 4473 2e41 5441 4e3a  ms.PrimIDs.ATAN:
-000148b0: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-000148c0: 732e 6174 616e 2878 292c 2028 782c 2929  s.atan(x), (x,))
-000148d0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-000148e0: 4944 732e 4154 414e 483a 206c 616d 6264  IDs.ATANH: lambd
-000148f0: 6120 783a 2028 7072 696d 732e 6174 616e  a x: (prims.atan
-00014900: 6828 7829 2c20 2878 2c29 292c 0a20 2020  h(x), (x,)),.   
-00014910: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014920: 5441 4e32 3a20 6c61 6d62 6461 2078 2c20  TAN2: lambda x, 
-00014930: 793a 2028 7072 696d 732e 6174 616e 3228  y: (prims.atan2(
-00014940: 782c 2079 292c 2028 782c 2079 2929 2c0a  x, y), (x, y)),.
-00014950: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014960: 732e 434f 5348 3a20 6c61 6d62 6461 2078  s.COSH: lambda x
-00014970: 3a20 2870 7269 6d73 2e63 6f73 6828 7829  : (prims.cosh(x)
-00014980: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014990: 6d73 2e50 7269 6d49 4473 2e44 4947 414d  ms.PrimIDs.DIGAM
-000149a0: 4d41 3a20 6c61 6d62 6461 2078 3a20 2870  MA: lambda x: (p
-000149b0: 7269 6d73 2e64 6967 616d 6d61 2878 292c  rims.digamma(x),
-000149c0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-000149d0: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
-000149e0: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-000149f0: 2e65 7266 6328 7829 2c20 2878 2c29 292c  .erfc(x), (x,)),
-00014a00: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014a10: 4473 2e45 5246 494e 563a 206c 616d 6264  Ds.ERFINV: lambd
-00014a20: 6120 783a 2028 7072 696d 732e 6572 6669  a x: (prims.erfi
-00014a30: 6e76 2878 292c 2028 7072 696d 732e 6572  nv(x), (prims.er
-00014a40: 6669 6e76 2878 292c 2929 2c0a 2020 2020  finv(x),)),.    
-00014a50: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
-00014a60: 4643 494e 563a 206c 616d 6264 6120 783a  FCINV: lambda x:
-00014a70: 2028 7072 696d 732e 6572 6663 696e 7628   (prims.erfcinv(
-00014a80: 7829 2c20 2870 7269 6d73 2e65 7266 6369  x), (prims.erfci
-00014a90: 6e76 2878 292c 2929 2c0a 2020 2020 7072  nv(x),)),.    pr
-00014aa0: 696d 732e 5072 696d 4944 732e 4558 5032  ims.PrimIDs.EXP2
-00014ab0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00014ac0: 6d73 2e65 7870 3228 7829 2c20 2870 7269  ms.exp2(x), (pri
-00014ad0: 6d73 2e65 7870 3228 7829 2c29 292c 0a20  ms.exp2(x),)),. 
-00014ae0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014af0: 2e45 5850 4d31 3a20 6c61 6d62 6461 2078  .EXPM1: lambda x
-00014b00: 3a20 2870 7269 6d73 2e65 7870 6d31 2878  : (prims.expm1(x
-00014b10: 292c 2028 7072 696d 732e 6578 706d 3128  ), (prims.expm1(
-00014b20: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
-00014b30: 2e50 7269 6d49 4473 2e4c 4741 4d4d 413a  .PrimIDs.LGAMMA:
-00014b40: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014b50: 732e 6c67 616d 6d61 2878 292c 2028 782c  s.lgamma(x), (x,
-00014b60: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014b70: 696d 4944 732e 4e44 5452 493a 206c 616d  imIDs.NDTRI: lam
-00014b80: 6264 6120 783a 2028 7072 696d 732e 6e64  bda x: (prims.nd
-00014b90: 7472 6928 7829 2c20 2870 7269 6d73 2e6e  tri(x), (prims.n
-00014ba0: 6474 7269 2878 292c 2929 2c0a 2020 2020  dtri(x),)),.    
-00014bb0: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
-00014bc0: 4e48 3a20 6c61 6d62 6461 2078 3a20 2870  NH: lambda x: (p
-00014bd0: 7269 6d73 2e73 696e 6828 7829 2c20 2878  rims.sinh(x), (x
+0000bbb0: 2028 7072 696d 616c 2c29 203d 2062 7379   (primal,) = bsy
+0000bbc0: 6d2e 666c 6174 5f61 7267 730a 2020 2020  m.flat_args.    
+0000bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbe0: 6772 6164 3a20 4e75 6d62 6572 207c 2054  grad: Number | T
+0000bbf0: 656e 736f 7250 726f 7879 203d 2062 7379  ensorProxy = bsy
+0000bc00: 6d2e 6f75 7470 7574 0a0a 2020 2020 2020  m.output..      
+0000bc10: 2020 2020 2020 2020 2020 2020 2020 7670                vp
+0000bc20: 7269 6d61 6c3a 2056 6172 6961 626c 650a  rimal: Variable.
+0000bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc40: 2020 2020 7667 7261 643a 2056 6172 6961      vgrad: Varia
+0000bc50: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+0000bc60: 2020 2020 2020 2020 7670 7269 6d61 6c2c          vprimal,
+0000bc70: 2076 6772 6164 203d 2076 6172 6961 626c   vgrad = variabl
+0000bc80: 6569 6679 2870 7269 6d61 6c29 2c20 7661  eify(primal), va
+0000bc90: 7269 6162 6c65 6966 7928 6772 6164 290a  riableify(grad).
+0000bca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bcb0: 2020 2020 2061 6374 7561 6c5f 6772 6164       actual_grad
+0000bcc0: 3a20 4e6f 6e65 207c 2054 656e 736f 7250  : None | TensorP
+0000bcd0: 726f 7879 203d 2070 7269 6d61 6c73 5f74  roxy = primals_t
+0000bce0: 6f5f 6769 6e70 7574 5f6d 6170 2e67 6574  o_ginput_map.get
+0000bcf0: 2876 7072 696d 616c 2c20 4e6f 6e65 290a  (vprimal, None).
+0000bd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bd10: 2020 2020 2023 204e 4f54 4520 4966 2061       # NOTE If a
+0000bd20: 6374 7561 6c5f 6772 6164 2069 7320 4e6f  ctual_grad is No
+0000bd30: 6e65 2074 6865 6e20 7468 6572 6527 7320  ne then there's 
+0000bd40: 6120 6765 745f 6772 6164 2829 2072 6571  a get_grad() req
+0000bd50: 7565 7374 2066 6f72 2061 2074 656e 736f  uest for a tenso
+0000bd60: 7220 7768 6963 680a 2020 2020 2020 2020  r which.        
+0000bd70: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000bd80: 6861 7320 6e6f 2070 7574 5f67 7261 6428  has no put_grad(
+0000bd90: 292c 2073 6f20 7765 2072 6574 7572 6e20  ), so we return 
+0000bda0: 7a65 726f 7320 666f 7220 7468 6520 6772  zeros for the gr
+0000bdb0: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
+0000bdc0: 2020 2020 2020 2023 2054 4f44 4f20 5265         # TODO Re
+0000bdd0: 7669 7369 7420 7468 6973 202d 2d20 6361  visit this -- ca
+0000bde0: 6e20 7765 2072 656d 6f76 6520 7468 6573  n we remove thes
+0000bdf0: 6520 636f 6d70 7574 6174 696f 6e73 2c20  e computations, 
+0000be00: 6f72 2075 7365 2061 2073 7065 6369 616c  or use a special
+0000be10: 205a 6572 6f54 656e 736f 720a 2020 2020   ZeroTensor.    
+0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be30: 2320 2020 746f 2073 696d 706c 6966 7920  #   to simplify 
+0000be40: 7468 656d 3f0a 2020 2020 2020 2020 2020  them?.          
+0000be50: 2020 2020 2020 2020 2020 6966 2061 6374            if act
+0000be60: 7561 6c5f 6772 6164 2069 7320 4e6f 6e65  ual_grad is None
+0000be70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000be80: 2020 2020 2020 2020 2020 6163 7475 616c            actual
+0000be90: 5f67 7261 6420 3d20 6c74 6f72 6368 2e7a  _grad = ltorch.z
+0000bea0: 6572 6f73 5f6c 696b 6528 7072 696d 616c  eros_like(primal
+0000beb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000bec0: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+0000bed0: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
+0000bee0: 7670 7269 6d61 6c5d 203d 2061 6374 7561  vprimal] = actua
+0000bef0: 6c5f 6772 6164 0a0a 2020 2020 2020 2020  l_grad..        
+0000bf00: 2020 2020 2020 2020 2020 2020 2320 5570              # Up
+0000bf10: 6461 7465 7320 7468 6520 6772 6164 2061  dates the grad a
+0000bf20: 6c69 6173 206d 6170 0a20 2020 2020 2020  lias map.       
+0000bf30: 2020 2020 2020 2020 2020 2020 2076 6163               vac
+0000bf40: 7475 616c 5f67 7261 643a 2056 6172 6961  tual_grad: Varia
+0000bf50: 626c 6520 3d20 7661 7269 6162 6c65 6966  ble = variableif
+0000bf60: 7928 6163 7475 616c 5f67 7261 6429 0a20  y(actual_grad). 
+0000bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf80: 2020 2069 6620 7661 6374 7561 6c5f 6772     if vactual_gr
+0000bf90: 6164 2021 3d20 7667 7261 643a 0a20 2020  ad != vgrad:.   
+0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfb0: 2020 2020 2073 7761 706d 6170 5b76 6772       swapmap[vgr
+0000bfc0: 6164 5d20 3d20 6163 7475 616c 5f67 7261  ad] = actual_gra
+0000bfd0: 640a 0a20 2020 2020 2020 2066 696e 616c  d..        final
+0000bfe0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+0000bff0: 2320 5265 7374 6f72 6573 2073 636f 7065  # Restores scope
+0000c000: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000c010: 6574 5f74 7261 6365 6374 7828 7472 6163  et_tracectx(trac
+0000c020: 6563 7478 5f74 6f6b 290a 0a20 2020 2020  ectx_tok)..     
+0000c030: 2020 2023 2046 696c 7465 7273 2070 7574     # Filters put
+0000c040: 5f67 7261 6420 616e 6420 6765 745f 6772  _grad and get_gr
+0000c050: 6164 206f 7065 7261 7469 6f6e 7320 616e  ad operations an
+0000c060: 6420 6170 706c 6965 7320 7468 6520 7377  d applies the sw
+0000c070: 6170 6d61 700a 2020 2020 2020 2020 6465  apmap.        de
+0000c080: 6620 5f66 696c 7465 7228 6273 796d 3a20  f _filter(bsym: 
+0000c090: 426f 756e 6453 796d 626f 6c29 202d 3e20  BoundSymbol) -> 
+0000c0a0: 626f 6f6c 3a0a 2020 2020 2020 2020 2020  bool:.          
+0000c0b0: 2020 6964 3a20 4861 7368 6162 6c65 203d    id: Hashable =
+0000c0c0: 2062 7379 6d2e 7379 6d2e 6964 0a20 2020   bsym.sym.id.   
+0000c0d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c0e0: 6964 2069 6e20 2870 6964 732e 5055 545f  id in (pids.PUT_
+0000c0f0: 4752 4144 2c20 7069 6473 2e47 4554 5f47  GRAD, pids.GET_G
+0000c100: 5241 4429 0a0a 2020 2020 2020 2020 6772  RAD)..        gr
+0000c110: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
+0000c120: 6f6c 7320 3d20 5b0a 2020 2020 2020 2020  ols = [.        
+0000c130: 2020 2020 6273 796d 2e66 726f 6d5f 6273      bsym.from_bs
+0000c140: 796d 5f73 7761 705f 7072 6f78 6965 7328  ym_swap_proxies(
+0000c150: 7377 6170 6d61 7029 2066 6f72 2062 7379  swapmap) for bsy
+0000c160: 6d20 696e 2067 7261 6474 7263 2e62 6f75  m in gradtrc.bou
+0000c170: 6e64 5f73 796d 626f 6c73 2069 6620 6e6f  nd_symbols if no
+0000c180: 7420 5f66 696c 7465 7228 6273 796d 290a  t _filter(bsym).
+0000c190: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+0000c1a0: 2020 2023 2053 5445 5020 464f 5552 202d     # STEP FOUR -
+0000c1b0: 2d2d 204f 7264 6572 7320 7468 6520 6f70  -- Orders the op
+0000c1c0: 6572 6174 696f 6e73 0a20 2020 2020 2020  erations.       
+0000c1d0: 2023 2054 4f44 4f20 436f 6e73 6964 6572   # TODO Consider
+0000c1e0: 2061 6c74 6572 6e61 7469 7665 2073 6368   alternative sch
+0000c1f0: 6564 756c 696e 6720 616c 676f 7269 7468  eduling algorith
+0000c200: 6d73 2c20 6d61 7962 6520 6279 2075 7369  ms, maybe by usi
+0000c210: 6e67 2067 7261 7068 2066 6561 7475 7265  ng graph feature
+0000c220: 730a 2020 2020 2020 2020 2320 2020 536f  s.        #   So
+0000c230: 6d65 2069 6465 6173 2061 7265 206c 6f6f  me ideas are loo
+0000c240: 6b69 6e67 2061 7420 6d65 6d6f 7279 2d73  king at memory-s
+0000c250: 6176 696e 6720 6e6f 6465 732c 2061 6e64  aving nodes, and
+0000c260: 206e 6f64 6573 2077 6974 6820 6120 6869   nodes with a hi
+0000c270: 6768 2069 6e2d 6465 6772 6565 206f 7220  gh in-degree or 
+0000c280: 6869 6768 206f 7574 2d64 6567 7265 650a  high out-degree.
+0000c290: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0000c2a0: 6573 2061 6e20 696e 6974 6961 6c20 7661  es an initial va
+0000c2b0: 6c69 6420 6f72 6465 7269 6e67 2074 6f20  lid ordering to 
+0000c2c0: 4443 452c 2073 6f20 7468 6174 2061 6464  DCE, so that add
+0000c2d0: 6974 696f 6e61 6c20 6f72 6465 7269 6e67  itional ordering
+0000c2e0: 2061 6e61 6c79 7369 7320 646f 6573 6e27   analysis doesn'
+0000c2f0: 7420 6e65 6564 2074 6f20 636f 6e73 6964  t need to consid
+0000c300: 6572 2061 6c6c 2073 796d 626f 6c73 0a20  er all symbols. 
+0000c310: 2020 2020 2020 2072 6f6f 7473 2c20 6c65         roots, le
+0000c320: 6176 6573 203d 2062 7379 6d5f 6c69 7374  aves = bsym_list
+0000c330: 5f74 6f5f 6461 6728 6772 6164 7472 632e  _to_dag(gradtrc.
+0000c340: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+0000c350: 2020 2020 2020 206f 7264 6572 6564 5f62         ordered_b
+0000c360: 7379 6d73 203d 2074 6f70 6f73 6f72 745f  syms = toposort_
+0000c370: 6273 796d 5f64 6167 2872 6f6f 7473 2c20  bsym_dag(roots, 
+0000c380: 544f 504f 534f 5254 5f4f 5244 4552 2e54  TOPOSORT_ORDER.T
+0000c390: 4f50 5f44 4f57 4e29 0a20 2020 2020 2020  OP_DOWN).       
+0000c3a0: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
+0000c3b0: 796d 626f 6c73 203d 206f 7264 6572 6564  ymbols = ordered
+0000c3c0: 5f62 7379 6d73 0a20 2020 2020 2020 2067  _bsyms.        g
+0000c3d0: 7261 6474 7263 203d 2064 6365 2867 7261  radtrc = dce(gra
+0000c3e0: 6474 7263 290a 0a20 2020 2020 2020 2023  dtrc)..        #
+0000c3f0: 2049 6465 6e74 6966 6965 7320 7468 6520   Identifies the 
+0000c400: 6f72 6465 7220 6f66 2042 6f75 6e64 5379  order of BoundSy
+0000c410: 6d62 6f6c 7320 7573 696e 6720 6120 2244  mbols using a "D
+0000c420: 4653 2061 6e64 2063 6861 696e 2220 616c  FS and chain" al
+0000c430: 676f 7269 7468 6d0a 2020 2020 2020 2020  gorithm.        
+0000c440: 2320 544f 444f 2045 6c61 626f 7261 7465  # TODO Elaborate
+0000c450: 206f 6e20 7468 6973 2061 6c67 6f72 6974   on this algorit
+0000c460: 686d 2061 6e64 2074 6865 2069 6d70 6c65  hm and the imple
+0000c470: 6d65 6e74 6174 696f 6e0a 2020 2020 2020  mentation.      
+0000c480: 2020 726f 6f74 732c 206c 6561 7665 7320    roots, leaves 
+0000c490: 3d20 6273 796d 5f6c 6973 745f 746f 5f64  = bsym_list_to_d
+0000c4a0: 6167 2867 7261 6474 7263 2e62 6f75 6e64  ag(gradtrc.bound
+0000c4b0: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
+0000c4c0: 2020 6368 6563 6b28 0a20 2020 2020 2020    check(.       
+0000c4d0: 2020 2020 206c 656e 286c 6561 7665 7329       len(leaves)
+0000c4e0: 203d 3d20 312c 0a20 2020 2020 2020 2020   == 1,.         
+0000c4f0: 2020 206c 616d 6264 613a 2066 2245 7870     lambda: f"Exp
+0000c500: 6563 7465 6420 6f6e 6c79 206f 6e65 206c  ected only one l
+0000c510: 6561 6620 6e6f 6465 2077 6865 6e20 736f  eaf node when so
+0000c520: 7274 696e 6720 666f 7220 6772 6164 2c20  rting for grad, 
+0000c530: 666f 756e 6420 7468 6572 6520 7765 7265  found there were
+0000c540: 207b 6c65 6e28 6c65 6176 6573 297d 206c   {len(leaves)} l
+0000c550: 6561 7665 7322 2c0a 2020 2020 2020 2020  eaves",.        
+0000c560: 290a 2020 2020 2020 2020 286c 6561 662c  ).        (leaf,
+0000c570: 2920 3d20 6c65 6176 6573 0a0a 2020 2020  ) = leaves..    
+0000c580: 2020 2020 2320 436f 6d70 7574 6573 2074      # Computes t
+0000c590: 6865 2074 656e 736f 7220 6d65 6d6f 7279  he tensor memory
+0000c5a0: 2075 7365 6420 6279 2074 6865 2067 6976   used by the giv
+0000c5b0: 656e 2070 7974 7265 650a 2020 2020 2020  en pytree.      
+0000c5c0: 2020 6465 6620 6d65 6d6f 7279 5f75 7365    def memory_use
+0000c5d0: 6428 7079 7472 6565 2920 2d3e 2069 6e74  d(pytree) -> int
+0000c5e0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
+0000c5f0: 6d6f 7279 5f75 7365 3a20 696e 7420 3d20  mory_use: int = 
+0000c600: 300a 0a20 2020 2020 2020 2020 2020 2064  0..            d
+0000c610: 6566 2063 6f75 6e74 5f6d 656d 6f72 795f  ef count_memory_
+0000c620: 7573 6528 7829 3a0a 2020 2020 2020 2020  use(x):.        
+0000c630: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
+0000c640: 206d 656d 6f72 795f 7573 650a 2020 2020   memory_use.    
+0000c650: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000c660: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
+0000c670: 736f 7250 726f 7879 293a 0a20 2020 2020  sorProxy):.     
+0000c680: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000c690: 656d 6f72 795f 7573 6520 2b3d 2078 2e64  emory_use += x.d
+0000c6a0: 7479 7065 2e5f 6279 7465 7320 2a20 782e  type._bytes * x.
+0000c6b0: 6e75 6d65 6c0a 0a20 2020 2020 2020 2020  numel..         
+0000c6c0: 2020 2074 7265 655f 6d61 7028 636f 756e     tree_map(coun
+0000c6d0: 745f 6d65 6d6f 7279 5f75 7365 2c20 7079  t_memory_use, py
+0000c6e0: 7472 6565 290a 2020 2020 2020 2020 2020  tree).          
+0000c6f0: 2020 7265 7475 726e 206d 656d 6f72 795f    return memory_
+0000c700: 7573 650a 0a20 2020 2020 2020 2023 2054  use..        # T
+0000c710: 7275 6520 7768 656e 2061 206e 6f64 6520  rue when a node 
+0000c720: 6973 2061 2022 6c69 6e6b 2220 2d2d 2061  is a "link" -- a
+0000c730: 206e 6f64 6520 7769 7468 206f 6e6c 7920   node with only 
+0000c740: 6f6e 6520 6368 696c 6420 616e 6420 6174  one child and at
+0000c750: 206d 6f73 7420 6f6e 6520 7061 7265 6e74   most one parent
+0000c760: 0a20 2020 2020 2020 2023 2020 2043 6f6e  .        #   Con
+0000c770: 6365 7074 7561 6c6c 7920 7468 6520 6e6f  ceptually the no
+0000c780: 6465 2069 7320 6120 226c 696e 6b22 2069  de is a "link" i
+0000c790: 6e20 6120 6368 6169 6e20 6f66 206e 6f64  n a chain of nod
+0000c7a0: 6573 206c 696b 6520 4120 2d3e 2042 202d  es like A -> B -
+0000c7b0: 3e20 430a 2020 2020 2020 2020 6465 6620  > C.        def 
+0000c7c0: 6973 5f6c 696e 6b28 6e3a 204e 6f64 6529  is_link(n: Node)
+0000c7d0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+0000c7e0: 2020 2020 2020 5f69 735f 6c69 6e6b 203d        _is_link =
+0000c7f0: 206c 656e 286e 2e63 6869 6c64 7265 6e29   len(n.children)
+0000c800: 203d 3d20 3120 616e 6420 6c65 6e28 6e2e   == 1 and len(n.
+0000c810: 7061 7265 6e74 7329 203c 3d20 310a 2020  parents) <= 1.  
+0000c820: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c830: 205f 6973 5f6c 696e 6b0a 0a20 2020 2020   _is_link..     
+0000c840: 2020 2063 6f75 6e74 6572 3a20 696e 7420     counter: int 
+0000c850: 3d20 300a 0a20 2020 2020 2020 2064 6566  = 0..        def
+0000c860: 205f 6368 6169 6e28 633a 206c 6973 745b   _chain(c: list[
+0000c870: 4e6f 6465 5d2c 2065 6e64 3a20 4e6f 6465  Node], end: Node
+0000c880: 2920 2d3e 206c 6973 745b 4e6f 6465 5d3a  ) -> list[Node]:
+0000c890: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
+0000c8a0: 6c6f 6361 6c20 636f 756e 7465 720a 0a20  local counter.. 
+0000c8b0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0000c8c0: 4f20 4578 7065 7269 6d65 6e74 2077 6974  O Experiment wit
+0000c8d0: 6820 6e6f 7420 616c 7761 7973 2066 7573  h not always fus
+0000c8e0: 696e 6720 7468 6973 2069 6e74 6f20 7468  ing this into th
+0000c8f0: 6520 636f 6e73 756d 6572 202d 2d20 7468  e consumer -- th
+0000c900: 6572 6520 636f 756c 6420 6265 2061 6e0a  ere could be an.
+0000c910: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000c920: 696e 7465 7265 7374 696e 6720 6d69 6e63  interesting minc
+0000c930: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
+0000c940: 204e 4f54 4520 496e 2074 6869 7320 6361   NOTE In this ca
+0000c950: 7365 2074 6865 2063 6861 696e 2063 616e  se the chain can
+0000c960: 6e6f 7420 6265 2065 7874 656e 6465 642c  not be extended,
+0000c970: 2061 6e64 2069 7473 206f 7269 6769 6e20   and its origin 
+0000c980: 6973 2069 6e70 7574 2074 6f20 7468 6520  is input to the 
+0000c990: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+0000c9a0: 2020 2020 2023 2020 2073 6f20 7468 6973       #   so this
+0000c9b0: 206a 7573 7420 6675 7365 7320 6974 2069   just fuses it i
+0000c9c0: 6e74 6f20 7468 6520 636f 6e73 756d 6572  nto the consumer
+0000c9d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000c9e0: 6c65 6e28 656e 642e 7061 7265 6e74 7329  len(end.parents)
+0000c9f0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0000ca00: 2020 2020 2020 2066 6f72 206e 2069 6e20         for n in 
+0000ca10: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+0000ca20: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
+0000ca30: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
+0000ca40: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000ca50: 756e 7465 7220 2b3d 2031 0a20 2020 2020  unter += 1.     
+0000ca60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ca70: 6e20 5b5d 0a0a 2020 2020 2020 2020 2020  n []..          
+0000ca80: 2020 2320 4e4f 5445 206c 656e 2865 6e64    # NOTE len(end
+0000ca90: 2e70 6172 656e 7473 2920 3d3d 2031 206f  .parents) == 1 o
+0000caa0: 6e20 7468 6973 2070 6174 680a 2020 2020  n this path.    
+0000cab0: 2020 2020 2020 2020 2870 6172 656e 742c          (parent,
+0000cac0: 2920 3d20 656e 642e 7061 7265 6e74 730a  ) = end.parents.
+0000cad0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+0000cae0: 7874 656e 6473 2074 6865 2063 6861 696e  xtends the chain
+0000caf0: 2069 6620 7468 6520 7061 7265 6e74 2069   if the parent i
+0000cb00: 7320 6120 6c69 6e6b 0a20 2020 2020 2020  s a link.       
+0000cb10: 2020 2020 2069 6620 6973 5f6c 696e 6b28       if is_link(
+0000cb20: 7061 7265 6e74 293a 0a20 2020 2020 2020  parent):.       
+0000cb30: 2020 2020 2020 2020 2063 2e61 7070 656e           c.appen
+0000cb40: 6428 7061 7265 6e74 290a 2020 2020 2020  d(parent).      
+0000cb50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000cb60: 205f 6368 6169 6e28 632c 2070 6172 656e   _chain(c, paren
+0000cb70: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0000cb80: 2320 4e4f 5445 2049 6e20 7468 6973 2063  # NOTE In this c
+0000cb90: 6173 6520 7468 6520 6368 6169 6e20 6861  ase the chain ha
+0000cba0: 7320 6120 7061 7265 6e74 2074 6861 7420  s a parent that 
+0000cbb0: 6973 206e 6f74 2061 206c 696e 6b0a 2020  is not a link.  
+0000cbc0: 2020 2020 2020 2020 2020 2320 4669 6e64            # Find
+0000cbd0: 7320 7468 6520 6d69 6e63 7574 0a20 2020  s the mincut.   
+0000cbe0: 2020 2020 2020 2020 206d 696e 6375 745f           mincut_
+0000cbf0: 6964 783a 2069 6e74 203d 206c 656e 2863  idx: int = len(c
+0000cc00: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
+0000cc10: 6e5f 6d65 6d6f 7279 5f75 7361 6765 3a20  n_memory_usage: 
+0000cc20: 696e 7420 3d20 6d65 6d6f 7279 5f75 7365  int = memory_use
+0000cc30: 6428 7061 7265 6e74 2e62 7379 6d2e 6f75  d(parent.bsym.ou
+0000cc40: 7470 7574 290a 0a20 2020 2020 2020 2020  tput)..         
+0000cc50: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
+0000cc60: 2065 6e75 6d65 7261 7465 2863 293a 0a20   enumerate(c):. 
+0000cc70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000cc80: 656d 203d 206d 656d 6f72 795f 7573 6564  em = memory_used
+0000cc90: 286e 2e62 7379 6d2e 6f75 7470 7574 290a  (n.bsym.output).
+0000cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccb0: 6966 206d 656d 203c 206d 696e 5f6d 656d  if mem < min_mem
+0000ccc0: 6f72 795f 7573 6167 653a 0a20 2020 2020  ory_usage:.     
+0000ccd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000cce0: 696e 6375 745f 6964 7820 3d20 6964 780a  incut_idx = idx.
+0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd00: 2020 2020 6d69 6e5f 6d65 6d6f 7279 5f75      min_memory_u
+0000cd10: 7361 6765 203d 206d 656d 0a0a 2020 2020  sage = mem..    
+0000cd20: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
+0000cd30: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
+0000cd40: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
+0000cd50: 2020 2020 6966 2069 6478 203c 206d 696e      if idx < min
+0000cd60: 6375 745f 6964 783a 0a20 2020 2020 2020  cut_idx:.       
+0000cd70: 2020 2020 2020 2020 2020 2020 206e 2e6e               n.n
+0000cd80: 756d 6265 7220 3d20 636f 756e 7465 720a  umber = counter.
+0000cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cda0: 2020 2020 636f 756e 7465 7220 2b3d 2031      counter += 1
+0000cdb0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000cdc0: 5265 7475 726e 7320 7468 6520 7072 6f64  Returns the prod
+0000cdd0: 7563 6572 2d73 6964 6520 6368 6169 6e20  ucer-side chain 
+0000cde0: 6375 7420 6966 2069 7420 6578 6973 7473  cut if it exists
+0000cdf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000ce00: 6d69 6e63 7574 5f69 6478 203c 206c 656e  mincut_idx < len
+0000ce10: 2863 293a 0a20 2020 2020 2020 2020 2020  (c):.           
+0000ce20: 2020 2020 2072 6574 7572 6e20 5b63 5b6d       return [c[m
+0000ce30: 696e 6375 745f 6964 785d 5d0a 2020 2020  incut_idx]].    
+0000ce40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ce50: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000ce60: 7365 7274 206d 696e 6375 745f 6964 7820  sert mincut_idx 
+0000ce70: 3d3d 206c 656e 2863 290a 2020 2020 2020  == len(c).      
+0000ce80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000ce90: 2065 6e64 2e70 6172 656e 7473 0a0a 2020   end.parents..  
+0000cea0: 2020 2020 2020 6465 6620 6368 6169 6e5f        def chain_
+0000ceb0: 6f75 7428 6e3a 204e 6f64 652c 2073 7461  out(n: Node, sta
+0000cec0: 636b 3a20 6c69 7374 5b4e 6f64 655d 2920  ck: list[Node]) 
+0000ced0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000cee0: 2020 2020 2023 2053 686f 7274 2d63 6972       # Short-cir
+0000cef0: 6375 6974 7320 6966 2074 6865 206f 7269  cuits if the ori
+0000cf00: 6769 6e61 6c20 6e6f 6465 206e 2063 616e  ginal node n can
+0000cf10: 6e6f 7420 6265 2070 6172 7420 6f66 2061  not be part of a
+0000cf20: 2063 6861 696e 0a20 2020 2020 2020 2020   chain.         
+0000cf30: 2020 2069 6620 6e6f 7420 6973 5f6c 696e     if not is_lin
+0000cf40: 6b28 6e29 3a0a 2020 2020 2020 2020 2020  k(n):.          
+0000cf50: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
+0000cf60: 6e64 286e 290a 2020 2020 2020 2020 2020  nd(n).          
+0000cf70: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0000cf80: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+0000cf90: 2069 735f 6c69 6e6b 286e 2920 3d3d 2054   is_link(n) == T
+0000cfa0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000cfb0: 706f 7374 5f63 6861 696e 3a20 6c69 7374  post_chain: list
+0000cfc0: 5b4e 6f64 655d 203d 205f 6368 6169 6e28  [Node] = _chain(
+0000cfd0: 5b6e 5d2c 206e 290a 0a20 2020 2020 2020  [n], n)..       
+0000cfe0: 2020 2020 2066 6f72 2070 6320 696e 2070       for pc in p
+0000cff0: 6f73 745f 6368 6169 6e3a 0a20 2020 2020  ost_chain:.     
+0000d000: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0000d010: 2e61 7070 656e 6428 7063 290a 0a20 2020  .append(pc)..   
+0000d020: 2020 2020 2073 7461 636b 3a20 6c69 7374       stack: list
+0000d030: 5b4e 6f64 655d 203d 205b 6c65 6166 5d0a  [Node] = [leaf].
+0000d040: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
+0000d050: 6e28 7374 6163 6b29 203e 2030 3a0a 2020  n(stack) > 0:.  
+0000d060: 2020 2020 2020 2020 2020 6e3a 204e 6f64            n: Nod
+0000d070: 6520 3d20 7374 6163 6b2e 706f 7028 290a  e = stack.pop().
+0000d080: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000d090: 6e2e 6e75 6d62 6572 2069 7320 6e6f 7420  n.number is not 
+0000d0a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000d0b0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+0000d0c0: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
+0000d0d0: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
+0000d0e0: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
+0000d0f0: 6572 202b 3d20 310a 0a20 2020 2020 2020  er += 1..       
+0000d100: 2020 2020 2066 6f72 2070 2069 6e20 6e2e       for p in n.
+0000d110: 7061 7265 6e74 733a 0a20 2020 2020 2020  parents:.       
+0000d120: 2020 2020 2020 2020 2063 6861 696e 5f6f           chain_o
+0000d130: 7574 2870 2c20 7374 6163 6b29 0a0a 2020  ut(p, stack)..  
+0000d140: 2020 2020 2020 6465 6620 5f73 656c 6563        def _selec
+0000d150: 746f 7228 656c 6967 6962 6c65 5f6e 6f64  tor(eligible_nod
+0000d160: 6573 3a20 6c69 7374 5b4e 6f64 655d 2920  es: list[Node]) 
+0000d170: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
+0000d180: 2020 2020 6d69 6e5f 6964 783a 2069 6e74      min_idx: int
+0000d190: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0000d1a0: 206d 696e 5f6e 756d 6265 723a 2069 6e74   min_number: int
+0000d1b0: 203d 2065 6c69 6769 626c 655f 6e6f 6465   = eligible_node
+0000d1c0: 735b 305d 2e6e 756d 6265 720a 0a20 2020  s[0].number..   
+0000d1d0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
+0000d1e0: 416c 7468 6f75 6768 2077 6527 7665 2061  Although we've a
+0000d1f0: 6c72 6561 6479 2070 726f 6365 7373 6564  lready processed
+0000d200: 2074 6865 2066 6972 7374 2065 6c65 6d65   the first eleme
+0000d210: 6e74 2068 6572 652c 2074 6869 7320 7374  nt here, this st
+0000d220: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
+0000d230: 2320 2020 656e 756d 6572 6174 6573 2074  #   enumerates t
+0000d240: 6865 2065 6e74 6972 6520 6c69 7374 2063  he entire list c
+0000d250: 2074 6f20 616c 6967 6e20 7468 6520 656e   to align the en
+0000d260: 756d 6572 6174 696f 6e20 6964 7820 7072  umeration idx pr
+0000d270: 6f70 6572 6c79 0a20 2020 2020 2020 2020  operly.         
+0000d280: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
+0000d290: 2065 6e75 6d65 7261 7465 2865 6c69 6769   enumerate(eligi
+0000d2a0: 626c 655f 6e6f 6465 7329 3a0a 2020 2020  ble_nodes):.    
+0000d2b0: 2020 2020 2020 2020 2020 2020 6368 6563              chec
+0000d2c0: 6b28 6e2e 6e75 6d62 6572 2069 7320 6e6f  k(n.number is no
+0000d2d0: 7420 4e6f 6e65 2c20 6c61 6d62 6461 3a20  t None, lambda: 
+0000d2e0: 6622 4578 7065 6374 6564 2065 6163 6820  f"Expected each 
+0000d2f0: 6e6f 6465 2074 6f20 6265 206e 756d 6265  node to be numbe
+0000d300: 7265 642c 2062 7574 207b 6e7d 2077 6173  red, but {n} was
+0000d310: 206e 6f74 2229 0a0a 2020 2020 2020 2020   not")..        
+0000d320: 2020 2020 2020 2020 6966 206e 2e6e 756d          if n.num
+0000d330: 6265 7220 3c20 6d69 6e5f 6e75 6d62 6572  ber < min_number
+0000d340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d350: 2020 2020 2020 6d69 6e5f 6964 7820 3d20        min_idx = 
+0000d360: 6964 780a 2020 2020 2020 2020 2020 2020  idx.            
+0000d370: 2020 2020 2020 2020 6d69 6e5f 6e75 6d62          min_numb
+0000d380: 6572 203d 206e 2e6e 756d 6265 720a 0a20  er = n.number.. 
+0000d390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d3a0: 6e20 6d69 6e5f 6964 780a 0a20 2020 2020  n min_idx..     
+0000d3b0: 2020 2073 6f72 7465 645f 6273 796d 7320     sorted_bsyms 
+0000d3c0: 3d20 746f 706f 736f 7274 5f62 7379 6d5f  = toposort_bsym_
+0000d3d0: 6461 6728 6c65 6176 6573 2c20 746f 706f  dag(leaves, topo
+0000d3e0: 736f 7274 5f6f 7264 6572 3d54 4f50 4f53  sort_order=TOPOS
+0000d3f0: 4f52 545f 4f52 4445 522e 424f 5454 4f4d  ORT_ORDER.BOTTOM
+0000d400: 5f55 502c 2073 656c 6563 746f 723d 5f73  _UP, selector=_s
+0000d410: 656c 6563 746f 7229 0a20 2020 2020 2020  elector).       
+0000d420: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
+0000d430: 796d 626f 6c73 203d 2073 6f72 7465 645f  ymbols = sorted_
+0000d440: 6273 796d 730a 2020 2020 2020 2020 6772  bsyms.        gr
+0000d450: 6164 7472 6320 3d20 6463 6528 6772 6164  adtrc = dce(grad
+0000d460: 7472 6329 0a0a 2020 2020 2020 2020 2320  trc)..        # 
+0000d470: 544f 444f 2043 6f6e 7369 6465 7220 686f  TODO Consider ho
+0000d480: 7720 746f 2068 616e 646c 6520 6772 6164  w to handle grad
+0000d490: 2077 2e72 2e74 2e20 6f6e 6c79 2073 6f6d   w.r.t. only som
+0000d4a0: 6520 6f75 7470 7574 7320 2d2d 2073 686f  e outputs -- sho
+0000d4b0: 756c 6420 616c 6c20 6772 6164 0a20 2020  uld all grad.   
+0000d4c0: 2020 2020 2023 2020 206f 7065 7261 7469       #   operati
+0000d4d0: 6f6e 7320 7573 696e 6720 7468 6520 6f74  ons using the ot
+0000d4e0: 6865 7220 6f75 7470 7574 2062 6520 7265  her output be re
+0000d4f0: 6d6f 7665 643f 2057 6861 7420 6b69 6e64  moved? What kind
+0000d500: 206f 6620 6173 7375 6d70 7469 6f6e 2064   of assumption d
+0000d510: 6f65 7320 7468 6174 0a20 2020 2020 2020  oes that.       
+0000d520: 2023 2020 206d 616b 6520 6162 6f75 7420   #   make about 
+0000d530: 7468 6520 6772 6164 2073 7472 7563 7475  the grad structu
+0000d540: 7265 3f20 5072 6f62 6162 6c79 2073 6f6d  re? Probably som
+0000d550: 6520 6b69 6e64 206f 6620 696e 6465 7065  e kind of indepe
+0000d560: 6e64 656e 6365 2061 7373 756d 7074 696f  ndence assumptio
+0000d570: 6e3f 2041 7265 0a20 2020 2020 2020 2023  n? Are.        #
+0000d580: 2020 2074 6865 7265 2070 7261 6374 6963     there practic
+0000d590: 616c 2065 7861 6d70 6c65 7320 7768 6572  al examples wher
+0000d5a0: 6520 7468 6174 2773 2061 6e20 6973 7375  e that's an issu
+0000d5b0: 653f 0a0a 2020 2020 2020 2020 656e 645f  e?..        end_
+0000d5c0: 7469 6d65 5f6e 7320 3d20 7469 6d65 2e74  time_ns = time.t
+0000d5d0: 696d 655f 6e73 2829 0a20 2020 2020 2020  ime_ns().       
+0000d5e0: 2065 6c61 7073 6564 5f74 696d 655f 6e73   elapsed_time_ns
+0000d5f0: 203d 2065 6e64 5f74 696d 655f 6e73 202d   = end_time_ns -
+0000d600: 2073 7461 7274 5f74 696d 655f 6e73 0a20   start_time_ns. 
+0000d610: 2020 2020 2020 2065 6c61 7073 6564 5f74         elapsed_t
+0000d620: 696d 655f 6d69 6c6c 6973 203d 2065 6c61  ime_millis = ela
+0000d630: 7073 6564 5f74 696d 655f 6e73 202f 2f20  psed_time_ns // 
+0000d640: 3130 3030 3030 300a 2020 2020 2020 2020  1000000.        
+0000d650: 6772 6164 7472 632e 7365 745f 7072 6f76  gradtrc.set_prov
+0000d660: 656e 616e 6365 2854 7261 6365 5072 6f76  enance(TraceProv
+0000d670: 656e 616e 6365 2866 2247 7261 6420 2874  enance(f"Grad (t
+0000d680: 6f6f 6b20 7b65 6c61 7073 6564 5f74 696d  ook {elapsed_tim
+0000d690: 655f 6d69 6c6c 6973 7d20 6d69 6c6c 6973  e_millis} millis
+0000d6a0: 6563 6f6e 6473 2922 2929 0a0a 2020 2020  econds)"))..    
+0000d6b0: 2020 2020 7265 7475 726e 2067 7261 6474      return gradt
+0000d6c0: 7263 0a0a 2020 2020 2320 4e4f 5445 2054  rc..    # NOTE T
+0000d6d0: 6869 7320 6973 2061 206b 6c75 6467 6520  his is a kludge 
+0000d6e0: 746f 2069 6e64 6963 6174 6520 7468 6174  to indicate that
+0000d6f0: 2077 6520 7368 6f75 6c64 6e27 7420 7573   we shouldn't us
+0000d700: 6520 5079 546f 7263 6827 7320 6175 746f  e PyTorch's auto
+0000d710: 6772 6164 2062 6563 6175 7365 0a20 2020  grad because.   
+0000d720: 2023 2020 2077 6527 7265 2075 7369 6e67   #   we're using
+0000d730: 206f 7572 206f 776e 2061 7574 6f67 7261   our own autogra
+0000d740: 6420 7472 616e 7366 6f72 6d0a 2020 2020  d transform.    
+0000d750: 6366 6e2e 5f75 7369 6e67 5f67 7261 645f  cfn._using_grad_
+0000d760: 7472 616e 7366 6f72 6d20 3d20 5472 7565  transform = True
+0000d770: 0a0a 2020 2020 7265 7475 726e 2061 6464  ..    return add
+0000d780: 5f74 7261 6e73 666f 726d 2863 666e 2c20  _transform(cfn, 
+0000d790: 7472 616e 7366 6f72 6d3d 5f67 7261 645f  transform=_grad_
+0000d7a0: 7472 616e 7366 6f72 6d2c 2064 6973 6162  transform, disab
+0000d7b0: 6c65 5f74 6f72 6368 5f61 7574 6f67 7261  le_torch_autogra
+0000d7c0: 645f 7375 7070 6f72 743d 5472 7565 290a  d_support=True).
+0000d7d0: 0a0a 6465 6620 6772 6164 280a 2020 2020  ..def grad(.    
+0000d7e0: 6366 6e2c 0a29 202d 3e20 4361 6c6c 6162  cfn,.) -> Callab
+0000d7f0: 6c65 3a0a 2020 2020 6465 6620 6772 6164  le:.    def grad
+0000d800: 2866 756e 6329 3a0a 0a20 2020 2020 2020  (func):..       
+0000d810: 2040 7772 6170 7328 6675 6e63 290a 2020   @wraps(func).  
+0000d820: 2020 2020 2020 6465 6620 6772 6164 5f66        def grad_f
+0000d830: 756e 6328 2a61 7267 732c 202a 2a6b 7761  unc(*args, **kwa
+0000d840: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
+0000d850: 2020 5f2c 2067 7261 6473 203d 2076 616c    _, grads = val
+0000d860: 7565 5f61 6e64 5f67 7261 6428 6675 6e63  ue_and_grad(func
+0000d870: 2928 2a61 7267 732c 202a 2a6b 7761 7267  )(*args, **kwarg
+0000d880: 7329 0a20 2020 2020 2020 2020 2020 2067  s).            g
+0000d890: 7261 6473 203d 2074 7265 655f 666c 6174  rads = tree_flat
+0000d8a0: 7465 6e28 6772 6164 7329 5b30 5d0a 2020  ten(grads)[0].  
+0000d8b0: 2020 2020 2020 2020 2020 6772 6164 7320            grads 
+0000d8c0: 3d20 5b67 2066 6f72 2067 2069 6e20 6772  = [g for g in gr
+0000d8d0: 6164 7320 6966 2067 2069 7320 6e6f 7420  ads if g is not 
+0000d8e0: 4e6f 6e65 5d0a 2020 2020 2020 2020 2020  None].          
+0000d8f0: 2020 7265 7475 726e 2067 7261 6473 0a0a    return grads..
+0000d900: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0000d910: 7261 645f 6675 6e63 0a0a 2020 2020 6465  rad_func..    de
+0000d920: 6620 5f67 7261 645f 7472 616e 7366 6f72  f _grad_transfor
+0000d930: 6d28 7472 633a 2054 7261 6365 2c20 2a2c  m(trc: Trace, *,
+0000d940: 2065 7865 6375 746f 7273 5f6c 6973 743a   executors_list:
+0000d950: 2053 6571 7565 6e63 655b 416e 795d 2920   Sequence[Any]) 
+0000d960: 2d3e 2054 7261 6365 3a0a 2020 2020 2020  -> Trace:.      
+0000d970: 2020 2320 5573 696e 6720 7472 632e 7079    # Using trc.py
+0000d980: 7468 6f6e 5f63 616c 6c61 626c 6528 2920  thon_callable() 
+0000d990: 6d61 6b65 7320 6974 2069 6d70 6f73 7369  makes it impossi
+0000d9a0: 626c 6520 746f 2072 6574 7261 6365 2074  ble to retrace t
+0000d9b0: 6865 0a20 2020 2020 2020 2023 2066 756e  he.        # fun
+0000d9c0: 6374 696f 6e20 6265 6361 7573 6520 7468  ction because th
+0000d9d0: 6520 7079 7468 6f6e 5f63 616c 6c61 626c  e python_callabl
+0000d9e0: 6520 7573 6573 2070 7974 686f 6e5f 6374  e uses python_ct
+0000d9f0: 7820 7768 6963 6820 7265 706c 6163 6573  x which replaces
+0000da00: 0a20 2020 2020 2020 2023 2073 796d 626f  .        # symbo
+0000da10: 6c20 6f63 6375 7272 656e 6365 7320 7769  l occurrences wi
+0000da20: 7468 2069 7473 2073 796d 626f 6c2e 5f63  th its symbol._c
+0000da30: 616c 6c5f 6374 7820 6675 6e63 7469 6f6e  all_ctx function
+0000da40: 0a20 2020 2020 2020 2040 7772 6170 7328  .        @wraps(
+0000da50: 7472 632e 7079 7468 6f6e 5f63 616c 6c61  trc.python_calla
+0000da60: 626c 6528 2929 0a20 2020 2020 2020 2064  ble()).        d
+0000da70: 6566 2070 7974 686f 6e5f 6361 6c6c 6162  ef python_callab
+0000da80: 6c65 282a 6172 6773 2c20 2a2a 6b77 6172  le(*args, **kwar
+0000da90: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
+0000daa0: 2072 6574 7572 6e20 6576 616c 5f74 7261   return eval_tra
+0000dab0: 6365 2874 7263 2c20 2a61 7267 732c 202a  ce(trc, *args, *
+0000dac0: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
+0000dad0: 2020 6772 6164 7472 6320 3d20 636f 6e73    gradtrc = cons
+0000dae0: 7472 7563 745f 7472 6163 6528 2928 6772  truct_trace()(gr
+0000daf0: 6164 2870 7974 686f 6e5f 6361 6c6c 6162  ad(python_callab
+0000db00: 6c65 292c 202a 7472 632e 6172 6773 2c20  le), *trc.args, 
+0000db10: 2a2a 7472 632e 6b77 6172 6773 290a 2020  **trc.kwargs).  
+0000db20: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+0000db30: 6474 7263 0a0a 2020 2020 6366 6e2e 5f75  dtrc..    cfn._u
+0000db40: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
+0000db50: 6f72 6d20 3d20 5472 7565 0a20 2020 2072  orm = True.    r
+0000db60: 6574 7572 6e20 6164 645f 7472 616e 7366  eturn add_transf
+0000db70: 6f72 6d28 6366 6e2c 2074 7261 6e73 666f  orm(cfn, transfo
+0000db80: 726d 3d5f 6772 6164 5f74 7261 6e73 666f  rm=_grad_transfo
+0000db90: 726d 2c20 6469 7361 626c 655f 746f 7263  rm, disable_torc
+0000dba0: 685f 6175 746f 6772 6164 5f73 7570 706f  h_autograd_suppo
+0000dbb0: 7274 3d54 7275 6529 0a0a 0a63 6c61 7373  rt=True)...class
+0000dbc0: 2054 7261 6e73 666f 726d 7328 456e 756d   Transforms(Enum
+0000dbd0: 293a 0a20 2020 2049 6465 6e74 6974 794f  ):.    IdentityO
+0000dbe0: 7020 3d20 6175 746f 2829 0a20 2020 2056  p = auto().    V
+0000dbf0: 6d61 704f 7020 3d20 6175 746f 2829 0a20  mapOp = auto(). 
+0000dc00: 2020 204a 7670 4f70 203d 2061 7574 6f28     JvpOp = auto(
+0000dc10: 290a 2020 2020 566a 704f 7020 3d20 6175  ).    VjpOp = au
+0000dc20: 746f 2829 0a0a 0a40 6c72 755f 6361 6368  to()...@lru_cach
+0000dc30: 6528 6d61 7873 697a 653d 4e6f 6e65 290a  e(maxsize=None).
+0000dc40: 6465 6620 7379 6d62 6f6c 5f74 6f5f 6576  def symbol_to_ev
+0000dc50: 616c 2862 6f75 6e64 5f73 796d 626f 6c29  al(bound_symbol)
+0000dc60: 3a0a 2020 2020 2222 224d 6170 2061 2042  :.    """Map a B
+0000dc70: 6f75 6e64 5379 6d62 6f6c 2074 6f20 6120  oundSymbol to a 
+0000dc80: 6675 6e63 7469 6f6e 2074 6861 7420 6576  function that ev
+0000dc90: 616c 7561 7465 7320 6974 2e0a 0a20 2020  aluates it...   
+0000dca0: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
+0000dcb0: 6f75 6e64 5f73 796d 626f 6c3a 2042 6f75  ound_symbol: Bou
+0000dcc0: 6e64 5379 6d62 6f6c 2074 6f20 6d61 700a  ndSymbol to map.
+0000dcd0: 2020 2020 2222 220a 2020 2020 2320 5379      """.    # Sy
+0000dce0: 6d62 6f6c 2069 7320 6361 6c6c 6162 6c65  mbol is callable
+0000dcf0: 0a20 2020 2072 6574 7572 6e20 626f 756e  .    return boun
+0000dd00: 645f 7379 6d62 6f6c 2e73 796d 0a0a 0a23  d_symbol.sym...#
+0000dd10: 2054 4f44 4f3a 2043 7572 7265 6e74 6c79   TODO: Currently
+0000dd20: 2077 6520 7573 6520 7472 6163 652e 6172   we use trace.ar
+0000dd30: 6773 2061 6e64 2074 7261 6365 2e6b 7761  gs and trace.kwa
+0000dd40: 7267 7320 746f 2067 6574 2074 6865 2061  rgs to get the a
+0000dd50: 7267 756d 656e 7473 0a23 204d 6179 6265  rguments.# Maybe
+0000dd60: 2077 6520 7368 6f75 6c64 2075 7365 2074   we should use t
+0000dd70: 6865 7365 2069 6e73 7465 6164 0a74 7261  hese instead.tra
+0000dd80: 6e73 666f 726d 5f73 6b69 705f 6c69 7374  nsform_skip_list
+0000dd90: 203d 2028 0a20 2020 2070 7269 6d73 2e50   = (.    prims.P
+0000dda0: 7269 6d49 4473 2e55 4e50 4143 4b5f 454d  rimIDs.UNPACK_EM
+0000ddb0: 5054 595f 4449 4354 2c0a 2020 2020 7072  PTY_DICT,.    pr
+0000ddc0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+0000ddd0: 434b 5f4b 4559 2c0a 2020 2020 7072 696d  CK_KEY,.    prim
+0000dde0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+0000ddf0: 5f53 4551 5545 4e43 452c 0a20 2020 2070  _SEQUENCE,.    p
+0000de00: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
+0000de10: 4143 4b5f 5452 4956 4941 4c2c 0a20 2020  ACK_TRIVIAL,.   
+0000de20: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
+0000de30: 4554 5552 4e2c 0a29 0a0a 0a64 6566 2065  ETURN,.)...def e
+0000de40: 7661 6c5f 7472 6163 6528 7472 6163 652c  val_trace(trace,
+0000de50: 202a 6172 6773 2c20 7379 6d62 6f6c 5f6d   *args, symbol_m
+0000de60: 6170 7065 723d 7379 6d62 6f6c 5f74 6f5f  apper=symbol_to_
+0000de70: 6576 616c 2c20 7769 7468 5f65 6e76 3d46  eval, with_env=F
+0000de80: 616c 7365 2c20 2a2a 6b77 6172 6773 293a  alse, **kwargs):
+0000de90: 0a20 2020 2022 2222 4576 616c 7561 7465  .    """Evaluate
+0000dea0: 2061 2074 7261 6365 2e0a 0a20 2020 2041   a trace...    A
+0000deb0: 7267 733a 0a20 2020 2020 2020 2074 7261  rgs:.        tra
+0000dec0: 6365 3a20 7472 6163 6520 746f 2065 7661  ce: trace to eva
+0000ded0: 6c75 6174 650a 2020 2020 2020 2020 2a61  luate.        *a
+0000dee0: 7267 733a 2061 7267 756d 656e 7473 2074  rgs: arguments t
+0000def0: 6f20 6576 616c 7561 7465 2074 6865 2074  o evaluate the t
+0000df00: 7261 6365 2077 6974 680a 2020 2020 2020  race with.      
+0000df10: 2020 7379 6d62 6f6c 5f6d 6170 7065 723a    symbol_mapper:
+0000df20: 2066 756e 6374 696f 6e20 7468 6174 206d   function that m
+0000df30: 6170 7320 6120 7379 6d62 6f6c 2074 6f20  aps a symbol to 
+0000df40: 6120 6675 6e63 7469 6f6e 2074 6861 7420  a function that 
+0000df50: 6576 616c 7561 7465 7320 6974 0a20 2020  evaluates it.   
+0000df60: 2020 2020 202a 2a6b 7761 7267 733a 206b       **kwargs: k
+0000df70: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
+0000df80: 2074 6f20 6576 616c 7561 7465 2074 6865   to evaluate the
+0000df90: 2074 7261 6365 2077 6974 680a 0a20 2020   trace with..   
+0000dfa0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000dfb0: 2020 7265 7375 6c74 206f 6620 6576 616c    result of eval
+0000dfc0: 7561 7469 6e67 2074 6865 2074 7261 6365  uating the trace
+0000dfd0: 0a20 2020 2022 2222 0a20 2020 2065 6e76  .    """.    env
+0000dfe0: 203d 207b 7d0a 0a20 2020 2064 6566 2072   = {}..    def r
+0000dff0: 6561 6428 783a 2056 6172 6961 626c 6529  ead(x: Variable)
+0000e000: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0000e010: 6e73 7461 6e63 6528 782c 2056 6172 6961  nstance(x, Varia
+0000e020: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
+0000e030: 2020 7265 7475 726e 2065 6e76 5b78 2e6e    return env[x.n
+0000e040: 616d 655d 0a20 2020 2020 2020 2065 6c73  ame].        els
+0000e050: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000e060: 6574 7572 6e20 780a 0a20 2020 2064 6566  eturn x..    def
+0000e070: 2077 7269 7465 2876 3a20 5661 7269 6162   write(v: Variab
+0000e080: 6c65 2c20 7661 6c3a 2041 6e79 2c20 616c  le, val: Any, al
+0000e090: 6c6f 775f 6475 706c 6963 6174 6573 3d46  low_duplicates=F
+0000e0a0: 616c 7365 2920 2d3e 204e 6f6e 653a 0a20  alse) -> None:. 
+0000e0b0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0000e0c0: 696e 7374 616e 6365 2876 2c20 5661 7269  instance(v, Vari
+0000e0d0: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
+0000e0e0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0000e0f0: 2020 2320 4475 706c 6963 6174 6573 2061    # Duplicates a
+0000e100: 7265 2061 6c6c 6f77 6564 2061 6e64 206f  re allowed and o
+0000e110: 7665 7277 7269 7474 656e 0a20 2020 2020  verwritten.     
+0000e120: 2020 2069 6620 762e 6e61 6d65 2069 6e20     if v.name in 
+0000e130: 656e 763a 0a20 2020 2020 2020 2020 2020  env:.           
+0000e140: 2069 6620 616c 6c6f 775f 6475 706c 6963   if allow_duplic
+0000e150: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
+0000e160: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000e170: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0000e180: 616c 7565 4572 726f 7228 6622 5661 7269  alueError(f"Vari
+0000e190: 6162 6c65 207b 762e 6e61 6d65 7d20 6973  able {v.name} is
+0000e1a0: 2062 6569 6e67 206f 7665 7277 7269 7474   being overwritt
+0000e1b0: 656e 2074 6869 7320 6973 206e 6f74 2061  en this is not a
+0000e1c0: 6c6c 6f77 6564 2229 0a20 2020 2020 2020  llowed").       
+0000e1d0: 2065 6e76 5b76 2e6e 616d 655d 203d 2076   env[v.name] = v
+0000e1e0: 616c 0a0a 2020 2020 7361 6665 5f6d 6170  al..    safe_map
+0000e1f0: 5f66 6c61 7428 7772 6974 652c 206c 6973  _flat(write, lis
+0000e200: 7428 7472 6163 652e 6172 6773 292c 206c  t(trace.args), l
+0000e210: 6973 7428 6172 6773 2929 0a20 2020 2073  ist(args)).    s
+0000e220: 6166 655f 6d61 705f 666c 6174 2877 7269  afe_map_flat(wri
+0000e230: 7465 2c20 6c69 7374 2874 7261 6365 2e6b  te, list(trace.k
+0000e240: 7761 7267 732e 7661 6c75 6573 2829 292c  wargs.values()),
+0000e250: 206c 6973 7428 6b77 6172 6773 2e76 616c   list(kwargs.val
+0000e260: 7565 7328 2929 290a 0a20 2020 2066 6f72  ues()))..    for
+0000e270: 2073 796d 626f 6c20 696e 2074 7261 6365   symbol in trace
+0000e280: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
+0000e290: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
+0000e2a0: 6c2e 7379 6d2e 6964 2069 6e20 7472 616e  l.sym.id in tran
+0000e2b0: 7366 6f72 6d5f 736b 6970 5f6c 6973 743a  sform_skip_list:
+0000e2c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000e2d0: 7469 6e75 650a 2020 2020 2020 2020 6172  tinue.        ar
+0000e2e0: 6773 203d 2074 7265 655f 6d61 7028 7265  gs = tree_map(re
+0000e2f0: 6164 2c20 7379 6d62 6f6c 2e61 7267 7329  ad, symbol.args)
+0000e300: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
+0000e310: 3d20 7472 6565 5f6d 6170 2872 6561 642c  = tree_map(read,
+0000e320: 2073 796d 626f 6c2e 6b77 6172 6773 290a   symbol.kwargs).
+0000e330: 2020 2020 2020 2020 7072 696d 5f66 756e          prim_fun
+0000e340: 6320 3d20 7379 6d62 6f6c 5f6d 6170 7065  c = symbol_mappe
+0000e350: 7228 7379 6d62 6f6c 290a 2020 2020 2020  r(symbol).      
+0000e360: 2020 6966 2070 7269 6d5f 6675 6e63 2069    if prim_func i
+0000e370: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000e380: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0000e390: 2020 2020 2072 6573 756c 7420 3d20 7072       result = pr
+0000e3a0: 696d 5f66 756e 6328 2a61 7267 732c 202a  im_func(*args, *
+0000e3b0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+0000e3c0: 2073 6166 655f 6d61 705f 666c 6174 2877   safe_map_flat(w
+0000e3d0: 7269 7465 2c20 6c69 7374 2873 6571 7565  rite, list(seque
+0000e3e0: 6e63 6966 7928 7379 6d62 6f6c 2e6f 7574  ncify(symbol.out
+0000e3f0: 7075 7429 292c 206c 6973 7428 7365 7175  put)), list(sequ
+0000e400: 656e 6369 6679 2872 6573 756c 7429 2929  encify(result)))
+0000e410: 0a0a 2020 2020 6966 2077 6974 685f 656e  ..    if with_en
+0000e420: 763a 0a20 2020 2020 2020 2072 6574 7572  v:.        retur
+0000e430: 6e20 7472 6565 5f6d 6170 2872 6561 642c  n tree_map(read,
+0000e440: 2074 7261 6365 2e6f 7574 7075 7429 2c20   trace.output), 
+0000e450: 656e 760a 0a20 2020 2072 6574 7572 6e20  env..    return 
+0000e460: 7472 6565 5f6d 6170 2872 6561 642c 2074  tree_map(read, t
+0000e470: 7261 6365 2e6f 7574 7075 7429 0a0a 0a64  race.output)...d
+0000e480: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
+0000e490: 6c5f 6d65 7461 6675 6e63 282a 6172 6773  l_metafunc(*args
+0000e4a0: 2c20 7472 6163 653a 2054 7261 6365 2c20  , trace: Trace, 
+0000e4b0: 2a2a 6b77 6172 6773 293a 0a20 2020 2077  **kwargs):.    w
+0000e4c0: 6974 6820 6465 7461 6368 6564 5f74 7261  ith detached_tra
+0000e4d0: 6365 2829 3a0a 2020 2020 2020 2020 7265  ce():.        re
+0000e4e0: 7475 726e 2065 7661 6c5f 7472 6163 6528  turn eval_trace(
+0000e4f0: 7472 6163 652c 202a 6172 6773 2c20 2a2a  trace, *args, **
+0000e500: 6b77 6172 6773 290a 0a0a 6964 656e 7469  kwargs)...identi
+0000e510: 7479 5f63 616c 6c20 3d20 5379 6d62 6f6c  ty_call = Symbol
+0000e520: 2869 643d 5472 616e 7366 6f72 6d73 2e49  (id=Transforms.I
+0000e530: 6465 6e74 6974 794f 702c 206e 616d 653d  dentityOp, name=
+0000e540: 2269 6465 6e74 6974 795f 6361 6c6c 222c  "identity_call",
+0000e550: 206d 6574 613d 5f69 6465 6e74 6974 795f   meta=_identity_
+0000e560: 6361 6c6c 5f6d 6574 6166 756e 6329 0a0a  call_metafunc)..
+0000e570: 0a64 6566 2069 6465 6e74 6974 7928 6675  .def identity(fu
+0000e580: 6e63 293a 0a20 2020 2022 2222 4964 656e  nc):.    """Iden
+0000e590: 7469 7479 2074 7261 6e73 666f 726d 2066  tity transform f
+0000e5a0: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
+0000e5b0: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
+0000e5c0: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
+0000e5d0: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
+0000e5e0: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
+0000e5f0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+0000e600: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0000e610: 6620 7772 6170 7065 7228 2a61 7267 732c  f wrapper(*args,
+0000e620: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0000e630: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
+0000e640: 7472 7563 745f 7472 6163 6528 2928 6675  truct_trace()(fu
+0000e650: 6e63 2c20 2a61 7267 732c 202a 2a6b 7761  nc, *args, **kwa
+0000e660: 7267 7329 0a20 2020 2020 2020 2072 6574  rgs).        ret
+0000e670: 7572 6e20 6964 656e 7469 7479 5f63 616c  urn identity_cal
+0000e680: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
+0000e690: 732c 2074 7261 6365 3d74 7261 6365 290a  s, trace=trace).
+0000e6a0: 0a20 2020 2072 6574 7572 6e20 7772 6170  .    return wrap
+0000e6b0: 7065 720a 0a0a 6465 6620 5f69 6465 6e74  per...def _ident
+0000e6c0: 6974 795f 6361 6c6c 5f70 7974 6f72 6368  ity_call_pytorch
+0000e6d0: 282a 6172 6773 2c20 7472 6163 653a 2054  (*args, trace: T
+0000e6e0: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+0000e6f0: 0a20 2020 2069 6d70 6f72 7420 746f 7263  .    import torc
+0000e700: 680a 0a20 2020 2064 6566 2073 796d 626f  h..    def symbo
+0000e710: 6c5f 6d61 7070 6572 286f 7029 3a0a 2020  l_mapper(op):.  
+0000e720: 2020 2020 2020 6966 206f 702e 6f70 203d        if op.op =
+0000e730: 3d20 5472 616e 7366 6f72 6d73 2e49 6465  = Transforms.Ide
+0000e740: 6e74 6974 794f 703a 0a20 2020 2020 2020  ntityOp:.       
+0000e750: 2020 2020 2072 6574 7572 6e20 5f69 6465       return _ide
+0000e760: 6e74 6974 795f 6361 6c6c 5f70 7974 6f72  ntity_call_pytor
+0000e770: 6368 0a0a 2020 2020 2020 2020 746f 7263  ch..        torc
+0000e780: 685f 6f70 203d 206f 7073 5f74 6f5f 746f  h_op = ops_to_to
+0000e790: 7263 685f 6f70 735f 6d61 705b 6f70 2e6f  rch_ops_map[op.o
+0000e7a0: 705d 0a20 2020 2020 2020 2069 6620 6973  p].        if is
+0000e7b0: 696e 7374 616e 6365 2874 6f72 6368 5f6f  instance(torch_o
+0000e7c0: 702c 2073 7472 293a 0a20 2020 2020 2020  p, str):.       
+0000e7d0: 2020 2020 2072 6574 7572 6e20 6765 7461       return geta
+0000e7e0: 7474 7228 746f 7263 682c 2074 6f72 6368  ttr(torch, torch
+0000e7f0: 5f6f 702e 7374 7269 7028 2270 7974 6f72  _op.strip("pytor
+0000e800: 6368 2e22 2929 0a20 2020 2020 2020 2072  ch.")).        r
+0000e810: 6574 7572 6e20 746f 7263 685f 6f70 0a0a  eturn torch_op..
+0000e820: 2020 2020 7769 7468 2064 6574 6163 6865      with detache
+0000e830: 645f 7472 6163 6528 293a 0a20 2020 2020  d_trace():.     
+0000e840: 2020 2072 6574 7572 6e20 6576 616c 5f74     return eval_t
+0000e850: 7261 6365 2874 7261 6365 2c20 2a61 7267  race(trace, *arg
+0000e860: 732c 202a 2a6b 7761 7267 732c 2073 796d  s, **kwargs, sym
+0000e870: 626f 6c5f 6d61 7070 6572 3d73 796d 626f  bol_mapper=symbo
+0000e880: 6c5f 6d61 7070 6572 290a 0a0a 2320 5265  l_mapper)...# Re
+0000e890: 6769 7374 6572 2074 6865 2069 6465 6e74  gister the ident
+0000e8a0: 6974 7920 6361 6c6c 2066 6f72 2050 7954  ity call for PyT
+0000e8b0: 6f72 6368 2065 7865 6375 746f 722e 0a23  orch executor..#
+0000e8c0: 206f 7073 5f74 6f5f 746f 7263 685f 6f70   ops_to_torch_op
+0000e8d0: 735f 6d61 705b 5472 616e 7366 6f72 6d73  s_map[Transforms
+0000e8e0: 2e49 6465 6e74 6974 794f 705d 203d 205f  .IdentityOp] = _
+0000e8f0: 6964 656e 7469 7479 5f63 616c 6c5f 7079  identity_call_py
+0000e900: 746f 7263 680a 0a0a 2320 564d 4150 2074  torch...# VMAP t
+0000e910: 7261 6e73 666f 726d 0a23 202d 2d2d 2d2d  ransform.# -----
+0000e920: 2d2d 2d2d 2d2d 2d2d 0a0a 0a63 6c61 7373  --------...class
+0000e930: 204e 6f74 4d61 7070 6564 3a0a 2020 2020   NotMapped:.    
+0000e940: 2222 2252 6570 7265 7365 6e74 7320 6120  """Represents a 
+0000e950: 6e6f 6e2d 6261 7463 6865 6420 6469 6d65  non-batched dime
+0000e960: 6e73 696f 6e2e 2222 220a 0a20 2020 2064  nsion."""..    d
+0000e970: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
+0000e980: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000e990: 6e20 226e 6f74 5f6d 6170 7065 6422 0a0a  n "not_mapped"..
+0000e9a0: 0a40 6461 7461 636c 6173 7328 6672 6f7a  .@dataclass(froz
+0000e9b0: 656e 3d54 7275 6529 0a63 6c61 7373 2042  en=True).class B
+0000e9c0: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
+0000e9d0: 2022 2222 4261 7463 6865 6420 7661 6c75   """Batched valu
+0000e9e0: 6520 666f 7220 7468 6520 766d 6170 2074  e for the vmap t
+0000e9f0: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
+0000ea00: 7474 7269 6275 7465 733a 0a20 2020 2020  ttributes:.     
+0000ea10: 2020 2076 616c 7565 3a20 4261 7463 6865     value: Batche
+0000ea20: 6420 7661 6c75 652e 0a20 2020 2020 2020  d value..       
+0000ea30: 2062 6174 6368 5f64 696d 3a20 4261 7463   batch_dim: Batc
+0000ea40: 6869 6e67 2064 696d 656e 7369 6f6e 206f  hing dimension o
+0000ea50: 7220 6e6f 745f 6d61 7070 6564 0a20 2020  r not_mapped.   
+0000ea60: 2022 2222 0a0a 2020 2020 7661 6c75 653a   """..    value:
+0000ea70: 2041 6e79 0a20 2020 2062 6174 6368 5f64   Any.    batch_d
+0000ea80: 696d 3a20 696e 7420 7c20 4e6f 744d 6170  im: int | NotMap
+0000ea90: 7065 640a 0a20 2020 2064 6566 205f 5f69  ped..    def __i
+0000eaa0: 7465 725f 5f28 7365 6c66 293a 0a20 2020  ter__(self):.   
+0000eab0: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
+0000eac0: 7661 6c75 650a 2020 2020 2020 2020 7969  value.        yi
+0000ead0: 656c 6420 7365 6c66 2e62 6174 6368 5f64  eld self.batch_d
+0000eae0: 696d 0a0a 0a64 6566 2070 6169 725f 746f  im...def pair_to
+0000eaf0: 5f62 6174 6368 6564 5f76 616c 7565 2870  _batched_value(p
+0000eb00: 6169 7229 3a0a 2020 2020 2222 2243 6f6e  air):.    """Con
+0000eb10: 7665 7274 7320 6120 7061 6972 2074 6f20  verts a pair to 
+0000eb20: 6120 4261 7463 6865 6456 616c 7565 2e0a  a BatchedValue..
+0000eb30: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0000eb40: 2020 2070 6169 7220 2853 6571 7565 6e63     pair (Sequenc
+0000eb50: 6529 3a20 5061 6972 2074 6f20 636f 6e76  e): Pair to conv
+0000eb60: 6572 742e 0a0a 2020 2020 5265 7475 726e  ert...    Return
+0000eb70: 733a 0a20 2020 2020 2020 2042 6174 6368  s:.        Batch
+0000eb80: 6564 5661 6c75 653a 2042 6174 6368 6564  edValue: Batched
+0000eb90: 5661 6c75 6520 7265 7072 6573 656e 7461  Value representa
+0000eba0: 7469 6f6e 206f 6620 7468 6520 7061 6972  tion of the pair
+0000ebb0: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+0000ebc0: 2069 7369 6e73 7461 6e63 6528 7061 6972   isinstance(pair
+0000ebd0: 2c20 4261 7463 6865 6456 616c 7565 293a  , BatchedValue):
+0000ebe0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000ebf0: 7061 6972 0a20 2020 2065 6c73 653a 0a20  pair.    else:. 
+0000ec00: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0000ec10: 696e 7374 616e 6365 2870 6169 722c 2053  instance(pair, S
+0000ec20: 6571 7565 6e63 6529 2061 6e64 206c 656e  equence) and len
+0000ec30: 2870 6169 7229 203d 3d20 320a 2020 2020  (pair) == 2.    
+0000ec40: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000ec50: 6564 5661 6c75 6528 2a70 6169 7229 0a0a  edValue(*pair)..
+0000ec60: 0a64 6566 2076 6563 746f 7269 7a65 645f  .def vectorized_
+0000ec70: 6261 7463 6865 7228 7072 696d 2c20 6178  batcher(prim, ax
+0000ec80: 6973 5f73 697a 652c 2062 6174 6368 6564  is_size, batched
+0000ec90: 5f76 616c 7565 732c 202a 2a6b 7761 7267  _values, **kwarg
+0000eca0: 7329 3a0a 2020 2020 6261 7463 685f 6469  s):.    batch_di
+0000ecb0: 6d20 3d20 6261 7463 6865 645f 7661 6c75  m = batched_valu
+0000ecc0: 6573 5b30 5d2e 6261 7463 685f 6469 6d0a  es[0].batch_dim.
+0000ecd0: 2020 2020 6173 7365 7274 2061 6c6c 280a      assert all(.
+0000ece0: 2020 2020 2020 2020 6261 7463 685f 6469          batch_di
+0000ecf0: 6d20 3d3d 2062 762e 6261 7463 685f 6469  m == bv.batch_di
+0000ed00: 6d20 666f 7220 6276 2069 6e20 6261 7463  m for bv in batc
+0000ed10: 6865 645f 7661 6c75 6573 5b31 3a5d 0a20  hed_values[1:]. 
+0000ed20: 2020 2029 2c20 6622 6076 6563 746f 7269     ), f"`vectori
+0000ed30: 7a65 645f 6261 7463 6865 7260 2067 6f74  zed_batcher` got
+0000ed40: 2064 6966 6665 7265 6e74 2062 6174 6368   different batch
+0000ed50: 6564 2064 696d 656e 7369 6f6e 7320 7b5b  ed dimensions {[
+0000ed60: 6276 2e62 6174 6368 5f64 696d 2066 6f72  bv.batch_dim for
+0000ed70: 2062 7620 696e 2062 6174 6368 6564 5f76   bv in batched_v
+0000ed80: 616c 7565 735d 7d22 0a20 2020 2072 6574  alues]}".    ret
+0000ed90: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+0000eda0: 2870 7269 6d28 2a5b 6276 2e76 616c 7565  (prim(*[bv.value
+0000edb0: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
+0000edc0: 6564 5f76 616c 7565 735d 2c20 2a2a 6b77  ed_values], **kw
+0000edd0: 6172 6773 292c 2062 6174 6368 5f64 696d  args), batch_dim
+0000ede0: 290a 0a0a 6e6f 745f 6d61 7070 6564 203d  )...not_mapped =
+0000edf0: 204e 6f74 4d61 7070 6564 2829 0a0a 0a64   NotMapped()...d
+0000ee00: 6566 206d 6f76 6564 696d 2878 2c20 7372  ef movedim(x, sr
+0000ee10: 633a 2069 6e74 2c20 6473 743a 2069 6e74  c: int, dst: int
+0000ee20: 293a 0a20 2020 2070 6572 6d20 3d20 5b69  ):.    perm = [i
+0000ee30: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000ee40: 782e 6e64 696d 2920 6966 2069 2021 3d20  x.ndim) if i != 
+0000ee50: 7372 635d 0a20 2020 2070 6572 6d2e 696e  src].    perm.in
+0000ee60: 7365 7274 2864 7374 2c20 7372 6329 0a20  sert(dst, src). 
+0000ee70: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+0000ee80: 7472 616e 7370 6f73 6528 782c 2074 7570  transpose(x, tup
+0000ee90: 6c65 2870 6572 6d29 290a 0a0a 6465 6620  le(perm))...def 
+0000eea0: 6d6f 7665 5f62 6174 6368 5f64 696d 2861  move_batch_dim(a
+0000eeb0: 7869 735f 7369 7a65 2c20 7372 632c 2064  xis_size, src, d
+0000eec0: 7374 2c20 7829 3a0a 2020 2020 6966 2073  st, x):.    if s
+0000eed0: 7263 2069 7320 6e6f 745f 6d61 7070 6564  rc is not_mapped
+0000eee0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+0000eef0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
+0000ef00: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000ef10: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
+0000ef20: 2074 6172 6765 745f 7368 6170 6520 3d20   target_shape = 
+0000ef30: 6c69 7374 2878 2e73 6861 7065 290a 2020  list(x.shape).  
+0000ef40: 2020 2020 2020 7461 7267 6574 5f73 6861        target_sha
+0000ef50: 7065 2e69 6e73 6572 7428 6473 742c 2061  pe.insert(dst, a
+0000ef60: 7869 735f 7369 7a65 290a 2020 2020 2020  xis_size).      
+0000ef70: 2020 6263 6173 745f 6469 6d73 203d 206c    bcast_dims = l
+0000ef80: 6973 7428 7261 6e67 6528 6c65 6e28 7461  ist(range(len(ta
+0000ef90: 7267 6574 5f73 6861 7065 2929 290a 2020  rget_shape))).  
+0000efa0: 2020 2020 2020 6263 6173 745f 6469 6d73        bcast_dims
+0000efb0: 2e70 6f70 2864 7374 290a 2020 2020 2020  .pop(dst).      
+0000efc0: 2020 7265 7475 726e 2070 7269 6d73 2e62    return prims.b
+0000efd0: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
+0000efe0: 782c 2074 6172 6765 745f 7368 6170 652c  x, target_shape,
+0000eff0: 2062 6361 7374 5f64 696d 7329 0a20 2020   bcast_dims).   
+0000f000: 2065 6c69 6620 7372 6320 3d3d 2064 7374   elif src == dst
+0000f010: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000f020: 2078 0a20 2020 2065 6c73 653a 0a20 2020   x.    else:.   
+0000f030: 2020 2020 2072 6574 7572 6e20 6d6f 7665       return move
+0000f040: 6469 6d28 782c 2073 7263 2c20 6473 7429  dim(x, src, dst)
+0000f050: 0a0a 0a64 6566 2062 696e 6172 795f 6f70  ...def binary_op
+0000f060: 5f62 6174 6368 696e 675f 7275 6c65 286f  _batching_rule(o
+0000f070: 703a 2070 7269 6d73 2e50 7269 6d49 4473  p: prims.PrimIDs
+0000f080: 2c20 6178 6973 5f73 697a 653a 2069 6e74  , axis_size: int
+0000f090: 2c20 7661 6c73 5f69 6e3a 2042 6174 6368  , vals_in: Batch
+0000f0a0: 6564 5661 6c75 6529 3a0a 2020 2020 2828  edValue):.    ((
+0000f0b0: 782c 2078 5f62 6469 6d29 2c20 2879 2c20  x, x_bdim), (y, 
+0000f0c0: 795f 6264 696d 2929 203d 2076 616c 735f  y_bdim)) = vals_
+0000f0d0: 696e 0a20 2020 2069 6620 785f 6264 696d  in.    if x_bdim
+0000f0e0: 2021 3d20 795f 6264 696d 3a0a 2020 2020   != y_bdim:.    
+0000f0f0: 2020 2020 6966 2078 5f62 6469 6d20 6973      if x_bdim is
+0000f100: 206e 6f74 5f6d 6170 7065 643a 0a20 2020   not_mapped:.   
+0000f110: 2020 2020 2020 2020 2078 203d 206d 6f76           x = mov
+0000f120: 655f 6261 7463 685f 6469 6d28 6178 6973  e_batch_dim(axis
+0000f130: 5f73 697a 652c 2078 5f62 6469 6d2c 2079  _size, x_bdim, y
+0000f140: 5f62 6469 6d2c 2078 290a 2020 2020 2020  _bdim, x).      
+0000f150: 2020 2020 2020 785f 6264 696d 203d 2079        x_bdim = y
+0000f160: 5f62 6469 6d0a 2020 2020 2020 2020 656c  _bdim.        el
+0000f170: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000f180: 7920 3d20 6d6f 7665 5f62 6174 6368 5f64  y = move_batch_d
+0000f190: 696d 2861 7869 735f 7369 7a65 2c20 795f  im(axis_size, y_
+0000f1a0: 6264 696d 2c20 785f 6264 696d 2c20 7929  bdim, x_bdim, y)
+0000f1b0: 0a20 2020 2072 6574 7572 6e20 4261 7463  .    return Batc
+0000f1c0: 6865 6456 616c 7565 286f 7028 782c 2079  hedValue(op(x, y
+0000f1d0: 292c 2078 5f62 6469 6d29 0a0a 0a64 6566  ), x_bdim)...def
+0000f1e0: 2073 696e 5f76 6d61 7028 6178 6973 5f73   sin_vmap(axis_s
+0000f1f0: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
+0000f200: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
+0000f210: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
+0000f220: 7265 7475 726e 2076 6563 746f 7269 7a65  return vectorize
+0000f230: 645f 6261 7463 6865 7228 7072 696d 732e  d_batcher(prims.
+0000f240: 7369 6e2c 2061 7869 735f 7369 7a65 2c20  sin, axis_size, 
+0000f250: 2861 2c29 290a 0a0a 6465 6620 636f 735f  (a,))...def cos_
+0000f260: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
+0000f270: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
+0000f280: 616c 7565 2920 2d3e 2042 6174 6368 6564  alue) -> Batched
+0000f290: 5661 6c75 653a 0a20 2020 2072 6574 7572  Value:.    retur
+0000f2a0: 6e20 7665 6374 6f72 697a 6564 5f62 6174  n vectorized_bat
+0000f2b0: 6368 6572 2870 7269 6d73 2e63 6f73 2c20  cher(prims.cos, 
+0000f2c0: 6178 6973 5f73 697a 652c 2028 612c 2929  axis_size, (a,))
+0000f2d0: 0a0a 0a64 6566 206d 756c 5f76 6d61 7028  ...def mul_vmap(
+0000f2e0: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
+0000f2f0: 613a 2042 6174 6368 6564 5661 6c75 652c  a: BatchedValue,
+0000f300: 2062 3a20 4261 7463 6865 6456 616c 7565   b: BatchedValue
+0000f310: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
+0000f320: 653a 0a20 2020 2072 6574 7572 6e20 6269  e:.    return bi
+0000f330: 6e61 7279 5f6f 705f 6261 7463 6869 6e67  nary_op_batching
+0000f340: 5f72 756c 6528 7072 696d 732e 6d75 6c2c  _rule(prims.mul,
+0000f350: 2061 7869 735f 7369 7a65 2c20 2861 2c20   axis_size, (a, 
+0000f360: 6229 290a 0a0a 6465 6620 6164 645f 766d  b))...def add_vm
+0000f370: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
+0000f380: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
+0000f390: 7565 2c20 623a 2042 6174 6368 6564 5661  ue, b: BatchedVa
+0000f3a0: 6c75 6529 202d 3e20 4261 7463 6865 6456  lue) -> BatchedV
+0000f3b0: 616c 7565 3a0a 2020 2020 7265 7475 726e  alue:.    return
+0000f3c0: 2062 696e 6172 795f 6f70 5f62 6174 6368   binary_op_batch
+0000f3d0: 696e 675f 7275 6c65 2870 7269 6d73 2e61  ing_rule(prims.a
+0000f3e0: 6464 2c20 6178 6973 5f73 697a 652c 2028  dd, axis_size, (
+0000f3f0: 612c 2062 2929 0a0a 0a64 6566 2073 756d  a, b))...def sum
+0000f400: 5f76 6d61 7028 6178 6973 5f73 697a 653a  _vmap(axis_size:
+0000f410: 2069 6e74 2c20 613a 2042 6174 6368 6564   int, a: Batched
+0000f420: 5661 6c75 652c 2064 696d 733a 2053 6571  Value, dims: Seq
+0000f430: 7565 6e63 655b 696e 745d 2c20 2a2a 6b77  uence[int], **kw
+0000f440: 6172 6773 2920 2d3e 2042 6174 6368 6564  args) -> Batched
+0000f450: 5661 6c75 653a 0a20 2020 2062 6469 6d20  Value:.    bdim 
+0000f460: 3d20 612e 6261 7463 685f 6469 6d0a 2020  = a.batch_dim.  
+0000f470: 2020 2320 544f 444f 3a20 7265 6d6f 7665    # TODO: remove
+0000f480: 2074 6869 7320 7768 656e 2064 696d 7320   this when dims 
+0000f490: 6265 636f 6d65 7320 6120 6d61 6e64 6174  becomes a mandat
+0000f4a0: 6f72 7920 6b77 6172 670a 2020 2020 6966  ory kwarg.    if
+0000f4b0: 206c 656e 2864 696d 7329 203e 2030 3a0a   len(dims) > 0:.
+0000f4c0: 2020 2020 2020 2020 6469 6d73 2c20 5f20          dims, _ 
+0000f4d0: 3d20 7361 6665 5f7a 6970 282a 6469 6d73  = safe_zip(*dims
+0000f4e0: 290a 2020 2020 6469 6d73 5f62 6566 6f72  ).    dims_befor
+0000f4f0: 6520 3d20 7475 706c 6528 656c 2066 6f72  e = tuple(el for
+0000f500: 2065 6c20 696e 2064 696d 7320 6966 2065   el in dims if e
+0000f510: 6c20 3c20 6264 696d 290a 2020 2020 6469  l < bdim).    di
+0000f520: 6d73 5f61 6674 6572 203d 2074 7570 6c65  ms_after = tuple
+0000f530: 2865 6c20 2b20 3120 666f 7220 656c 2069  (el + 1 for el i
+0000f540: 6e20 6469 6d73 2069 6620 656c 203e 3d20  n dims if el >= 
+0000f550: 6264 696d 290a 2020 2020 6261 7463 6865  bdim).    batche
+0000f560: 645f 6469 6d73 203d 2064 696d 735f 6265  d_dims = dims_be
+0000f570: 666f 7265 202b 2064 696d 735f 6166 7465  fore + dims_afte
+0000f580: 720a 2020 2020 7265 7475 726e 2076 6563  r.    return vec
+0000f590: 746f 7269 7a65 645f 6261 7463 6865 7228  torized_batcher(
+0000f5a0: 7072 696d 732e 7375 6d2c 2061 7869 735f  prims.sum, axis_
+0000f5b0: 7369 7a65 2c20 2861 2c29 2c20 6469 6d73  size, (a,), dims
+0000f5c0: 3d62 6174 6368 6564 5f64 696d 732c 202a  =batched_dims, *
+0000f5d0: 2a6b 7761 7267 7329 0a0a 0a23 2054 4f44  *kwargs)...# TOD
+0000f5e0: 4f3a 2050 6c65 6173 6520 7465 7374 2074  O: Please test t
+0000f5f0: 6869 7320 6578 7465 6e73 6976 656c 790a  his extensively.
+0000f600: 6465 6620 6272 6f61 6463 6173 745f 696e  def broadcast_in
+0000f610: 5f64 696d 5f76 6d61 7028 0a20 2020 2061  _dim_vmap(.    a
+0000f620: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
+0000f630: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
+0000f640: 7368 6170 653a 2053 6571 7565 6e63 655b  shape: Sequence[
+0000f650: 4261 7463 6865 6456 616c 7565 5d2c 2062  BatchedValue], b
+0000f660: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f670: 6f6e 733a 2053 6571 7565 6e63 655b 4261  ons: Sequence[Ba
+0000f680: 7463 6865 6456 616c 7565 5d0a 2920 2d3e  tchedValue].) ->
+0000f690: 2042 6174 6368 6564 5661 6c75 653a 0a20   BatchedValue:. 
+0000f6a0: 2020 2062 6469 6d20 3d20 612e 6261 7463     bdim = a.batc
+0000f6b0: 685f 6469 6d0a 2020 2020 2320 544f 444f  h_dim.    # TODO
+0000f6c0: 3a20 7265 6d6f 7665 2074 6869 7320 7768  : remove this wh
+0000f6d0: 656e 2073 6861 7065 2061 6e64 2062 726f  en shape and bro
+0000f6e0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+0000f6f0: 7320 6265 636f 6d65 206d 616e 6461 746f  s become mandato
+0000f700: 7279 206b 7761 7267 730a 2020 2020 7368  ry kwargs.    sh
+0000f710: 6170 652c 205f 203d 2073 6166 655f 7a69  ape, _ = safe_zi
+0000f720: 7028 2a73 6861 7065 290a 2020 2020 6966  p(*shape).    if
+0000f730: 206c 656e 2862 726f 6164 6361 7374 5f64   len(broadcast_d
+0000f740: 696d 656e 7369 6f6e 7329 203e 2030 3a0a  imensions) > 0:.
+0000f750: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
+0000f760: 745f 6469 6d65 6e73 696f 6e73 2c20 5f20  t_dimensions, _ 
+0000f770: 3d20 7361 6665 5f7a 6970 282a 6272 6f61  = safe_zip(*broa
+0000f780: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000f790: 290a 2020 2020 6966 2062 6469 6d20 6973  ).    if bdim is
+0000f7a0: 206e 6f74 5f6d 6170 7065 643a 0a20 2020   not_mapped:.   
+0000f7b0: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
+0000f7c0: 6865 6456 616c 7565 2870 7269 6d73 2e62  hedValue(prims.b
+0000f7d0: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
+0000f7e0: 612e 7661 6c75 652c 2073 6861 7065 2c20  a.value, shape, 
+0000f7f0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000f800: 696f 6e73 292c 2062 6469 6d29 0a20 2020  ions), bdim).   
+0000f810: 2065 6c73 653a 0a20 2020 2020 2020 206e   else:.        n
+0000f820: 6577 5f62 6469 6d20 3d20 6264 696d 202b  ew_bdim = bdim +
+0000f830: 2073 756d 2831 2066 6f72 2064 696d 2069   sum(1 for dim i
+0000f840: 6e20 6272 6f61 6463 6173 745f 6469 6d65  n broadcast_dime
+0000f850: 6e73 696f 6e73 2069 6620 6469 6d20 3c20  nsions if dim < 
+0000f860: 6264 696d 290a 2020 2020 2020 2020 6e65  bdim).        ne
+0000f870: 775f 7368 6170 6520 3d20 6c69 7374 2873  w_shape = list(s
+0000f880: 6861 7065 290a 2020 2020 2020 2020 6e65  hape).        ne
+0000f890: 775f 7368 6170 652e 696e 7365 7274 286e  w_shape.insert(n
+0000f8a0: 6577 5f62 6469 6d2c 2061 7869 735f 7369  ew_bdim, axis_si
+0000f8b0: 7a65 290a 2020 2020 2020 2020 6e65 775f  ze).        new_
+0000f8c0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000f8d0: 696f 6e73 203d 2028 302c 2920 2b20 7475  ions = (0,) + tu
+0000f8e0: 706c 6528 6469 6d20 2b20 3120 6966 2064  ple(dim + 1 if d
+0000f8f0: 696d 203e 3d20 6264 696d 2065 6c73 6520  im >= bdim else 
+0000f900: 6469 6d20 666f 7220 6469 6d20 696e 2062  dim for dim in b
+0000f910: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f920: 6f6e 7329 0a20 2020 2020 2020 2069 6620  ons).        if 
+0000f930: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000f940: 696f 6e73 203d 3d20 2829 3a0a 2020 2020  ions == ():.    
+0000f950: 2020 2020 2020 2020 6e65 775f 6272 6f61          new_broa
+0000f960: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000f970: 203d 2028 290a 2020 2020 2020 2020 7265   = ().        re
+0000f980: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
+0000f990: 6528 7072 696d 732e 6272 6f61 6463 6173  e(prims.broadcas
+0000f9a0: 745f 696e 5f64 696d 2861 2e76 616c 7565  t_in_dim(a.value
+0000f9b0: 2c20 6e65 775f 7368 6170 652c 206e 6577  , new_shape, new
+0000f9c0: 5f62 726f 6164 6361 7374 5f64 696d 656e  _broadcast_dimen
+0000f9d0: 7369 6f6e 7329 2c20 6e65 775f 6264 696d  sions), new_bdim
+0000f9e0: 290a 0a0a 766d 6170 5f69 6d70 6c73 3a20  )...vmap_impls: 
+0000f9f0: 6469 6374 5b70 7269 6d73 2e53 796d 626f  dict[prims.Symbo
+0000fa00: 6c2c 2043 616c 6c61 626c 655d 203d 2064  l, Callable] = d
+0000fa10: 6963 7428 290a 0a0a 6465 6620 756e 7772  ict()...def unwr
+0000fa20: 6170 5f6f 6e65 5f6c 6576 656c 5f6f 665f  ap_one_level_of_
+0000fa30: 7375 6273 796d 626f 6c73 2874 7261 6365  subsymbols(trace
+0000fa40: 293a 0a20 2020 206e 6577 5f73 796d 626f  ):.    new_symbo
+0000fa50: 6c73 5f69 7465 7220 3d20 280a 2020 2020  ls_iter = (.    
+0000fa60: 2020 2020 626f 756e 645f 7379 6d62 6f6c      bound_symbol
+0000fa70: 2e73 7562 7379 6d62 6f6c 7320 6966 206c  .subsymbols if l
+0000fa80: 656e 2862 6f75 6e64 5f73 796d 626f 6c2e  en(bound_symbol.
+0000fa90: 7375 6273 796d 626f 6c73 2920 3e20 3020  subsymbols) > 0 
+0000faa0: 656c 7365 205b 626f 756e 645f 7379 6d62  else [bound_symb
+0000fab0: 6f6c 5d0a 2020 2020 2020 2020 666f 7220  ol].        for 
+0000fac0: 626f 756e 645f 7379 6d62 6f6c 2069 6e20  bound_symbol in 
+0000fad0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0000fae0: 6f6c 730a 2020 2020 290a 2020 2020 6e65  ols.    ).    ne
+0000faf0: 775f 7379 6d62 6f6c 7320 3d20 6c69 7374  w_symbols = list
+0000fb00: 2863 6861 696e 2e66 726f 6d5f 6974 6572  (chain.from_iter
+0000fb10: 6162 6c65 286e 6577 5f73 796d 626f 6c73  able(new_symbols
+0000fb20: 5f69 7465 7229 290a 2020 2020 7472 6163  _iter)).    trac
+0000fb30: 652e 626f 756e 645f 7379 6d62 6f6c 7320  e.bound_symbols 
+0000fb40: 3d20 6e65 775f 7379 6d62 6f6c 730a 2020  = new_symbols.  
+0000fb50: 2020 7265 7475 726e 2074 7261 6365 0a0a    return trace..
+0000fb60: 0a64 6566 2064 6563 6f6d 706f 7365 645f  .def decomposed_
+0000fb70: 666e 5f76 6d61 705f 7275 6c65 2861 7869  fn_vmap_rule(axi
+0000fb80: 735f 7369 7a65 2c20 2a61 7267 732c 2066  s_size, *args, f
+0000fb90: 6e2c 202a 2a6b 7761 7267 7329 3a0a 2020  n, **kwargs):.  
+0000fba0: 2020 6172 6773 2c20 696e 5f64 696d 7320    args, in_dims 
+0000fbb0: 3d20 756e 7a69 7032 2861 7267 7329 0a20  = unzip2(args). 
+0000fbc0: 2020 2075 6e62 6174 6368 6564 5f61 7267     unbatched_arg
+0000fbd0: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
+0000fbe0: 6264 6120 783a 2072 656d 6f76 655f 6261  bda x: remove_ba
+0000fbf0: 7463 685f 6469 6d28 7829 2069 6620 6973  tch_dim(x) if is
+0000fc00: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+0000fc10: 6f72 5072 6f78 7929 2065 6c73 6520 782c  orProxy) else x,
+0000fc20: 2061 7267 7329 0a20 2020 2074 7261 6365   args).    trace
+0000fc30: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0000fc40: 6365 2829 2866 6e2c 202a 756e 6261 7463  ce()(fn, *unbatc
+0000fc50: 6865 645f 6172 6773 2c20 2a2a 6b77 6172  hed_args, **kwar
+0000fc60: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
+0000fc70: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
+0000fc80: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
+0000fc90: 7261 6365 290a 2020 2020 6f75 7473 203d  race).    outs =
+0000fca0: 205f 766d 6170 5f63 616c 6c5f 6d65 7461   _vmap_call_meta
+0000fcb0: 6675 6e63 2846 616c 7365 2c20 6172 6773  func(False, args
+0000fcc0: 2c20 696e 5f64 696d 732c 2030 2c20 6178  , in_dims, 0, ax
+0000fcd0: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
+0000fce0: 6e5f 7472 6163 653d 7472 6163 652c 202a  n_trace=trace, *
+0000fcf0: 2a6b 7761 7267 7329 0a20 2020 2069 6620  *kwargs).    if 
+0000fd00: 6973 696e 7374 616e 6365 286f 7574 732c  isinstance(outs,
+0000fd10: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+0000fd20: 2020 2020 6f75 745f 6469 6d73 203d 2028      out_dims = (
+0000fd30: 302c 2920 2a20 6c65 6e28 6f75 7473 290a  0,) * len(outs).
+0000fd40: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000fd50: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+0000fd60: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
+0000fd70: 6166 655f 7a69 7028 6f75 7473 2c20 6f75  afe_zip(outs, ou
+0000fd80: 745f 6469 6d73 2929 0a20 2020 2072 6574  t_dims)).    ret
+0000fd90: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+0000fda0: 286f 7574 732c 2030 290a 0a0a 766d 6170  (outs, 0)...vmap
+0000fdb0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+0000fdc0: 6d49 4473 2e53 494e 5d20 3d20 7369 6e5f  mIDs.SIN] = sin_
+0000fdd0: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
+0000fde0: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
+0000fdf0: 535d 203d 2063 6f73 5f76 6d61 700a 766d  S] = cos_vmap.vm
+0000fe00: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
+0000fe10: 7269 6d49 4473 2e4d 554c 5d20 3d20 6d75  rimIDs.MUL] = mu
+0000fe20: 6c5f 766d 6170 0a76 6d61 705f 696d 706c  l_vmap.vmap_impl
+0000fe30: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+0000fe40: 4144 445d 203d 2061 6464 5f76 6d61 700a  ADD] = add_vmap.
+0000fe50: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
+0000fe60: 2e50 7269 6d49 4473 2e53 554d 5d20 3d20  .PrimIDs.SUM] = 
+0000fe70: 7375 6d5f 766d 6170 0a76 6d61 705f 696d  sum_vmap.vmap_im
+0000fe80: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+0000fe90: 732e 4252 4f41 4443 4153 545f 494e 5f44  s.BROADCAST_IN_D
+0000fea0: 494d 5d20 3d20 6272 6f61 6463 6173 745f  IM] = broadcast_
+0000feb0: 696e 5f64 696d 5f76 6d61 700a 0a0a 6465  in_dim_vmap...de
+0000fec0: 6620 766d 6170 5f73 796d 626f 6c5f 6d61  f vmap_symbol_ma
+0000fed0: 7070 6572 2873 796d 626f 6c3a 2070 7269  pper(symbol: pri
+0000fee0: 6d73 2e53 796d 626f 6c2c 202a 2c20 6178  ms.Symbol, *, ax
+0000fef0: 6973 5f73 697a 653a 2069 6e74 293a 0a20  is_size: int):. 
+0000ff00: 2020 2022 2222 4d61 7073 2061 2073 796d     """Maps a sym
+0000ff10: 626f 6c20 746f 2061 2076 6d61 7020 6675  bol to a vmap fu
+0000ff20: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
+0000ff30: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
+0000ff40: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
+0000ff50: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
+0000ff60: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6576  l): Symbol to ev
+0000ff70: 616c 7561 7465 2e0a 0a20 2020 2052 6169  aluate...    Rai
+0000ff80: 7365 733a 0a20 2020 2020 2020 204e 6f74  ses:.        Not
+0000ff90: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+0000ffa0: 3a20 4966 2074 6865 2076 6d61 7020 666f  : If the vmap fo
+0000ffb0: 7220 7468 6520 7379 6d62 6f6c 2069 7320  r the symbol is 
+0000ffc0: 6e6f 7420 696d 706c 656d 656e 7465 642e  not implemented.
+0000ffd0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0000ffe0: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
+0000fff0: 2076 6d61 7020 6675 6e63 7469 6f6e 2074   vmap function t
+00010000: 6861 7420 6576 616c 7561 7465 7320 7468  hat evaluates th
+00010010: 6520 7379 6d62 6f6c 2e0a 2020 2020 2222  e symbol..    ""
+00010020: 220a 0a20 2020 2064 6566 2077 7261 705f  "..    def wrap_
+00010030: 6172 6728 7829 3a0a 2020 2020 2020 2020  arg(x):.        
+00010040: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00010050: 2042 6174 6368 6564 5661 6c75 6529 3a0a   BatchedValue):.
+00010060: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010070: 726e 2078 0a20 2020 2020 2020 2065 6c69  rn x.        eli
+00010080: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00010090: 284e 756d 6265 722c 204e 756d 6265 7250  (Number, NumberP
+000100a0: 726f 7879 2929 3a0a 2020 2020 2020 2020  roxy)):.        
+000100b0: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+000100c0: 6564 5661 6c75 6528 782c 206e 6f74 5f6d  edValue(x, not_m
+000100d0: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
+000100e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000100f0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00010100: 7228 6622 766d 6170 2077 7261 705f 6172  r(f"vmap wrap_ar
+00010110: 6720 676f 7420 616e 2075 6e73 7570 706f  g got an unsuppo
+00010120: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
+00010130: 7829 7d22 290a 0a20 2020 2069 6620 7379  x)}")..    if sy
+00010140: 6d62 6f6c 2e61 7265 5f61 6c6c 5f61 7267  mbol.are_all_arg
+00010150: 735f 636f 6e73 7461 6e74 3a0a 0a20 2020  s_constant:..   
+00010160: 2020 2020 2064 6566 205f 766d 6170 5f69       def _vmap_i
+00010170: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
+00010180: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+00010190: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+000101a0: 6f75 7420 3d20 7379 6d62 6f6c 5f74 6f5f  out = symbol_to_
+000101b0: 6576 616c 2873 796d 626f 6c29 282a 6172  eval(symbol)(*ar
+000101c0: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
+000101d0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+000101e0: 696e 7374 616e 6365 286f 7574 2c20 5365  instance(out, Se
+000101f0: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+00010200: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00010210: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
+00010220: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
+00010230: 7361 6665 5f7a 6970 2861 7267 732c 205b  safe_zip(args, [
+00010240: 6e6f 745f 6d61 7070 6564 5d20 2a20 6c65  not_mapped] * le
+00010250: 6e28 6f75 7429 2929 0a0a 2020 2020 2020  n(out)))..      
+00010260: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
+00010270: 6368 6564 5661 6c75 6528 6f75 742c 206e  chedValue(out, n
+00010280: 6f74 5f6d 6170 7065 6429 0a0a 2020 2020  ot_mapped)..    
+00010290: 2020 2020 7265 7475 726e 2070 6172 7469      return parti
+000102a0: 616c 285f 766d 6170 5f69 6d70 6c5f 636f  al(_vmap_impl_co
+000102b0: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
+000102c0: 2020 766d 6170 5f69 6d70 6c20 3d20 766d    vmap_impl = vm
+000102d0: 6170 5f69 6d70 6c73 2e67 6574 2873 796d  ap_impls.get(sym
+000102e0: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
+000102f0: 6966 2076 6d61 705f 696d 706c 2069 7320  if vmap_impl is 
+00010300: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+00010310: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
+00010320: 796d 626f 6c73 2920 3e20 303a 0a20 2020  ymbols) > 0:.   
+00010330: 2020 2020 2020 2020 2076 6d61 705f 696d           vmap_im
+00010340: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
+00010350: 6f6d 706f 7365 645f 666e 5f76 6d61 705f  omposed_fn_vmap_
+00010360: 7275 6c65 2c20 666e 3d73 796d 626f 6c2e  rule, fn=symbol.
+00010370: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
+00010380: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00010390: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
+000103a0: 7465 6445 7272 6f72 2866 2276 6d61 7020  tedError(f"vmap 
+000103b0: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
+000103c0: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
+000103d0: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
+000103e0: 6620 5f76 6d61 705f 696d 706c 282a 6172  f _vmap_impl(*ar
+000103f0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00010400: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
+00010410: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
+00010420: 2061 7267 7329 0a20 2020 2020 2020 2061   args).        a
+00010430: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
+00010440: 616e 6365 2861 7267 2c20 4261 7463 6865  ance(arg, Batche
+00010450: 6456 616c 7565 2920 666f 7220 6172 6720  dValue) for arg 
+00010460: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
+00010470: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
+00010480: 2020 7265 7475 726e 2076 6d61 705f 696d    return vmap_im
+00010490: 706c 2861 7869 735f 7369 7a65 2c20 2a61  pl(axis_size, *a
+000104a0: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
+000104b0: 2020 2020 7265 7475 726e 205f 766d 6170      return _vmap
+000104c0: 5f69 6d70 6c0a 0a0a 6465 6620 7265 6d6f  _impl...def remo
+000104d0: 7665 5f62 6174 6368 5f64 696d 2874 656e  ve_batch_dim(ten
+000104e0: 736f 723a 2054 656e 736f 7250 726f 7879  sor: TensorProxy
+000104f0: 2c20 6261 7463 685f 6469 6d3a 2069 6e74  , batch_dim: int
+00010500: 203d 2030 2920 2d3e 2054 656e 736f 7250   = 0) -> TensorP
+00010510: 726f 7879 3a0a 2020 2020 2222 2252 656d  roxy:.    """Rem
+00010520: 6f76 6573 2074 6865 2062 6174 6368 2064  oves the batch d
+00010530: 696d 656e 7369 6f6e 2066 726f 6d20 6120  imension from a 
+00010540: 7465 6e73 6f72 2e0a 0a20 2020 2041 7267  tensor...    Arg
+00010550: 733a 0a20 2020 2020 2020 2074 656e 736f  s:.        tenso
+00010560: 7220 2854 656e 736f 7250 726f 7879 293a  r (TensorProxy):
+00010570: 2054 656e 736f 7220 746f 2072 656d 6f76   Tensor to remov
+00010580: 6520 7468 6520 6261 7463 6820 6469 6d65  e the batch dime
+00010590: 6e73 696f 6e20 6672 6f6d 2e0a 0a20 2020  nsion from...   
+000105a0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+000105b0: 2020 5465 6e73 6f72 5072 6f78 793a 2054    TensorProxy: T
+000105c0: 656e 736f 7220 7769 7468 2074 6865 2062  ensor with the b
+000105d0: 6174 6368 2064 696d 656e 7369 6f6e 2072  atch dimension r
+000105e0: 656d 6f76 6564 2e0a 2020 2020 2222 220a  emoved..    """.
+000105f0: 2020 2020 6e65 775f 7368 6170 6520 3d20      new_shape = 
+00010600: 7465 6e73 6f72 2e73 6861 7065 5b3a 6261  tensor.shape[:ba
+00010610: 7463 685f 6469 6d5d 202b 2074 656e 736f  tch_dim] + tenso
+00010620: 722e 7368 6170 655b 6261 7463 685f 6469  r.shape[batch_di
+00010630: 6d20 2b20 3120 3a5d 0a20 2020 2072 6574  m + 1 :].    ret
+00010640: 7572 6e20 5465 6e73 6f72 5072 6f78 7928  urn TensorProxy(
+00010650: 6c69 6b65 3d74 656e 736f 722c 2073 6861  like=tensor, sha
+00010660: 7065 3d6e 6577 5f73 6861 7065 290a 0a0a  pe=new_shape)...
+00010670: 2320 544f 444f 3a20 696e 204a 4158 2061  # TODO: in JAX a
+00010680: 7267 732c 2069 6e5f 6469 6d73 2061 7265  rgs, in_dims are
+00010690: 2066 6c61 7474 656e 6564 2074 6865 2073   flattened the s
+000106a0: 616d 6520 7761 790a 2320 544f 444f 3a20  ame way.# TODO: 
+000106b0: 696e 204a 4158 206f 7574 5f64 696d 7320  in JAX out_dims 
+000106c0: 6172 6520 666c 6174 7465 6e65 6420 6173  are flattened as
+000106d0: 2077 656c 6c0a 6465 6620 5f76 6d61 705f   well.def _vmap_
+000106e0: 6361 6c6c 5f6d 6574 6166 756e 6328 6465  call_metafunc(de
+000106f0: 7461 6368 6564 3a20 626f 6f6c 2c20 6172  tached: bool, ar
+00010700: 6773 2c20 696e 5f64 696d 732c 206f 7574  gs, in_dims, out
+00010710: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
+00010720: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+00010730: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+00010740: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
+00010750: 756e 6374 696f 6e20 666f 7220 766d 6170  unction for vmap
+00010760: 2063 616c 6c2e 0a0a 2020 2020 4172 6773   call...    Args
+00010770: 3a0a 2020 2020 2020 2020 6465 7461 6368  :.        detach
+00010780: 6564 2028 626f 6f6c 293a 2057 6865 7468  ed (bool): Wheth
+00010790: 6572 2074 6f20 6465 7461 6368 2074 6865  er to detach the
+000107a0: 2074 7261 6365 2e0a 2020 2020 2020 2020   trace..        
+000107b0: 6172 6773 2028 5475 706c 655b 5072 6f78  args (Tuple[Prox
+000107c0: 795d 293a 2041 7267 756d 656e 7473 2074  y]): Arguments t
+000107d0: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
+000107e0: 2020 2020 2020 2020 696e 5f64 696d 7320          in_dims 
+000107f0: 2854 7570 6c65 5b69 6e74 5d29 3a20 4261  (Tuple[int]): Ba
+00010800: 7463 6820 6469 6d65 6e73 696f 6e20 666f  tch dimension fo
+00010810: 7220 6561 6368 2061 7267 756d 656e 742e  r each argument.
+00010820: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
+00010830: 7320 2854 7570 6c65 5b69 6e74 5d29 3a20  s (Tuple[int]): 
+00010840: 4261 7463 6820 6469 6d65 6e73 696f 6e20  Batch dimension 
+00010850: 666f 7220 7265 7475 726e 2076 616c 7565  for return value
+00010860: 732e 0a20 2020 2020 2020 2066 756e 6374  s..        funct
+00010870: 696f 6e5f 7472 6163 6520 2854 7261 6365  ion_trace (Trace
+00010880: 293a 2054 7261 6365 2074 6f20 7573 6520  ): Trace to use 
+00010890: 666f 7220 7468 6520 6675 6e63 7469 6f6e  for the function
+000108a0: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+000108b0: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
+000108c0: 6e74 732e 0a0a 2020 2020 5261 6973 6573  nts...    Raises
+000108d0: 3a0a 2020 2020 2020 2020 4173 7365 7274  :.        Assert
+000108e0: 696f 6e45 7272 6f72 3a20 4966 2074 6865  ionError: If the
+000108f0: 2076 6d61 7020 666f 7220 6b65 7977 6f72   vmap for keywor
+00010900: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
+00010910: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
+00010920: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00010930: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
+00010940: 7468 6520 766d 6170 2074 7261 6e73 666f  the vmap transfo
+00010950: 726d 2e0a 2020 2020 2222 220a 2020 2020  rm..    """.    
+00010960: 636f 6d6d 6f6e 5f64 6576 6963 6520 3d20  common_device = 
+00010970: 7b78 2e64 6576 6963 6520 666f 7220 7820  {x.device for x 
+00010980: 696e 2061 7267 7320 6966 2069 7369 6e73  in args if isins
+00010990: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+000109a0: 726f 7879 297d 0a20 2020 2061 7373 6572  roxy)}.    asser
+000109b0: 7420 6c65 6e28 636f 6d6d 6f6e 5f64 6576  t len(common_dev
+000109c0: 6963 6529 203c 3d20 312c 2022 766d 6170  ice) <= 1, "vmap
+000109d0: 2066 6f72 206d 756c 7469 706c 6520 6465   for multiple de
+000109e0: 7669 6365 7320 6973 206e 6f74 2069 6d70  vices is not imp
+000109f0: 6c65 6d65 6e74 6564 220a 2020 2020 2863  lemented".    (c
+00010a00: 6f6d 6d6f 6e5f 6465 7669 6365 2c29 203d  ommon_device,) =
+00010a10: 2063 6f6d 6d6f 6e5f 6465 7669 6365 2069   common_device i
+00010a20: 6620 6c65 6e28 636f 6d6d 6f6e 5f64 6576  f len(common_dev
+00010a30: 6963 6529 203d 3d20 3120 656c 7365 2028  ice) == 1 else (
+00010a40: 6370 752c 290a 0a20 2020 2069 6620 6178  cpu,)..    if ax
+00010a50: 6973 5f73 697a 6520 6973 204e 6f6e 653a  is_size is None:
+00010a60: 0a20 2020 2020 2020 2028 6178 6973 5f73  .        (axis_s
+00010a70: 697a 652c 2920 3d20 7b78 2e73 6861 7065  ize,) = {x.shape
+00010a80: 5b61 785d 2066 6f72 2078 2c20 6178 2069  [ax] for x, ax i
+00010a90: 6e20 7a69 7028 6172 6773 2c20 696e 5f64  n zip(args, in_d
+00010aa0: 696d 7329 2069 6620 6178 2069 7320 6e6f  ims) if ax is no
+00010ab0: 7420 6e6f 745f 6d61 7070 6564 7d0a 2020  t not_mapped}.  
+00010ac0: 2020 696e 5f64 696d 7320 3d20 696e 5f64    in_dims = in_d
+00010ad0: 696d 7320 6966 2069 7369 6e73 7461 6e63  ims if isinstanc
+00010ae0: 6528 696e 5f64 696d 732c 2053 6571 7565  e(in_dims, Seque
+00010af0: 6e63 6529 2065 6c73 6520 2869 6e5f 6469  nce) else (in_di
+00010b00: 6d73 2c29 0a20 2020 2069 6e5f 6469 6d73  ms,).    in_dims
+00010b10: 203d 2074 7570 6c65 286e 6f74 5f6d 6170   = tuple(not_map
+00010b20: 7065 6420 6966 2069 7369 6e73 7461 6e63  ped if isinstanc
+00010b30: 6528 612c 2028 4e75 6d62 6572 2c20 4e75  e(a, (Number, Nu
+00010b40: 6d62 6572 5072 6f78 7929 2920 656c 7365  mberProxy)) else
+00010b50: 2064 2066 6f72 2061 2c20 6420 696e 2073   d for a, d in s
+00010b60: 6166 655f 7a69 7028 6172 6773 2c20 696e  afe_zip(args, in
+00010b70: 5f64 696d 7329 290a 2020 2020 6f75 745f  _dims)).    out_
+00010b80: 6469 6d73 203d 206f 7574 5f64 696d 7320  dims = out_dims 
+00010b90: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+00010ba0: 745f 6469 6d73 2c20 5365 7175 656e 6365  t_dims, Sequence
+00010bb0: 2920 656c 7365 2028 6f75 745f 6469 6d73  ) else (out_dims
+00010bc0: 2c29 0a0a 2020 2020 6374 7820 3d20 6465  ,)..    ctx = de
+00010bd0: 7461 6368 6564 5f74 7261 6365 2829 2069  tached_trace() i
+00010be0: 6620 6465 7461 6368 6564 2065 6c73 6520  f detached else 
+00010bf0: 6e75 6c6c 636f 6e74 6578 7428 290a 2020  nullcontext().  
+00010c00: 2020 7769 7468 2063 7478 3a0a 2020 2020    with ctx:.    
+00010c10: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
+00010c20: 7465 2074 6865 2042 6174 6368 5661 6c75  te the BatchValu
+00010c30: 6520 7468 726f 7567 6820 7468 6520 7472  e through the tr
+00010c40: 6163 652c 2061 6e64 2074 6865 6e20 756e  ace, and then un
+00010c50: 7772 6170 2069 7420 6174 2074 6865 2065  wrap it at the e
+00010c60: 6e64 0a20 2020 2020 2020 2062 6174 6368  nd.        batch
+00010c70: 6564 5f61 7267 7320 3d20 7361 6665 5f6d  ed_args = safe_m
+00010c80: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
+00010c90: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
+00010ca0: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
+00010cb0: 2929 0a20 2020 2020 2020 2072 6573 756c  )).        resul
+00010cc0: 7420 3d20 6576 616c 5f74 7261 6365 280a  t = eval_trace(.
+00010cd0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+00010ce0: 7469 6f6e 5f74 7261 6365 2c20 2a62 6174  tion_trace, *bat
+00010cf0: 6368 6564 5f61 7267 732c 2073 796d 626f  ched_args, symbo
+00010d00: 6c5f 6d61 7070 6572 3d70 6172 7469 616c  l_mapper=partial
+00010d10: 2876 6d61 705f 7379 6d62 6f6c 5f6d 6170  (vmap_symbol_map
+00010d20: 7065 722c 2061 7869 735f 7369 7a65 3d61  per, axis_size=a
+00010d30: 7869 735f 7369 7a65 292c 202a 2a6b 7761  xis_size), **kwa
+00010d40: 7267 730a 2020 2020 2020 2020 290a 2020  rgs.        ).  
+00010d50: 2020 2020 2020 2320 556e 7772 6170 7069        # Unwrappi
+00010d60: 6e67 2074 6865 2042 6174 6368 6564 5661  ng the BatchedVa
+00010d70: 6c75 6527 730a 2020 2020 2020 2020 6966  lue's.        if
+00010d80: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00010d90: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
+00010da0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
+00010db0: 7265 7375 6c74 2c20 7370 6563 203d 2074  result, spec = t
+00010dc0: 7265 655f 666c 6174 7465 6e28 7265 7375  ree_flatten(resu
+00010dd0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+00010de0: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
+00010df0: 7461 6e63 6528 782c 2042 6174 6368 6564  tance(x, Batched
+00010e00: 5661 6c75 6529 2066 6f72 2078 2069 6e20  Value) for x in 
+00010e10: 666c 6174 5f72 6573 756c 7429 0a20 2020  flat_result).   
+00010e20: 2020 2020 2020 2020 206f 7574 732c 2062           outs, b
+00010e30: 6469 6d73 203d 2075 6e7a 6970 3228 666c  dims = unzip2(fl
+00010e40: 6174 5f72 6573 756c 7429 0a20 2020 2020  at_result).     
+00010e50: 2020 2020 2020 2023 2054 4f44 4f3a 2068         # TODO: h
+00010e60: 616e 646c 6520 7468 6520 6361 7365 2077  andle the case w
+00010e70: 6865 7265 206f 7574 5f64 696d 7320 6973  here out_dims is
+00010e80: 2061 2073 696e 676c 6520 7661 6c75 6520   a single value 
+00010e90: 6265 7474 6572 0a20 2020 2020 2020 2020  better.         
+00010ea0: 2020 2069 6620 6c65 6e28 6f75 745f 6469     if len(out_di
+00010eb0: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
+00010ec0: 2020 2020 2020 2020 2020 6f75 745f 6469            out_di
+00010ed0: 6d73 203d 206f 7574 5f64 696d 7320 2a20  ms = out_dims * 
+00010ee0: 6c65 6e28 6f75 7473 290a 2020 2020 2020  len(outs).      
+00010ef0: 2020 2020 2020 6f75 7473 203d 2073 6166        outs = saf
+00010f00: 655f 6d61 7028 7061 7274 6961 6c28 6d6f  e_map(partial(mo
+00010f10: 7665 5f62 6174 6368 5f64 696d 2c20 6178  ve_batch_dim, ax
+00010f20: 6973 5f73 697a 6529 2c20 6264 696d 732c  is_size), bdims,
+00010f30: 206f 7574 5f64 696d 732c 206f 7574 7329   out_dims, outs)
+00010f40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010f50: 7572 6e20 7472 6565 5f75 6e66 6c61 7474  urn tree_unflatt
+00010f60: 656e 286f 7574 732c 2073 7065 6329 0a20  en(outs, spec). 
+00010f70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00010f80: 616e 6365 2872 6573 756c 742c 2028 4e75  ance(result, (Nu
+00010f90: 6d62 6572 2c20 4e75 6d62 6572 5072 6f78  mber, NumberProx
+00010fa0: 7929 2920 616e 6420 6178 6973 5f73 697a  y)) and axis_siz
+00010fb0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00010fc0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+00010fd0: 4f3a 2066 6574 6368 2074 6865 2064 6566  O: fetch the def
+00010fe0: 6175 6c74 2064 6576 6963 6520 6672 6f6d  ault device from
+00010ff0: 2074 6865 2063 6f6e 7465 7874 0a20 2020   the context.   
+00011000: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00011010: 3d20 6675 6c6c 2873 6861 7065 3d28 292c  = full(shape=(),
+00011020: 2066 696c 6c5f 7661 6c75 653d 7265 7375   fill_value=resu
+00011030: 6c74 2c20 6465 7669 6365 3d63 6f6d 6d6f  lt, device=commo
+00011040: 6e5f 6465 7669 6365 290a 2020 2020 2020  n_device).      
+00011050: 2020 2020 2020 7265 7375 6c74 203d 2042        result = B
+00011060: 6174 6368 6564 5661 6c75 6528 7265 7375  atchedValue(resu
+00011070: 6c74 2c20 6e6f 745f 6d61 7070 6564 290a  lt, not_mapped).
+00011080: 2020 2020 2020 2020 656c 6966 2028 0a20          elif (. 
+00011090: 2020 2020 2020 2020 2020 2069 7369 6e73             isins
+000110a0: 7461 6e63 6528 7265 7375 6c74 2c20 4261  tance(result, Ba
+000110b0: 7463 6865 6456 616c 7565 290a 2020 2020  tchedValue).    
+000110c0: 2020 2020 2020 2020 616e 6420 6973 696e          and isin
+000110d0: 7374 616e 6365 2872 6573 756c 742e 7661  stance(result.va
+000110e0: 6c75 652c 2028 4e75 6d62 6572 2c20 4e75  lue, (Number, Nu
+000110f0: 6d62 6572 5072 6f78 7929 290a 2020 2020  mberProxy)).    
+00011100: 2020 2020 2020 2020 616e 6420 6178 6973          and axis
+00011110: 5f73 697a 6520 6973 206e 6f74 204e 6f6e  _size is not Non
+00011120: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
+00011130: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00011140: 3d20 4261 7463 6865 6456 616c 7565 2866  = BatchedValue(f
+00011150: 756c 6c28 7368 6170 653d 2829 2c20 6669  ull(shape=(), fi
+00011160: 6c6c 5f76 616c 7565 3d72 6573 756c 742e  ll_value=result.
+00011170: 7661 6c75 652c 2064 6576 6963 653d 636f  value, device=co
+00011180: 6d6d 6f6e 5f64 6576 6963 6529 2c20 7265  mmon_device), re
+00011190: 7375 6c74 2e62 6174 6368 5f64 696d 290a  sult.batch_dim).
+000111a0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+000111b0: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+000111c0: 2c20 4261 7463 6865 6456 616c 7565 290a  , BatchedValue).
+000111d0: 2020 2020 2020 2020 6f75 7420 3d20 6d6f          out = mo
+000111e0: 7665 5f62 6174 6368 5f64 696d 2861 7869  ve_batch_dim(axi
+000111f0: 735f 7369 7a65 2c20 7265 7375 6c74 2e62  s_size, result.b
+00011200: 6174 6368 5f64 696d 2c20 6f75 745f 6469  atch_dim, out_di
+00011210: 6d73 5b30 5d2c 2072 6573 756c 742e 7661  ms[0], result.va
+00011220: 6c75 6529 0a20 2020 2020 2020 2072 6574  lue).        ret
+00011230: 7572 6e20 6f75 740a 0a0a 766d 6170 5f63  urn out...vmap_c
+00011240: 616c 6c20 3d20 5379 6d62 6f6c 2869 643d  all = Symbol(id=
+00011250: 5472 616e 7366 6f72 6d73 2e56 6d61 704f  Transforms.VmapO
+00011260: 702c 206e 616d 653d 2276 6d61 705f 6361  p, name="vmap_ca
+00011270: 6c6c 222c 206d 6574 613d 7061 7274 6961  ll", meta=partia
+00011280: 6c28 5f76 6d61 705f 6361 6c6c 5f6d 6574  l(_vmap_call_met
+00011290: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
+000112a0: 0a23 2054 4f44 4f3a 2068 6f77 2073 686f  .# TODO: how sho
+000112b0: 756c 6420 7765 2068 616e 646c 6520 6f75  uld we handle ou
+000112c0: 745f 6469 6d73 2068 6572 653f 0a23 2061  t_dims here?.# a
+000112d0: 6c74 686f 7567 6820 6865 7265 2077 6520  lthough here we 
+000112e0: 6172 6520 6361 6c6c 696e 6720 766d 6170  are calling vmap
+000112f0: 206f 6620 6964 656e 7469 7479 2c20 736f   of identity, so
+00011300: 2077 6520 7368 6f75 6c64 206b 6e6f 7720   we should know 
+00011310: 6672 6f6d 2074 6865 2063 616c 6c20 746f  from the call to
+00011320: 2076 6d61 700a 2320 5468 6973 2073 686f   vmap.# This sho
+00011330: 756c 6420 6265 2066 696e 652e 2049 6620  uld be fine. If 
+00011340: 7765 2068 6176 6520 766d 6170 2869 6465  we have vmap(ide
+00011350: 6e74 6974 7928 6675 6e63 292c 206f 7574  ntity(func), out
+00011360: 5f64 696d 733d 4e29 2074 6865 6e20 7468  _dims=N) then th
+00011370: 6973 2072 756c 6520 6973 2066 6972 7374  is rule is first
+00011380: 2075 7365 640a 2320 746f 2067 6574 2074   used.# to get t
+00011390: 6865 2076 6d61 7070 6564 2072 6573 756c  he vmapped resul
+000113a0: 7420 6f66 2069 6465 6e74 6974 7928 6675  t of identity(fu
+000113b0: 6e63 2920 696e 2076 6d61 705f 7379 6d62  nc) in vmap_symb
+000113c0: 6f6c 5f6d 6170 7065 722c 2061 6e64 206f  ol_mapper, and o
+000113d0: 7574 5f64 696d 7320 6973 2068 616e 646c  ut_dims is handl
+000113e0: 6564 0a23 2061 6674 6572 2074 6861 7420  ed.# after that 
+000113f0: 696e 2074 6865 206f 7574 6572 205f 766d  in the outer _vm
+00011400: 6170 5f63 616c 6c5f 6d65 7461 6675 6e63  ap_call_metafunc
+00011410: 2e0a 6465 6620 5f69 6465 6e74 6974 795f  ..def _identity_
+00011420: 6361 6c6c 5f76 6d61 7028 6178 6973 5f73  call_vmap(axis_s
+00011430: 697a 652c 202a 6261 7463 6865 645f 6172  ize, *batched_ar
+00011440: 6773 2c20 7472 6163 653a 2054 7261 6365  gs, trace: Trace
+00011450: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00011460: 2061 7267 732c 2069 6e5f 6469 6d73 203d   args, in_dims =
+00011470: 2075 6e7a 6970 3228 6261 7463 6865 645f   unzip2(batched_
+00011480: 6172 6773 290a 2020 2020 6f75 745f 6469  args).    out_di
+00011490: 6d73 203d 2030 2020 2320 4669 786d 650a  ms = 0  # Fixme.
+000114a0: 2020 2020 6f75 7473 2c20 6f75 745f 6469      outs, out_di
+000114b0: 6d73 203d 205f 766d 6170 5f63 616c 6c5f  ms = _vmap_call_
+000114c0: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
+000114d0: 6172 6773 2c20 696e 5f64 696d 732c 206f  args, in_dims, o
+000114e0: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
+000114f0: 7a65 2c20 6675 6e63 7469 6f6e 5f74 7261  ze, function_tra
+00011500: 6365 3d74 7261 6365 2c20 2a2a 6b77 6172  ce=trace, **kwar
+00011510: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
+00011520: 7461 6e63 6528 6f75 7473 2c20 5365 7175  tance(outs, Sequ
+00011530: 656e 6365 293a 0a20 2020 2020 2020 2072  ence):.        r
+00011540: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+00011550: 6169 725f 746f 5f62 6174 6368 6564 5f76  air_to_batched_v
+00011560: 616c 7565 2c20 7361 6665 5f7a 6970 286f  alue, safe_zip(o
+00011570: 7574 732c 206f 7574 5f64 696d 7329 290a  uts, out_dims)).
+00011580: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+00011590: 6564 5661 6c75 6528 6f75 7473 2c20 6f75  edValue(outs, ou
+000115a0: 745f 6469 6d73 290a 0a0a 766d 6170 5f69  t_dims)...vmap_i
+000115b0: 6d70 6c73 5b54 7261 6e73 666f 726d 732e  mpls[Transforms.
+000115c0: 4964 656e 7469 7479 4f70 5d20 3d20 5f69  IdentityOp] = _i
+000115d0: 6465 6e74 6974 795f 6361 6c6c 5f76 6d61  dentity_call_vma
+000115e0: 700a 0a0a 6465 6620 5f6a 7670 5f63 616c  p...def _jvp_cal
+000115f0: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
+00011600: 2c20 6261 7463 6865 645f 7072 696d 616c  , batched_primal
+00011610: 732c 2062 6174 6368 6564 5f74 616e 6765  s, batched_tange
+00011620: 6e74 732c 202a 2c20 6675 6e63 7469 6f6e  nts, *, function
+00011630: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
+00011640: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
+00011650: 696d 616c 732c 2070 7269 6d61 6c73 5f62  imals, primals_b
+00011660: 6469 6d73 203d 2073 6166 655f 7a69 7028  dims = safe_zip(
+00011670: 2a62 6174 6368 6564 5f70 7269 6d61 6c73  *batched_primals
+00011680: 290a 2020 2020 7461 6e67 656e 7473 2c20  ).    tangents, 
+00011690: 7461 6e67 656e 7473 5f62 6469 6d73 203d  tangents_bdims =
+000116a0: 2073 6166 655f 7a69 7028 2a62 6174 6368   safe_zip(*batch
+000116b0: 6564 5f74 616e 6765 6e74 7329 0a20 2020  ed_tangents).   
+000116c0: 206a 7670 5f66 756e 6320 3d20 7061 7274   jvp_func = part
+000116d0: 6961 6c28 5f6a 7670 5f63 616c 6c5f 6d65  ial(_jvp_call_me
+000116e0: 7461 6675 6e63 2c20 4661 6c73 652c 2066  tafunc, False, f
+000116f0: 756e 6374 696f 6e5f 7472 6163 653d 6675  unction_trace=fu
+00011700: 6e63 7469 6f6e 5f74 7261 6365 290a 2020  nction_trace).  
+00011710: 2020 766d 6170 7065 645f 6a76 705f 6675    vmapped_jvp_fu
+00011720: 6e63 203d 2076 6d61 7028 6a76 705f 6675  nc = vmap(jvp_fu
+00011730: 6e63 2c20 696e 5f64 696d 733d 2870 7269  nc, in_dims=(pri
+00011740: 6d61 6c73 5f62 6469 6d73 2c20 7461 6e67  mals_bdims, tang
+00011750: 656e 7473 5f62 6469 6d73 292c 2061 7869  ents_bdims), axi
+00011760: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
+00011770: 290a 2020 2020 7265 7375 6c74 203d 2076  ).    result = v
+00011780: 6d61 7070 6564 5f6a 7670 5f66 756e 6328  mapped_jvp_func(
+00011790: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+000117a0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
+000117b0: 2072 6574 7572 6e20 7472 6565 5f6d 6170   return tree_map
+000117c0: 286c 616d 6264 6120 783a 2042 6174 6368  (lambda x: Batch
+000117d0: 6564 5661 6c75 6528 782c 2030 292c 2072  edValue(x, 0), r
+000117e0: 6573 756c 7429 0a0a 0a76 6d61 705f 696d  esult)...vmap_im
+000117f0: 706c 735b 5472 616e 7366 6f72 6d73 2e4a  pls[Transforms.J
+00011800: 7670 4f70 5d20 3d20 5f6a 7670 5f63 616c  vpOp] = _jvp_cal
+00011810: 6c5f 766d 6170 0a0a 0a64 6566 2076 6d61  l_vmap...def vma
+00011820: 7028 6675 6e63 2c20 696e 5f64 696d 733d  p(func, in_dims=
+00011830: 302c 206f 7574 5f64 696d 733d 302c 2061  0, out_dims=0, a
+00011840: 7869 735f 7369 7a65 3d4e 6f6e 6529 3a0a  xis_size=None):.
+00011850: 2020 2020 2222 2256 6563 746f 7269 7a69      """Vectorizi
+00011860: 6e67 2074 7261 6e73 666f 726d 2066 6f72  ng transform for
+00011870: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
+00011880: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
+00011890: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
+000118a0: 6c6c 6162 6c65 293a 2041 2054 6875 6e64  llable): A Thund
+000118b0: 6572 2066 756e 6374 696f 6e20 746f 2062  er function to b
+000118c0: 6520 7472 616e 7366 6f72 6d65 642e 0a0a  e transformed...
+000118d0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000118e0: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
+000118f0: 2076 6d61 7070 6564 2076 6572 7369 6f6e   vmapped version
+00011900: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+00011910: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+00011920: 2054 4f44 4f3a 2066 6c61 7474 656e 0a20   TODO: flatten. 
+00011930: 2020 2023 2049 6e20 4a41 5820 666c 6174     # In JAX flat
+00011940: 7465 6e69 6e67 206f 6620 696e 5f64 696d  tening of in_dim
+00011950: 7320 6973 2072 6174 6865 7220 636f 6d70  s is rather comp
+00011960: 6c69 6361 7465 6420 6265 6361 7573 6520  licated because 
+00011970: 6974 2063 616e 206f 7074 696f 6e61 6c6c  it can optionall
+00011980: 7920 6265 0a20 2020 2023 2073 7065 6369  y be.    # speci
+00011990: 6669 6564 2061 7320 6120 e280 9c70 7265  fied as a ...pre
+000119a0: 6669 78e2 809d 2070 7974 7265 652c 206d  fix... pytree, m
+000119b0: 6561 6e69 6e67 2074 6861 7420 6120 7369  eaning that a si
+000119c0: 6e67 6c65 206c 6561 6620 7661 6c75 6520  ngle leaf value 
+000119d0: 6361 6e20 6265 2061 7070 6c69 6564 0a20  can be applied. 
+000119e0: 2020 2023 2074 6f20 616e 2065 6e74 6972     # to an entir
+000119f0: 6520 7375 622d 7079 7472 6565 2e0a 0a20  e sub-pytree... 
+00011a00: 2020 2064 6566 2066 6c61 7474 656e 5f66     def flatten_f
+00011a10: 756e 635f 666f 725f 766d 6170 2866 756e  unc_for_vmap(fun
+00011a20: 632c 2061 7267 732c 206b 7761 7267 7329  c, args, kwargs)
+00011a30: 3a0a 2020 2020 2020 2020 666c 6174 5f61  :.        flat_a
+00011a40: 7267 732c 2073 7065 6320 3d20 7472 6565  rgs, spec = tree
+00011a50: 5f66 6c61 7474 656e 2828 6172 6773 2c20  _flatten((args, 
+00011a60: 6b77 6172 6773 2929 0a0a 2020 2020 2020  kwargs))..      
+00011a70: 2020 6465 6620 666c 6174 5f66 756e 6328    def flat_func(
+00011a80: 2a66 6c61 745f 6172 6773 293a 0a20 2020  *flat_args):.   
+00011a90: 2020 2020 2020 2020 2066 6e5f 6172 6773           fn_args
+00011aa0: 2c20 666e 5f6b 7761 7267 7320 3d20 7472  , fn_kwargs = tr
+00011ab0: 6565 5f75 6e66 6c61 7474 656e 2866 6c61  ee_unflatten(fla
+00011ac0: 745f 6172 6773 2c20 7370 6563 290a 2020  t_args, spec).  
+00011ad0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00011ae0: 2066 756e 6328 2a66 6e5f 6172 6773 2c20   func(*fn_args, 
+00011af0: 2a2a 666e 5f6b 7761 7267 7329 0a0a 2020  **fn_kwargs)..  
+00011b00: 2020 2020 2020 7265 7475 726e 2066 6c61        return fla
+00011b10: 745f 6675 6e63 2c20 666c 6174 5f61 7267  t_func, flat_arg
+00011b20: 732c 2073 7065 630a 0a20 2020 2064 6566  s, spec..    def
+00011b30: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
+00011b40: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00011b50: 2020 2066 756e 635f 666c 6174 2c20 6172     func_flat, ar
+00011b60: 6773 5f66 6c61 742c 2061 7267 735f 7370  gs_flat, args_sp
+00011b70: 6563 203d 2066 6c61 7474 656e 5f66 756e  ec = flatten_fun
+00011b80: 635f 666f 725f 766d 6170 2866 756e 632c  c_for_vmap(func,
+00011b90: 2061 7267 732c 206b 7761 7267 7329 0a20   args, kwargs). 
+00011ba0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00011bb0: 616e 6365 2869 6e5f 6469 6d73 2c20 696e  ance(in_dims, in
+00011bc0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00011bd0: 696e 5f64 696d 735f 666c 6174 203d 2028  in_dims_flat = (
+00011be0: 696e 5f64 696d 732c 2920 2a20 6c65 6e28  in_dims,) * len(
+00011bf0: 6172 6773 5f66 6c61 7429 0a20 2020 2020  args_flat).     
+00011c00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00011c10: 2020 2020 2069 6e5f 6469 6d73 5f66 6c61       in_dims_fla
+00011c20: 742c 2069 6e5f 6469 6d73 5f73 7065 6320  t, in_dims_spec 
+00011c30: 3d20 7472 6565 5f66 6c61 7474 656e 2869  = tree_flatten(i
+00011c40: 6e5f 6469 6d73 290a 2020 2020 2020 2020  n_dims).        
+00011c50: 2020 2020 6173 7365 7274 206c 656e 2869      assert len(i
+00011c60: 6e5f 6469 6d73 5f66 6c61 7429 203d 3d20  n_dims_flat) == 
+00011c70: 6c65 6e28 6172 6773 5f66 6c61 7429 2c20  len(args_flat), 
+00011c80: 2269 6e5f 6469 6d73 206d 7573 7420 6861  "in_dims must ha
+00011c90: 7665 2074 6865 2073 616d 6520 6c65 6e67  ve the same leng
+00011ca0: 7468 2061 7320 6172 6773 2c20 6b77 6172  th as args, kwar
+00011cb0: 6773 220a 2020 2020 2020 2020 756e 6261  gs".        unba
+00011cc0: 7463 6865 645f 6172 6773 5f66 6c61 7420  tched_args_flat 
+00011cd0: 3d20 5b72 656d 6f76 655f 6261 7463 685f  = [remove_batch_
+00011ce0: 6469 6d28 6172 6729 2069 6620 6973 696e  dim(arg) if isin
+00011cf0: 7374 616e 6365 2861 7267 2c20 5465 6e73  stance(arg, Tens
+00011d00: 6f72 5072 6f78 7929 2065 6c73 6520 6172  orProxy) else ar
+00011d10: 6720 666f 7220 6172 6720 696e 2061 7267  g for arg in arg
+00011d20: 735f 666c 6174 5d0a 2020 2020 2020 2020  s_flat].        
+00011d30: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
+00011d40: 745f 7472 6163 6528 2928 6675 6e63 5f66  t_trace()(func_f
+00011d50: 6c61 742c 202a 756e 6261 7463 6865 645f  lat, *unbatched_
+00011d60: 6172 6773 5f66 6c61 7429 0a20 2020 2020  args_flat).     
+00011d70: 2020 206f 7574 7320 3d20 766d 6170 5f63     outs = vmap_c
+00011d80: 616c 6c28 6172 6773 5f66 6c61 742c 2069  all(args_flat, i
+00011d90: 6e5f 6469 6d73 5f66 6c61 742c 206f 7574  n_dims_flat, out
+00011da0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
+00011db0: 3d61 7869 735f 7369 7a65 2c20 6675 6e63  =axis_size, func
+00011dc0: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
+00011dd0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00011de0: 206f 7574 730a 0a20 2020 2072 6574 7572   outs..    retur
+00011df0: 6e20 7772 6170 7065 720a 0a0a 2320 544f  n wrapper...# TO
+00011e00: 444f 2054 6869 7320 6675 6e63 7469 6f6e  DO This function
+00011e10: 2063 6f6d 6d65 6e74 6564 206f 7574 2062   commented out b
+00011e20: 6563 6175 7365 2069 7420 6361 6c6c 7320  ecause it calls 
+00011e30: 6d61 6b65 5f74 7261 6365 642c 2077 6869  make_traced, whi
+00011e40: 6368 2064 6f65 7320 6e6f 7420 6578 6973  ch does not exis
+00011e50: 740a 2320 6465 6620 766d 6170 5f65 6167  t.# def vmap_eag
+00011e60: 6572 2866 756e 632c 2061 7267 732c 2069  er(func, args, i
+00011e70: 6e5f 6469 6d73 3d30 2c20 6f75 745f 6469  n_dims=0, out_di
+00011e80: 6d73 3d30 2c20 6178 6973 5f73 697a 653d  ms=0, axis_size=
+00011e90: 4e6f 6e65 2c20 6578 6563 7574 6f72 3d22  None, executor="
+00011ea0: 746f 7263 6822 293a 0a23 2020 2020 2022  torch"):.#     "
+00011eb0: 2222 436f 6d70 7574 6573 2074 6865 2076  ""Computes the v
+00011ec0: 6d61 7020 6f66 2061 2054 6875 6e64 6572  map of a Thunder
+00011ed0: 2066 756e 6374 696f 6e2e 0a0a 2320 2020   function...#   
+00011ee0: 2020 4172 6773 3a0a 2320 2020 2020 2020    Args:.#       
+00011ef0: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
+00011f00: 293a 2041 2054 6875 6e64 6572 2066 756e  ): A Thunder fun
+00011f10: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
+00011f20: 7366 6f72 6d65 642e 0a23 2020 2020 2020  sformed..#      
+00011f30: 2020 2061 7267 7320 285f 7479 7065 5f29     args (_type_)
+00011f40: 3a20 4172 6773 206f 6620 7468 6520 6675  : Args of the fu
+00011f50: 6e63 7469 6f6e 2e0a 2320 2020 2020 2020  nction..#       
+00011f60: 2020 6578 6563 7574 6f72 2028 7374 722c    executor (str,
+00011f70: 206f 7074 696f 6e61 6c29 3a20 4578 6563   optional): Exec
+00011f80: 7574 6f72 2074 6f20 7573 652e 2044 6566  utor to use. Def
+00011f90: 6175 6c74 7320 746f 2022 746f 7263 6822  aults to "torch"
+00011fa0: 2e0a 0a23 2020 2020 2052 6574 7572 6e73  ...#     Returns
+00011fb0: 3a0a 2320 2020 2020 2020 2020 5468 6520  :.#         The 
+00011fc0: 7265 7375 6c74 206f 6620 7468 6520 766d  result of the vm
+00011fd0: 6170 7065 6420 6675 6e63 7469 6f6e 2e0a  apped function..
+00011fe0: 2320 2020 2020 2222 220a 2320 2020 2020  #     """.#     
+00011ff0: 2320 544f 444f 3a20 6669 7820 7468 6973  # TODO: fix this
+00012000: 202d 206e 6f74 2061 6c6c 2061 7267 7320   - not all args 
+00012010: 6d61 7920 6265 2062 6174 6368 6564 0a23  may be batched.#
+00012020: 2020 2020 2023 2054 4f44 4f3a 2068 6572       # TODO: her
+00012030: 6520 7765 2061 7373 756d 6520 6261 7463  e we assume batc
+00012040: 6820 6178 6973 2069 7320 300a 2320 2020  h axis is 0.#   
+00012050: 2020 766d 6170 5f74 7261 6365 203d 206d    vmap_trace = m
+00012060: 616b 655f 7472 6163 6528 0a23 2020 2020  ake_trace(.#    
+00012070: 2020 2020 2076 6d61 7028 6675 6e63 2c20       vmap(func, 
+00012080: 696e 5f64 696d 733d 696e 5f64 696d 732c  in_dims=in_dims,
+00012090: 206f 7574 5f64 696d 733d 6f75 745f 6469   out_dims=out_di
+000120a0: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
+000120b0: 6973 5f73 697a 6529 2c20 6578 6563 7574  is_size), execut
+000120c0: 6f72 3d65 7865 6375 746f 722c 0a23 2020  or=executor,.#  
+000120d0: 2020 2020 2020 202a 6172 6773 290a 2320         *args).# 
+000120e0: 2020 2020 766d 6170 5f74 7261 6365 6420      vmap_traced 
+000120f0: 3d20 6d61 6b65 5f74 7261 6365 6428 7061  = make_traced(pa
+00012100: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
+00012110: 2c20 766d 6170 5f74 7261 6365 292c 2065  , vmap_trace), e
+00012120: 7865 6375 746f 723d 6578 6563 7574 6f72  xecutor=executor
+00012130: 290a 2320 2020 2020 7265 7475 726e 2076  ).#     return v
+00012140: 6d61 705f 7472 6163 6564 282a 6172 6773  map_traced(*args
+00012150: 290a 0a0a 2320 4a56 5020 7472 616e 7366  )...# JVP transf
+00012160: 6f72 6d0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  orm.# ----------
+00012170: 2d2d 2d0a 0a0a 4064 6174 6163 6c61 7373  ---...@dataclass
+00012180: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
+00012190: 6173 7320 4a56 5044 7561 6c3a 0a20 2020  ass JVPDual:.   
+000121a0: 2022 2222 4475 616c 206e 756d 6265 7220   """Dual number 
+000121b0: 666f 7220 7468 6520 4a56 5020 7472 616e  for the JVP tran
+000121c0: 7366 6f72 6d2e 0a0a 2020 2020 4174 7472  sform...    Attr
+000121d0: 6962 7574 6573 3a0a 2020 2020 2020 2020  ibutes:.        
+000121e0: 7072 696d 616c 3a20 5072 696d 616c 2076  primal: Primal v
+000121f0: 616c 7565 2e0a 2020 2020 2020 2020 7461  alue..        ta
+00012200: 6e67 656e 743a 2054 616e 6765 6e74 2076  ngent: Tangent v
+00012210: 616c 7565 2e0a 2020 2020 2222 220a 0a20  alue..    """.. 
+00012220: 2020 2070 7269 6d61 6c3a 2041 6e79 0a20     primal: Any. 
+00012230: 2020 2074 616e 6765 6e74 3a20 416e 790a     tangent: Any.
+00012240: 0a20 2020 2064 6566 205f 5f69 7465 725f  .    def __iter_
+00012250: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
+00012260: 2079 6965 6c64 2073 656c 662e 7072 696d   yield self.prim
+00012270: 616c 0a20 2020 2020 2020 2079 6965 6c64  al.        yield
+00012280: 2073 656c 662e 7461 6e67 656e 740a 0a0a   self.tangent...
+00012290: 6465 6620 7061 6972 5f74 6f5f 6a76 705f  def pair_to_jvp_
+000122a0: 6475 616c 2870 6169 7229 3a0a 2020 2020  dual(pair):.    
+000122b0: 2222 2243 6f6e 7665 7274 7320 6120 7061  """Converts a pa
+000122c0: 6972 2074 6f20 6120 4a56 5044 7561 6c2e  ir to a JVPDual.
+000122d0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000122e0: 2020 2020 7061 6972 2028 5365 7175 656e      pair (Sequen
+000122f0: 6365 293a 2050 6169 7220 746f 2063 6f6e  ce): Pair to con
+00012300: 7665 7274 2e0a 0a20 2020 2052 6574 7572  vert...    Retur
+00012310: 6e73 3a0a 2020 2020 2020 2020 4a56 5044  ns:.        JVPD
+00012320: 7561 6c3a 204a 5650 4475 616c 2072 6570  ual: JVPDual rep
+00012330: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+00012340: 6865 2070 6169 722e 0a20 2020 2022 2222  he pair..    """
+00012350: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+00012360: 6365 2870 6169 722c 204a 5650 4475 616c  ce(pair, JVPDual
+00012370: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00012380: 6e20 7061 6972 0a20 2020 2065 6c73 653a  n pair.    else:
+00012390: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000123a0: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
+000123b0: 2053 6571 7565 6e63 6529 2061 6e64 206c   Sequence) and l
+000123c0: 656e 2870 6169 7229 203d 3d20 320a 2020  en(pair) == 2.  
+000123d0: 2020 2020 2020 7265 7475 726e 204a 5650        return JVP
+000123e0: 4475 616c 282a 7061 6972 290a 0a0a 6465  Dual(*pair)...de
+000123f0: 6620 7369 6e5f 6a76 7028 613a 204a 5650  f sin_jvp(a: JVP
+00012400: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
+00012410: 203d 2061 0a20 2020 2072 6574 7572 6e20   = a.    return 
+00012420: 4a56 5044 7561 6c28 7072 696d 732e 7369  JVPDual(prims.si
+00012430: 6e28 7829 2c20 7072 696d 732e 636f 7328  n(x), prims.cos(
+00012440: 7829 202a 2078 6429 0a0a 0a64 6566 206d  x) * xd)...def m
+00012450: 756c 5f6a 7670 2861 3a20 4a56 5044 7561  ul_jvp(a: JVPDua
+00012460: 6c2c 2062 3a20 4a56 5044 7561 6c29 3a0a  l, b: JVPDual):.
+00012470: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
+00012480: 2020 792c 2079 6420 3d20 620a 2020 2020    y, yd = b.    
+00012490: 7265 7475 726e 204a 5650 4475 616c 2878  return JVPDual(x
+000124a0: 202a 2079 2c20 7820 2a20 7964 202b 2079   * y, x * yd + y
+000124b0: 202a 2078 6429 0a0a 0a64 6566 2061 6464   * xd)...def add
+000124c0: 5f6a 7670 2861 3a20 4a56 5044 7561 6c2c  _jvp(a: JVPDual,
+000124d0: 2062 3a20 4a56 5044 7561 6c29 3a0a 2020   b: JVPDual):.  
+000124e0: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
+000124f0: 792c 2079 6420 3d20 620a 2020 2020 7265  y, yd = b.    re
+00012500: 7475 726e 204a 5650 4475 616c 2878 202b  turn JVPDual(x +
+00012510: 2079 2c20 7864 202b 2079 6429 0a0a 0a64   y, xd + yd)...d
+00012520: 6566 2062 726f 6164 6361 7374 5f69 6e5f  ef broadcast_in_
+00012530: 6469 6d5f 6a76 7028 613a 204a 5650 4475  dim_jvp(a: JVPDu
+00012540: 616c 2c20 7368 6170 653a 2074 7570 6c65  al, shape: tuple
+00012550: 5b4a 5650 4475 616c 2c20 2e2e 2e5d 2c20  [JVPDual, ...], 
+00012560: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+00012570: 696f 6e73 3a20 7475 706c 655b 4a56 5044  ions: tuple[JVPD
+00012580: 7561 6c2c 202e 2e2e 5d29 202d 3e20 4a56  ual, ...]) -> JV
+00012590: 5044 7561 6c3a 0a20 2020 2078 2c20 7864  PDual:.    x, xd
+000125a0: 203d 2061 0a20 2020 2023 2054 4f44 4f3a   = a.    # TODO:
+000125b0: 2073 6861 7065 2061 6e64 2062 726f 6164   shape and broad
+000125c0: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
+000125d0: 7368 6f75 6c64 2062 6520 7475 706c 6573  should be tuples
+000125e0: 206f 6620 696e 7473 0a20 2020 2023 2062   of ints.    # b
+000125f0: 7574 2066 6f72 206e 6f77 2069 7427 7320  ut for now it's 
+00012600: 6120 7475 706c 6520 6f66 204a 5650 4475  a tuple of JVPDu
+00012610: 616c 730a 2020 2020 6966 206c 656e 2873  als.    if len(s
+00012620: 6861 7065 2920 3e20 3020 616e 6420 6973  hape) > 0 and is
+00012630: 696e 7374 616e 6365 2873 6861 7065 5b30  instance(shape[0
+00012640: 5d2c 204a 5650 4475 616c 293a 0a20 2020  ], JVPDual):.   
+00012650: 2020 2020 2073 6861 7065 2c20 5f20 3d20       shape, _ = 
+00012660: 7361 6665 5f7a 6970 282a 7368 6170 6529  safe_zip(*shape)
+00012670: 0a20 2020 2069 6620 6c65 6e28 6272 6f61  .    if len(broa
+00012680: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+00012690: 2920 3e20 3020 616e 6420 6973 696e 7374  ) > 0 and isinst
+000126a0: 616e 6365 2862 726f 6164 6361 7374 5f64  ance(broadcast_d
+000126b0: 696d 656e 7369 6f6e 735b 305d 2c20 4a56  imensions[0], JV
+000126c0: 5044 7561 6c29 3a0a 2020 2020 2020 2020  PDual):.        
+000126d0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+000126e0: 696f 6e73 2c20 5f20 3d20 7361 6665 5f7a  ions, _ = safe_z
+000126f0: 6970 282a 6272 6f61 6463 6173 745f 6469  ip(*broadcast_di
+00012700: 6d65 6e73 696f 6e73 290a 2020 2020 7265  mensions).    re
+00012710: 7475 726e 204a 5650 4475 616c 280a 2020  turn JVPDual(.  
+00012720: 2020 2020 2020 7072 696d 732e 6272 6f61        prims.broa
+00012730: 6463 6173 745f 696e 5f64 696d 2878 2c20  dcast_in_dim(x, 
+00012740: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
+00012750: 5f64 696d 656e 7369 6f6e 7329 2c20 7072  _dimensions), pr
+00012760: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
+00012770: 5f64 696d 2878 642c 2073 6861 7065 2c20  _dim(xd, shape, 
+00012780: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+00012790: 696f 6e73 290a 2020 2020 290a 0a0a 6465  ions).    )...de
+000127a0: 6620 756e 7061 636b 5f73 6571 7565 6e63  f unpack_sequenc
+000127b0: 655f 6a76 7028 7365 7175 656e 6365 3a20  e_jvp(sequence: 
+000127c0: 4a56 5044 7561 6c2c 206c 656e 6774 683a  JVPDual, length:
+000127d0: 204a 5650 4475 616c 2920 2d3e 204a 5650   JVPDual) -> JVP
+000127e0: 4475 616c 3a0a 2020 2020 7820 3d20 7472  Dual:.    x = tr
+000127f0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+00012800: 2078 2e70 7269 6d61 6c2c 2073 6571 7565   x.primal, seque
+00012810: 6e63 6529 0a20 2020 2078 6420 3d20 7472  nce).    xd = tr
+00012820: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+00012830: 2078 2e74 616e 6765 6e74 2c20 7365 7175   x.tangent, sequ
+00012840: 656e 6365 290a 2020 2020 6c65 6e67 7468  ence).    length
+00012850: 2c20 5f20 3d20 6c65 6e67 7468 0a20 2020  , _ = length.   
+00012860: 2070 7269 6d61 6c73 203d 2070 7269 6d73   primals = prims
+00012870: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
+00012880: 2878 2c20 6c65 6e67 7468 290a 2020 2020  (x, length).    
+00012890: 7461 6e67 656e 7473 203d 2070 7269 6d73  tangents = prims
+000128a0: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
+000128b0: 2878 642c 206c 656e 6774 6829 0a20 2020  (xd, length).   
+000128c0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+000128d0: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+000128e0: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
+000128f0: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
+00012900: 0a0a 6465 6620 756e 7061 636b 5f74 7269  ..def unpack_tri
+00012910: 7669 616c 5f6a 7670 2878 3a20 4a56 5044  vial_jvp(x: JVPD
+00012920: 7561 6c29 202d 3e20 4a56 5044 7561 6c3a  ual) -> JVPDual:
+00012930: 0a20 2020 2072 6574 7572 6e20 780a 0a0a  .    return x...
+00012940: 6a76 705f 696d 706c 733a 2064 6963 745b  jvp_impls: dict[
+00012950: 7072 696d 732e 5379 6d62 6f6c 2c20 4361  prims.Symbol, Ca
+00012960: 6c6c 6162 6c65 5d20 3d20 6469 6374 2829  llable] = dict()
+00012970: 0a0a 6a76 705f 696d 706c 735b 7072 696d  ..jvp_impls[prim
+00012980: 732e 5072 696d 4944 732e 5349 4e5d 203d  s.PrimIDs.SIN] =
+00012990: 2073 696e 5f6a 7670 0a6a 7670 5f69 6d70   sin_jvp.jvp_imp
+000129a0: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+000129b0: 2e4d 554c 5d20 3d20 6d75 6c5f 6a76 700a  .MUL] = mul_jvp.
+000129c0: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
+000129d0: 5072 696d 4944 732e 4144 445d 203d 2061  PrimIDs.ADD] = a
+000129e0: 6464 5f6a 7670 0a6a 7670 5f69 6d70 6c73  dd_jvp.jvp_impls
+000129f0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e42  [prims.PrimIDs.B
+00012a00: 524f 4144 4341 5354 5f49 4e5f 4449 4d5d  ROADCAST_IN_DIM]
+00012a10: 203d 2062 726f 6164 6361 7374 5f69 6e5f   = broadcast_in_
+00012a20: 6469 6d5f 6a76 700a 2320 6a76 705f 696d  dim_jvp.# jvp_im
+00012a30: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+00012a40: 732e 554e 5041 434b 5f53 4551 5545 4e43  s.UNPACK_SEQUENC
+00012a50: 455d 203d 2075 6e70 6163 6b5f 7365 7175  E] = unpack_sequ
+00012a60: 656e 6365 5f6a 7670 0a23 206a 7670 5f69  ence_jvp.# jvp_i
+00012a70: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+00012a80: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
+00012a90: 4c5d 203d 2075 6e70 6163 6b5f 7472 6976  L] = unpack_triv
+00012aa0: 6961 6c5f 6a76 700a 0a0a 6465 6620 6a76  ial_jvp...def jv
+00012ab0: 705f 7379 6d62 6f6c 5f6d 6170 7065 7228  p_symbol_mapper(
+00012ac0: 7379 6d62 6f6c 3a20 7072 696d 732e 5379  symbol: prims.Sy
+00012ad0: 6d62 6f6c 293a 0a20 2020 2022 2222 4d61  mbol):.    """Ma
+00012ae0: 7073 2061 2073 796d 626f 6c20 746f 2061  ps a symbol to a
+00012af0: 204a 5650 2066 756e 6374 696f 6e20 7468   JVP function th
+00012b00: 6174 2065 7661 6c75 6174 6573 2069 742e  at evaluates it.
+00012b10: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00012b20: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
+00012b30: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
+00012b40: 6c20 746f 2065 7661 6c75 6174 652e 0a0a  l to evaluate...
+00012b50: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00012b60: 2020 2020 4e6f 7449 6d70 6c65 6d65 6e74      NotImplement
+00012b70: 6564 4572 726f 723a 2049 6620 7468 6520  edError: If the 
+00012b80: 4a56 5020 666f 7220 7468 6520 7379 6d62  JVP for the symb
+00012b90: 6f6c 2069 7320 6e6f 7420 696d 706c 656d  ol is not implem
+00012ba0: 656e 7465 642e 0a0a 2020 2020 5265 7475  ented...    Retu
+00012bb0: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+00012bc0: 6c61 626c 653a 204a 5650 2066 756e 6374  lable: JVP funct
+00012bd0: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
+00012be0: 6573 2074 6865 2073 796d 626f 6c2e 0a20  es the symbol.. 
+00012bf0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+00012c00: 7772 6170 5f61 7267 2878 293a 0a20 2020  wrap_arg(x):.   
+00012c10: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00012c20: 6365 2878 2c20 4a56 5044 7561 6c29 3a0a  ce(x, JVPDual):.
+00012c30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012c40: 726e 2078 0a20 2020 2020 2020 2065 6c69  rn x.        eli
+00012c50: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00012c60: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
+00012c70: 2020 2020 2072 6574 7572 6e20 4a56 5044       return JVPD
+00012c80: 7561 6c28 782c 2074 7970 6528 7829 2830  ual(x, type(x)(0
+00012c90: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+00012ca0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00012cb0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+00012cc0: 4a56 5020 7772 6170 5f61 7267 2067 6f74  JVP wrap_arg got
+00012cd0: 2061 6e20 756e 7375 7070 6f72 7465 6420   an unsupported 
+00012ce0: 7479 7065 207b 7479 7065 2878 297d 2229  type {type(x)}")
+00012cf0: 0a0a 2020 2020 2320 4966 2073 796d 626f  ..    # If symbo
+00012d00: 6c2e 6172 6773 2064 6f65 736e 2774 2068  l.args doesn't h
+00012d10: 6176 6520 7375 6263 6c61 7373 6573 206f  ave subclasses o
+00012d20: 6620 5661 7269 6162 6c65 2c20 7468 656e  f Variable, then
+00012d30: 2077 6520 6e65 6564 2074 6f20 7265 7475   we need to retu
+00012d40: 726e 2061 207a 6572 6f20 7461 6e67 656e  rn a zero tangen
+00012d50: 740a 2020 2020 2320 544f 444f 3a20 7468  t.    # TODO: th
+00012d60: 6572 6520 6d61 7920 6265 2061 2062 6574  ere may be a bet
+00012d70: 7465 7220 7761 7920 746f 2064 6574 6563  ter way to detec
+00012d80: 7420 636f 6e73 7461 6e74 7320 696e 2074  t constants in t
+00012d90: 6865 2074 7261 6365 0a20 2020 2069 6620  he trace.    if 
+00012da0: 7379 6d62 6f6c 2e61 7265 5f61 6c6c 5f61  symbol.are_all_a
+00012db0: 7267 735f 636f 6e73 7461 6e74 3a0a 0a20  rgs_constant:.. 
+00012dc0: 2020 2020 2020 2064 6566 207a 6572 6f73         def zeros
+00012dd0: 5f6c 696b 6528 7829 3a0a 2020 2020 2020  _like(x):.      
+00012de0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00012df0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+00012e00: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+00012e10: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
+00012e20: 5f6c 696b 6528 782c 2066 696c 6c5f 7661  _like(x, fill_va
+00012e30: 6c75 653d 3029 0a20 2020 2020 2020 2020  lue=0).         
+00012e40: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00012e50: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
+00012e60: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+00012e70: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
+00012e80: 782e 7661 6c75 6529 2830 290a 2020 2020  x.value)(0).    
+00012e90: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00012ea0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
+00012eb0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00012ec0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
+00012ed0: 7829 2830 290a 2020 2020 2020 2020 2020  x)(0).          
+00012ee0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00012ef0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00012f00: 6c75 6545 7272 6f72 2866 227a 6572 6f73  lueError(f"zeros
+00012f10: 5f6c 696b 6520 696e 7369 6465 204a 5650  _like inside JVP
+00012f20: 2067 6f74 2061 6e20 756e 7375 7070 6f72   got an unsuppor
+00012f30: 7465 6420 7479 7065 207b 7479 7065 2878  ted type {type(x
+00012f40: 297d 2229 0a0a 2020 2020 2020 2020 6465  )}")..        de
+00012f50: 6620 6a76 705f 696d 706c 5f63 6f6e 7374  f jvp_impl_const
+00012f60: 2873 796d 626f 6c2c 202a 6172 6773 2c20  (symbol, *args, 
+00012f70: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00012f80: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
+00012f90: 2073 796d 626f 6c5f 746f 5f65 7661 6c28   symbol_to_eval(
+00012fa0: 7379 6d62 6f6c 2928 2a61 7267 732c 202a  symbol)(*args, *
+00012fb0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+00012fc0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00012fd0: 6365 2870 7269 6d61 6c73 2c20 5365 7175  ce(primals, Sequ
+00012fe0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+00012ff0: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
+00013000: 3d20 7475 706c 6528 7a65 726f 735f 6c69  = tuple(zeros_li
+00013010: 6b65 2870 2920 666f 7220 7020 696e 2070  ke(p) for p in p
+00013020: 7269 6d61 6c73 290a 2020 2020 2020 2020  rimals).        
+00013030: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00013040: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+00013050: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
+00013060: 6970 2870 7269 6d61 6c73 2c20 7461 6e67  ip(primals, tang
+00013070: 656e 7473 2929 0a20 2020 2020 2020 2020  ents)).         
+00013080: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
+00013090: 6c28 7072 696d 616c 732c 207a 6572 6f73  l(primals, zeros
+000130a0: 5f6c 696b 6528 7072 696d 616c 7329 290a  _like(primals)).
+000130b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000130c0: 7061 7274 6961 6c28 6a76 705f 696d 706c  partial(jvp_impl
+000130d0: 5f63 6f6e 7374 2c20 7379 6d62 6f6c 290a  _const, symbol).
+000130e0: 0a20 2020 2023 204e 6f72 6d61 6c20 6361  .    # Normal ca
+000130f0: 7365 2c20 7765 2068 6176 6520 6120 7072  se, we have a pr
+00013100: 6f78 7920 7461 6e67 656e 740a 2020 2020  oxy tangent.    
+00013110: 6a76 705f 696d 706c 203d 206a 7670 5f69  jvp_impl = jvp_i
+00013120: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
+00013130: 7379 6d2e 6964 290a 2020 2020 6966 206a  sym.id).    if j
+00013140: 7670 5f69 6d70 6c20 6973 204e 6f6e 653a  vp_impl is None:
+00013150: 0a20 2020 2020 2020 2072 6169 7365 204e  .        raise N
+00013160: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00013170: 6f72 2866 224a 5650 2066 6f72 207b 7379  or(f"JVP for {sy
+00013180: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
+00013190: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
+000131a0: 290a 0a20 2020 2064 6566 205f 6a76 705f  )..    def _jvp_
+000131b0: 696d 706c 282a 6172 6773 2c20 2a2a 6b77  impl(*args, **kw
+000131c0: 6172 6773 293a 0a20 2020 2020 2020 2061  args):.        a
+000131d0: 7267 7320 3d20 7472 6565 5f6d 6170 2877  rgs = tree_map(w
+000131e0: 7261 705f 6172 672c 2061 7267 7329 0a20  rap_arg, args). 
+000131f0: 2020 2020 2020 2023 2045 7870 6563 7469         # Expecti
+00013200: 6e67 204a 5650 4475 616c 7320 7772 6170  ng JVPDuals wrap
+00013210: 7069 6e67 2070 6169 7273 206f 6620 7072  ping pairs of pr
+00013220: 696d 616c 7320 616e 6420 7461 6e67 656e  imals and tangen
+00013230: 7473 0a20 2020 2020 2020 2061 7373 6572  ts.        asser
+00013240: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
+00013250: 2861 7267 2c20 4a56 5044 7561 6c29 2066  (arg, JVPDual) f
+00013260: 6f72 2061 7267 2069 6e20 7472 6565 5f66  or arg in tree_f
+00013270: 6c61 7474 656e 2861 7267 7329 5b30 5d29  latten(args)[0])
+00013280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00013290: 6a76 705f 696d 706c 282a 6172 6773 2c20  jvp_impl(*args, 
+000132a0: 2a2a 6b77 6172 6773 290a 0a20 2020 2072  **kwargs)..    r
+000132b0: 6574 7572 6e20 5f6a 7670 5f69 6d70 6c0a  eturn _jvp_impl.
+000132c0: 0a0a 6465 6620 5f6a 7670 5f63 616c 6c5f  ..def _jvp_call_
+000132d0: 6d65 7461 6675 6e63 2864 6574 6163 6865  metafunc(detache
+000132e0: 643a 2062 6f6f 6c2c 2070 7269 6d61 6c73  d: bool, primals
+000132f0: 2c20 7461 6e67 656e 7473 2c20 2a2c 2066  , tangents, *, f
+00013300: 756e 6374 696f 6e5f 7472 6163 653a 2054  unction_trace: T
+00013310: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+00013320: 0a20 2020 2022 2222 4d65 7461 6675 6e63  .    """Metafunc
+00013330: 7469 6f6e 2066 6f72 2074 6865 204a 5650  tion for the JVP
+00013340: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
+00013350: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
+00013360: 6574 6163 6865 6420 2862 6f6f 6c29 3a20  etached (bool): 
+00013370: 5768 6574 6865 7220 746f 2064 6574 6163  Whether to detac
+00013380: 6820 7468 6520 7472 6163 652e 0a20 2020  h the trace..   
+00013390: 2020 2020 2070 7269 6d61 6c73 2028 5475       primals (Tu
+000133a0: 706c 655b 5072 6f78 795d 293a 2050 7269  ple[Proxy]): Pri
+000133b0: 6d61 6c20 7661 6c75 6573 2e0a 2020 2020  mal values..    
+000133c0: 2020 2020 7461 6e67 656e 7473 2028 5475      tangents (Tu
+000133d0: 706c 655b 5072 6f78 795d 293a 2054 616e  ple[Proxy]): Tan
+000133e0: 6765 6e74 2076 616c 7565 732e 0a20 2020  gent values..   
+000133f0: 2020 2020 2066 756e 6374 696f 6e5f 7472       function_tr
+00013400: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
+00013410: 6365 206f 6620 7468 6520 6675 6e63 7469  ce of the functi
+00013420: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+00013430: 726d 6564 2e0a 2020 2020 2020 2020 6b77  rmed..        kw
+00013440: 6172 6773 3a20 4b65 7977 6f72 6420 6172  args: Keyword ar
+00013450: 6775 6d65 6e74 732e 0a0a 2020 2020 5261  guments...    Ra
+00013460: 6973 6573 3a0a 2020 2020 2020 2020 4173  ises:.        As
+00013470: 7365 7274 696f 6e45 7272 6f72 3a20 4966  sertionError: If
+00013480: 2074 6865 204a 5650 2066 6f72 206b 6579   the JVP for key
+00013490: 776f 7264 2061 7267 756d 656e 7473 2069  word arguments i
+000134a0: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
+000134b0: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
+000134c0: 0a20 2020 2020 2020 2052 6573 756c 7420  .        Result 
+000134d0: 6f66 2074 6865 204a 5650 2074 7261 6e73  of the JVP trans
+000134e0: 666f 726d 2e0a 2020 2020 2222 220a 2020  form..    """.  
+000134f0: 2020 6173 7365 7274 206c 656e 286b 7761    assert len(kwa
+00013500: 7267 7329 203d 3d20 302c 2022 4a56 5020  rgs) == 0, "JVP 
+00013510: 666f 7220 6b77 6172 6773 2069 7320 6e6f  for kwargs is no
+00013520: 7420 696d 706c 656d 656e 7465 6422 0a0a  t implemented"..
+00013530: 2020 2020 6374 7820 3d20 6465 7461 6368      ctx = detach
+00013540: 6564 5f74 7261 6365 2829 2069 6620 6465  ed_trace() if de
+00013550: 7461 6368 6564 2065 6c73 6520 6e75 6c6c  tached else null
+00013560: 636f 6e74 6578 7428 290a 2020 2020 7769  context().    wi
+00013570: 7468 2063 7478 3a0a 2020 2020 2020 2020  th ctx:.        
+00013580: 2320 5772 6170 7069 6e67 2074 6865 2070  # Wrapping the p
+00013590: 7269 6d61 6c73 2061 6e64 2074 616e 6765  rimals and tange
+000135a0: 6e74 7320 696e 204a 5650 4475 616c 7320  nts in JVPDuals 
+000135b0: 6973 206e 6f74 2073 7472 6963 746c 7920  is not strictly 
+000135c0: 6e65 6365 7373 6172 792c 2062 7574 2069  necessary, but i
+000135d0: 7420 6d61 6b65 730a 2020 2020 2020 2020  t makes.        
+000135e0: 2320 7468 6520 636f 6465 206d 6f72 6520  # the code more 
+000135f0: 7265 6164 6162 6c65 0a20 2020 2020 2020  readable.       
+00013600: 2023 2057 6520 7072 6f70 6167 6174 6520   # We propagate 
+00013610: 7468 6520 4a56 5044 7561 6c73 2074 6872  the JVPDuals thr
+00013620: 6f75 6768 2074 6865 2074 7261 6365 2c20  ough the trace, 
+00013630: 616e 6420 7468 656e 2075 6e77 7261 7020  and then unwrap 
+00013640: 7468 656d 2061 7420 7468 6520 656e 640a  them at the end.
+00013650: 2020 2020 2020 2020 7072 696d 616c 735f          primals_
+00013660: 7461 6e67 656e 7473 5f64 7561 6c73 203d  tangents_duals =
+00013670: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
+00013680: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
+00013690: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
+000136a0: 6e67 656e 7473 2929 0a20 2020 2020 2020  ngents)).       
+000136b0: 2072 6573 756c 7420 3d20 6576 616c 5f74   result = eval_t
+000136c0: 7261 6365 2866 756e 6374 696f 6e5f 7472  race(function_tr
+000136d0: 6163 652c 202a 7072 696d 616c 735f 7461  ace, *primals_ta
+000136e0: 6e67 656e 7473 5f64 7561 6c73 2c20 7379  ngents_duals, sy
+000136f0: 6d62 6f6c 5f6d 6170 7065 723d 6a76 705f  mbol_mapper=jvp_
+00013700: 7379 6d62 6f6c 5f6d 6170 7065 7229 0a20  symbol_mapper). 
+00013710: 2020 2020 2020 2023 2055 6e77 7261 7070         # Unwrapp
+00013720: 696e 6720 7468 6520 4a56 5044 7561 6c73  ing the JVPDuals
+00013730: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00013740: 7374 616e 6365 2872 6573 756c 742c 2053  stance(result, S
+00013750: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00013760: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+00013770: 2869 7369 6e73 7461 6e63 6528 782c 204a  (isinstance(x, J
+00013780: 5650 4475 616c 2920 666f 7220 7820 696e  VPDual) for x in
+00013790: 2072 6573 756c 7429 0a20 2020 2020 2020   result).       
+000137a0: 2020 2020 2070 7269 6d61 6c73 2c20 7461       primals, ta
+000137b0: 6e67 656e 7473 203d 2075 6e7a 6970 3228  ngents = unzip2(
+000137c0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
+000137d0: 2020 2020 7265 7475 726e 2070 7269 6d61      return prima
+000137e0: 6c73 2c20 7461 6e67 656e 7473 0a20 2020  ls, tangents.   
+000137f0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00013800: 7374 616e 6365 2872 6573 756c 742c 204a  stance(result, J
+00013810: 5650 4475 616c 290a 2020 2020 2020 2020  VPDual).        
+00013820: 7265 7475 726e 2072 6573 756c 742e 7072  return result.pr
+00013830: 696d 616c 2c20 7265 7375 6c74 2e74 616e  imal, result.tan
+00013840: 6765 6e74 0a0a 0a6a 7670 5f63 616c 6c20  gent...jvp_call 
+00013850: 3d20 5379 6d62 6f6c 2869 643d 5472 616e  = Symbol(id=Tran
+00013860: 7366 6f72 6d73 2e4a 7670 4f70 2c20 6e61  sforms.JvpOp, na
+00013870: 6d65 3d22 6a76 705f 6361 6c6c 222c 206d  me="jvp_call", m
+00013880: 6574 613d 7061 7274 6961 6c28 5f6a 7670  eta=partial(_jvp
+00013890: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
+000138a0: 4661 6c73 6529 290a 0a0a 6465 6620 5f69  False))...def _i
+000138b0: 6465 6e74 6974 795f 6361 6c6c 5f6a 7670  dentity_call_jvp
+000138c0: 282a 6172 6773 3a20 4a56 5044 7561 6c2c  (*args: JVPDual,
+000138d0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+000138e0: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
+000138f0: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
+00013900: 3d20 756e 7a69 7032 2861 7267 7329 0a20  = unzip2(args). 
+00013910: 2020 206f 7574 5f70 7269 6d61 6c73 2c20     out_primals, 
+00013920: 6f75 745f 7461 6e67 656e 7473 203d 205f  out_tangents = _
+00013930: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
+00013940: 6328 4661 6c73 652c 2070 7269 6d61 6c73  c(False, primals
+00013950: 2c20 7461 6e67 656e 7473 2c20 7472 6163  , tangents, trac
+00013960: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+00013970: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+00013980: 7574 5f70 7269 6d61 6c73 2c20 5365 7175  ut_primals, Sequ
+00013990: 656e 6365 293a 0a20 2020 2020 2020 2072  ence):.        r
+000139a0: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+000139b0: 6169 725f 746f 5f6a 7670 5f64 7561 6c2c  air_to_jvp_dual,
+000139c0: 2073 6166 655f 7a69 7028 6f75 745f 7072   safe_zip(out_pr
+000139d0: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
+000139e0: 6e74 7329 290a 2020 2020 7265 7475 726e  nts)).    return
+000139f0: 204a 5650 4475 616c 286f 7574 5f70 7269   JVPDual(out_pri
+00013a00: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
+00013a10: 7473 290a 0a0a 6a76 705f 696d 706c 735b  ts)...jvp_impls[
+00013a20: 5472 616e 7366 6f72 6d73 2e49 6465 6e74  Transforms.Ident
+00013a30: 6974 794f 705d 203d 205f 6964 656e 7469  ityOp] = _identi
+00013a40: 7479 5f63 616c 6c5f 6a76 700a 0a0a 6465  ty_call_jvp...de
+00013a50: 6620 5f76 6d61 705f 6361 6c6c 5f6a 7670  f _vmap_call_jvp
+00013a60: 2861 7267 733a 204a 5650 4475 616c 2c20  (args: JVPDual, 
+00013a70: 696e 5f64 696d 732c 206f 7574 5f64 696d  in_dims, out_dim
+00013a80: 732c 2061 7869 735f 7369 7a65 2c20 7472  s, axis_size, tr
+00013a90: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+00013aa0: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
+00013ab0: 6c73 2c20 7461 6e67 656e 7473 203d 2073  ls, tangents = s
+00013ac0: 6166 655f 7a69 7028 2a61 7267 7329 0a20  afe_zip(*args). 
+00013ad0: 2020 2069 6e5f 6469 6d73 2c20 5f20 3d20     in_dims, _ = 
+00013ae0: 7361 6665 5f7a 6970 282a 696e 5f64 696d  safe_zip(*in_dim
+00013af0: 7329 0a20 2020 206f 7574 5f64 696d 732c  s).    out_dims,
+00013b00: 205f 203d 2073 6166 655f 7a69 7028 2a6f   _ = safe_zip(*o
+00013b10: 7574 5f64 696d 7329 0a20 2020 2076 6d61  ut_dims).    vma
+00013b20: 7070 6564 5f74 7261 6365 203d 2063 6f6e  pped_trace = con
+00013b30: 7374 7275 6374 5f74 7261 6365 2829 280a  struct_trace()(.
+00013b40: 2020 2020 2020 2020 766d 6170 2870 6172          vmap(par
+00013b50: 7469 616c 2865 7661 6c5f 7472 6163 652c  tial(eval_trace,
+00013b60: 2074 7261 6365 292c 2069 6e5f 6469 6d73   trace), in_dims
+00013b70: 3d69 6e5f 6469 6d73 2c20 6f75 745f 6469  =in_dims, out_di
+00013b80: 6d73 3d6f 7574 5f64 696d 732c 2061 7869  ms=out_dims, axi
+00013b90: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
+00013ba0: 292c 202a 7072 696d 616c 730a 2020 2020  ), *primals.    
+00013bb0: 290a 2020 2020 766d 6170 7065 645f 6675  ).    vmapped_fu
+00013bc0: 6e63 203d 2070 6172 7469 616c 2865 7661  nc = partial(eva
+00013bd0: 6c5f 7472 6163 652c 2076 6d61 7070 6564  l_trace, vmapped
+00013be0: 5f74 7261 6365 290a 2020 2020 6f75 745f  _trace).    out_
+00013bf0: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00013c00: 6765 6e74 7320 3d20 6a76 7028 766d 6170  gents = jvp(vmap
+00013c10: 7065 645f 6675 6e63 2928 7072 696d 616c  ped_func)(primal
+00013c20: 732c 2074 616e 6765 6e74 732c 202a 2a6b  s, tangents, **k
+00013c30: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
+00013c40: 696e 7374 616e 6365 286f 7574 5f70 7269  instance(out_pri
+00013c50: 6d61 6c73 2c20 5365 7175 656e 6365 293a  mals, Sequence):
+00013c60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00013c70: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
+00013c80: 5f6a 7670 5f64 7561 6c2c 2073 6166 655f  _jvp_dual, safe_
+00013c90: 7a69 7028 6f75 745f 7072 696d 616c 732c  zip(out_primals,
+00013ca0: 206f 7574 5f74 616e 6765 6e74 7329 290a   out_tangents)).
+00013cb0: 2020 2020 7265 7475 726e 204a 5650 4475      return JVPDu
+00013cc0: 616c 286f 7574 5f70 7269 6d61 6c73 2c20  al(out_primals, 
+00013cd0: 6f75 745f 7461 6e67 656e 7473 290a 0a0a  out_tangents)...
+00013ce0: 6a76 705f 696d 706c 735b 5472 616e 7366  jvp_impls[Transf
+00013cf0: 6f72 6d73 2e56 6d61 704f 705d 203d 205f  orms.VmapOp] = _
+00013d00: 766d 6170 5f63 616c 6c5f 6a76 700a 0a0a  vmap_call_jvp...
+00013d10: 6465 6620 6a76 7028 6675 6e63 293a 0a20  def jvp(func):. 
+00013d20: 2020 2022 2222 4a61 636f 6269 616e 2d76     """Jacobian-v
+00013d30: 6563 746f 7220 7072 6f64 7563 7420 7472  ector product tr
+00013d40: 616e 7366 6f72 6d20 666f 7220 6120 5468  ansform for a Th
+00013d50: 756e 6465 7220 6675 6e63 7469 6f6e 2e0a  under function..
+00013d60: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00013d70: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
+00013d80: 6529 3a20 4120 5468 756e 6465 7220 6675  e): A Thunder fu
+00013d90: 6e63 7469 6f6e 2074 6f20 6265 2074 7261  nction to be tra
+00013da0: 6e73 666f 726d 6564 2e0a 0a20 2020 2052  nsformed...    R
+00013db0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00013dc0: 4361 6c6c 6162 6c65 3a20 4120 6675 6e63  Callable: A func
+00013dd0: 7469 6f6e 2074 6861 7420 636f 6d70 7574  tion that comput
+00013de0: 6573 2074 6865 204a 6163 6f62 6961 6e2d  es the Jacobian-
+00013df0: 7665 6374 6f72 2070 726f 6475 6374 0a20  vector product. 
+00013e00: 2020 2020 2020 2020 2020 2074 616b 696e             takin
+00013e10: 6720 7072 696d 616c 7320 616e 6420 7461  g primals and ta
+00013e20: 6e67 656e 7473 2061 7320 6172 6775 6d65  ngents as argume
+00013e30: 6e74 732e 0a20 2020 2022 2222 0a0a 2020  nts..    """..  
+00013e40: 2020 6465 6620 7772 6170 7065 7228 7072    def wrapper(pr
+00013e50: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
+00013e60: 3a0a 2020 2020 2020 2020 7472 6163 6520  :.        trace 
+00013e70: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+00013e80: 6528 2928 6675 6e63 2c20 2a70 7269 6d61  e()(func, *prima
+00013e90: 6c73 290a 2020 2020 2020 2020 7265 7475  ls).        retu
+00013ea0: 726e 206a 7670 5f63 616c 6c28 7072 696d  rn jvp_call(prim
+00013eb0: 616c 732c 2074 616e 6765 6e74 732c 2066  als, tangents, f
+00013ec0: 756e 6374 696f 6e5f 7472 6163 653d 7472  unction_trace=tr
+00013ed0: 6163 6529 0a0a 2020 2020 7265 7475 726e  ace)..    return
+00013ee0: 2077 7261 7070 6572 0a0a 0a23 2054 4f44   wrapper...# TOD
+00013ef0: 4f20 5468 6973 2066 756e 6374 696f 6e20  O This function 
+00013f00: 636f 6d6d 656e 7465 6420 6f75 7420 6265  commented out be
+00013f10: 6361 7573 6520 6974 2063 616c 6c73 206d  cause it calls m
+00013f20: 616b 655f 7472 6163 6564 2c20 7768 6963  ake_traced, whic
+00013f30: 6820 646f 6573 206e 6f74 2065 7869 7374  h does not exist
+00013f40: 0a23 2064 6566 206a 7670 5f65 6167 6572  .# def jvp_eager
+00013f50: 2866 756e 632c 2070 7269 6d61 6c73 2c20  (func, primals, 
+00013f60: 7461 6e67 656e 7473 2c20 6578 6563 7574  tangents, execut
+00013f70: 6f72 3d22 746f 7263 6822 293a 0a23 2020  or="torch"):.#  
+00013f80: 2020 2022 2222 436f 6d70 7574 6573 2074     """Computes t
+00013f90: 6865 204a 6163 6f62 6961 6e2d 7665 6374  he Jacobian-vect
+00013fa0: 6f72 2070 726f 6475 6374 206f 6620 6120  or product of a 
+00013fb0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+00013fc0: 2e0a 0a23 2020 2020 2041 7267 733a 0a23  ...#     Args:.#
+00013fd0: 2020 2020 2020 2020 2066 756e 6320 2843           func (C
+00013fe0: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
+00013ff0: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
+00014000: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
+00014010: 2320 2020 2020 2020 2020 7072 696d 616c  #         primal
+00014020: 7320 285f 7479 7065 5f29 3a20 5072 696d  s (_type_): Prim
+00014030: 616c 7320 6f66 2074 6865 2066 756e 6374  als of the funct
+00014040: 696f 6e2e 0a23 2020 2020 2020 2020 2074  ion..#         t
+00014050: 616e 6765 6e74 7320 285f 7479 7065 5f29  angents (_type_)
+00014060: 3a20 5461 6e67 656e 7473 206f 6620 7468  : Tangents of th
+00014070: 6520 6675 6e63 7469 6f6e 2e0a 2320 2020  e function..#   
+00014080: 2020 2020 2020 6578 6563 7574 6f72 2028        executor (
+00014090: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
+000140a0: 4578 6563 7574 6f72 2074 6f20 7573 652e  Executor to use.
+000140b0: 2044 6566 6175 6c74 7320 746f 2022 746f   Defaults to "to
+000140c0: 7263 6822 2e0a 0a23 2020 2020 2052 6574  rch"...#     Ret
+000140d0: 7572 6e73 3a0a 2320 2020 2020 2020 2020  urns:.#         
+000140e0: 5468 6520 7265 7375 6c74 206f 6620 7468  The result of th
+000140f0: 6520 4a61 636f 6269 616e 2d76 6563 746f  e Jacobian-vecto
+00014100: 7220 7072 6f64 7563 742e 0a23 2020 2020  r product..#    
+00014110: 2022 2222 0a23 2020 2020 2074 7261 6365   """.#     trace
+00014120: 203d 206d 616b 655f 7472 6163 6528 6675   = make_trace(fu
+00014130: 6e63 2c20 6578 6563 7574 6f72 3d65 7865  nc, executor=exe
+00014140: 6375 746f 722c 202a 7072 696d 616c 7329  cutor, *primals)
+00014150: 0a0a 2320 2020 2020 6465 6620 6a76 705f  ..#     def jvp_
+00014160: 6675 6e63 282a 7072 696d 616c 735f 616e  func(*primals_an
+00014170: 645f 7461 6e67 656e 7473 293a 0a23 2020  d_tangents):.#  
+00014180: 2020 2020 2020 205f 7072 696d 616c 732c         _primals,
+00014190: 205f 7461 6e67 656e 7473 203d 2070 7269   _tangents = pri
+000141a0: 6d61 6c73 5f61 6e64 5f74 616e 6765 6e74  mals_and_tangent
+000141b0: 735b 3a20 6c65 6e28 7072 696d 616c 7329  s[: len(primals)
+000141c0: 5d2c 2070 7269 6d61 6c73 5f61 6e64 5f74  ], primals_and_t
+000141d0: 616e 6765 6e74 735b 6c65 6e28 7072 696d  angents[len(prim
+000141e0: 616c 7329 203a 5d0a 2320 2020 2020 2020  als) :].#       
+000141f0: 2020 7265 7475 726e 205f 6a76 705f 6361    return _jvp_ca
+00014200: 6c6c 5f6d 6574 6166 756e 6328 5f70 7269  ll_metafunc(_pri
+00014210: 6d61 6c73 2c20 5f74 616e 6765 6e74 732c  mals, _tangents,
+00014220: 2074 7261 6365 2c20 6465 7461 6368 6564   trace, detached
+00014230: 3d46 616c 7365 290a 0a23 2020 2020 206a  =False)..#     j
+00014240: 7670 5f74 7261 6365 203d 206d 616b 655f  vp_trace = make_
+00014250: 7472 6163 6528 6a76 705f 6675 6e63 2c20  trace(jvp_func, 
+00014260: 6578 6563 7574 6f72 3d65 7865 6375 746f  executor=executo
+00014270: 7229 282a 7072 696d 616c 732c 202a 7461  r)(*primals, *ta
+00014280: 6e67 656e 7473 290a 2320 2020 2020 6a76  ngents).#     jv
+00014290: 705f 7472 6163 6564 203d 206d 616b 655f  p_traced = make_
+000142a0: 7472 6163 6564 2870 6172 7469 616c 2865  traced(partial(e
+000142b0: 7661 6c5f 7472 6163 652c 206a 7670 5f74  val_trace, jvp_t
+000142c0: 7261 6365 292c 2065 7865 6375 746f 723d  race), executor=
+000142d0: 6578 6563 7574 6f72 290a 2320 2020 2020  executor).#     
+000142e0: 7265 7475 726e 206a 7670 5f74 7261 6365  return jvp_trace
+000142f0: 6428 2a70 7269 6d61 6c73 2c20 2a74 616e  d(*primals, *tan
+00014300: 6765 6e74 7329 0a0a 0a23 2056 4a50 2074  gents)...# VJP t
+00014310: 7261 6e73 666f 726d 0a23 203d 3d3d 3d3d  ransform.# =====
+00014320: 3d3d 3d3d 3d3d 3d3d 0a40 6461 7461 636c  ========.@datacl
+00014330: 6173 7328 6672 6f7a 656e 3d54 7275 6529  ass(frozen=True)
+00014340: 0a63 6c61 7373 2056 4a50 4475 616c 3a0a  .class VJPDual:.
+00014350: 2020 2020 2222 2241 2070 6169 7220 6f66      """A pair of
+00014360: 2070 7269 6d61 6c20 616e 6420 7361 7665   primal and save
+00014370: 6420 696e 666f 726d 6174 696f 6e20 666f  d information fo
+00014380: 7220 6261 636b 7761 7264 2028 7265 7369  r backward (resi
+00014390: 6475 616c 7329 2e0a 0a20 2020 2041 7267  duals)...    Arg
+000143a0: 733a 0a20 2020 2020 2020 2070 7269 6d61  s:.        prima
+000143b0: 6c20 2855 6e69 6f6e 5b50 726f 7879 2c20  l (Union[Proxy, 
+000143c0: 4e75 6d62 6572 5d29 3a20 5072 696d 616c  Number]): Primal
+000143d0: 2076 616c 7565 2c20 692e 652e 2c20 7468   value, i.e., th
+000143e0: 6520 7661 6c75 6520 6265 696e 6720 6469  e value being di
+000143f0: 6666 6572 656e 7469 6174 6564 2e0a 2020  fferentiated..  
+00014400: 2020 2020 2020 7265 7369 6475 616c 7320        residuals 
+00014410: 2854 7570 6c65 5b50 726f 7879 2c20 2e2e  (Tuple[Proxy, ..
+00014420: 2e5d 293a 2052 6573 6964 7561 6c73 2c20  .]): Residuals, 
+00014430: 692e 652e 2c20 7468 6520 7661 6c75 6573  i.e., the values
+00014440: 2074 6861 7420 6172 650a 2020 2020 2020   that are.      
+00014450: 2020 2020 2020 7361 7665 6420 666f 7220        saved for 
+00014460: 7468 6520 6261 636b 7761 7264 2e0a 0a20  the backward... 
+00014470: 2020 2059 6965 6c64 733a 0a20 2020 2020     Yields:.     
+00014480: 2020 2054 7570 6c65 5b56 6172 6961 626c     Tuple[Variabl
+00014490: 652c 2054 7570 6c65 5b56 6172 6961 626c  e, Tuple[Variabl
+000144a0: 652c 202e 2e2e 5d2c 2043 616c 6c61 626c  e, ...], Callabl
+000144b0: 655d 3a20 5072 696d 616c 2061 6e64 2072  e]: Primal and r
+000144c0: 6573 6964 7561 6c73 0a20 2020 2022 2222  esiduals.    """
+000144d0: 0a0a 2020 2020 7072 696d 616c 3a20 5072  ..    primal: Pr
+000144e0: 6f78 7920 7c20 4e75 6d62 6572 0a20 2020  oxy | Number.   
+000144f0: 2072 6573 6964 7561 6c73 3a20 7475 706c   residuals: tupl
+00014500: 655b 5072 6f78 792c 202e 2e2e 5d0a 0a20  e[Proxy, ...].. 
+00014510: 2020 2064 6566 205f 5f69 7465 725f 5f28     def __iter__(
+00014520: 7365 6c66 293a 0a20 2020 2020 2020 2079  self):.        y
+00014530: 6965 6c64 2073 656c 662e 7072 696d 616c  ield self.primal
+00014540: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+00014550: 656c 662e 7265 7369 6475 616c 730a 0a0a  elf.residuals...
+00014560: 636c 6173 7320 4e6f 5075 6c6c 6261 636b  class NoPullback
+00014570: 3a0a 2020 2020 2222 2241 2064 756d 6d79  :.    """A dummy
+00014580: 2070 756c 6c62 6163 6b20 6675 6e63 7469   pullback functi
+00014590: 6f6e 2074 6861 7420 7265 7475 726e 7320  on that returns 
+000145a0: 4e6f 6e65 206f 7220 7261 6973 6573 2061  None or raises a
+000145b0: 6e20 6572 726f 722e 2222 220a 0a20 2020  n error."""..   
+000145c0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000145d0: 6c66 2c20 6e75 6d5f 6172 6773 3d30 293a  lf, num_args=0):
+000145e0: 0a20 2020 2020 2020 2073 656c 662e 6e75  .        self.nu
+000145f0: 6d5f 6172 6773 203d 206e 756d 5f61 7267  m_args = num_arg
+00014600: 730a 0a20 2020 2064 6566 205f 5f63 616c  s..    def __cal
+00014610: 6c5f 5f28 7365 6c66 2c20 2a61 7267 732c  l__(self, *args,
+00014620: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00014630: 2020 2020 6966 2073 656c 662e 6e75 6d5f      if self.num_
+00014640: 6172 6773 203e 2030 3a0a 2020 2020 2020  args > 0:.      
+00014650: 2020 2020 2020 7265 7475 726e 2028 4e6f        return (No
+00014660: 6e65 2c29 202a 2073 656c 662e 6e75 6d5f  ne,) * self.num_
+00014670: 6172 6773 0a20 2020 2020 2020 2072 6169  args.        rai
+00014680: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00014690: 2250 756c 6c62 6163 6b20 6361 6c6c 6564  "Pullback called
+000146a0: 206f 6e20 6120 6e6f 6e2d 6469 6666 6572   on a non-differ
+000146b0: 656e 7469 6162 6c65 2073 796d 626f 6c20  entiable symbol 
+000146c0: 6f72 2061 2063 6f6e 7374 616e 742e 2229  or a constant.")
+000146d0: 0a0a 0a63 6c61 7373 205a 6572 6f42 6163  ...class ZeroBac
+000146e0: 6b77 6172 643a 0a20 2020 2022 2222 4120  kward:.    """A 
+000146f0: 6865 6c70 6572 2062 6163 6b77 6172 6420  helper backward 
+00014700: 6675 6e63 7469 6f6e 2074 6861 7420 7265  function that re
+00014710: 7475 726e 7320 7a65 726f 732e 2222 220a  turns zeros.""".
+00014720: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00014730: 5f28 7365 6c66 2c20 6e75 6d5f 6172 6773  _(self, num_args
+00014740: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00014750: 6e75 6d5f 6172 6773 203d 206e 756d 5f61  num_args = num_a
+00014760: 7267 730a 0a20 2020 2064 6566 205f 5f63  rgs..    def __c
+00014770: 616c 6c5f 5f28 7365 6c66 2c20 2a61 7267  all__(self, *arg
+00014780: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+00014790: 2020 2020 2020 2320 4173 7375 6d69 6e67        # Assuming
+000147a0: 2074 6861 7420 7468 6520 6669 7273 7420   that the first 
+000147b0: 6172 6775 6d65 6e74 7320 6172 6520 7468  arguments are th
+000147c0: 6520 666f 7277 6172 6420 6172 6775 6d65  e forward argume
+000147d0: 6e74 730a 2020 2020 2020 2020 666f 7277  nts.        forw
+000147e0: 6172 645f 6172 6773 203d 2061 7267 735b  ard_args = args[
+000147f0: 3a20 7365 6c66 2e6e 756d 5f61 7267 735d  : self.num_args]
+00014800: 0a0a 2020 2020 2020 2020 6465 6620 7a65  ..        def ze
+00014810: 726f 735f 6c69 6b65 2878 293a 0a20 2020  ros_like(x):.   
+00014820: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00014830: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+00014840: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
+00014850: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00014860: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
+00014870: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+00014880: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00014890: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
+000148a0: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
+000148b0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
+000148c0: 7065 2878 2e76 616c 7565 2928 3029 0a20  pe(x.value)(0). 
+000148d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000148e0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+000148f0: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
+00014900: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
+00014910: 7065 2878 2928 3029 0a20 2020 2020 2020  pe(x)(0).       
+00014920: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014930: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00014940: 2056 616c 7565 4572 726f 7228 6622 7a65   ValueError(f"ze
+00014950: 726f 735f 6c69 6b65 2069 6e73 6964 6520  ros_like inside 
+00014960: 5a65 726f 4261 636b 7761 7264 2067 6f74  ZeroBackward got
+00014970: 2061 6e20 756e 7375 7070 6f72 7465 6420   an unsupported 
+00014980: 7479 7065 207b 7479 7065 2878 297d 2229  type {type(x)}")
+00014990: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000149a0: 2074 7570 6c65 287a 6572 6f73 5f6c 696b   tuple(zeros_lik
+000149b0: 6528 6172 6729 2066 6f72 2061 7267 2069  e(arg) for arg i
+000149c0: 6e20 666f 7277 6172 645f 6172 6773 290a  n forward_args).
+000149d0: 0a0a 2320 4d61 7070 696e 6720 6672 6f6d  ..# Mapping from
+000149e0: 2073 796d 626f 6c73 2074 6f20 6175 676d   symbols to augm
+000149f0: 656e 7465 6420 7072 696d 616c 2028 666f  ented primal (fo
+00014a00: 7277 6172 6429 2066 756e 6374 696f 6e73  rward) functions
+00014a10: 2075 7365 6420 696e 2056 4a50 0a23 2054   used in VJP.# T
+00014a20: 6865 2061 7567 6d65 6e74 6564 5f70 7269  he augmented_pri
+00014a30: 6d61 6c20 6675 6e63 7469 6f6e 2074 616b  mal function tak
+00014a40: 6573 2074 6865 2070 7269 6d61 6c20 7661  es the primal va
+00014a50: 6c75 6573 2061 6e64 2072 6574 7572 6e73  lues and returns
+00014a60: 2074 6865 2070 7269 6d61 6c0a 2320 7265   the primal.# re
+00014a70: 7375 6c74 2061 6e64 2074 6865 2072 6573  sult and the res
+00014a80: 6964 7561 6c73 2028 7361 7665 6420 7661  iduals (saved va
+00014a90: 6c75 6573 2066 6f72 2074 6865 2062 6163  lues for the bac
+00014aa0: 6b77 6172 6429 2e0a 6175 676d 656e 7465  kward)..augmente
+00014ab0: 645f 666f 7277 6172 645f 696d 706c 7320  d_forward_impls 
+00014ac0: 3d20 7b0a 2020 2020 7072 696d 732e 5072  = {.    prims.Pr
+00014ad0: 696d 4944 732e 4143 4f53 3a20 6c61 6d62  imIDs.ACOS: lamb
+00014ae0: 6461 2078 3a20 2870 7269 6d73 2e61 636f  da x: (prims.aco
+00014af0: 7328 7829 2c20 2878 2c29 292c 0a20 2020  s(x), (x,)),.   
+00014b00: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00014b10: 434f 5348 3a20 6c61 6d62 6461 2078 3a20  COSH: lambda x: 
+00014b20: 2870 7269 6d73 2e61 636f 7368 2878 292c  (prims.acosh(x),
+00014b30: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014b40: 732e 5072 696d 4944 732e 4153 494e 3a20  s.PrimIDs.ASIN: 
+00014b50: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014b60: 2e61 7369 6e28 7829 2c20 2878 2c29 292c  .asin(x), (x,)),
+00014b70: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014b80: 4473 2e41 5349 4e48 3a20 6c61 6d62 6461  Ds.ASINH: lambda
+00014b90: 2078 3a20 2870 7269 6d73 2e61 7369 6e68   x: (prims.asinh
+00014ba0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+00014bb0: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
+00014bc0: 414e 3a20 6c61 6d62 6461 2078 3a20 2870  AN: lambda x: (p
+00014bd0: 7269 6d73 2e61 7461 6e28 7829 2c20 2878  rims.atan(x), (x
 00014be0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014bf0: 7269 6d49 4473 2e53 5152 543a 206c 616d  rimIDs.SQRT: lam
-00014c00: 6264 6120 783a 2028 7072 696d 732e 7371  bda x: (prims.sq
-00014c10: 7274 2878 292c 2028 7072 696d 732e 7371  rt(x), (prims.sq
-00014c20: 7274 2878 292c 2929 2c0a 2020 2020 7072  rt(x),)),.    pr
-00014c30: 696d 732e 5072 696d 4944 732e 4c4f 4731  ims.PrimIDs.LOG1
-00014c40: 303a 206c 616d 6264 6120 783a 2028 7072  0: lambda x: (pr
-00014c50: 696d 732e 6c6f 6731 3028 7829 2c20 2878  ims.log10(x), (x
-00014c60: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014c70: 7269 6d49 4473 2e4c 4f47 3150 3a20 6c61  rimIDs.LOG1P: la
-00014c80: 6d62 6461 2078 3a20 2870 7269 6d73 2e6c  mbda x: (prims.l
-00014c90: 6f67 3170 2878 292c 2028 782c 2929 2c0a  og1p(x), (x,)),.
-00014ca0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014cb0: 732e 4c4f 4732 3a20 6c61 6d62 6461 2078  s.LOG2: lambda x
-00014cc0: 3a20 2870 7269 6d73 2e6c 6f67 3228 7829  : (prims.log2(x)
-00014cd0: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014ce0: 6d73 2e50 7269 6d49 4473 2e5a 4554 413a  ms.PrimIDs.ZETA:
-00014cf0: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
-00014d00: 7269 6d73 2e7a 6574 6128 782c 2079 292c  rims.zeta(x, y),
-00014d10: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
-00014d20: 696d 732e 5072 696d 4944 732e 464d 4f44  ims.PrimIDs.FMOD
-00014d30: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
-00014d40: 7072 696d 732e 666d 6f64 2878 2c20 7929  prims.fmod(x, y)
-00014d50: 2c20 2878 2c20 7929 292c 0a20 2020 2070  , (x, y)),.    p
-00014d60: 7269 6d73 2e50 7269 6d49 4473 2e43 4f50  rims.PrimIDs.COP
-00014d70: 595f 3a20 6c61 6d62 6461 2078 2c20 793a  Y_: lambda x, y:
-00014d80: 2028 7072 696d 732e 636f 7079 5f28 782c   (prims.copy_(x,
-00014d90: 2079 292c 2074 7570 6c65 2829 292c 0a7d   y), tuple()),.}
-00014da0: 0a0a 0a23 204d 6170 7069 6e67 2066 726f  ...# Mapping fro
-00014db0: 6d20 7379 6d62 6f6c 7320 746f 2062 6163  m symbols to bac
-00014dc0: 6b77 6172 6420 6675 6e63 7469 6f6e 7320  kward functions 
-00014dd0: 7573 6564 2069 6e20 564a 500a 2320 5468  used in VJP.# Th
-00014de0: 6520 6261 636b 7761 7264 2066 756e 6374  e backward funct
-00014df0: 696f 6e20 7461 6b65 7320 7468 6520 7265  ion takes the re
-00014e00: 7369 6475 616c 7320 616e 6420 636f 7461  siduals and cota
-00014e10: 6e67 656e 7473 2061 6e64 2072 6574 7572  ngents and retur
-00014e20: 6e73 2074 6865 0a23 2076 6563 746f 722d  ns the.# vector-
-00014e30: 4a61 636f 6269 616e 2070 726f 6475 6374  Jacobian product
-00014e40: 7320 666f 7220 6561 6368 2061 7267 756d  s for each argum
-00014e50: 656e 742e 0a62 6163 6b77 6172 645f 696d  ent..backward_im
-00014e60: 706c 7320 3d20 7b0a 2020 2020 7072 696d  pls = {.    prim
-00014e70: 732e 5072 696d 4944 732e 4143 4f53 3a20  s.PrimIDs.ACOS: 
-00014e80: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
-00014e90: 2f20 7072 696d 732e 7371 7274 2831 2e30  / prims.sqrt(1.0
-00014ea0: 202d 2078 202a 2078 292c 0a20 2020 2070   - x * x),.    p
-00014eb0: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
-00014ec0: 5348 3a20 6c61 6d62 6461 2078 2c20 673a  SH: lambda x, g:
-00014ed0: 2067 202a 2070 7269 6d73 2e72 7371 7274   g * prims.rsqrt
-00014ee0: 2878 202a 2078 202d 2031 2e30 292c 0a20  (x * x - 1.0),. 
-00014ef0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014f00: 2e41 5349 4e3a 206c 616d 6264 6120 782c  .ASIN: lambda x,
-00014f10: 2067 3a20 6720 2f20 7072 696d 732e 7371   g: g / prims.sq
-00014f20: 7274 2831 2e30 202d 2078 202a 2078 292c  rt(1.0 - x * x),
-00014f30: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014f40: 4473 2e41 5349 4e48 3a20 6c61 6d62 6461  Ds.ASINH: lambda
-00014f50: 2078 2c20 673a 2067 202a 2070 7269 6d73   x, g: g * prims
-00014f60: 2e72 7371 7274 2831 2e30 202b 2078 202a  .rsqrt(1.0 + x *
-00014f70: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
-00014f80: 7269 6d49 4473 2e41 5441 4e3a 206c 616d  rimIDs.ATAN: lam
-00014f90: 6264 6120 782c 2067 3a20 6720 2f20 2831  bda x, g: g / (1
-00014fa0: 2e30 202b 2078 202a 2078 292c 0a20 2020  .0 + x * x),.   
-00014fb0: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014fc0: 5441 4e48 3a20 6c61 6d62 6461 2078 2c20  TANH: lambda x, 
-00014fd0: 673a 2067 202f 2028 312e 3020 2d20 7820  g: g / (1.0 - x 
-00014fe0: 2a20 7829 2c0a 2020 2020 7072 696d 732e  * x),.    prims.
-00014ff0: 5072 696d 4944 732e 434f 5348 3a20 6c61  PrimIDs.COSH: la
-00015000: 6d62 6461 2078 2c20 673a 2070 7269 6d73  mbda x, g: prims
-00015010: 2e6d 756c 2867 2c20 7072 696d 732e 7369  .mul(g, prims.si
-00015020: 6e68 2878 2929 2c0a 2020 2020 7072 696d  nh(x)),.    prim
-00015030: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
-00015040: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
-00015050: 2a20 322e 3020 2f20 6d61 7468 2e73 7172  * 2.0 / math.sqr
-00015060: 7428 6d61 7468 2e70 6929 202a 2070 7269  t(math.pi) * pri
-00015070: 6d73 2e65 7870 282d 7820 2a20 7829 2c0a  ms.exp(-x * x),.
-00015080: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00015090: 732e 4552 4649 4e56 3a20 6c61 6d62 6461  s.ERFINV: lambda
-000150a0: 2072 6573 756c 742c 2067 3a20 6720 2a20   result, g: g * 
-000150b0: 302e 3520 2a20 6d61 7468 2e73 7172 7428  0.5 * math.sqrt(
-000150c0: 6d61 7468 2e70 6929 202a 2070 7269 6d73  math.pi) * prims
-000150d0: 2e65 7870 2872 6573 756c 742a 2a32 292c  .exp(result**2),
-000150e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000150f0: 4473 2e45 5246 4349 4e56 3a20 6c61 6d62  Ds.ERFCINV: lamb
-00015100: 6461 2072 6573 756c 742c 2067 3a20 2d67  da result, g: -g
-00015110: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
-00015120: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
-00015130: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
-00015140: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00015150: 696d 4944 732e 4558 5032 3a20 6c61 6d62  imIDs.EXP2: lamb
-00015160: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
-00015170: 2a20 7265 7375 6c74 202a 206d 6174 682e  * result * math.
-00015180: 6c6f 6728 322e 3029 2c0a 2020 2020 7072  log(2.0),.    pr
-00015190: 696d 732e 5072 696d 4944 732e 4558 504d  ims.PrimIDs.EXPM
-000151a0: 313a 206c 616d 6264 6120 7265 7375 6c74  1: lambda result
-000151b0: 2c20 673a 2067 202a 2028 7265 7375 6c74  , g: g * (result
-000151c0: 202b 2031 2e30 292c 0a20 2020 2070 7269   + 1.0),.    pri
-000151d0: 6d73 2e50 7269 6d49 4473 2e4c 4741 4d4d  ms.PrimIDs.LGAMM
-000151e0: 413a 206c 616d 6264 6120 782c 2067 3a20  A: lambda x, g: 
-000151f0: 6720 2a20 7072 696d 732e 6469 6761 6d6d  g * prims.digamm
-00015200: 6128 7829 2c0a 2020 2020 7072 696d 732e  a(x),.    prims.
-00015210: 5072 696d 4944 732e 4e44 5452 493a 206c  PrimIDs.NDTRI: l
-00015220: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-00015230: 2067 202a 2070 7269 6d73 2e65 7870 2830   g * prims.exp(0
-00015240: 2e35 202a 2072 6573 756c 742a 2a32 2920  .5 * result**2) 
-00015250: 2a20 6d61 7468 2e73 7172 7428 322e 3020  * math.sqrt(2.0 
-00015260: 2a20 6d61 7468 2e70 6929 2c0a 2020 2020  * math.pi),.    
-00015270: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
-00015280: 4e48 3a20 6c61 6d62 6461 2078 2c20 673a  NH: lambda x, g:
-00015290: 2070 7269 6d73 2e6d 756c 2867 2c20 7072   prims.mul(g, pr
-000152a0: 696d 732e 636f 7368 2878 2929 2c0a 2020  ims.cosh(x)),.  
-000152b0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-000152c0: 5351 5254 3a20 6c61 6d62 6461 2072 6573  SQRT: lambda res
-000152d0: 756c 742c 2067 3a20 6720 2f20 2832 2e30  ult, g: g / (2.0
-000152e0: 202a 2072 6573 756c 7429 2c0a 2020 2020   * result),.    
-000152f0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
-00015300: 4731 303a 206c 616d 6264 6120 782c 2067  G10: lambda x, g
-00015310: 3a20 6720 2f20 2878 202a 2032 2e33 3032  : g / (x * 2.302
-00015320: 3538 3530 3932 3939 3430 3436 292c 0a20  585092994046),. 
-00015330: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00015340: 2e4c 4f47 3150 3a20 6c61 6d62 6461 2078  .LOG1P: lambda x
-00015350: 2c20 673a 2067 202f 2028 7820 2b20 3129  , g: g / (x + 1)
-00015360: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00015370: 4944 732e 4c4f 4732 3a20 6c61 6d62 6461  IDs.LOG2: lambda
-00015380: 2078 2c20 673a 2067 202f 2028 7820 2a20   x, g: g / (x * 
-00015390: 302e 3639 3331 3437 3138 3035 3539 3934  0.69314718055994
-000153a0: 3533 292c 0a20 2020 2070 7269 6d73 2e50  53),.    prims.P
-000153b0: 7269 6d49 4473 2e46 4d4f 443a 206c 616d  rimIDs.FMOD: lam
-000153c0: 6264 6120 782c 2079 2c20 673a 2028 672c  bda x, y, g: (g,
-000153d0: 202d 6720 2a20 7072 696d 732e 7472 756e   -g * prims.trun
-000153e0: 6328 7820 2f20 7929 292c 0a20 2020 2023  c(x / y)),.    #
-000153f0: 2054 6865 2063 6f70 7920 7368 6f75 6c64   The copy should
-00015400: 206e 6f74 2062 6520 6469 6666 6572 656e   not be differen
-00015410: 7469 6162 6c65 2e20 5765 2072 6574 7572  tiable. We retur
-00015420: 6e20 4e6f 6e65 2074 6f20 656e 6162 6c65  n None to enable
-00015430: 2074 6865 2067 656e 6572 6174 696f 6e20   the generation 
-00015440: 6f66 2074 6865 2062 6163 6b77 6172 6420  of the backward 
-00015450: 6772 6170 6820 7468 726f 7567 6820 7468  graph through th
-00015460: 656d 2e0a 2020 2020 7072 696d 732e 5072  em..    prims.Pr
-00015470: 696d 4944 732e 434f 5059 5f3a 206c 616d  imIDs.COPY_: lam
-00015480: 6264 6120 673a 2028 4e6f 6e65 2c20 4e6f  bda g: (None, No
-00015490: 6e65 292c 0a7d 0a0a 0a64 6566 2072 6567  ne),.}...def reg
-000154a0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-000154b0: 666f 7277 6172 6428 6f70 293a 0a20 2020  forward(op):.   
-000154c0: 2022 2222 4465 636f 7261 746f 7220 746f   """Decorator to
-000154d0: 2072 6567 6973 7465 7220 616e 2061 7567   register an aug
-000154e0: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
-000154f0: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
-00015500: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
-00015510: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
-00015520: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
-00015530: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
-00015540: 6973 7465 7220 7468 6520 6175 676d 656e  ister the augmen
-00015550: 7465 6420 666f 7277 6172 6420 696d 706c  ted forward impl
-00015560: 656d 656e 7461 7469 6f6e 2e0a 0a20 2020  ementation...   
-00015570: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00015580: 2020 4361 6c6c 6162 6c65 3a20 4465 636f    Callable: Deco
-00015590: 7261 746f 7220 6675 6e63 7469 6f6e 2e0a  rator function..
-000155a0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-000155b0: 2064 6563 6f72 6174 6f72 2866 756e 6329   decorator(func)
-000155c0: 3a0a 2020 2020 2020 2020 6175 676d 656e  :.        augmen
-000155d0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-000155e0: 735b 6f70 5d20 3d20 6675 6e63 0a20 2020  s[op] = func.   
-000155f0: 2020 2020 2072 6574 7572 6e20 6675 6e63       return func
-00015600: 0a0a 2020 2020 7265 7475 726e 2064 6563  ..    return dec
-00015610: 6f72 6174 6f72 0a0a 0a64 6566 2072 6567  orator...def reg
-00015620: 6973 7465 725f 6261 636b 7761 7264 286f  ister_backward(o
-00015630: 7029 3a0a 2020 2020 2222 2244 6563 6f72  p):.    """Decor
-00015640: 6174 6f72 2074 6f20 7265 6769 7374 6572  ator to register
-00015650: 2061 2062 6163 6b77 6172 6420 696d 706c   a backward impl
-00015660: 656d 656e 7461 7469 6f6e 2066 6f72 2061  ementation for a
-00015670: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
-00015680: 6773 3a0a 2020 2020 2020 2020 6f70 2028  gs:.        op (
-00015690: 4f70 7329 3a20 5379 6d62 6f6c 2066 6f72  Ops): Symbol for
-000156a0: 2077 6869 6368 2074 6f20 7265 6769 7374   which to regist
-000156b0: 6572 2074 6865 2062 6163 6b77 6172 6420  er the backward 
-000156c0: 696d 706c 656d 656e 7461 7469 6f6e 2e0a  implementation..
-000156d0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-000156e0: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
-000156f0: 4465 636f 7261 746f 7220 6675 6e63 7469  Decorator functi
-00015700: 6f6e 2e0a 2020 2020 2222 220a 0a20 2020  on..    """..   
-00015710: 2064 6566 2064 6563 6f72 6174 6f72 2866   def decorator(f
-00015720: 756e 6329 3a0a 2020 2020 2020 2020 6261  unc):.        ba
-00015730: 636b 7761 7264 5f69 6d70 6c73 5b6f 705d  ckward_impls[op]
-00015740: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-00015750: 7265 7475 726e 2066 756e 630a 0a20 2020  return func..   
-00015760: 2072 6574 7572 6e20 6465 636f 7261 746f   return decorato
-00015770: 720a 0a0a 6465 6620 7265 7374 6f72 655f  r...def restore_
-00015780: 7265 6475 6365 645f 6469 6d73 2878 2c20  reduced_dims(x, 
-00015790: 7265 6475 6365 645f 6469 6d73 2c20 6f72  reduced_dims, or
-000157a0: 6967 696e 616c 5f73 6861 7065 293a 0a20  iginal_shape):. 
-000157b0: 2020 2022 2222 5265 7374 6f72 6573 2074     """Restores t
-000157c0: 6865 2072 6564 7563 6564 2064 696d 656e  he reduced dimen
-000157d0: 7369 6f6e 7320 6f66 2061 2074 656e 736f  sions of a tenso
-000157e0: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
-000157f0: 2020 2020 2020 7820 2856 6172 6961 626c        x (Variabl
-00015800: 6529 3a20 5465 6e73 6f72 2074 6f20 6265  e): Tensor to be
-00015810: 2072 6573 6861 7065 642e 0a20 2020 2020   reshaped..     
-00015820: 2020 2072 6564 7563 6564 5f64 696d 7320     reduced_dims 
-00015830: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
-00015840: 293a 2054 7570 6c65 206f 6620 7265 6475  ): Tuple of redu
-00015850: 6365 6420 6469 6d65 6e73 696f 6e73 2e0a  ced dimensions..
-00015860: 2020 2020 2020 2020 6f72 6967 696e 616c          original
-00015870: 5f73 6861 7065 2028 5475 706c 655b 696e  _shape (Tuple[in
-00015880: 742c 202e 2e2e 5d29 3a20 4f72 6967 696e  t, ...]): Origin
-00015890: 616c 2073 6861 7065 206f 6620 7468 6520  al shape of the 
-000158a0: 7465 6e73 6f72 2e0a 0a20 2020 2052 6574  tensor...    Ret
-000158b0: 7572 6e73 3a0a 2020 2020 2020 2020 5661  urns:.        Va
-000158c0: 7269 6162 6c65 3a20 5465 6e73 6f72 2077  riable: Tensor w
-000158d0: 6974 6820 7468 6520 7265 6475 6365 6420  ith the reduced 
-000158e0: 6469 6d65 6e73 696f 6e73 2072 6573 746f  dimensions resto
-000158f0: 7265 642e 0a20 2020 2022 2222 0a20 2020  red..    """.   
-00015900: 2069 6620 6f72 6967 696e 616c 5f73 6861   if original_sha
-00015910: 7065 203d 3d20 2829 3a20 2023 2073 6361  pe == ():  # sca
-00015920: 6c61 720a 2020 2020 2020 2020 7265 7475  lar.        retu
-00015930: 726e 2078 0a0a 2020 2020 756e 7371 7565  rn x..    unsque
-00015940: 657a 6564 203d 2063 6c61 6e67 2e75 6e73  ezed = clang.uns
-00015950: 7175 6565 7a65 2878 2c20 7265 6475 6365  queeze(x, reduce
-00015960: 645f 6469 6d73 290a 2020 2020 7265 7475  d_dims).    retu
-00015970: 726e 2063 6c61 6e67 2e65 7870 616e 6428  rn clang.expand(
-00015980: 756e 7371 7565 657a 6564 2c20 6f72 6967  unsqueezed, orig
-00015990: 696e 616c 5f73 6861 7065 290a 0a0a 4072  inal_shape)...@r
-000159a0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-000159b0: 2870 7269 6d73 2e50 7269 6d49 4473 2e5a  (prims.PrimIDs.Z
-000159c0: 4554 4129 0a64 6566 207a 6574 615f 6261  ETA).def zeta_ba
-000159d0: 636b 7761 7264 2878 2c20 792c 2067 293a  ckward(x, y, g):
-000159e0: 0a20 2020 2023 2054 6865 2064 6572 6976  .    # The deriv
-000159f0: 6174 6976 6520 7772 7420 7468 6520 6669  ative wrt the fi
-00015a00: 7273 7420 6172 6775 6d65 6e74 2069 7320  rst argument is 
-00015a10: 6e6f 7420 6578 7072 6573 7369 626c 6520  not expressible 
-00015a20: 696e 2074 6572 6d73 206f 6620 7a65 7461  in terms of zeta
-00015a30: 206f 720a 2020 2020 2320 6f74 6865 7220   or.    # other 
-00015a40: 7370 6563 6961 6c20 6675 6e63 7469 6f6e  special function
-00015a50: 730a 2020 2020 2320 5468 6572 6566 6f72  s.    # Therefor
-00015a60: 652c 2077 6520 636f 6d70 7574 6520 6f6e  e, we compute on
-00015a70: 6c79 2074 6865 2064 6572 6976 6174 6976  ly the derivativ
-00015a80: 6520 7772 7420 7468 6520 7365 636f 6e64  e wrt the second
-00015a90: 2061 7267 756d 656e 740a 2020 2020 6779   argument.    gy
-00015aa0: 203d 2067 202a 202d 7820 2a20 7072 696d   = g * -x * prim
-00015ab0: 732e 7a65 7461 2878 202b 2031 2e30 2c20  s.zeta(x + 1.0, 
-00015ac0: 7929 0a0a 2020 2020 2320 5265 7475 726e  y)..    # Return
-00015ad0: 2061 206d 6170 7070 696e 6720 6672 6f6d   a mappping from
-00015ae0: 2074 6865 2066 6f72 7761 7264 2061 7267   the forward arg
-00015af0: 756d 656e 7473 2074 6f20 7468 6520 6772  uments to the gr
-00015b00: 6164 6965 6e74 730a 2020 2020 7265 7475  adients.    retu
-00015b10: 726e 207b 2279 223a 2067 797d 0a0a 0a40  rn {"y": gy}...@
-00015b20: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00015b30: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00015b40: 4449 4741 4d4d 4129 0a64 6566 2064 6967  DIGAMMA).def dig
-00015b50: 616d 6d61 5f62 6163 6b77 6172 6428 613a  amma_backward(a:
-00015b60: 2050 726f 7879 2c20 6729 3a0a 2020 2020   Proxy, g):.    
-00015b70: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00015b80: 6368 2069 6d70 6f72 7420 706f 6c79 6761  ch import polyga
-00015b90: 6d6d 610a 0a20 2020 2072 6574 7572 6e20  mma..    return 
-00015ba0: 6720 2a20 706f 6c79 6761 6d6d 6128 312c  g * polygamma(1,
-00015bb0: 2061 290a 0a0a 4072 6567 6973 7465 725f   a)...@register_
-00015bc0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00015bd0: 6428 2274 6f72 6368 2e70 6f6c 7967 616d  d("torch.polygam
-00015be0: 6d61 2229 0a64 6566 2070 6f6c 7967 616d  ma").def polygam
-00015bf0: 6d61 5f61 7567 5f66 7764 286e 3a20 696e  ma_aug_fwd(n: in
-00015c00: 742c 2061 3a20 5072 6f78 7929 3a0a 2020  t, a: Proxy):.  
-00015c10: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00015c20: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
-00015c30: 6761 6d6d 610a 0a20 2020 2070 7269 6d61  gamma..    prima
-00015c40: 6c20 3d20 706f 6c79 6761 6d6d 6128 6e2c  l = polygamma(n,
-00015c50: 2061 290a 2020 2020 7265 7369 6475 616c   a).    residual
-00015c60: 7320 3d20 286e 2c20 6129 0a20 2020 2072  s = (n, a).    r
-00015c70: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00015c80: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00015c90: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00015ca0: 6b77 6172 6428 2274 6f72 6368 2e70 6f6c  kward("torch.pol
-00015cb0: 7967 616d 6d61 2229 0a64 6566 2070 6f6c  ygamma").def pol
-00015cc0: 7967 616d 6d61 5f62 6163 6b77 6172 6428  ygamma_backward(
-00015cd0: 6e3a 2069 6e74 2c20 613a 2050 726f 7879  n: int, a: Proxy
-00015ce0: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
-00015cf0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00015d00: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
-00015d10: 2020 2072 6574 7572 6e20 4e6f 6e65 2c20     return None, 
-00015d20: 6720 2a20 706f 6c79 6761 6d6d 6128 6e20  g * polygamma(n 
-00015d30: 2b20 312c 2061 290a 0a0a 4072 6567 6973  + 1, a)...@regis
-00015d40: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-00015d50: 6d73 2e50 7269 6d49 4473 2e41 5441 4e32  ms.PrimIDs.ATAN2
-00015d60: 290a 6465 6620 6174 616e 325f 6261 636b  ).def atan2_back
-00015d70: 7761 7264 2878 2c20 792c 2067 293a 0a20  ward(x, y, g):. 
-00015d80: 2020 2061 6c70 6861 203d 2031 2e30 202f     alpha = 1.0 /
-00015d90: 2028 7820 2a20 7820 2b20 7920 2a20 7929   (x * x + y * y)
-00015da0: 0a20 2020 2067 7261 645f 7820 3d20 6720  .    grad_x = g 
-00015db0: 2a20 7920 2a20 616c 7068 610a 2020 2020  * y * alpha.    
-00015dc0: 6772 6164 5f79 203d 2067 202a 202d 7820  grad_y = g * -x 
-00015dd0: 2a20 616c 7068 610a 2020 2020 7265 7475  * alpha.    retu
-00015de0: 726e 2067 7261 645f 782c 2067 7261 645f  rn grad_x, grad_
-00015df0: 790a 0a0a 4072 6567 6973 7465 725f 6175  y...@register_au
-00015e00: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-00015e10: 7072 696d 732e 5072 696d 4944 732e 5641  prims.PrimIDs.VA
-00015e20: 5229 0a64 6566 2076 6172 5f61 7567 5f66  R).def var_aug_f
-00015e30: 7764 2861 2c20 6469 6d2c 202a 2c20 636f  wd(a, dim, *, co
-00015e40: 7272 6563 7469 6f6e 293a 0a20 2020 2076  rrection):.    v
-00015e50: 203d 2070 7269 6d73 2e76 6172 2861 2c20   = prims.var(a, 
-00015e60: 6469 6d2c 2063 6f72 7265 6374 696f 6e3d  dim, correction=
-00015e70: 636f 7272 6563 7469 6f6e 290a 2020 2020  correction).    
-00015e80: 7265 7475 726e 2056 4a50 4475 616c 2828  return VJPDual((
-00015e90: 762c 292c 2028 612c 2064 696d 2c20 636f  v,), (a, dim, co
-00015ea0: 7272 6563 7469 6f6e 2c20 7629 290a 0a0a  rrection, v))...
-00015eb0: 2320 544f 444f 3a20 6669 7820 6469 7669  # TODO: fix divi
-00015ec0: 7369 6f6e 2062 7920 7a65 726f 2077 6865  sion by zero whe
-00015ed0: 6e20 6e5f 656c 656d 5f72 6564 7563 6564  n n_elem_reduced
-00015ee0: 203d 3d20 3020 6f72 2077 6865 6e20 762e   == 0 or when v.
-00015ef0: 6e75 6d65 6c20 3d3d 2030 0a23 2062 7920  numel == 0.# by 
-00015f00: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
-00015f10: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
-00015f20: 6172 2e0a 2320 544f 444f 3a20 6669 7820  ar..# TODO: fix 
-00015f30: 6772 6164 2077 6865 6e20 636f 7272 6563  grad when correc
-00015f40: 7469 6f6e 203e 206e 5f65 6c65 6d5f 7265  tion > n_elem_re
-00015f50: 6475 6365 642e 0a40 7265 6769 7374 6572  duced..@register
-00015f60: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-00015f70: 5072 696d 4944 732e 5641 5229 0a64 6566  PrimIDs.VAR).def
-00015f80: 2076 6172 5f62 6163 6b77 6172 6428 612c   var_backward(a,
-00015f90: 2064 696d 2c20 636f 7272 6563 7469 6f6e   dim, correction
-00015fa0: 2c20 762c 2067 293a 0a20 2020 206e 5f65  , v, g):.    n_e
-00015fb0: 6c65 6d5f 7265 6475 6365 6420 3d20 612e  lem_reduced = a.
-00015fc0: 6e75 6d65 6c28 2920 2f2f 2076 2e6e 756d  numel() // v.num
-00015fd0: 656c 2829 2069 6620 612e 6e75 6d65 6c28  el() if a.numel(
-00015fe0: 2920 213d 2030 2065 6c73 6520 310a 2020  ) != 0 else 1.  
-00015ff0: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
-00016000: 7363 616c 6172 203d 206e 5f65 6c65 6d5f  scalar = n_elem_
-00016010: 7265 6475 6365 6420 2d20 636f 7272 6563  reduced - correc
-00016020: 7469 6f6e 0a20 2020 2067 203d 2072 6573  tion.    g = res
-00016030: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
-00016040: 7328 672c 2064 696d 2c20 612e 7368 6170  s(g, dim, a.shap
-00016050: 6529 0a20 2020 2069 6620 612e 6474 7970  e).    if a.dtyp
-00016060: 6520 213d 2076 2e64 7479 7065 3a0a 2020  e != v.dtype:.  
-00016070: 2020 2020 2020 6120 3d20 7072 696d 732e        a = prims.
-00016080: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-00016090: 7479 7065 2861 2c20 762e 6474 7970 6529  type(a, v.dtype)
-000160a0: 0a20 2020 206d 6561 6e20 3d20 7072 696d  .    mean = prim
-000160b0: 732e 7375 6d28 612c 2064 696d 2920 2f20  s.sum(a, dim) / 
-000160c0: 6e5f 656c 656d 5f72 6564 7563 6564 0a20  n_elem_reduced. 
-000160d0: 2020 206d 6561 6e20 3d20 7265 7374 6f72     mean = restor
-000160e0: 655f 7265 6475 6365 645f 6469 6d73 286d  e_reduced_dims(m
-000160f0: 6561 6e2c 2064 696d 2c20 612e 7368 6170  ean, dim, a.shap
-00016100: 6529 0a20 2020 2072 6574 7572 6e20 2832  e).    return (2
-00016110: 202a 2067 202a 2028 6120 2d20 6d65 616e   * g * (a - mean
-00016120: 2929 202f 206e 6f72 6d61 6c69 7a61 7469  )) / normalizati
-00016130: 6f6e 5f73 6361 6c61 720a 0a0a 6465 6620  on_scalar...def 
-00016140: 6e5f 656c 656d 5f72 6564 7563 6564 2861  n_elem_reduced(a
-00016150: 5f6e 6469 6d2c 2061 5f73 6861 7065 2c20  _ndim, a_shape, 
-00016160: 6469 6d73 293a 0a20 2020 2064 696d 7320  dims):.    dims 
-00016170: 3d20 7574 696c 732e 6361 6e6f 6e69 6361  = utils.canonica
-00016180: 6c69 7a65 5f64 696d 7328 615f 6e64 696d  lize_dims(a_ndim
-00016190: 2c20 6469 6d73 290a 2020 2020 7265 6475  , dims).    redu
-000161a0: 6374 696f 6e5f 7369 7a65 203d 2031 0a20  ction_size = 1. 
-000161b0: 2020 2066 6f72 2069 6478 2c20 7369 7a65     for idx, size
-000161c0: 2069 6e20 656e 756d 6572 6174 6528 615f   in enumerate(a_
-000161d0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-000161e0: 6966 2069 6478 2069 6e20 6469 6d73 3a0a  if idx in dims:.
-000161f0: 2020 2020 2020 2020 2020 2020 7265 6475              redu
-00016200: 6374 696f 6e5f 7369 7a65 202a 3d20 7369  ction_size *= si
-00016210: 7a65 0a20 2020 2072 6574 7572 6e20 7265  ze.    return re
-00016220: 6475 6374 696f 6e5f 7369 7a65 0a0a 0a64  duction_size...d
-00016230: 6566 206d 6561 6e5f 6261 636b 7761 7264  ef mean_backward
-00016240: 2861 5f6e 6469 6d2c 2061 5f73 6861 7065  (a_ndim, a_shape
-00016250: 2c20 6469 6d73 2c20 6772 6164 293a 0a20  , dims, grad):. 
-00016260: 2020 206d 6561 6e5f 6c6f 6361 6c5f 6772     mean_local_gr
-00016270: 6164 203d 2031 2e30 202f 206e 5f65 6c65  ad = 1.0 / n_ele
-00016280: 6d5f 7265 6475 6365 6428 615f 6e64 696d  m_reduced(a_ndim
-00016290: 2c20 615f 7368 6170 652c 2064 696d 7329  , a_shape, dims)
-000162a0: 0a20 2020 2072 6574 7572 6e20 7265 7374  .    return rest
-000162b0: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-000162c0: 2867 7261 642c 2064 696d 732c 2061 5f73  (grad, dims, a_s
-000162d0: 6861 7065 2920 2a20 6d65 616e 5f6c 6f63  hape) * mean_loc
-000162e0: 616c 5f67 7261 640a 0a0a 4072 6567 6973  al_grad...@regis
-000162f0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00016300: 7277 6172 6428 7072 696d 732e 5072 696d  rward(prims.Prim
-00016310: 4944 732e 5041 4429 0a64 6566 2070 6164  IDs.PAD).def pad
-00016320: 5f61 7567 5f66 7764 2861 2c20 7061 6464  _aug_fwd(a, padd
-00016330: 696e 675f 7661 6c75 652c 2070 6164 6469  ing_value, paddi
-00016340: 6e67 5f63 6f6e 6669 6729 3a0a 2020 2020  ng_config):.    
-00016350: 7265 7475 726e 2056 4a50 4475 616c 2828  return VJPDual((
-00016360: 7072 696d 732e 7061 6428 612c 2070 6164  prims.pad(a, pad
-00016370: 6469 6e67 5f76 616c 7565 2c20 7061 6464  ding_value, padd
-00016380: 696e 675f 636f 6e66 6967 292c 292c 2028  ing_config),), (
-00016390: 612c 2070 6164 6469 6e67 5f63 6f6e 6669  a, padding_confi
-000163a0: 6729 290a 0a0a 4072 6567 6973 7465 725f  g))...@register_
-000163b0: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
-000163c0: 7269 6d49 4473 2e50 4144 290a 6465 6620  rimIDs.PAD).def 
-000163d0: 7061 645f 6261 636b 7761 7264 2861 2c20  pad_backward(a, 
-000163e0: 7061 6464 696e 675f 636f 6e66 6967 2c20  padding_config, 
-000163f0: 6729 3a0a 2020 2020 2320 5368 6f72 7420  g):.    # Short 
-00016400: 6369 7263 7569 7420 6f6e 2065 6d70 7479  circuit on empty
-00016410: 2069 6e70 7574 2e0a 2020 2020 6966 2061   input..    if a
-00016420: 6e79 2864 696d 203d 3d20 3020 666f 7220  ny(dim == 0 for 
-00016430: 6469 6d20 696e 2061 2e73 6861 7065 293a  dim in a.shape):
-00016440: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00016450: 6675 6c6c 5f6c 696b 6528 612c 2066 696c  full_like(a, fil
-00016460: 6c5f 7661 6c75 653d 3029 0a0a 2020 2020  l_value=0)..    
-00016470: 2320 556e 2d70 6164 2062 7920 7061 6464  # Un-pad by padd
-00016480: 696e 6720 7769 7468 207a 6572 6f20 7661  ing with zero va
-00016490: 6c75 6573 0a20 2020 207a 6572 6f5f 7061  lues.    zero_pa
-000164a0: 6464 696e 675f 636f 6e66 6967 203d 205b  dding_config = [
-000164b0: 282d 6c6f 2c20 2d68 692c 2030 2920 666f  (-lo, -hi, 0) fo
-000164c0: 7220 6c6f 2c20 6869 2c20 5f20 696e 2070  r lo, hi, _ in p
-000164d0: 6164 6469 6e67 5f63 6f6e 6669 675d 0a0a  adding_config]..
-000164e0: 2020 2020 6720 3d20 7072 696d 732e 7061      g = prims.pa
-000164f0: 6428 672c 2030 2e30 2c20 7a65 726f 5f70  d(g, 0.0, zero_p
-00016500: 6164 6469 6e67 5f63 6f6e 6669 6729 0a0a  adding_config)..
-00016510: 2020 2020 2320 556e 2d73 6c69 6365 2062      # Un-slice b
-00016520: 7920 736c 6963 696e 6720 7769 7468 2061  y slicing with a
-00016530: 2073 7472 6964 6520 6f66 2076 616c 7565   stride of value
-00016540: 2028 6469 6c61 7469 6f6e 202b 2031 290a   (dilation + 1).
-00016550: 2020 2020 666f 7220 6469 6d2c 2028 5f2c      for dim, (_,
-00016560: 205f 2c20 6429 2069 6e20 656e 756d 6572   _, d) in enumer
-00016570: 6174 6528 7061 6464 696e 675f 636f 6e66  ate(padding_conf
-00016580: 6967 293a 0a20 2020 2020 2020 2067 203d  ig):.        g =
-00016590: 2073 6c69 6365 5f69 6e5f 6469 6d28 672c   slice_in_dim(g,
-000165a0: 2030 2c20 672e 7368 6170 655b 6469 6d5d   0, g.shape[dim]
-000165b0: 2c20 7374 7269 6465 3d64 202b 2031 2c20  , stride=d + 1, 
-000165c0: 6469 6d3d 6469 6d29 0a0a 2020 2020 7265  dim=dim)..    re
-000165d0: 7475 726e 2067 0a0a 0a40 7265 6769 7374  turn g...@regist
-000165e0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-000165f0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00016600: 4473 2e50 524f 4429 0a64 6566 2070 726f  Ds.PROD).def pro
-00016610: 645f 6175 675f 6677 6428 782c 2064 696d  d_aug_fwd(x, dim
-00016620: 7329 3a0a 2020 2020 2222 2241 7567 6d65  s):.    """Augme
-00016630: 6e74 6564 2070 726f 6420 6f70 6572 6174  nted prod operat
-00016640: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
-00016650: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
-00016660: 626c 6529 3a20 5465 6e73 6f72 2074 6f20  ble): Tensor to 
-00016670: 6265 206d 756c 7469 706c 6965 642e 0a20  be multiplied.. 
-00016680: 2020 2020 2020 2064 696d 7320 2854 7570         dims (Tup
-00016690: 6c65 5b69 6e74 2c20 2e2e 2e5d 293a 2044  le[int, ...]): D
-000166a0: 696d 656e 7369 6f6e 7320 746f 2062 6520  imensions to be 
-000166b0: 6d75 6c74 6970 6c69 6564 2e0a 0a20 2020  multiplied...   
-000166c0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-000166d0: 2020 564a 5044 7561 6c3a 2050 7269 6d61    VJPDual: Prima
-000166e0: 6c20 616e 6420 7265 7369 6475 616c 732e  l and residuals.
-000166f0: 0a20 2020 2022 2222 0a20 2020 2070 7269  .    """.    pri
-00016700: 6d61 6c20 3d20 7072 696d 732e 7072 6f64  mal = prims.prod
-00016710: 2878 2c20 6469 6d73 290a 0a20 2020 2072  (x, dims)..    r
-00016720: 6573 6964 7561 6c73 203d 2028 0a20 2020  esiduals = (.   
-00016730: 2020 2020 2070 7269 6d61 6c2c 0a20 2020       primal,.   
-00016740: 2020 2020 2078 2c0a 2020 2020 2020 2020       x,.        
-00016750: 782e 7368 6170 652c 0a20 2020 2020 2020  x.shape,.       
-00016760: 2064 696d 732c 0a20 2020 2029 0a20 2020   dims,.    ).   
-00016770: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00016780: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00016790: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-000167a0: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
-000167b0: 696d 4944 732e 5052 4f44 290a 6465 6620  imIDs.PROD).def 
-000167c0: 7072 6f64 5f70 756c 6c62 6163 6b28 7072  prod_pullback(pr
-000167d0: 696d 616c 2c20 782c 2078 5f73 6861 7065  imal, x, x_shape
-000167e0: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
-000167f0: 6729 3a0a 2020 2020 7265 7475 726e 2070  g):.    return p
-00016800: 7269 6d73 2e64 6976 2872 6573 746f 7265  rims.div(restore
-00016810: 5f72 6564 7563 6564 5f64 696d 7328 7072  _reduced_dims(pr
-00016820: 696d 616c 202a 2067 2c20 7265 6475 6365  imal * g, reduce
-00016830: 645f 6469 6d73 2c20 785f 7368 6170 6529  d_dims, x_shape)
-00016840: 2c20 7829 0a0a 0a64 6566 206b 6565 7064  , x)...def keepd
-00016850: 696d 5f72 6564 7563 7469 6f6e 2872 6564  im_reduction(red
-00016860: 7563 7469 6f6e 5f66 6e2c 2078 2c20 6469  uction_fn, x, di
-00016870: 6d73 293a 0a20 2020 2022 2222 4170 706c  ms):.    """Appl
-00016880: 6965 7320 7265 6475 6374 696f 6e20 616e  ies reduction an
-00016890: 6420 6669 7865 7320 6f75 7470 7574 2074  d fixes output t
-000168a0: 6f20 636f 6e66 6f72 6d20 746f 206b 6565  o conform to kee
-000168b0: 7064 696d 3d54 7275 6522 2222 0a20 2020  pdim=True""".   
-000168c0: 206f 7574 203d 2072 6564 7563 7469 6f6e   out = reduction
-000168d0: 5f66 6e28 782c 2064 696d 7329 0a20 2020  _fn(x, dims).   
-000168e0: 2061 7267 6d61 785f 7375 6d5f 6f75 745f   argmax_sum_out_
-000168f0: 7368 6170 6520 3d20 5b78 2e73 6861 7065  shape = [x.shape
-00016900: 5b69 5d20 6966 2069 206e 6f74 2069 6e20  [i] if i not in 
-00016910: 6469 6d73 2065 6c73 6520 3120 666f 7220  dims else 1 for 
-00016920: 6920 696e 2072 616e 6765 2878 2e6e 6469  i in range(x.ndi
-00016930: 6d29 5d0a 2020 2020 6272 6f61 6463 6173  m)].    broadcas
-00016940: 745f 6469 6d73 203d 205b 6920 666f 7220  t_dims = [i for 
-00016950: 6920 696e 2072 616e 6765 2878 2e6e 6469  i in range(x.ndi
-00016960: 6d29 2069 6620 6920 6e6f 7420 696e 2064  m) if i not in d
-00016970: 696d 735d 0a20 2020 2072 6574 7572 6e20  ims].    return 
-00016980: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
-00016990: 696e 5f64 696d 286f 7574 2c20 6172 676d  in_dim(out, argm
-000169a0: 6178 5f73 756d 5f6f 7574 5f73 6861 7065  ax_sum_out_shape
-000169b0: 2c20 6272 6f61 6463 6173 745f 6469 6d73  , broadcast_dims
-000169c0: 290a 0a0a 2320 496e 7370 6972 6564 2066  )...# Inspired f
-000169d0: 726f 6d20 6874 7470 733a 2f2f 6769 7468  rom https://gith
-000169e0: 7562 2e63 6f6d 2f48 4950 532f 6175 746f  ub.com/HIPS/auto
-000169f0: 6772 6164 2f62 6c6f 622f 6d61 7374 6572  grad/blob/master
-00016a00: 2f61 7574 6f67 7261 642f 6e75 6d70 792f  /autograd/numpy/
-00016a10: 6e75 6d70 795f 766a 7073 2e70 7923 4c33  numpy_vjps.py#L3
-00016a20: 3533 0a64 6566 2067 7261 645f 6368 6f6f  53.def grad_choo
-00016a30: 7365 725f 6261 636b 7761 7264 2870 7269  ser_backward(pri
-00016a40: 6d61 6c2c 2078 2c20 785f 7368 6170 652c  mal, x, x_shape,
-00016a50: 2072 6564 7563 6564 5f64 696d 732c 2067   reduced_dims, g
-00016a60: 293a 0a20 2020 2022 2222 4275 696c 6473  ):.    """Builds
-00016a70: 2067 7261 6469 656e 7420 6f66 2066 756e   gradient of fun
-00016a80: 6374 696f 6e73 2074 6861 7420 6368 6f6f  ctions that choo
-00016a90: 7365 2061 2073 696e 676c 6520 6974 656d  se a single item
-00016aa0: 2c20 7375 6368 2061 7320 6d69 6e20 6f72  , such as min or
-00016ab0: 206d 6178 2e22 2222 0a20 2020 2067 5f72   max.""".    g_r
-00016ac0: 6570 6561 7465 6420 3d20 7265 7374 6f72  epeated = restor
-00016ad0: 655f 7265 6475 6365 645f 6469 6d73 2867  e_reduced_dims(g
-00016ae0: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
-00016af0: 785f 7368 6170 6529 0a20 2020 2070 7269  x_shape).    pri
-00016b00: 6d61 6c5f 7265 7065 6174 6564 203d 2072  mal_repeated = r
-00016b10: 6573 746f 7265 5f72 6564 7563 6564 5f64  estore_reduced_d
-00016b20: 696d 7328 7072 696d 616c 2c20 7265 6475  ims(primal, redu
-00016b30: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
-00016b40: 6529 0a20 2020 2061 7267 6d61 785f 6c6f  e).    argmax_lo
-00016b50: 6361 7469 6f6e 7320 3d20 7820 3d3d 2070  cations = x == p
-00016b60: 7269 6d61 6c5f 7265 7065 6174 6564 0a20  rimal_repeated. 
-00016b70: 2020 2061 7267 6d61 785f 7375 6d20 3d20     argmax_sum = 
-00016b80: 6b65 6570 6469 6d5f 7265 6475 6374 696f  keepdim_reductio
-00016b90: 6e28 7072 696d 732e 7375 6d2c 2061 7267  n(prims.sum, arg
-00016ba0: 6d61 785f 6c6f 6361 7469 6f6e 732c 2072  max_locations, r
-00016bb0: 6564 7563 6564 5f64 696d 7329 0a20 2020  educed_dims).   
-00016bc0: 206f 7574 203d 2067 5f72 6570 6561 7465   out = g_repeate
-00016bd0: 6420 2a20 6172 676d 6178 5f6c 6f63 6174  d * argmax_locat
-00016be0: 696f 6e73 202f 2061 7267 6d61 785f 7375  ions / argmax_su
-00016bf0: 6d0a 2020 2020 7265 7475 726e 206f 7574  m.    return out
-00016c00: 0a0a 0a72 6567 6973 7465 725f 6261 636b  ...register_back
-00016c10: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00016c20: 4473 2e41 4d49 4e29 2867 7261 645f 6368  Ds.AMIN)(grad_ch
-00016c30: 6f6f 7365 725f 6261 636b 7761 7264 290a  ooser_backward).
-00016c40: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-00016c50: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
-00016c60: 696d 732e 5072 696d 4944 732e 414d 494e  ims.PrimIDs.AMIN
-00016c70: 290a 6465 6620 616d 696e 5f61 7567 5f66  ).def amin_aug_f
-00016c80: 7764 2878 2c20 6469 6d73 293a 0a20 2020  wd(x, dims):.   
-00016c90: 2022 2222 4175 676d 656e 7465 6420 616d   """Augmented am
-00016ca0: 696e 206f 7065 7261 7469 6f6e 2e0a 2020  in operation..  
-00016cb0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00016cc0: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
-00016cd0: 6e73 6f72 2074 6f20 636f 6d70 7574 6520  nsor to compute 
-00016ce0: 616d 696e 206f 6e2e 0a20 2020 2020 2020  amin on..       
-00016cf0: 2064 696d 7320 2854 7570 6c65 5b69 6e74   dims (Tuple[int
-00016d00: 2c20 2e2e 2e5d 293a 2044 696d 656e 7369  , ...]): Dimensi
-00016d10: 6f6e 7320 746f 2063 6f6d 7075 7465 2061  ons to compute a
-00016d20: 6d69 6e20 6f76 6572 2e0a 2020 2020 5265  min over..    Re
-00016d30: 7475 726e 733a 0a20 2020 2020 2020 2056  turns:.        V
-00016d40: 4a50 4475 616c 3a20 5072 696d 616c 2061  JPDual: Primal a
-00016d50: 6e64 2072 6573 6964 7561 6c73 2e0a 2020  nd residuals..  
-00016d60: 2020 2222 220a 2020 2020 7072 696d 616c    """.    primal
-00016d70: 203d 2070 7269 6d73 2e61 6d69 6e28 782c   = prims.amin(x,
-00016d80: 2064 696d 7329 0a0a 2020 2020 7265 7369   dims)..    resi
-00016d90: 6475 616c 7320 3d20 280a 2020 2020 2020  duals = (.      
-00016da0: 2020 7072 696d 616c 2c0a 2020 2020 2020    primal,.      
-00016db0: 2020 782c 0a20 2020 2020 2020 2078 2e73    x,.        x.s
-00016dc0: 6861 7065 2c0a 2020 2020 2020 2020 6469  hape,.        di
-00016dd0: 6d73 2c0a 2020 2020 290a 0a20 2020 2072  ms,.    )..    r
-00016de0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00016df0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00016e00: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00016e10: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
-00016e20: 7269 6d73 2e50 7269 6d49 4473 2e50 4f57  rims.PrimIDs.POW
-00016e30: 290a 6465 6620 706f 775f 6175 675f 6665  ).def pow_aug_fe
-00016e40: 6428 782c 2079 293a 0a20 2020 2022 2222  d(x, y):.    """
-00016e50: 4175 676d 656e 7465 6420 7468 6520 706f  Augmented the po
-00016e60: 7720 6f70 6572 6174 696f 6e2e 0a0a 2020  w operation...  
-00016e70: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00016e80: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
-00016e90: 6e73 6f72 2077 6974 6820 7468 6520 6261  nsor with the ba
-00016ea0: 7365 2074 6f20 6265 2065 7870 6f6e 656e  se to be exponen
-00016eb0: 7469 6174 6564 2e0a 2020 2020 2020 2020  tiated..        
-00016ec0: 7920 2856 6172 6961 626c 6529 3a20 5465  y (Variable): Te
-00016ed0: 6e73 6f72 2077 6974 6820 706f 7765 7220  nsor with power 
-00016ee0: 746f 2072 6169 7365 2074 6f2e 0a0a 2020  to raise to...  
-00016ef0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00016f00: 2020 2056 4a50 4475 616c 3a20 5072 696d     VJPDual: Prim
-00016f10: 616c 2061 6e64 2072 6573 6964 7561 6c73  al and residuals
-00016f20: 2e0a 2020 2020 2222 220a 2020 2020 7072  ..    """.    pr
-00016f30: 696d 616c 203d 2070 7269 6d73 2e70 6f77  imal = prims.pow
-00016f40: 2878 2c20 7929 0a20 2020 2072 6573 6964  (x, y).    resid
-00016f50: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
-00016f60: 782c 2079 290a 2020 2020 7265 7475 726e  x, y).    return
-00016f70: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-00016f80: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-00016f90: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00016fa0: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
-00016fb0: 4f57 290a 6465 6620 706f 775f 6261 636b  OW).def pow_back
-00016fc0: 7761 7264 2872 6573 756c 742c 2078 2c20  ward(result, x, 
-00016fd0: 792c 2067 293a 0a20 2020 2069 6d70 6f72  y, g):.    impor
-00016fe0: 7420 7468 756e 6465 722e 636c 616e 6720  t thunder.clang 
-00016ff0: 6173 2074 6c61 6e67 0a0a 2020 2020 6772  as tlang..    gr
-00017000: 6573 756c 7420 3d20 6720 2a20 7265 7375  esult = g * resu
-00017010: 6c74 2020 2320 7265 7573 6520 636f 6d6d  lt  # reuse comm
-00017020: 6f6e 2066 6163 746f 720a 2020 2020 6478  on factor.    dx
-00017030: 203d 2067 202a 2079 202a 2078 202a 2a20   = g * y * x ** 
-00017040: 2879 202d 2031 290a 2020 2020 6479 203d  (y - 1).    dy =
-00017050: 2067 7265 7375 6c74 202a 2074 6c61 6e67   gresult * tlang
-00017060: 2e6c 6f67 2878 290a 2020 2020 7265 7475  .log(x).    retu
-00017070: 726e 2064 782c 2064 790a 0a0a 4072 6567  rn dx, dy...@reg
-00017080: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00017090: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-000170a0: 696d 4944 732e 5441 4e29 0a64 6566 2074  imIDs.TAN).def t
-000170b0: 616e 5f61 7567 5f66 7764 2878 293a 0a20  an_aug_fwd(x):. 
-000170c0: 2020 2022 2222 4175 676d 656e 7465 6420     """Augmented 
-000170d0: 7461 6e20 6f70 6572 6174 696f 6e2e 0a0a  tan operation...
-000170e0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-000170f0: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
-00017100: 5465 6e73 6f72 2074 6f20 6265 2070 6173  Tensor to be pas
-00017110: 7365 6420 746f 2074 616e 2e0a 2020 2020  sed to tan..    
-00017120: 2222 220a 0a20 2020 2070 7269 6d61 6c20  """..    primal 
-00017130: 3d20 7072 696d 732e 7461 6e28 7829 0a20  = prims.tan(x). 
-00017140: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00017150: 7072 696d 616c 2c29 0a20 2020 2072 6574  primal,).    ret
-00017160: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00017170: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-00017180: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00017190: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000171a0: 732e 5441 4e29 0a64 6566 2074 616e 5f62  s.TAN).def tan_b
-000171b0: 6163 6b77 6172 6428 7265 7375 6c74 2c20  ackward(result, 
-000171c0: 6729 3a0a 2020 2020 7265 7475 726e 2067  g):.    return g
-000171d0: 202a 2028 3120 2b20 7265 7375 6c74 202a   * (1 + result *
-000171e0: 2072 6573 756c 7429 0a0a 0a23 204e 4f54   result)...# NOT
-000171f0: 453a 204a 6178 2075 7365 7320 6e70 2e61  E: Jax uses np.a
-00017200: 7267 736f 7274 2069 6e20 6974 7320 7472  rgsort in its tr
-00017210: 616e 7370 6f73 6520 766a 7020 636f 6d70  anspose vjp comp
-00017220: 7574 6174 696f 6e0a 6465 6620 5f61 7267  utation.def _arg
-00017230: 736f 7274 2873 6571 293a 0a20 2020 2072  sort(seq):.    r
-00017240: 6574 7572 6e20 736f 7274 6564 2872 616e  eturn sorted(ran
-00017250: 6765 286c 656e 2873 6571 2929 2c20 6b65  ge(len(seq)), ke
-00017260: 793d 7365 712e 5f5f 6765 7469 7465 6d5f  y=seq.__getitem_
-00017270: 5f29 0a0a 0a40 7265 6769 7374 6572 5f61  _)...@register_a
-00017280: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00017290: 2870 7269 6d73 2e50 7269 6d49 4473 2e44  (prims.PrimIDs.D
-000172a0: 4556 4943 455f 5055 5429 0a64 6566 2064  EVICE_PUT).def d
-000172b0: 6576 6963 655f 7075 745f 6175 675f 6677  evice_put_aug_fw
-000172c0: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
-000172d0: 2c20 6465 7669 6365 3a20 4465 7669 6365  , device: Device
-000172e0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-000172f0: 3a0a 2020 2020 7072 696d 616c 203d 2070  :.    primal = p
-00017300: 7269 6d73 2e64 6576 6963 655f 7075 7428  rims.device_put(
-00017310: 612c 2064 6576 6963 6529 0a20 2020 2072  a, device).    r
-00017320: 6573 6964 7561 6c73 203d 2028 612e 6465  esiduals = (a.de
-00017330: 7669 6365 2c29 0a20 2020 2072 6574 7572  vice,).    retur
-00017340: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-00017350: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
-00017360: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00017370: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00017380: 4445 5649 4345 5f50 5554 290a 6465 6620  DEVICE_PUT).def 
-00017390: 6465 7669 6365 5f70 7574 5f62 6163 6b77  device_put_backw
-000173a0: 6172 6428 6f72 6967 5f64 6576 6963 652c  ard(orig_device,
-000173b0: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
-000173c0: 7072 696d 732e 6465 7669 6365 5f70 7574  prims.device_put
-000173d0: 2867 2c20 6f72 6967 5f64 6576 6963 6529  (g, orig_device)
-000173e0: 2c20 4e6f 6e65 0a0a 0a40 7265 6769 7374  , None...@regist
-000173f0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-00017400: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00017410: 4473 2e43 4f4e 564f 4c55 5449 4f4e 290a  Ds.CONVOLUTION).
-00017420: 6465 6620 636f 6e76 6f6c 7574 696f 6e5f  def convolution_
-00017430: 6175 675f 6677 6428 0a20 2020 2061 3a20  aug_fwd(.    a: 
-00017440: 5072 6f78 792c 0a20 2020 2077 6569 6768  Proxy,.    weigh
-00017450: 742c 0a20 2020 2062 6961 732c 0a20 2020  t,.    bias,.   
-00017460: 2073 7472 6964 652c 0a20 2020 2070 6164   stride,.    pad
-00017470: 6469 6e67 2c0a 2020 2020 6469 6c61 7469  ding,.    dilati
-00017480: 6f6e 2c0a 2020 2020 7472 616e 7370 6f73  on,.    transpos
-00017490: 6564 2c0a 2020 2020 6f75 7470 7574 5f70  ed,.    output_p
-000174a0: 6164 6469 6e67 2c0a 2020 2020 6772 6f75  adding,.    grou
-000174b0: 7073 2c0a 293a 0a20 2020 2070 7269 6d61  ps,.):.    prima
-000174c0: 6c20 3d20 636f 6e76 6f6c 7574 696f 6e28  l = convolution(
-000174d0: 612c 2077 6569 6768 742c 2062 6961 732c  a, weight, bias,
-000174e0: 2073 7472 6964 652c 2070 6164 6469 6e67   stride, padding
-000174f0: 2c20 6469 6c61 7469 6f6e 2c20 7472 616e  , dilation, tran
-00017500: 7370 6f73 6564 2c20 6f75 7470 7574 5f70  sposed, output_p
-00017510: 6164 6469 6e67 2c20 6772 6f75 7073 290a  adding, groups).
-00017520: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
-00017530: 2870 7269 6d61 6c2c 2061 2c20 7765 6967  (primal, a, weig
-00017540: 6874 2c20 6269 6173 2c20 7374 7269 6465  ht, bias, stride
-00017550: 2c20 7061 6464 696e 672c 2064 696c 6174  , padding, dilat
-00017560: 696f 6e2c 2074 7261 6e73 706f 7365 642c  ion, transposed,
-00017570: 206f 7574 7075 745f 7061 6464 696e 672c   output_padding,
-00017580: 2067 726f 7570 7329 0a20 2020 2072 6574   groups).    ret
-00017590: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-000175a0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-000175b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000175c0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000175d0: 732e 434f 4e56 4f4c 5554 494f 4e29 0a64  s.CONVOLUTION).d
-000175e0: 6566 2063 6f6e 766f 6c75 7469 6f6e 5f62  ef convolution_b
-000175f0: 6163 6b77 6172 6428 0a20 2020 206f 7574  ackward(.    out
-00017600: 7075 743a 2050 726f 7879 2c0a 2020 2020  put: Proxy,.    
-00017610: 696e 7075 743a 2050 726f 7879 2c0a 2020  input: Proxy,.  
-00017620: 2020 7765 6967 6874 2c0a 2020 2020 6269    weight,.    bi
-00017630: 6173 2c0a 2020 2020 7374 7269 6465 2c0a  as,.    stride,.
-00017640: 2020 2020 7061 6464 696e 672c 0a20 2020      padding,.   
-00017650: 2064 696c 6174 696f 6e2c 0a20 2020 2074   dilation,.    t
-00017660: 7261 6e73 706f 7365 642c 0a20 2020 206f  ransposed,.    o
-00017670: 7574 7075 745f 7061 6464 696e 672c 0a20  utput_padding,. 
-00017680: 2020 2067 726f 7570 732c 0a20 2020 2067     groups,.    g
-00017690: 7261 642c 0a29 3a0a 2020 2020 2320 5472  rad,.):.    # Tr
-000176a0: 616e 7370 6f73 6564 2063 6f6e 766f 6c75  ansposed convolu
-000176b0: 7469 6f6e 2069 7320 6e6f 7420 7375 7070  tion is not supp
-000176c0: 6f72 7465 6421 0a20 2020 2061 7373 6572  orted!.    asser
-000176d0: 7420 7472 616e 7370 6f73 6564 203d 3d20  t transposed == 
-000176e0: 300a 0a20 2020 2069 6e70 7574 5f67 7261  0..    input_gra
-000176f0: 6420 3d20 4e6f 6e65 0a20 2020 2077 6569  d = None.    wei
-00017700: 6768 745f 6772 6164 203d 204e 6f6e 650a  ght_grad = None.
-00017710: 2020 2020 6269 6173 5f67 7261 6420 3d20      bias_grad = 
-00017720: 4e6f 6e65 0a0a 2020 2020 2320 5368 6f72  None..    # Shor
-00017730: 7420 6369 7263 7569 7420 6f6e 207a 6572  t circuit on zer
-00017740: 6f2d 6469 6d20 6772 6164 0a20 2020 2069  o-dim grad.    i
-00017750: 6620 616e 7928 7320 3d3d 2030 2066 6f72  f any(s == 0 for
-00017760: 2073 2069 6e20 6772 6164 2e73 6861 7065   s in grad.shape
-00017770: 293a 0a20 2020 2020 2020 2069 6e70 7574  ):.        input
-00017780: 5f67 7261 6420 3d20 6675 6c6c 5f6c 696b  _grad = full_lik
-00017790: 6528 696e 7075 742c 2066 696c 6c5f 7661  e(input, fill_va
-000177a0: 6c75 653d 3029 0a20 2020 2020 2020 2077  lue=0).        w
-000177b0: 6569 6768 745f 6772 6164 203d 2066 756c  eight_grad = ful
-000177c0: 6c5f 6c69 6b65 2877 6569 6768 742c 2066  l_like(weight, f
-000177d0: 696c 6c5f 7661 6c75 653d 3029 0a20 2020  ill_value=0).   
-000177e0: 2020 2020 2069 6620 6269 6173 2069 7320       if bias is 
-000177f0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00017800: 2020 2020 2020 6269 6173 5f67 7261 6420        bias_grad 
-00017810: 3d20 6675 6c6c 5f6c 696b 6528 6269 6173  = full_like(bias
-00017820: 2c20 6669 6c6c 5f76 616c 7565 3d30 290a  , fill_value=0).
-00017830: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00017840: 696e 7075 745f 6772 6164 2c20 7765 6967  input_grad, weig
-00017850: 6874 5f67 7261 642c 2062 6961 735f 6772  ht_grad, bias_gr
-00017860: 6164 2920 2b20 2828 4e6f 6e65 2c29 202a  ad) + ((None,) *
-00017870: 2036 290a 0a20 2020 2062 6174 6368 2c20   6)..    batch, 
-00017880: 696e 5f63 6861 6e6e 656c 732c 202a 7370  in_channels, *sp
-00017890: 6174 6961 6c5f 6469 6d73 203d 2069 6e70  atial_dims = inp
-000178a0: 7574 2e73 6861 7065 0a20 2020 206f 7574  ut.shape.    out
-000178b0: 5f63 6861 6e6e 656c 732c 2067 696e 5f63  _channels, gin_c
-000178c0: 6861 6e6e 656c 732c 202a 6b65 726e 656c  hannels, *kernel
-000178d0: 5f64 696d 7320 3d20 7765 6967 6874 2e73  _dims = weight.s
-000178e0: 6861 7065 0a20 2020 2064 696d 203d 206c  hape.    dim = l
-000178f0: 656e 2873 7061 7469 616c 5f64 696d 7329  en(spatial_dims)
-00017900: 0a0a 2020 2020 6465 6620 6d61 7962 655f  ..    def maybe_
-00017910: 6578 7061 6e64 5f73 6571 2873 2c20 6469  expand_seq(s, di
-00017920: 6d29 3a0a 2020 2020 2020 2020 6966 206c  m):.        if l
-00017930: 656e 2873 2920 3d3d 2031 3a0a 2020 2020  en(s) == 1:.    
-00017940: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00017950: 735b 305d 2c29 202a 2064 696d 0a20 2020  s[0],) * dim.   
-00017960: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00017970: 2020 2020 2020 2072 6574 7572 6e20 730a         return s.
-00017980: 0a20 2020 2073 7472 6964 6520 3d20 6d61  .    stride = ma
-00017990: 7962 655f 6578 7061 6e64 5f73 6571 2873  ybe_expand_seq(s
-000179a0: 7472 6964 652c 2064 696d 290a 2020 2020  tride, dim).    
-000179b0: 7061 6464 696e 6720 3d20 6d61 7962 655f  padding = maybe_
-000179c0: 6578 7061 6e64 5f73 6571 2870 6164 6469  expand_seq(paddi
-000179d0: 6e67 2c20 6469 6d29 0a20 2020 2064 696c  ng, dim).    dil
-000179e0: 6174 696f 6e20 3d20 6d61 7962 655f 6578  ation = maybe_ex
-000179f0: 7061 6e64 5f73 6571 2864 696c 6174 696f  pand_seq(dilatio
-00017a00: 6e2c 2064 696d 290a 0a20 2020 2064 6566  n, dim)..    def
-00017a10: 2063 6f6e 765f 7472 616e 7370 6f73 6528   conv_transpose(
-00017a20: 7429 3a0a 2020 2020 2020 2020 7265 7475  t):.        retu
-00017a30: 726e 2070 7269 6d73 2e74 7261 6e73 706f  rn prims.transpo
-00017a40: 7365 2874 2c20 2831 2c20 3029 202b 2074  se(t, (1, 0) + t
-00017a50: 7570 6c65 2872 616e 6765 2832 2c20 742e  uple(range(2, t.
-00017a60: 6e64 696d 2929 290a 0a20 2020 2023 2069  ndim)))..    # i
-00017a70: 6e70 7574 5f67 7261 6420 3d20 7b0a 2020  nput_grad = {.  
-00017a80: 2020 6465 6620 7472 616e 7370 6f73 655f    def transpose_
-00017a90: 616e 645f 666c 6970 5f77 6569 6768 7428  and_flip_weight(
-00017aa0: 7765 6967 6874 293a 0a20 2020 2020 2020  weight):.       
-00017ab0: 2023 2054 6865 206c 696e 6573 2062 656c   # The lines bel
-00017ac0: 6f77 2061 7265 2074 7261 6e73 706f 7369  ow are transposi
-00017ad0: 6e67 2074 6865 2063 6861 6e6e 656c 7320  ng the channels 
-00017ae0: 6469 6d73 2e0a 2020 2020 2020 2020 2320  dims..        # 
-00017af0: 5765 2061 6c73 6f20 6e65 6564 2074 6f20  We also need to 
-00017b00: 6578 7472 6163 7420 7468 6520 6772 6f75  extract the grou
-00017b10: 7020 696e 666f 726d 6174 696f 6e20 616e  p information an
-00017b20: 6420 6d65 7267 6520 6974 0a20 2020 2020  d merge it.     
-00017b30: 2020 2023 2077 6974 6820 7468 6520 6469     # with the di
-00017b40: 6d65 6e73 696f 6e20 636f 7272 6573 706f  mension correspo
-00017b50: 6e64 696e 6720 746f 2074 6865 2022 6f75  nding to the "ou
-00017b60: 745f 6368 616e 6e65 6c73 2220 6469 6d2e  t_channels" dim.
-00017b70: 0a20 2020 2020 2020 2023 2028 6f75 745f  .        # (out_
-00017b80: 6368 616e 6e65 6c73 2c20 6769 6e5f 6368  channels, gin_ch
-00017b90: 616e 6e65 6c73 2920 2d3e 2028 6769 6e5f  annels) -> (gin_
-00017ba0: 6368 616e 6e65 6c73 2c20 6f75 745f 6368  channels, out_ch
-00017bb0: 616e 6e65 6c73 290a 2020 2020 2020 2020  annels).        
-00017bc0: 7765 6967 6874 203d 2063 6f6e 765f 7472  weight = conv_tr
-00017bd0: 616e 7370 6f73 6528 7765 6967 6874 290a  anspose(weight).
-00017be0: 2020 2020 2020 2020 2320 5370 6c69 7420          # Split 
-00017bf0: 286f 7574 5f63 6861 6e6e 656c 732c 2920  (out_channels,) 
-00017c00: 2d3e 2028 6772 6f75 7073 2c20 6f75 745f  -> (groups, out_
-00017c10: 6368 616e 6e65 6c73 202f 2f20 6772 6f75  channels // grou
-00017c20: 7073 290a 2020 2020 2020 2020 7765 6967  ps).        weig
-00017c30: 6874 203d 2077 6569 6768 742e 7265 7368  ht = weight.resh
-00017c40: 6170 6528 5b67 696e 5f63 6861 6e6e 656c  ape([gin_channel
-00017c50: 732c 2067 726f 7570 732c 206f 7574 5f63  s, groups, out_c
-00017c60: 6861 6e6e 656c 7320 2f2f 2067 726f 7570  hannels // group
-00017c70: 735d 202b 206b 6572 6e65 6c5f 6469 6d73  s] + kernel_dims
-00017c80: 290a 2020 2020 2020 2020 2320 4d6f 7669  ).        # Movi
-00017c90: 6e67 2067 726f 7570 7320 746f 2074 6865  ng groups to the
-00017ca0: 206c 6566 742d 6d6f 7374 2070 6f73 6974   left-most posit
-00017cb0: 696f 6e2e 0a20 2020 2020 2020 2023 2028  ion..        # (
-00017cc0: 6769 6e5f 6368 616e 6e65 6c73 2c20 6772  gin_channels, gr
-00017cd0: 6f75 7073 2c20 6f75 745f 6368 616e 6e65  oups, out_channe
-00017ce0: 6c73 202f 2f20 6772 6f75 7073 2920 2d3e  ls // groups) ->
-00017cf0: 2028 6772 6f75 7073 2c20 6769 6e5f 6368   (groups, gin_ch
-00017d00: 616e 6e65 6c73 2c20 6f75 745f 6368 616e  annels, out_chan
-00017d10: 6e65 6c73 202f 2f20 6772 6f75 7073 290a  nels // groups).
-00017d20: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
-00017d30: 2063 6f6e 765f 7472 616e 7370 6f73 6528   conv_transpose(
-00017d40: 7765 6967 6874 290a 2020 2020 2020 2020  weight).        
-00017d50: 2320 5371 7561 7368 2028 6772 6f75 7073  # Squash (groups
-00017d60: 2c20 6769 6e5f 6368 616e 6e65 6c73 2920  , gin_channels) 
-00017d70: 2d3e 2028 696e 5f63 6861 6e6e 656c 7329  -> (in_channels)
-00017d80: 0a20 2020 2020 2020 2077 6569 6768 7420  .        weight 
-00017d90: 3d20 7765 6967 6874 2e72 6573 6861 7065  = weight.reshape
-00017da0: 285b 696e 5f63 6861 6e6e 656c 732c 206f  ([in_channels, o
-00017db0: 7574 5f63 6861 6e6e 656c 7320 2f2f 2067  ut_channels // g
-00017dc0: 726f 7570 735d 202b 206b 6572 6e65 6c5f  roups] + kernel_
-00017dd0: 6469 6d73 290a 0a20 2020 2020 2020 2023  dims)..        #
-00017de0: 2046 6c69 7020 7370 6174 6961 6c20 6469   Flip spatial di
-00017df0: 6d65 6e73 696f 6e73 0a20 2020 2020 2020  mensions.       
-00017e00: 2077 6569 6768 7420 3d20 7072 696d 732e   weight = prims.
-00017e10: 666c 6970 2877 6569 6768 742c 2074 7570  flip(weight, tup
-00017e20: 6c65 2872 616e 6765 2832 2c20 7765 6967  le(range(2, weig
-00017e30: 6874 2e6e 6469 6d29 2929 0a20 2020 2020  ht.ndim))).     
-00017e40: 2020 2072 6574 7572 6e20 7765 6967 6874     return weight
-00017e50: 0a0a 2020 2020 2320 5765 206e 6565 6420  ..    # We need 
-00017e60: 746f 2070 6164 2074 6865 2067 7261 6469  to pad the gradi
-00017e70: 656e 7420 746f 2062 6520 6162 6c65 2074  ent to be able t
-00017e80: 6f20 6669 7420 6b65 726e 656c 2077 696e  o fit kernel win
-00017e90: 646f 7773 2e0a 2020 2020 696e 6974 6961  dows..    initia
-00017ea0: 6c5f 6772 6164 5f70 6164 6469 6e67 203d  l_grad_padding =
-00017eb0: 205b 6420 2a20 286b 202d 2031 2920 666f   [d * (k - 1) fo
-00017ec0: 7220 642c 206b 2069 6e20 7a69 7028 6469  r d, k in zip(di
-00017ed0: 6c61 7469 6f6e 2c20 6b65 726e 656c 5f64  lation, kernel_d
-00017ee0: 696d 7329 5d0a 0a20 2020 2069 6e70 7574  ims)]..    input
-00017ef0: 5f67 7261 6420 3d20 636f 6e76 6f6c 7574  _grad = convolut
-00017f00: 696f 6e28 0a20 2020 2020 2020 2070 7269  ion(.        pri
-00017f10: 6d73 2e70 6164 280a 2020 2020 2020 2020  ms.pad(.        
-00017f20: 2020 2020 6772 6164 2c0a 2020 2020 2020      grad,.      
-00017f30: 2020 2020 2020 302e 302c 0a20 2020 2020        0.0,.     
-00017f40: 2020 2020 2020 2023 2054 6865 2070 6978         # The pix
-00017f50: 6573 2061 7265 2073 7472 6964 6520 6177  es are stride aw
-00017f60: 6179 2066 726f 6d20 6561 6368 206f 7468  ay from each oth
-00017f70: 6572 2069 6e20 7468 6520 6f72 6967 696e  er in the origin
-00017f80: 616c 2069 6e70 7574 2e0a 2020 2020 2020  al input..      
-00017f90: 2020 2020 2020 2320 4865 6e63 6520 7765        # Hence we
-00017fa0: 206e 6565 6420 746f 2064 696c 6174 6520   need to dilate 
-00017fb0: 7468 6520 6772 6164 6965 6e74 2062 7920  the gradient by 
-00017fc0: 6469 6c61 7469 6f6e 3d73 7472 6964 6520  dilation=stride 
-00017fd0: 2d20 310a 2020 2020 2020 2020 2020 2020  - 1.            
-00017fe0: 2320 736f 2074 6861 7420 7468 6572 6520  # so that there 
-00017ff0: 6172 6520 7374 7269 6465 202d 2031 207a  are stride - 1 z
-00018000: 6572 6f73 2062 6574 7765 656e 2074 6865  eros between the
-00018010: 2070 6978 656c 732e 0a20 2020 2020 2020   pixels..       
-00018020: 2020 2020 205b 2830 2c20 302c 2030 292c       [(0, 0, 0),
-00018030: 2028 302c 2030 2c20 3029 5d20 2b20 5b28   (0, 0, 0)] + [(
-00018040: 302c 2030 2c20 7320 2d20 3129 2066 6f72  0, 0, s - 1) for
-00018050: 2073 2069 6e20 7374 7269 6465 5d2c 0a20   s in stride],. 
-00018060: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00018070: 2020 7472 616e 7370 6f73 655f 616e 645f    transpose_and_
-00018080: 666c 6970 5f77 6569 6768 7428 7765 6967  flip_weight(weig
-00018090: 6874 292c 0a20 2020 2020 2020 204e 6f6e  ht),.        Non
-000180a0: 652c 0a20 2020 2020 2020 2023 2053 6574  e,.        # Set
-000180b0: 7469 6e67 2073 7472 6964 6520 746f 2031  ting stride to 1
-000180c0: 2061 7320 7468 6520 6469 7374 616e 6365   as the distance
-000180d0: 2062 6574 7765 656e 2070 6978 656c 7320   between pixels 
-000180e0: 6973 2074 616b 656e 0a20 2020 2020 2020  is taken.       
-000180f0: 2023 2063 6172 6520 6279 2074 6865 2070   # care by the p
-00018100: 6164 2072 6967 6874 2061 626f 7665 2e0a  ad right above..
-00018110: 2020 2020 2020 2020 2831 2c29 2c0a 2020          (1,),.  
-00018120: 2020 2020 2020 696e 6974 6961 6c5f 6772        initial_gr
-00018130: 6164 5f70 6164 6469 6e67 2c0a 2020 2020  ad_padding,.    
-00018140: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
-00018150: 2020 2020 2020 7472 616e 7370 6f73 6564        transposed
-00018160: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
-00018170: 5f70 6164 6469 6e67 2c0a 2020 2020 2020  _padding,.      
-00018180: 2020 6772 6f75 7073 2c0a 2020 2020 290a    groups,.    ).
-00018190: 0a20 2020 2064 6566 2070 6164 5f74 6f5f  .    def pad_to_
-000181a0: 696e 7075 7428 6772 6164 293a 0a20 2020  input(grad):.   
-000181b0: 2020 2020 2023 2057 6520 6e65 6564 2074       # We need t
-000181c0: 6f20 756e 7061 6420 7468 6520 7061 6464  o unpad the padd
-000181d0: 696e 6720 646f 6e65 2074 6f20 7468 6520  ing done to the 
-000181e0: 696e 7075 7420 7072 696f 7220 746f 2074  input prior to t
-000181f0: 6865 2063 6f6e 766f 6c75 7469 6f6e 2e0a  he convolution..
-00018200: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
-00018210: 6861 7420 6c6f 7720 616e 6420 6869 6768  hat low and high
-00018220: 2070 6164 6469 6e67 2061 7265 206e 6f74   padding are not
-00018230: 206e 6563 6573 7361 7269 6c79 2065 7175   necessarily equ
-00018240: 616c 2c20 736f 2077 6520 6361 6e6e 6f74  al, so we cannot
-00018250: 0a20 2020 2020 2020 2023 2061 6273 6f72  .        # absor
-00018260: 6220 6974 2069 6e74 6f20 7468 6520 636f  b it into the co
-00018270: 6e76 6f6c 7574 696f 6e20 6a75 7374 2079  nvolution just y
-00018280: 6574 2c20 756e 6c65 7373 2074 6865 2041  et, unless the A
-00018290: 5049 2069 7320 6d6f 6469 6669 6564 2e0a  PI is modified..
-000182a0: 2020 2020 2020 2020 7061 645f 636f 6e66          pad_conf
-000182b0: 6967 203d 205b 2830 2c20 302c 2030 292c  ig = [(0, 0, 0),
-000182c0: 2028 302c 2030 2c20 3029 5d0a 2020 2020   (0, 0, 0)].    
-000182d0: 2020 2020 666f 7220 6f2c 2069 2c20 672c      for o, i, g,
-000182e0: 2070 2069 6e20 7a69 7028 6772 6164 2e73   p in zip(grad.s
-000182f0: 6861 7065 5b32 3a5d 2c20 7370 6174 6961  hape[2:], spatia
-00018300: 6c5f 6469 6d73 2c20 696e 7075 745f 6772  l_dims, input_gr
-00018310: 6164 2e73 6861 7065 5b32 3a5d 2c20 7061  ad.shape[2:], pa
-00018320: 6464 696e 6729 3a0a 2020 2020 2020 2020  dding):.        
-00018330: 2020 2020 6c6f 203d 202d 700a 2020 2020      lo = -p.    
-00018340: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
-00018350: 6861 7420 2869 202b 2032 202a 2070 2920  hat (i + 2 * p) 
-00018360: 6973 2074 6865 2073 697a 6520 6f66 2074  is the size of t
-00018370: 6865 2070 6164 6465 6420 696e 7075 742c  he padded input,
-00018380: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-00018390: 6f20 7468 6520 7175 616e 7469 7479 2028  o the quantity (
-000183a0: 6920 2b20 3220 2a20 7029 202d 2067 2074  i + 2 * p) - g t
-000183b0: 656c 6c73 2075 7320 6279 2068 6f77 206d  ells us by how m
-000183c0: 7563 680a 2020 2020 2020 2020 2020 2020  uch.            
-000183d0: 2320 7765 206e 6565 6420 746f 2070 6164  # we need to pad
-000183e0: 2074 6865 2067 7261 6469 656e 7420 736f   the gradient so
-000183f0: 2074 6861 7420 7468 6520 656c 656d 656e   that the elemen
-00018400: 7473 206f 7574 7369 6465 0a20 2020 2020  ts outside.     
-00018410: 2020 2020 2020 2023 206f 6620 7468 6520         # of the 
-00018420: 636f 6e76 6f6c 7574 696f 6e20 7265 6365  convolution rece
-00018430: 6976 6520 7a65 726f 2067 7261 6469 656e  ive zero gradien
-00018440: 742e 0a20 2020 2020 2020 2020 2020 2023  t..            #
-00018450: 2070 2069 7320 6164 6469 7469 6f6e 616c   p is additional
-00018460: 6c79 2073 7562 7472 6163 7465 6420 746f  ly subtracted to
-00018470: 206e 6567 6174 6520 7468 6520 696e 7075   negate the inpu
-00018480: 7427 7320 7061 640a 2020 2020 2020 2020  t's pad.        
-00018490: 2020 2020 2320 696e 2066 6f72 7761 7264      # in forward
-000184a0: 2e0a 2020 2020 2020 2020 2020 2020 6869  ..            hi
-000184b0: 203d 2028 6920 2b20 3220 2a20 7029 202d   = (i + 2 * p) -
-000184c0: 2067 202d 2070 0a20 2020 2020 2020 2020   g - p.         
-000184d0: 2020 2070 6164 5f63 6f6e 6669 672e 6170     pad_config.ap
-000184e0: 7065 6e64 2828 6c6f 2c20 6869 2c20 3029  pend((lo, hi, 0)
-000184f0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00018500: 2070 7269 6d73 2e70 6164 2867 7261 642c   prims.pad(grad,
-00018510: 2030 2e30 2c20 7061 645f 636f 6e66 6967   0.0, pad_config
-00018520: 290a 0a20 2020 2069 6e70 7574 5f67 7261  )..    input_gra
-00018530: 6420 3d20 7061 645f 746f 5f69 6e70 7574  d = pad_to_input
-00018540: 2869 6e70 7574 5f67 7261 6429 0a20 2020  (input_grad).   
-00018550: 2023 207d 0a0a 2020 2020 2320 6269 6173   # }..    # bias
-00018560: 5f67 7261 6420 3d20 7b0a 2020 2020 6966  _grad = {.    if
-00018570: 2062 6961 7320 6973 206e 6f74 204e 6f6e   bias is not Non
-00018580: 653a 0a20 2020 2020 2020 2069 6d70 6f72  e:.        impor
-00018590: 7420 7468 756e 6465 722e 746f 7263 6820  t thunder.torch 
-000185a0: 6173 206c 746f 7263 680a 0a20 2020 2020  as ltorch..     
-000185b0: 2020 2062 6961 735f 6772 6164 203d 206c     bias_grad = l
-000185c0: 746f 7263 682e 7375 6d28 6772 6164 2c20  torch.sum(grad, 
-000185d0: 5b64 2066 6f72 2064 2069 6e20 7261 6e67  [d for d in rang
-000185e0: 6528 6772 6164 2e6e 6469 6d29 2069 6620  e(grad.ndim) if 
-000185f0: 6420 213d 2031 5d29 0a20 2020 2023 207d  d != 1]).    # }
-00018600: 0a0a 2020 2020 2320 7765 6967 6874 2067  ..    # weight g
-00018610: 7261 6420 3d20 7b0a 2020 2020 6465 6620  rad = {.    def 
-00018620: 7061 645f 7472 616e 7370 6f73 655f 616e  pad_transpose_an
-00018630: 645f 7075 7368 5f67 726f 7570 735f 696e  d_push_groups_in
-00018640: 746f 5f62 6174 6368 6573 2874 293a 0a20  to_batches(t):. 
-00018650: 2020 2020 2020 2023 2046 6972 7374 2070         # First p
-00018660: 6164 2c2e 2e2e 0a20 2020 2020 2020 2023  ad,....        #
-00018670: 2050 6164 2061 7320 6e65 6365 7373 6172   Pad as necessar
-00018680: 7920 736f 2074 6861 7420 696e 2063 6f6e  y so that in con
-00018690: 766f 6c75 7469 6f6e 7320 7765 206e 6576  volutions we nev
-000186a0: 6572 2061 6476 616e 6365 0a20 2020 2020  er advance.     
-000186b0: 2020 2023 2070 6173 7420 7265 6c65 7661     # past releva
-000186c0: 6e74 2069 6e70 7574 732e 0a20 2020 2020  nt inputs..     
-000186d0: 2020 2070 6164 5f63 6f6e 6669 6720 3d20     pad_config = 
-000186e0: 5b28 302c 2030 2c20 3029 2c20 2830 2c20  [(0, 0, 0), (0, 
-000186f0: 302c 2030 295d 0a20 2020 2020 2020 2066  0, 0)].        f
-00018700: 6f72 206f 2c20 692c 206b 2c20 702c 2073  or o, i, k, p, s
-00018710: 2c20 6420 696e 207a 6970 2867 7261 642e  , d in zip(grad.
-00018720: 7368 6170 655b 323a 5d2c 2073 7061 7469  shape[2:], spati
-00018730: 616c 5f64 696d 732c 206b 6572 6e65 6c5f  al_dims, kernel_
-00018740: 6469 6d73 2c20 7061 6464 696e 672c 2073  dims, padding, s
-00018750: 7472 6964 652c 2064 696c 6174 696f 6e29  tride, dilation)
-00018760: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00018770: 5061 6464 696e 6720 6672 6f6d 2062 656c  Padding from bel
-00018780: 6f77 2069 7320 7468 6520 7361 6d65 2e0a  ow is the same..
-00018790: 2020 2020 2020 2020 2020 2020 6c6f 203d              lo =
-000187a0: 2070 0a20 2020 2020 2020 2020 2020 2023   p.            #
-000187b0: 2054 6865 7265 2069 7320 616c 7761 7973   There is always
-000187c0: 2074 6865 206d 6178 2069 6e64 6578 2069   the max index i
-000187d0: 6478 2069 6e20 7468 6520 696e 7075 740a  dx in the input.
-000187e0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-000187f0: 6520 7661 6c75 6520 6f66 2077 6869 6368  e value of which
-00018800: 2c20 696e 7075 745b 6964 785d 2c20 7468  , input[idx], th
-00018810: 6520 6b65 726e 656c 2074 6f75 6368 6573  e kernel touches
-00018820: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00018830: 5468 6520 6b65 726e 656c 2072 6561 6368  The kernel reach
-00018840: 2c20 6f72 206b 5f72 6561 6368 2c20 6973  , or k_reach, is
-00018850: 2065 7861 6374 6c79 2069 6478 202b 2031   exactly idx + 1
-00018860: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00018870: 5765 2075 7365 2069 7420 746f 2064 6563  We use it to dec
-00018880: 6964 6520 6279 2068 6f77 206d 7563 6820  ide by how much 
-00018890: 7765 206e 6565 6420 746f 2070 6164 2066  we need to pad f
-000188a0: 726f 6d20 6162 6f76 650a 2020 2020 2020  rom above.      
-000188b0: 2020 2020 2020 2320 6173 2074 6f20 6e6f        # as to no
-000188c0: 7420 6d6f 7665 2070 6173 7420 7265 6c65  t move past rele
-000188d0: 7661 6e74 2076 616c 7565 732e 0a20 2020  vant values..   
-000188e0: 2020 2020 2020 2020 206b 5f72 6561 6368           k_reach
-000188f0: 203d 2028 6f20 2d20 3129 202a 2073 202b   = (o - 1) * s +
-00018900: 2064 202a 2028 6b20 2d20 3129 202b 2031   d * (k - 1) + 1
-00018910: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00018920: 6865 2070 6164 2066 726f 6d20 6162 6f76  he pad from abov
-00018930: 6520 6571 7561 6c73 206b 5f72 6561 6368  e equals k_reach
-00018940: 206d 696e 7573 2074 6865 206c 656e 6774   minus the lengt
-00018950: 680a 2020 2020 2020 2020 2020 2020 2320  h.            # 
-00018960: 6f66 2074 6865 2069 6e70 7574 2070 6164  of the input pad
-00018970: 6465 6420 6672 6f6d 2062 656c 6f77 2e0a  ded from below..
-00018980: 2020 2020 2020 2020 2020 2020 6869 203d              hi =
-00018990: 206b 5f72 6561 6368 202d 2028 6920 2b20   k_reach - (i + 
-000189a0: 7029 0a20 2020 2020 2020 2020 2020 2070  p).            p
-000189b0: 6164 5f63 6f6e 6669 672e 6170 7065 6e64  ad_config.append
-000189c0: 2828 6c6f 2c20 6869 2c20 3029 290a 2020  ((lo, hi, 0)).  
-000189d0: 2020 2020 2020 7420 3d20 7072 696d 732e        t = prims.
-000189e0: 7061 6428 742c 2030 2e30 2c20 7061 645f  pad(t, 0.0, pad_
-000189f0: 636f 6e66 6967 290a 0a20 2020 2020 2020  config)..       
-00018a00: 205f 2c20 5f2c 202a 745f 7370 6174 6961   _, _, *t_spatia
-00018a10: 6c5f 6469 6d73 203d 2074 2e73 6861 7065  l_dims = t.shape
-00018a20: 0a0a 2020 2020 2020 2020 2320 2e2e 2e20  ..        # ... 
-00018a30: 7468 656e 2064 6f20 7468 6520 7265 7374  then do the rest
-00018a40: 2e0a 2020 2020 2020 2020 2320 742e 7368  ..        # t.sh
-00018a50: 6170 6520 3d3d 2028 6261 7463 682c 2069  ape == (batch, i
-00018a60: 6e5f 6368 616e 6e65 6c73 2c20 2e2e 2e29  n_channels, ...)
-00018a70: 0a20 2020 2020 2020 2023 2054 6865 2072  .        # The r
-00018a80: 6573 756c 7420 6f66 2074 6869 7320 6675  esult of this fu
-00018a90: 6e63 7469 6f6e 2068 6173 2073 6861 7065  nction has shape
-00018aa0: 0a20 2020 2020 2020 2023 2028 696e 5f63  .        # (in_c
-00018ab0: 6861 6e6e 656c 732c 2062 6174 6368 202a  hannels, batch *
-00018ac0: 2067 726f 7570 7329 0a20 2020 2020 2020   groups).       
-00018ad0: 2023 2028 6261 7463 682c 2069 6e5f 6368   # (batch, in_ch
-00018ae0: 616e 6e65 6c73 2920 2d3e 2028 696e 5f63  annels) -> (in_c
-00018af0: 6861 6e6e 656c 732c 2062 6174 6368 290a  hannels, batch).
-00018b00: 2020 2020 2020 2020 7420 3d20 636f 6e76          t = conv
-00018b10: 5f74 7261 6e73 706f 7365 2874 290a 2020  _transpose(t).  
-00018b20: 2020 2020 2020 2320 5370 6c69 7420 2869        # Split (i
-00018b30: 6e5f 6368 616e 6e65 6c73 2c29 202d 3e20  n_channels,) -> 
-00018b40: 2867 726f 7570 732c 2067 696e 5f63 6861  (groups, gin_cha
-00018b50: 6e6e 656c 7329 0a20 2020 2020 2020 2074  nnels).        t
-00018b60: 203d 2074 2e72 6573 6861 7065 285b 6772   = t.reshape([gr
-00018b70: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
-00018b80: 6c73 2c20 6261 7463 685d 202b 2074 5f73  ls, batch] + t_s
-00018b90: 7061 7469 616c 5f64 696d 7329 0a20 2020  patial_dims).   
-00018ba0: 2020 2020 2023 2054 7261 6e73 706f 7365       # Transpose
-00018bb0: 2028 6772 6f75 7073 2c20 6769 6e5f 6368   (groups, gin_ch
-00018bc0: 616e 6e65 6c73 2c20 6261 7463 6829 202d  annels, batch) -
-00018bd0: 3e20 2867 696e 5f63 6861 6e6e 656c 732c  > (gin_channels,
-00018be0: 2067 726f 7570 732c 2062 6174 6368 290a   groups, batch).
-00018bf0: 2020 2020 2020 2020 7420 3d20 636f 6e76          t = conv
-00018c00: 5f74 7261 6e73 706f 7365 2874 290a 2020  _transpose(t).  
-00018c10: 2020 2020 2020 2320 466c 6174 7465 6e20        # Flatten 
-00018c20: 2867 726f 7570 732c 2062 6174 6368 2920  (groups, batch) 
-00018c30: 2d3e 2028 6772 6f75 7073 202a 2062 6174  -> (groups * bat
-00018c40: 6368 2c29 0a20 2020 2020 2020 2074 203d  ch,).        t =
-00018c50: 2074 2e72 6573 6861 7065 285b 6769 6e5f   t.reshape([gin_
-00018c60: 6368 616e 6e65 6c73 2c20 6772 6f75 7073  channels, groups
-00018c70: 202a 2062 6174 6368 5d20 2b20 745f 7370   * batch] + t_sp
-00018c80: 6174 6961 6c5f 6469 6d73 290a 2020 2020  atial_dims).    
-00018c90: 2020 2020 7265 7475 726e 2074 0a0a 2020      return t..  
-00018ca0: 2020 2320 696e 7075 7420 7769 6c6c 2068    # input will h
-00018cb0: 6176 6520 7368 6170 6520 2867 696e 5f63  ave shape (gin_c
-00018cc0: 6861 6e6e 656c 732c 2067 726f 7570 7320  hannels, groups 
-00018cd0: 2a20 6261 7463 6829 0a20 2020 2069 6e70  * batch).    inp
-00018ce0: 7574 203d 2070 6164 5f74 7261 6e73 706f  ut = pad_transpo
-00018cf0: 7365 5f61 6e64 5f70 7573 685f 6772 6f75  se_and_push_grou
-00018d00: 7073 5f69 6e74 6f5f 6261 7463 6865 7328  ps_into_batches(
-00018d10: 696e 7075 7429 0a20 2020 2023 2067 7261  input).    # gra
-00018d20: 6420 7769 6c6c 2068 6176 6520 7368 6170  d will have shap
-00018d30: 6520 286f 7574 5f63 6861 6e6e 656c 732c  e (out_channels,
-00018d40: 2062 6174 6368 290a 2020 2020 2320 4e6f   batch).    # No
-00018d50: 7465 2074 6861 7420 7468 6573 6520 7368  te that these sh
-00018d60: 6170 6573 2061 7265 2063 6f6d 7061 7469  apes are compati
-00018d70: 626c 6520 666f 7220 6120 6772 6f75 7020  ble for a group 
-00018d80: 636f 6e76 6f6c 7574 696f 6e2e 0a20 2020  convolution..   
-00018d90: 2067 7261 6420 3d20 636f 6e76 5f74 7261   grad = conv_tra
-00018da0: 6e73 706f 7365 2867 7261 6429 0a0a 2020  nspose(grad)..  
-00018db0: 2020 2320 5768 7920 646f 2077 6520 666c    # Why do we fl
-00018dc0: 6970 2073 7472 6964 6520 616e 6420 6469  ip stride and di
-00018dd0: 6c61 7469 6f6e 3f0a 2020 2020 2320 6b65  lation?.    # ke
-00018de0: 726e 656c 5b69 5d20 616e 6420 6b65 726e  rnel[i] and kern
-00018df0: 656c 5b69 202b 2031 5d20 6172 6520 6469  el[i + 1] are di
-00018e00: 6c61 7469 6f6e 2061 7061 7274 2066 726f  lation apart fro
-00018e10: 6d20 6561 6368 206f 7468 6572 2c0a 2020  m each other,.  
-00018e20: 2020 2320 736f 2064 696c 6174 696f 6e20    # so dilation 
-00018e30: 6265 636f 6d65 7320 7468 6520 6e65 7720  becomes the new 
-00018e40: 7374 7269 6465 2e0a 2020 2020 2320 416c  stride..    # Al
-00018e50: 6c20 7468 6520 656c 656d 656e 7473 2074  l the elements t
-00018e60: 6861 7420 6b65 726e 656c 5b69 5d20 746f  hat kernel[i] to
-00018e70: 7563 6865 7320 6172 6520 7374 7269 6465  uches are stride
-00018e80: 2061 7761 7920 6672 6f6d 2065 6163 6820   away from each 
-00018e90: 6f74 6865 722c 0a20 2020 2023 2068 656e  other,.    # hen
-00018ea0: 6365 2073 7472 6964 6520 6265 636f 6d65  ce stride become
-00018eb0: 7320 7468 6520 6e65 7720 6469 6c61 7469  s the new dilati
-00018ec0: 6f6e 2e0a 2020 2020 7765 6967 6874 5f67  on..    weight_g
-00018ed0: 7261 6420 3d20 636f 6e76 6f6c 7574 696f  rad = convolutio
-00018ee0: 6e28 0a20 2020 2020 2020 2069 6e70 7574  n(.        input
-00018ef0: 2c0a 2020 2020 2020 2020 6772 6164 2c0a  ,.        grad,.
-00018f00: 2020 2020 2020 2020 4e6f 6e65 2c0a 2020          None,.  
-00018f10: 2020 2020 2020 6469 6c61 7469 6f6e 2c20        dilation, 
-00018f20: 2023 2073 6574 2073 7472 6964 653d 6469   # set stride=di
-00018f30: 6c61 7469 6f6e 0a20 2020 2020 2020 2028  lation.        (
-00018f40: 302c 292c 0a20 2020 2020 2020 2073 7472  0,),.        str
-00018f50: 6964 652c 2020 2320 7365 7420 6469 6c61  ide,  # set dila
-00018f60: 7469 6f6e 3d73 7472 6964 650a 2020 2020  tion=stride.    
-00018f70: 2020 2020 7472 616e 7370 6f73 6564 2c0a      transposed,.
-00018f80: 2020 2020 2020 2020 6f75 7470 7574 5f70          output_p
-00018f90: 6164 6469 6e67 2c0a 2020 2020 2020 2020  adding,.        
-00018fa0: 6772 6f75 7073 2c0a 2020 2020 290a 0a20  groups,.    ).. 
-00018fb0: 2020 2023 2054 6865 2072 6573 756c 7420     # The result 
-00018fc0: 6f66 2074 6865 2063 6f6e 766f 6c75 7469  of the convoluti
-00018fd0: 6f6e 2068 6173 2073 6861 7065 2028 6769  on has shape (gi
-00018fe0: 6e5f 6368 616e 6e65 6c73 2c20 6f75 745f  n_channels, out_
-00018ff0: 6368 616e 6e65 6c73 292c 0a20 2020 2023  channels),.    #
-00019000: 2073 6f20 7472 616e 7370 6f73 6974 696f   so transpositio
-00019010: 6e20 6973 2072 6571 7569 7265 642e 0a20  n is required.. 
-00019020: 2020 2077 6569 6768 745f 6772 6164 203d     weight_grad =
-00019030: 2063 6f6e 765f 7472 616e 7370 6f73 6528   conv_transpose(
-00019040: 7765 6967 6874 5f67 7261 6429 0a20 2020  weight_grad).   
-00019050: 2023 207d 0a0a 2020 2020 7265 7475 726e   # }..    return
-00019060: 2028 696e 7075 745f 6772 6164 2c20 7765   (input_grad, we
-00019070: 6967 6874 5f67 7261 642c 2062 6961 735f  ight_grad, bias_
-00019080: 6772 6164 290a 0a0a 4072 6567 6973 7465  grad)...@registe
-00019090: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-000190a0: 6172 6428 2274 6f72 6368 2e6c 6f67 5f73  ard("torch.log_s
-000190b0: 6f66 746d 6178 2229 0a64 6566 206c 6f67  oftmax").def log
-000190c0: 5f73 6f66 746d 6178 5f61 7567 5f66 7764  _softmax_aug_fwd
-000190d0: 2869 6e70 7574 3a20 5465 6e73 6f72 5072  (input: TensorPr
-000190e0: 6f78 792c 2064 696d 3a20 696e 742c 202a  oxy, dim: int, *
-000190f0: 2c20 6474 7970 653d 4e6f 6e65 2920 2d3e  , dtype=None) ->
-00019100: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
-00019110: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00019120: 2069 6d70 6f72 7420 6c6f 675f 736f 6674   import log_soft
-00019130: 6d61 780a 0a20 2020 2070 7269 6d61 6c20  max..    primal 
-00019140: 3d20 6c6f 675f 736f 6674 6d61 7828 696e  = log_softmax(in
-00019150: 7075 742c 2064 696d 3d64 696d 2c20 6474  put, dim=dim, dt
-00019160: 7970 653d 6474 7970 6529 0a20 2020 2072  ype=dtype).    r
-00019170: 6573 6964 7561 6c73 203d 2028 7072 696d  esiduals = (prim
-00019180: 616c 2c20 6469 6d2c 2069 6e70 7574 2e64  al, dim, input.d
-00019190: 7479 7065 290a 2020 2020 7265 7475 726e  type).    return
-000191a0: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-000191b0: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-000191c0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-000191d0: 2822 746f 7263 682e 6c6f 675f 736f 6674  ("torch.log_soft
-000191e0: 6d61 7822 290a 6465 6620 6c6f 675f 736f  max").def log_so
-000191f0: 6674 6d61 785f 6261 636b 7761 7264 2870  ftmax_backward(p
-00019200: 7269 6d61 6c2c 2064 696d 2c20 6474 7970  rimal, dim, dtyp
-00019210: 652c 2067 293a 0a20 2020 2066 726f 6d20  e, g):.    from 
-00019220: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00019230: 706f 7274 206c 6f67 5f73 6f66 746d 6178  port log_softmax
-00019240: 5f62 6163 6b77 6172 640a 0a20 2020 2072  _backward..    r
-00019250: 6574 7572 6e20 6c6f 675f 736f 6674 6d61  eturn log_softma
-00019260: 785f 6261 636b 7761 7264 2867 2c20 7072  x_backward(g, pr
-00019270: 696d 616c 2c20 6469 6d2c 2064 7479 7065  imal, dim, dtype
-00019280: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-00019290: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-000192a0: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
-000192b0: 6f6e 616c 2e6e 6c6c 5f6c 6f73 7322 290a  onal.nll_loss").
-000192c0: 6465 6620 6e6c 6c5f 6c6f 7373 5f61 7567  def nll_loss_aug
-000192d0: 5f66 7764 280a 2020 2020 696e 7075 743a  _fwd(.    input:
-000192e0: 2050 726f 7879 2c0a 2020 2020 7461 7267   Proxy,.    targ
-000192f0: 6574 3a20 5072 6f78 792c 0a20 2020 2077  et: Proxy,.    w
-00019300: 6569 6768 743a 204e 6f6e 6520 7c20 5072  eight: None | Pr
-00019310: 6f78 792c 0a20 2020 2069 676e 6f72 655f  oxy,.    ignore_
-00019320: 696e 6465 783a 2069 6e74 2c0a 2020 2020  index: int,.    
-00019330: 7265 6475 6374 696f 6e3a 2073 7472 2c0a  reduction: str,.
-00019340: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
-00019350: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00019360: 6f72 6368 2069 6d70 6f72 7420 5f6e 6c6c  orch import _nll
-00019370: 5f6c 6f73 735f 6865 6c70 6572 0a0a 2020  _loss_helper..  
-00019380: 2020 7072 696d 616c 2c20 746f 7461 6c5f    primal, total_
-00019390: 7765 6967 6874 203d 205f 6e6c 6c5f 6c6f  weight = _nll_lo
-000193a0: 7373 5f68 656c 7065 7228 0a20 2020 2020  ss_helper(.     
-000193b0: 2020 2069 6e70 7574 2c0a 2020 2020 2020     input,.      
-000193c0: 2020 7461 7267 6574 2c0a 2020 2020 2020    target,.      
-000193d0: 2020 7765 6967 6874 2c0a 2020 2020 2020    weight,.      
-000193e0: 2020 6967 6e6f 7265 5f69 6e64 6578 2c0a    ignore_index,.
-000193f0: 2020 2020 2020 2020 7265 6475 6374 696f          reductio
-00019400: 6e2c 0a20 2020 2029 0a20 2020 2072 6573  n,.    ).    res
-00019410: 6964 7561 6c73 203d 2028 696e 7075 742c  iduals = (input,
-00019420: 2074 6172 6765 742c 2077 6569 6768 742c   target, weight,
-00019430: 2072 6564 7563 7469 6f6e 2c20 6967 6e6f   reduction, igno
-00019440: 7265 5f69 6e64 6578 2c20 746f 7461 6c5f  re_index, total_
-00019450: 7765 6967 6874 290a 2020 2020 7265 7475  weight).    retu
-00019460: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00019470: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00019480: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00019490: 7264 2822 746f 7263 682e 6e6e 2e66 756e  rd("torch.nn.fun
-000194a0: 6374 696f 6e61 6c2e 6e6c 6c5f 6c6f 7373  ctional.nll_loss
-000194b0: 2229 0a64 6566 206e 6c6c 5f6c 6f73 735f  ").def nll_loss_
-000194c0: 6261 636b 7761 7264 2869 6e70 7574 2c20  backward(input, 
-000194d0: 7461 7267 6574 2c20 7765 6967 6874 2c20  target, weight, 
-000194e0: 7265 6475 6374 696f 6e2c 2069 676e 6f72  reduction, ignor
-000194f0: 655f 696e 6465 782c 2074 6f74 616c 5f77  e_index, total_w
-00019500: 6569 6768 742c 2067 293a 0a20 2020 2066  eight, g):.    f
-00019510: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-00019520: 6820 696d 706f 7274 206e 6c6c 5f6c 6f73  h import nll_los
-00019530: 735f 6261 636b 7761 7264 0a0a 2020 2020  s_backward..    
-00019540: 6769 6e70 7574 203d 206e 6c6c 5f6c 6f73  ginput = nll_los
-00019550: 735f 6261 636b 7761 7264 2867 2c20 696e  s_backward(g, in
-00019560: 7075 742c 2074 6172 6765 742c 2077 6569  put, target, wei
-00019570: 6768 742c 2072 6564 7563 7469 6f6e 2c20  ght, reduction, 
-00019580: 6967 6e6f 7265 5f69 6e64 6578 2c20 746f  ignore_index, to
-00019590: 7461 6c5f 7765 6967 6874 290a 2020 2020  tal_weight).    
-000195a0: 7265 7475 726e 2067 696e 7075 742c 202a  return ginput, *
-000195b0: 2828 4e6f 6e65 2c29 202a 2034 290a 0a0a  ((None,) * 4)...
-000195c0: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-000195d0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-000195e0: 6368 2e73 706c 6974 2229 0a64 6566 2073  ch.split").def s
-000195f0: 706c 6974 5f61 7567 5f66 7764 2861 3a20  plit_aug_fwd(a: 
-00019600: 5465 6e73 6f72 5072 6f78 792c 2073 706c  TensorProxy, spl
-00019610: 6974 5f73 697a 655f 6f72 5f73 6563 7469  it_size_or_secti
-00019620: 6f6e 733a 2069 6e74 207c 2053 6571 7565  ons: int | Seque
-00019630: 6e63 655b 696e 745d 2c20 6469 6d3a 2069  nce[int], dim: i
-00019640: 6e74 203d 2030 2920 2d3e 2056 4a50 4475  nt = 0) -> VJPDu
-00019650: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
-00019660: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-00019670: 7420 7370 6c69 740a 0a20 2020 2070 7269  t split..    pri
-00019680: 6d61 6c20 3d20 7370 6c69 7428 612c 2073  mal = split(a, s
-00019690: 706c 6974 5f73 697a 655f 6f72 5f73 6563  plit_size_or_sec
-000196a0: 7469 6f6e 732c 2064 696d 290a 2020 2020  tions, dim).    
-000196b0: 7265 7369 6475 616c 7320 3d20 2864 696d  residuals = (dim
-000196c0: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
-000196d0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-000196e0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-000196f0: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-00019700: 6f72 6368 2e73 706c 6974 2229 0a64 6566  orch.split").def
-00019710: 2073 706c 6974 5f62 6163 6b77 6172 6428   split_backward(
-00019720: 6469 6d2c 202a 6772 6164 7329 3a0a 2020  dim, *grads):.  
-00019730: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00019740: 6f72 6368 2069 6d70 6f72 7420 6361 740a  orch import cat.
-00019750: 0a20 2020 2072 6574 7572 6e20 6361 7428  .    return cat(
-00019760: 6772 6164 732c 2064 696d 290a 0a0a 4072  grads, dim)...@r
-00019770: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00019780: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
-00019790: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e65  .nn.functional.e
-000197a0: 6d62 6564 6469 6e67 2229 0a64 6566 2065  mbedding").def e
-000197b0: 6d62 6564 6469 6e67 5f61 7567 5f66 7764  mbedding_aug_fwd
-000197c0: 280a 2020 2020 613a 2050 726f 7879 2c0a  (.    a: Proxy,.
-000197d0: 2020 2020 7765 6967 6874 3a20 5072 6f78      weight: Prox
-000197e0: 792c 0a20 2020 2070 6164 6469 6e67 5f69  y,.    padding_i
-000197f0: 6478 3a20 696e 7420 7c20 4e6f 6e65 2c0a  dx: int | None,.
-00019800: 2020 2020 6d61 785f 6e6f 726d 3a20 666c      max_norm: fl
-00019810: 6f61 7420 7c20 4e6f 6e65 2c0a 2020 2020  oat | None,.    
-00019820: 6e6f 726d 5f74 7970 653a 2066 6c6f 6174  norm_type: float
-00019830: 2c0a 2020 2020 7363 616c 655f 6772 6164  ,.    scale_grad
-00019840: 5f62 795f 6672 6571 3a20 626f 6f6c 2c0a  _by_freq: bool,.
-00019850: 2020 2020 7370 6172 7365 3a20 626f 6f6c      sparse: bool
-00019860: 2c0a 2920 2d3e 2056 4a50 4475 616c 3a0a  ,.) -> VJPDual:.
-00019870: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00019880: 2e74 6f72 6368 2069 6d70 6f72 7420 656d  .torch import em
-00019890: 6265 6464 696e 670a 0a20 2020 2070 7269  bedding..    pri
-000198a0: 6d61 6c20 3d20 656d 6265 6464 696e 6728  mal = embedding(
-000198b0: 0a20 2020 2020 2020 2061 2c0a 2020 2020  .        a,.    
-000198c0: 2020 2020 7765 6967 6874 2c0a 2020 2020      weight,.    
-000198d0: 2020 2020 7061 6464 696e 675f 6964 783d      padding_idx=
-000198e0: 7061 6464 696e 675f 6964 782c 0a20 2020  padding_idx,.   
-000198f0: 2020 2020 206d 6178 5f6e 6f72 6d3d 6d61       max_norm=ma
-00019900: 785f 6e6f 726d 2c0a 2020 2020 2020 2020  x_norm,.        
-00019910: 6e6f 726d 5f74 7970 653d 6e6f 726d 5f74  norm_type=norm_t
-00019920: 7970 652c 0a20 2020 2020 2020 2073 6361  ype,.        sca
-00019930: 6c65 5f67 7261 645f 6279 5f66 7265 713d  le_grad_by_freq=
-00019940: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-00019950: 6571 2c0a 2020 2020 2020 2020 7370 6172  eq,.        spar
-00019960: 7365 3d73 7061 7273 652c 0a20 2020 2029  se=sparse,.    )
-00019970: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-00019980: 2028 612c 2077 6569 6768 742e 7368 6170   (a, weight.shap
-00019990: 655b 305d 2c20 7061 6464 696e 675f 6964  e[0], padding_id
-000199a0: 782c 2073 6361 6c65 5f67 7261 645f 6279  x, scale_grad_by
-000199b0: 5f66 7265 712c 2073 7061 7273 6529 0a20  _freq, sparse). 
-000199c0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-000199d0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-000199e0: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
-000199f0: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
-00019a00: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e65  .nn.functional.e
-00019a10: 6d62 6564 6469 6e67 2229 0a64 6566 2065  mbedding").def e
-00019a20: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
-00019a30: 6428 612c 206e 756d 5f77 6569 6768 7473  d(a, num_weights
-00019a40: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
-00019a50: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-00019a60: 712c 2073 7061 7273 652c 2067 293a 0a20  q, sparse, g):. 
-00019a70: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-00019a80: 746f 7263 6820 696d 706f 7274 2065 6d62  torch import emb
-00019a90: 6564 6469 6e67 5f62 6163 6b77 6172 640a  edding_backward.
-00019aa0: 0a20 2020 2070 6164 6469 6e67 5f69 6478  .    padding_idx
-00019ab0: 203d 202d 3120 6966 2070 6164 6469 6e67   = -1 if padding
-00019ac0: 5f69 6478 2069 7320 4e6f 6e65 2065 6c73  _idx is None els
-00019ad0: 6520 7061 6464 696e 675f 6964 780a 2020  e padding_idx.  
-00019ae0: 2020 6777 6569 6768 7420 3d20 656d 6265    gweight = embe
-00019af0: 6464 696e 675f 6261 636b 7761 7264 2867  dding_backward(g
-00019b00: 2c20 612c 206e 756d 5f77 6569 6768 7473  , a, num_weights
-00019b10: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
-00019b20: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-00019b30: 712c 2073 7061 7273 6529 0a20 2020 2072  q, sparse).    r
-00019b40: 6574 7572 6e20 6777 6569 6768 740a 0a0a  eturn gweight...
-00019b50: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00019b60: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-00019b70: 6368 2e63 756d 7375 6d22 290a 6465 6620  ch.cumsum").def 
-00019b80: 6375 6d73 756d 5f61 7567 5f66 7764 2861  cumsum_aug_fwd(a
-00019b90: 3a20 5072 6f78 792c 2064 696d 3a20 696e  : Proxy, dim: in
-00019ba0: 742c 202a 2c20 6474 7970 653a 204e 6f6e  t, *, dtype: Non
-00019bb0: 6520 7c20 6474 7970 6573 2e64 7479 7065  e | dtypes.dtype
-00019bc0: 203d 204e 6f6e 6529 202d 3e20 564a 5044   = None) -> VJPD
-00019bd0: 7561 6c3a 0a20 2020 2066 726f 6d20 7468  ual:.    from th
-00019be0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
-00019bf0: 7274 2063 756d 7375 6d0a 0a20 2020 2070  rt cumsum..    p
-00019c00: 7269 6d61 6c20 3d20 6375 6d73 756d 2861  rimal = cumsum(a
-00019c10: 2c20 6469 6d2c 2064 7479 7065 3d64 7479  , dim, dtype=dty
-00019c20: 7065 290a 2020 2020 7265 7369 6475 616c  pe).    residual
-00019c30: 7320 3d20 280a 2020 2020 2020 2020 612e  s = (.        a.
-00019c40: 6474 7970 652c 0a20 2020 2020 2020 2064  dtype,.        d
-00019c50: 696d 2c0a 2020 2020 290a 2020 2020 7265  im,.    ).    re
-00019c60: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00019c70: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-00019c80: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00019c90: 7761 7264 2822 746f 7263 682e 6375 6d73  ward("torch.cums
-00019ca0: 756d 2229 0a64 6566 2063 756d 7375 6d5f  um").def cumsum_
-00019cb0: 6261 636b 7761 7264 2861 5f64 7479 7065  backward(a_dtype
-00019cc0: 2c20 6469 6d2c 2067 293a 0a20 2020 2067  , dim, g):.    g
-00019cd0: 203d 2067 2e74 6f28 615f 6474 7970 6529   = g.to(a_dtype)
-00019ce0: 0a20 2020 2069 6620 672e 6e75 6d65 6c28  .    if g.numel(
-00019cf0: 2920 3c3d 2031 206f 7220 672e 7368 6170  ) <= 1 or g.shap
-00019d00: 655b 6469 6d5d 203d 3d20 313a 0a20 2020  e[dim] == 1:.   
-00019d10: 2020 2020 2072 6574 7572 6e20 670a 2020       return g.  
-00019d20: 2020 7265 7475 726e 2067 2e66 6c69 7028    return g.flip(
-00019d30: 6469 6d29 2e63 756d 7375 6d28 6469 6d29  dim).cumsum(dim)
-00019d40: 2e66 6c69 7028 6469 6d29 0a0a 0a40 7265  .flip(dim)...@re
-00019d50: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-00019d60: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
-00019d70: 736f 6674 6d61 7822 290a 6465 6620 736f  softmax").def so
-00019d80: 6674 6d61 785f 6175 675f 6677 6428 613a  ftmax_aug_fwd(a:
-00019d90: 2050 726f 7879 2c20 6469 6d3a 2069 6e74   Proxy, dim: int
-00019da0: 2c20 6474 7970 653a 2064 7479 7065 732e  , dtype: dtypes.
-00019db0: 6474 7970 6520 7c20 4e6f 6e65 203d 204e  dtype | None = N
-00019dc0: 6f6e 6529 202d 3e20 564a 5044 7561 6c3a  one) -> VJPDual:
-00019dd0: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00019de0: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
-00019df0: 6f66 746d 6178 0a0a 2020 2020 7072 696d  oftmax..    prim
-00019e00: 616c 203d 2073 6f66 746d 6178 2861 2c20  al = softmax(a, 
-00019e10: 6469 6d2c 2064 7479 7065 3d64 7479 7065  dim, dtype=dtype
-00019e20: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00019e30: 3d20 2870 7269 6d61 6c2c 2064 696d 290a  = (primal, dim).
-00019e40: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00019e50: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00019e60: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00019e70: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-00019e80: 682e 736f 6674 6d61 7822 290a 6465 6620  h.softmax").def 
-00019e90: 736f 6674 6d61 785f 6261 636b 7761 7264  softmax_backward
-00019ea0: 2870 7269 6d61 6c2c 2064 696d 2c20 6729  (primal, dim, g)
-00019eb0: 3a0a 2020 2020 7265 7475 726e 2070 7269  :.    return pri
-00019ec0: 6d61 6c20 2a20 2867 202d 2028 7072 696d  mal * (g - (prim
-00019ed0: 616c 202a 2067 292e 7375 6d28 6469 6d2c  al * g).sum(dim,
-00019ee0: 206b 6565 7064 696d 3d54 7275 6529 290a   keepdim=True)).
-00019ef0: 0a0a 6465 6620 6974 6572 5f62 6f75 6e64  ..def iter_bound
-00019f00: 5f73 796d 626f 6c73 2862 6f75 6e64 5f73  _symbols(bound_s
-00019f10: 796d 626f 6c73 293a 0a20 2020 2022 2222  ymbols):.    """
-00019f20: 4974 6572 6174 6520 6f76 6572 2062 6f75  Iterate over bou
-00019f30: 6e64 2073 796d 626f 6c73 2c20 736b 6970  nd symbols, skip
-00019f40: 7069 6e67 2073 796d 626f 6c73 2074 6861  ping symbols tha
-00019f50: 7420 6172 6520 6e6f 7420 7375 7070 6f72  t are not suppor
-00019f60: 7465 6420 6279 0a20 2020 2074 6865 2074  ted by.    the t
-00019f70: 7261 6e73 666f 726d 7320 696e 6672 6173  ransforms infras
-00019f80: 7472 7563 7475 7265 2e0a 0a20 2020 2041  tructure...    A
-00019f90: 7267 733a 0a20 2020 2020 2020 2062 6f75  rgs:.        bou
-00019fa0: 6e64 5f73 796d 626f 6c73 2028 4c69 7374  nd_symbols (List
-00019fb0: 5b42 6f75 6e64 5379 6d62 6f6c 5d29 3a20  [BoundSymbol]): 
-00019fc0: 4c69 7374 206f 6620 626f 756e 6420 7379  List of bound sy
-00019fd0: 6d62 6f6c 730a 0a20 2020 2059 6965 6c64  mbols..    Yield
-00019fe0: 733a 0a20 2020 2020 2020 2042 6f75 6e64  s:.        Bound
-00019ff0: 5379 6d62 6f6c 3a20 426f 756e 6420 7379  Symbol: Bound sy
-0001a000: 6d62 6f6c 7320 7468 6174 2061 7265 2073  mbols that are s
-0001a010: 7570 706f 7274 6564 2062 7920 7468 6520  upported by the 
-0001a020: 7472 616e 7366 6f72 6d73 0a20 2020 2020  transforms.     
-0001a030: 2020 2069 6e66 7261 7374 7275 6374 7572     infrastructur
-0001a040: 650a 2020 2020 2222 220a 2020 2020 666f  e.    """.    fo
-0001a050: 7220 7379 6d62 6f6c 2069 6e20 626f 756e  r symbol in boun
-0001a060: 645f 7379 6d62 6f6c 733a 0a20 2020 2020  d_symbols:.     
-0001a070: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
-0001a080: 2e69 6420 696e 2074 7261 6e73 666f 726d  .id in transform
-0001a090: 5f73 6b69 705f 6c69 7374 3a0a 2020 2020  _skip_list:.    
-0001a0a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0001a0b0: 0a20 2020 2020 2020 2065 6c69 6620 7379  .        elif sy
-0001a0c0: 6d62 6f6c 2e6f 7574 7075 7420 6973 204e  mbol.output is N
-0001a0d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001a0e0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0001a0f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001a100: 2020 2020 7969 656c 6420 7379 6d62 6f6c      yield symbol
-0001a110: 0a0a 0a64 6566 2064 6563 6f6e 7374 7275  ...def deconstru
-0001a120: 6374 5f66 6f72 7761 7264 5f65 6e76 5f66  ct_forward_env_f
-0001a130: 6f72 5f62 6163 6b77 6172 6428 7472 6163  or_backward(trac
-0001a140: 652c 2065 6e76 293a 0a20 2020 2023 204e  e, env):.    # N
-0001a150: 6f74 6520 5b53 6176 696e 6720 7468 6520  ote [Saving the 
-0001a160: 666f 7277 6172 6420 656e 7669 726f 6e6d  forward environm
-0001a170: 656e 7420 696e 2074 6865 2062 6163 6b77  ent in the backw
-0001a180: 6172 6420 7275 6c65 5d0a 2020 2020 2320  ard rule].    # 
-0001a190: 5765 2063 616e 6e6f 7420 7361 7665 2074  We cannot save t
-0001a1a0: 6865 2074 7261 6365 206f 626a 6563 7420  he trace object 
-0001a1b0: 696e 2074 6865 2072 6573 6964 7561 6c73  in the residuals
-0001a1c0: 2062 6563 6175 7365 2065 7865 6375 746f   because executo
-0001a1d0: 7273 206d 6179 206e 6f74 0a20 2020 2023  rs may not.    #
-0001a1e0: 2062 6520 6162 6c65 2074 6f20 7265 7475   be able to retu
-0001a1f0: 726e 2069 7420 666f 7220 7468 6520 7370  rn it for the sp
-0001a200: 6c69 7474 6564 2066 6f72 7761 7264 2f62  litted forward/b
-0001a210: 6163 6b77 6172 6420 7061 7373 6573 2e20  ackward passes. 
-0001a220: 496e 7374 6561 642c 2077 650a 2020 2020  Instead, we.    
-0001a230: 2320 7361 7665 2061 7267 7320 616e 6420  # save args and 
-0001a240: 6b77 6172 6773 206f 6620 7468 6520 6f72  kwargs of the or
-0001a250: 6967 696e 616c 2066 756e 6374 696f 6e20  iginal function 
-0001a260: 6361 6c6c 2061 6e64 2072 6563 6f6e 7374  call and reconst
-0001a270: 7275 6374 2074 6865 0a20 2020 2023 2074  ruct the.    # t
-0001a280: 7261 6365 206f 626a 6563 7420 616e 6420  race object and 
-0001a290: 6974 7320 656e 7669 726f 6e6d 656e 7420  its environment 
-0001a2a0: 6469 6374 2069 6e20 7468 6520 6261 636b  dict in the back
-0001a2b0: 7761 7264 2072 756c 652e 2048 6572 6520  ward rule. Here 
-0001a2c0: 7765 2072 656c 790a 2020 2020 2320 6f6e  we rely.    # on
-0001a2d0: 2074 6865 2066 6163 7420 7468 6174 2074   the fact that t
-0001a2e0: 6865 206f 7264 6572 206f 6620 7468 6520  he order of the 
-0001a2f0: 7379 6d62 6f6c 7320 696e 2074 6865 2074  symbols in the t
-0001a300: 7261 6365 2069 7320 6465 7465 726d 696e  race is determin
-0001a310: 6973 7469 630a 2020 2020 2320 616e 6420  istic.    # and 
-0001a320: 616c 7761 7973 2074 6865 2073 616d 6520  always the same 
-0001a330: 666f 7220 7468 6520 7361 6d65 2066 756e  for the same fun
-0001a340: 6374 696f 6e20 6361 6c6c 2061 6e64 2074  ction call and t
-0001a350: 6865 2073 616d 6520 7365 7420 6f66 0a20  he same set of. 
-0001a360: 2020 2023 2061 7267 756d 656e 7473 2e20     # arguments. 
-0001a370: 5365 6520 7465 7374 5f67 7261 642e 7079  See test_grad.py
-0001a380: 3a74 6573 745f 746f 7263 685f 6175 746f  :test_torch_auto
-0001a390: 6772 6164 5f66 756e 6374 696f 6e20 666f  grad_function fo
-0001a3a0: 7220 616e 2065 7861 6d70 6c65 0a20 2020  r an example.   
-0001a3b0: 2023 2077 6865 7265 2074 6869 7320 6973   # where this is
-0001a3c0: 2074 6573 7465 642e 0a20 2020 2062 6f75   tested..    bou
-0001a3d0: 6e64 5f73 796d 626f 6c73 203d 2069 7465  nd_symbols = ite
-0001a3e0: 725f 626f 756e 645f 7379 6d62 6f6c 7328  r_bound_symbols(
-0001a3f0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001a400: 6f6c 7329 0a20 2020 2073 6176 6564 5f66  ols).    saved_f
-0001a410: 6f72 5f62 6163 6b77 6172 6420 3d20 7475  or_backward = tu
-0001a420: 706c 6528 656e 765b 7365 7175 656e 6369  ple(env[sequenci
-0001a430: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
-0001a440: 295b 305d 2e6e 616d 655d 2e72 6573 6964  )[0].name].resid
-0001a450: 7561 6c73 2066 6f72 2073 796d 626f 6c20  uals for symbol 
-0001a460: 696e 2062 6f75 6e64 5f73 796d 626f 6c73  in bound_symbols
-0001a470: 290a 2020 2020 7265 7475 726e 2073 6176  ).    return sav
-0001a480: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
-0001a490: 0a0a 6465 6620 7265 636f 6e73 7472 7563  ..def reconstruc
-0001a4a0: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-0001a4b0: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-0001a4c0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-0001a4d0: 7761 7264 293a 0a20 2020 2062 6f75 6e64  ward):.    bound
-0001a4e0: 5f73 796d 626f 6c73 203d 2069 7465 725f  _symbols = iter_
-0001a4f0: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
-0001a500: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001a510: 7329 0a0a 2020 2020 7265 636f 6e73 7472  s)..    reconstr
-0001a520: 7563 7465 645f 656e 7620 3d20 7b7d 0a0a  ucted_env = {}..
-0001a530: 2020 2020 666f 7220 6964 782c 2073 796d      for idx, sym
-0001a540: 2069 6e20 656e 756d 6572 6174 6528 626f   in enumerate(bo
-0001a550: 756e 645f 7379 6d62 6f6c 7329 3a0a 2020  und_symbols):.  
-0001a560: 2020 2020 2020 6b20 3d20 7365 7175 656e        k = sequen
-0001a570: 6369 6679 2873 796d 2e6f 7574 7075 7429  cify(sym.output)
-0001a580: 5b30 5d2e 6e61 6d65 0a20 2020 2020 2020  [0].name.       
-0001a590: 2076 203d 2056 4a50 4475 616c 284e 6f6e   v = VJPDual(Non
-0001a5a0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001a5b0: 6b77 6172 645b 6964 785d 290a 2020 2020  kward[idx]).    
-0001a5c0: 2020 2020 7265 636f 6e73 7472 7563 7465      reconstructe
-0001a5d0: 645f 656e 765b 6b5d 203d 2076 0a0a 2020  d_env[k] = v..  
-0001a5e0: 2020 7265 7475 726e 2072 6563 6f6e 7374    return reconst
-0001a5f0: 7275 6374 6564 5f65 6e76 0a0a 0a64 6566  ructed_env...def
-0001a600: 2064 6563 6f6d 706f 7365 645f 666e 5f61   decomposed_fn_a
-0001a610: 7567 5f66 7764 5f72 756c 6528 2a61 7267  ug_fwd_rule(*arg
-0001a620: 732c 2064 6563 6f6d 706f 7365 645f 666e  s, decomposed_fn
-0001a630: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001a640: 2022 2222 4175 676d 656e 7465 6420 666f   """Augmented fo
-0001a650: 7277 6172 6420 7275 6c65 2066 6f72 2063  rward rule for c
-0001a660: 6f6d 706f 7369 7465 2066 756e 6374 696f  omposite functio
-0001a670: 6e73 2069 6d70 6c65 6d65 6e74 6564 2069  ns implemented i
-0001a680: 6e20 7465 726d 7320 6f66 206f 7468 6572  n terms of other
-0001a690: 2066 756e 6374 696f 6e73 2074 6861 7420   functions that 
-0001a6a0: 6172 650a 2020 2020 7375 7070 6f73 6564  are.    supposed
-0001a6b0: 2074 6f20 6265 2073 7570 706f 7274 6564   to be supported
-0001a6c0: 2062 7920 7468 6520 564a 5020 696e 6672   by the VJP infr
-0001a6d0: 6173 7472 7563 7475 7265 2e0a 0a20 2020  astructure...   
-0001a6e0: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
-0001a6f0: 6563 6f6d 706f 7365 645f 666e 2028 4361  ecomposed_fn (Ca
-0001a700: 6c6c 6162 6c65 293a 2064 6563 6f6d 706f  llable): decompo
-0001a710: 7365 6420 7665 7273 696f 6e20 6f66 2074  sed version of t
-0001a720: 6865 2066 756e 6374 696f 6e0a 0a20 2020  he function..   
-0001a730: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001a740: 2020 4361 6c6c 6162 6c65 3a20 4175 676d    Callable: Augm
-0001a750: 656e 7465 6420 666f 7277 6172 6420 7275  ented forward ru
-0001a760: 6c65 2066 6f72 2074 6865 2063 6f6d 706f  le for the compo
-0001a770: 7369 7465 2066 756e 6374 696f 6e0a 2020  site function.  
-0001a780: 2020 2222 220a 2020 2020 7472 6163 6520    """.    trace 
-0001a790: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0001a7a0: 6528 2928 6465 636f 6d70 6f73 6564 5f66  e()(decomposed_f
-0001a7b0: 6e2c 202a 6172 6773 2c20 2a2a 6b77 6172  n, *args, **kwar
-0001a7c0: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
-0001a7d0: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
-0001a7e0: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
-0001a7f0: 7261 6365 290a 2020 2020 2320 5468 6572  race).    # Ther
-0001a800: 6520 6d61 7920 6265 2061 2064 6561 6420  e may be a dead 
-0001a810: 6e6f 6465 206c 696b 6520 225f 203d 2070  node like "_ = p
-0001a820: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
-0001a830: 6d65 6e74 5f74 7970 6528 302c 2066 6c6f  ment_type(0, flo
-0001a840: 6174 2922 0a20 2020 2023 2069 6e20 7468  at)".    # in th
-0001a850: 6520 7472 6163 652e 2057 6520 6e65 6564  e trace. We need
-0001a860: 2074 6f20 7265 6d6f 7665 2069 7420 6265   to remove it be
-0001a870: 666f 7265 2077 6520 6361 6e20 7573 6520  fore we can use 
-0001a880: 7468 6520 7472 6163 6520 666f 720a 2020  the trace for.  
-0001a890: 2020 2320 6175 676d 656e 7465 645f 666f    # augmented_fo
-0001a8a0: 7277 6172 645f 7061 7373 2e0a 2020 2020  rward_pass..    
-0001a8b0: 7472 6163 6520 3d20 6463 6528 7472 6163  trace = dce(trac
-0001a8c0: 6529 0a20 2020 2072 6573 756c 742c 2065  e).    result, e
-0001a8d0: 6e76 203d 2061 7567 6d65 6e74 6564 5f66  nv = augmented_f
-0001a8e0: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
-0001a8f0: 732c 2074 7261 6365 3d74 7261 6365 2c20  s, trace=trace, 
-0001a900: 2a2a 6b77 6172 6773 290a 2020 2020 7361  **kwargs).    sa
-0001a910: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001a920: 203d 2064 6563 6f6e 7374 7275 6374 5f66   = deconstruct_f
-0001a930: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-0001a940: 6163 6b77 6172 6428 7472 6163 652c 2065  ackward(trace, e
-0001a950: 6e76 290a 2020 2020 2320 5374 6174 6963  nv).    # Static
-0001a960: 2063 6163 6869 6e67 2064 6f65 7320 6e6f   caching does no
-0001a970: 7420 7769 7468 2077 6974 6820 6b77 6172  t with with kwar
-0001a980: 6773 2064 6963 7473 2c20 736f 2077 6527  gs dicts, so we'
-0001a990: 7265 2063 6f6e 7665 7274 696e 6720 7468  re converting th
-0001a9a0: 656d 0a20 2020 2023 2074 6f20 4e6f 6e65  em.    # to None
-0001a9b0: 2066 6f72 206e 6f77 2077 6865 6e20 706f   for now when po
-0001a9c0: 7373 6962 6c65 2e0a 2020 2020 6b77 6172  ssible..    kwar
-0001a9d0: 6773 203d 204e 6f6e 6520 6966 206e 6f74  gs = None if not
-0001a9e0: 206b 7761 7267 7320 656c 7365 206b 7761   kwargs else kwa
-0001a9f0: 7267 730a 2020 2020 7265 7369 6475 616c  rgs.    residual
-0001aa00: 7320 3d20 2861 7267 732c 206b 7761 7267  s = (args, kwarg
-0001aa10: 732c 2073 6176 6564 5f66 6f72 5f62 6163  s, saved_for_bac
-0001aa20: 6b77 6172 6429 0a20 2020 2072 6574 7572  kward).    retur
-0001aa30: 6e20 564a 5044 7561 6c28 7265 7375 6c74  n VJPDual(result
-0001aa40: 2c20 7265 7369 6475 616c 7329 0a0a 0a64  , residuals)...d
-0001aa50: 6566 2064 6563 6f6d 706f 7365 645f 666e  ef decomposed_fn
-0001aa60: 5f62 6163 6b77 6172 645f 7275 6c65 2864  _backward_rule(d
-0001aa70: 6563 6f6d 706f 7365 645f 666e 2c20 6172  ecomposed_fn, ar
-0001aa80: 6773 2c20 6b77 6172 6773 2c20 7361 7665  gs, kwargs, save
-0001aa90: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-0001aaa0: 2a67 7261 6473 293a 0a20 2020 206b 7761  *grads):.    kwa
-0001aab0: 7267 7320 3d20 7b7d 2069 6620 6b77 6172  rgs = {} if kwar
-0001aac0: 6773 2069 7320 4e6f 6e65 2065 6c73 6520  gs is None else 
-0001aad0: 6b77 6172 6773 0a20 2020 2074 7261 6365  kwargs.    trace
-0001aae0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-0001aaf0: 6365 2829 2864 6563 6f6d 706f 7365 645f  ce()(decomposed_
-0001ab00: 666e 2c20 2a61 7267 732c 202a 2a6b 7761  fn, *args, **kwa
-0001ab10: 7267 7329 0a20 2020 2074 7261 6365 203d  rgs).    trace =
-0001ab20: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
-0001ab30: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
-0001ab40: 7472 6163 6529 0a20 2020 2074 7261 6365  trace).    trace
-0001ab50: 203d 2064 6365 2874 7261 6365 290a 2020   = dce(trace).  
-0001ab60: 2020 2320 626f 756e 645f 7379 6d62 6f6c    # bound_symbol
-0001ab70: 7320 3d20 6974 6572 5f62 6f75 6e64 5f73  s = iter_bound_s
-0001ab80: 796d 626f 6c73 2874 7261 6365 2e62 6f75  ymbols(trace.bou
-0001ab90: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
-0001aba0: 2320 7265 636f 6e73 7472 7563 7465 645f  # reconstructed_
-0001abb0: 656e 7620 3d20 7b0a 2020 2020 2320 2020  env = {.    #   
-0001abc0: 2020 7365 7175 656e 6369 6679 2873 796d    sequencify(sym
-0001abd0: 626f 6c2e 6f75 7470 7574 295b 305d 2e6e  bol.output)[0].n
-0001abe0: 616d 653a 2056 4a50 4475 616c 284e 6f6e  ame: VJPDual(Non
-0001abf0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001ac00: 6b77 6172 645b 695d 290a 2020 2020 2320  kward[i]).    # 
-0001ac10: 2020 2020 666f 7220 692c 2073 796d 626f      for i, symbo
-0001ac20: 6c20 696e 2065 6e75 6d65 7261 7465 2862  l in enumerate(b
-0001ac30: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0001ac40: 2020 2320 7d0a 2020 2020 7265 636f 6e73    # }.    recons
-0001ac50: 7472 7563 7465 645f 656e 7620 3d20 7265  tructed_env = re
-0001ac60: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
-0001ac70: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
-0001ac80: 7264 2874 7261 6365 2c20 7361 7665 645f  rd(trace, saved_
-0001ac90: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001aca0: 2020 7265 7375 6c74 203d 2062 6163 6b77    result = backw
-0001acb0: 6172 645f 7061 7373 2872 6563 6f6e 7374  ard_pass(reconst
-0001acc0: 7275 6374 6564 5f65 6e76 2c20 7472 6163  ructed_env, trac
-0001acd0: 652c 2067 7261 6473 290a 2020 2020 6966  e, grads).    if
-0001ace0: 206c 656e 2861 7267 7329 203d 3d20 313a   len(args) == 1:
-0001acf0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001ad00: 7265 7375 6c74 5b30 5d0a 2020 2020 2320  result[0].    # 
-0001ad10: 4261 636b 7761 7264 2070 6173 7320 6d69  Backward pass mi
-0001ad20: 6768 7420 7265 7475 726e 2061 2064 6963  ght return a dic
-0001ad30: 7420 7769 7468 2067 7261 6473 2062 7574  t with grads but
-0001ad40: 2063 7572 7265 6e74 2069 6e74 6572 6661   current interfa
-0001ad50: 6365 206f 660a 2020 2020 2320 6261 636b  ce of.    # back
-0001ad60: 7761 7264 2072 756c 6520 646f 6573 206e  ward rule does n
-0001ad70: 6f74 2073 7570 706f 7274 2069 742e 2053  ot support it. S
-0001ad80: 6f20 7765 206a 7573 7420 6472 6f70 2069  o we just drop i
-0001ad90: 7420 666f 7220 6e6f 772e 0a20 2020 2065  t for now..    e
-0001ada0: 6c69 6620 6973 696e 7374 616e 6365 2872  lif isinstance(r
-0001adb0: 6573 756c 745b 2d31 5d2c 2064 6963 7429  esult[-1], dict)
-0001adc0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001add0: 2072 6573 756c 745b 3a2d 315d 0a20 2020   result[:-1].   
-0001ade0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-0001adf0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-0001ae00: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
-0001ae10: 7263 682e 5465 6e73 6f72 2e63 6f6e 7469  rch.Tensor.conti
-0001ae20: 6775 6f75 7322 290a 4072 6567 6973 7465  guous").@registe
-0001ae30: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-0001ae40: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
-0001ae50: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
-0001ae60: 6967 756f 7573 5f61 7567 5f66 7764 2878  iguous_aug_fwd(x
-0001ae70: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
-0001ae80: 2c20 2a2c 206d 656d 6f72 795f 666f 726d  , *, memory_form
-0001ae90: 6174 3a20 746f 7263 682e 6d65 6d6f 7279  at: torch.memory
-0001aea0: 5f66 6f72 6d61 7420 3d20 746f 7263 682e  _format = torch.
-0001aeb0: 636f 6e74 6967 756f 7573 5f66 6f72 6d61  contiguous_forma
-0001aec0: 7429 202d 3e20 564a 5044 7561 6c3a 0a20  t) -> VJPDual:. 
-0001aed0: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-0001aee0: 746f 7263 6820 696d 706f 7274 2063 6f6e  torch import con
-0001aef0: 7469 6775 6f75 730a 0a20 2020 2072 6574  tiguous..    ret
-0001af00: 7572 6e20 564a 5044 7561 6c28 636f 6e74  urn VJPDual(cont
-0001af10: 6967 756f 7573 2878 2c20 6d65 6d6f 7279  iguous(x, memory
-0001af20: 5f66 6f72 6d61 743d 6d65 6d6f 7279 5f66  _format=memory_f
-0001af30: 6f72 6d61 7429 2c20 7475 706c 6528 2929  ormat), tuple())
-0001af40: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-0001af50: 6b77 6172 6428 2274 6f72 6368 2e54 656e  kward("torch.Ten
-0001af60: 736f 722e 636f 6e74 6967 756f 7573 2229  sor.contiguous")
-0001af70: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-0001af80: 6172 6428 2274 6f72 6368 2e63 6f6e 7469  ard("torch.conti
-0001af90: 6775 6f75 7322 290a 6465 6620 636f 6e74  guous").def cont
-0001afa0: 6967 756f 7573 5f62 6163 6b77 6172 6428  iguous_backward(
-0001afb0: 2a72 6573 6964 7561 6c73 5f61 6e64 5f67  *residuals_and_g
-0001afc0: 7261 6429 202d 3e20 5465 6e73 6f72 5072  rad) -> TensorPr
-0001afd0: 6f78 793a 0a20 2020 2023 2052 6573 6964  oxy:.    # Resid
-0001afe0: 7561 6c73 2069 7320 6e6f 7420 656d 7074  uals is not empt
-0001aff0: 7920 6265 6361 7573 6520 636f 6e74 6967  y because contig
-0001b000: 756f 7573 2073 796d 626f 6c20 6861 7320  uous symbol has 
-0001b010: 7468 6520 7361 6d65 206f 7574 7075 7420  the same output 
-0001b020: 6173 2069 7473 2069 6e70 7574 0a20 2020  as its input.   
-0001b030: 2067 203d 2072 6573 6964 7561 6c73 5f61   g = residuals_a
-0001b040: 6e64 5f67 7261 645b 2d31 5d0a 2020 2020  nd_grad[-1].    
-0001b050: 7265 7475 726e 2067 0a0a 0a64 6566 2072  return g...def r
-0001b060: 6563 6970 726f 6361 6c5f 6175 675f 6677  eciprocal_aug_fw
-0001b070: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
-0001b080: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
-0001b090: 2020 7072 696d 616c 203d 2072 6563 6970    primal = recip
-0001b0a0: 726f 6361 6c28 6129 0a20 2020 2072 6574  rocal(a).    ret
-0001b0b0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-0001b0c0: 616c 2c20 2870 7269 6d61 6c2c 2929 0a0a  al, (primal,))..
-0001b0d0: 0a64 6566 2072 6563 6970 726f 6361 6c5f  .def reciprocal_
-0001b0e0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-0001b0f0: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
-0001b100: 2d67 202a 2070 7269 6d61 6c20 2a20 7072  -g * primal * pr
-0001b110: 696d 616c 0a0a 0a40 7061 7274 6961 6c28  imal...@partial(
-0001b120: 7265 6769 7374 6572 5f67 7261 642c 2070  register_grad, p
-0001b130: 7269 6d73 2e50 7269 6d49 4473 2e52 4543  rims.PrimIDs.REC
-0001b140: 4950 524f 4341 4c29 0a64 6566 2072 6563  IPROCAL).def rec
-0001b150: 6970 726f 6361 6c5f 6a6f 696e 745f 666f  iprocal_joint_fo
-0001b160: 7277 6172 645f 6261 636b 7761 7264 5f72  rward_backward_r
-0001b170: 756c 6528 613a 2054 656e 736f 7250 726f  ule(a: TensorPro
-0001b180: 7879 2920 2d3e 2054 656e 736f 7250 726f  xy) -> TensorPro
-0001b190: 7879 3a0a 2020 2020 7265 7375 6c74 2c20  xy:.    result, 
-0001b1a0: 7361 7665 6420 3d20 7265 6369 7072 6f63  saved = reciproc
-0001b1b0: 616c 5f61 7567 5f66 7764 2861 290a 2020  al_aug_fwd(a).  
-0001b1c0: 2020 6720 3d20 6765 745f 6772 6164 2872    g = get_grad(r
-0001b1d0: 6573 756c 7429 0a20 2020 2067 6120 3d20  esult).    ga = 
-0001b1e0: 7265 6369 7072 6f63 616c 5f62 6163 6b77  reciprocal_backw
-0001b1f0: 6172 6428 2a73 6176 6564 2c20 6729 0a20  ard(*saved, g). 
-0001b200: 2020 2070 7574 5f67 7261 6428 612c 2067     put_grad(a, g
-0001b210: 6129 0a20 2020 2072 6574 7572 6e20 7265  a).    return re
-0001b220: 7375 6c74 0a0a 0a40 7265 6769 7374 6572  sult...@register
-0001b230: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-0001b240: 7264 2822 746f 7263 682e 696e 6465 785f  rd("torch.index_
-0001b250: 7075 7422 290a 6465 6620 696e 6465 785f  put").def index_
-0001b260: 7075 745f 6175 675f 6677 6428 0a20 2020  put_aug_fwd(.   
-0001b270: 2061 3a20 5465 6e73 6f72 5072 6f78 792c   a: TensorProxy,
-0001b280: 202f 2c20 696e 6469 6365 733a 2053 6571   /, indices: Seq
-0001b290: 7565 6e63 655b 5465 6e73 6f72 5072 6f78  uence[TensorProx
-0001b2a0: 795d 2c20 7661 6c75 6573 3a20 5465 6e73  y], values: Tens
-0001b2b0: 6f72 5072 6f78 792c 2061 6363 756d 756c  orProxy, accumul
-0001b2c0: 6174 653a 2062 6f6f 6c20 3d20 4661 6c73  ate: bool = Fals
-0001b2d0: 650a 2920 2d3e 2056 4a50 4475 616c 3a0a  e.) -> VJPDual:.
-0001b2e0: 2020 2020 7072 696d 616c 203d 2063 6c61      primal = cla
-0001b2f0: 6e67 2e69 6e64 6578 5f70 7574 2861 2c20  ng.index_put(a, 
-0001b300: 696e 6469 6365 732c 2076 616c 7565 732c  indices, values,
-0001b310: 2061 6363 756d 756c 6174 6529 0a20 2020   accumulate).   
-0001b320: 2072 6573 6964 7561 6c73 203d 2028 0a20   residuals = (. 
-0001b330: 2020 2020 2020 2069 6e64 6963 6573 2c0a         indices,.
-0001b340: 2020 2020 2020 2020 7661 6c75 6573 2c0a          values,.
-0001b350: 2020 2020 2020 2020 6163 6375 6d75 6c61          accumula
-0001b360: 7465 2c0a 2020 2020 290a 2020 2020 7265  te,.    ).    re
-0001b370: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-0001b380: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-0001b390: 0a0a 6465 6620 7375 6d5f 746f 2861 3a20  ..def sum_to(a: 
-0001b3a0: 5465 6e73 6f72 5072 6f78 792c 2073 6861  TensorProxy, sha
-0001b3b0: 7065 3a20 5365 7175 656e 6365 5b69 6e74  pe: Sequence[int
-0001b3c0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
-0001b3d0: 793a 0a20 2020 2069 6620 6e6f 7420 7368  y:.    if not sh
-0001b3e0: 6170 653a 0a20 2020 2020 2020 2072 6574  ape:.        ret
-0001b3f0: 7572 6e20 612e 7375 6d28 290a 2020 2020  urn a.sum().    
-0001b400: 6c65 6164 696e 675f 6469 6d73 203d 2061  leading_dims = a
-0001b410: 2e6e 6469 6d20 2d20 6c65 6e28 7368 6170  .ndim - len(shap
-0001b420: 6529 0a20 2020 2072 6564 7563 655f 6469  e).    reduce_di
-0001b430: 6d73 203d 2074 7570 6c65 2872 616e 6765  ms = tuple(range
-0001b440: 286c 6561 6469 6e67 5f64 696d 7329 2920  (leading_dims)) 
-0001b450: 2b20 7475 706c 6528 0a20 2020 2020 2020  + tuple(.       
-0001b460: 2069 2066 6f72 2069 2069 6e20 7261 6e67   i for i in rang
-0001b470: 6528 6c65 6164 696e 675f 6469 6d73 2c20  e(leading_dims, 
-0001b480: 612e 6e64 696d 2920 6966 2073 6861 7065  a.ndim) if shape
-0001b490: 5b69 202d 206c 6561 6469 6e67 5f64 696d  [i - leading_dim
-0001b4a0: 735d 203d 3d20 3120 616e 6420 612e 7368  s] == 1 and a.sh
-0001b4b0: 6170 655b 695d 2021 3d20 310a 2020 2020  ape[i] != 1.    
-0001b4c0: 290a 2020 2020 6120 3d20 6c74 6f72 6368  ).    a = ltorch
-0001b4d0: 2e73 756d 2861 2c20 6469 6d3d 7265 6475  .sum(a, dim=redu
-0001b4e0: 6365 5f64 696d 732c 206b 6565 7064 696d  ce_dims, keepdim
-0001b4f0: 3d54 7275 6529 0a20 2020 2069 6620 6c65  =True).    if le
-0001b500: 6164 696e 675f 6469 6d73 203e 2030 3a0a  ading_dims > 0:.
-0001b510: 2020 2020 2020 2020 7265 7475 726e 206c          return l
-0001b520: 746f 7263 682e 7669 6577 2861 2c20 7368  torch.view(a, sh
-0001b530: 6170 6529 0a20 2020 2072 6574 7572 6e20  ape).    return 
-0001b540: 610a 0a0a 4072 6567 6973 7465 725f 6261  a...@register_ba
-0001b550: 636b 7761 7264 2822 746f 7263 682e 696e  ckward("torch.in
-0001b560: 6465 785f 7075 7422 290a 6465 6620 696e  dex_put").def in
-0001b570: 6465 785f 7075 745f 6261 636b 7761 7264  dex_put_backward
-0001b580: 2869 6e64 6963 6573 3a20 5365 7175 656e  (indices: Sequen
-0001b590: 6365 5b54 656e 736f 7250 726f 7879 5d2c  ce[TensorProxy],
-0001b5a0: 2076 616c 7565 733a 2054 656e 736f 7250   values: TensorP
-0001b5b0: 726f 7879 2c20 6163 6375 6d75 6c61 7465  roxy, accumulate
-0001b5c0: 3a20 626f 6f6c 2c20 673a 2054 656e 736f  : bool, g: Tenso
-0001b5d0: 7250 726f 7879 293a 0a20 2020 2067 5f76  rProxy):.    g_v
-0001b5e0: 616c 7565 7320 3d20 675b 696e 6469 6365  alues = g[indice
-0001b5f0: 735d 0a20 2020 2023 2074 6f72 6368 2068  s].    # torch h
-0001b600: 6173 2065 7874 7261 206c 6f67 6963 2074  as extra logic t
-0001b610: 6f20 6861 6e64 6c65 2074 6865 2065 7870  o handle the exp
-0001b620: 616e 6465 6420 7661 6c75 6573 0a20 2020  anded values.   
-0001b630: 2069 6620 6e6f 7420 7574 696c 732e 7361   if not utils.sa
-0001b640: 6d65 5f73 6861 7065 2867 5f76 616c 7565  me_shape(g_value
-0001b650: 732e 7368 6170 652c 2076 616c 7565 732e  s.shape, values.
-0001b660: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-0001b670: 6966 2063 6c61 6e67 2e63 6f6d 7075 7465  if clang.compute
-0001b680: 5f62 726f 6164 6361 7374 5f73 6861 7065  _broadcast_shape
-0001b690: 2867 5f76 616c 7565 732e 7368 6170 652c  (g_values.shape,
-0001b6a0: 2076 616c 7565 732e 7368 6170 6529 3a0a   values.shape):.
-0001b6b0: 2020 2020 2020 2020 2020 2020 675f 7661              g_va
-0001b6c0: 6c75 6573 203d 2073 756d 5f74 6f28 675f  lues = sum_to(g_
-0001b6d0: 7661 6c75 6573 2c20 7661 6c75 6573 2e73  values, values.s
-0001b6e0: 6861 7065 290a 2020 2020 6966 2061 6363  hape).    if acc
-0001b6f0: 756d 756c 6174 653a 0a20 2020 2020 2020  umulate:.       
-0001b700: 2072 6574 7572 6e20 672c 2067 5f76 616c   return g, g_val
-0001b710: 7565 730a 2020 2020 7265 7475 726e 2063  ues.    return c
-0001b720: 6c61 6e67 2e69 6e64 6578 5f70 7574 2867  lang.index_put(g
-0001b730: 2c20 696e 6469 6365 732c 206c 746f 7263  , indices, ltorc
-0001b740: 682e 7a65 726f 735f 6c69 6b65 2876 616c  h.zeros_like(val
-0001b750: 7565 7329 2c20 4661 6c73 6529 2c20 675f  ues), False), g_
-0001b760: 7661 6c75 6573 0a0a 0a64 6566 2075 6e69  values...def uni
-0001b770: 666f 726d 5f61 7567 5f66 7764 2873 6861  form_aug_fwd(sha
-0001b780: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
-0001b790: 616c 2c20 2a2c 2064 6576 6963 652c 2064  al, *, device, d
-0001b7a0: 7479 7065 293a 0a20 2020 2070 7269 6d61  type):.    prima
-0001b7b0: 6c20 3d20 7072 696d 732e 756e 6966 6f72  l = prims.unifor
-0001b7c0: 6d28 7368 6170 652c 206d 696e 7661 6c2c  m(shape, minval,
-0001b7d0: 206d 6178 7661 6c2c 2064 6576 6963 653d   maxval, device=
-0001b7e0: 6465 7669 6365 2c20 6474 7970 653d 6474  device, dtype=dt
-0001b7f0: 7970 6529 0a20 2020 2072 6574 7572 6e20  ype).    return 
-0001b800: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-0001b810: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
-0001b820: 206d 6178 7661 6c29 290a 0a0a 6465 6620   maxval))...def 
-0001b830: 756e 6966 6f72 6d5f 6261 636b 7761 7264  uniform_backward
-0001b840: 2870 7269 6d61 6c2c 206d 696e 7661 6c2c  (primal, minval,
-0001b850: 206d 6178 7661 6c2c 2067 293a 0a20 2020   maxval, g):.   
-0001b860: 2023 2075 6e69 666f 726d 2069 7320 696d   # uniform is im
-0001b870: 706c 656d 656e 7465 6420 6173 2028 6d61  plemented as (ma
-0001b880: 7876 616c 202d 206d 696e 7661 6c29 202a  xval - minval) *
-0001b890: 2075 6e69 666f 726d 2873 6861 7065 2c20   uniform(shape, 
-0001b8a0: 302c 2031 2920 2b20 6d69 6e76 616c 0a20  0, 1) + minval. 
-0001b8b0: 2020 2075 6e73 6361 6c65 645f 7072 696d     unscaled_prim
-0001b8c0: 616c 203d 2028 7072 696d 616c 202d 206d  al = (primal - m
-0001b8d0: 696e 7661 6c29 202f 2028 6d61 7876 616c  inval) / (maxval
-0001b8e0: 202d 206d 696e 7661 6c29 0a20 2020 2072   - minval).    r
-0001b8f0: 6564 7563 655f 616c 6c5f 6469 6d73 203d  educe_all_dims =
-0001b900: 2074 7570 6c65 2872 616e 6765 2867 2e6e   tuple(range(g.n
-0001b910: 6469 6d29 290a 2020 2020 7375 6d20 3d20  dim)).    sum = 
-0001b920: 7061 7274 6961 6c28 7072 696d 732e 7375  partial(prims.su
-0001b930: 6d2c 2064 696d 733d 7265 6475 6365 5f61  m, dims=reduce_a
-0001b940: 6c6c 5f64 696d 7329 0a20 2020 2072 6574  ll_dims).    ret
-0001b950: 7572 6e20 4e6f 6e65 2c20 7375 6d28 6720  urn None, sum(g 
-0001b960: 2a20 2831 202d 2075 6e73 6361 6c65 645f  * (1 - unscaled_
-0001b970: 7072 696d 616c 2929 2c20 7375 6d28 6720  primal)), sum(g 
-0001b980: 2a20 756e 7363 616c 6564 5f70 7269 6d61  * unscaled_prima
-0001b990: 6c29 0a0a 0a6e 6f6e 6469 6666 6572 656e  l)...nondifferen
-0001b9a0: 7469 6162 6c65 5f76 6a70 5f73 796d 626f  tiable_vjp_symbo
-0001b9b0: 6c73 203d 2028 7072 696d 732e 5072 696d  ls = (prims.Prim
-0001b9c0: 4944 732e 4249 5457 4953 455f 414e 442c  IDs.BITWISE_AND,
-0001b9d0: 2070 7269 6d73 2e50 7269 6d49 4473 2e53   prims.PrimIDs.S
-0001b9e0: 4947 4e42 4954 2c20 7072 696d 732e 5072  IGNBIT, prims.Pr
-0001b9f0: 696d 4944 732e 4655 4c4c 290a 0a0a 6465  imIDs.FULL)...de
-0001ba00: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
-0001ba10: 725f 766a 7028 7379 6d62 6f6c 3a20 7072  r_vjp(symbol: pr
-0001ba20: 696d 732e 5379 6d62 6f6c 2920 2d3e 2062  ims.Symbol) -> b
-0001ba30: 6f6f 6c3a 0a20 2020 2022 2222 4368 6563  ool:.    """Chec
-0001ba40: 6b20 6966 2061 2073 796d 626f 6c20 6973  k if a symbol is
-0001ba50: 2063 6f6e 7374 616e 7420 666f 7220 7468   constant for th
-0001ba60: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
-0001ba70: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001ba80: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
-0001ba90: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
-0001baa0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
-0001bab0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001bac0: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
-0001bad0: 7468 6520 7379 6d62 6f6c 2069 7320 636f  the symbol is co
-0001bae0: 6e73 7461 6e74 2c20 4661 6c73 6520 6f74  nstant, False ot
-0001baf0: 6865 7277 6973 652e 0a20 2020 2022 2222  herwise..    """
-0001bb00: 0a20 2020 2061 7265 5f61 6c6c 5f61 7267  .    are_all_arg
-0001bb10: 735f 6e6f 6e5f 6469 6666 6572 656e 7469  s_non_differenti
-0001bb20: 6162 6c65 203d 206e 6f74 2061 6e79 2869  able = not any(i
-0001bb30: 7369 6e73 7461 6e63 6528 6172 672c 2028  sinstance(arg, (
-0001bb40: 466c 6f61 7450 726f 7879 2c20 5465 6e73  FloatProxy, Tens
-0001bb50: 6f72 5072 6f78 7929 2920 666f 7220 6172  orProxy)) for ar
-0001bb60: 6720 696e 2073 796d 626f 6c2e 666c 6174  g in symbol.flat
-0001bb70: 5f61 7267 7329 0a20 2020 2072 6574 7572  _args).    retur
-0001bb80: 6e20 280a 2020 2020 2020 2020 6172 655f  n (.        are_
-0001bb90: 616c 6c5f 6172 6773 5f6e 6f6e 5f64 6966  all_args_non_dif
-0001bba0: 6665 7265 6e74 6961 626c 650a 2020 2020  ferentiable.    
-0001bbb0: 2020 2020 6f72 2073 796d 626f 6c2e 6172      or symbol.ar
-0001bbc0: 655f 616c 6c5f 6172 6773 5f63 6f6e 7374  e_all_args_const
-0001bbd0: 616e 740a 2020 2020 2020 2020 6f72 2073  ant.        or s
-0001bbe0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
-0001bbf0: 6e6f 6e64 6966 6665 7265 6e74 6961 626c  nondifferentiabl
-0001bc00: 655f 766a 705f 7379 6d62 6f6c 730a 2020  e_vjp_symbols.  
-0001bc10: 2020 290a 0a0a 6465 6620 766a 705f 7379    )...def vjp_sy
-0001bc20: 6d62 6f6c 5f6d 6170 7065 7228 7379 6d62  mbol_mapper(symb
-0001bc30: 6f6c 3a20 7072 696d 732e 5379 6d62 6f6c  ol: prims.Symbol
-0001bc40: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-0001bc50: 7329 3a0a 2020 2020 2222 2253 796d 626f  s):.    """Symbo
-0001bc60: 6c20 6d61 7070 6572 2066 6f72 2074 6865  l mapper for the
-0001bc70: 2056 4a50 2074 7261 6e73 666f 726d 2e0a   VJP transform..
-0001bc80: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001bc90: 2020 2073 796d 626f 6c20 2870 7269 6d73     symbol (prims
-0001bca0: 2e53 796d 626f 6c29 3a20 5379 6d62 6f6c  .Symbol): Symbol
-0001bcb0: 2074 6f20 6265 206d 6170 7065 642e 0a20   to be mapped.. 
-0001bcc0: 2020 2020 2020 2061 7267 7320 2854 7570         args (Tup
-0001bcd0: 6c65 5b56 6172 6961 626c 655d 293a 2041  le[Variable]): A
-0001bce0: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0001bcf0: 7379 6d62 6f6c 2e0a 2020 2020 2020 2020  symbol..        
-0001bd00: 6b77 6172 6773 2028 4469 6374 5b73 7472  kwargs (Dict[str
-0001bd10: 2c20 5661 7269 6162 6c65 5d29 3a20 4b65  , Variable]): Ke
-0001bd20: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
-0001bd30: 746f 2074 6865 2073 796d 626f 6c2e 0a0a  to the symbol...
-0001bd40: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001bd50: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
-0001bd60: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
-0001bd70: 6f6d 7075 7465 7320 7468 6520 564a 5020  omputes the VJP 
-0001bd80: 6f66 2074 6865 2073 796d 626f 6c2e 0a20  of the symbol.. 
-0001bd90: 2020 2022 2222 0a20 2020 2023 2043 6f6e     """.    # Con
-0001bda0: 7374 616e 7420 6361 7365 0a20 2020 2069  stant case.    i
-0001bdb0: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
-0001bdc0: 725f 766a 7028 7379 6d62 6f6c 293a 0a0a  r_vjp(symbol):..
-0001bdd0: 2020 2020 2020 2020 6465 6620 766a 705f          def vjp_
-0001bde0: 696d 706c 5f63 6f6e 7374 2873 796d 626f  impl_const(symbo
-0001bdf0: 6c2c 202a 6172 6773 2c20 2a2a 6b77 6172  l, *args, **kwar
-0001be00: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-0001be10: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
-0001be20: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-0001be30: 783a 2078 2e70 7269 6d61 6c20 6966 2069  x: x.primal if i
-0001be40: 7369 6e73 7461 6e63 6528 782c 2056 4a50  sinstance(x, VJP
-0001be50: 4475 616c 2920 656c 7365 2078 2c20 2861  Dual) else x, (a
-0001be60: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
-0001be70: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0001be80: 7320 3d20 7379 6d62 6f6c 5f74 6f5f 6576  s = symbol_to_ev
-0001be90: 616c 2873 796d 626f 6c29 282a 6172 6773  al(symbol)(*args
-0001bea0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0001beb0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001bec0: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
-0001bed0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001bee0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001bef0: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001bf00: 2078 3a20 564a 5044 7561 6c28 782c 2074   x: VJPDual(x, t
-0001bf10: 7570 6c65 2829 292c 2070 7269 6d61 6c73  uple()), primals
-0001bf20: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0001bf30: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-0001bf40: 6d61 6c73 2c20 7475 706c 6528 2929 0a0a  mals, tuple())..
-0001bf50: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0001bf60: 6172 7469 616c 2876 6a70 5f69 6d70 6c5f  artial(vjp_impl_
-0001bf70: 636f 6e73 742c 2073 796d 626f 6c29 0a0a  const, symbol)..
-0001bf80: 2020 2020 2320 4e6f 726d 616c 2063 6173      # Normal cas
-0001bf90: 652c 2077 6520 6861 7665 2061 2070 726f  e, we have a pro
-0001bfa0: 7879 2074 616e 6765 6e74 0a20 2020 2076  xy tangent.    v
-0001bfb0: 6a70 5f69 6d70 6c20 3d20 6175 676d 656e  jp_impl = augmen
-0001bfc0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-0001bfd0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
-0001bfe0: 2e69 6429 0a0a 2020 2020 6966 205f 6765  .id)..    if _ge
-0001bff0: 745f 6772 6164 666e 5f61 6e64 5f65 7865  t_gradfn_and_exe
-0001c000: 6375 746f 7228 7379 6d62 6f6c 295b 305d  cutor(symbol)[0]
-0001c010: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001c020: 2020 2020 2020 766a 705f 696d 706c 2c20        vjp_impl, 
-0001c030: 6261 636b 7761 7264 5f66 6e20 3d20 6d61  backward_fn = ma
-0001c040: 6b65 5f61 7567 5f66 6f72 7761 7264 5f61  ke_aug_forward_a
-0001c050: 6e64 5f62 6163 6b77 6172 6428 7379 6d62  nd_backward(symb
-0001c060: 6f6c 290a 0a20 2020 2069 6620 766a 705f  ol)..    if vjp_
-0001c070: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
-0001c080: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
-0001c090: 206e 6f74 2066 696e 6420 6120 564a 5020   not find a VJP 
-0001c0a0: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
-0001c0b0: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
-0001c0c0: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
-0001c0d0: 2020 2069 6620 6c65 6e28 7379 6d62 6f6c     if len(symbol
-0001c0e0: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
-0001c0f0: 2061 6e64 206e 6f74 2069 7369 6e73 7461   and not isinsta
-0001c100: 6e63 6528 7379 6d62 6f6c 2e73 796d 2e69  nce(symbol.sym.i
-0001c110: 642c 2070 7269 6d73 2e50 7269 6d49 4473  d, prims.PrimIDs
-0001c120: 293a 0a20 2020 2020 2020 2020 2020 2076  ):.            v
-0001c130: 6a70 5f69 6d70 6c20 3d20 7061 7274 6961  jp_impl = partia
-0001c140: 6c28 6465 636f 6d70 6f73 6564 5f66 6e5f  l(decomposed_fn_
-0001c150: 6175 675f 6677 645f 7275 6c65 2c20 6465  aug_fwd_rule, de
-0001c160: 636f 6d70 6f73 6564 5f66 6e3d 7379 6d62  composed_fn=symb
-0001c170: 6f6c 2e73 796d 290a 2020 2020 2020 2020  ol.sym).        
-0001c180: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001c190: 2020 2320 5765 2063 6f75 6c64 206e 6f74    # We could not
-0001c1a0: 2066 696e 6420 6120 564a 5020 666f 7220   find a VJP for 
-0001c1b0: 7468 6973 2073 796d 626f 6c20 616e 6420  this symbol and 
-0001c1c0: 7765 2063 6f75 6c64 206e 6f74 2064 6563  we could not dec
-0001c1d0: 6f6d 706f 7365 2069 740a 2020 2020 2020  ompose it.      
-0001c1e0: 2020 2020 2020 2320 4974 2063 6f75 6c64        # It could
-0001c1f0: 2062 6520 6120 746f 7263 682e 6472 6f70   be a torch.drop
-0001c200: 6f75 7420 7769 7468 2030 2e30 2070 726f  out with 0.0 pro
-0001c210: 6261 6269 6c69 7479 2c20 736f 2077 6520  bability, so we 
-0001c220: 736b 6970 2069 740a 2020 2020 2020 2020  skip it.        
-0001c230: 2020 2020 6966 2073 796d 626f 6c2e 7379      if symbol.sy
-0001c240: 6d2e 6964 203d 3d20 2274 6f72 6368 2e6e  m.id == "torch.n
-0001c250: 6e2e 6675 6e63 7469 6f6e 616c 2e64 726f  n.functional.dro
-0001c260: 706f 7574 223a 0a20 2020 2020 2020 2020  pout":.         
-0001c270: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0001c280: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
-0001c290: 7269 6e74 2866 2256 4a50 2066 6f72 207b  rint(f"VJP for {
-0001c2a0: 7379 6d62 6f6c 7d20 6973 206e 6f74 2069  symbol} is not i
-0001c2b0: 6d70 6c65 6d65 6e74 6564 2229 0a20 2020  mplemented").   
-0001c2c0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-0001c2d0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0001c2e0: 6f72 2866 2256 4a50 2066 6f72 207b 7379  or(f"VJP for {sy
-0001c2f0: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
-0001c300: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-0001c310: 290a 0a20 2020 2064 6566 205f 766a 705f  )..    def _vjp_
-0001c320: 696d 706c 282a 6172 6773 2c20 2a2a 6b77  impl(*args, **kw
-0001c330: 6172 6773 293a 0a20 2020 2020 2020 2070  args):.        p
-0001c340: 7269 6d61 6c73 2c20 6b77 6172 6773 203d  rimals, kwargs =
-0001c350: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001c360: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
-0001c370: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
-0001c380: 5044 7561 6c29 2065 6c73 6520 782c 2028  PDual) else x, (
-0001c390: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
-0001c3a0: 2020 2020 2020 206f 7574 5f70 7269 6d61         out_prima
-0001c3b0: 6c2c 206f 7574 5f72 6573 6964 7561 6c73  l, out_residuals
-0001c3c0: 203d 2076 6a70 5f69 6d70 6c28 2a70 7269   = vjp_impl(*pri
-0001c3d0: 6d61 6c73 2c20 2a2a 6b77 6172 6773 290a  mals, **kwargs).
-0001c3e0: 0a20 2020 2020 2020 2023 2057 6520 6172  .        # We ar
-0001c3f0: 6520 7361 7669 6e67 2074 6865 2072 6573  e saving the res
-0001c400: 6964 7561 6c73 2061 6e64 2070 756c 6c62  iduals and pullb
-0001c410: 6163 6b20 6f6e 6c79 2069 6e20 7468 6520  ack only in the 
-0001c420: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
-0001c430: 2020 2020 2023 2062 6163 6b77 6172 645f       # backward_
-0001c440: 7061 7373 2074 6865 6e20 7265 7472 6965  pass then retrie
-0001c450: 7665 7320 7468 6520 7265 7369 6475 616c  ves the residual
-0001c460: 7320 616e 6420 7075 6c6c 6261 636b 2066  s and pullback f
-0001c470: 726f 6d20 7468 6520 6669 7273 7420 6f75  rom the first ou
-0001c480: 7470 7574 0a20 2020 2020 2020 2069 6620  tput.        if 
-0001c490: 6973 696e 7374 616e 6365 286f 7574 5f70  isinstance(out_p
-0001c4a0: 7269 6d61 6c2c 2053 6571 7565 6e63 6529  rimal, Sequence)
-0001c4b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001c4c0: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
-0001c4d0: 745f 7072 696d 616c 5b30 5d2c 206f 7574  t_primal[0], out
-0001c4e0: 5f72 6573 6964 7561 6c73 292c 202a 2856  _residuals), *(V
-0001c4f0: 4a50 4475 616c 286f 2c20 7475 706c 6528  JPDual(o, tuple(
-0001c500: 2929 2066 6f72 206f 2069 6e20 6f75 745f  )) for o in out_
-0001c510: 7072 696d 616c 5b31 3a5d 2929 0a0a 2020  primal[1:]))..  
-0001c520: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
-0001c530: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-0001c540: 2c20 6f75 745f 7265 7369 6475 616c 7329  , out_residuals)
-0001c550: 2c29 0a0a 2020 2020 7265 7475 726e 205f  ,)..    return _
-0001c560: 766a 705f 696d 706c 0a0a 0a64 6566 2063  vjp_impl...def c
-0001c570: 6865 636b 5f62 7379 6d5f 666f 725f 766a  heck_bsym_for_vj
-0001c580: 7028 6273 796d 293a 0a20 2020 2022 2222  p(bsym):.    """
-0001c590: 0a20 2020 2043 6865 636b 2069 6620 6120  .    Check if a 
-0001c5a0: 626f 756e 6420 7379 6d62 6f6c 2069 7320  bound symbol is 
-0001c5b0: 7375 7070 6f72 7465 6420 6279 2076 6a70  supported by vjp
-0001c5c0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0001c5d0: 2020 2020 2062 7379 6d20 2842 6f75 6e64       bsym (Bound
-0001c5e0: 5379 6d62 6f6c 293a 2054 6865 2062 6f75  Symbol): The bou
-0001c5f0: 6e64 2073 796d 626f 6c20 746f 2063 6865  nd symbol to che
-0001c600: 636b 2e0a 0a20 2020 2052 6574 7572 6e73  ck...    Returns
-0001c610: 3a0a 2020 2020 2020 2020 626f 6f6c 3a20  :.        bool: 
-0001c620: 5472 7565 2069 6620 7468 6520 626f 756e  True if the boun
-0001c630: 6420 7379 6d62 6f6c 2069 7320 7375 7070  d symbol is supp
-0001c640: 6f72 7465 6420 6279 2076 6a70 2c20 4661  orted by vjp, Fa
-0001c650: 6c73 6520 6f74 6865 7277 6973 652e 0a20  lse otherwise.. 
-0001c660: 2020 2022 2222 0a0a 2020 2020 6966 2062     """..    if b
-0001c670: 7379 6d2e 7379 6d2e 6964 2069 6e20 7472  sym.sym.id in tr
-0001c680: 616e 7366 6f72 6d5f 736b 6970 5f6c 6973  ansform_skip_lis
-0001c690: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-0001c6a0: 6e20 5472 7565 0a0a 2020 2020 6966 2062  n True..    if b
-0001c6b0: 7379 6d2e 7379 6d2e 6964 2069 6e20 6261  sym.sym.id in ba
-0001c6c0: 636b 7761 7264 5f69 6d70 6c73 2061 6e64  ckward_impls and
-0001c6d0: 2062 7379 6d2e 7379 6d2e 6964 2069 6e20   bsym.sym.id in 
-0001c6e0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001c6f0: 645f 696d 706c 733a 0a20 2020 2020 2020  d_impls:.       
-0001c700: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-0001c710: 2020 6966 2062 7379 6d2e 7379 6d2e 6964    if bsym.sym.id
-0001c720: 2069 6e20 5f67 7261 645f 666e 5f6d 6170   in _grad_fn_map
-0001c730: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001c740: 2054 7275 650a 0a20 2020 2023 2057 6520   True..    # We 
-0001c750: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
-0001c760: 2056 4a50 2066 6f72 2074 6869 7320 7379   VJP for this sy
-0001c770: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
-0001c780: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
-0001c790: 2020 2020 2320 696e 746f 2073 7562 2d73      # into sub-s
-0001c7a0: 796d 626f 6c73 2061 6e64 2063 6865 636b  ymbols and check
-0001c7b0: 2069 6620 7468 6579 2061 7265 2073 7570   if they are sup
-0001c7c0: 706f 7274 6564 0a20 2020 2069 6620 6c65  ported.    if le
-0001c7d0: 6e28 6273 796d 2e73 7562 7379 6d62 6f6c  n(bsym.subsymbol
-0001c7e0: 7329 203e 2030 2061 6e64 206e 6f74 2062  s) > 0 and not b
-0001c7f0: 7379 6d2e 7379 6d2e 6973 5f70 7269 6d3a  sym.sym.is_prim:
-0001c800: 0a20 2020 2020 2020 2073 7562 7472 6163  .        subtrac
-0001c810: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
-0001c820: 6163 6528 2928 6273 796d 2e73 796d 2c20  ace()(bsym.sym, 
-0001c830: 2a62 7379 6d2e 6172 6773 2c20 2a2a 6273  *bsym.args, **bs
-0001c840: 796d 2e6b 7761 7267 7329 0a20 2020 2020  ym.kwargs).     
-0001c850: 2020 2073 7562 7472 6163 6520 3d20 756e     subtrace = un
-0001c860: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
-0001c870: 665f 7375 6273 796d 626f 6c73 2873 7562  f_subsymbols(sub
-0001c880: 7472 6163 6529 0a20 2020 2020 2020 2061  trace).        a
-0001c890: 6c6c 5f73 7570 706f 7274 6564 203d 2061  ll_supported = a
-0001c8a0: 6c6c 2863 6865 636b 5f62 7379 6d5f 666f  ll(check_bsym_fo
-0001c8b0: 725f 766a 7028 7375 6262 7379 6d29 2066  r_vjp(subbsym) f
-0001c8c0: 6f72 2073 7562 6273 796d 2069 6e20 7375  or subbsym in su
-0001c8d0: 6274 7261 6365 2e62 6f75 6e64 5f73 796d  btrace.bound_sym
-0001c8e0: 626f 6c73 290a 2020 2020 2020 2020 7265  bols).        re
-0001c8f0: 7475 726e 2061 6c6c 5f73 7570 706f 7274  turn all_support
-0001c900: 6564 0a0a 2020 2020 7265 7475 726e 2046  ed..    return F
-0001c910: 616c 7365 0a0a 0a64 6566 2061 7567 6d65  alse...def augme
-0001c920: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
-0001c930: 7328 2a61 7267 732c 2074 7261 6365 3a20  s(*args, trace: 
-0001c940: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-0001c950: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
-0001c960: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
-0001c970: 666f 7220 7468 6520 564a 5020 7472 616e  for the VJP tran
-0001c980: 7366 6f72 6d2e 0a0a 2020 2020 5468 6520  sform...    The 
-0001c990: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
-0001c9a0: 6420 7061 7373 2069 7320 6120 666f 7277  d pass is a forw
-0001c9b0: 6172 6420 7061 7373 2074 6861 7420 7265  ard pass that re
-0001c9c0: 7475 726e 7320 7468 6520 7265 7369 6475  turns the residu
-0001c9d0: 616c 730a 2020 2020 6f66 2074 6865 2066  als.    of the f
-0001c9e0: 6f72 7761 7264 2070 6173 732e 0a20 2020  orward pass..   
-0001c9f0: 2054 6865 7365 2072 6573 6964 7561 6c73   These residuals
-0001ca00: 2061 7265 2075 7365 6420 696e 2074 6865   are used in the
-0001ca10: 2062 6163 6b77 6172 6420 7061 7373 2074   backward pass t
-0001ca20: 6f20 636f 6d70 7574 6520 7468 6520 564a  o compute the VJ
-0001ca30: 5020 616e 6420 7468 6579 0a20 2020 2061  P and they.    a
-0001ca40: 7265 2072 6563 6f72 6465 6420 696e 2074  re recorded in t
-0001ca50: 6865 2065 6e76 6972 6f6e 6d65 6e74 2064  he environment d
-0001ca60: 6963 7469 6f6e 6172 7920 666f 7220 6561  ictionary for ea
-0001ca70: 6368 2076 6172 6961 626c 652e 0a0a 2020  ch variable...  
-0001ca80: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001ca90: 6172 6773 2028 5475 706c 655b 5661 7269  args (Tuple[Vari
-0001caa0: 6162 6c65 5d29 3a20 4172 6775 6d65 6e74  able]): Argument
-0001cab0: 7320 746f 2074 6865 2066 756e 6374 696f  s to the functio
-0001cac0: 6e2e 0a20 2020 2020 2020 2074 7261 6365  n..        trace
-0001cad0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-0001cae0: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
-0001caf0: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
-0001cb00: 2844 6963 745b 7374 722c 2056 6172 6961  (Dict[str, Varia
-0001cb10: 626c 655d 293a 204b 6579 776f 7264 2061  ble]): Keyword a
-0001cb20: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0001cb30: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2052  function...    R
-0001cb40: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0001cb50: 5475 706c 655b 416e 792c 2044 6963 745b  Tuple[Any, Dict[
-0001cb60: 7374 722c 2041 6e79 5d5d 3a20 5475 706c  str, Any]]: Tupl
-0001cb70: 6520 6f66 2074 6865 2070 7269 6d61 6c20  e of the primal 
-0001cb80: 6f75 7470 7574 7320 616e 6420 7468 6520  outputs and the 
-0001cb90: 656e 7669 726f 6e6d 656e 742e 0a20 2020  environment..   
-0001cba0: 2022 2222 0a20 2020 2061 7267 732c 206b   """.    args, k
-0001cbb0: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
-0001cbc0: 286c 616d 6264 6120 783a 2056 4a50 4475  (lambda x: VJPDu
-0001cbd0: 616c 2878 2c20 7475 706c 6528 2929 2c20  al(x, tuple()), 
-0001cbe0: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
-0001cbf0: 2020 2020 7265 7375 6c74 2c20 656e 7620      result, env 
-0001cc00: 3d20 6576 616c 5f74 7261 6365 280a 2020  = eval_trace(.  
-0001cc10: 2020 2020 2020 7472 6163 652c 0a20 2020        trace,.   
-0001cc20: 2020 2020 202a 6172 6773 2c0a 2020 2020       *args,.    
-0001cc30: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0001cc40: 2020 2020 2020 7769 7468 5f65 6e76 3d54        with_env=T
-0001cc50: 7275 652c 0a20 2020 2020 2020 2073 796d  rue,.        sym
-0001cc60: 626f 6c5f 6d61 7070 6572 3d76 6a70 5f73  bol_mapper=vjp_s
-0001cc70: 796d 626f 6c5f 6d61 7070 6572 2c0a 2020  ymbol_mapper,.  
-0001cc80: 2020 290a 2020 2020 7265 7375 6c74 203d    ).    result =
-0001cc90: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-0001cca0: 2078 3a20 782e 7072 696d 616c 2069 6620   x: x.primal if 
-0001ccb0: 6973 696e 7374 616e 6365 2878 2c20 564a  isinstance(x, VJ
-0001ccc0: 5044 7561 6c29 2065 6c73 6520 782c 2072  PDual) else x, r
-0001ccd0: 6573 756c 7429 0a20 2020 2072 6574 7572  esult).    retur
-0001cce0: 6e20 7265 7375 6c74 2c20 656e 760a 0a0a  n result, env...
-0001ccf0: 2320 544f 444f 3a20 496e 7374 6561 6420  # TODO: Instead 
-0001cd00: 6f66 2075 7369 6e67 2074 6865 2065 6e76  of using the env
-0001cd10: 6972 6f6e 6d65 6e74 2064 6963 7469 6f6e  ironment diction
-0001cd20: 6172 792c 2077 6520 636f 756c 6420 7573  ary, we could us
-0001cd30: 6520 7468 6520 7472 6163 650a 2320 7379  e the trace.# sy
-0001cd40: 6d62 6f6c 7320 6f72 6465 7220 2874 6861  mbols order (tha
-0001cd50: 7420 7368 6f75 6c64 2062 6520 6465 7465  t should be dete
-0001cd60: 726d 696e 6973 7469 6329 2074 6f20 7265  rministic) to re
-0001cd70: 7472 6965 7665 2074 6865 2072 6573 6964  trieve the resid
-0001cd80: 7561 6c73 206e 6565 6465 640a 2320 666f  uals needed.# fo
-0001cd90: 7220 7468 6520 6261 636b 7761 7264 2070  r the backward p
-0001cda0: 6173 732e 0a64 6566 2062 6163 6b77 6172  ass..def backwar
-0001cdb0: 645f 7061 7373 2866 6f72 7761 7264 5f65  d_pass(forward_e
-0001cdc0: 6e76 2c20 7472 6163 652c 2069 6e69 745f  nv, trace, init_
-0001cdd0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
-0001cde0: 2022 2222 4261 636b 7761 7264 2070 6173   """Backward pas
-0001cdf0: 7320 666f 7220 7468 6520 564a 5020 7472  s for the VJP tr
-0001ce00: 616e 7366 6f72 6d2e 0a0a 2020 2020 5468  ansform...    Th
-0001ce10: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-0001ce20: 6973 2061 2072 6576 6572 7365 206d 6f64  is a reverse mod
-0001ce30: 6520 6175 746f 6d61 7469 6320 6469 6666  e automatic diff
-0001ce40: 6572 656e 7469 6174 696f 6e20 7061 7373  erentiation pass
-0001ce50: 2074 6861 740a 2020 2020 636f 6d70 7574   that.    comput
-0001ce60: 6573 2074 6865 2076 6563 746f 722d 4a61  es the vector-Ja
-0001ce70: 636f 6269 616e 2070 726f 6475 6374 2028  cobian product (
-0001ce80: 564a 5029 206f 6620 7468 6520 6675 6e63  VJP) of the func
-0001ce90: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
-0001cea0: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-0001ceb0: 5f65 6e76 2028 4469 6374 5b73 7472 2c20  _env (Dict[str, 
-0001cec0: 416e 795d 293a 2045 6e76 6972 6f6e 6d65  Any]): Environme
-0001ced0: 6e74 206f 6620 7468 6520 666f 7277 6172  nt of the forwar
-0001cee0: 6420 7061 7373 2e0a 2020 2020 2020 2020  d pass..        
-0001cef0: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
-0001cf00: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
-0001cf10: 7469 6f6e 2e0a 2020 2020 2020 2020 696e  tion..        in
-0001cf20: 6974 5f63 6f74 616e 6765 6e74 7320 2854  it_cotangents (T
-0001cf30: 7570 6c65 5b56 6172 6961 626c 655d 293a  uple[Variable]):
-0001cf40: 2049 6e69 7469 616c 2063 6f74 616e 6765   Initial cotange
-0001cf50: 6e74 732e 0a0a 2020 2020 5265 7475 726e  nts...    Return
-0001cf60: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
-0001cf70: 5b50 726f 7879 2c20 2e2e 2e5d 3a20 5475  [Proxy, ...]: Tu
-0001cf80: 706c 6520 6f66 2074 6865 2072 6573 756c  ple of the resul
-0001cf90: 7473 206f 6620 7468 6520 6261 636b 7761  ts of the backwa
-0001cfa0: 7264 2070 6173 7320 666f 7220 6561 6368  rd pass for each
-0001cfb0: 2069 6e70 7574 2e0a 2020 2020 2222 220a   input..    """.
-0001cfc0: 2020 2020 656e 7620 3d20 7b7d 0a0a 2020      env = {}..  
-0001cfd0: 2020 6465 6620 6765 745f 6772 6164 2878    def get_grad(x
-0001cfe0: 3a20 5661 7269 6162 6c65 293a 0a20 2020  : Variable):.   
-0001cff0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001d000: 6365 2878 2c20 5661 7269 6162 6c65 293a  ce(x, Variable):
-0001d010: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-0001d020: 6574 7572 6e20 4e6f 6e65 2069 6620 7468  eturn None if th
-0001d030: 6520 7661 7269 6162 6c65 2077 6173 206e  e variable was n
-0001d040: 6f74 2075 7365 6420 696e 2074 6865 2063  ot used in the c
-0001d050: 6f6d 7075 7461 7469 6f6e 2061 6e64 0a20  omputation and. 
-0001d060: 2020 2020 2020 2020 2020 2023 2068 656e             # hen
-0001d070: 6365 206e 6f74 2069 6e20 7468 6520 656e  ce not in the en
-0001d080: 760a 2020 2020 2020 2020 2020 2020 7265  v.            re
-0001d090: 7475 726e 2065 6e76 2e67 6574 2878 2e6e  turn env.get(x.n
-0001d0a0: 616d 652c 204e 6f6e 6529 0a20 2020 2020  ame, None).     
-0001d0b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001d0c0: 2020 2020 2072 6574 7572 6e20 780a 0a20       return x.. 
-0001d0d0: 2020 2064 6566 2070 7574 5f67 7261 6428     def put_grad(
-0001d0e0: 763a 2056 6172 6961 626c 652c 2076 616c  v: Variable, val
-0001d0f0: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
-0001d100: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001d110: 7461 6e63 6528 762c 2056 6172 6961 626c  tance(v, Variabl
-0001d120: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001d130: 6966 2076 2e6e 616d 6520 696e 2065 6e76  if v.name in env
-0001d140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d150: 2020 6966 2076 616c 2069 7320 4e6f 6e65    if val is None
-0001d160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d170: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001d180: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-0001d190: 6363 756d 756c 6174 6520 636f 7461 6e67  ccumulate cotang
-0001d1a0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-0001d1b0: 2020 2020 2065 6e76 5b76 2e6e 616d 655d       env[v.name]
-0001d1c0: 203d 2063 6c61 6e67 2e61 6464 2865 6e76   = clang.add(env
-0001d1d0: 5b76 2e6e 616d 655d 2c20 7661 6c29 2069  [v.name], val) i
-0001d1e0: 6620 656e 765b 762e 6e61 6d65 5d20 6973  f env[v.name] is
-0001d1f0: 206e 6f74 204e 6f6e 6520 656c 7365 2076   not None else v
-0001d200: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
-0001d210: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0001d220: 2020 2020 2020 656e 765b 762e 6e61 6d65        env[v.name
-0001d230: 5d20 3d20 7661 6c0a 2020 2020 2020 2020  ] = val.        
-0001d240: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001d250: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
-0001d260: 2061 6c6c 2869 7369 6e73 7461 6e63 6528   all(isinstance(
-0001d270: 782c 2069 6e74 2920 666f 7220 7820 696e  x, int) for x in
-0001d280: 2076 293a 0a20 2020 2020 2020 2020 2020   v):.           
-0001d290: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
-0001d2a0: 7768 656e 2077 6520 6d6f 7665 2064 696d  when we move dim
-0001d2b0: 7320 746f 206b 7761 7267 730a 2020 2020  s to kwargs.    
-0001d2c0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0001d2d0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0001d2e0: 616e 6365 2876 2c20 7374 7229 3a0a 2020  ance(v, str):.  
-0001d2f0: 2020 2020 2020 2020 2020 656e 765b 765d            env[v]
-0001d300: 203d 2076 616c 0a20 2020 2020 2020 2065   = val.        e
-0001d310: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
-0001d320: 2c20 5365 7175 656e 6365 2920 616e 6420  , Sequence) and 
-0001d330: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
-0001d340: 2020 2020 2020 2020 2023 2062 726f 6164           # broad
-0001d350: 6361 7374 204e 6f6e 6520 746f 2074 6865  cast None to the
-0001d360: 2072 6967 6874 2073 6861 7065 0a20 2020   right shape.   
-0001d370: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
-0001d380: 7028 7075 745f 6772 6164 2c20 762c 205b  p(put_grad, v, [
-0001d390: 4e6f 6e65 5d20 2a20 6c65 6e28 7629 290a  None] * len(v)).
-0001d3a0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001d3b0: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
-0001d3c0: 6e63 6529 2061 6e64 2069 7369 6e73 7461  nce) and isinsta
-0001d3d0: 6e63 6528 7661 6c2c 2053 6571 7565 6e63  nce(val, Sequenc
-0001d3e0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001d3f0: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
-0001d400: 745f 6772 6164 2c20 762c 2076 616c 290a  t_grad, v, val).
-0001d410: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001d420: 2020 2020 2020 2020 2020 2320 536b 6970            # Skip
-0001d430: 2077 7269 7469 6e67 2074 6f20 636f 6e73   writing to cons
-0001d440: 7461 6e74 730a 2020 2020 2020 2020 2020  tants.          
-0001d450: 2020 7061 7373 0a0a 2020 2020 6966 2069    pass..    if i
-0001d460: 7369 6e73 7461 6e63 6528 696e 6974 5f63  sinstance(init_c
-0001d470: 6f74 616e 6765 6e74 732c 2053 6571 7565  otangents, Seque
-0001d480: 6e63 6529 2061 6e64 206c 656e 2869 6e69  nce) and len(ini
-0001d490: 745f 636f 7461 6e67 656e 7473 2920 3d3d  t_cotangents) ==
-0001d4a0: 2031 2061 6e64 206e 6f74 2069 7369 6e73   1 and not isins
-0001d4b0: 7461 6e63 6528 7472 6163 652e 6f75 7470  tance(trace.outp
-0001d4c0: 7574 2c20 5365 7175 656e 6365 293a 0a20  ut, Sequence):. 
-0001d4d0: 2020 2020 2020 2069 6e69 745f 636f 7461         init_cota
-0001d4e0: 6e67 656e 7473 203d 2069 6e69 745f 636f  ngents = init_co
-0001d4f0: 7461 6e67 656e 7473 5b30 5d0a 2020 2020  tangents[0].    
-0001d500: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
-0001d510: 745f 6772 6164 2c20 7472 6163 652e 6f75  t_grad, trace.ou
-0001d520: 7470 7574 2c20 696e 6974 5f63 6f74 616e  tput, init_cotan
-0001d530: 6765 6e74 7329 0a0a 2020 2020 666f 7220  gents)..    for 
-0001d540: 7379 6d62 6f6c 2069 6e20 7265 7665 7273  symbol in revers
-0001d550: 6564 286c 6973 7428 6974 6572 5f62 6f75  ed(list(iter_bou
-0001d560: 6e64 5f73 796d 626f 6c73 2874 7261 6365  nd_symbols(trace
-0001d570: 2e62 6f75 6e64 5f73 796d 626f 6c73 2929  .bound_symbols))
-0001d580: 293a 0a20 2020 2020 2020 2073 796d 626f  ):.        symbo
-0001d590: 6c5f 6f75 7470 7574 203d 2073 6571 7565  l_output = seque
-0001d5a0: 6e63 6966 7928 7379 6d62 6f6c 2e6f 7574  ncify(symbol.out
-0001d5b0: 7075 7429 0a0a 2020 2020 2020 2020 636f  put)..        co
-0001d5c0: 7461 6e67 656e 7473 203d 2074 7265 655f  tangents = tree_
-0001d5d0: 6d61 7028 6765 745f 6772 6164 2c20 7379  map(get_grad, sy
-0001d5e0: 6d62 6f6c 5f6f 7574 7075 7429 0a20 2020  mbol_output).   
-0001d5f0: 2020 2020 2023 2048 6176 696e 6720 6120       # Having a 
-0001d600: 7369 6e67 6c65 2063 6f74 616e 6765 6e74  single cotangent
-0001d610: 2069 7320 6120 636f 6d6d 6f6e 2063 6173   is a common cas
-0001d620: 652c 2073 6f20 7765 2066 6c61 7474 656e  e, so we flatten
-0001d630: 2069 740a 2020 2020 2020 2020 2320 4f74   it.        # Ot
-0001d640: 6865 7277 6973 652c 2077 6520 7769 6c6c  herwise, we will
-0001d650: 206e 6565 6420 746f 2072 6577 7269 7465   need to rewrite
-0001d660: 2074 6865 2070 756c 6c62 6163 6b20 6675   the pullback fu
-0001d670: 6e63 7469 6f6e 730a 2020 2020 2020 2020  nctions.        
-0001d680: 636f 7461 6e67 656e 7473 203d 2074 7265  cotangents = tre
-0001d690: 655f 666c 6174 7465 6e28 636f 7461 6e67  e_flatten(cotang
-0001d6a0: 656e 7473 295b 305d 0a20 2020 2020 2020  ents)[0].       
-0001d6b0: 2072 6573 6964 7561 6c73 203d 2066 6f72   residuals = for
-0001d6c0: 7761 7264 5f65 6e76 5b73 796d 626f 6c5f  ward_env[symbol_
-0001d6d0: 6f75 7470 7574 5b30 5d2e 6e61 6d65 5d2e  output[0].name].
-0001d6e0: 7265 7369 6475 616c 730a 2020 2020 2020  residuals.      
-0001d6f0: 2020 6966 2069 735f 636f 6e73 7461 6e74    if is_constant
-0001d700: 5f66 6f72 5f76 6a70 2873 796d 626f 6c29  _for_vjp(symbol)
-0001d710: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001d720: 5765 2063 616e 2073 6b69 7020 7468 6520  We can skip the 
-0001d730: 7075 6c6c 6261 636b 2069 6620 616c 6c20  pullback if all 
-0001d740: 7468 6520 6172 6775 6d65 6e74 7320 6172  the arguments ar
-0001d750: 6520 636f 6e73 7461 6e74 0a20 2020 2020  e constant.     
-0001d760: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001d770: 0a20 2020 2020 2020 2069 6620 616c 6c28  .        if all(
-0001d780: 636f 7461 6e67 656e 7420 6973 204e 6f6e  cotangent is Non
-0001d790: 6520 666f 7220 636f 7461 6e67 656e 7420  e for cotangent 
-0001d7a0: 696e 2063 6f74 616e 6765 6e74 7329 3a0a  in cotangents):.
-0001d7b0: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-0001d7c0: 2063 616e 2073 6b69 7020 7468 6520 7075   can skip the pu
-0001d7d0: 6c6c 6261 636b 2069 6620 7468 6520 636f  llback if the co
-0001d7e0: 7461 6e67 656e 7420 6973 204e 6f6e 650a  tangent is None.
-0001d7f0: 2020 2020 2020 2020 2020 2020 7361 6665              safe
-0001d800: 5f6d 6170 2870 7574 5f67 7261 642c 2073  _map(put_grad, s
-0001d810: 796d 626f 6c2e 6172 6773 2c20 284e 6f6e  ymbol.args, (Non
-0001d820: 652c 2920 2a20 6c65 6e28 7379 6d62 6f6c  e,) * len(symbol
-0001d830: 2e61 7267 7329 290a 2020 2020 2020 2020  .args)).        
-0001d840: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0001d850: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
-0001d860: 7379 6d2e 6964 203d 3d20 2274 6f72 6368  sym.id == "torch
-0001d870: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e64  .nn.functional.d
-0001d880: 726f 706f 7574 2220 616e 6420 6e6f 7420  ropout" and not 
-0001d890: 7379 6d62 6f6c 2e73 7562 7379 6d62 6f6c  symbol.subsymbol
-0001d8a0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-0001d8b0: 2057 6520 6361 6e20 736b 6970 2074 6865   We can skip the
-0001d8c0: 2070 756c 6c62 6163 6b20 6966 2074 6865   pullback if the
-0001d8d0: 2064 726f 706f 7574 2070 726f 6261 6269   dropout probabi
-0001d8e0: 6c69 7479 2069 7320 302e 300a 2020 2020  lity is 0.0.    
-0001d8f0: 2020 2020 2020 2020 2320 4173 7375 6d69          # Assumi
-0001d900: 6e67 2074 6861 7420 7468 6520 6472 6f70  ng that the drop
-0001d910: 6f75 7420 7379 6d62 6f6c 2068 6173 2074  out symbol has t
-0001d920: 6865 2073 616d 6520 6f75 7470 7574 2061  he same output a
-0001d930: 6e64 2061 7267 756d 656e 740a 2020 2020  nd argument.    
-0001d940: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-0001d950: 796d 626f 6c2e 6f75 7470 7574 2e6e 616d  ymbol.output.nam
-0001d960: 6520 3d3d 2073 796d 626f 6c2e 6172 6773  e == symbol.args
-0001d970: 5b30 5d2e 6e61 6d65 2c20 2244 726f 706f  [0].name, "Dropo
-0001d980: 7574 2073 796d 626f 6c20 6861 7320 6120  ut symbol has a 
-0001d990: 6469 6666 6572 656e 7420 6f75 7470 7574  different output
-0001d9a0: 2061 6e64 2061 7267 756d 656e 7422 0a20   and argument". 
-0001d9b0: 2020 2020 2020 2020 2020 2069 6620 7379             if sy
-0001d9c0: 6d62 6f6c 2e61 7267 735b 315d 203d 3d20  mbol.args[1] == 
-0001d9d0: 302e 3020 6f72 2073 796d 626f 6c2e 6172  0.0 or symbol.ar
-0001d9e0: 6773 5b32 5d20 6973 2046 616c 7365 3a0a  gs[2] is False:.
-0001d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001da00: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0001da10: 2020 6261 636b 7761 7264 203d 2062 6163    backward = bac
-0001da20: 6b77 6172 645f 696d 706c 732e 6765 7428  kward_impls.get(
-0001da30: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a20  symbol.sym.id). 
-0001da40: 2020 2020 2020 2061 7567 5f66 6f72 7761         aug_forwa
-0001da50: 7264 203d 2061 7567 6d65 6e74 6564 5f66  rd = augmented_f
-0001da60: 6f72 7761 7264 5f69 6d70 6c73 2e67 6574  orward_impls.get
-0001da70: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
-0001da80: 0a20 2020 2020 2020 2069 6620 5f67 6574  .        if _get
-0001da90: 5f67 7261 6466 6e5f 616e 645f 6578 6563  _gradfn_and_exec
-0001daa0: 7574 6f72 2873 796d 626f 6c29 5b30 5d20  utor(symbol)[0] 
-0001dab0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001dac0: 2020 2020 2020 2020 2061 7567 5f66 6f72           aug_for
-0001dad0: 7761 7264 2c20 6261 636b 7761 7264 203d  ward, backward =
-0001dae0: 206d 616b 655f 6175 675f 666f 7277 6172   make_aug_forwar
-0001daf0: 645f 616e 645f 6261 636b 7761 7264 2873  d_and_backward(s
-0001db00: 796d 626f 6c29 0a0a 2020 2020 2020 2020  ymbol)..        
-0001db10: 6966 2062 6163 6b77 6172 6420 6973 204e  if backward is N
-0001db20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001db30: 2069 6620 6c65 6e28 7379 6d62 6f6c 2e73   if len(symbol.s
-0001db40: 7562 7379 6d62 6f6c 7329 203e 2030 2061  ubsymbols) > 0 a
-0001db50: 6e64 206e 6f74 2069 7369 6e73 7461 6e63  nd not isinstanc
-0001db60: 6528 7379 6d62 6f6c 2e73 796d 2e69 642c  e(symbol.sym.id,
-0001db70: 2070 7269 6d73 2e50 7269 6d49 4473 293a   prims.PrimIDs):
-0001db80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001db90: 2023 2057 6520 636f 756c 6420 6e6f 7420   # We could not 
-0001dba0: 6669 6e64 2061 2062 6163 6b77 6172 6420  find a backward 
-0001dbb0: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
-0001dbc0: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
-0001dbd0: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
-0001dbe0: 2020 2020 2020 2020 2020 2062 6163 6b77             backw
-0001dbf0: 6172 6420 3d20 7061 7274 6961 6c28 6465  ard = partial(de
-0001dc00: 636f 6d70 6f73 6564 5f66 6e5f 6261 636b  composed_fn_back
-0001dc10: 7761 7264 5f72 756c 652c 2073 796d 626f  ward_rule, symbo
-0001dc20: 6c2e 7379 6d29 0a20 2020 2020 2020 2020  l.sym).         
-0001dc30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001dc40: 2020 2020 2020 2020 2023 2057 6520 636f           # We co
-0001dc50: 756c 6420 6e6f 7420 6669 6e64 2061 2062  uld not find a b
-0001dc60: 6163 6b77 6172 6420 666f 7220 7468 6973  ackward for this
-0001dc70: 2073 796d 626f 6c20 616e 6420 7765 2063   symbol and we c
-0001dc80: 6f75 6c64 206e 6f74 2064 6563 6f6d 706f  ould not decompo
-0001dc90: 7365 2069 740a 2020 2020 2020 2020 2020  se it.          
-0001dca0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0001dcb0: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0001dcc0: 6622 4261 636b 7761 7264 2066 6f72 207b  f"Backward for {
-0001dcd0: 7379 6d62 6f6c 2e73 796d 2e69 647d 2069  symbol.sym.id} i
-0001dce0: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-0001dcf0: 6422 290a 0a20 2020 2020 2020 2072 6573  d")..        res
-0001dd00: 756c 7420 3d20 6261 636b 7761 7264 282a  ult = backward(*
-0001dd10: 7265 7369 6475 616c 732c 202a 636f 7461  residuals, *cota
-0001dd20: 6e67 656e 7473 290a 2020 2020 2020 2020  ngents).        
-0001dd30: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-0001dd40: 7375 6c74 2c20 6469 6374 293a 0a20 2020  sult, dict):.   
-0001dd50: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
-0001dd60: 6520 6261 636b 7761 7264 2072 6574 7572  e backward retur
-0001dd70: 6e73 2061 2064 6963 742c 2077 6520 6173  ns a dict, we as
-0001dd80: 7375 6d65 2074 6861 7420 6974 2069 7320  sume that it is 
-0001dd90: 6120 6469 6374 206f 660a 2020 2020 2020  a dict of.      
-0001dda0: 2020 2020 2020 2320 666f 7277 6172 6420        # forward 
-0001ddb0: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
-0001ddc0: 2063 6f72 7265 7370 6f6e 6469 6e67 0a20   corresponding. 
-0001ddd0: 2020 2020 2020 2020 2020 2023 2067 7261             # gra
-0001dde0: 6469 656e 7473 2f63 6f74 616e 6765 6e74  dients/cotangent
-0001ddf0: 732f 6164 6a6f 696e 7473 2f73 656e 7369  s/adjoints/sensi
-0001de00: 7469 7669 7469 6573 2e0a 2020 2020 2020  tivities..      
-0001de10: 2020 2020 2020 7573 6564 5f6e 616d 6573        used_names
-0001de20: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0001de30: 2020 2020 2066 6f72 2069 2c20 286b 2c20       for i, (k, 
-0001de40: 7629 2069 6e20 656e 756d 6572 6174 6528  v) in enumerate(
-0001de50: 696e 7370 6563 742e 7369 676e 6174 7572  inspect.signatur
-0001de60: 6528 6175 675f 666f 7277 6172 6429 2e70  e(aug_forward).p
-0001de70: 6172 616d 6574 6572 732e 6974 656d 7328  arameters.items(
-0001de80: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0001de90: 2020 2020 6966 2076 2e6b 696e 6420 696e      if v.kind in
-0001dea0: 2028 696e 7370 6563 742e 5061 7261 6d65   (inspect.Parame
-0001deb0: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
-0001dec0: 4e4c 592c 2069 6e73 7065 6374 2e50 6172  NLY, inspect.Par
-0001ded0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
-0001dee0: 4c5f 4f52 5f4b 4559 574f 5244 293a 0a20  L_OR_KEYWORD):. 
-0001def0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df00: 2020 2070 7574 5f67 7261 6428 7379 6d62     put_grad(symb
-0001df10: 6f6c 2e61 7267 735b 695d 2c20 7265 7375  ol.args[i], resu
-0001df20: 6c74 2e67 6574 286b 2c20 4e6f 6e65 2929  lt.get(k, None))
-0001df30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001df40: 2020 2020 2075 7365 645f 6e61 6d65 732e       used_names.
-0001df50: 6164 6428 6b29 0a0a 2020 2020 2020 2020  add(k)..        
-0001df60: 2020 2020 2320 466f 7220 6465 7665 6c6f      # For develo
-0001df70: 7065 7220 636f 6e76 656e 6965 6e63 652c  per convenience,
-0001df80: 2077 6520 616c 6c6f 7720 7573 696e 6720   we allow using 
-0001df90: 7468 6520 6e61 6d65 2066 726f 6d20 7468  the name from th
-0001dfa0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-0001dfb0: 666f 7277 6172 6420 6d65 7461 2069 6e20  forward meta in 
-0001dfc0: 6164 6469 7469 6f6e 2074 6f20 7468 6520  addition to the 
-0001dfd0: 6e61 6d65 2066 726f 6d20 7468 6520 6175  name from the au
-0001dfe0: 676d 656e 7465 6420 666f 7277 6172 640a  gmented forward.
-0001dff0: 2020 2020 2020 2020 2020 2020 2320 7369              # si
-0001e000: 676e 6174 7572 652e 0a20 2020 2020 2020  gnature..       
-0001e010: 2020 2020 2023 2049 6620 626f 7468 206e       # If both n
-0001e020: 616d 6573 2061 7265 2075 7365 642c 2074  ames are used, t
-0001e030: 6865 206f 6e65 2066 726f 6d20 7468 6520  he one from the 
-0001e040: 666f 7277 6172 6420 6d65 7461 2074 616b  forward meta tak
-0001e050: 6573 0a20 2020 2020 2020 2020 2020 2023  es.            #
-0001e060: 2070 7265 6365 6465 6e63 652e 0a20 2020   precedence..   
-0001e070: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
-0001e080: 286b 2c20 7629 2069 6e20 656e 756d 6572  (k, v) in enumer
-0001e090: 6174 6528 696e 7370 6563 742e 7369 676e  ate(inspect.sign
-0001e0a0: 6174 7572 6528 7379 6d62 6f6c 2e73 796d  ature(symbol.sym
-0001e0b0: 2e6d 6574 6129 2e70 6172 616d 6574 6572  .meta).parameter
-0001e0c0: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
-0001e0d0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0001e0e0: 2e6b 696e 6420 696e 2028 696e 7370 6563  .kind in (inspec
-0001e0f0: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
-0001e100: 5449 4f4e 414c 5f4f 4e4c 592c 2069 6e73  TIONAL_ONLY, ins
-0001e110: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
-0001e120: 4f53 4954 494f 4e41 4c5f 4f52 5f4b 4559  OSITIONAL_OR_KEY
-0001e130: 574f 5244 293a 0a20 2020 2020 2020 2020  WORD):.         
-0001e140: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
-0001e150: 6e6f 7420 696e 2075 7365 645f 6e61 6d65  not in used_name
-0001e160: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001e170: 2020 2020 2020 2020 2020 2070 7574 5f67             put_g
-0001e180: 7261 6428 7379 6d62 6f6c 2e61 7267 735b  rad(symbol.args[
-0001e190: 695d 2c20 7265 7375 6c74 2e67 6574 286b  i], result.get(k
-0001e1a0: 2c20 4e6f 6e65 2929 0a20 2020 2020 2020  , None)).       
-0001e1b0: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-0001e1c0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0001e1d0: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
-0001e1e0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0001e1f0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0001e200: 2028 7265 7375 6c74 2c29 0a0a 2020 2020   (result,)..    
-0001e210: 2020 2020 6465 6620 6973 5f64 6966 6665      def is_diffe
-0001e220: 7265 6e74 6961 626c 6528 6172 6729 3a0a  rentiable(arg):.
-0001e230: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-0001e240: 6820 6172 673a 0a20 2020 2020 2020 2020  h arg:.         
-0001e250: 2020 2020 2020 2063 6173 6520 5465 6e73         case Tens
-0001e260: 6f72 5072 6f78 7928 293a 0a20 2020 2020  orProxy():.     
-0001e270: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001e280: 6574 7572 6e20 6474 7970 6573 2e69 735f  eturn dtypes.is_
-0001e290: 696e 6578 6163 745f 6474 7970 6528 6172  inexact_dtype(ar
-0001e2a0: 672e 6474 7970 6529 0a20 2020 2020 2020  g.dtype).       
-0001e2b0: 2020 2020 2020 2020 2063 6173 6520 5365           case Se
-0001e2c0: 7175 656e 6365 2829 3a0a 2020 2020 2020  quence():.      
-0001e2d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001e2e0: 7475 726e 2061 7267 2061 6e64 2061 6c6c  turn arg and all
-0001e2f0: 2869 7369 6e73 7461 6e63 6528 782c 2054  (isinstance(x, T
-0001e300: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
-0001e310: 6474 7970 6573 2e69 735f 696e 6578 6163  dtypes.is_inexac
-0001e320: 745f 6474 7970 6528 782e 6474 7970 6529  t_dtype(x.dtype)
-0001e330: 2066 6f72 2078 2069 6e20 6172 6729 0a20   for x in arg). 
-0001e340: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e350: 6173 6520 5f3a 0a20 2020 2020 2020 2020  ase _:.         
-0001e360: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001e370: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-0001e380: 2069 6620 6c65 6e28 7379 6d62 6f6c 2e61   if len(symbol.a
-0001e390: 7267 7329 2021 3d20 286f 7269 675f 7265  rgs) != (orig_re
-0001e3a0: 735f 6c65 6e20 3a3d 206c 656e 2872 6573  s_len := len(res
-0001e3b0: 756c 7429 293a 0a20 2020 2020 2020 2020  ult)):.         
-0001e3c0: 2020 2063 6865 636b 280a 2020 2020 2020     check(.      
-0001e3d0: 2020 2020 2020 2020 2020 6f72 6967 5f72            orig_r
-0001e3e0: 6573 5f6c 656e 203c 3d20 6c65 6e28 7379  es_len <= len(sy
-0001e3f0: 6d62 6f6c 2e61 7267 7329 2c0a 2020 2020  mbol.args),.    
-0001e400: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-0001e410: 6461 3a20 6622 4261 636b 7761 7264 2066  da: f"Backward f
-0001e420: 6f72 207b 7379 6d62 6f6c 2e73 796d 2e69  or {symbol.sym.i
-0001e430: 647d 2072 6574 7572 6e65 6420 7b6f 7269  d} returned {ori
-0001e440: 675f 7265 735f 6c65 6e7d 2076 616c 7565  g_res_len} value
-0001e450: 732c 2022 0a20 2020 2020 2020 2020 2020  s, ".           
-0001e460: 2020 2020 202b 2066 2262 7574 2065 7870       + f"but exp
-0001e470: 6563 7465 6420 6174 206d 6f73 7420 7b6c  ected at most {l
-0001e480: 656e 2873 796d 626f 6c2e 6172 6773 297d  en(symbol.args)}
-0001e490: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
-0001e4a0: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-0001e4b0: 7373 756d 696e 6720 7468 6174 2074 6865  ssuming that the
-0001e4c0: 206e 6f6e 2d64 6966 6665 7265 6e74 6961   non-differentia
-0001e4d0: 626c 6520 6172 6775 6d65 6e74 7320 7765  ble arguments we
-0001e4e0: 7265 2064 726f 7070 6564 2066 726f 6d0a  re dropped from.
-0001e4f0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-0001e500: 6520 6261 636b 7761 7264 2066 756e 6374  e backward funct
-0001e510: 696f 6e2c 2077 6520 6172 6520 676f 696e  ion, we are goin
-0001e520: 6720 746f 2061 7070 656e 6420 4e6f 6e65  g to append None
-0001e530: 2074 6f20 7468 6520 7265 7375 6c74 0a20   to the result. 
-0001e540: 2020 2020 2020 2020 2020 2023 2074 6f20             # to 
-0001e550: 6d61 7463 6820 7468 6520 6e75 6d62 6572  match the number
-0001e560: 206f 6620 6172 6775 6d65 6e74 732e 2041   of arguments. A
-0001e570: 6c74 6572 6e61 7469 7665 6c79 2c20 7765  lternatively, we
-0001e580: 2063 6f75 6c64 206a 7573 740a 2020 2020   could just.    
-0001e590: 2020 2020 2020 2020 2320 6861 7665 2061          # have a
-0001e5a0: 2066 6f72 2d6c 6f6f 7020 7769 7468 2061   for-loop with a
-0001e5b0: 2063 6f6e 6469 7469 6f6e 616c 2077 6865   conditional whe
-0001e5c0: 6e20 7772 6974 696e 6720 746f 2074 6865  n writing to the
-0001e5d0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-0001e5e0: 6e76 6972 6f6e 6d65 6e74 2e0a 0a20 2020  nvironment...   
-0001e5f0: 2020 2020 2020 2020 2069 7465 725f 7265           iter_re
-0001e600: 7375 6c74 203d 2069 7465 7228 7265 7375  sult = iter(resu
-0001e610: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-0001e620: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
-0001e630: 5f61 7267 7320 3d20 7375 6d28 626f 6f6c  _args = sum(bool
-0001e640: 2869 735f 6469 6666 6572 656e 7469 6162  (is_differentiab
-0001e650: 6c65 2861 7267 2929 2066 6f72 2061 7267  le(arg)) for arg
-0001e660: 2069 6e20 7379 6d62 6f6c 2e61 7267 7329   in symbol.args)
-0001e670: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-0001e680: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
-0001e690: 2020 2020 6e5f 6469 6666 6572 656e 7469      n_differenti
-0001e6a0: 6162 6c65 5f61 7267 7320 3c3d 206f 7269  able_args <= ori
-0001e6b0: 675f 7265 735f 6c65 6e2c 0a20 2020 2020  g_res_len,.     
-0001e6c0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-0001e6d0: 613a 2066 2242 6163 6b77 6172 6420 666f  a: f"Backward fo
-0001e6e0: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
-0001e6f0: 7d20 7265 7475 726e 6564 207b 6f72 6967  } returned {orig
-0001e700: 5f72 6573 5f6c 656e 7d20 7661 6c75 6528  _res_len} value(
-0001e710: 7329 2c20 220a 2020 2020 2020 2020 2020  s), ".          
-0001e720: 2020 2020 2020 2b20 6622 6275 7420 6578        + f"but ex
-0001e730: 7065 6374 6564 207b 6e5f 6469 6666 6572  pected {n_differ
-0001e740: 656e 7469 6162 6c65 5f61 7267 737d 222c  entiable_args}",
-0001e750: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0001e760: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-0001e770: 6c74 203d 2074 7570 6c65 286e 6578 7428  lt = tuple(next(
-0001e780: 6974 6572 5f72 6573 756c 7429 2069 6620  iter_result) if 
-0001e790: 6973 5f64 6966 6665 7265 6e74 6961 626c  is_differentiabl
-0001e7a0: 6528 6172 6729 2065 6c73 6520 4e6f 6e65  e(arg) else None
-0001e7b0: 2066 6f72 2061 7267 2069 6e20 7379 6d62   for arg in symb
-0001e7c0: 6f6c 2e61 7267 7329 0a0a 2020 2020 2020  ol.args)..      
-0001e7d0: 2020 2320 5365 6520 2242 6163 6b77 6172    # See "Backwar
-0001e7e0: 6420 696d 706c 2066 6f72 206f 7073 206f  d impl for ops o
-0001e7f0: 6620 7468 6520 7479 7065 2053 6571 7565  f the type Seque
-0001e800: 6e63 655b 5465 6e73 6f72 5072 6f78 795d  nce[TensorProxy]
-0001e810: 2c20 2e2e 2e20 2d3e 202e 2e2e 2072 6573  , ... -> ... res
-0001e820: 756c 7473 2069 6e20 4e6f 6e65 2067 7261  ults in None gra
-0001e830: 6473 2e22 0a20 2020 2020 2020 2023 2054  ds.".        # T
-0001e840: 6869 7320 6973 2061 2074 656d 706f 7261  his is a tempora
-0001e850: 7279 2077 6f72 6b61 726f 756e 642e 0a20  ry workaround.. 
-0001e860: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
-0001e870: 2e73 796d 2e69 6420 696e 2028 7072 696d  .sym.id in (prim
-0001e880: 732e 5072 696d 4944 732e 4341 542c 2022  s.PrimIDs.CAT, "
-0001e890: 746f 7263 682e 6361 7422 2c20 2274 6f72  torch.cat", "tor
-0001e8a0: 6368 2e73 7461 636b 2229 3a0a 2020 2020  ch.stack"):.    
-0001e8b0: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
-0001e8c0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
-0001e8d0: 7379 6d62 6f6c 2e61 7267 732c 2072 6573  symbol.args, res
-0001e8e0: 756c 7429 0a20 2020 2020 2020 2065 6c73  ult).        els
-0001e8f0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0001e900: 6166 655f 6d61 7028 7075 745f 6772 6164  afe_map(put_grad
-0001e910: 2c20 7379 6d62 6f6c 2e61 7267 732c 2072  , symbol.args, r
-0001e920: 6573 756c 7429 0a0a 2020 2020 6465 6620  esult)..    def 
-0001e930: 6765 745f 696e 6578 6163 745f 6474 7970  get_inexact_dtyp
-0001e940: 655f 6f72 5f6e 6f6e 6528 7829 3a0a 2020  e_or_none(x):.  
-0001e950: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001e960: 6e63 6528 782c 2028 5465 6e73 6f72 5072  nce(x, (TensorPr
-0001e970: 6f78 792c 2046 7574 7572 6554 656e 736f  oxy, FutureTenso
-0001e980: 7250 726f 7879 2929 2061 6e64 2064 7479  rProxy)) and dty
-0001e990: 7065 732e 6973 5f69 6e65 7861 6374 5f64  pes.is_inexact_d
-0001e9a0: 7479 7065 2878 2e64 7479 7065 293a 0a20  type(x.dtype):. 
-0001e9b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001e9c0: 6e20 780a 2020 2020 2020 2020 656c 7365  n x.        else
-0001e9d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001e9e0: 7475 726e 204e 6f6e 650a 0a20 2020 2067  turn None..    g
-0001e9f0: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
-0001ea00: 6765 745f 6772 6164 2c20 7475 706c 6528  get_grad, tuple(
-0001ea10: 7472 6163 652e 6172 6773 2929 0a20 2020  trace.args)).   
-0001ea20: 2067 6b77 6172 6773 203d 2074 7265 655f   gkwargs = tree_
-0001ea30: 6d61 7028 6765 745f 6772 6164 2c20 7472  map(get_grad, tr
-0001ea40: 6163 652e 6b77 6172 6773 290a 2020 2020  ace.kwargs).    
-0001ea50: 676b 7761 7267 7320 3d20 7b6b 3a20 7620  gkwargs = {k: v 
-0001ea60: 666f 7220 6b2c 2076 2069 6e20 676b 7761  for k, v in gkwa
-0001ea70: 7267 732e 6974 656d 7328 2920 6966 2076  rgs.items() if v
-0001ea80: 2069 7320 6e6f 7420 4e6f 6e65 7d0a 2020   is not None}.  
-0001ea90: 2020 6761 7267 732c 2067 6b77 6172 6773    gargs, gkwargs
-0001eaa0: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
-0001eab0: 696e 6578 6163 745f 6474 7970 655f 6f72  inexact_dtype_or
-0001eac0: 5f6e 6f6e 652c 2028 6761 7267 732c 2067  _none, (gargs, g
-0001ead0: 6b77 6172 6773 2929 0a20 2020 2072 6574  kwargs)).    ret
-0001eae0: 7572 6e20 6761 7267 7320 2b20 2867 6b77  urn gargs + (gkw
-0001eaf0: 6172 6773 2c29 2069 6620 6c65 6e28 676b  args,) if len(gk
-0001eb00: 7761 7267 7329 2021 3d20 3020 656c 7365  wargs) != 0 else
-0001eb10: 2067 6172 6773 0a0a 0a64 6566 2076 6a70   gargs...def vjp
-0001eb20: 5f63 616c 6c5f 6d65 7461 6675 6e63 2864  _call_metafunc(d
-0001eb30: 6574 6163 6865 643a 2062 6f6f 6c2c 2070  etached: bool, p
-0001eb40: 7269 6d61 6c73 2c20 636f 7461 6e67 656e  rimals, cotangen
-0001eb50: 7473 2c20 7472 6163 653a 2054 7261 6365  ts, trace: Trace
-0001eb60: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001eb70: 2023 2041 7373 756d 696e 6720 7072 696d   # Assuming prim
-0001eb80: 616c 7320 6973 2066 6c61 740a 0a20 2020  als is flat..   
-0001eb90: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-0001eba0: 6365 2870 7269 6d61 6c73 2c20 5365 7175  ce(primals, Sequ
-0001ebb0: 656e 6365 293a 0a20 2020 2020 2020 2070  ence):.        p
-0001ebc0: 7269 6d61 6c73 203d 2028 7072 696d 616c  rimals = (primal
-0001ebd0: 732c 290a 0a20 2020 2063 7478 203d 2064  s,)..    ctx = d
-0001ebe0: 6574 6163 6865 645f 7472 6163 6528 2920  etached_trace() 
-0001ebf0: 6966 2064 6574 6163 6865 6420 656c 7365  if detached else
-0001ec00: 206e 756c 6c63 6f6e 7465 7874 2829 0a20   nullcontext(). 
-0001ec10: 2020 2077 6974 6820 6374 783a 0a20 2020     with ctx:.   
-0001ec20: 2020 2020 2072 6573 756c 742c 2065 6e76       result, env
-0001ec30: 203d 2061 7567 6d65 6e74 6564 5f66 6f72   = augmented_for
-0001ec40: 7761 7264 5f70 6173 7328 2a70 7269 6d61  ward_pass(*prima
-0001ec50: 6c73 2c20 7472 6163 653d 7472 6163 652c  ls, trace=trace,
-0001ec60: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-0001ec70: 2020 2063 6865 636b 280a 2020 2020 2020     check(.      
-0001ec80: 2020 2020 2020 6c65 6e28 7265 7375 6c74        len(result
-0001ec90: 2920 3d3d 206c 656e 2863 6f74 616e 6765  ) == len(cotange
-0001eca0: 6e74 7329 2069 6620 6973 696e 7374 616e  nts) if isinstan
-0001ecb0: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
-0001ecc0: 6e63 6529 2065 6c73 6520 5472 7565 2c0a  nce) else True,.
-0001ecd0: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-0001ece0: 6461 3a20 6622 4578 7065 6374 6564 2063  da: f"Expected c
-0001ecf0: 6f74 616e 6765 6e74 7320 746f 2062 6520  otangents to be 
-0001ed00: 6120 7365 7175 656e 6365 206f 6620 6c65  a sequence of le
-0001ed10: 6e67 7468 207b 6c65 6e28 7265 7375 6c74  ngth {len(result
-0001ed20: 297d 2c20 676f 7420 6120 7365 7175 656e  )}, got a sequen
-0001ed30: 6365 206f 6620 6c65 6e67 7468 207b 6c65  ce of length {le
-0001ed40: 6e28 636f 7461 6e67 656e 7473 297d 222c  n(cotangents)}",
-0001ed50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001ed60: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0001ed70: 2c20 6261 636b 7761 7264 5f70 6173 7328  , backward_pass(
-0001ed80: 656e 762c 2074 7261 6365 2c20 636f 7461  env, trace, cota
-0001ed90: 6e67 656e 7473 290a 0a0a 2320 544f 444f  ngents)...# TODO
-0001eda0: 3a20 4361 6e27 7420 7573 6520 6120 5379  : Can't use a Sy
-0001edb0: 6d62 6f6c 2068 6572 6520 6265 6361 7573  mbol here becaus
-0001edc0: 6520 6d69 7865 6420 6578 6563 7574 6f72  e mixed executor
-0001edd0: 2073 7962 7379 6d62 6f6c 7320 7365 656d   sybsymbols seem
-0001ede0: 2074 6f20 6265 0a23 2075 6e73 7570 706f   to be.# unsuppo
-0001edf0: 7274 6564 2e20 5365 6520 6973 7375 6520  rted. See issue 
-0001ee00: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
-0001ee10: 616e 2065 7865 6375 746f 7220 666f 7220  an executor for 
-0001ee20: 626f 756e 6420 7379 6d62 6f6c 2077 6865  bound symbol whe
-0001ee30: 6e20 6974 7320 7375 6273 796d 626f 6c73  n its subsymbols
-0001ee40: 0a23 2061 7265 206e 6f74 2066 756c 6c79  .# are not fully
-0001ee50: 2073 7570 706f 7274 6564 2062 7920 6120   supported by a 
-0001ee60: 7369 6e67 6c65 2065 7865 6375 746f 7222  single executor"
-0001ee70: 0a76 6a70 5f63 616c 6c20 3d20 7061 7274  .vjp_call = part
-0001ee80: 6961 6c28 0a20 2020 2076 6a70 5f63 616c  ial(.    vjp_cal
-0001ee90: 6c5f 6d65 7461 6675 6e63 2c20 4661 6c73  l_metafunc, Fals
-0001eea0: 650a 2920 2023 2053 796d 626f 6c28 6964  e.)  # Symbol(id
-0001eeb0: 3d54 7261 6e73 666f 726d 732e 566a 704f  =Transforms.VjpO
-0001eec0: 702c 206e 616d 653d 2276 6a70 5f63 616c  p, name="vjp_cal
-0001eed0: 6c22 2c20 6d65 7461 3d70 6172 7469 616c  l", meta=partial
-0001eee0: 2876 6a70 5f63 616c 6c5f 6d65 7461 6675  (vjp_call_metafu
-0001eef0: 6e63 2c20 4661 6c73 6529 290a 0a0a 6465  nc, False))...de
-0001ef00: 6620 766a 7028 6675 6e63 293a 0a20 2020  f vjp(func):.   
-0001ef10: 2022 2222 436f 6d70 7574 6573 2074 6865   """Computes the
-0001ef20: 2056 4a50 206f 6620 6120 6675 6e63 7469   VJP of a functi
-0001ef30: 6f6e 2e0a 0a20 2020 2041 7267 733a 0a20  on...    Args:. 
-0001ef40: 2020 2020 2020 2066 756e 6320 2843 616c         func (Cal
-0001ef50: 6c61 626c 6529 3a20 4675 6e63 7469 6f6e  lable): Function
-0001ef60: 2074 6f20 6265 2064 6966 6665 7265 6e74   to be different
-0001ef70: 6961 7465 642e 0a20 2020 2022 2222 0a0a  iated..    """..
-0001ef80: 2020 2020 6465 6620 5f76 6a70 2870 7269      def _vjp(pri
-0001ef90: 6d61 6c73 2c20 636f 7461 6e67 656e 7473  mals, cotangents
-0001efa0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001efb0: 2020 2020 2066 6c61 745f 6675 6e63 2c20       flat_func, 
-0001efc0: 666c 6174 5f61 7267 732c 2073 7065 6320  flat_args, spec 
-0001efd0: 3d20 666c 6174 7465 6e5f 6675 6e63 2866  = flatten_func(f
-0001efe0: 756e 632c 2070 7269 6d61 6c73 2c20 6b77  unc, primals, kw
-0001eff0: 6172 6773 290a 2020 2020 2020 2020 7472  args).        tr
-0001f000: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-0001f010: 7472 6163 6528 2928 666c 6174 5f66 756e  trace()(flat_fun
-0001f020: 632c 202a 666c 6174 5f61 7267 7329 0a20  c, *flat_args). 
-0001f030: 2020 2020 2020 2072 6573 756c 742c 2076         result, v
-0001f040: 6a70 5f72 6573 756c 7420 3d20 766a 705f  jp_result = vjp_
-0001f050: 6361 6c6c 2866 6c61 745f 6172 6773 2c20  call(flat_args, 
-0001f060: 636f 7461 6e67 656e 7473 2c20 7472 6163  cotangents, trac
-0001f070: 653d 7472 6163 6529 0a20 2020 2020 2020  e=trace).       
-0001f080: 2067 7072 696d 616c 732c 2067 6b77 6172   gprimals, gkwar
-0001f090: 6773 203d 2074 7265 655f 756e 666c 6174  gs = tree_unflat
-0001f0a0: 7465 6e28 766a 705f 7265 7375 6c74 2c20  ten(vjp_result, 
-0001f0b0: 7370 6563 290a 2020 2020 2020 2020 6772  spec).        gr
-0001f0c0: 6164 7320 3d20 6770 7269 6d61 6c73 202b  ads = gprimals +
-0001f0d0: 2028 676b 7761 7267 732c 2920 6966 206c   (gkwargs,) if l
-0001f0e0: 656e 2867 6b77 6172 6773 2920 213d 2030  en(gkwargs) != 0
-0001f0f0: 2065 6c73 6520 6770 7269 6d61 6c73 0a20   else gprimals. 
-0001f100: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0001f110: 7375 6c74 2c20 6772 6164 730a 0a20 2020  sult, grads..   
-0001f120: 2072 6574 7572 6e20 5f76 6a70 0a0a 0a64   return _vjp...d
-0001f130: 6566 2076 616c 7565 5f61 6e64 5f67 7261  ef value_and_gra
-0001f140: 6428 6675 6e63 293a 0a20 2020 2022 2222  d(func):.    """
-0001f150: 436f 6d70 7574 6573 2074 6865 2076 616c  Computes the val
-0001f160: 7565 2061 6e64 2067 7261 6469 656e 7420  ue and gradient 
-0001f170: 6f66 2061 2066 756e 6374 696f 6e2e 0a0a  of a function...
-0001f180: 2020 2020 5468 6973 2069 7320 6120 636f      This is a co
-0001f190: 6e76 656e 6965 6e63 6520 6675 6e63 7469  nvenience functi
-0001f1a0: 6f6e 2074 6861 7420 636f 6d62 696e 6573  on that combines
-0001f1b0: 2074 6865 2066 756e 6374 696f 6e61 6c69   the functionali
-0001f1c0: 7479 206f 660a 2020 2020 6076 6a70 5f63  ty of.    `vjp_c
-0001f1d0: 616c 6c60 2077 6974 6820 696d 706c 6963  all` with implic
-0001f1e0: 6974 2069 6e69 7469 616c 697a 6174 696f  it initializatio
-0001f1f0: 6e20 6f66 2074 6865 2063 6f74 616e 6765  n of the cotange
-0001f200: 6e74 2074 6f20 312e 0a0a 2020 2020 4172  nt to 1...    Ar
-0001f210: 6773 3a0a 2020 2020 2020 2020 6675 6e63  gs:.        func
-0001f220: 2028 4361 6c6c 6162 6c65 293a 2046 756e   (Callable): Fun
-0001f230: 6374 696f 6e20 746f 2062 6520 6469 6666  ction to be diff
-0001f240: 6572 656e 7469 6174 6564 2e0a 2020 2020  erentiated..    
-0001f250: 2222 220a 0a20 2020 2064 6566 206f 6e65  """..    def one
-0001f260: 735f 6c69 6b65 2878 293a 0a20 2020 2020  s_like(x):.     
-0001f270: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0001f280: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
-0001f290: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001f2a0: 7475 726e 2066 756c 6c5f 6c69 6b65 2878  turn full_like(x
-0001f2b0: 2c20 6669 6c6c 5f76 616c 7565 3d31 290a  , fill_value=1).
-0001f2c0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001f2d0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-0001f2e0: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
-0001f2f0: 2020 2020 2072 6574 7572 6e20 7479 7065       return type
-0001f300: 2878 2e76 616c 7565 2928 3129 0a20 2020  (x.value)(1).   
-0001f310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001f320: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0001f330: 6e65 0a0a 2020 2020 6465 6620 5f76 616c  ne..    def _val
-0001f340: 7565 5f61 6e64 5f67 7261 6428 2a61 7267  ue_and_grad(*arg
-0001f350: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0001f360: 2020 2020 2020 7472 6163 6520 3d20 636f        trace = co
-0001f370: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-0001f380: 6675 6e63 2c20 2a61 7267 732c 202a 2a6b  func, *args, **k
-0001f390: 7761 7267 7329 0a20 2020 2020 2020 2063  wargs).        c
-0001f3a0: 6f74 616e 6765 6e74 7320 3d20 7472 6565  otangents = tree
-0001f3b0: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
-0001f3c0: 6e65 735f 6c69 6b65 2876 292c 2074 7261  nes_like(v), tra
-0001f3d0: 6365 2e6f 7574 7075 7429 0a20 2020 2020  ce.output).     
-0001f3e0: 2020 2072 6574 7572 6e20 766a 7028 6675     return vjp(fu
-0001f3f0: 6e63 2928 6172 6773 2c20 636f 7461 6e67  nc)(args, cotang
-0001f400: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
-0001f410: 0a20 2020 2072 6574 7572 6e20 5f76 616c  .    return _val
-0001f420: 7565 5f61 6e64 5f67 7261 640a 0a0a 466f  ue_and_grad...Fo
-0001f430: 7277 6172 6442 6163 6b77 6172 6454 7261  rwardBackwardTra
-0001f440: 6365 7320 3d20 6e61 6d65 6474 7570 6c65  ces = namedtuple
-0001f450: 2822 466f 7277 6172 6442 6163 6b77 6172  ("ForwardBackwar
-0001f460: 6454 7261 6365 7322 2c20 5b22 666f 7277  dTraces", ["forw
-0001f470: 6172 645f 7472 6163 6522 2c20 2262 6163  ard_trace", "bac
-0001f480: 6b77 6172 645f 7472 6163 6522 5d29 0a0a  kward_trace"])..
-0001f490: 0a64 6566 205f 7370 6c69 745f 7361 7665  .def _split_save
-0001f4a0: 645f 666f 725f 6261 636b 7761 7264 5f69  d_for_backward_i
-0001f4b0: 6e74 6f5f 7465 6e73 6f72 735f 616e 645f  nto_tensors_and_
-0001f4c0: 6f74 6865 7228 0a20 2020 2073 6176 6564  other(.    saved
-0001f4d0: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
-0001f4e0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f4f0: 5d2c 0a29 202d 3e20 7475 706c 655b 5365  ],.) -> tuple[Se
-0001f500: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
-0001f510: 2c20 5365 7175 656e 6365 5b56 6172 6961  , Sequence[Varia
-0001f520: 626c 655d 5d3a 0a20 2020 2022 2222 5370  ble]]:.    """Sp
-0001f530: 6c69 7473 2073 6176 6564 5f66 6f72 5f62  lits saved_for_b
-0001f540: 6163 6b77 6172 6420 696e 746f 2074 656e  ackward into ten
-0001f550: 736f 7273 2061 6e64 206f 7468 6572 2e0a  sors and other..
-0001f560: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001f570: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-0001f580: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
-0001f590: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
-0001f5a0: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
-0001f5b0: 6f20 7370 6c69 742e 0a0a 2020 2020 5265  o split...    Re
-0001f5c0: 7475 726e 733a 0a20 2020 2020 2020 2074  turns:.        t
-0001f5d0: 7570 6c65 5b53 6571 7565 6e63 655b 5661  uple[Sequence[Va
-0001f5e0: 7269 6162 6c65 5d2c 2053 6571 7565 6e63  riable], Sequenc
-0001f5f0: 655b 5661 7269 6162 6c65 5d5d 3a20 5475  e[Variable]]: Tu
-0001f600: 706c 6520 6f66 2074 656e 736f 7273 2061  ple of tensors a
-0001f610: 6e64 206f 7468 6572 2e0a 2020 2020 2222  nd other..    ""
-0001f620: 220a 2020 2020 6973 5f74 656e 736f 7220  ".    is_tensor 
-0001f630: 3d20 6c61 6d62 6461 2078 3a20 6973 696e  = lambda x: isin
-0001f640: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-0001f650: 5072 6f78 7929 0a20 2020 206f 7468 6572  Proxy).    other
-0001f660: 2c20 7465 6e73 6f72 7320 3d20 7574 696c  , tensors = util
-0001f670: 732e 7061 7274 6974 696f 6e28 6973 5f74  s.partition(is_t
-0001f680: 656e 736f 722c 2073 6176 6564 5f66 6f72  ensor, saved_for
-0001f690: 5f62 6163 6b77 6172 6429 0a20 2020 2072  _backward).    r
-0001f6a0: 6574 7572 6e20 7475 706c 6528 7465 6e73  eturn tuple(tens
-0001f6b0: 6f72 7329 2c20 7475 706c 6528 6f74 6865  ors), tuple(othe
-0001f6c0: 7229 0a0a 0a64 6566 205f 7570 6461 7465  r)...def _update
-0001f6d0: 5f66 6f72 7761 7264 5f77 6974 685f 6e65  _forward_with_ne
-0001f6e0: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
-0001f6f0: 7761 7264 2866 6f72 7761 7264 5f74 7261  ward(forward_tra
-0001f700: 6365 3a20 5472 6163 652c 2073 6176 6564  ce: Trace, saved
-0001f710: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
-0001f720: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f730: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
-0001f740: 2222 2255 7064 6174 6573 2074 6865 2066  """Updates the f
-0001f750: 6f72 7761 7264 2074 7261 6365 2077 6974  orward trace wit
-0001f760: 6820 6e65 7720 7361 7665 645f 666f 725f  h new saved_for_
-0001f770: 6261 636b 7761 7264 2e0a 0a20 2020 2054  backward...    T
-0001f780: 6869 7320 6973 206e 6563 6573 7361 7279  his is necessary
-0001f790: 2062 6563 6175 7365 2074 6865 2075 7064   because the upd
-0001f7a0: 6174 6564 2073 6176 6564 5f66 6f72 5f62  ated saved_for_b
-0001f7b0: 6163 6b77 6172 6420 6973 206e 6f74 2061  ackward is not a
-0001f7c0: 7661 696c 6162 6c65 0a20 2020 2077 6865  vailable.    whe
-0001f7d0: 6e20 7468 6520 666f 7277 6172 6420 616e  n the forward an
-0001f7e0: 6420 6261 636b 7761 7264 2074 7261 6365  d backward trace
-0001f7f0: 7320 6172 6520 636f 6e73 7472 7563 7465  s are constructe
-0001f800: 642e 0a0a 2020 2020 4172 6773 3a0a 2020  d...    Args:.  
-0001f810: 2020 2020 2020 666f 7277 6172 645f 7472        forward_tr
-0001f820: 6163 6520 2854 7261 6365 293a 2046 6f72  ace (Trace): For
-0001f830: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
-0001f840: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
-0001f850: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f860: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
-0001f870: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
-0001f880: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
-0001f890: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-0001f8a0: 7570 6461 7465 2074 6865 2066 6f72 7761  update the forwa
-0001f8b0: 7264 2074 7261 6365 2e0a 2020 2020 2222  rd trace..    ""
-0001f8c0: 220a 2020 2020 7361 7665 645f 666f 725f  ".    saved_for_
-0001f8d0: 6261 636b 7761 7264 203d 2074 7265 655f  backward = tree_
-0001f8e0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-0001f8f0: 7661 6c75 6520 6966 2069 7369 6e73 7461  value if isinsta
-0001f900: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
-0001f910: 7879 2920 656c 7365 2078 2c20 7361 7665  xy) else x, save
-0001f920: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
-0001f930: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
-0001f940: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
-0001f950: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
-0001f960: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
-0001f970: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
-0001f980: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
-0001f990: 7761 7264 290a 2020 2020 6173 7365 7274  ward).    assert
-0001f9a0: 2066 6f72 7761 7264 5f74 7261 6365 2e62   forward_trace.b
-0001f9b0: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
-0001f9c0: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
-0001f9d0: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
-0001f9e0: 2020 2020 6e65 775f 7265 7475 726e 203d      new_return =
-0001f9f0: 2028 666f 7277 6172 645f 7472 6163 652e   (forward_trace.
-0001fa00: 6f75 7470 7574 5b30 5d2c 2028 7361 7665  output[0], (save
-0001fa10: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
-0001fa20: 5f6f 7468 6572 2929 0a20 2020 2066 6f72  _other)).    for
-0001fa30: 7761 7264 5f74 7261 6365 2e62 6f75 6e64  ward_trace.bound
-0001fa40: 5f73 796d 626f 6c73 5b2d 315d 203d 2072  _symbols[-1] = r
-0001fa50: 6570 6c61 6365 2866 6f72 7761 7264 5f74  eplace(forward_t
-0001fa60: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001fa70: 6c73 5b2d 315d 2c20 6172 6773 3d6e 6577  ls[-1], args=new
-0001fa80: 5f72 6574 7572 6e29 0a0a 0a64 6566 205f  _return)...def _
-0001fa90: 7570 6461 7465 5f62 6163 6b77 6172 645f  update_backward_
-0001faa0: 7769 7468 5f6e 6577 5f73 6176 6564 5f66  with_new_saved_f
-0001fab0: 6f72 5f62 6163 6b77 6172 6428 6261 636b  or_backward(back
-0001fac0: 7761 7264 5f74 7261 6365 3a20 5472 6163  ward_trace: Trac
-0001fad0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001fae0: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
-0001faf0: 5661 7269 6162 6c65 5d29 202d 3e20 4e6f  Variable]) -> No
-0001fb00: 6e65 3a0a 2020 2020 2222 2255 7064 6174  ne:.    """Updat
-0001fb10: 6573 2074 6865 2062 6163 6b77 6172 6420  es the backward 
-0001fb20: 7472 6163 6520 7769 7468 206e 6577 2073  trace with new s
-0001fb30: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001fb40: 642e 0a0a 2020 2020 5468 6973 2069 7320  d...    This is 
-0001fb50: 6e65 6365 7373 6172 7920 6265 6361 7573  necessary becaus
-0001fb60: 6520 7468 6520 7570 6461 7465 6420 7361  e the updated sa
-0001fb70: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001fb80: 2069 730a 2020 2020 6e6f 7420 6176 6169   is.    not avai
-0001fb90: 6c61 626c 6520 7768 656e 2074 6865 2062  lable when the b
-0001fba0: 6163 6b77 6172 6420 7472 6163 6520 6973  ackward trace is
-0001fbb0: 2063 6f6e 7374 7275 6374 6564 2e0a 0a20   constructed... 
-0001fbc0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001fbd0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
-0001fbe0: 2854 7261 6365 293a 2042 6163 6b77 6172  (Trace): Backwar
-0001fbf0: 6420 7472 6163 6520 746f 2075 7064 6174  d trace to updat
-0001fc00: 652e 0a20 2020 2020 2020 2073 6176 6564  e..        saved
-0001fc10: 5f66 6f72 5f62 6163 6b77 6172 6420 2853  _for_backward (S
-0001fc20: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001fc30: 5d29 3a20 5361 7665 645f 666f 725f 6261  ]): Saved_for_ba
-0001fc40: 636b 7761 7264 2074 6f20 7573 6520 746f  ckward to use to
-0001fc50: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
-0001fc60: 6174 6520 7468 6520 6261 636b 7761 7264  ate the backward
-0001fc70: 2074 7261 6365 2e0a 2020 2020 2222 220a   trace..    """.
-0001fc80: 0a20 2020 2064 6566 2075 6e70 6163 6b69  .    def unpacki
-0001fc90: 6e67 5f66 6e28 7361 7665 645f 666f 725f  ng_fn(saved_for_
-0001fca0: 6261 636b 7761 7264 2c20 636f 7461 6e67  backward, cotang
-0001fcb0: 656e 7473 293a 0a20 2020 2020 2020 2070  ents):.        p
-0001fcc0: 6173 730a 0a20 2020 2063 6f74 616e 6765  ass..    cotange
-0001fcd0: 6e74 7320 3d20 6261 636b 7761 7264 5f74  nts = backward_t
-0001fce0: 7261 6365 2e61 7267 735b 315d 0a20 2020  race.args[1].   
-0001fcf0: 2073 6176 6564 5f74 656e 736f 7273 2c20   saved_tensors, 
-0001fd00: 7361 7665 645f 6f74 6865 7220 3d20 5f73  saved_other = _s
-0001fd10: 706c 6974 5f73 6176 6564 5f66 6f72 5f62  plit_saved_for_b
-0001fd20: 6163 6b77 6172 645f 696e 746f 5f74 656e  ackward_into_ten
-0001fd30: 736f 7273 5f61 6e64 5f6f 7468 6572 2873  sors_and_other(s
-0001fd40: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001fd50: 6429 0a20 2020 2075 6e70 6163 6b69 6e67  d).    unpacking
-0001fd60: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
-0001fd70: 6374 5f74 7261 6365 2872 656e 616d 655f  ct_trace(rename_
-0001fd80: 7072 6f78 6965 733d 4661 6c73 652c 2075  proxies=False, u
-0001fd90: 7365 5f64 6365 3d46 616c 7365 2928 0a20  se_dce=False)(. 
-0001fda0: 2020 2020 2020 2075 6e70 6163 6b69 6e67         unpacking
-0001fdb0: 5f66 6e2c 2028 7361 7665 645f 7465 6e73  _fn, (saved_tens
-0001fdc0: 6f72 732c 2073 6176 6564 5f6f 7468 6572  ors, saved_other
-0001fdd0: 292c 2063 6f74 616e 6765 6e74 730a 2020  ), cotangents.  
-0001fde0: 2020 290a 2020 2020 6173 7365 7274 2075    ).    assert u
-0001fdf0: 6e70 6163 6b69 6e67 5f74 7261 6365 2e62  npacking_trace.b
-0001fe00: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
-0001fe10: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
-0001fe20: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
-0001fe30: 0a20 2020 2062 6163 6b77 6172 645f 7472  .    backward_tr
-0001fe40: 6163 652e 6172 6773 203d 2075 6e70 6163  ace.args = unpac
-0001fe50: 6b69 6e67 5f74 7261 6365 2e61 7267 730a  king_trace.args.
-0001fe60: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-0001fe70: 6365 5f62 7379 6d73 5f77 6974 686f 7574  ce_bsyms_without
-0001fe80: 5f75 6e70 6163 6b69 6e67 203d 2028 0a20  _unpacking = (. 
-0001fe90: 2020 2020 2020 2062 7379 6d0a 2020 2020         bsym.    
-0001fea0: 2020 2020 666f 7220 6273 796d 2069 6e20      for bsym in 
-0001feb0: 6261 636b 7761 7264 5f74 7261 6365 2e62  backward_trace.b
-0001fec0: 6f75 6e64 5f73 796d 626f 6c73 0a20 2020  ound_symbols.   
-0001fed0: 2020 2020 2069 6620 6273 796d 2e73 796d       if bsym.sym
-0001fee0: 2e69 640a 2020 2020 2020 2020 6e6f 7420  .id.        not 
-0001fef0: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
-0001ff00: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
-0001ff10: 4e50 4143 4b5f 454d 5054 595f 4449 4354  NPACK_EMPTY_DICT
-0001ff20: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
-0001ff30: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-0001ff40: 434b 5f4b 4559 2c0a 2020 2020 2020 2020  CK_KEY,.        
-0001ff50: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-0001ff60: 732e 554e 5041 434b 5f53 4551 5545 4e43  s.UNPACK_SEQUENC
-0001ff70: 452c 0a20 2020 2020 2020 2020 2020 2070  E,.            p
-0001ff80: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
-0001ff90: 4143 4b5f 5452 4956 4941 4c2c 0a20 2020  ACK_TRIVIAL,.   
-0001ffa0: 2020 2020 2029 0a20 2020 2029 0a20 2020       ).    ).   
-0001ffb0: 2062 6163 6b77 6172 645f 7472 6163 652e   backward_trace.
-0001ffc0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0001ffd0: 6c69 7374 2828 2a75 6e70 6163 6b69 6e67  list((*unpacking
-0001ffe0: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001fff0: 626f 6c73 5b3a 2d31 5d2c 202a 6261 636b  bols[:-1], *back
-00020000: 7761 7264 5f74 7261 6365 5f62 7379 6d73  ward_trace_bsyms
-00020010: 5f77 6974 686f 7574 5f75 6e70 6163 6b69  _without_unpacki
-00020020: 6e67 2929 0a0a 0a23 204e 4f54 453a 2052  ng))...# NOTE: R
-00020030: 6574 7572 6e69 6e67 206e 616d 6564 7475  eturning namedtu
-00020040: 706c 6573 2066 726f 6d20 636f 6d70 696c  ples from compil
-00020050: 6564 2066 756e 6374 696f 6e73 2064 6f65  ed functions doe
-00020060: 736e 2774 2077 6f72 6b2e 2053 6565 3a0a  sn't work. See:.
-00020070: 2320 2241 6c6c 6f77 2072 6574 7572 6e69  # "Allow returni
-00020080: 6e67 206e 616d 6564 7475 706c 6573 2066  ng namedtuples f
-00020090: 726f 6d20 636f 6d70 696c 6564 2066 756e  rom compiled fun
-000200a0: 6374 696f 6e73 220a 2320 4e6f 7465 205b  ctions".# Note [
-000200b0: 4772 6164 2066 6f72 7761 7264 206f 7574  Grad forward out
-000200c0: 7075 7420 7370 6563 5d0a 2320 4966 2069  put spec].# If i
-000200d0: 7420 6469 6420 776f 726b 2069 7420 776f  t did work it wo
-000200e0: 756c 6420 6265 206e 6963 6520 746f 2075  uld be nice to u
-000200f0: 7365 2074 6869 7320 6e61 6d65 6474 7570  se this namedtup
-00020100: 6c65 0a23 2069 6e73 7465 6164 206f 6620  le.# instead of 
-00020110: 7468 6520 706c 6169 6e20 7475 706c 6520  the plain tuple 
-00020120: 6f72 2064 6963 7420 7468 6174 2077 6527  or dict that we'
-00020130: 7265 2075 7369 6e67 206e 6f77 2e0a 546f  re using now..To
-00020140: 7263 6841 7574 6f67 7261 6446 6f72 7761  rchAutogradForwa
-00020150: 7264 4461 7461 203d 206e 616d 6564 7475  rdData = namedtu
-00020160: 706c 6528 0a20 2020 2022 546f 7263 6841  ple(.    "TorchA
-00020170: 7574 6f67 7261 6446 6f72 7761 7264 4461  utogradForwardDa
-00020180: 7461 222c 0a20 2020 205b 226f 7574 7075  ta",.    ["outpu
-00020190: 7422 2c20 2266 6c61 745f 6172 6773 222c  t", "flat_args",
-000201a0: 2022 666c 6174 5f6f 7574 7075 7422 5d2c   "flat_output"],
-000201b0: 0a29 0a0a 0a64 6566 2066 6f72 7761 7264  .)...def forward
-000201c0: 5f61 6e64 5f62 6163 6b77 6172 645f 6672  _and_backward_fr
-000201d0: 6f6d 5f74 7261 6365 2874 7261 6365 3a20  om_trace(trace: 
-000201e0: 5472 6163 652c 2074 6f72 6368 5f61 7574  Trace, torch_aut
-000201f0: 6f67 7261 643d 4661 6c73 6529 202d 3e20  ograd=False) -> 
-00020200: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
-00020210: 7261 6365 733a 0a20 2020 2022 2222 4765  races:.    """Ge
-00020220: 6e65 7261 7465 7320 7468 6520 666f 7277  nerates the forw
-00020230: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-00020240: 2070 6173 7365 7320 6672 6f6d 2061 2074   passes from a t
-00020250: 7261 6365 2e0a 0a20 2020 2054 6869 7320  race...    This 
-00020260: 6973 2061 2063 6f6e 7665 6e69 656e 6365  is a convenience
-00020270: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
-00020280: 6f6d 6269 6e65 7320 7468 6520 6675 6e63  ombines the func
-00020290: 7469 6f6e 616c 6974 7920 6f66 0a20 2020  tionality of.   
-000202a0: 2060 6175 676d 656e 7465 645f 666f 7277   `augmented_forw
-000202b0: 6172 645f 7061 7373 6020 616e 6420 6062  ard_pass` and `b
-000202c0: 6163 6b77 6172 645f 7061 7373 602e 2054  ackward_pass`. T
-000202d0: 6865 206d 6169 6e20 6469 6666 6572 656e  he main differen
-000202e0: 6365 2069 7320 7468 6174 0a20 2020 2074  ce is that.    t
-000202f0: 6869 7320 6675 6e63 7469 6f6e 2064 6f65  his function doe
-00020300: 7320 6e6f 7420 7265 7175 6972 6520 7468  s not require th
-00020310: 6520 7573 6572 2074 6f20 7072 6f76 6964  e user to provid
-00020320: 6520 6e65 7720 696e 7075 7473 2066 6f72  e new inputs for
-00020330: 2074 6865 0a20 2020 2074 7261 6365 2065   the.    trace e
-00020340: 7661 6c75 6174 696f 6e2e 2049 6e73 7465  valuation. Inste
-00020350: 6164 2069 7420 7573 6573 2074 6865 2069  ad it uses the i
-00020360: 6e70 7574 7320 7468 6174 2077 6572 6520  nputs that were 
-00020370: 7573 6564 2074 6f20 636f 6e73 7472 7563  used to construc
-00020380: 740a 2020 2020 7468 6520 7472 6163 652e  t.    the trace.
-00020390: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-000203a0: 2020 2020 7472 6163 6520 2854 7261 6365      trace (Trace
-000203b0: 293a 2054 7261 6365 2074 6f20 6765 6e65  ): Trace to gene
-000203c0: 7261 7465 2074 6865 2066 6f72 7761 7264  rate the forward
-000203d0: 2061 6e64 2062 6163 6b77 6172 6420 7061   and backward pa
-000203e0: 7373 6573 2066 726f 6d2e 0a0a 2020 2020  sses from...    
-000203f0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00020400: 2046 6f72 7761 7264 4261 636b 7761 7264   ForwardBackward
-00020410: 5472 6163 6573 3a20 4120 6e61 6d65 6420  Traces: A named 
-00020420: 7475 706c 6520 636f 6e74 6169 6e69 6e67  tuple containing
-00020430: 2074 6865 2066 6f72 7761 7264 2061 6e64   the forward and
-00020440: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
-00020450: 2020 2020 2020 7472 6163 6573 2e0a 0a20        traces... 
-00020460: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
-00020470: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
-00020480: 6f72 6368 0a20 2020 2020 2020 203e 3e3e  orch.        >>>
-00020490: 2066 726f 6d20 7468 756e 6465 7220 696d   from thunder im
-000204a0: 706f 7274 2063 6f6d 7069 6c65 2c20 6c61  port compile, la
-000204b0: 7374 5f74 7261 6365 730a 2020 2020 2020  st_traces.      
-000204c0: 2020 3e3e 3e20 6672 6f6d 2074 6875 6e64    >>> from thund
-000204d0: 6572 2e63 6f72 652e 7472 616e 7366 6f72  er.core.transfor
-000204e0: 6d73 2069 6d70 6f72 7420 666f 7277 6172  ms import forwar
-000204f0: 645f 616e 645f 6261 636b 7761 7264 5f66  d_and_backward_f
-00020500: 726f 6d5f 7472 6163 650a 2020 2020 2020  rom_trace.      
-00020510: 2020 3e3e 3e20 6465 6620 6628 7829 3a0a    >>> def f(x):.
-00020520: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00020530: 7265 7475 726e 2074 6f72 6368 2e73 696e  return torch.sin
-00020540: 2878 290a 2020 2020 2020 2020 3e3e 3e20  (x).        >>> 
-00020550: 7820 3d20 746f 7263 682e 7465 6e73 6f72  x = torch.tensor
-00020560: 2833 2e30 290a 2020 2020 2020 2020 3e3e  (3.0).        >>
-00020570: 3e20 6366 203d 2063 6f6d 7069 6c65 2866  > cf = compile(f
-00020580: 290a 2020 2020 2020 2020 3e3e 3e20 6f75  ).        >>> ou
-00020590: 7420 3d20 6366 2878 290a 2020 2020 2020  t = cf(x).      
-000205a0: 2020 3e3e 3e20 7472 6163 6520 3d20 6c61    >>> trace = la
-000205b0: 7374 5f74 7261 6365 7328 6366 295b 305d  st_traces(cf)[0]
-000205c0: 0a20 2020 2020 2020 203e 3e3e 2066 6f72  .        >>> for
-000205d0: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
-000205e0: 645f 6672 6f6d 5f74 7261 6365 2874 7261  d_from_trace(tra
-000205f0: 6365 290a 2020 2020 2020 2020 2e2e 2e20  ce).        ... 
-00020600: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
-00020610: 7261 6365 7328 0a20 2020 2020 2020 202e  races(.        .
-00020620: 2e2e 2066 6f72 7761 7264 5f74 7261 6365  .. forward_trace
-00020630: 3d23 2069 6d70 6f72 7420 7468 756e 6465  =# import thunde
-00020640: 7220 6173 2074 6875 6e64 6572 0a20 2020  r as thunder.   
-00020650: 2020 2020 202e 2e2e 2023 2069 6d70 6f72       ... # impor
-00020660: 7420 7468 756e 6465 722e 636f 7265 2e70  t thunder.core.p
-00020670: 7269 6d73 2061 7320 7072 696d 730a 2020  rims as prims.  
-00020680: 2020 2020 2020 2e2e 2e20 696d 706f 7274        ... import
-00020690: 2074 6f72 6368 0a20 2020 2020 2020 202e   torch.        .
-000206a0: 2e2e 0a20 2020 2020 2020 202e 2e2e 2040  ...        ... @
-000206b0: 746f 7263 682e 6e6f 5f67 7261 6428 290a  torch.no_grad().
-000206c0: 2020 2020 2020 2020 2e2e 2e20 6465 6620          ... def 
-000206d0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-000206e0: 645f 666e 282a 6172 6773 293a 0a20 2020  d_fn(*args):.   
-000206f0: 2020 2020 202e 2e2e 2020 2023 2061 7267       ...   # arg
-00020700: 733a 2022 436f 6c6c 6563 7469 6f6e 2220  s: "Collection" 
-00020710: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
-00020720: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
-00020730: 2020 202e 2e2e 2020 2074 302c 205c 0a20     ...   t0, \. 
-00020740: 2020 2020 2020 202e 2e2e 2020 203d 2061         ...   = a
-00020750: 7267 730a 2020 2020 2020 2020 2e2e 2e20  rgs.        ... 
-00020760: 2020 7431 203d 2070 7269 6d73 2e73 696e    t1 = prims.sin
-00020770: 2874 3029 2020 2320 7431 3a20 2263 7075  (t0)  # t1: "cpu
-00020780: 2066 3332 5b5d 220a 2020 2020 2020 2020   f32[]".        
-00020790: 2e2e 2e20 2020 7265 7475 726e 2074 312c  ...   return t1,
-000207a0: 2028 7430 2c29 2c0a 2020 2020 2020 2020   (t0,),.        
-000207b0: 2e2e 2e20 6261 636b 7761 7264 5f74 7261  ... backward_tra
-000207c0: 6365 3d23 2069 6d70 6f72 7420 7468 756e  ce=# import thun
-000207d0: 6465 7220 6173 2074 6875 6e64 6572 0a20  der as thunder. 
-000207e0: 2020 2020 2020 202e 2e2e 2023 2069 6d70         ... # imp
-000207f0: 6f72 7420 7468 756e 6465 722e 636f 7265  ort thunder.core
-00020800: 2e70 7269 6d73 2061 7320 7072 696d 730a  .prims as prims.
-00020810: 2020 2020 2020 2020 2e2e 2e20 696d 706f          ... impo
-00020820: 7274 2074 6f72 6368 0a20 2020 2020 2020  rt torch.       
-00020830: 202e 2e2e 0a20 2020 2020 2020 202e 2e2e   ....        ...
-00020840: 2040 746f 7263 682e 6e6f 5f67 7261 6428   @torch.no_grad(
-00020850: 290a 2020 2020 2020 2020 2e2e 2e20 6465  ).        ... de
-00020860: 6620 6261 636b 7761 7264 5f66 6e28 7361  f backward_fn(sa
-00020870: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00020880: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
-00020890: 2020 2020 2020 202e 2e2e 2020 2023 2073         ...   # s
-000208a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000208b0: 643a 2022 436f 6c6c 6563 7469 6f6e 2220  d: "Collection" 
-000208c0: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
-000208d0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
-000208e0: 2020 202e 2e2e 2020 2023 2063 6f74 616e     ...   # cotan
-000208f0: 6765 6e74 733a 2022 6370 7520 6633 325b  gents: "cpu f32[
-00020900: 5d22 203d 2020 636f 7461 6e67 656e 7473  ]" =  cotangents
-00020910: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
-00020920: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
-00020930: 2074 302c 205c 0a20 2020 2020 2020 202e   t0, \.        .
-00020940: 2e2e 2020 203d 2073 6176 6564 5f66 6f72  ..   = saved_for
-00020950: 5f62 6163 6b77 6172 640a 2020 2020 2020  _backward.      
-00020960: 2020 2e2e 2e20 2020 7431 203d 2070 7269    ...   t1 = pri
-00020970: 6d73 2e63 6f73 2874 3029 2020 2320 7431  ms.cos(t0)  # t1
-00020980: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
-00020990: 2020 2020 2020 2e2e 2e20 2020 7432 203d        ...   t2 =
-000209a0: 2070 7269 6d73 2e6d 756c 2863 6f74 616e   prims.mul(cotan
-000209b0: 6765 6e74 732c 2074 3129 2020 2320 7432  gents, t1)  # t2
-000209c0: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
-000209d0: 2020 2020 2020 2e2e 2e20 2020 7265 7475        ...   retu
-000209e0: 726e 2028 7432 2c29 290a 2020 2020 2222  rn (t2,)).    ""
-000209f0: 220a 0a20 2020 206f 7574 7075 745f 7370  "..    output_sp
-00020a00: 6563 203d 204e 6f6e 650a 0a20 2020 2064  ec = None..    d
-00020a10: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-00020a20: 7761 7264 5f66 6e28 2a61 7267 732c 202a  ward_fn(*args, *
-00020a30: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00020a40: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
-00020a50: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00020a60: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
-00020a70: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
-00020a80: 7267 7329 0a20 2020 2020 2020 2073 6176  rgs).        sav
-00020a90: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00020aa0: 3d20 6465 636f 6e73 7472 7563 745f 666f  = deconstruct_fo
-00020ab0: 7277 6172 645f 656e 765f 666f 725f 6261  rward_env_for_ba
-00020ac0: 636b 7761 7264 2874 7261 6365 2c20 656e  ckward(trace, en
-00020ad0: 7629 0a20 2020 2020 2020 2069 6620 746f  v).        if to
-00020ae0: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-00020af0: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
-00020b00: 616c 206f 7574 7075 745f 7370 6563 0a20  al output_spec. 
-00020b10: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
-00020b20: 6172 6773 2c20 5f20 3d20 7472 6565 5f66  args, _ = tree_f
-00020b30: 6c61 7474 656e 2828 6172 6773 2c20 6b77  latten((args, kw
-00020b40: 6172 6773 2929 0a20 2020 2020 2020 2020  args)).         
-00020b50: 2020 2066 6c61 745f 6f75 7470 7574 2c20     flat_output, 
-00020b60: 6f75 7470 7574 5f73 7065 6320 3d20 7472  output_spec = tr
-00020b70: 6565 5f66 6c61 7474 656e 2872 6573 756c  ee_flatten(resul
-00020b80: 7429 0a20 2020 2020 2020 2020 2020 2066  t).            f
-00020b90: 6c61 745f 6f75 7470 7574 203d 2074 7570  lat_output = tup
-00020ba0: 6c65 2866 6c61 745f 6f75 7470 7574 290a  le(flat_output).
-00020bb0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-00020bc0: 6520 4e6f 7465 205b 4772 6164 2066 6f72  e Note [Grad for
-00020bd0: 7761 7264 206f 7574 7075 7420 7370 6563  ward output spec
-00020be0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00020bf0: 725f 6175 746f 6772 6164 203d 2054 6f72  r_autograd = Tor
-00020c00: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
-00020c10: 6444 6174 6128 0a20 2020 2020 2020 2020  dData(.         
-00020c20: 2020 2020 2020 2072 6573 756c 742c 0a20         result,. 
-00020c30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020c40: 6c61 745f 6172 6773 2c0a 2020 2020 2020  lat_args,.      
-00020c50: 2020 2020 2020 2020 2020 666c 6174 5f6f            flat_o
-00020c60: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
-00020c70: 2020 2029 2e5f 6173 6469 6374 2829 0a20     )._asdict(). 
-00020c80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020c90: 6e20 2866 6f72 5f61 7574 6f67 7261 642c  n (for_autograd,
-00020ca0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00020cb0: 6172 6429 0a20 2020 2020 2020 2072 6574  ard).        ret
-00020cc0: 7572 6e20 7265 7375 6c74 2c20 7361 7665  urn result, save
-00020cd0: 645f 666f 725f 6261 636b 7761 7264 0a0a  d_for_backward..
-00020ce0: 2020 2020 2320 436f 7079 2074 6865 2073      # Copy the s
-00020cf0: 6967 6e61 7475 7265 206f 6620 7468 6520  ignature of the 
-00020d00: 6f72 6967 696e 616c 2066 756e 6374 696f  original functio
-00020d10: 6e20 736f 2074 6861 7420 7468 6520 6172  n so that the ar
-00020d20: 6775 6d65 6e74 7320 6172 650a 2020 2020  guments are.    
-00020d30: 2320 6e61 6d65 6420 636f 7272 6563 746c  # named correctl
-00020d40: 7920 696e 2074 6865 2061 7567 6d65 6e74  y in the augment
-00020d50: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
-00020d60: 696e 7374 6561 6420 6f66 2062 6569 6e67  instead of being
-00020d70: 206e 616d 6564 0a20 2020 2023 2022 6172   named.    # "ar
-00020d80: 6773 2220 616e 6420 226b 7761 7267 7322  gs" and "kwargs"
-00020d90: 2e0a 2020 2020 6175 676d 656e 7465 645f  ..    augmented_
-00020da0: 666f 7277 6172 645f 666e 2e5f 5f73 6967  forward_fn.__sig
-00020db0: 6e61 7475 7265 5f5f 203d 2069 6e73 7065  nature__ = inspe
-00020dc0: 6374 2e73 6967 6e61 7475 7265 2874 7261  ct.signature(tra
-00020dd0: 6365 2e66 6e20 6f72 2074 7261 6365 2e70  ce.fn or trace.p
-00020de0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
-00020df0: 290a 0a20 2020 2064 6566 206f 6e65 735f  )..    def ones_
-00020e00: 6c69 6b65 2878 293a 0a20 2020 2020 2020  like(x):.       
-00020e10: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-00020e20: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
-00020e30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00020e40: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
-00020e50: 6669 6c6c 5f76 616c 7565 3d31 290a 2020  fill_value=1).  
-00020e60: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00020e70: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
-00020e80: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-00020e90: 2020 2072 6574 7572 6e20 7479 7065 2878     return type(x
-00020ea0: 2e76 616c 7565 2928 3129 0a20 2020 2020  .value)(1).     
-00020eb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00020ec0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00020ed0: 0a0a 2020 2020 666f 7277 6172 645f 7472  ..    forward_tr
-00020ee0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00020ef0: 7472 6163 6528 2928 6175 676d 656e 7465  trace()(augmente
-00020f00: 645f 666f 7277 6172 645f 666e 2c20 2a74  d_forward_fn, *t
-00020f10: 7261 6365 2e61 7267 732c 202a 2a74 7261  race.args, **tra
-00020f20: 6365 2e6b 7761 7267 7329 0a20 2020 2023  ce.kwargs).    #
-00020f30: 2057 6520 7365 7420 666f 7277 6172 6420   We set forward 
-00020f40: 7472 6163 6520 746f 2063 6f6e 7374 7275  trace to constru
-00020f50: 6374 2070 726f 7869 6573 2062 6563 6175  ct proxies becau
-00020f60: 7365 2077 6520 6e65 6564 2074 6865 7365  se we need these
-00020f70: 2070 726f 7869 6573 2074 6f0a 2020 2020   proxies to.    
-00020f80: 2320 6861 7665 2064 6966 6665 7265 6e74  # have different
-00020f90: 206e 616d 6573 2074 6861 6e20 7468 6520   names than the 
-00020fa0: 6f6e 6573 2069 6e20 7468 6520 666f 7277  ones in the forw
-00020fb0: 6172 6420 7472 6163 652e 0a20 2020 2074  ard trace..    t
-00020fc0: 7279 3a0a 2020 2020 2020 2020 7472 6163  ry:.        trac
-00020fd0: 6563 7478 5f74 6f6b 656e 203d 2073 6574  ectx_token = set
-00020fe0: 5f74 7261 6365 6374 7828 666f 7277 6172  _tracectx(forwar
-00020ff0: 645f 7472 6163 6529 0a20 2020 2020 2020  d_trace).       
-00021000: 2023 2057 6520 646f 6e27 7420 7761 6e74   # We don't want
-00021010: 2074 6f20 7265 636f 7264 2074 686f 7365   to record those
-00021020: 206f 6e65 735f 6c69 6b65 2063 616c 6c73   ones_like calls
-00021030: 2069 6e20 7468 6520 666f 7277 6172 6420   in the forward 
-00021040: 7472 6163 652e 0a20 2020 2020 2020 2077  trace..        w
-00021050: 6974 6820 6465 7461 6368 6564 5f74 7261  ith detached_tra
-00021060: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
-00021070: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
-00021080: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00021090: 2020 2020 2023 2049 7427 7320 6173 7375       # It's assu
-000210a0: 6d65 6420 7468 6174 2066 6f72 7761 7264  med that forward
-000210b0: 5f74 7261 6365 2e6f 7574 7075 745b 305d  _trace.output[0]
-000210c0: 2069 7320 6120 6469 6374 2066 726f 6d20   is a dict from 
-000210d0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
-000210e0: 7761 7264 4461 7461 0a20 2020 2020 2020  wardData.       
-000210f0: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
-00021100: 7470 7574 203d 2066 6f72 7761 7264 5f74  tput = forward_t
-00021110: 7261 6365 2e6f 7574 7075 745b 305d 5b22  race.output[0]["
-00021120: 666c 6174 5f6f 7574 7075 7422 5d0a 2020  flat_output"].  
-00021130: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00021140: 7461 6e67 656e 7473 203d 2075 7469 6c73  tangents = utils
-00021150: 2e73 6571 7565 6e63 6966 7928 7472 6565  .sequencify(tree
-00021160: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
-00021170: 6e65 735f 6c69 6b65 2876 292c 2066 6c61  nes_like(v), fla
-00021180: 745f 6f75 7470 7574 2929 0a20 2020 2020  t_output)).     
-00021190: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000211a0: 2020 2020 2020 2020 2020 2020 2063 6f74               cot
-000211b0: 616e 6765 6e74 7320 3d20 7574 696c 732e  angents = utils.
-000211c0: 7365 7175 656e 6369 6679 2874 7265 655f  sequencify(tree_
-000211d0: 6d61 7028 6c61 6d62 6461 2076 3a20 6f6e  map(lambda v: on
-000211e0: 6573 5f6c 696b 6528 7629 2c20 7472 6163  es_like(v), trac
-000211f0: 652e 6f75 7470 7574 2929 0a20 2020 2066  e.output)).    f
-00021200: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00021210: 7265 7365 745f 7472 6163 6563 7478 2874  reset_tracectx(t
-00021220: 7261 6365 6374 785f 746f 6b65 6e29 0a0a  racectx_token)..
-00021230: 2020 2020 6465 6620 6261 636b 7761 7264      def backward
-00021240: 5f66 6e28 7361 7665 645f 666f 725f 6261  _fn(saved_for_ba
-00021250: 636b 7761 7264 2c20 636f 7461 6e67 656e  ckward, cotangen
-00021260: 7473 293a 0a20 2020 2020 2020 2065 6e76  ts):.        env
-00021270: 203d 2072 6563 6f6e 7374 7275 6374 5f66   = reconstruct_f
-00021280: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-00021290: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
-000212a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000212b0: 6429 0a20 2020 2020 2020 2069 6620 746f  d).        if to
-000212c0: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-000212d0: 2020 2020 2020 2020 2020 636f 7461 6e67            cotang
-000212e0: 656e 7473 203d 2074 7265 655f 756e 666c  ents = tree_unfl
-000212f0: 6174 7465 6e28 636f 7461 6e67 656e 7473  atten(cotangents
-00021300: 2c20 6f75 7470 7574 5f73 7065 6329 0a20  , output_spec). 
-00021310: 2020 2020 2020 206f 7574 203d 2062 6163         out = bac
-00021320: 6b77 6172 645f 7061 7373 2865 6e76 2c20  kward_pass(env, 
-00021330: 7472 6163 652c 2063 6f74 616e 6765 6e74  trace, cotangent
-00021340: 7329 0a20 2020 2020 2020 2069 6620 746f  s).        if to
-00021350: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-00021360: 2020 2020 2020 2020 2020 676b 7761 7267            gkwarg
-00021370: 7320 3d20 6f75 745b 2d31 5d20 6966 2069  s = out[-1] if i
-00021380: 7369 6e73 7461 6e63 6528 6f75 745b 2d31  sinstance(out[-1
-00021390: 5d2c 2064 6963 7429 2065 6c73 6520 7b7d  ], dict) else {}
-000213a0: 0a20 2020 2020 2020 2020 2020 2067 6172  .            gar
-000213b0: 6773 203d 206f 7574 5b3a 2d31 5d20 6966  gs = out[:-1] if
-000213c0: 2069 7369 6e73 7461 6e63 6528 6f75 745b   isinstance(out[
-000213d0: 2d31 5d2c 2064 6963 7429 2065 6c73 6520  -1], dict) else 
-000213e0: 6f75 740a 2020 2020 2020 2020 2020 2020  out.            
-000213f0: 676b 7761 7267 7320 3d20 7b6b 3a20 676b  gkwargs = {k: gk
-00021400: 7761 7267 732e 6765 7428 6b2c 204e 6f6e  wargs.get(k, Non
-00021410: 6529 2066 6f72 206b 2069 6e20 7472 6163  e) for k in trac
-00021420: 652e 6b77 6172 6773 7d0a 2020 2020 2020  e.kwargs}.      
-00021430: 2020 2020 2020 6f75 7420 3d20 282a 6761        out = (*ga
-00021440: 7267 732c 2067 6b77 6172 6773 290a 2020  rgs, gkwargs).  
-00021450: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00021460: 7472 6565 5f66 6c61 7474 656e 286f 7574  tree_flatten(out
-00021470: 295b 305d 0a20 2020 2020 2020 2072 6574  )[0].        ret
-00021480: 7572 6e20 6f75 740a 0a20 2020 2073 6176  urn out..    sav
-00021490: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-000214a0: 3d20 666f 7277 6172 645f 7472 6163 652e  = forward_trace.
-000214b0: 6f75 7470 7574 5b31 5d0a 2020 2020 6261  output[1].    ba
-000214c0: 636b 7761 7264 5f74 7261 6365 203d 2063  ckward_trace = c
-000214d0: 6f6e 7374 7275 6374 5f74 7261 6365 2872  onstruct_trace(r
-000214e0: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
-000214f0: 6c73 6529 2862 6163 6b77 6172 645f 666e  lse)(backward_fn
-00021500: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-00021510: 7761 7264 2c20 636f 7461 6e67 656e 7473  ward, cotangents
-00021520: 290a 0a20 2020 2023 2057 6520 6172 6520  )..    # We are 
-00021530: 646f 6e65 2077 6974 6820 636f 6e73 7472  done with constr
-00021540: 7563 7469 6e67 2074 6865 2066 6f72 7761  ucting the forwa
-00021550: 7264 2061 6e64 2062 6163 6b77 6172 6420  rd and backward 
-00021560: 7061 7373 6573 2061 7420 7468 6973 0a20  passes at this. 
-00021570: 2020 2023 2073 7461 6765 2e20 5468 6520     # stage. The 
-00021580: 666f 6c6c 6f77 696e 6720 6973 206e 6f74  following is not
-00021590: 2073 7472 6963 746c 7920 6e65 6365 7373   strictly necess
-000215a0: 6172 792c 2062 7574 2069 7427 7320 676f  ary, but it's go
-000215b0: 6f64 2074 6f20 6669 6c74 6572 0a20 2020  od to filter.   
-000215c0: 2023 206f 7574 2074 6865 2075 6e75 7365   # out the unuse
-000215d0: 6420 656c 656d 656e 7473 206f 6620 7468  d elements of th
-000215e0: 6520 7361 7665 645f 666f 725f 6261 636b  e saved_for_back
-000215f0: 7761 7264 2061 6e64 2066 6c61 7474 656e  ward and flatten
-00021600: 2069 7420 666f 7220 6d6f 7265 0a20 2020   it for more.   
-00021610: 2023 2063 6f6d 7061 6374 2062 6163 6b77   # compact backw
-00021620: 6172 6420 7472 6163 652e 0a0a 2020 2020  ard trace...    
-00021630: 2320 4e6f 7720 7765 2063 616e 2064 6574  # Now we can det
-00021640: 6572 6d69 6e65 2065 7861 6374 6c79 2077  ermine exactly w
-00021650: 6861 7427 7320 7573 6564 2069 6e20 7468  hat's used in th
-00021660: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-00021670: 6672 6f6d 2074 6865 0a20 2020 2023 2073  from the.    # s
-00021680: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00021690: 642e 2057 6520 6361 6e20 666c 6174 7465  d. We can flatte
-000216a0: 6e20 616e 6420 6669 6c74 6572 2074 6865  n and filter the
-000216b0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-000216c0: 6172 640a 2020 2020 636f 6e73 756d 6572  ard.    consumer
-000216d0: 7320 3d20 7574 696c 732e 636f 6e73 756d  s = utils.consum
-000216e0: 6572 7328 6261 636b 7761 7264 5f74 7261  ers(backward_tra
-000216f0: 6365 290a 0a20 2020 2023 2046 6f72 7761  ce)..    # Forwa
-00021700: 7264 2773 2061 6e64 2062 6163 6b77 6172  rd's and backwar
-00021710: 6427 7320 2273 6176 6564 5f66 6f72 5f62  d's "saved_for_b
-00021720: 6163 6b77 6172 6422 2061 7265 206e 6f74  ackward" are not
-00021730: 206e 6563 6573 7361 7269 6c79 2074 6865   necessarily the
-00021740: 2073 616d 650a 2020 2020 2320 6173 2074   same.    # as t
-00021750: 6865 2073 6176 6564 5f66 6f72 5f62 6163  he saved_for_bac
-00021760: 6b77 6172 642c 2062 6563 6175 7365 2073  kward, because s
-00021770: 6f6d 6520 6f72 2061 6c6c 2065 6c65 6d65  ome or all eleme
-00021780: 6e74 7320 6f66 2074 6865 0a20 2020 2023  nts of the.    #
-00021790: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-000217a0: 6172 6420 7265 7375 6c74 7320 6d69 6768  ard results migh
-000217b0: 7420 6265 2072 652d 7072 6f78 6966 6965  t be re-proxifie
-000217c0: 642e 0a20 2020 2062 775f 666c 6174 5f73  d..    bw_flat_s
-000217d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000217e0: 642c 2073 7065 6320 3d20 7472 6565 5f66  d, spec = tree_f
-000217f0: 6c61 7474 656e 2862 6163 6b77 6172 645f  latten(backward_
-00021800: 7472 6163 652e 6172 6773 5b30 5d29 0a20  trace.args[0]). 
-00021810: 2020 2066 775f 666c 6174 5f73 6176 6564     fw_flat_saved
-00021820: 5f66 6f72 5f62 6163 6b77 6172 642c 205f  _for_backward, _
-00021830: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00021840: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
-00021850: 7470 7574 5b31 5d29 0a20 2020 2075 7365  tput[1]).    use
-00021860: 645f 6d61 736b 203d 206c 6973 7428 6c65  d_mask = list(le
-00021870: 6e28 636f 6e73 756d 6572 732e 6765 7428  n(consumers.get(
-00021880: 782c 2028 2929 2920 3e20 3020 666f 7220  x, ())) > 0 for 
-00021890: 7820 696e 2062 775f 666c 6174 5f73 6176  x in bw_flat_sav
-000218a0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-000218b0: 0a0a 2020 2020 2320 446f 6e27 7420 7573  ..    # Don't us
-000218c0: 6520 7468 6520 7361 6d65 2076 6172 6961  e the same varia
-000218d0: 626c 6520 7477 6963 6520 696e 2074 6865  ble twice in the
-000218e0: 2062 6163 6b77 6172 6420 7061 7373 0a20   backward pass. 
-000218f0: 2020 2073 6565 6e20 3d20 7365 7428 290a     seen = set().
-00021900: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00021910: 2e63 6f72 652e 7072 6f78 6965 7320 696d  .core.proxies im
-00021920: 706f 7274 2056 6172 6961 626c 650a 0a20  port Variable.. 
-00021930: 2020 2066 6f72 2069 2c20 7820 696e 2065     for i, x in e
-00021940: 6e75 6d65 7261 7465 2866 775f 666c 6174  numerate(fw_flat
-00021950: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-00021960: 6172 6429 3a0a 2020 2020 2020 2020 7820  ard):.        x 
-00021970: 3d20 7661 7269 6162 6c65 6966 7928 7829  = variableify(x)
-00021980: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00021990: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
-000219a0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
-000219b0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-000219c0: 2020 2020 2020 6966 2078 2069 6e20 7365        if x in se
-000219d0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-000219e0: 7573 6564 5f6d 6173 6b5b 695d 203d 2046  used_mask[i] = F
-000219f0: 616c 7365 0a20 2020 2020 2020 2065 6c73  alse.        els
-00021a00: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00021a10: 6565 6e2e 6164 6428 7829 0a0a 2020 2020  een.add(x)..    
-00021a20: 6f6e 6c79 5f75 7365 645f 6677 5f73 6176  only_used_fw_sav
-00021a30: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00021a40: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
-00021a50: 2866 775f 666c 6174 5f73 6176 6564 5f66  (fw_flat_saved_f
-00021a60: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
-00021a70: 645f 6d61 736b 2929 0a20 2020 206f 6e6c  d_mask)).    onl
-00021a80: 795f 7573 6564 5f62 775f 7361 7665 645f  y_used_bw_saved_
-00021a90: 666f 725f 6261 636b 7761 7264 203d 2074  for_backward = t
-00021aa0: 7570 6c65 2863 6f6d 7072 6573 7328 6277  uple(compress(bw
-00021ab0: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
-00021ac0: 6261 636b 7761 7264 2c20 7573 6564 5f6d  backward, used_m
-00021ad0: 6173 6b29 290a 0a20 2020 2023 2057 6520  ask))..    # We 
-00021ae0: 6e65 6564 2074 6f20 7570 6461 7465 2074  need to update t
-00021af0: 6865 2074 7261 6365 7320 7769 7468 2074  he traces with t
-00021b00: 6865 206e 6577 2073 6176 6564 5f66 6f72  he new saved_for
-00021b10: 5f62 6163 6b77 6172 640a 2020 2020 5f75  _backward.    _u
-00021b20: 7064 6174 655f 666f 7277 6172 645f 7769  pdate_forward_wi
-00021b30: 7468 5f6e 6577 5f73 6176 6564 5f66 6f72  th_new_saved_for
-00021b40: 5f62 6163 6b77 6172 6428 666f 7277 6172  _backward(forwar
-00021b50: 645f 7472 6163 652c 206f 6e6c 795f 7573  d_trace, only_us
-00021b60: 6564 5f66 775f 7361 7665 645f 666f 725f  ed_fw_saved_for_
-00021b70: 6261 636b 7761 7264 290a 2020 2020 5f75  backward).    _u
-00021b80: 7064 6174 655f 6261 636b 7761 7264 5f77  pdate_backward_w
-00021b90: 6974 685f 6e65 775f 7361 7665 645f 666f  ith_new_saved_fo
-00021ba0: 725f 6261 636b 7761 7264 2862 6163 6b77  r_backward(backw
-00021bb0: 6172 645f 7472 6163 652c 206f 6e6c 795f  ard_trace, only_
-00021bc0: 7573 6564 5f62 775f 7361 7665 645f 666f  used_bw_saved_fo
-00021bd0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-00021be0: 666f 7277 6172 645f 7472 6163 652e 7365  forward_trace.se
-00021bf0: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
-00021c00: 6365 5072 6f76 656e 616e 6365 2822 4175  ceProvenance("Au
-00021c10: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
-00021c20: 7061 7373 2229 290a 2020 2020 6261 636b  pass")).    back
-00021c30: 7761 7264 5f74 7261 6365 2e73 6574 5f70  ward_trace.set_p
-00021c40: 726f 7665 6e61 6e63 6528 5472 6163 6550  rovenance(TraceP
-00021c50: 726f 7665 6e61 6e63 6528 2242 6163 6b77  rovenance("Backw
-00021c60: 6172 6420 7061 7373 2229 290a 2020 2020  ard pass")).    
-00021c70: 7265 7475 726e 2046 6f72 7761 7264 4261  return ForwardBa
-00021c80: 636b 7761 7264 5472 6163 6573 2866 6f72  ckwardTraces(for
-00021c90: 7761 7264 5f74 7261 6365 2c20 6261 636b  ward_trace, back
-00021ca0: 7761 7264 5f74 7261 6365 290a 0a0a 2320  ward_trace)...# 
-00021cb0: 646f 2077 6520 6861 7070 656e 2074 6f20  do we happen to 
-00021cc0: 7761 6e74 2074 6f20 7265 6769 7374 6572  want to register
-00021cd0: 2060 6c74 6f72 6368 6020 6f70 7320 7375   `ltorch` ops su
-00021ce0: 6368 2061 7320 606c 746f 7263 682e 6c61  ch as `ltorch.la
-00021cf0: 7965 725f 6e6f 726d 6020 6173 2077 656c  yer_norm` as wel
-00021d00: 6c3f 0a61 7574 6f63 6173 745f 696d 706c  l?.autocast_impl
-00021d10: 733a 2064 6963 745b 7072 696d 732e 5072  s: dict[prims.Pr
-00021d20: 696d 4944 732c 2043 616c 6c61 626c 655d  imIDs, Callable]
-00021d30: 203d 207b 7d0a 0a0a 6465 6620 7265 6769   = {}...def regi
-00021d40: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00021d50: 6c65 286f 7029 3a0a 2020 2020 6465 6620  le(op):.    def 
-00021d60: 6465 636f 7261 746f 7228 6675 6e63 293a  decorator(func):
-00021d70: 0a20 2020 2020 2020 2061 7574 6f63 6173  .        autocas
-00021d80: 745f 696d 706c 735b 6f70 5d20 3d20 6675  t_impls[op] = fu
-00021d90: 6e63 0a20 2020 2020 2020 2072 6574 7572  nc.        retur
-00021da0: 6e20 6675 6e63 0a0a 2020 2020 7265 7475  n func..    retu
-00021db0: 726e 2064 6563 6f72 6174 6f72 0a0a 0a64  rn decorator...d
-00021dc0: 6566 206d 6179 6265 5f64 6f77 6e63 6173  ef maybe_downcas
-00021dd0: 745f 746f 2864 7479 7065 2c20 6172 6773  t_to(dtype, args
-00021de0: 293a 0a20 2020 2061 6c6c 6f77 6564 5f64  ):.    allowed_d
-00021df0: 6f77 6e63 6173 745f 7479 7065 7320 3d20  owncast_types = 
-00021e00: 2864 7479 7065 732e 666c 6f61 7431 362c  (dtypes.float16,
-00021e10: 2064 7479 7065 732e 6266 6c6f 6174 3136   dtypes.bfloat16
-00021e20: 2c20 6474 7970 6573 2e66 6c6f 6174 3332  , dtypes.float32
-00021e30: 290a 0a20 2020 2064 6566 206d 6170 5f66  )..    def map_f
-00021e40: 6e28 6129 3a0a 2020 2020 2020 2020 6966  n(a):.        if
-00021e50: 2069 7369 6e73 7461 6e63 6528 612c 2054   isinstance(a, T
-00021e60: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
-00021e70: 612e 6474 7970 6520 696e 2061 6c6c 6f77  a.dtype in allow
-00021e80: 6564 5f64 6f77 6e63 6173 745f 7479 7065  ed_downcast_type
-00021e90: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00021ea0: 6574 7572 6e20 6d61 7962 655f 636f 6e76  eturn maybe_conv
-00021eb0: 6572 745f 746f 5f64 7479 7065 2861 2c20  ert_to_dtype(a, 
-00021ec0: 6474 7970 6529 0a20 2020 2020 2020 2072  dtype).        r
-00021ed0: 6574 7572 6e20 610a 0a20 2020 2072 6574  eturn a..    ret
-00021ee0: 7572 6e20 7472 6565 5f6d 6170 286d 6170  urn tree_map(map
-00021ef0: 5f66 6e2c 2061 7267 7329 0a0a 0a40 7265  _fn, args)...@re
-00021f00: 6769 7374 6572 5f61 7574 6f63 6173 745f  gister_autocast_
-00021f10: 7275 6c65 2822 746f 7263 682e 6d61 746d  rule("torch.matm
-00021f20: 756c 2229 0a40 7265 6769 7374 6572 5f61  ul").@register_a
-00021f30: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
-00021f40: 6d73 2e50 7269 6d49 4473 2e4d 4154 4d55  ms.PrimIDs.MATMU
-00021f50: 4c29 0a64 6566 2061 7574 6f63 6173 745f  L).def autocast_
-00021f60: 6d61 746d 756c 5f72 756c 6528 612c 2062  matmul_rule(a, b
-00021f70: 2c20 6474 7970 6529 3a0a 2020 2020 2222  , dtype):.    ""
-00021f80: 2241 7574 6f63 6173 7420 7275 6c65 2066  "Autocast rule f
-00021f90: 6f72 206d 6174 6d75 6c22 2222 0a20 2020  or matmul""".   
-00021fa0: 2072 6574 7572 6e20 7072 696d 732e 6d61   return prims.ma
-00021fb0: 746d 756c 282a 286d 6179 6265 5f64 6f77  tmul(*(maybe_dow
-00021fc0: 6e63 6173 745f 746f 2864 7479 7065 2c20  ncast_to(dtype, 
-00021fd0: 2861 2c20 6229 2929 290a 0a0a 4072 6567  (a, b))))...@reg
-00021fe0: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
-00021ff0: 756c 6528 2274 6f72 6368 2e6e 6e2e 6675  ule("torch.nn.fu
-00022000: 6e63 7469 6f6e 616c 2e6c 696e 6561 7222  nctional.linear"
-00022010: 290a 4072 6567 6973 7465 725f 6175 746f  ).@register_auto
-00022020: 6361 7374 5f72 756c 6528 7072 696d 732e  cast_rule(prims.
-00022030: 5072 696d 4944 732e 4c49 4e45 4152 290a  PrimIDs.LINEAR).
-00022040: 6465 6620 6175 746f 6361 7374 5f6c 696e  def autocast_lin
-00022050: 6561 725f 7275 6c65 2861 2c20 772c 2062  ear_rule(a, w, b
-00022060: 6961 732c 2064 7479 7065 293a 0a20 2020  ias, dtype):.   
-00022070: 2069 6620 6269 6173 2069 7320 4e6f 6e65   if bias is None
-00022080: 3a0a 2020 2020 2020 2020 2320 446f 6e27  :.        # Don'
-00022090: 7420 7061 7373 2060 6269 6173 6020 746f  t pass `bias` to
-000220a0: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
-000220b0: 746f 2e0a 2020 2020 2020 2020 646f 776e  to..        down
-000220c0: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
-000220d0: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
-000220e0: 7970 652c 2028 612c 2077 2929 202b 2028  ype, (a, w)) + (
-000220f0: 6269 6173 2c29 0a20 2020 2065 6c73 653a  bias,).    else:
-00022100: 0a20 2020 2020 2020 2064 6f77 6e63 6173  .        downcas
-00022110: 745f 6172 6773 203d 206d 6179 6265 5f64  t_args = maybe_d
-00022120: 6f77 6e63 6173 745f 746f 2864 7479 7065  owncast_to(dtype
-00022130: 2c20 2861 2c20 772c 2062 6961 7329 290a  , (a, w, bias)).
-00022140: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
-00022150: 732e 6c69 6e65 6172 282a 646f 776e 6361  s.linear(*downca
-00022160: 7374 5f61 7267 7329 0a0a 0a40 7265 6769  st_args)...@regi
-00022170: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00022180: 6c65 2822 746f 7263 682e 6e6e 2e66 756e  le("torch.nn.fun
-00022190: 6374 696f 6e61 6c2e 7363 616c 6564 5f64  ctional.scaled_d
-000221a0: 6f74 5f70 726f 6475 6374 5f61 7474 656e  ot_product_atten
-000221b0: 7469 6f6e 2229 0a64 6566 2061 7574 6f63  tion").def autoc
-000221c0: 6173 745f 7363 616c 6564 5f64 6f74 5f70  ast_scaled_dot_p
-000221d0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
-000221e0: 280a 2020 2020 7175 6572 792c 0a20 2020  (.    query,.   
-000221f0: 206b 6579 2c0a 2020 2020 7661 6c75 652c   key,.    value,
-00022200: 0a20 2020 2061 7474 6e5f 6d61 736b 2c0a  .    attn_mask,.
-00022210: 2020 2020 6472 6f70 6f75 745f 702c 0a20      dropout_p,. 
-00022220: 2020 2069 735f 6361 7573 616c 2c0a 2020     is_causal,.  
-00022230: 2020 2a2c 0a20 2020 2064 7479 7065 2c0a    *,.    dtype,.
-00022240: 2020 2020 7363 616c 652c 0a29 3a0a 2020      scale,.):.  
-00022250: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00022260: 6f72 6368 2069 6d70 6f72 7420 7363 616c  orch import scal
-00022270: 6564 5f64 6f74 5f70 726f 6475 6374 5f61  ed_dot_product_a
-00022280: 7474 656e 7469 6f6e 0a0a 2020 2020 712c  ttention..    q,
-00022290: 206b 2c20 7620 3d20 6d61 7962 655f 646f   k, v = maybe_do
-000222a0: 776e 6361 7374 5f74 6f28 6474 7970 652c  wncast_to(dtype,
-000222b0: 2028 7175 6572 792c 206b 6579 2c20 7661   (query, key, va
-000222c0: 6c75 6529 290a 2020 2020 7265 7475 726e  lue)).    return
-000222d0: 2073 6361 6c65 645f 646f 745f 7072 6f64   scaled_dot_prod
-000222e0: 7563 745f 6174 7465 6e74 696f 6e28 712c  uct_attention(q,
-000222f0: 206b 2c20 762c 2061 7474 6e5f 6d61 736b   k, v, attn_mask
-00022300: 2c20 6472 6f70 6f75 745f 702c 2069 735f  , dropout_p, is_
-00022310: 6361 7573 616c 2c20 7363 616c 653d 7363  causal, scale=sc
-00022320: 616c 6529 0a0a 0a64 6566 2061 7574 6f63  ale)...def autoc
-00022330: 6173 745f 7379 6d62 6f6c 5f6d 6170 7065  ast_symbol_mappe
-00022340: 7228 626f 756e 645f 7379 6d62 6f6c 3a20  r(bound_symbol: 
-00022350: 426f 756e 6453 796d 626f 6c49 6e74 6572  BoundSymbolInter
-00022360: 6661 6365 2c20 6474 7970 653a 2064 7479  face, dtype: dty
-00022370: 7065 732e 6474 7970 6529 3a0a 2020 2020  pes.dtype):.    
-00022380: 2222 2252 6574 7572 6e20 7468 6520 6361  """Return the ca
-00022390: 6c6c 6162 6c65 2069 6d70 6c65 6d65 6e74  llable implement
-000223a0: 696e 6720 7468 6520 6175 746f 6361 7374  ing the autocast
-000223b0: 2072 756c 6520 666f 7220 7468 6520 7379   rule for the sy
-000223c0: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
-000223d0: 0a20 2020 2020 2020 2062 6f75 6e64 5f73  .        bound_s
-000223e0: 796d 626f 6c3a 204d 6170 7065 6420 746f  ymbol: Mapped to
-000223f0: 2069 7473 2061 7574 6f63 6173 7420 7275   its autocast ru
-00022400: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
-00022410: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-00022420: 6c65 3a20 5468 6520 6361 6c6c 6162 6c65  le: The callable
-00022430: 2069 6d70 6c65 6d65 6e74 696e 6720 7468   implementing th
-00022440: 6520 6175 746f 6361 7374 2072 756c 6520  e autocast rule 
-00022450: 666f 7220 7468 6520 7379 6d62 6f6c 2e0a  for the symbol..
-00022460: 2020 2020 2222 220a 2020 2020 6175 746f      """.    auto
-00022470: 6361 7374 5f69 6d70 6c3a 2043 616c 6c61  cast_impl: Calla
-00022480: 626c 6520 7c20 4e6f 6e65 203d 2061 7574  ble | None = aut
-00022490: 6f63 6173 745f 696d 706c 732e 6765 7428  ocast_impls.get(
-000224a0: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
-000224b0: 2e69 6429 0a20 2020 2072 6574 7572 6e20  .id).    return 
-000224c0: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
-000224d0: 2069 6620 6175 746f 6361 7374 5f69 6d70   if autocast_imp
-000224e0: 6c20 6973 204e 6f6e 6520 656c 7365 2070  l is None else p
-000224f0: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
-00022500: 696d 706c 2c20 6474 7970 653d 6474 7970  impl, dtype=dtyp
-00022510: 6529 0a0a 0a64 6566 2061 7574 6f63 6173  e)...def autocas
-00022520: 7428 6675 6e63 3a20 4361 6c6c 6162 6c65  t(func: Callable
-00022530: 2c20 6474 7970 653a 2064 7479 7065 732e  , dtype: dtypes.
-00022540: 6474 7970 6529 3a0a 2020 2020 2222 2254  dtype):.    """T
-00022550: 7261 6e73 666f 726d 7320 6120 6675 6e63  ransforms a func
-00022560: 7469 6f6e 2074 6f20 6175 746f 6361 7374  tion to autocast
-00022570: 2063 6572 7461 696e 206f 7065 7261 7469   certain operati
-00022580: 6f6e 732e 0a0a 2020 2020 4172 6773 3a0a  ons...    Args:.
-00022590: 2020 2020 2020 2020 6675 6e63 3a20 5468          func: Th
-000225a0: 6520 6675 6e63 7469 6f6e 2074 6f20 6265  e function to be
-000225b0: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
-000225c0: 2020 2020 2020 6474 7970 653a 2054 6865        dtype: The
-000225d0: 2064 6174 6120 7479 7065 2074 6f20 7768   data type to wh
-000225e0: 6963 6820 6172 6775 6d65 6e74 7320 6f66  ich arguments of
-000225f0: 2074 6865 2066 756e 6374 696f 6e20 6f72   the function or
-00022600: 2073 7562 2066 756e 6374 696f 6e73 2063   sub functions c
-00022610: 6f75 6c64 2067 6574 2063 6173 7420 6966  ould get cast if
-00022620: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00022630: 7920 6172 6520 6064 7479 7065 732e 666c  y are `dtypes.fl
-00022640: 6f61 7433 3260 2e0a 0a20 2020 2052 6574  oat32`...    Ret
-00022650: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
-00022660: 6c6c 6162 6c65 3a20 5468 6520 7472 616e  llable: The tran
-00022670: 7366 6f72 6d65 6420 6675 6e63 7469 6f6e  sformed function
-00022680: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
-00022690: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-000226a0: 6474 7970 652c 2064 7479 7065 732e 6474  dtype, dtypes.dt
-000226b0: 7970 6529 3a0a 2020 2020 2020 2020 7261  ype):.        ra
-000226c0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-000226d0: 2260 6474 7970 6560 2069 7320 6578 7065  "`dtype` is expe
-000226e0: 6374 6564 2074 6f20 6265 2060 7468 756e  cted to be `thun
-000226f0: 6465 722e 6474 7970 652e 6474 7970 6560  der.dtype.dtype`
-00022700: 2062 7574 207b 7479 7065 2864 7479 7065   but {type(dtype
-00022710: 297d 2229 0a20 2020 2069 6620 6474 7970  )}").    if dtyp
-00022720: 6520 6e6f 7420 696e 207b 6474 7970 6573  e not in {dtypes
-00022730: 2e66 6c6f 6174 3136 2c20 6474 7970 6573  .float16, dtypes
-00022740: 2e62 666c 6f61 7431 367d 3a0a 2020 2020  .bfloat16}:.    
-00022750: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00022760: 7272 6f72 2866 2260 6474 7970 6560 2069  rror(f"`dtype` i
-00022770: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
-00022780: 2065 6974 6865 7220 6074 6875 6e64 6572   either `thunder
-00022790: 2e66 6c6f 6174 3136 6020 6f72 2060 7468  .float16` or `th
-000227a0: 756e 6465 722e 6266 6c6f 6174 3136 602c  under.bfloat16`,
-000227b0: 2062 7574 207b 6474 7970 657d 2229 0a0a   but {dtype}")..
-000227c0: 2020 2020 4077 7261 7073 2866 756e 6329      @wraps(func)
-000227d0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
-000227e0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-000227f0: 293a 0a20 2020 2020 2020 2074 7261 6365  ):.        trace
-00022800: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-00022810: 6365 2829 2866 756e 632c 202a 6172 6773  ce()(func, *args
-00022820: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-00022830: 2020 2020 7265 7475 726e 2065 7661 6c5f      return eval_
-00022840: 7472 6163 6528 7472 6163 652c 202a 6172  trace(trace, *ar
-00022850: 6773 2c20 2a2a 6b77 6172 6773 2c20 7379  gs, **kwargs, sy
-00022860: 6d62 6f6c 5f6d 6170 7065 723d 7061 7274  mbol_mapper=part
-00022870: 6961 6c28 6175 746f 6361 7374 5f73 796d  ial(autocast_sym
-00022880: 626f 6c5f 6d61 7070 6572 2c20 6474 7970  bol_mapper, dtyp
-00022890: 653d 6474 7970 6529 290a 0a20 2020 2072  e=dtype))..    r
-000228a0: 6574 7572 6e20 7772 6170 7065 720a       eturn wrapper.
+00014bf0: 7269 6d49 4473 2e41 5441 4e48 3a20 6c61  rimIDs.ATANH: la
+00014c00: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
+00014c10: 7461 6e68 2878 292c 2028 782c 2929 2c0a  tanh(x), (x,)),.
+00014c20: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014c30: 732e 4154 414e 323a 206c 616d 6264 6120  s.ATAN2: lambda 
+00014c40: 782c 2079 3a20 2870 7269 6d73 2e61 7461  x, y: (prims.ata
+00014c50: 6e32 2878 2c20 7929 2c20 2878 2c20 7929  n2(x, y), (x, y)
+00014c60: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014c70: 6d49 4473 2e43 4f53 483a 206c 616d 6264  mIDs.COSH: lambd
+00014c80: 6120 783a 2028 7072 696d 732e 636f 7368  a x: (prims.cosh
+00014c90: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+00014ca0: 7072 696d 732e 5072 696d 4944 732e 4449  prims.PrimIDs.DI
+00014cb0: 4741 4d4d 413a 206c 616d 6264 6120 783a  GAMMA: lambda x:
+00014cc0: 2028 7072 696d 732e 6469 6761 6d6d 6128   (prims.digamma(
+00014cd0: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+00014ce0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+00014cf0: 433a 206c 616d 6264 6120 783a 2028 7072  C: lambda x: (pr
+00014d00: 696d 732e 6572 6663 2878 292c 2028 782c  ims.erfc(x), (x,
+00014d10: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014d20: 696d 4944 732e 4552 4649 4e56 3a20 6c61  imIDs.ERFINV: la
+00014d30: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
+00014d40: 7266 696e 7628 7829 2c20 2870 7269 6d73  rfinv(x), (prims
+00014d50: 2e65 7266 696e 7628 7829 2c29 292c 0a20  .erfinv(x),)),. 
+00014d60: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014d70: 2e45 5246 4349 4e56 3a20 6c61 6d62 6461  .ERFCINV: lambda
+00014d80: 2078 3a20 2870 7269 6d73 2e65 7266 6369   x: (prims.erfci
+00014d90: 6e76 2878 292c 2028 7072 696d 732e 6572  nv(x), (prims.er
+00014da0: 6663 696e 7628 7829 2c29 292c 0a20 2020  fcinv(x),)),.   
+00014db0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+00014dc0: 5850 323a 206c 616d 6264 6120 783a 2028  XP2: lambda x: (
+00014dd0: 7072 696d 732e 6578 7032 2878 292c 2028  prims.exp2(x), (
+00014de0: 7072 696d 732e 6578 7032 2878 292c 2929  prims.exp2(x),))
+00014df0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014e00: 4944 732e 4558 504d 313a 206c 616d 6264  IDs.EXPM1: lambd
+00014e10: 6120 783a 2028 7072 696d 732e 6578 706d  a x: (prims.expm
+00014e20: 3128 7829 2c20 2870 7269 6d73 2e65 7870  1(x), (prims.exp
+00014e30: 6d31 2878 292c 2929 2c0a 2020 2020 7072  m1(x),)),.    pr
+00014e40: 696d 732e 5072 696d 4944 732e 4c47 414d  ims.PrimIDs.LGAM
+00014e50: 4d41 3a20 6c61 6d62 6461 2078 3a20 2870  MA: lambda x: (p
+00014e60: 7269 6d73 2e6c 6761 6d6d 6128 7829 2c20  rims.lgamma(x), 
+00014e70: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+00014e80: 2e50 7269 6d49 4473 2e4e 4454 5249 3a20  .PrimIDs.NDTRI: 
+00014e90: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014ea0: 2e6e 6474 7269 2878 292c 2028 7072 696d  .ndtri(x), (prim
+00014eb0: 732e 6e64 7472 6928 7829 2c29 292c 0a20  s.ndtri(x),)),. 
+00014ec0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014ed0: 2e53 494e 483a 206c 616d 6264 6120 783a  .SINH: lambda x:
+00014ee0: 2028 7072 696d 732e 7369 6e68 2878 292c   (prims.sinh(x),
+00014ef0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014f00: 732e 5072 696d 4944 732e 5351 5254 3a20  s.PrimIDs.SQRT: 
+00014f10: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014f20: 2e73 7172 7428 7829 2c20 2870 7269 6d73  .sqrt(x), (prims
+00014f30: 2e73 7172 7428 7829 2c29 292c 0a20 2020  .sqrt(x),)),.   
+00014f40: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
+00014f50: 4f47 3130 3a20 6c61 6d62 6461 2078 3a20  OG10: lambda x: 
+00014f60: 2870 7269 6d73 2e6c 6f67 3130 2878 292c  (prims.log10(x),
+00014f70: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014f80: 732e 5072 696d 4944 732e 4c4f 4731 503a  s.PrimIDs.LOG1P:
+00014f90: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014fa0: 732e 6c6f 6731 7028 7829 2c20 2878 2c29  s.log1p(x), (x,)
+00014fb0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014fc0: 6d49 4473 2e4c 4f47 323a 206c 616d 6264  mIDs.LOG2: lambd
+00014fd0: 6120 783a 2028 7072 696d 732e 6c6f 6732  a x: (prims.log2
+00014fe0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+00014ff0: 7072 696d 732e 5072 696d 4944 732e 5a45  prims.PrimIDs.ZE
+00015000: 5441 3a20 6c61 6d62 6461 2078 2c20 793a  TA: lambda x, y:
+00015010: 2028 7072 696d 732e 7a65 7461 2878 2c20   (prims.zeta(x, 
+00015020: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
+00015030: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
+00015040: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
+00015050: 3a20 2870 7269 6d73 2e66 6d6f 6428 782c  : (prims.fmod(x,
+00015060: 2079 292c 2028 782c 2079 2929 2c0a 2020   y), (x, y)),.  
+00015070: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00015080: 434f 5059 5f3a 206c 616d 6264 6120 782c  COPY_: lambda x,
+00015090: 2079 3a20 2870 7269 6d73 2e63 6f70 795f   y: (prims.copy_
+000150a0: 2878 2c20 7929 2c20 7475 706c 6528 2929  (x, y), tuple())
+000150b0: 2c0a 7d0a 0a0a 2320 4d61 7070 696e 6720  ,.}...# Mapping 
+000150c0: 6672 6f6d 2073 796d 626f 6c73 2074 6f20  from symbols to 
+000150d0: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
+000150e0: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
+000150f0: 2054 6865 2062 6163 6b77 6172 6420 6675   The backward fu
+00015100: 6e63 7469 6f6e 2074 616b 6573 2074 6865  nction takes the
+00015110: 2072 6573 6964 7561 6c73 2061 6e64 2063   residuals and c
+00015120: 6f74 616e 6765 6e74 7320 616e 6420 7265  otangents and re
+00015130: 7475 726e 7320 7468 650a 2320 7665 6374  turns the.# vect
+00015140: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
+00015150: 7563 7473 2066 6f72 2065 6163 6820 6172  ucts for each ar
+00015160: 6775 6d65 6e74 2e0a 6261 636b 7761 7264  gument..backward
+00015170: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
+00015180: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
+00015190: 533a 206c 616d 6264 6120 782c 2067 3a20  S: lambda x, g: 
+000151a0: 2d67 202f 2070 7269 6d73 2e73 7172 7428  -g / prims.sqrt(
+000151b0: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
+000151c0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+000151d0: 4143 4f53 483a 206c 616d 6264 6120 782c  ACOSH: lambda x,
+000151e0: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
+000151f0: 7172 7428 7820 2a20 7820 2d20 312e 3029  qrt(x * x - 1.0)
+00015200: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00015210: 4944 732e 4153 494e 3a20 6c61 6d62 6461  IDs.ASIN: lambda
+00015220: 2078 2c20 673a 2067 202f 2070 7269 6d73   x, g: g / prims
+00015230: 2e73 7172 7428 312e 3020 2d20 7820 2a20  .sqrt(1.0 - x * 
+00015240: 7829 2c0a 2020 2020 7072 696d 732e 5072  x),.    prims.Pr
+00015250: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
+00015260: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
+00015270: 696d 732e 7273 7172 7428 312e 3020 2b20  ims.rsqrt(1.0 + 
+00015280: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
+00015290: 732e 5072 696d 4944 732e 4154 414e 3a20  s.PrimIDs.ATAN: 
+000152a0: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
+000152b0: 2028 312e 3020 2b20 7820 2a20 7829 2c0a   (1.0 + x * x),.
+000152c0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+000152d0: 732e 4154 414e 483a 206c 616d 6264 6120  s.ATANH: lambda 
+000152e0: 782c 2067 3a20 6720 2f20 2831 2e30 202d  x, g: g / (1.0 -
+000152f0: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
+00015300: 6d73 2e50 7269 6d49 4473 2e43 4f53 483a  ms.PrimIDs.COSH:
+00015310: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
+00015320: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
+00015330: 2e73 696e 6828 7829 292c 0a20 2020 2070  .sinh(x)),.    p
+00015340: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+00015350: 433a 206c 616d 6264 6120 782c 2067 3a20  C: lambda x, g: 
+00015360: 2d67 202a 2032 2e30 202f 206d 6174 682e  -g * 2.0 / math.
+00015370: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
+00015380: 7072 696d 732e 6578 7028 2d78 202a 2078  prims.exp(-x * x
+00015390: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000153a0: 6d49 4473 2e45 5246 494e 563a 206c 616d  mIDs.ERFINV: lam
+000153b0: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
+000153c0: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
+000153d0: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
+000153e0: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
+000153f0: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00015400: 696d 4944 732e 4552 4643 494e 563a 206c  imIDs.ERFCINV: l
+00015410: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
+00015420: 202d 6720 2a20 302e 3520 2a20 6d61 7468   -g * 0.5 * math
+00015430: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
+00015440: 2070 7269 6d73 2e65 7870 2872 6573 756c   prims.exp(resul
+00015450: 742a 2a32 292c 0a20 2020 2070 7269 6d73  t**2),.    prims
+00015460: 2e50 7269 6d49 4473 2e45 5850 323a 206c  .PrimIDs.EXP2: l
+00015470: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
+00015480: 2067 202a 2072 6573 756c 7420 2a20 6d61   g * result * ma
+00015490: 7468 2e6c 6f67 2832 2e30 292c 0a20 2020  th.log(2.0),.   
+000154a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+000154b0: 5850 4d31 3a20 6c61 6d62 6461 2072 6573  XPM1: lambda res
+000154c0: 756c 742c 2067 3a20 6720 2a20 2872 6573  ult, g: g * (res
+000154d0: 756c 7420 2b20 312e 3029 2c0a 2020 2020  ult + 1.0),.    
+000154e0: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
+000154f0: 414d 4d41 3a20 6c61 6d62 6461 2078 2c20  AMMA: lambda x, 
+00015500: 673a 2067 202a 2070 7269 6d73 2e64 6967  g: g * prims.dig
+00015510: 616d 6d61 2878 292c 0a20 2020 2070 7269  amma(x),.    pri
+00015520: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
+00015530: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
+00015540: 2067 3a20 6720 2a20 7072 696d 732e 6578   g: g * prims.ex
+00015550: 7028 302e 3520 2a20 7265 7375 6c74 2a2a  p(0.5 * result**
+00015560: 3229 202a 206d 6174 682e 7371 7274 2832  2) * math.sqrt(2
+00015570: 2e30 202a 206d 6174 682e 7069 292c 0a20  .0 * math.pi),. 
+00015580: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00015590: 2e53 494e 483a 206c 616d 6264 6120 782c  .SINH: lambda x,
+000155a0: 2067 3a20 7072 696d 732e 6d75 6c28 672c   g: prims.mul(g,
+000155b0: 2070 7269 6d73 2e63 6f73 6828 7829 292c   prims.cosh(x)),
+000155c0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000155d0: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
+000155e0: 7265 7375 6c74 2c20 673a 2067 202f 2028  result, g: g / (
+000155f0: 322e 3020 2a20 7265 7375 6c74 292c 0a20  2.0 * result),. 
+00015600: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00015610: 2e4c 4f47 3130 3a20 6c61 6d62 6461 2078  .LOG10: lambda x
+00015620: 2c20 673a 2067 202f 2028 7820 2a20 322e  , g: g / (x * 2.
+00015630: 3330 3235 3835 3039 3239 3934 3034 3629  302585092994046)
+00015640: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00015650: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
+00015660: 6120 782c 2067 3a20 6720 2f20 2878 202b  a x, g: g / (x +
+00015670: 2031 292c 0a20 2020 2070 7269 6d73 2e50   1),.    prims.P
+00015680: 7269 6d49 4473 2e4c 4f47 323a 206c 616d  rimIDs.LOG2: lam
+00015690: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
+000156a0: 202a 2030 2e36 3933 3134 3731 3830 3535   * 0.69314718055
+000156b0: 3939 3435 3329 2c0a 2020 2020 7072 696d  99453),.    prim
+000156c0: 732e 5072 696d 4944 732e 464d 4f44 3a20  s.PrimIDs.FMOD: 
+000156d0: 6c61 6d62 6461 2078 2c20 792c 2067 3a20  lambda x, y, g: 
+000156e0: 2867 2c20 2d67 202a 2070 7269 6d73 2e74  (g, -g * prims.t
+000156f0: 7275 6e63 2878 202f 2079 2929 2c0a 2020  runc(x / y)),.  
+00015700: 2020 2320 5468 6520 636f 7079 2073 686f    # The copy sho
+00015710: 756c 6420 6e6f 7420 6265 2064 6966 6665  uld not be diffe
+00015720: 7265 6e74 6961 626c 652e 2057 6520 7265  rentiable. We re
+00015730: 7475 726e 204e 6f6e 6520 746f 2065 6e61  turn None to ena
+00015740: 626c 6520 7468 6520 6765 6e65 7261 7469  ble the generati
+00015750: 6f6e 206f 6620 7468 6520 6261 636b 7761  on of the backwa
+00015760: 7264 2067 7261 7068 2074 6872 6f75 6768  rd graph through
+00015770: 2074 6865 6d2e 0a20 2020 2070 7269 6d73   them..    prims
+00015780: 2e50 7269 6d49 4473 2e43 4f50 595f 3a20  .PrimIDs.COPY_: 
+00015790: 6c61 6d62 6461 2067 3a20 284e 6f6e 652c  lambda g: (None,
+000157a0: 204e 6f6e 6529 2c0a 7d0a 0a0a 6465 6620   None),.}...def 
+000157b0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+000157c0: 6564 5f66 6f72 7761 7264 286f 7029 3a0a  ed_forward(op):.
+000157d0: 2020 2020 2222 2244 6563 6f72 6174 6f72      """Decorator
+000157e0: 2074 6f20 7265 6769 7374 6572 2061 6e20   to register an 
+000157f0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
+00015800: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
+00015810: 2066 6f72 2061 2073 796d 626f 6c2e 0a0a   for a symbol...
+00015820: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00015830: 2020 6f70 2028 4f70 7329 3a20 5379 6d62    op (Ops): Symb
+00015840: 6f6c 2066 6f72 2077 6869 6368 2074 6f20  ol for which to 
+00015850: 7265 6769 7374 6572 2074 6865 2061 7567  register the aug
+00015860: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
+00015870: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0a0a  mplementation...
+00015880: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00015890: 2020 2020 2043 616c 6c61 626c 653a 2044       Callable: D
+000158a0: 6563 6f72 6174 6f72 2066 756e 6374 696f  ecorator functio
+000158b0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
+000158c0: 6465 6620 6465 636f 7261 746f 7228 6675  def decorator(fu
+000158d0: 6e63 293a 0a20 2020 2020 2020 2061 7567  nc):.        aug
+000158e0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
+000158f0: 6d70 6c73 5b6f 705d 203d 2066 756e 630a  mpls[op] = func.
+00015900: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00015910: 756e 630a 0a20 2020 2072 6574 7572 6e20  unc..    return 
+00015920: 6465 636f 7261 746f 720a 0a0a 6465 6620  decorator...def 
+00015930: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+00015940: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
+00015950: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
+00015960: 7465 7220 6120 6261 636b 7761 7264 2069  ter a backward i
+00015970: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
+00015980: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
+00015990: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
+000159a0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
+000159b0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
+000159c0: 6973 7465 7220 7468 6520 6261 636b 7761  ister the backwa
+000159d0: 7264 2069 6d70 6c65 6d65 6e74 6174 696f  rd implementatio
+000159e0: 6e2e 0a0a 2020 2020 5265 7475 726e 733a  n...    Returns:
+000159f0: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
+00015a00: 653a 2044 6563 6f72 6174 6f72 2066 756e  e: Decorator fun
+00015a10: 6374 696f 6e2e 0a20 2020 2022 2222 0a0a  ction..    """..
+00015a20: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
+00015a30: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
+00015a40: 2062 6163 6b77 6172 645f 696d 706c 735b   backward_impls[
+00015a50: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
+00015a60: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
+00015a70: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
+00015a80: 6174 6f72 0a0a 0a64 6566 2072 6573 746f  ator...def resto
+00015a90: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
+00015aa0: 782c 2072 6564 7563 6564 5f64 696d 732c  x, reduced_dims,
+00015ab0: 206f 7269 6769 6e61 6c5f 7368 6170 6529   original_shape)
+00015ac0: 3a0a 2020 2020 2222 2252 6573 746f 7265  :.    """Restore
+00015ad0: 7320 7468 6520 7265 6475 6365 6420 6469  s the reduced di
+00015ae0: 6d65 6e73 696f 6e73 206f 6620 6120 7465  mensions of a te
+00015af0: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
+00015b00: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
+00015b10: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
+00015b20: 2062 6520 7265 7368 6170 6564 2e0a 2020   be reshaped..  
+00015b30: 2020 2020 2020 7265 6475 6365 645f 6469        reduced_di
+00015b40: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
+00015b50: 2e2e 5d29 3a20 5475 706c 6520 6f66 2072  ..]): Tuple of r
+00015b60: 6564 7563 6564 2064 696d 656e 7369 6f6e  educed dimension
+00015b70: 732e 0a20 2020 2020 2020 206f 7269 6769  s..        origi
+00015b80: 6e61 6c5f 7368 6170 6520 2854 7570 6c65  nal_shape (Tuple
+00015b90: 5b69 6e74 2c20 2e2e 2e5d 293a 204f 7269  [int, ...]): Ori
+00015ba0: 6769 6e61 6c20 7368 6170 6520 6f66 2074  ginal shape of t
+00015bb0: 6865 2074 656e 736f 722e 0a0a 2020 2020  he tensor...    
+00015bc0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00015bd0: 2056 6172 6961 626c 653a 2054 656e 736f   Variable: Tenso
+00015be0: 7220 7769 7468 2074 6865 2072 6564 7563  r with the reduc
+00015bf0: 6564 2064 696d 656e 7369 6f6e 7320 7265  ed dimensions re
+00015c00: 7374 6f72 6564 2e0a 2020 2020 2222 220a  stored..    """.
+00015c10: 2020 2020 6966 206f 7269 6769 6e61 6c5f      if original_
+00015c20: 7368 6170 6520 3d3d 2028 293a 2020 2320  shape == ():  # 
+00015c30: 7363 616c 6172 0a20 2020 2020 2020 2072  scalar.        r
+00015c40: 6574 7572 6e20 780a 0a20 2020 2075 6e73  eturn x..    uns
+00015c50: 7175 6565 7a65 6420 3d20 636c 616e 672e  queezed = clang.
+00015c60: 756e 7371 7565 657a 6528 782c 2072 6564  unsqueeze(x, red
+00015c70: 7563 6564 5f64 696d 7329 0a20 2020 2072  uced_dims).    r
+00015c80: 6574 7572 6e20 636c 616e 672e 6578 7061  eturn clang.expa
+00015c90: 6e64 2875 6e73 7175 6565 7a65 642c 206f  nd(unsqueezed, o
+00015ca0: 7269 6769 6e61 6c5f 7368 6170 6529 0a0a  riginal_shape)..
+00015cb0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00015cc0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00015cd0: 732e 5a45 5441 290a 6465 6620 7a65 7461  s.ZETA).def zeta
+00015ce0: 5f62 6163 6b77 6172 6428 782c 2079 2c20  _backward(x, y, 
+00015cf0: 6729 3a0a 2020 2020 2320 5468 6520 6465  g):.    # The de
+00015d00: 7269 7661 7469 7665 2077 7274 2074 6865  rivative wrt the
+00015d10: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
+00015d20: 6973 206e 6f74 2065 7870 7265 7373 6962  is not expressib
+00015d30: 6c65 2069 6e20 7465 726d 7320 6f66 207a  le in terms of z
+00015d40: 6574 6120 6f72 0a20 2020 2023 206f 7468  eta or.    # oth
+00015d50: 6572 2073 7065 6369 616c 2066 756e 6374  er special funct
+00015d60: 696f 6e73 0a20 2020 2023 2054 6865 7265  ions.    # There
+00015d70: 666f 7265 2c20 7765 2063 6f6d 7075 7465  fore, we compute
+00015d80: 206f 6e6c 7920 7468 6520 6465 7269 7661   only the deriva
+00015d90: 7469 7665 2077 7274 2074 6865 2073 6563  tive wrt the sec
+00015da0: 6f6e 6420 6172 6775 6d65 6e74 0a20 2020  ond argument.   
+00015db0: 2067 7920 3d20 6720 2a20 2d78 202a 2070   gy = g * -x * p
+00015dc0: 7269 6d73 2e7a 6574 6128 7820 2b20 312e  rims.zeta(x + 1.
+00015dd0: 302c 2079 290a 0a20 2020 2023 2052 6574  0, y)..    # Ret
+00015de0: 7572 6e20 6120 6d61 7070 7069 6e67 2066  urn a mappping f
+00015df0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
+00015e00: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
+00015e10: 2067 7261 6469 656e 7473 0a20 2020 2072   gradients.    r
+00015e20: 6574 7572 6e20 7b22 7922 3a20 6779 7d0a  eturn {"y": gy}.
+00015e30: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00015e40: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+00015e50: 4473 2e44 4947 414d 4d41 290a 6465 6620  Ds.DIGAMMA).def 
+00015e60: 6469 6761 6d6d 615f 6261 636b 7761 7264  digamma_backward
+00015e70: 2861 3a20 5072 6f78 792c 2067 293a 0a20  (a: Proxy, g):. 
+00015e80: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+00015e90: 746f 7263 6820 696d 706f 7274 2070 6f6c  torch import pol
+00015ea0: 7967 616d 6d61 0a0a 2020 2020 7265 7475  ygamma..    retu
+00015eb0: 726e 2067 202a 2070 6f6c 7967 616d 6d61  rn g * polygamma
+00015ec0: 2831 2c20 6129 0a0a 0a40 7265 6769 7374  (1, a)...@regist
+00015ed0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+00015ee0: 7761 7264 2822 746f 7263 682e 706f 6c79  ward("torch.poly
+00015ef0: 6761 6d6d 6122 290a 6465 6620 706f 6c79  gamma").def poly
+00015f00: 6761 6d6d 615f 6175 675f 6677 6428 6e3a  gamma_aug_fwd(n:
+00015f10: 2069 6e74 2c20 613a 2050 726f 7879 293a   int, a: Proxy):
+00015f20: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00015f30: 722e 746f 7263 6820 696d 706f 7274 2070  r.torch import p
+00015f40: 6f6c 7967 616d 6d61 0a0a 2020 2020 7072  olygamma..    pr
+00015f50: 696d 616c 203d 2070 6f6c 7967 616d 6d61  imal = polygamma
+00015f60: 286e 2c20 6129 0a20 2020 2072 6573 6964  (n, a).    resid
+00015f70: 7561 6c73 203d 2028 6e2c 2061 290a 2020  uals = (n, a).  
+00015f80: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00015f90: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+00015fa0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+00015fb0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
+00015fc0: 706f 6c79 6761 6d6d 6122 290a 6465 6620  polygamma").def 
+00015fd0: 706f 6c79 6761 6d6d 615f 6261 636b 7761  polygamma_backwa
+00015fe0: 7264 286e 3a20 696e 742c 2061 3a20 5072  rd(n: int, a: Pr
+00015ff0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
+00016000: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00016010: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
+00016020: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
+00016030: 652c 2067 202a 2070 6f6c 7967 616d 6d61  e, g * polygamma
+00016040: 286e 202b 2031 2c20 6129 0a0a 0a40 7265  (n + 1, a)...@re
+00016050: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00016060: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
+00016070: 414e 3229 0a64 6566 2061 7461 6e32 5f62  AN2).def atan2_b
+00016080: 6163 6b77 6172 6428 782c 2079 2c20 6729  ackward(x, y, g)
+00016090: 3a0a 2020 2020 616c 7068 6120 3d20 312e  :.    alpha = 1.
+000160a0: 3020 2f20 2878 202a 2078 202b 2079 202a  0 / (x * x + y *
+000160b0: 2079 290a 2020 2020 6772 6164 5f78 203d   y).    grad_x =
+000160c0: 2067 202a 2079 202a 2061 6c70 6861 0a20   g * y * alpha. 
+000160d0: 2020 2067 7261 645f 7920 3d20 6720 2a20     grad_y = g * 
+000160e0: 2d78 202a 2061 6c70 6861 0a20 2020 2072  -x * alpha.    r
+000160f0: 6574 7572 6e20 6772 6164 5f78 2c20 6772  eturn grad_x, gr
+00016100: 6164 5f79 0a0a 0a40 7265 6769 7374 6572  ad_y...@register
+00016110: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00016120: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+00016130: 2e56 4152 290a 6465 6620 7661 725f 6175  .VAR).def var_au
+00016140: 675f 6677 6428 612c 2064 696d 2c20 2a2c  g_fwd(a, dim, *,
+00016150: 2063 6f72 7265 6374 696f 6e29 3a0a 2020   correction):.  
+00016160: 2020 7620 3d20 7072 696d 732e 7661 7228    v = prims.var(
+00016170: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
+00016180: 6f6e 3d63 6f72 7265 6374 696f 6e29 0a20  on=correction). 
+00016190: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+000161a0: 6c28 2876 2c29 2c20 2861 2c20 6469 6d2c  l((v,), (a, dim,
+000161b0: 2063 6f72 7265 6374 696f 6e2c 2076 2929   correction, v))
+000161c0: 0a0a 0a23 2054 4f44 4f3a 2066 6978 2064  ...# TODO: fix d
+000161d0: 6976 6973 696f 6e20 6279 207a 6572 6f20  ivision by zero 
+000161e0: 7768 656e 206e 5f65 6c65 6d5f 7265 6475  when n_elem_redu
+000161f0: 6365 6420 3d3d 2030 206f 7220 7768 656e  ced == 0 or when
+00016200: 2076 2e6e 756d 656c 203d 3d20 300a 2320   v.numel == 0.# 
+00016210: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
+00016220: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
+00016230: 6d69 6c61 722e 0a23 2054 4f44 4f3a 2066  milar..# TODO: f
+00016240: 6978 2067 7261 6420 7768 656e 2063 6f72  ix grad when cor
+00016250: 7265 6374 696f 6e20 3e20 6e5f 656c 656d  rection > n_elem
+00016260: 5f72 6564 7563 6564 2e0a 4072 6567 6973  _reduced..@regis
+00016270: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
+00016280: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
+00016290: 6465 6620 7661 725f 6261 636b 7761 7264  def var_backward
+000162a0: 2861 2c20 6469 6d2c 2063 6f72 7265 6374  (a, dim, correct
+000162b0: 696f 6e2c 2076 2c20 6729 3a0a 2020 2020  ion, v, g):.    
+000162c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
+000162d0: 2061 2e6e 756d 656c 2829 202f 2f20 762e   a.numel() // v.
+000162e0: 6e75 6d65 6c28 2920 6966 2061 2e6e 756d  numel() if a.num
+000162f0: 656c 2829 2021 3d20 3020 656c 7365 2031  el() != 0 else 1
+00016300: 0a20 2020 206e 6f72 6d61 6c69 7a61 7469  .    normalizati
+00016310: 6f6e 5f73 6361 6c61 7220 3d20 6e5f 656c  on_scalar = n_el
+00016320: 656d 5f72 6564 7563 6564 202d 2063 6f72  em_reduced - cor
+00016330: 7265 6374 696f 6e0a 2020 2020 6720 3d20  rection.    g = 
+00016340: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
+00016350: 6469 6d73 2867 2c20 6469 6d2c 2061 2e73  dims(g, dim, a.s
+00016360: 6861 7065 290a 2020 2020 6966 2061 2e64  hape).    if a.d
+00016370: 7479 7065 2021 3d20 762e 6474 7970 653a  type != v.dtype:
+00016380: 0a20 2020 2020 2020 2061 203d 2070 7269  .        a = pri
+00016390: 6d73 2e63 6f6e 7665 7274 5f65 6c65 6d65  ms.convert_eleme
+000163a0: 6e74 5f74 7970 6528 612c 2076 2e64 7479  nt_type(a, v.dty
+000163b0: 7065 290a 2020 2020 6d65 616e 203d 2070  pe).    mean = p
+000163c0: 7269 6d73 2e73 756d 2861 2c20 6469 6d29  rims.sum(a, dim)
+000163d0: 202f 206e 5f65 6c65 6d5f 7265 6475 6365   / n_elem_reduce
+000163e0: 640a 2020 2020 6d65 616e 203d 2072 6573  d.    mean = res
+000163f0: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
+00016400: 7328 6d65 616e 2c20 6469 6d2c 2061 2e73  s(mean, dim, a.s
+00016410: 6861 7065 290a 2020 2020 7265 7475 726e  hape).    return
+00016420: 2028 3220 2a20 6720 2a20 2861 202d 206d   (2 * g * (a - m
+00016430: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
+00016440: 6174 696f 6e5f 7363 616c 6172 0a0a 0a64  ation_scalar...d
+00016450: 6566 206e 5f65 6c65 6d5f 7265 6475 6365  ef n_elem_reduce
+00016460: 6428 615f 6e64 696d 2c20 615f 7368 6170  d(a_ndim, a_shap
+00016470: 652c 2064 696d 7329 3a0a 2020 2020 6469  e, dims):.    di
+00016480: 6d73 203d 2075 7469 6c73 2e63 616e 6f6e  ms = utils.canon
+00016490: 6963 616c 697a 655f 6469 6d73 2861 5f6e  icalize_dims(a_n
+000164a0: 6469 6d2c 2064 696d 7329 0a20 2020 2072  dim, dims).    r
+000164b0: 6564 7563 7469 6f6e 5f73 697a 6520 3d20  eduction_size = 
+000164c0: 310a 2020 2020 666f 7220 6964 782c 2073  1.    for idx, s
+000164d0: 697a 6520 696e 2065 6e75 6d65 7261 7465  ize in enumerate
+000164e0: 2861 5f73 6861 7065 293a 0a20 2020 2020  (a_shape):.     
+000164f0: 2020 2069 6620 6964 7820 696e 2064 696d     if idx in dim
+00016500: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00016510: 6564 7563 7469 6f6e 5f73 697a 6520 2a3d  eduction_size *=
+00016520: 2073 697a 650a 2020 2020 7265 7475 726e   size.    return
+00016530: 2072 6564 7563 7469 6f6e 5f73 697a 650a   reduction_size.
+00016540: 0a0a 6465 6620 6d65 616e 5f62 6163 6b77  ..def mean_backw
+00016550: 6172 6428 615f 6e64 696d 2c20 615f 7368  ard(a_ndim, a_sh
+00016560: 6170 652c 2064 696d 732c 2067 7261 6429  ape, dims, grad)
+00016570: 3a0a 2020 2020 6d65 616e 5f6c 6f63 616c  :.    mean_local
+00016580: 5f67 7261 6420 3d20 312e 3020 2f20 6e5f  _grad = 1.0 / n_
+00016590: 656c 656d 5f72 6564 7563 6564 2861 5f6e  elem_reduced(a_n
+000165a0: 6469 6d2c 2061 5f73 6861 7065 2c20 6469  dim, a_shape, di
+000165b0: 6d73 290a 2020 2020 7265 7475 726e 2072  ms).    return r
+000165c0: 6573 746f 7265 5f72 6564 7563 6564 5f64  estore_reduced_d
+000165d0: 696d 7328 6772 6164 2c20 6469 6d73 2c20  ims(grad, dims, 
+000165e0: 615f 7368 6170 6529 202a 206d 6561 6e5f  a_shape) * mean_
+000165f0: 6c6f 6361 6c5f 6772 6164 0a0a 0a40 7265  local_grad...@re
+00016600: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+00016610: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
+00016620: 7269 6d49 4473 2e50 4144 290a 6465 6620  rimIDs.PAD).def 
+00016630: 7061 645f 6175 675f 6677 6428 612c 2070  pad_aug_fwd(a, p
+00016640: 6164 6469 6e67 5f76 616c 7565 2c20 7061  adding_value, pa
+00016650: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
+00016660: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+00016670: 6c28 2870 7269 6d73 2e70 6164 2861 2c20  l((prims.pad(a, 
+00016680: 7061 6464 696e 675f 7661 6c75 652c 2070  padding_value, p
+00016690: 6164 6469 6e67 5f63 6f6e 6669 6729 2c29  adding_config),)
+000166a0: 2c20 2861 2c20 7061 6464 696e 675f 636f  , (a, padding_co
+000166b0: 6e66 6967 2929 0a0a 0a40 7265 6769 7374  nfig))...@regist
+000166c0: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+000166d0: 732e 5072 696d 4944 732e 5041 4429 0a64  s.PrimIDs.PAD).d
+000166e0: 6566 2070 6164 5f62 6163 6b77 6172 6428  ef pad_backward(
+000166f0: 612c 2070 6164 6469 6e67 5f63 6f6e 6669  a, padding_confi
+00016700: 672c 2067 293a 0a20 2020 2023 2053 686f  g, g):.    # Sho
+00016710: 7274 2063 6972 6375 6974 206f 6e20 656d  rt circuit on em
+00016720: 7074 7920 696e 7075 742e 0a20 2020 2069  pty input..    i
+00016730: 6620 616e 7928 6469 6d20 3d3d 2030 2066  f any(dim == 0 f
+00016740: 6f72 2064 696d 2069 6e20 612e 7368 6170  or dim in a.shap
+00016750: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+00016760: 726e 2066 756c 6c5f 6c69 6b65 2861 2c20  rn full_like(a, 
+00016770: 6669 6c6c 5f76 616c 7565 3d30 290a 0a20  fill_value=0).. 
+00016780: 2020 2023 2055 6e2d 7061 6420 6279 2070     # Un-pad by p
+00016790: 6164 6469 6e67 2077 6974 6820 7a65 726f  adding with zero
+000167a0: 2076 616c 7565 730a 2020 2020 7a65 726f   values.    zero
+000167b0: 5f70 6164 6469 6e67 5f63 6f6e 6669 6720  _padding_config 
+000167c0: 3d20 5b28 2d6c 6f2c 202d 6869 2c20 3029  = [(-lo, -hi, 0)
+000167d0: 2066 6f72 206c 6f2c 2068 692c 205f 2069   for lo, hi, _ i
+000167e0: 6e20 7061 6464 696e 675f 636f 6e66 6967  n padding_config
+000167f0: 5d0a 0a20 2020 2067 203d 2070 7269 6d73  ]..    g = prims
+00016800: 2e70 6164 2867 2c20 302e 302c 207a 6572  .pad(g, 0.0, zer
+00016810: 6f5f 7061 6464 696e 675f 636f 6e66 6967  o_padding_config
+00016820: 290a 0a20 2020 2023 2055 6e2d 736c 6963  )..    # Un-slic
+00016830: 6520 6279 2073 6c69 6369 6e67 2077 6974  e by slicing wit
+00016840: 6820 6120 7374 7269 6465 206f 6620 7661  h a stride of va
+00016850: 6c75 6520 2864 696c 6174 696f 6e20 2b20  lue (dilation + 
+00016860: 3129 0a20 2020 2066 6f72 2064 696d 2c20  1).    for dim, 
+00016870: 285f 2c20 5f2c 2064 2920 696e 2065 6e75  (_, _, d) in enu
+00016880: 6d65 7261 7465 2870 6164 6469 6e67 5f63  merate(padding_c
+00016890: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
+000168a0: 6720 3d20 736c 6963 655f 696e 5f64 696d  g = slice_in_dim
+000168b0: 2867 2c20 302c 2067 2e73 6861 7065 5b64  (g, 0, g.shape[d
+000168c0: 696d 5d2c 2073 7472 6964 653d 6420 2b20  im], stride=d + 
+000168d0: 312c 2064 696d 3d64 696d 290a 0a20 2020  1, dim=dim)..   
+000168e0: 2072 6574 7572 6e20 670a 0a0a 4072 6567   return g...@reg
+000168f0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00016900: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00016910: 696d 4944 732e 5052 4f44 290a 6465 6620  imIDs.PROD).def 
+00016920: 7072 6f64 5f61 7567 5f66 7764 2878 2c20  prod_aug_fwd(x, 
+00016930: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
+00016940: 676d 656e 7465 6420 7072 6f64 206f 7065  gmented prod ope
+00016950: 7261 7469 6f6e 2e0a 0a20 2020 2041 7267  ration...    Arg
+00016960: 733a 0a20 2020 2020 2020 2078 2028 5661  s:.        x (Va
+00016970: 7269 6162 6c65 293a 2054 656e 736f 7220  riable): Tensor 
+00016980: 746f 2062 6520 6d75 6c74 6970 6c69 6564  to be multiplied
+00016990: 2e0a 2020 2020 2020 2020 6469 6d73 2028  ..        dims (
+000169a0: 5475 706c 655b 696e 742c 202e 2e2e 5d29  Tuple[int, ...])
+000169b0: 3a20 4469 6d65 6e73 696f 6e73 2074 6f20  : Dimensions to 
+000169c0: 6265 206d 756c 7469 706c 6965 642e 0a0a  be multiplied...
+000169d0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000169e0: 2020 2020 2056 4a50 4475 616c 3a20 5072       VJPDual: Pr
+000169f0: 696d 616c 2061 6e64 2072 6573 6964 7561  imal and residua
+00016a00: 6c73 2e0a 2020 2020 2222 220a 2020 2020  ls..    """.    
+00016a10: 7072 696d 616c 203d 2070 7269 6d73 2e70  primal = prims.p
+00016a20: 726f 6428 782c 2064 696d 7329 0a0a 2020  rod(x, dims)..  
+00016a30: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
+00016a40: 2020 2020 2020 2020 7072 696d 616c 2c0a          primal,.
+00016a50: 2020 2020 2020 2020 782c 0a20 2020 2020          x,.     
+00016a60: 2020 2078 2e73 6861 7065 2c0a 2020 2020     x.shape,.    
+00016a70: 2020 2020 6469 6d73 2c0a 2020 2020 290a      dims,.    ).
+00016a80: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00016a90: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00016aa0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00016ab0: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00016ac0: 2e50 7269 6d49 4473 2e50 524f 4429 0a64  .PrimIDs.PROD).d
+00016ad0: 6566 2070 726f 645f 7075 6c6c 6261 636b  ef prod_pullback
+00016ae0: 2870 7269 6d61 6c2c 2078 2c20 785f 7368  (primal, x, x_sh
+00016af0: 6170 652c 2072 6564 7563 6564 5f64 696d  ape, reduced_dim
+00016b00: 732c 2067 293a 0a20 2020 2072 6574 7572  s, g):.    retur
+00016b10: 6e20 7072 696d 732e 6469 7628 7265 7374  n prims.div(rest
+00016b20: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
+00016b30: 2870 7269 6d61 6c20 2a20 672c 2072 6564  (primal * g, red
+00016b40: 7563 6564 5f64 696d 732c 2078 5f73 6861  uced_dims, x_sha
+00016b50: 7065 292c 2078 290a 0a0a 6465 6620 6b65  pe), x)...def ke
+00016b60: 6570 6469 6d5f 7265 6475 6374 696f 6e28  epdim_reduction(
+00016b70: 7265 6475 6374 696f 6e5f 666e 2c20 782c  reduction_fn, x,
+00016b80: 2064 696d 7329 3a0a 2020 2020 2222 2241   dims):.    """A
+00016b90: 7070 6c69 6573 2072 6564 7563 7469 6f6e  pplies reduction
+00016ba0: 2061 6e64 2066 6978 6573 206f 7574 7075   and fixes outpu
+00016bb0: 7420 746f 2063 6f6e 666f 726d 2074 6f20  t to conform to 
+00016bc0: 6b65 6570 6469 6d3d 5472 7565 2222 220a  keepdim=True""".
+00016bd0: 2020 2020 6f75 7420 3d20 7265 6475 6374      out = reduct
+00016be0: 696f 6e5f 666e 2878 2c20 6469 6d73 290a  ion_fn(x, dims).
+00016bf0: 2020 2020 6172 676d 6178 5f73 756d 5f6f      argmax_sum_o
+00016c00: 7574 5f73 6861 7065 203d 205b 782e 7368  ut_shape = [x.sh
+00016c10: 6170 655b 695d 2069 6620 6920 6e6f 7420  ape[i] if i not 
+00016c20: 696e 2064 696d 7320 656c 7365 2031 2066  in dims else 1 f
+00016c30: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
+00016c40: 6e64 696d 295d 0a20 2020 2062 726f 6164  ndim)].    broad
+00016c50: 6361 7374 5f64 696d 7320 3d20 5b69 2066  cast_dims = [i f
+00016c60: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
+00016c70: 6e64 696d 2920 6966 2069 206e 6f74 2069  ndim) if i not i
+00016c80: 6e20 6469 6d73 5d0a 2020 2020 7265 7475  n dims].    retu
+00016c90: 726e 2070 7269 6d73 2e62 726f 6164 6361  rn prims.broadca
+00016ca0: 7374 5f69 6e5f 6469 6d28 6f75 742c 2061  st_in_dim(out, a
+00016cb0: 7267 6d61 785f 7375 6d5f 6f75 745f 7368  rgmax_sum_out_sh
+00016cc0: 6170 652c 2062 726f 6164 6361 7374 5f64  ape, broadcast_d
+00016cd0: 696d 7329 0a0a 0a23 2049 6e73 7069 7265  ims)...# Inspire
+00016ce0: 6420 6672 6f6d 2068 7474 7073 3a2f 2f67  d from https://g
+00016cf0: 6974 6875 622e 636f 6d2f 4849 5053 2f61  ithub.com/HIPS/a
+00016d00: 7574 6f67 7261 642f 626c 6f62 2f6d 6173  utograd/blob/mas
+00016d10: 7465 722f 6175 746f 6772 6164 2f6e 756d  ter/autograd/num
+00016d20: 7079 2f6e 756d 7079 5f76 6a70 732e 7079  py/numpy_vjps.py
+00016d30: 234c 3335 330a 6465 6620 6772 6164 5f63  #L353.def grad_c
+00016d40: 686f 6f73 6572 5f62 6163 6b77 6172 6428  hooser_backward(
+00016d50: 7072 696d 616c 2c20 782c 2078 5f73 6861  primal, x, x_sha
+00016d60: 7065 2c20 7265 6475 6365 645f 6469 6d73  pe, reduced_dims
+00016d70: 2c20 6729 3a0a 2020 2020 2222 2242 7569  , g):.    """Bui
+00016d80: 6c64 7320 6772 6164 6965 6e74 206f 6620  lds gradient of 
+00016d90: 6675 6e63 7469 6f6e 7320 7468 6174 2063  functions that c
+00016da0: 686f 6f73 6520 6120 7369 6e67 6c65 2069  hoose a single i
+00016db0: 7465 6d2c 2073 7563 6820 6173 206d 696e  tem, such as min
+00016dc0: 206f 7220 6d61 782e 2222 220a 2020 2020   or max.""".    
+00016dd0: 675f 7265 7065 6174 6564 203d 2072 6573  g_repeated = res
+00016de0: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
+00016df0: 7328 672c 2072 6564 7563 6564 5f64 696d  s(g, reduced_dim
+00016e00: 732c 2078 5f73 6861 7065 290a 2020 2020  s, x_shape).    
+00016e10: 7072 696d 616c 5f72 6570 6561 7465 6420  primal_repeated 
+00016e20: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
+00016e30: 645f 6469 6d73 2870 7269 6d61 6c2c 2072  d_dims(primal, r
+00016e40: 6564 7563 6564 5f64 696d 732c 2078 5f73  educed_dims, x_s
+00016e50: 6861 7065 290a 2020 2020 6172 676d 6178  hape).    argmax
+00016e60: 5f6c 6f63 6174 696f 6e73 203d 2078 203d  _locations = x =
+00016e70: 3d20 7072 696d 616c 5f72 6570 6561 7465  = primal_repeate
+00016e80: 640a 2020 2020 6172 676d 6178 5f73 756d  d.    argmax_sum
+00016e90: 203d 206b 6565 7064 696d 5f72 6564 7563   = keepdim_reduc
+00016ea0: 7469 6f6e 2870 7269 6d73 2e73 756d 2c20  tion(prims.sum, 
+00016eb0: 6172 676d 6178 5f6c 6f63 6174 696f 6e73  argmax_locations
+00016ec0: 2c20 7265 6475 6365 645f 6469 6d73 290a  , reduced_dims).
+00016ed0: 2020 2020 6f75 7420 3d20 675f 7265 7065      out = g_repe
+00016ee0: 6174 6564 202a 2061 7267 6d61 785f 6c6f  ated * argmax_lo
+00016ef0: 6361 7469 6f6e 7320 2f20 6172 676d 6178  cations / argmax
+00016f00: 5f73 756d 0a20 2020 2072 6574 7572 6e20  _sum.    return 
+00016f10: 6f75 740a 0a0a 7265 6769 7374 6572 5f62  out...register_b
+00016f20: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
+00016f30: 696d 4944 732e 414d 494e 2928 6772 6164  imIDs.AMIN)(grad
+00016f40: 5f63 686f 6f73 6572 5f62 6163 6b77 6172  _chooser_backwar
+00016f50: 6429 0a0a 0a40 7265 6769 7374 6572 5f61  d)...@register_a
+00016f60: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00016f70: 2870 7269 6d73 2e50 7269 6d49 4473 2e41  (prims.PrimIDs.A
+00016f80: 4d49 4e29 0a64 6566 2061 6d69 6e5f 6175  MIN).def amin_au
+00016f90: 675f 6677 6428 782c 2064 696d 7329 3a0a  g_fwd(x, dims):.
+00016fa0: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
+00016fb0: 2061 6d69 6e20 6f70 6572 6174 696f 6e2e   amin operation.
+00016fc0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00016fd0: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
+00016fe0: 2054 656e 736f 7220 746f 2063 6f6d 7075   Tensor to compu
+00016ff0: 7465 2061 6d69 6e20 6f6e 2e0a 2020 2020  te amin on..    
+00017000: 2020 2020 6469 6d73 2028 5475 706c 655b      dims (Tuple[
+00017010: 696e 742c 202e 2e2e 5d29 3a20 4469 6d65  int, ...]): Dime
+00017020: 6e73 696f 6e73 2074 6f20 636f 6d70 7574  nsions to comput
+00017030: 6520 616d 696e 206f 7665 722e 0a20 2020  e amin over..   
+00017040: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00017050: 2020 564a 5044 7561 6c3a 2050 7269 6d61    VJPDual: Prima
+00017060: 6c20 616e 6420 7265 7369 6475 616c 732e  l and residuals.
+00017070: 0a20 2020 2022 2222 0a20 2020 2070 7269  .    """.    pri
+00017080: 6d61 6c20 3d20 7072 696d 732e 616d 696e  mal = prims.amin
+00017090: 2878 2c20 6469 6d73 290a 0a20 2020 2072  (x, dims)..    r
+000170a0: 6573 6964 7561 6c73 203d 2028 0a20 2020  esiduals = (.   
+000170b0: 2020 2020 2070 7269 6d61 6c2c 0a20 2020       primal,.   
+000170c0: 2020 2020 2078 2c0a 2020 2020 2020 2020       x,.        
+000170d0: 782e 7368 6170 652c 0a20 2020 2020 2020  x.shape,.       
+000170e0: 2064 696d 732c 0a20 2020 2029 0a0a 2020   dims,.    )..  
+000170f0: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00017100: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+00017110: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+00017120: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00017130: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00017140: 504f 5729 0a64 6566 2070 6f77 5f61 7567  POW).def pow_aug
+00017150: 5f66 6564 2878 2c20 7929 3a0a 2020 2020  _fed(x, y):.    
+00017160: 2222 2241 7567 6d65 6e74 6564 2074 6865  """Augmented the
+00017170: 2070 6f77 206f 7065 7261 7469 6f6e 2e0a   pow operation..
+00017180: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00017190: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
+000171a0: 2054 656e 736f 7220 7769 7468 2074 6865   Tensor with the
+000171b0: 2062 6173 6520 746f 2062 6520 6578 706f   base to be expo
+000171c0: 6e65 6e74 6961 7465 642e 0a20 2020 2020  nentiated..     
+000171d0: 2020 2079 2028 5661 7269 6162 6c65 293a     y (Variable):
+000171e0: 2054 656e 736f 7220 7769 7468 2070 6f77   Tensor with pow
+000171f0: 6572 2074 6f20 7261 6973 6520 746f 2e0a  er to raise to..
+00017200: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00017210: 2020 2020 2020 564a 5044 7561 6c3a 2050        VJPDual: P
+00017220: 7269 6d61 6c20 616e 6420 7265 7369 6475  rimal and residu
+00017230: 616c 732e 0a20 2020 2022 2222 0a20 2020  als..    """.   
+00017240: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
+00017250: 706f 7728 782c 2079 290a 2020 2020 7265  pow(x, y).    re
+00017260: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
+00017270: 6c2c 2078 2c20 7929 0a20 2020 2072 6574  l, x, y).    ret
+00017280: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+00017290: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000172a0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000172b0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+000172c0: 732e 504f 5729 0a64 6566 2070 6f77 5f62  s.POW).def pow_b
+000172d0: 6163 6b77 6172 6428 7265 7375 6c74 2c20  ackward(result, 
+000172e0: 782c 2079 2c20 6729 3a0a 2020 2020 696d  x, y, g):.    im
+000172f0: 706f 7274 2074 6875 6e64 6572 2e63 6c61  port thunder.cla
+00017300: 6e67 2061 7320 746c 616e 670a 0a20 2020  ng as tlang..   
+00017310: 2067 7265 7375 6c74 203d 2067 202a 2072   gresult = g * r
+00017320: 6573 756c 7420 2023 2072 6575 7365 2063  esult  # reuse c
+00017330: 6f6d 6d6f 6e20 6661 6374 6f72 0a20 2020  ommon factor.   
+00017340: 2064 7820 3d20 6720 2a20 7920 2a20 7820   dx = g * y * x 
+00017350: 2a2a 2028 7920 2d20 3129 0a20 2020 2064  ** (y - 1).    d
+00017360: 7920 3d20 6772 6573 756c 7420 2a20 746c  y = gresult * tl
+00017370: 616e 672e 6c6f 6728 7829 0a20 2020 2072  ang.log(x).    r
+00017380: 6574 7572 6e20 6478 2c20 6479 0a0a 0a40  eturn dx, dy...@
+00017390: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+000173a0: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+000173b0: 2e50 7269 6d49 4473 2e54 414e 290a 6465  .PrimIDs.TAN).de
+000173c0: 6620 7461 6e5f 6175 675f 6677 6428 7829  f tan_aug_fwd(x)
+000173d0: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
+000173e0: 6564 2074 616e 206f 7065 7261 7469 6f6e  ed tan operation
+000173f0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00017400: 2020 2020 2078 2028 5661 7269 6162 6c65       x (Variable
+00017410: 293a 2054 656e 736f 7220 746f 2062 6520  ): Tensor to be 
+00017420: 7061 7373 6564 2074 6f20 7461 6e2e 0a20  passed to tan.. 
+00017430: 2020 2022 2222 0a0a 2020 2020 7072 696d     """..    prim
+00017440: 616c 203d 2070 7269 6d73 2e74 616e 2878  al = prims.tan(x
+00017450: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
+00017460: 3d20 2870 7269 6d61 6c2c 290a 2020 2020  = (primal,).    
+00017470: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
+00017480: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
+00017490: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
+000174a0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
+000174b0: 6d49 4473 2e54 414e 290a 6465 6620 7461  mIDs.TAN).def ta
+000174c0: 6e5f 6261 636b 7761 7264 2872 6573 756c  n_backward(resul
+000174d0: 742c 2067 293a 0a20 2020 2072 6574 7572  t, g):.    retur
+000174e0: 6e20 6720 2a20 2831 202b 2072 6573 756c  n g * (1 + resul
+000174f0: 7420 2a20 7265 7375 6c74 290a 0a0a 2320  t * result)...# 
+00017500: 4e4f 5445 3a20 4a61 7820 7573 6573 206e  NOTE: Jax uses n
+00017510: 702e 6172 6773 6f72 7420 696e 2069 7473  p.argsort in its
+00017520: 2074 7261 6e73 706f 7365 2076 6a70 2063   transpose vjp c
+00017530: 6f6d 7075 7461 7469 6f6e 0a64 6566 205f  omputation.def _
+00017540: 6172 6773 6f72 7428 7365 7129 3a0a 2020  argsort(seq):.  
+00017550: 2020 7265 7475 726e 2073 6f72 7465 6428    return sorted(
+00017560: 7261 6e67 6528 6c65 6e28 7365 7129 292c  range(len(seq)),
+00017570: 206b 6579 3d73 6571 2e5f 5f67 6574 6974   key=seq.__getit
+00017580: 656d 5f5f 290a 0a0a 4072 6567 6973 7465  em__)...@registe
+00017590: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+000175a0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+000175b0: 732e 4445 5649 4345 5f50 5554 290a 6465  s.DEVICE_PUT).de
+000175c0: 6620 6465 7669 6365 5f70 7574 5f61 7567  f device_put_aug
+000175d0: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
+000175e0: 6f78 792c 2064 6576 6963 653a 2044 6576  oxy, device: Dev
+000175f0: 6963 6529 202d 3e20 5465 6e73 6f72 5072  ice) -> TensorPr
+00017600: 6f78 793a 0a20 2020 2070 7269 6d61 6c20  oxy:.    primal 
+00017610: 3d20 7072 696d 732e 6465 7669 6365 5f70  = prims.device_p
+00017620: 7574 2861 2c20 6465 7669 6365 290a 2020  ut(a, device).  
+00017630: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
+00017640: 2e64 6576 6963 652c 290a 2020 2020 7265  .device,).    re
+00017650: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00017660: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+00017670: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00017680: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+00017690: 4473 2e44 4556 4943 455f 5055 5429 0a64  Ds.DEVICE_PUT).d
+000176a0: 6566 2064 6576 6963 655f 7075 745f 6261  ef device_put_ba
+000176b0: 636b 7761 7264 286f 7269 675f 6465 7669  ckward(orig_devi
+000176c0: 6365 2c20 6729 3a0a 2020 2020 7265 7475  ce, g):.    retu
+000176d0: 726e 2070 7269 6d73 2e64 6576 6963 655f  rn prims.device_
+000176e0: 7075 7428 672c 206f 7269 675f 6465 7669  put(g, orig_devi
+000176f0: 6365 292c 204e 6f6e 650a 0a0a 4072 6567  ce), None...@reg
+00017700: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00017710: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00017720: 696d 4944 732e 434f 4e56 4f4c 5554 494f  imIDs.CONVOLUTIO
+00017730: 4e29 0a64 6566 2063 6f6e 766f 6c75 7469  N).def convoluti
+00017740: 6f6e 5f61 7567 5f66 7764 280a 2020 2020  on_aug_fwd(.    
+00017750: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
+00017760: 6967 6874 2c0a 2020 2020 6269 6173 2c0a  ight,.    bias,.
+00017770: 2020 2020 7374 7269 6465 2c0a 2020 2020      stride,.    
+00017780: 7061 6464 696e 672c 0a20 2020 2064 696c  padding,.    dil
+00017790: 6174 696f 6e2c 0a20 2020 2074 7261 6e73  ation,.    trans
+000177a0: 706f 7365 642c 0a20 2020 206f 7574 7075  posed,.    outpu
+000177b0: 745f 7061 6464 696e 672c 0a20 2020 2067  t_padding,.    g
+000177c0: 726f 7570 732c 0a29 3a0a 2020 2020 7072  roups,.):.    pr
+000177d0: 696d 616c 203d 2063 6f6e 766f 6c75 7469  imal = convoluti
+000177e0: 6f6e 2861 2c20 7765 6967 6874 2c20 6269  on(a, weight, bi
+000177f0: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
+00017800: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
+00017810: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
+00017820: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
+00017830: 7329 0a20 2020 2072 6573 6964 7561 6c73  s).    residuals
+00017840: 203d 2028 7072 696d 616c 2c20 612c 2077   = (primal, a, w
+00017850: 6569 6768 742c 2062 6961 732c 2073 7472  eight, bias, str
+00017860: 6964 652c 2070 6164 6469 6e67 2c20 6469  ide, padding, di
+00017870: 6c61 7469 6f6e 2c20 7472 616e 7370 6f73  lation, transpos
+00017880: 6564 2c20 6f75 7470 7574 5f70 6164 6469  ed, output_paddi
+00017890: 6e67 2c20 6772 6f75 7073 290a 2020 2020  ng, groups).    
+000178a0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
+000178b0: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
+000178c0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
+000178d0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
+000178e0: 6d49 4473 2e43 4f4e 564f 4c55 5449 4f4e  mIDs.CONVOLUTION
+000178f0: 290a 6465 6620 636f 6e76 6f6c 7574 696f  ).def convolutio
+00017900: 6e5f 6261 636b 7761 7264 280a 2020 2020  n_backward(.    
+00017910: 6f75 7470 7574 3a20 5072 6f78 792c 0a20  output: Proxy,. 
+00017920: 2020 2069 6e70 7574 3a20 5072 6f78 792c     input: Proxy,
+00017930: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
+00017940: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
+00017950: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
+00017960: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
+00017970: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
+00017980: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00017990: 2c0a 2020 2020 6772 6f75 7073 2c0a 2020  ,.    groups,.  
+000179a0: 2020 6772 6164 2c0a 293a 0a20 2020 2023    grad,.):.    #
+000179b0: 2054 7261 6e73 706f 7365 6420 636f 6e76   Transposed conv
+000179c0: 6f6c 7574 696f 6e20 6973 206e 6f74 2073  olution is not s
+000179d0: 7570 706f 7274 6564 210a 2020 2020 6173  upported!.    as
+000179e0: 7365 7274 2074 7261 6e73 706f 7365 6420  sert transposed 
+000179f0: 3d3d 2030 0a0a 2020 2020 696e 7075 745f  == 0..    input_
+00017a00: 6772 6164 203d 204e 6f6e 650a 2020 2020  grad = None.    
+00017a10: 7765 6967 6874 5f67 7261 6420 3d20 4e6f  weight_grad = No
+00017a20: 6e65 0a20 2020 2062 6961 735f 6772 6164  ne.    bias_grad
+00017a30: 203d 204e 6f6e 650a 0a20 2020 2023 2053   = None..    # S
+00017a40: 686f 7274 2063 6972 6375 6974 206f 6e20  hort circuit on 
+00017a50: 7a65 726f 2d64 696d 2067 7261 640a 2020  zero-dim grad.  
+00017a60: 2020 6966 2061 6e79 2873 203d 3d20 3020    if any(s == 0 
+00017a70: 666f 7220 7320 696e 2067 7261 642e 7368  for s in grad.sh
+00017a80: 6170 6529 3a0a 2020 2020 2020 2020 696e  ape):.        in
+00017a90: 7075 745f 6772 6164 203d 2066 756c 6c5f  put_grad = full_
+00017aa0: 6c69 6b65 2869 6e70 7574 2c20 6669 6c6c  like(input, fill
+00017ab0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+00017ac0: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
+00017ad0: 6675 6c6c 5f6c 696b 6528 7765 6967 6874  full_like(weight
+00017ae0: 2c20 6669 6c6c 5f76 616c 7565 3d30 290a  , fill_value=0).
+00017af0: 2020 2020 2020 2020 6966 2062 6961 7320          if bias 
+00017b00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00017b10: 2020 2020 2020 2020 2062 6961 735f 6772           bias_gr
+00017b20: 6164 203d 2066 756c 6c5f 6c69 6b65 2862  ad = full_like(b
+00017b30: 6961 732c 2066 696c 6c5f 7661 6c75 653d  ias, fill_value=
+00017b40: 3029 0a20 2020 2020 2020 2072 6574 7572  0).        retur
+00017b50: 6e20 2869 6e70 7574 5f67 7261 642c 2077  n (input_grad, w
+00017b60: 6569 6768 745f 6772 6164 2c20 6269 6173  eight_grad, bias
+00017b70: 5f67 7261 6429 202b 2028 284e 6f6e 652c  _grad) + ((None,
+00017b80: 2920 2a20 3629 0a0a 2020 2020 6261 7463  ) * 6)..    batc
+00017b90: 682c 2069 6e5f 6368 616e 6e65 6c73 2c20  h, in_channels, 
+00017ba0: 2a73 7061 7469 616c 5f64 696d 7320 3d20  *spatial_dims = 
+00017bb0: 696e 7075 742e 7368 6170 650a 2020 2020  input.shape.    
+00017bc0: 6f75 745f 6368 616e 6e65 6c73 2c20 6769  out_channels, gi
+00017bd0: 6e5f 6368 616e 6e65 6c73 2c20 2a6b 6572  n_channels, *ker
+00017be0: 6e65 6c5f 6469 6d73 203d 2077 6569 6768  nel_dims = weigh
+00017bf0: 742e 7368 6170 650a 2020 2020 6469 6d20  t.shape.    dim 
+00017c00: 3d20 6c65 6e28 7370 6174 6961 6c5f 6469  = len(spatial_di
+00017c10: 6d73 290a 0a20 2020 2064 6566 206d 6179  ms)..    def may
+00017c20: 6265 5f65 7870 616e 645f 7365 7128 732c  be_expand_seq(s,
+00017c30: 2064 696d 293a 0a20 2020 2020 2020 2069   dim):.        i
+00017c40: 6620 6c65 6e28 7329 203d 3d20 313a 0a20  f len(s) == 1:. 
+00017c50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00017c60: 6e20 2873 5b30 5d2c 2920 2a20 6469 6d0a  n (s[0],) * dim.
+00017c70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00017c80: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00017c90: 2073 0a0a 2020 2020 7374 7269 6465 203d   s..    stride =
+00017ca0: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
+00017cb0: 7128 7374 7269 6465 2c20 6469 6d29 0a20  q(stride, dim). 
+00017cc0: 2020 2070 6164 6469 6e67 203d 206d 6179     padding = may
+00017cd0: 6265 5f65 7870 616e 645f 7365 7128 7061  be_expand_seq(pa
+00017ce0: 6464 696e 672c 2064 696d 290a 2020 2020  dding, dim).    
+00017cf0: 6469 6c61 7469 6f6e 203d 206d 6179 6265  dilation = maybe
+00017d00: 5f65 7870 616e 645f 7365 7128 6469 6c61  _expand_seq(dila
+00017d10: 7469 6f6e 2c20 6469 6d29 0a0a 2020 2020  tion, dim)..    
+00017d20: 6465 6620 636f 6e76 5f74 7261 6e73 706f  def conv_transpo
+00017d30: 7365 2874 293a 0a20 2020 2020 2020 2072  se(t):.        r
+00017d40: 6574 7572 6e20 7072 696d 732e 7472 616e  eturn prims.tran
+00017d50: 7370 6f73 6528 742c 2028 312c 2030 2920  spose(t, (1, 0) 
+00017d60: 2b20 7475 706c 6528 7261 6e67 6528 322c  + tuple(range(2,
+00017d70: 2074 2e6e 6469 6d29 2929 0a0a 2020 2020   t.ndim)))..    
+00017d80: 2320 696e 7075 745f 6772 6164 203d 207b  # input_grad = {
+00017d90: 0a20 2020 2064 6566 2074 7261 6e73 706f  .    def transpo
+00017da0: 7365 5f61 6e64 5f66 6c69 705f 7765 6967  se_and_flip_weig
+00017db0: 6874 2877 6569 6768 7429 3a0a 2020 2020  ht(weight):.    
+00017dc0: 2020 2020 2320 5468 6520 6c69 6e65 7320      # The lines 
+00017dd0: 6265 6c6f 7720 6172 6520 7472 616e 7370  below are transp
+00017de0: 6f73 696e 6720 7468 6520 6368 616e 6e65  osing the channe
+00017df0: 6c73 2064 696d 732e 0a20 2020 2020 2020  ls dims..       
+00017e00: 2023 2057 6520 616c 736f 206e 6565 6420   # We also need 
+00017e10: 746f 2065 7874 7261 6374 2074 6865 2067  to extract the g
+00017e20: 726f 7570 2069 6e66 6f72 6d61 7469 6f6e  roup information
+00017e30: 2061 6e64 206d 6572 6765 2069 740a 2020   and merge it.  
+00017e40: 2020 2020 2020 2320 7769 7468 2074 6865        # with the
+00017e50: 2064 696d 656e 7369 6f6e 2063 6f72 7265   dimension corre
+00017e60: 7370 6f6e 6469 6e67 2074 6f20 7468 6520  sponding to the 
+00017e70: 226f 7574 5f63 6861 6e6e 656c 7322 2064  "out_channels" d
+00017e80: 696d 2e0a 2020 2020 2020 2020 2320 286f  im..        # (o
+00017e90: 7574 5f63 6861 6e6e 656c 732c 2067 696e  ut_channels, gin
+00017ea0: 5f63 6861 6e6e 656c 7329 202d 3e20 2867  _channels) -> (g
+00017eb0: 696e 5f63 6861 6e6e 656c 732c 206f 7574  in_channels, out
+00017ec0: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
+00017ed0: 2020 2077 6569 6768 7420 3d20 636f 6e76     weight = conv
+00017ee0: 5f74 7261 6e73 706f 7365 2877 6569 6768  _transpose(weigh
+00017ef0: 7429 0a20 2020 2020 2020 2023 2053 706c  t).        # Spl
+00017f00: 6974 2028 6f75 745f 6368 616e 6e65 6c73  it (out_channels
+00017f10: 2c29 202d 3e20 2867 726f 7570 732c 206f  ,) -> (groups, o
+00017f20: 7574 5f63 6861 6e6e 656c 7320 2f2f 2067  ut_channels // g
+00017f30: 726f 7570 7329 0a20 2020 2020 2020 2077  roups).        w
+00017f40: 6569 6768 7420 3d20 7765 6967 6874 2e72  eight = weight.r
+00017f50: 6573 6861 7065 285b 6769 6e5f 6368 616e  eshape([gin_chan
+00017f60: 6e65 6c73 2c20 6772 6f75 7073 2c20 6f75  nels, groups, ou
+00017f70: 745f 6368 616e 6e65 6c73 202f 2f20 6772  t_channels // gr
+00017f80: 6f75 7073 5d20 2b20 6b65 726e 656c 5f64  oups] + kernel_d
+00017f90: 696d 7329 0a20 2020 2020 2020 2023 204d  ims).        # M
+00017fa0: 6f76 696e 6720 6772 6f75 7073 2074 6f20  oving groups to 
+00017fb0: 7468 6520 6c65 6674 2d6d 6f73 7420 706f  the left-most po
+00017fc0: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
+00017fd0: 2320 2867 696e 5f63 6861 6e6e 656c 732c  # (gin_channels,
+00017fe0: 2067 726f 7570 732c 206f 7574 5f63 6861   groups, out_cha
+00017ff0: 6e6e 656c 7320 2f2f 2067 726f 7570 7329  nnels // groups)
+00018000: 202d 3e20 2867 726f 7570 732c 2067 696e   -> (groups, gin
+00018010: 5f63 6861 6e6e 656c 732c 206f 7574 5f63  _channels, out_c
+00018020: 6861 6e6e 656c 7320 2f2f 2067 726f 7570  hannels // group
+00018030: 7329 0a20 2020 2020 2020 2077 6569 6768  s).        weigh
+00018040: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
+00018050: 7365 2877 6569 6768 7429 0a20 2020 2020  se(weight).     
+00018060: 2020 2023 2053 7175 6173 6820 2867 726f     # Squash (gro
+00018070: 7570 732c 2067 696e 5f63 6861 6e6e 656c  ups, gin_channel
+00018080: 7329 202d 3e20 2869 6e5f 6368 616e 6e65  s) -> (in_channe
+00018090: 6c73 290a 2020 2020 2020 2020 7765 6967  ls).        weig
+000180a0: 6874 203d 2077 6569 6768 742e 7265 7368  ht = weight.resh
+000180b0: 6170 6528 5b69 6e5f 6368 616e 6e65 6c73  ape([in_channels
+000180c0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+000180d0: 2f20 6772 6f75 7073 5d20 2b20 6b65 726e  / groups] + kern
+000180e0: 656c 5f64 696d 7329 0a0a 2020 2020 2020  el_dims)..      
+000180f0: 2020 2320 466c 6970 2073 7061 7469 616c    # Flip spatial
+00018100: 2064 696d 656e 7369 6f6e 730a 2020 2020   dimensions.    
+00018110: 2020 2020 7765 6967 6874 203d 2070 7269      weight = pri
+00018120: 6d73 2e66 6c69 7028 7765 6967 6874 2c20  ms.flip(weight, 
+00018130: 7475 706c 6528 7261 6e67 6528 322c 2077  tuple(range(2, w
+00018140: 6569 6768 742e 6e64 696d 2929 290a 2020  eight.ndim))).  
+00018150: 2020 2020 2020 7265 7475 726e 2077 6569        return wei
+00018160: 6768 740a 0a20 2020 2023 2057 6520 6e65  ght..    # We ne
+00018170: 6564 2074 6f20 7061 6420 7468 6520 6772  ed to pad the gr
+00018180: 6164 6965 6e74 2074 6f20 6265 2061 626c  adient to be abl
+00018190: 6520 746f 2066 6974 206b 6572 6e65 6c20  e to fit kernel 
+000181a0: 7769 6e64 6f77 732e 0a20 2020 2069 6e69  windows..    ini
+000181b0: 7469 616c 5f67 7261 645f 7061 6464 696e  tial_grad_paddin
+000181c0: 6720 3d20 5b64 202a 2028 6b20 2d20 3129  g = [d * (k - 1)
+000181d0: 2066 6f72 2064 2c20 6b20 696e 207a 6970   for d, k in zip
+000181e0: 2864 696c 6174 696f 6e2c 206b 6572 6e65  (dilation, kerne
+000181f0: 6c5f 6469 6d73 295d 0a0a 2020 2020 696e  l_dims)]..    in
+00018200: 7075 745f 6772 6164 203d 2063 6f6e 766f  put_grad = convo
+00018210: 6c75 7469 6f6e 280a 2020 2020 2020 2020  lution(.        
+00018220: 7072 696d 732e 7061 6428 0a20 2020 2020  prims.pad(.     
+00018230: 2020 2020 2020 2067 7261 642c 0a20 2020         grad,.   
+00018240: 2020 2020 2020 2020 2030 2e30 2c0a 2020           0.0,.  
+00018250: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00018260: 7069 7865 7320 6172 6520 7374 7269 6465  pixes are stride
+00018270: 2061 7761 7920 6672 6f6d 2065 6163 6820   away from each 
+00018280: 6f74 6865 7220 696e 2074 6865 206f 7269  other in the ori
+00018290: 6769 6e61 6c20 696e 7075 742e 0a20 2020  ginal input..   
+000182a0: 2020 2020 2020 2020 2023 2048 656e 6365           # Hence
+000182b0: 2077 6520 6e65 6564 2074 6f20 6469 6c61   we need to dila
+000182c0: 7465 2074 6865 2067 7261 6469 656e 7420  te the gradient 
+000182d0: 6279 2064 696c 6174 696f 6e3d 7374 7269  by dilation=stri
+000182e0: 6465 202d 2031 0a20 2020 2020 2020 2020  de - 1.         
+000182f0: 2020 2023 2073 6f20 7468 6174 2074 6865     # so that the
+00018300: 7265 2061 7265 2073 7472 6964 6520 2d20  re are stride - 
+00018310: 3120 7a65 726f 7320 6265 7477 6565 6e20  1 zeros between 
+00018320: 7468 6520 7069 7865 6c73 2e0a 2020 2020  the pixels..    
+00018330: 2020 2020 2020 2020 5b28 302c 2030 2c20          [(0, 0, 
+00018340: 3029 2c20 2830 2c20 302c 2030 295d 202b  0), (0, 0, 0)] +
+00018350: 205b 2830 2c20 302c 2073 202d 2031 2920   [(0, 0, s - 1) 
+00018360: 666f 7220 7320 696e 2073 7472 6964 655d  for s in stride]
+00018370: 2c0a 2020 2020 2020 2020 292c 0a20 2020  ,.        ),.   
+00018380: 2020 2020 2074 7261 6e73 706f 7365 5f61       transpose_a
+00018390: 6e64 5f66 6c69 705f 7765 6967 6874 2877  nd_flip_weight(w
+000183a0: 6569 6768 7429 2c0a 2020 2020 2020 2020  eight),.        
+000183b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2320  None,.        # 
+000183c0: 5365 7474 696e 6720 7374 7269 6465 2074  Setting stride t
+000183d0: 6f20 3120 6173 2074 6865 2064 6973 7461  o 1 as the dista
+000183e0: 6e63 6520 6265 7477 6565 6e20 7069 7865  nce between pixe
+000183f0: 6c73 2069 7320 7461 6b65 6e0a 2020 2020  ls is taken.    
+00018400: 2020 2020 2320 6361 7265 2062 7920 7468      # care by th
+00018410: 6520 7061 6420 7269 6768 7420 6162 6f76  e pad right abov
+00018420: 652e 0a20 2020 2020 2020 2028 312c 292c  e..        (1,),
+00018430: 0a20 2020 2020 2020 2069 6e69 7469 616c  .        initial
+00018440: 5f67 7261 645f 7061 6464 696e 672c 0a20  _grad_padding,. 
+00018450: 2020 2020 2020 2064 696c 6174 696f 6e2c         dilation,
+00018460: 0a20 2020 2020 2020 2074 7261 6e73 706f  .        transpo
+00018470: 7365 642c 0a20 2020 2020 2020 206f 7574  sed,.        out
+00018480: 7075 745f 7061 6464 696e 672c 0a20 2020  put_padding,.   
+00018490: 2020 2020 2067 726f 7570 732c 0a20 2020       groups,.   
+000184a0: 2029 0a0a 2020 2020 6465 6620 7061 645f   )..    def pad_
+000184b0: 746f 5f69 6e70 7574 2867 7261 6429 3a0a  to_input(grad):.
+000184c0: 2020 2020 2020 2020 2320 5765 206e 6565          # We nee
+000184d0: 6420 746f 2075 6e70 6164 2074 6865 2070  d to unpad the p
+000184e0: 6164 6469 6e67 2064 6f6e 6520 746f 2074  adding done to t
+000184f0: 6865 2069 6e70 7574 2070 7269 6f72 2074  he input prior t
+00018500: 6f20 7468 6520 636f 6e76 6f6c 7574 696f  o the convolutio
+00018510: 6e2e 0a20 2020 2020 2020 2023 204e 6f74  n..        # Not
+00018520: 6520 7468 6174 206c 6f77 2061 6e64 2068  e that low and h
+00018530: 6967 6820 7061 6464 696e 6720 6172 6520  igh padding are 
+00018540: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
+00018550: 6571 7561 6c2c 2073 6f20 7765 2063 616e  equal, so we can
+00018560: 6e6f 740a 2020 2020 2020 2020 2320 6162  not.        # ab
+00018570: 736f 7262 2069 7420 696e 746f 2074 6865  sorb it into the
+00018580: 2063 6f6e 766f 6c75 7469 6f6e 206a 7573   convolution jus
+00018590: 7420 7965 742c 2075 6e6c 6573 7320 7468  t yet, unless th
+000185a0: 6520 4150 4920 6973 206d 6f64 6966 6965  e API is modifie
+000185b0: 642e 0a20 2020 2020 2020 2070 6164 5f63  d..        pad_c
+000185c0: 6f6e 6669 6720 3d20 5b28 302c 2030 2c20  onfig = [(0, 0, 
+000185d0: 3029 2c20 2830 2c20 302c 2030 295d 0a20  0), (0, 0, 0)]. 
+000185e0: 2020 2020 2020 2066 6f72 206f 2c20 692c         for o, i,
+000185f0: 2067 2c20 7020 696e 207a 6970 2867 7261   g, p in zip(gra
+00018600: 642e 7368 6170 655b 323a 5d2c 2073 7061  d.shape[2:], spa
+00018610: 7469 616c 5f64 696d 732c 2069 6e70 7574  tial_dims, input
+00018620: 5f67 7261 642e 7368 6170 655b 323a 5d2c  _grad.shape[2:],
+00018630: 2070 6164 6469 6e67 293a 0a20 2020 2020   padding):.     
+00018640: 2020 2020 2020 206c 6f20 3d20 2d70 0a20         lo = -p. 
+00018650: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+00018660: 6520 7468 6174 2028 6920 2b20 3220 2a20  e that (i + 2 * 
+00018670: 7029 2069 7320 7468 6520 7369 7a65 206f  p) is the size o
+00018680: 6620 7468 6520 7061 6464 6564 2069 6e70  f the padded inp
+00018690: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+000186a0: 2320 736f 2074 6865 2071 7561 6e74 6974  # so the quantit
+000186b0: 7920 2869 202b 2032 202a 2070 2920 2d20  y (i + 2 * p) - 
+000186c0: 6720 7465 6c6c 7320 7573 2062 7920 686f  g tells us by ho
+000186d0: 7720 6d75 6368 0a20 2020 2020 2020 2020  w much.         
+000186e0: 2020 2023 2077 6520 6e65 6564 2074 6f20     # we need to 
+000186f0: 7061 6420 7468 6520 6772 6164 6965 6e74  pad the gradient
+00018700: 2073 6f20 7468 6174 2074 6865 2065 6c65   so that the ele
+00018710: 6d65 6e74 7320 6f75 7473 6964 650a 2020  ments outside.  
+00018720: 2020 2020 2020 2020 2020 2320 6f66 2074            # of t
+00018730: 6865 2063 6f6e 766f 6c75 7469 6f6e 2072  he convolution r
+00018740: 6563 6569 7665 207a 6572 6f20 6772 6164  eceive zero grad
+00018750: 6965 6e74 2e0a 2020 2020 2020 2020 2020  ient..          
+00018760: 2020 2320 7020 6973 2061 6464 6974 696f    # p is additio
+00018770: 6e61 6c6c 7920 7375 6274 7261 6374 6564  nally subtracted
+00018780: 2074 6f20 6e65 6761 7465 2074 6865 2069   to negate the i
+00018790: 6e70 7574 2773 2070 6164 0a20 2020 2020  nput's pad.     
+000187a0: 2020 2020 2020 2023 2069 6e20 666f 7277         # in forw
+000187b0: 6172 642e 0a20 2020 2020 2020 2020 2020  ard..           
+000187c0: 2068 6920 3d20 2869 202b 2032 202a 2070   hi = (i + 2 * p
+000187d0: 2920 2d20 6720 2d20 700a 2020 2020 2020  ) - g - p.      
+000187e0: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
+000187f0: 2e61 7070 656e 6428 286c 6f2c 2068 692c  .append((lo, hi,
+00018800: 2030 2929 0a20 2020 2020 2020 2072 6574   0)).        ret
+00018810: 7572 6e20 7072 696d 732e 7061 6428 6772  urn prims.pad(gr
+00018820: 6164 2c20 302e 302c 2070 6164 5f63 6f6e  ad, 0.0, pad_con
+00018830: 6669 6729 0a0a 2020 2020 696e 7075 745f  fig)..    input_
+00018840: 6772 6164 203d 2070 6164 5f74 6f5f 696e  grad = pad_to_in
+00018850: 7075 7428 696e 7075 745f 6772 6164 290a  put(input_grad).
+00018860: 2020 2020 2320 7d0a 0a20 2020 2023 2062      # }..    # b
+00018870: 6961 735f 6772 6164 203d 207b 0a20 2020  ias_grad = {.   
+00018880: 2069 6620 6269 6173 2069 7320 6e6f 7420   if bias is not 
+00018890: 4e6f 6e65 3a0a 2020 2020 2020 2020 696d  None:.        im
+000188a0: 706f 7274 2074 6875 6e64 6572 2e74 6f72  port thunder.tor
+000188b0: 6368 2061 7320 6c74 6f72 6368 0a0a 2020  ch as ltorch..  
+000188c0: 2020 2020 2020 6269 6173 5f67 7261 6420        bias_grad 
+000188d0: 3d20 6c74 6f72 6368 2e73 756d 2867 7261  = ltorch.sum(gra
+000188e0: 642c 205b 6420 666f 7220 6420 696e 2072  d, [d for d in r
+000188f0: 616e 6765 2867 7261 642e 6e64 696d 2920  ange(grad.ndim) 
+00018900: 6966 2064 2021 3d20 315d 290a 2020 2020  if d != 1]).    
+00018910: 2320 7d0a 0a20 2020 2023 2077 6569 6768  # }..    # weigh
+00018920: 7420 6772 6164 203d 207b 0a20 2020 2064  t grad = {.    d
+00018930: 6566 2070 6164 5f74 7261 6e73 706f 7365  ef pad_transpose
+00018940: 5f61 6e64 5f70 7573 685f 6772 6f75 7073  _and_push_groups
+00018950: 5f69 6e74 6f5f 6261 7463 6865 7328 7429  _into_batches(t)
+00018960: 3a0a 2020 2020 2020 2020 2320 4669 7273  :.        # Firs
+00018970: 7420 7061 642c 2e2e 2e0a 2020 2020 2020  t pad,....      
+00018980: 2020 2320 5061 6420 6173 206e 6563 6573    # Pad as neces
+00018990: 7361 7279 2073 6f20 7468 6174 2069 6e20  sary so that in 
+000189a0: 636f 6e76 6f6c 7574 696f 6e73 2077 6520  convolutions we 
+000189b0: 6e65 7665 7220 6164 7661 6e63 650a 2020  never advance.  
+000189c0: 2020 2020 2020 2320 7061 7374 2072 656c        # past rel
+000189d0: 6576 616e 7420 696e 7075 7473 2e0a 2020  evant inputs..  
+000189e0: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
+000189f0: 203d 205b 2830 2c20 302c 2030 292c 2028   = [(0, 0, 0), (
+00018a00: 302c 2030 2c20 3029 5d0a 2020 2020 2020  0, 0, 0)].      
+00018a10: 2020 666f 7220 6f2c 2069 2c20 6b2c 2070    for o, i, k, p
+00018a20: 2c20 732c 2064 2069 6e20 7a69 7028 6772  , s, d in zip(gr
+00018a30: 6164 2e73 6861 7065 5b32 3a5d 2c20 7370  ad.shape[2:], sp
+00018a40: 6174 6961 6c5f 6469 6d73 2c20 6b65 726e  atial_dims, kern
+00018a50: 656c 5f64 696d 732c 2070 6164 6469 6e67  el_dims, padding
+00018a60: 2c20 7374 7269 6465 2c20 6469 6c61 7469  , stride, dilati
+00018a70: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
+00018a80: 2023 2050 6164 6469 6e67 2066 726f 6d20   # Padding from 
+00018a90: 6265 6c6f 7720 6973 2074 6865 2073 616d  below is the sam
+00018aa0: 652e 0a20 2020 2020 2020 2020 2020 206c  e..            l
+00018ab0: 6f20 3d20 700a 2020 2020 2020 2020 2020  o = p.          
+00018ac0: 2020 2320 5468 6572 6520 6973 2061 6c77    # There is alw
+00018ad0: 6179 7320 7468 6520 6d61 7820 696e 6465  ays the max inde
+00018ae0: 7820 6964 7820 696e 2074 6865 2069 6e70  x idx in the inp
+00018af0: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
+00018b00: 2074 6865 2076 616c 7565 206f 6620 7768   the value of wh
+00018b10: 6963 682c 2069 6e70 7574 5b69 6478 5d2c  ich, input[idx],
+00018b20: 2074 6865 206b 6572 6e65 6c20 746f 7563   the kernel touc
+00018b30: 6865 732e 0a20 2020 2020 2020 2020 2020  hes..           
+00018b40: 2023 2054 6865 206b 6572 6e65 6c20 7265   # The kernel re
+00018b50: 6163 682c 206f 7220 6b5f 7265 6163 682c  ach, or k_reach,
+00018b60: 2069 7320 6578 6163 746c 7920 6964 7820   is exactly idx 
+00018b70: 2b20 312e 0a20 2020 2020 2020 2020 2020  + 1..           
+00018b80: 2023 2057 6520 7573 6520 6974 2074 6f20   # We use it to 
+00018b90: 6465 6369 6465 2062 7920 686f 7720 6d75  decide by how mu
+00018ba0: 6368 2077 6520 6e65 6564 2074 6f20 7061  ch we need to pa
+00018bb0: 6420 6672 6f6d 2061 626f 7665 0a20 2020  d from above.   
+00018bc0: 2020 2020 2020 2020 2023 2061 7320 746f           # as to
+00018bd0: 206e 6f74 206d 6f76 6520 7061 7374 2072   not move past r
+00018be0: 656c 6576 616e 7420 7661 6c75 6573 2e0a  elevant values..
+00018bf0: 2020 2020 2020 2020 2020 2020 6b5f 7265              k_re
+00018c00: 6163 6820 3d20 286f 202d 2031 2920 2a20  ach = (o - 1) * 
+00018c10: 7320 2b20 6420 2a20 286b 202d 2031 2920  s + d * (k - 1) 
+00018c20: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
+00018c30: 2320 5468 6520 7061 6420 6672 6f6d 2061  # The pad from a
+00018c40: 626f 7665 2065 7175 616c 7320 6b5f 7265  bove equals k_re
+00018c50: 6163 6820 6d69 6e75 7320 7468 6520 6c65  ach minus the le
+00018c60: 6e67 7468 0a20 2020 2020 2020 2020 2020  ngth.           
+00018c70: 2023 206f 6620 7468 6520 696e 7075 7420   # of the input 
+00018c80: 7061 6464 6564 2066 726f 6d20 6265 6c6f  padded from belo
+00018c90: 772e 0a20 2020 2020 2020 2020 2020 2068  w..            h
+00018ca0: 6920 3d20 6b5f 7265 6163 6820 2d20 2869  i = k_reach - (i
+00018cb0: 202b 2070 290a 2020 2020 2020 2020 2020   + p).          
+00018cc0: 2020 7061 645f 636f 6e66 6967 2e61 7070    pad_config.app
+00018cd0: 656e 6428 286c 6f2c 2068 692c 2030 2929  end((lo, hi, 0))
+00018ce0: 0a20 2020 2020 2020 2074 203d 2070 7269  .        t = pri
+00018cf0: 6d73 2e70 6164 2874 2c20 302e 302c 2070  ms.pad(t, 0.0, p
+00018d00: 6164 5f63 6f6e 6669 6729 0a0a 2020 2020  ad_config)..    
+00018d10: 2020 2020 5f2c 205f 2c20 2a74 5f73 7061      _, _, *t_spa
+00018d20: 7469 616c 5f64 696d 7320 3d20 742e 7368  tial_dims = t.sh
+00018d30: 6170 650a 0a20 2020 2020 2020 2023 202e  ape..        # .
+00018d40: 2e2e 2074 6865 6e20 646f 2074 6865 2072  .. then do the r
+00018d50: 6573 742e 0a20 2020 2020 2020 2023 2074  est..        # t
+00018d60: 2e73 6861 7065 203d 3d20 2862 6174 6368  .shape == (batch
+00018d70: 2c20 696e 5f63 6861 6e6e 656c 732c 202e  , in_channels, .
+00018d80: 2e2e 290a 2020 2020 2020 2020 2320 5468  ..).        # Th
+00018d90: 6520 7265 7375 6c74 206f 6620 7468 6973  e result of this
+00018da0: 2066 756e 6374 696f 6e20 6861 7320 7368   function has sh
+00018db0: 6170 650a 2020 2020 2020 2020 2320 2869  ape.        # (i
+00018dc0: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
+00018dd0: 6820 2a20 6772 6f75 7073 290a 2020 2020  h * groups).    
+00018de0: 2020 2020 2320 2862 6174 6368 2c20 696e      # (batch, in
+00018df0: 5f63 6861 6e6e 656c 7329 202d 3e20 2869  _channels) -> (i
+00018e00: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
+00018e10: 6829 0a20 2020 2020 2020 2074 203d 2063  h).        t = c
+00018e20: 6f6e 765f 7472 616e 7370 6f73 6528 7429  onv_transpose(t)
+00018e30: 0a20 2020 2020 2020 2023 2053 706c 6974  .        # Split
+00018e40: 2028 696e 5f63 6861 6e6e 656c 732c 2920   (in_channels,) 
+00018e50: 2d3e 2028 6772 6f75 7073 2c20 6769 6e5f  -> (groups, gin_
+00018e60: 6368 616e 6e65 6c73 290a 2020 2020 2020  channels).      
+00018e70: 2020 7420 3d20 742e 7265 7368 6170 6528    t = t.reshape(
+00018e80: 5b67 726f 7570 732c 2067 696e 5f63 6861  [groups, gin_cha
+00018e90: 6e6e 656c 732c 2062 6174 6368 5d20 2b20  nnels, batch] + 
+00018ea0: 745f 7370 6174 6961 6c5f 6469 6d73 290a  t_spatial_dims).
+00018eb0: 2020 2020 2020 2020 2320 5472 616e 7370          # Transp
+00018ec0: 6f73 6520 2867 726f 7570 732c 2067 696e  ose (groups, gin
+00018ed0: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
+00018ee0: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
+00018ef0: 6c73 2c20 6772 6f75 7073 2c20 6261 7463  ls, groups, batc
+00018f00: 6829 0a20 2020 2020 2020 2074 203d 2063  h).        t = c
+00018f10: 6f6e 765f 7472 616e 7370 6f73 6528 7429  onv_transpose(t)
+00018f20: 0a20 2020 2020 2020 2023 2046 6c61 7474  .        # Flatt
+00018f30: 656e 2028 6772 6f75 7073 2c20 6261 7463  en (groups, batc
+00018f40: 6829 202d 3e20 2867 726f 7570 7320 2a20  h) -> (groups * 
+00018f50: 6261 7463 682c 290a 2020 2020 2020 2020  batch,).        
+00018f60: 7420 3d20 742e 7265 7368 6170 6528 5b67  t = t.reshape([g
+00018f70: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
+00018f80: 7570 7320 2a20 6261 7463 685d 202b 2074  ups * batch] + t
+00018f90: 5f73 7061 7469 616c 5f64 696d 7329 0a20  _spatial_dims). 
+00018fa0: 2020 2020 2020 2072 6574 7572 6e20 740a         return t.
+00018fb0: 0a20 2020 2023 2069 6e70 7574 2077 696c  .    # input wil
+00018fc0: 6c20 6861 7665 2073 6861 7065 2028 6769  l have shape (gi
+00018fd0: 6e5f 6368 616e 6e65 6c73 2c20 6772 6f75  n_channels, grou
+00018fe0: 7073 202a 2062 6174 6368 290a 2020 2020  ps * batch).    
+00018ff0: 696e 7075 7420 3d20 7061 645f 7472 616e  input = pad_tran
+00019000: 7370 6f73 655f 616e 645f 7075 7368 5f67  spose_and_push_g
+00019010: 726f 7570 735f 696e 746f 5f62 6174 6368  roups_into_batch
+00019020: 6573 2869 6e70 7574 290a 2020 2020 2320  es(input).    # 
+00019030: 6772 6164 2077 696c 6c20 6861 7665 2073  grad will have s
+00019040: 6861 7065 2028 6f75 745f 6368 616e 6e65  hape (out_channe
+00019050: 6c73 2c20 6261 7463 6829 0a20 2020 2023  ls, batch).    #
+00019060: 204e 6f74 6520 7468 6174 2074 6865 7365   Note that these
+00019070: 2073 6861 7065 7320 6172 6520 636f 6d70   shapes are comp
+00019080: 6174 6962 6c65 2066 6f72 2061 2067 726f  atible for a gro
+00019090: 7570 2063 6f6e 766f 6c75 7469 6f6e 2e0a  up convolution..
+000190a0: 2020 2020 6772 6164 203d 2063 6f6e 765f      grad = conv_
+000190b0: 7472 616e 7370 6f73 6528 6772 6164 290a  transpose(grad).
+000190c0: 0a20 2020 2023 2057 6879 2064 6f20 7765  .    # Why do we
+000190d0: 2066 6c69 7020 7374 7269 6465 2061 6e64   flip stride and
+000190e0: 2064 696c 6174 696f 6e3f 0a20 2020 2023   dilation?.    #
+000190f0: 206b 6572 6e65 6c5b 695d 2061 6e64 206b   kernel[i] and k
+00019100: 6572 6e65 6c5b 6920 2b20 315d 2061 7265  ernel[i + 1] are
+00019110: 2064 696c 6174 696f 6e20 6170 6172 7420   dilation apart 
+00019120: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
+00019130: 0a20 2020 2023 2073 6f20 6469 6c61 7469  .    # so dilati
+00019140: 6f6e 2062 6563 6f6d 6573 2074 6865 206e  on becomes the n
+00019150: 6577 2073 7472 6964 652e 0a20 2020 2023  ew stride..    #
+00019160: 2041 6c6c 2074 6865 2065 6c65 6d65 6e74   All the element
+00019170: 7320 7468 6174 206b 6572 6e65 6c5b 695d  s that kernel[i]
+00019180: 2074 6f75 6368 6573 2061 7265 2073 7472   touches are str
+00019190: 6964 6520 6177 6179 2066 726f 6d20 6561  ide away from ea
+000191a0: 6368 206f 7468 6572 2c0a 2020 2020 2320  ch other,.    # 
+000191b0: 6865 6e63 6520 7374 7269 6465 2062 6563  hence stride bec
+000191c0: 6f6d 6573 2074 6865 206e 6577 2064 696c  omes the new dil
+000191d0: 6174 696f 6e2e 0a20 2020 2077 6569 6768  ation..    weigh
+000191e0: 745f 6772 6164 203d 2063 6f6e 766f 6c75  t_grad = convolu
+000191f0: 7469 6f6e 280a 2020 2020 2020 2020 696e  tion(.        in
+00019200: 7075 742c 0a20 2020 2020 2020 2067 7261  put,.        gra
+00019210: 642c 0a20 2020 2020 2020 204e 6f6e 652c  d,.        None,
+00019220: 0a20 2020 2020 2020 2064 696c 6174 696f  .        dilatio
+00019230: 6e2c 2020 2320 7365 7420 7374 7269 6465  n,  # set stride
+00019240: 3d64 696c 6174 696f 6e0a 2020 2020 2020  =dilation.      
+00019250: 2020 2830 2c29 2c0a 2020 2020 2020 2020    (0,),.        
+00019260: 7374 7269 6465 2c20 2023 2073 6574 2064  stride,  # set d
+00019270: 696c 6174 696f 6e3d 7374 7269 6465 0a20  ilation=stride. 
+00019280: 2020 2020 2020 2074 7261 6e73 706f 7365         transpose
+00019290: 642c 0a20 2020 2020 2020 206f 7574 7075  d,.        outpu
+000192a0: 745f 7061 6464 696e 672c 0a20 2020 2020  t_padding,.     
+000192b0: 2020 2067 726f 7570 732c 0a20 2020 2029     groups,.    )
+000192c0: 0a0a 2020 2020 2320 5468 6520 7265 7375  ..    # The resu
+000192d0: 6c74 206f 6620 7468 6520 636f 6e76 6f6c  lt of the convol
+000192e0: 7574 696f 6e20 6861 7320 7368 6170 6520  ution has shape 
+000192f0: 2867 696e 5f63 6861 6e6e 656c 732c 206f  (gin_channels, o
+00019300: 7574 5f63 6861 6e6e 656c 7329 2c0a 2020  ut_channels),.  
+00019310: 2020 2320 736f 2074 7261 6e73 706f 7369    # so transposi
+00019320: 7469 6f6e 2069 7320 7265 7175 6972 6564  tion is required
+00019330: 2e0a 2020 2020 7765 6967 6874 5f67 7261  ..    weight_gra
+00019340: 6420 3d20 636f 6e76 5f74 7261 6e73 706f  d = conv_transpo
+00019350: 7365 2877 6569 6768 745f 6772 6164 290a  se(weight_grad).
+00019360: 2020 2020 2320 7d0a 0a20 2020 2072 6574      # }..    ret
+00019370: 7572 6e20 2869 6e70 7574 5f67 7261 642c  urn (input_grad,
+00019380: 2077 6569 6768 745f 6772 6164 2c20 6269   weight_grad, bi
+00019390: 6173 5f67 7261 6429 0a0a 0a40 7265 6769  as_grad)...@regi
+000193a0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+000193b0: 6f72 7761 7264 2822 746f 7263 682e 6c6f  orward("torch.lo
+000193c0: 675f 736f 6674 6d61 7822 290a 6465 6620  g_softmax").def 
+000193d0: 6c6f 675f 736f 6674 6d61 785f 6175 675f  log_softmax_aug_
+000193e0: 6677 6428 696e 7075 743a 2054 656e 736f  fwd(input: Tenso
+000193f0: 7250 726f 7879 2c20 6469 6d3a 2069 6e74  rProxy, dim: int
+00019400: 2c20 2a2c 2064 7479 7065 3d4e 6f6e 6529  , *, dtype=None)
+00019410: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
+00019420: 2066 726f 6d20 7468 756e 6465 722e 746f   from thunder.to
+00019430: 7263 6820 696d 706f 7274 206c 6f67 5f73  rch import log_s
+00019440: 6f66 746d 6178 0a0a 2020 2020 7072 696d  oftmax..    prim
+00019450: 616c 203d 206c 6f67 5f73 6f66 746d 6178  al = log_softmax
+00019460: 2869 6e70 7574 2c20 6469 6d3d 6469 6d2c  (input, dim=dim,
+00019470: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
+00019480: 2020 7265 7369 6475 616c 7320 3d20 2870    residuals = (p
+00019490: 7269 6d61 6c2c 2064 696d 2c20 696e 7075  rimal, dim, inpu
+000194a0: 742e 6474 7970 6529 0a20 2020 2072 6574  t.dtype).    ret
+000194b0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+000194c0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000194d0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000194e0: 6172 6428 2274 6f72 6368 2e6c 6f67 5f73  ard("torch.log_s
+000194f0: 6f66 746d 6178 2229 0a64 6566 206c 6f67  oftmax").def log
+00019500: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
+00019510: 6428 7072 696d 616c 2c20 6469 6d2c 2064  d(primal, dim, d
+00019520: 7479 7065 2c20 6729 3a0a 2020 2020 6672  type, g):.    fr
+00019530: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00019540: 2069 6d70 6f72 7420 6c6f 675f 736f 6674   import log_soft
+00019550: 6d61 785f 6261 636b 7761 7264 0a0a 2020  max_backward..  
+00019560: 2020 7265 7475 726e 206c 6f67 5f73 6f66    return log_sof
+00019570: 746d 6178 5f62 6163 6b77 6172 6428 672c  tmax_backward(g,
+00019580: 2070 7269 6d61 6c2c 2064 696d 2c20 6474   primal, dim, dt
+00019590: 7970 6529 0a0a 0a40 7265 6769 7374 6572  ype)...@register
+000195a0: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+000195b0: 7264 2822 746f 7263 682e 6e6e 2e66 756e  rd("torch.nn.fun
+000195c0: 6374 696f 6e61 6c2e 6e6c 6c5f 6c6f 7373  ctional.nll_loss
+000195d0: 2229 0a64 6566 206e 6c6c 5f6c 6f73 735f  ").def nll_loss_
+000195e0: 6175 675f 6677 6428 0a20 2020 2069 6e70  aug_fwd(.    inp
+000195f0: 7574 3a20 5072 6f78 792c 0a20 2020 2074  ut: Proxy,.    t
+00019600: 6172 6765 743a 2050 726f 7879 2c0a 2020  arget: Proxy,.  
+00019610: 2020 7765 6967 6874 3a20 4e6f 6e65 207c    weight: None |
+00019620: 2050 726f 7879 2c0a 2020 2020 6967 6e6f   Proxy,.    igno
+00019630: 7265 5f69 6e64 6578 3a20 696e 742c 0a20  re_index: int,. 
+00019640: 2020 2072 6564 7563 7469 6f6e 3a20 7374     reduction: st
+00019650: 722c 0a29 202d 3e20 564a 5044 7561 6c3a  r,.) -> VJPDual:
+00019660: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00019670: 722e 746f 7263 6820 696d 706f 7274 205f  r.torch import _
+00019680: 6e6c 6c5f 6c6f 7373 5f68 656c 7065 720a  nll_loss_helper.
+00019690: 0a20 2020 2070 7269 6d61 6c2c 2074 6f74  .    primal, tot
+000196a0: 616c 5f77 6569 6768 7420 3d20 5f6e 6c6c  al_weight = _nll
+000196b0: 5f6c 6f73 735f 6865 6c70 6572 280a 2020  _loss_helper(.  
+000196c0: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
+000196d0: 2020 2020 2074 6172 6765 742c 0a20 2020       target,.   
+000196e0: 2020 2020 2077 6569 6768 742c 0a20 2020       weight,.   
+000196f0: 2020 2020 2069 676e 6f72 655f 696e 6465       ignore_inde
+00019700: 782c 0a20 2020 2020 2020 2072 6564 7563  x,.        reduc
+00019710: 7469 6f6e 2c0a 2020 2020 290a 2020 2020  tion,.    ).    
+00019720: 7265 7369 6475 616c 7320 3d20 2869 6e70  residuals = (inp
+00019730: 7574 2c20 7461 7267 6574 2c20 7765 6967  ut, target, weig
+00019740: 6874 2c20 7265 6475 6374 696f 6e2c 2069  ht, reduction, i
+00019750: 676e 6f72 655f 696e 6465 782c 2074 6f74  gnore_index, tot
+00019760: 616c 5f77 6569 6768 7429 0a20 2020 2072  al_weight).    r
+00019770: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
+00019780: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
+00019790: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+000197a0: 6b77 6172 6428 2274 6f72 6368 2e6e 6e2e  kward("torch.nn.
+000197b0: 6675 6e63 7469 6f6e 616c 2e6e 6c6c 5f6c  functional.nll_l
+000197c0: 6f73 7322 290a 6465 6620 6e6c 6c5f 6c6f  oss").def nll_lo
+000197d0: 7373 5f62 6163 6b77 6172 6428 696e 7075  ss_backward(inpu
+000197e0: 742c 2074 6172 6765 742c 2077 6569 6768  t, target, weigh
+000197f0: 742c 2072 6564 7563 7469 6f6e 2c20 6967  t, reduction, ig
+00019800: 6e6f 7265 5f69 6e64 6578 2c20 746f 7461  nore_index, tota
+00019810: 6c5f 7765 6967 6874 2c20 6729 3a0a 2020  l_weight, g):.  
+00019820: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00019830: 6f72 6368 2069 6d70 6f72 7420 6e6c 6c5f  orch import nll_
+00019840: 6c6f 7373 5f62 6163 6b77 6172 640a 0a20  loss_backward.. 
+00019850: 2020 2067 696e 7075 7420 3d20 6e6c 6c5f     ginput = nll_
+00019860: 6c6f 7373 5f62 6163 6b77 6172 6428 672c  loss_backward(g,
+00019870: 2069 6e70 7574 2c20 7461 7267 6574 2c20   input, target, 
+00019880: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
+00019890: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
+000198a0: 2074 6f74 616c 5f77 6569 6768 7429 0a20   total_weight). 
+000198b0: 2020 2072 6574 7572 6e20 6769 6e70 7574     return ginput
+000198c0: 2c20 2a28 284e 6f6e 652c 2920 2a20 3429  , *((None,) * 4)
+000198d0: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+000198e0: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
+000198f0: 746f 7263 682e 7370 6c69 7422 290a 6465  torch.split").de
+00019900: 6620 7370 6c69 745f 6175 675f 6677 6428  f split_aug_fwd(
+00019910: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+00019920: 7370 6c69 745f 7369 7a65 5f6f 725f 7365  split_size_or_se
+00019930: 6374 696f 6e73 3a20 696e 7420 7c20 5365  ctions: int | Se
+00019940: 7175 656e 6365 5b69 6e74 5d2c 2064 696d  quence[int], dim
+00019950: 3a20 696e 7420 3d20 3029 202d 3e20 564a  : int = 0) -> VJ
+00019960: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
+00019970: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+00019980: 706f 7274 2073 706c 6974 0a0a 2020 2020  port split..    
+00019990: 7072 696d 616c 203d 2073 706c 6974 2861  primal = split(a
+000199a0: 2c20 7370 6c69 745f 7369 7a65 5f6f 725f  , split_size_or_
+000199b0: 7365 6374 696f 6e73 2c20 6469 6d29 0a20  sections, dim). 
+000199c0: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+000199d0: 6469 6d2c 290a 2020 2020 7265 7475 726e  dim,).    return
+000199e0: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
+000199f0: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
+00019a00: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00019a10: 2822 746f 7263 682e 7370 6c69 7422 290a  ("torch.split").
+00019a20: 6465 6620 7370 6c69 745f 6261 636b 7761  def split_backwa
+00019a30: 7264 2864 696d 2c20 2a67 7261 6473 293a  rd(dim, *grads):
+00019a40: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00019a50: 722e 746f 7263 6820 696d 706f 7274 2063  r.torch import c
+00019a60: 6174 0a0a 2020 2020 7265 7475 726e 2063  at..    return c
+00019a70: 6174 2867 7261 6473 2c20 6469 6d29 0a0a  at(grads, dim)..
+00019a80: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00019a90: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
+00019aa0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+00019ab0: 6c2e 656d 6265 6464 696e 6722 290a 6465  l.embedding").de
+00019ac0: 6620 656d 6265 6464 696e 675f 6175 675f  f embedding_aug_
+00019ad0: 6677 6428 0a20 2020 2061 3a20 5072 6f78  fwd(.    a: Prox
+00019ae0: 792c 0a20 2020 2077 6569 6768 743a 2050  y,.    weight: P
+00019af0: 726f 7879 2c0a 2020 2020 7061 6464 696e  roxy,.    paddin
+00019b00: 675f 6964 783a 2069 6e74 207c 204e 6f6e  g_idx: int | Non
+00019b10: 652c 0a20 2020 206d 6178 5f6e 6f72 6d3a  e,.    max_norm:
+00019b20: 2066 6c6f 6174 207c 204e 6f6e 652c 0a20   float | None,. 
+00019b30: 2020 206e 6f72 6d5f 7479 7065 3a20 666c     norm_type: fl
+00019b40: 6f61 742c 0a20 2020 2073 6361 6c65 5f67  oat,.    scale_g
+00019b50: 7261 645f 6279 5f66 7265 713a 2062 6f6f  rad_by_freq: boo
+00019b60: 6c2c 0a20 2020 2073 7061 7273 653a 2062  l,.    sparse: b
+00019b70: 6f6f 6c2c 0a29 202d 3e20 564a 5044 7561  ool,.) -> VJPDua
+00019b80: 6c3a 0a20 2020 2066 726f 6d20 7468 756e  l:.    from thun
+00019b90: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
+00019ba0: 2065 6d62 6564 6469 6e67 0a0a 2020 2020   embedding..    
+00019bb0: 7072 696d 616c 203d 2065 6d62 6564 6469  primal = embeddi
+00019bc0: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
+00019bd0: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
+00019be0: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
+00019bf0: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
+00019c00: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
+00019c10: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
+00019c20: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
+00019c30: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
+00019c40: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+00019c50: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
+00019c60: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
+00019c70: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
+00019c80: 2020 290a 2020 2020 7265 7369 6475 616c    ).    residual
+00019c90: 7320 3d20 2861 2c20 7765 6967 6874 2e73  s = (a, weight.s
+00019ca0: 6861 7065 5b30 5d2c 2070 6164 6469 6e67  hape[0], padding
+00019cb0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
+00019cc0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
+00019cd0: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+00019ce0: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00019cf0: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+00019d00: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
+00019d10: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+00019d20: 6c2e 656d 6265 6464 696e 6722 290a 6465  l.embedding").de
+00019d30: 6620 656d 6265 6464 696e 675f 6261 636b  f embedding_back
+00019d40: 7761 7264 2861 2c20 6e75 6d5f 7765 6967  ward(a, num_weig
+00019d50: 6874 732c 2070 6164 6469 6e67 5f69 6478  hts, padding_idx
+00019d60: 2c20 7363 616c 655f 6772 6164 5f62 795f  , scale_grad_by_
+00019d70: 6672 6571 2c20 7370 6172 7365 2c20 6729  freq, sparse, g)
+00019d80: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
+00019d90: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
+00019da0: 656d 6265 6464 696e 675f 6261 636b 7761  embedding_backwa
+00019db0: 7264 0a0a 2020 2020 7061 6464 696e 675f  rd..    padding_
+00019dc0: 6964 7820 3d20 2d31 2069 6620 7061 6464  idx = -1 if padd
+00019dd0: 696e 675f 6964 7820 6973 204e 6f6e 6520  ing_idx is None 
+00019de0: 656c 7365 2070 6164 6469 6e67 5f69 6478  else padding_idx
+00019df0: 0a20 2020 2067 7765 6967 6874 203d 2065  .    gweight = e
+00019e00: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
+00019e10: 6428 672c 2061 2c20 6e75 6d5f 7765 6967  d(g, a, num_weig
+00019e20: 6874 732c 2070 6164 6469 6e67 5f69 6478  hts, padding_idx
+00019e30: 2c20 7363 616c 655f 6772 6164 5f62 795f  , scale_grad_by_
+00019e40: 6672 6571 2c20 7370 6172 7365 290a 2020  freq, sparse).  
+00019e50: 2020 7265 7475 726e 2067 7765 6967 6874    return gweight
+00019e60: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00019e70: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
+00019e80: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
+00019e90: 6566 2063 756d 7375 6d5f 6175 675f 6677  ef cumsum_aug_fw
+00019ea0: 6428 613a 2050 726f 7879 2c20 6469 6d3a  d(a: Proxy, dim:
+00019eb0: 2069 6e74 2c20 2a2c 2064 7479 7065 3a20   int, *, dtype: 
+00019ec0: 4e6f 6e65 207c 2064 7479 7065 732e 6474  None | dtypes.dt
+00019ed0: 7970 6520 3d20 4e6f 6e65 2920 2d3e 2056  ype = None) -> V
+00019ee0: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
+00019ef0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00019f00: 6d70 6f72 7420 6375 6d73 756d 0a0a 2020  mport cumsum..  
+00019f10: 2020 7072 696d 616c 203d 2063 756d 7375    primal = cumsu
+00019f20: 6d28 612c 2064 696d 2c20 6474 7970 653d  m(a, dim, dtype=
+00019f30: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
+00019f40: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
+00019f50: 2061 2e64 7479 7065 2c0a 2020 2020 2020   a.dtype,.      
+00019f60: 2020 6469 6d2c 0a20 2020 2029 0a20 2020    dim,.    ).   
+00019f70: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00019f80: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+00019f90: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+00019fa0: 6163 6b77 6172 6428 2274 6f72 6368 2e63  ackward("torch.c
+00019fb0: 756d 7375 6d22 290a 6465 6620 6375 6d73  umsum").def cums
+00019fc0: 756d 5f62 6163 6b77 6172 6428 615f 6474  um_backward(a_dt
+00019fd0: 7970 652c 2064 696d 2c20 6729 3a0a 2020  ype, dim, g):.  
+00019fe0: 2020 6720 3d20 672e 746f 2861 5f64 7479    g = g.to(a_dty
+00019ff0: 7065 290a 2020 2020 6966 2067 2e6e 756d  pe).    if g.num
+0001a000: 656c 2829 203c 3d20 3120 6f72 2067 2e73  el() <= 1 or g.s
+0001a010: 6861 7065 5b64 696d 5d20 3d3d 2031 3a0a  hape[dim] == 1:.
+0001a020: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0001a030: 0a20 2020 2072 6574 7572 6e20 672e 666c  .    return g.fl
+0001a040: 6970 2864 696d 292e 6375 6d73 756d 2864  ip(dim).cumsum(d
+0001a050: 696d 292e 666c 6970 2864 696d 290a 0a0a  im).flip(dim)...
+0001a060: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+0001a070: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+0001a080: 6368 2e73 6f66 746d 6178 2229 0a64 6566  ch.softmax").def
+0001a090: 2073 6f66 746d 6178 5f61 7567 5f66 7764   softmax_aug_fwd
+0001a0a0: 2861 3a20 5072 6f78 792c 2064 696d 3a20  (a: Proxy, dim: 
+0001a0b0: 696e 742c 2064 7479 7065 3a20 6474 7970  int, dtype: dtyp
+0001a0c0: 6573 2e64 7479 7065 207c 204e 6f6e 6520  es.dtype | None 
+0001a0d0: 3d20 4e6f 6e65 2920 2d3e 2056 4a50 4475  = None) -> VJPDu
+0001a0e0: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+0001a0f0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+0001a100: 7420 736f 6674 6d61 780a 0a20 2020 2070  t softmax..    p
+0001a110: 7269 6d61 6c20 3d20 736f 6674 6d61 7828  rimal = softmax(
+0001a120: 612c 2064 696d 2c20 6474 7970 653d 6474  a, dim, dtype=dt
+0001a130: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
+0001a140: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
+0001a150: 6d29 0a20 2020 2072 6574 7572 6e20 564a  m).    return VJ
+0001a160: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+0001a170: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+0001a180: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
+0001a190: 6f72 6368 2e73 6f66 746d 6178 2229 0a64  orch.softmax").d
+0001a1a0: 6566 2073 6f66 746d 6178 5f62 6163 6b77  ef softmax_backw
+0001a1b0: 6172 6428 7072 696d 616c 2c20 6469 6d2c  ard(primal, dim,
+0001a1c0: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
+0001a1d0: 7072 696d 616c 202a 2028 6720 2d20 2870  primal * (g - (p
+0001a1e0: 7269 6d61 6c20 2a20 6729 2e73 756d 2864  rimal * g).sum(d
+0001a1f0: 696d 2c20 6b65 6570 6469 6d3d 5472 7565  im, keepdim=True
+0001a200: 2929 0a0a 0a64 6566 2069 7465 725f 626f  ))...def iter_bo
+0001a210: 756e 645f 7379 6d62 6f6c 7328 626f 756e  und_symbols(boun
+0001a220: 645f 7379 6d62 6f6c 7329 3a0a 2020 2020  d_symbols):.    
+0001a230: 2222 2249 7465 7261 7465 206f 7665 7220  """Iterate over 
+0001a240: 626f 756e 6420 7379 6d62 6f6c 732c 2073  bound symbols, s
+0001a250: 6b69 7070 696e 6720 7379 6d62 6f6c 7320  kipping symbols 
+0001a260: 7468 6174 2061 7265 206e 6f74 2073 7570  that are not sup
+0001a270: 706f 7274 6564 2062 790a 2020 2020 7468  ported by.    th
+0001a280: 6520 7472 616e 7366 6f72 6d73 2069 6e66  e transforms inf
+0001a290: 7261 7374 7275 6374 7572 652e 0a0a 2020  rastructure...  
+0001a2a0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001a2b0: 626f 756e 645f 7379 6d62 6f6c 7320 284c  bound_symbols (L
+0001a2c0: 6973 745b 426f 756e 6453 796d 626f 6c5d  ist[BoundSymbol]
+0001a2d0: 293a 204c 6973 7420 6f66 2062 6f75 6e64  ): List of bound
+0001a2e0: 2073 796d 626f 6c73 0a0a 2020 2020 5969   symbols..    Yi
+0001a2f0: 656c 6473 3a0a 2020 2020 2020 2020 426f  elds:.        Bo
+0001a300: 756e 6453 796d 626f 6c3a 2042 6f75 6e64  undSymbol: Bound
+0001a310: 2073 796d 626f 6c73 2074 6861 7420 6172   symbols that ar
+0001a320: 6520 7375 7070 6f72 7465 6420 6279 2074  e supported by t
+0001a330: 6865 2074 7261 6e73 666f 726d 730a 2020  he transforms.  
+0001a340: 2020 2020 2020 696e 6672 6173 7472 7563        infrastruc
+0001a350: 7475 7265 0a20 2020 2022 2222 0a20 2020  ture.    """.   
+0001a360: 2066 6f72 2073 796d 626f 6c20 696e 2062   for symbol in b
+0001a370: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
+0001a380: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
+0001a390: 7379 6d2e 6964 2069 6e20 7472 616e 7366  sym.id in transf
+0001a3a0: 6f72 6d5f 736b 6970 5f6c 6973 743a 0a20  orm_skip_list:. 
+0001a3b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0001a3c0: 6e75 650a 2020 2020 2020 2020 656c 6966  nue.        elif
+0001a3d0: 2073 796d 626f 6c2e 6f75 7470 7574 2069   symbol.output i
+0001a3e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001a3f0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0001a400: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001a410: 2020 2020 2020 2079 6965 6c64 2073 796d         yield sym
+0001a420: 626f 6c0a 0a0a 6465 6620 6465 636f 6e73  bol...def decons
+0001a430: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
+0001a440: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
+0001a450: 7261 6365 2c20 656e 7629 3a0a 2020 2020  race, env):.    
+0001a460: 2320 4e6f 7465 205b 5361 7669 6e67 2074  # Note [Saving t
+0001a470: 6865 2066 6f72 7761 7264 2065 6e76 6972  he forward envir
+0001a480: 6f6e 6d65 6e74 2069 6e20 7468 6520 6261  onment in the ba
+0001a490: 636b 7761 7264 2072 756c 655d 0a20 2020  ckward rule].   
+0001a4a0: 2023 2057 6520 6361 6e6e 6f74 2073 6176   # We cannot sav
+0001a4b0: 6520 7468 6520 7472 6163 6520 6f62 6a65  e the trace obje
+0001a4c0: 6374 2069 6e20 7468 6520 7265 7369 6475  ct in the residu
+0001a4d0: 616c 7320 6265 6361 7573 6520 6578 6563  als because exec
+0001a4e0: 7574 6f72 7320 6d61 7920 6e6f 740a 2020  utors may not.  
+0001a4f0: 2020 2320 6265 2061 626c 6520 746f 2072    # be able to r
+0001a500: 6574 7572 6e20 6974 2066 6f72 2074 6865  eturn it for the
+0001a510: 2073 706c 6974 7465 6420 666f 7277 6172   splitted forwar
+0001a520: 642f 6261 636b 7761 7264 2070 6173 7365  d/backward passe
+0001a530: 732e 2049 6e73 7465 6164 2c20 7765 0a20  s. Instead, we. 
+0001a540: 2020 2023 2073 6176 6520 6172 6773 2061     # save args a
+0001a550: 6e64 206b 7761 7267 7320 6f66 2074 6865  nd kwargs of the
+0001a560: 206f 7269 6769 6e61 6c20 6675 6e63 7469   original functi
+0001a570: 6f6e 2063 616c 6c20 616e 6420 7265 636f  on call and reco
+0001a580: 6e73 7472 7563 7420 7468 650a 2020 2020  nstruct the.    
+0001a590: 2320 7472 6163 6520 6f62 6a65 6374 2061  # trace object a
+0001a5a0: 6e64 2069 7473 2065 6e76 6972 6f6e 6d65  nd its environme
+0001a5b0: 6e74 2064 6963 7420 696e 2074 6865 2062  nt dict in the b
+0001a5c0: 6163 6b77 6172 6420 7275 6c65 2e20 4865  ackward rule. He
+0001a5d0: 7265 2077 6520 7265 6c79 0a20 2020 2023  re we rely.    #
+0001a5e0: 206f 6e20 7468 6520 6661 6374 2074 6861   on the fact tha
+0001a5f0: 7420 7468 6520 6f72 6465 7220 6f66 2074  t the order of t
+0001a600: 6865 2073 796d 626f 6c73 2069 6e20 7468  he symbols in th
+0001a610: 6520 7472 6163 6520 6973 2064 6574 6572  e trace is deter
+0001a620: 6d69 6e69 7374 6963 0a20 2020 2023 2061  ministic.    # a
+0001a630: 6e64 2061 6c77 6179 7320 7468 6520 7361  nd always the sa
+0001a640: 6d65 2066 6f72 2074 6865 2073 616d 6520  me for the same 
+0001a650: 6675 6e63 7469 6f6e 2063 616c 6c20 616e  function call an
+0001a660: 6420 7468 6520 7361 6d65 2073 6574 206f  d the same set o
+0001a670: 660a 2020 2020 2320 6172 6775 6d65 6e74  f.    # argument
+0001a680: 732e 2053 6565 2074 6573 745f 6772 6164  s. See test_grad
+0001a690: 2e70 793a 7465 7374 5f74 6f72 6368 5f61  .py:test_torch_a
+0001a6a0: 7574 6f67 7261 645f 6675 6e63 7469 6f6e  utograd_function
+0001a6b0: 2066 6f72 2061 6e20 6578 616d 706c 650a   for an example.
+0001a6c0: 2020 2020 2320 7768 6572 6520 7468 6973      # where this
+0001a6d0: 2069 7320 7465 7374 6564 2e0a 2020 2020   is tested..    
+0001a6e0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0001a6f0: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
+0001a700: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
+0001a710: 796d 626f 6c73 290a 2020 2020 7361 7665  ymbols).    save
+0001a720: 645f 666f 725f 6261 636b 7761 7264 203d  d_for_backward =
+0001a730: 2074 7570 6c65 2865 6e76 5b73 6571 7565   tuple(env[seque
+0001a740: 6e63 6966 7928 7379 6d62 6f6c 2e6f 7574  ncify(symbol.out
+0001a750: 7075 7429 5b30 5d2e 6e61 6d65 5d2e 7265  put)[0].name].re
+0001a760: 7369 6475 616c 7320 666f 7220 7379 6d62  siduals for symb
+0001a770: 6f6c 2069 6e20 626f 756e 645f 7379 6d62  ol in bound_symb
+0001a780: 6f6c 7329 0a20 2020 2072 6574 7572 6e20  ols).    return 
+0001a790: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001a7a0: 7264 0a0a 0a64 6566 2072 6563 6f6e 7374  rd...def reconst
+0001a7b0: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
+0001a7c0: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
+0001a7d0: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
+0001a7e0: 6163 6b77 6172 6429 3a0a 2020 2020 626f  ackward):.    bo
+0001a7f0: 756e 645f 7379 6d62 6f6c 7320 3d20 6974  und_symbols = it
+0001a800: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
+0001a810: 2874 7261 6365 2e62 6f75 6e64 5f73 796d  (trace.bound_sym
+0001a820: 626f 6c73 290a 0a20 2020 2072 6563 6f6e  bols)..    recon
+0001a830: 7374 7275 6374 6564 5f65 6e76 203d 207b  structed_env = {
+0001a840: 7d0a 0a20 2020 2066 6f72 2069 6478 2c20  }..    for idx, 
+0001a850: 7379 6d20 696e 2065 6e75 6d65 7261 7465  sym in enumerate
+0001a860: 2862 6f75 6e64 5f73 796d 626f 6c73 293a  (bound_symbols):
+0001a870: 0a20 2020 2020 2020 206b 203d 2073 6571  .        k = seq
+0001a880: 7565 6e63 6966 7928 7379 6d2e 6f75 7470  uencify(sym.outp
+0001a890: 7574 295b 305d 2e6e 616d 650a 2020 2020  ut)[0].name.    
+0001a8a0: 2020 2020 7620 3d20 564a 5044 7561 6c28      v = VJPDual(
+0001a8b0: 4e6f 6e65 2c20 7361 7665 645f 666f 725f  None, saved_for_
+0001a8c0: 6261 636b 7761 7264 5b69 6478 5d29 0a20  backward[idx]). 
+0001a8d0: 2020 2020 2020 2072 6563 6f6e 7374 7275         reconstru
+0001a8e0: 6374 6564 5f65 6e76 5b6b 5d20 3d20 760a  cted_env[k] = v.
+0001a8f0: 0a20 2020 2072 6574 7572 6e20 7265 636f  .    return reco
+0001a900: 6e73 7472 7563 7465 645f 656e 760a 0a0a  nstructed_env...
+0001a910: 6465 6620 6465 636f 6d70 6f73 6564 5f66  def decomposed_f
+0001a920: 6e5f 6175 675f 6677 645f 7275 6c65 282a  n_aug_fwd_rule(*
+0001a930: 6172 6773 2c20 6465 636f 6d70 6f73 6564  args, decomposed
+0001a940: 5f66 6e2c 202a 2a6b 7761 7267 7329 3a0a  _fn, **kwargs):.
+0001a950: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
+0001a960: 2066 6f72 7761 7264 2072 756c 6520 666f   forward rule fo
+0001a970: 7220 636f 6d70 6f73 6974 6520 6675 6e63  r composite func
+0001a980: 7469 6f6e 7320 696d 706c 656d 656e 7465  tions implemente
+0001a990: 6420 696e 2074 6572 6d73 206f 6620 6f74  d in terms of ot
+0001a9a0: 6865 7220 6675 6e63 7469 6f6e 7320 7468  her functions th
+0001a9b0: 6174 2061 7265 0a20 2020 2073 7570 706f  at are.    suppo
+0001a9c0: 7365 6420 746f 2062 6520 7375 7070 6f72  sed to be suppor
+0001a9d0: 7465 6420 6279 2074 6865 2056 4a50 2069  ted by the VJP i
+0001a9e0: 6e66 7261 7374 7275 6374 7572 652e 0a0a  nfrastructure...
+0001a9f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001aa00: 2020 6465 636f 6d70 6f73 6564 5f66 6e20    decomposed_fn 
+0001aa10: 2843 616c 6c61 626c 6529 3a20 6465 636f  (Callable): deco
+0001aa20: 6d70 6f73 6564 2076 6572 7369 6f6e 206f  mposed version o
+0001aa30: 6620 7468 6520 6675 6e63 7469 6f6e 0a0a  f the function..
+0001aa40: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001aa50: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
+0001aa60: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
+0001aa70: 2072 756c 6520 666f 7220 7468 6520 636f   rule for the co
+0001aa80: 6d70 6f73 6974 6520 6675 6e63 7469 6f6e  mposite function
+0001aa90: 0a20 2020 2022 2222 0a20 2020 2074 7261  .    """.    tra
+0001aaa0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+0001aab0: 7261 6365 2829 2864 6563 6f6d 706f 7365  race()(decompose
+0001aac0: 645f 666e 2c20 2a61 7267 732c 202a 2a6b  d_fn, *args, **k
+0001aad0: 7761 7267 7329 0a20 2020 2074 7261 6365  wargs).    trace
+0001aae0: 203d 2075 6e77 7261 705f 6f6e 655f 6c65   = unwrap_one_le
+0001aaf0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
+0001ab00: 7328 7472 6163 6529 0a20 2020 2023 2054  s(trace).    # T
+0001ab10: 6865 7265 206d 6179 2062 6520 6120 6465  here may be a de
+0001ab20: 6164 206e 6f64 6520 6c69 6b65 2022 5f20  ad node like "_ 
+0001ab30: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
+0001ab40: 656c 656d 656e 745f 7479 7065 2830 2c20  element_type(0, 
+0001ab50: 666c 6f61 7429 220a 2020 2020 2320 696e  float)".    # in
+0001ab60: 2074 6865 2074 7261 6365 2e20 5765 206e   the trace. We n
+0001ab70: 6565 6420 746f 2072 656d 6f76 6520 6974  eed to remove it
+0001ab80: 2062 6566 6f72 6520 7765 2063 616e 2075   before we can u
+0001ab90: 7365 2074 6865 2074 7261 6365 2066 6f72  se the trace for
+0001aba0: 0a20 2020 2023 2061 7567 6d65 6e74 6564  .    # augmented
+0001abb0: 5f66 6f72 7761 7264 5f70 6173 732e 0a20  _forward_pass.. 
+0001abc0: 2020 2074 7261 6365 203d 2064 6365 2874     trace = dce(t
+0001abd0: 7261 6365 290a 2020 2020 7265 7375 6c74  race).    result
+0001abe0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
+0001abf0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
+0001ac00: 6172 6773 2c20 7472 6163 653d 7472 6163  args, trace=trac
+0001ac10: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+0001ac20: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001ac30: 6172 6420 3d20 6465 636f 6e73 7472 7563  ard = deconstruc
+0001ac40: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
+0001ac50: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
+0001ac60: 2c20 656e 7629 0a20 2020 2023 2053 7461  , env).    # Sta
+0001ac70: 7469 6320 6361 6368 696e 6720 646f 6573  tic caching does
+0001ac80: 206e 6f74 2077 6974 6820 7769 7468 206b   not with with k
+0001ac90: 7761 7267 7320 6469 6374 732c 2073 6f20  wargs dicts, so 
+0001aca0: 7765 2772 6520 636f 6e76 6572 7469 6e67  we're converting
+0001acb0: 2074 6865 6d0a 2020 2020 2320 746f 204e   them.    # to N
+0001acc0: 6f6e 6520 666f 7220 6e6f 7720 7768 656e  one for now when
+0001acd0: 2070 6f73 7369 626c 652e 0a20 2020 206b   possible..    k
+0001ace0: 7761 7267 7320 3d20 4e6f 6e65 2069 6620  wargs = None if 
+0001acf0: 6e6f 7420 6b77 6172 6773 2065 6c73 6520  not kwargs else 
+0001ad00: 6b77 6172 6773 0a20 2020 2072 6573 6964  kwargs.    resid
+0001ad10: 7561 6c73 203d 2028 6172 6773 2c20 6b77  uals = (args, kw
+0001ad20: 6172 6773 2c20 7361 7665 645f 666f 725f  args, saved_for_
+0001ad30: 6261 636b 7761 7264 290a 2020 2020 7265  backward).    re
+0001ad40: 7475 726e 2056 4a50 4475 616c 2872 6573  turn VJPDual(res
+0001ad50: 756c 742c 2072 6573 6964 7561 6c73 290a  ult, residuals).
+0001ad60: 0a0a 6465 6620 6465 636f 6d70 6f73 6564  ..def decomposed
+0001ad70: 5f66 6e5f 6261 636b 7761 7264 5f72 756c  _fn_backward_rul
+0001ad80: 6528 6465 636f 6d70 6f73 6564 5f66 6e2c  e(decomposed_fn,
+0001ad90: 2061 7267 732c 206b 7761 7267 732c 2073   args, kwargs, s
+0001ada0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001adb0: 642c 202a 6772 6164 7329 3a0a 2020 2020  d, *grads):.    
+0001adc0: 6b77 6172 6773 203d 207b 7d20 6966 206b  kwargs = {} if k
+0001add0: 7761 7267 7320 6973 204e 6f6e 6520 656c  wargs is None el
+0001ade0: 7365 206b 7761 7267 730a 2020 2020 7472  se kwargs.    tr
+0001adf0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+0001ae00: 7472 6163 6528 2928 6465 636f 6d70 6f73  trace()(decompos
+0001ae10: 6564 5f66 6e2c 202a 6172 6773 2c20 2a2a  ed_fn, *args, **
+0001ae20: 6b77 6172 6773 290a 2020 2020 7472 6163  kwargs).    trac
+0001ae30: 6520 3d20 756e 7772 6170 5f6f 6e65 5f6c  e = unwrap_one_l
+0001ae40: 6576 656c 5f6f 665f 7375 6273 796d 626f  evel_of_subsymbo
+0001ae50: 6c73 2874 7261 6365 290a 2020 2020 7472  ls(trace).    tr
+0001ae60: 6163 6520 3d20 6463 6528 7472 6163 6529  ace = dce(trace)
+0001ae70: 0a20 2020 2023 2062 6f75 6e64 5f73 796d  .    # bound_sym
+0001ae80: 626f 6c73 203d 2069 7465 725f 626f 756e  bols = iter_boun
+0001ae90: 645f 7379 6d62 6f6c 7328 7472 6163 652e  d_symbols(trace.
+0001aea0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+0001aeb0: 2020 2023 2072 6563 6f6e 7374 7275 6374     # reconstruct
+0001aec0: 6564 5f65 6e76 203d 207b 0a20 2020 2023  ed_env = {.    #
+0001aed0: 2020 2020 2073 6571 7565 6e63 6966 7928       sequencify(
+0001aee0: 7379 6d62 6f6c 2e6f 7574 7075 7429 5b30  symbol.output)[0
+0001aef0: 5d2e 6e61 6d65 3a20 564a 5044 7561 6c28  ].name: VJPDual(
+0001af00: 4e6f 6e65 2c20 7361 7665 645f 666f 725f  None, saved_for_
+0001af10: 6261 636b 7761 7264 5b69 5d29 0a20 2020  backward[i]).   
+0001af20: 2023 2020 2020 2066 6f72 2069 2c20 7379   #     for i, sy
+0001af30: 6d62 6f6c 2069 6e20 656e 756d 6572 6174  mbol in enumerat
+0001af40: 6528 626f 756e 645f 7379 6d62 6f6c 7329  e(bound_symbols)
+0001af50: 0a20 2020 2023 207d 0a20 2020 2072 6563  .    # }.    rec
+0001af60: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
+0001af70: 2072 6563 6f6e 7374 7275 6374 5f66 6f72   reconstruct_for
+0001af80: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
+0001af90: 6b77 6172 6428 7472 6163 652c 2073 6176  kward(trace, sav
+0001afa0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+0001afb0: 0a20 2020 2072 6573 756c 7420 3d20 6261  .    result = ba
+0001afc0: 636b 7761 7264 5f70 6173 7328 7265 636f  ckward_pass(reco
+0001afd0: 6e73 7472 7563 7465 645f 656e 762c 2074  nstructed_env, t
+0001afe0: 7261 6365 2c20 6772 6164 7329 0a20 2020  race, grads).   
+0001aff0: 2069 6620 6c65 6e28 6172 6773 2920 3d3d   if len(args) ==
+0001b000: 2031 3a0a 2020 2020 2020 2020 7265 7475   1:.        retu
+0001b010: 726e 2072 6573 756c 745b 305d 0a20 2020  rn result[0].   
+0001b020: 2023 2042 6163 6b77 6172 6420 7061 7373   # Backward pass
+0001b030: 206d 6967 6874 2072 6574 7572 6e20 6120   might return a 
+0001b040: 6469 6374 2077 6974 6820 6772 6164 7320  dict with grads 
+0001b050: 6275 7420 6375 7272 656e 7420 696e 7465  but current inte
+0001b060: 7266 6163 6520 6f66 0a20 2020 2023 2062  rface of.    # b
+0001b070: 6163 6b77 6172 6420 7275 6c65 2064 6f65  ackward rule doe
+0001b080: 7320 6e6f 7420 7375 7070 6f72 7420 6974  s not support it
+0001b090: 2e20 536f 2077 6520 6a75 7374 2064 726f  . So we just dro
+0001b0a0: 7020 6974 2066 6f72 206e 6f77 2e0a 2020  p it for now..  
+0001b0b0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001b0c0: 6528 7265 7375 6c74 5b2d 315d 2c20 6469  e(result[-1], di
+0001b0d0: 6374 293a 0a20 2020 2020 2020 2072 6574  ct):.        ret
+0001b0e0: 7572 6e20 7265 7375 6c74 5b3a 2d31 5d0a  urn result[:-1].
+0001b0f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001b100: 740a 0a0a 4072 6567 6973 7465 725f 6175  t...@register_au
+0001b110: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+0001b120: 2274 6f72 6368 2e54 656e 736f 722e 636f  "torch.Tensor.co
+0001b130: 6e74 6967 756f 7573 2229 0a40 7265 6769  ntiguous").@regi
+0001b140: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+0001b150: 6f72 7761 7264 2822 746f 7263 682e 636f  orward("torch.co
+0001b160: 6e74 6967 756f 7573 2229 0a64 6566 2063  ntiguous").def c
+0001b170: 6f6e 7469 6775 6f75 735f 6175 675f 6677  ontiguous_aug_fw
+0001b180: 6428 783a 2054 656e 736f 7250 726f 7879  d(x: TensorProxy
+0001b190: 2c20 2f2c 202a 2c20 6d65 6d6f 7279 5f66  , /, *, memory_f
+0001b1a0: 6f72 6d61 743a 2074 6f72 6368 2e6d 656d  ormat: torch.mem
+0001b1b0: 6f72 795f 666f 726d 6174 203d 2074 6f72  ory_format = tor
+0001b1c0: 6368 2e63 6f6e 7469 6775 6f75 735f 666f  ch.contiguous_fo
+0001b1d0: 726d 6174 2920 2d3e 2056 4a50 4475 616c  rmat) -> VJPDual
+0001b1e0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
+0001b1f0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
+0001b200: 636f 6e74 6967 756f 7573 0a0a 2020 2020  contiguous..    
+0001b210: 7265 7475 726e 2056 4a50 4475 616c 2863  return VJPDual(c
+0001b220: 6f6e 7469 6775 6f75 7328 782c 206d 656d  ontiguous(x, mem
+0001b230: 6f72 795f 666f 726d 6174 3d6d 656d 6f72  ory_format=memor
+0001b240: 795f 666f 726d 6174 292c 2074 7570 6c65  y_format), tuple
+0001b250: 2829 290a 0a0a 4072 6567 6973 7465 725f  ())...@register_
+0001b260: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
+0001b270: 5465 6e73 6f72 2e63 6f6e 7469 6775 6f75  Tensor.contiguou
+0001b280: 7322 290a 4072 6567 6973 7465 725f 6261  s").@register_ba
+0001b290: 636b 7761 7264 2822 746f 7263 682e 636f  ckward("torch.co
+0001b2a0: 6e74 6967 756f 7573 2229 0a64 6566 2063  ntiguous").def c
+0001b2b0: 6f6e 7469 6775 6f75 735f 6261 636b 7761  ontiguous_backwa
+0001b2c0: 7264 282a 7265 7369 6475 616c 735f 616e  rd(*residuals_an
+0001b2d0: 645f 6772 6164 2920 2d3e 2054 656e 736f  d_grad) -> Tenso
+0001b2e0: 7250 726f 7879 3a0a 2020 2020 2320 5265  rProxy:.    # Re
+0001b2f0: 7369 6475 616c 7320 6973 206e 6f74 2065  siduals is not e
+0001b300: 6d70 7479 2062 6563 6175 7365 2063 6f6e  mpty because con
+0001b310: 7469 6775 6f75 7320 7379 6d62 6f6c 2068  tiguous symbol h
+0001b320: 6173 2074 6865 2073 616d 6520 6f75 7470  as the same outp
+0001b330: 7574 2061 7320 6974 7320 696e 7075 740a  ut as its input.
+0001b340: 2020 2020 6720 3d20 7265 7369 6475 616c      g = residual
+0001b350: 735f 616e 645f 6772 6164 5b2d 315d 0a20  s_and_grad[-1]. 
+0001b360: 2020 2072 6574 7572 6e20 670a 0a0a 6465     return g...de
+0001b370: 6620 7265 6369 7072 6f63 616c 5f61 7567  f reciprocal_aug
+0001b380: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
+0001b390: 6f78 7929 202d 3e20 564a 5044 7561 6c3a  oxy) -> VJPDual:
+0001b3a0: 0a20 2020 2070 7269 6d61 6c20 3d20 7265  .    primal = re
+0001b3b0: 6369 7072 6f63 616c 2861 290a 2020 2020  ciprocal(a).    
+0001b3c0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
+0001b3d0: 7269 6d61 6c2c 2028 7072 696d 616c 2c29  rimal, (primal,)
+0001b3e0: 290a 0a0a 6465 6620 7265 6369 7072 6f63  )...def reciproc
+0001b3f0: 616c 5f62 6163 6b77 6172 6428 7072 696d  al_backward(prim
+0001b400: 616c 2c20 6729 3a0a 2020 2020 7265 7475  al, g):.    retu
+0001b410: 726e 202d 6720 2a20 7072 696d 616c 202a  rn -g * primal *
+0001b420: 2070 7269 6d61 6c0a 0a0a 4070 6172 7469   primal...@parti
+0001b430: 616c 2872 6567 6973 7465 725f 6772 6164  al(register_grad
+0001b440: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
+0001b450: 5245 4349 5052 4f43 414c 290a 6465 6620  RECIPROCAL).def 
+0001b460: 7265 6369 7072 6f63 616c 5f6a 6f69 6e74  reciprocal_joint
+0001b470: 5f66 6f72 7761 7264 5f62 6163 6b77 6172  _forward_backwar
+0001b480: 645f 7275 6c65 2861 3a20 5465 6e73 6f72  d_rule(a: Tensor
+0001b490: 5072 6f78 7929 202d 3e20 5465 6e73 6f72  Proxy) -> Tensor
+0001b4a0: 5072 6f78 793a 0a20 2020 2072 6573 756c  Proxy:.    resul
+0001b4b0: 742c 2073 6176 6564 203d 2072 6563 6970  t, saved = recip
+0001b4c0: 726f 6361 6c5f 6175 675f 6677 6428 6129  rocal_aug_fwd(a)
+0001b4d0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+0001b4e0: 6428 7265 7375 6c74 290a 2020 2020 6761  d(result).    ga
+0001b4f0: 203d 2072 6563 6970 726f 6361 6c5f 6261   = reciprocal_ba
+0001b500: 636b 7761 7264 282a 7361 7665 642c 2067  ckward(*saved, g
+0001b510: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+0001b520: 2c20 6761 290a 2020 2020 7265 7475 726e  , ga).    return
+0001b530: 2072 6573 756c 740a 0a0a 4072 6567 6973   result...@regis
+0001b540: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+0001b550: 7277 6172 6428 2274 6f72 6368 2e69 6e64  rward("torch.ind
+0001b560: 6578 5f70 7574 2229 0a64 6566 2069 6e64  ex_put").def ind
+0001b570: 6578 5f70 7574 5f61 7567 5f66 7764 280a  ex_put_aug_fwd(.
+0001b580: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
+0001b590: 7879 2c20 2f2c 2069 6e64 6963 6573 3a20  xy, /, indices: 
+0001b5a0: 5365 7175 656e 6365 5b54 656e 736f 7250  Sequence[TensorP
+0001b5b0: 726f 7879 5d2c 2076 616c 7565 733a 2054  roxy], values: T
+0001b5c0: 656e 736f 7250 726f 7879 2c20 6163 6375  ensorProxy, accu
+0001b5d0: 6d75 6c61 7465 3a20 626f 6f6c 203d 2046  mulate: bool = F
+0001b5e0: 616c 7365 0a29 202d 3e20 564a 5044 7561  alse.) -> VJPDua
+0001b5f0: 6c3a 0a20 2020 2070 7269 6d61 6c20 3d20  l:.    primal = 
+0001b600: 636c 616e 672e 696e 6465 785f 7075 7428  clang.index_put(
+0001b610: 612c 2069 6e64 6963 6573 2c20 7661 6c75  a, indices, valu
+0001b620: 6573 2c20 6163 6375 6d75 6c61 7465 290a  es, accumulate).
+0001b630: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
+0001b640: 280a 2020 2020 2020 2020 696e 6469 6365  (.        indice
+0001b650: 732c 0a20 2020 2020 2020 2076 616c 7565  s,.        value
+0001b660: 732c 0a20 2020 2020 2020 2061 6363 756d  s,.        accum
+0001b670: 756c 6174 652c 0a20 2020 2029 0a20 2020  ulate,.    ).   
+0001b680: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+0001b690: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+0001b6a0: 7329 0a0a 0a64 6566 2073 756d 5f74 6f28  s)...def sum_to(
+0001b6b0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+0001b6c0: 7368 6170 653a 2053 6571 7565 6e63 655b  shape: Sequence[
+0001b6d0: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
+0001b6e0: 726f 7879 3a0a 2020 2020 6966 206e 6f74  roxy:.    if not
+0001b6f0: 2073 6861 7065 3a0a 2020 2020 2020 2020   shape:.        
+0001b700: 7265 7475 726e 2061 2e73 756d 2829 0a20  return a.sum(). 
+0001b710: 2020 206c 6561 6469 6e67 5f64 696d 7320     leading_dims 
+0001b720: 3d20 612e 6e64 696d 202d 206c 656e 2873  = a.ndim - len(s
+0001b730: 6861 7065 290a 2020 2020 7265 6475 6365  hape).    reduce
+0001b740: 5f64 696d 7320 3d20 7475 706c 6528 7261  _dims = tuple(ra
+0001b750: 6e67 6528 6c65 6164 696e 675f 6469 6d73  nge(leading_dims
+0001b760: 2929 202b 2074 7570 6c65 280a 2020 2020  )) + tuple(.    
+0001b770: 2020 2020 6920 666f 7220 6920 696e 2072      i for i in r
+0001b780: 616e 6765 286c 6561 6469 6e67 5f64 696d  ange(leading_dim
+0001b790: 732c 2061 2e6e 6469 6d29 2069 6620 7368  s, a.ndim) if sh
+0001b7a0: 6170 655b 6920 2d20 6c65 6164 696e 675f  ape[i - leading_
+0001b7b0: 6469 6d73 5d20 3d3d 2031 2061 6e64 2061  dims] == 1 and a
+0001b7c0: 2e73 6861 7065 5b69 5d20 213d 2031 0a20  .shape[i] != 1. 
+0001b7d0: 2020 2029 0a20 2020 2061 203d 206c 746f     ).    a = lto
+0001b7e0: 7263 682e 7375 6d28 612c 2064 696d 3d72  rch.sum(a, dim=r
+0001b7f0: 6564 7563 655f 6469 6d73 2c20 6b65 6570  educe_dims, keep
+0001b800: 6469 6d3d 5472 7565 290a 2020 2020 6966  dim=True).    if
+0001b810: 206c 6561 6469 6e67 5f64 696d 7320 3e20   leading_dims > 
+0001b820: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
+0001b830: 6e20 6c74 6f72 6368 2e76 6965 7728 612c  n ltorch.view(a,
+0001b840: 2073 6861 7065 290a 2020 2020 7265 7475   shape).    retu
+0001b850: 726e 2061 0a0a 0a40 7265 6769 7374 6572  rn a...@register
+0001b860: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
+0001b870: 2e69 6e64 6578 5f70 7574 2229 0a64 6566  .index_put").def
+0001b880: 2069 6e64 6578 5f70 7574 5f62 6163 6b77   index_put_backw
+0001b890: 6172 6428 696e 6469 6365 733a 2053 6571  ard(indices: Seq
+0001b8a0: 7565 6e63 655b 5465 6e73 6f72 5072 6f78  uence[TensorProx
+0001b8b0: 795d 2c20 7661 6c75 6573 3a20 5465 6e73  y], values: Tens
+0001b8c0: 6f72 5072 6f78 792c 2061 6363 756d 756c  orProxy, accumul
+0001b8d0: 6174 653a 2062 6f6f 6c2c 2067 3a20 5465  ate: bool, g: Te
+0001b8e0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+0001b8f0: 675f 7661 6c75 6573 203d 2067 5b69 6e64  g_values = g[ind
+0001b900: 6963 6573 5d0a 2020 2020 2320 746f 7263  ices].    # torc
+0001b910: 6820 6861 7320 6578 7472 6120 6c6f 6769  h has extra logi
+0001b920: 6320 746f 2068 616e 646c 6520 7468 6520  c to handle the 
+0001b930: 6578 7061 6e64 6564 2076 616c 7565 730a  expanded values.
+0001b940: 2020 2020 6966 206e 6f74 2075 7469 6c73      if not utils
+0001b950: 2e73 616d 655f 7368 6170 6528 675f 7661  .same_shape(g_va
+0001b960: 6c75 6573 2e73 6861 7065 2c20 7661 6c75  lues.shape, valu
+0001b970: 6573 2e73 6861 7065 293a 0a20 2020 2020  es.shape):.     
+0001b980: 2020 2069 6620 636c 616e 672e 636f 6d70     if clang.comp
+0001b990: 7574 655f 6272 6f61 6463 6173 745f 7368  ute_broadcast_sh
+0001b9a0: 6170 6528 675f 7661 6c75 6573 2e73 6861  ape(g_values.sha
+0001b9b0: 7065 2c20 7661 6c75 6573 2e73 6861 7065  pe, values.shape
+0001b9c0: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
+0001b9d0: 5f76 616c 7565 7320 3d20 7375 6d5f 746f  _values = sum_to
+0001b9e0: 2867 5f76 616c 7565 732c 2076 616c 7565  (g_values, value
+0001b9f0: 732e 7368 6170 6529 0a20 2020 2069 6620  s.shape).    if 
+0001ba00: 6163 6375 6d75 6c61 7465 3a0a 2020 2020  accumulate:.    
+0001ba10: 2020 2020 7265 7475 726e 2067 2c20 675f      return g, g_
+0001ba20: 7661 6c75 6573 0a20 2020 2072 6574 7572  values.    retur
+0001ba30: 6e20 636c 616e 672e 696e 6465 785f 7075  n clang.index_pu
+0001ba40: 7428 672c 2069 6e64 6963 6573 2c20 6c74  t(g, indices, lt
+0001ba50: 6f72 6368 2e7a 6572 6f73 5f6c 696b 6528  orch.zeros_like(
+0001ba60: 7661 6c75 6573 292c 2046 616c 7365 292c  values), False),
+0001ba70: 2067 5f76 616c 7565 730a 0a0a 6465 6620   g_values...def 
+0001ba80: 756e 6966 6f72 6d5f 6175 675f 6677 6428  uniform_aug_fwd(
+0001ba90: 7368 6170 652c 206d 696e 7661 6c2c 206d  shape, minval, m
+0001baa0: 6178 7661 6c2c 202a 2c20 6465 7669 6365  axval, *, device
+0001bab0: 2c20 6474 7970 6529 3a0a 2020 2020 7072  , dtype):.    pr
+0001bac0: 696d 616c 203d 2070 7269 6d73 2e75 6e69  imal = prims.uni
+0001bad0: 666f 726d 2873 6861 7065 2c20 6d69 6e76  form(shape, minv
+0001bae0: 616c 2c20 6d61 7876 616c 2c20 6465 7669  al, maxval, devi
+0001baf0: 6365 3d64 6576 6963 652c 2064 7479 7065  ce=device, dtype
+0001bb00: 3d64 7479 7065 290a 2020 2020 7265 7475  =dtype).    retu
+0001bb10: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
+0001bb20: 6c2c 2028 7072 696d 616c 2c20 6d69 6e76  l, (primal, minv
+0001bb30: 616c 2c20 6d61 7876 616c 2929 0a0a 0a64  al, maxval))...d
+0001bb40: 6566 2075 6e69 666f 726d 5f62 6163 6b77  ef uniform_backw
+0001bb50: 6172 6428 7072 696d 616c 2c20 6d69 6e76  ard(primal, minv
+0001bb60: 616c 2c20 6d61 7876 616c 2c20 6729 3a0a  al, maxval, g):.
+0001bb70: 2020 2020 2320 756e 6966 6f72 6d20 6973      # uniform is
+0001bb80: 2069 6d70 6c65 6d65 6e74 6564 2061 7320   implemented as 
+0001bb90: 286d 6178 7661 6c20 2d20 6d69 6e76 616c  (maxval - minval
+0001bba0: 2920 2a20 756e 6966 6f72 6d28 7368 6170  ) * uniform(shap
+0001bbb0: 652c 2030 2c20 3129 202b 206d 696e 7661  e, 0, 1) + minva
+0001bbc0: 6c0a 2020 2020 756e 7363 616c 6564 5f70  l.    unscaled_p
+0001bbd0: 7269 6d61 6c20 3d20 2870 7269 6d61 6c20  rimal = (primal 
+0001bbe0: 2d20 6d69 6e76 616c 2920 2f20 286d 6178  - minval) / (max
+0001bbf0: 7661 6c20 2d20 6d69 6e76 616c 290a 2020  val - minval).  
+0001bc00: 2020 7265 6475 6365 5f61 6c6c 5f64 696d    reduce_all_dim
+0001bc10: 7320 3d20 7475 706c 6528 7261 6e67 6528  s = tuple(range(
+0001bc20: 672e 6e64 696d 2929 0a20 2020 2073 756d  g.ndim)).    sum
+0001bc30: 203d 2070 6172 7469 616c 2870 7269 6d73   = partial(prims
+0001bc40: 2e73 756d 2c20 6469 6d73 3d72 6564 7563  .sum, dims=reduc
+0001bc50: 655f 616c 6c5f 6469 6d73 290a 2020 2020  e_all_dims).    
+0001bc60: 7265 7475 726e 204e 6f6e 652c 2073 756d  return None, sum
+0001bc70: 2867 202a 2028 3120 2d20 756e 7363 616c  (g * (1 - unscal
+0001bc80: 6564 5f70 7269 6d61 6c29 292c 2073 756d  ed_primal)), sum
+0001bc90: 2867 202a 2075 6e73 6361 6c65 645f 7072  (g * unscaled_pr
+0001bca0: 696d 616c 290a 0a0a 6e6f 6e64 6966 6665  imal)...nondiffe
+0001bcb0: 7265 6e74 6961 626c 655f 766a 705f 7379  rentiable_vjp_sy
+0001bcc0: 6d62 6f6c 7320 3d20 2870 7269 6d73 2e50  mbols = (prims.P
+0001bcd0: 7269 6d49 4473 2e42 4954 5749 5345 5f41  rimIDs.BITWISE_A
+0001bce0: 4e44 2c20 7072 696d 732e 5072 696d 4944  ND, prims.PrimID
+0001bcf0: 732e 5349 474e 4249 542c 2070 7269 6d73  s.SIGNBIT, prims
+0001bd00: 2e50 7269 6d49 4473 2e46 554c 4c29 0a0a  .PrimIDs.FULL)..
+0001bd10: 0a64 6566 2069 735f 636f 6e73 7461 6e74  .def is_constant
+0001bd20: 5f66 6f72 5f76 6a70 2873 796d 626f 6c3a  _for_vjp(symbol:
+0001bd30: 2070 7269 6d73 2e53 796d 626f 6c29 202d   prims.Symbol) -
+0001bd40: 3e20 626f 6f6c 3a0a 2020 2020 2222 2243  > bool:.    """C
+0001bd50: 6865 636b 2069 6620 6120 7379 6d62 6f6c  heck if a symbol
+0001bd60: 2069 7320 636f 6e73 7461 6e74 2066 6f72   is constant for
+0001bd70: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
+0001bd80: 726d 2e0a 0a20 2020 2041 7267 733a 0a20  rm...    Args:. 
+0001bd90: 2020 2020 2020 2073 796d 626f 6c20 2870         symbol (p
+0001bda0: 7269 6d73 2e53 796d 626f 6c29 3a20 5379  rims.Symbol): Sy
+0001bdb0: 6d62 6f6c 2074 6f20 6368 6563 6b2e 0a0a  mbol to check...
+0001bdc0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001bdd0: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
+0001bde0: 6966 2074 6865 2073 796d 626f 6c20 6973  if the symbol is
+0001bdf0: 2063 6f6e 7374 616e 742c 2046 616c 7365   constant, False
+0001be00: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
+0001be10: 2222 220a 2020 2020 6172 655f 616c 6c5f  """.    are_all_
+0001be20: 6172 6773 5f6e 6f6e 5f64 6966 6665 7265  args_non_differe
+0001be30: 6e74 6961 626c 6520 3d20 6e6f 7420 616e  ntiable = not an
+0001be40: 7928 6973 696e 7374 616e 6365 2861 7267  y(isinstance(arg
+0001be50: 2c20 2846 6c6f 6174 5072 6f78 792c 2054  , (FloatProxy, T
+0001be60: 656e 736f 7250 726f 7879 2929 2066 6f72  ensorProxy)) for
+0001be70: 2061 7267 2069 6e20 7379 6d62 6f6c 2e66   arg in symbol.f
+0001be80: 6c61 745f 6172 6773 290a 2020 2020 7265  lat_args).    re
+0001be90: 7475 726e 2028 0a20 2020 2020 2020 2061  turn (.        a
+0001bea0: 7265 5f61 6c6c 5f61 7267 735f 6e6f 6e5f  re_all_args_non_
+0001beb0: 6469 6666 6572 656e 7469 6162 6c65 0a20  differentiable. 
+0001bec0: 2020 2020 2020 206f 7220 7379 6d62 6f6c         or symbol
+0001bed0: 2e61 7265 5f61 6c6c 5f61 7267 735f 636f  .are_all_args_co
+0001bee0: 6e73 7461 6e74 0a20 2020 2020 2020 206f  nstant.        o
+0001bef0: 7220 7379 6d62 6f6c 2e73 796d 2e69 6420  r symbol.sym.id 
+0001bf00: 696e 206e 6f6e 6469 6666 6572 656e 7469  in nondifferenti
+0001bf10: 6162 6c65 5f76 6a70 5f73 796d 626f 6c73  able_vjp_symbols
+0001bf20: 0a20 2020 2029 0a0a 0a64 6566 2076 6a70  .    )...def vjp
+0001bf30: 5f73 796d 626f 6c5f 6d61 7070 6572 2873  _symbol_mapper(s
+0001bf40: 796d 626f 6c3a 2070 7269 6d73 2e53 796d  ymbol: prims.Sym
+0001bf50: 626f 6c2c 202a 6172 6773 2c20 2a2a 6b77  bol, *args, **kw
+0001bf60: 6172 6773 293a 0a20 2020 2022 2222 5379  args):.    """Sy
+0001bf70: 6d62 6f6c 206d 6170 7065 7220 666f 7220  mbol mapper for 
+0001bf80: 7468 6520 564a 5020 7472 616e 7366 6f72  the VJP transfor
+0001bf90: 6d2e 0a0a 2020 2020 4172 6773 3a0a 2020  m...    Args:.  
+0001bfa0: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
+0001bfb0: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
+0001bfc0: 626f 6c20 746f 2062 6520 6d61 7070 6564  bol to be mapped
+0001bfd0: 2e0a 2020 2020 2020 2020 6172 6773 2028  ..        args (
+0001bfe0: 5475 706c 655b 5661 7269 6162 6c65 5d29  Tuple[Variable])
+0001bff0: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
+0001c000: 6865 2073 796d 626f 6c2e 0a20 2020 2020  he symbol..     
+0001c010: 2020 206b 7761 7267 7320 2844 6963 745b     kwargs (Dict[
+0001c020: 7374 722c 2056 6172 6961 626c 655d 293a  str, Variable]):
+0001c030: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
+0001c040: 7473 2074 6f20 7468 6520 7379 6d62 6f6c  ts to the symbol
+0001c050: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001c060: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+0001c070: 3a20 4120 6675 6e63 7469 6f6e 2074 6861  : A function tha
+0001c080: 7420 636f 6d70 7574 6573 2074 6865 2056  t computes the V
+0001c090: 4a50 206f 6620 7468 6520 7379 6d62 6f6c  JP of the symbol
+0001c0a0: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
+0001c0b0: 436f 6e73 7461 6e74 2063 6173 650a 2020  Constant case.  
+0001c0c0: 2020 6966 2069 735f 636f 6e73 7461 6e74    if is_constant
+0001c0d0: 5f66 6f72 5f76 6a70 2873 796d 626f 6c29  _for_vjp(symbol)
+0001c0e0: 3a0a 0a20 2020 2020 2020 2064 6566 2076  :..        def v
+0001c0f0: 6a70 5f69 6d70 6c5f 636f 6e73 7428 7379  jp_impl_const(sy
+0001c100: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
+0001c110: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0001c120: 2020 2020 6172 6773 2c20 6b77 6172 6773      args, kwargs
+0001c130: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
+0001c140: 6461 2078 3a20 782e 7072 696d 616c 2069  da x: x.primal i
+0001c150: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0001c160: 564a 5044 7561 6c29 2065 6c73 6520 782c  VJPDual) else x,
+0001c170: 2028 6172 6773 2c20 6b77 6172 6773 2929   (args, kwargs))
+0001c180: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0001c190: 6d61 6c73 203d 2073 796d 626f 6c5f 746f  mals = symbol_to
+0001c1a0: 5f65 7661 6c28 7379 6d62 6f6c 2928 2a61  _eval(symbol)(*a
+0001c1b0: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+0001c1c0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0001c1d0: 696e 7374 616e 6365 2870 7269 6d61 6c73  instance(primals
+0001c1e0: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
+0001c1f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001c200: 7572 6e20 7472 6565 5f6d 6170 286c 616d  urn tree_map(lam
+0001c210: 6264 6120 783a 2056 4a50 4475 616c 2878  bda x: VJPDual(x
+0001c220: 2c20 7475 706c 6528 2929 2c20 7072 696d  , tuple()), prim
+0001c230: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
+0001c240: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+0001c250: 7072 696d 616c 732c 2074 7570 6c65 2829  primals, tuple()
+0001c260: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0001c270: 6e20 7061 7274 6961 6c28 766a 705f 696d  n partial(vjp_im
+0001c280: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
+0001c290: 290a 0a20 2020 2023 204e 6f72 6d61 6c20  )..    # Normal 
+0001c2a0: 6361 7365 2c20 7765 2068 6176 6520 6120  case, we have a 
+0001c2b0: 7072 6f78 7920 7461 6e67 656e 740a 2020  proxy tangent.  
+0001c2c0: 2020 766a 705f 696d 706c 203d 2061 7567    vjp_impl = aug
+0001c2d0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
+0001c2e0: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
+0001c2f0: 7379 6d2e 6964 290a 0a20 2020 2069 6620  sym.id)..    if 
+0001c300: 5f67 6574 5f67 7261 6466 6e5f 616e 645f  _get_gradfn_and_
+0001c310: 6578 6563 7574 6f72 2873 796d 626f 6c29  executor(symbol)
+0001c320: 5b30 5d20 6973 206e 6f74 204e 6f6e 653a  [0] is not None:
+0001c330: 0a20 2020 2020 2020 2076 6a70 5f69 6d70  .        vjp_imp
+0001c340: 6c2c 2062 6163 6b77 6172 645f 666e 203d  l, backward_fn =
+0001c350: 206d 616b 655f 6175 675f 666f 7277 6172   make_aug_forwar
+0001c360: 645f 616e 645f 6261 636b 7761 7264 2873  d_and_backward(s
+0001c370: 796d 626f 6c29 0a0a 2020 2020 6966 2076  ymbol)..    if v
+0001c380: 6a70 5f69 6d70 6c20 6973 204e 6f6e 653a  jp_impl is None:
+0001c390: 0a20 2020 2020 2020 2023 2057 6520 636f  .        # We co
+0001c3a0: 756c 6420 6e6f 7420 6669 6e64 2061 2056  uld not find a V
+0001c3b0: 4a50 2066 6f72 2074 6869 7320 7379 6d62  JP for this symb
+0001c3c0: 6f6c 2c20 736f 2077 6520 7472 7920 746f  ol, so we try to
+0001c3d0: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
+0001c3e0: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
+0001c3f0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
+0001c400: 3e20 3020 616e 6420 6e6f 7420 6973 696e  > 0 and not isin
+0001c410: 7374 616e 6365 2873 796d 626f 6c2e 7379  stance(symbol.sy
+0001c420: 6d2e 6964 2c20 7072 696d 732e 5072 696d  m.id, prims.Prim
+0001c430: 4944 7329 3a0a 2020 2020 2020 2020 2020  IDs):.          
+0001c440: 2020 766a 705f 696d 706c 203d 2070 6172    vjp_impl = par
+0001c450: 7469 616c 2864 6563 6f6d 706f 7365 645f  tial(decomposed_
+0001c460: 666e 5f61 7567 5f66 7764 5f72 756c 652c  fn_aug_fwd_rule,
+0001c470: 2064 6563 6f6d 706f 7365 645f 666e 3d73   decomposed_fn=s
+0001c480: 796d 626f 6c2e 7379 6d29 0a20 2020 2020  ymbol.sym).     
+0001c490: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001c4a0: 2020 2020 2023 2057 6520 636f 756c 6420       # We could 
+0001c4b0: 6e6f 7420 6669 6e64 2061 2056 4a50 2066  not find a VJP f
+0001c4c0: 6f72 2074 6869 7320 7379 6d62 6f6c 2061  or this symbol a
+0001c4d0: 6e64 2077 6520 636f 756c 6420 6e6f 7420  nd we could not 
+0001c4e0: 6465 636f 6d70 6f73 6520 6974 0a20 2020  decompose it.   
+0001c4f0: 2020 2020 2020 2020 2023 2049 7420 636f           # It co
+0001c500: 756c 6420 6265 2061 2074 6f72 6368 2e64  uld be a torch.d
+0001c510: 726f 706f 7574 2077 6974 6820 302e 3020  ropout with 0.0 
+0001c520: 7072 6f62 6162 696c 6974 792c 2073 6f20  probability, so 
+0001c530: 7765 2073 6b69 7020 6974 0a20 2020 2020  we skip it.     
+0001c540: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
+0001c550: 2e73 796d 2e69 6420 3d3d 2022 746f 7263  .sym.id == "torc
+0001c560: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
+0001c570: 6472 6f70 6f75 7422 3a0a 2020 2020 2020  dropout":.      
+0001c580: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001c590: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0001c5a0: 2020 7072 696e 7428 6622 564a 5020 666f    print(f"VJP fo
+0001c5b0: 7220 7b73 796d 626f 6c7d 2069 7320 6e6f  r {symbol} is no
+0001c5c0: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
+0001c5d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c5e0: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+0001c5f0: 4572 726f 7228 6622 564a 5020 666f 7220  Error(f"VJP for 
+0001c600: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
+0001c610: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+0001c620: 6564 2229 0a0a 2020 2020 6465 6620 5f76  ed")..    def _v
+0001c630: 6a70 5f69 6d70 6c28 2a61 7267 732c 202a  jp_impl(*args, *
+0001c640: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0001c650: 2020 7072 696d 616c 732c 206b 7761 7267    primals, kwarg
+0001c660: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
+0001c670: 6264 6120 783a 2078 2e70 7269 6d61 6c20  bda x: x.primal 
+0001c680: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001c690: 2056 4a50 4475 616c 2920 656c 7365 2078   VJPDual) else x
+0001c6a0: 2c20 2861 7267 732c 206b 7761 7267 7329  , (args, kwargs)
+0001c6b0: 290a 2020 2020 2020 2020 6f75 745f 7072  ).        out_pr
+0001c6c0: 696d 616c 2c20 6f75 745f 7265 7369 6475  imal, out_residu
+0001c6d0: 616c 7320 3d20 766a 705f 696d 706c 282a  als = vjp_impl(*
+0001c6e0: 7072 696d 616c 732c 202a 2a6b 7761 7267  primals, **kwarg
+0001c6f0: 7329 0a0a 2020 2020 2020 2020 2320 5765  s)..        # We
+0001c700: 2061 7265 2073 6176 696e 6720 7468 6520   are saving the 
+0001c710: 7265 7369 6475 616c 7320 616e 6420 7075  residuals and pu
+0001c720: 6c6c 6261 636b 206f 6e6c 7920 696e 2074  llback only in t
+0001c730: 6865 2066 6972 7374 206f 7574 7075 740a  he first output.
+0001c740: 2020 2020 2020 2020 2320 6261 636b 7761          # backwa
+0001c750: 7264 5f70 6173 7320 7468 656e 2072 6574  rd_pass then ret
+0001c760: 7269 6576 6573 2074 6865 2072 6573 6964  rieves the resid
+0001c770: 7561 6c73 2061 6e64 2070 756c 6c62 6163  uals and pullbac
+0001c780: 6b20 6672 6f6d 2074 6865 2066 6972 7374  k from the first
+0001c790: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0001c7a0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+0001c7b0: 745f 7072 696d 616c 2c20 5365 7175 656e  t_primal, Sequen
+0001c7c0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
+0001c7d0: 2072 6574 7572 6e20 2856 4a50 4475 616c   return (VJPDual
+0001c7e0: 286f 7574 5f70 7269 6d61 6c5b 305d 2c20  (out_primal[0], 
+0001c7f0: 6f75 745f 7265 7369 6475 616c 7329 2c20  out_residuals), 
+0001c800: 2a28 564a 5044 7561 6c28 6f2c 2074 7570  *(VJPDual(o, tup
+0001c810: 6c65 2829 2920 666f 7220 6f20 696e 206f  le()) for o in o
+0001c820: 7574 5f70 7269 6d61 6c5b 313a 5d29 290a  ut_primal[1:])).
+0001c830: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001c840: 2856 4a50 4475 616c 286f 7574 5f70 7269  (VJPDual(out_pri
+0001c850: 6d61 6c2c 206f 7574 5f72 6573 6964 7561  mal, out_residua
+0001c860: 6c73 292c 290a 0a20 2020 2072 6574 7572  ls),)..    retur
+0001c870: 6e20 5f76 6a70 5f69 6d70 6c0a 0a0a 6465  n _vjp_impl...de
+0001c880: 6620 6368 6563 6b5f 6273 796d 5f66 6f72  f check_bsym_for
+0001c890: 5f76 6a70 2862 7379 6d29 3a0a 2020 2020  _vjp(bsym):.    
+0001c8a0: 2222 220a 2020 2020 4368 6563 6b20 6966  """.    Check if
+0001c8b0: 2061 2062 6f75 6e64 2073 796d 626f 6c20   a bound symbol 
+0001c8c0: 6973 2073 7570 706f 7274 6564 2062 7920  is supported by 
+0001c8d0: 766a 702e 0a0a 2020 2020 4172 6773 3a0a  vjp...    Args:.
+0001c8e0: 2020 2020 2020 2020 6273 796d 2028 426f          bsym (Bo
+0001c8f0: 756e 6453 796d 626f 6c29 3a20 5468 6520  undSymbol): The 
+0001c900: 626f 756e 6420 7379 6d62 6f6c 2074 6f20  bound symbol to 
+0001c910: 6368 6563 6b2e 0a0a 2020 2020 5265 7475  check...    Retu
+0001c920: 726e 733a 0a20 2020 2020 2020 2062 6f6f  rns:.        boo
+0001c930: 6c3a 2054 7275 6520 6966 2074 6865 2062  l: True if the b
+0001c940: 6f75 6e64 2073 796d 626f 6c20 6973 2073  ound symbol is s
+0001c950: 7570 706f 7274 6564 2062 7920 766a 702c  upported by vjp,
+0001c960: 2046 616c 7365 206f 7468 6572 7769 7365   False otherwise
+0001c970: 2e0a 2020 2020 2222 220a 0a20 2020 2069  ..    """..    i
+0001c980: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
+0001c990: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
+0001c9a0: 6c69 7374 3a0a 2020 2020 2020 2020 7265  list:.        re
+0001c9b0: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
+0001c9c0: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
+0001c9d0: 2062 6163 6b77 6172 645f 696d 706c 7320   backward_impls 
+0001c9e0: 616e 6420 6273 796d 2e73 796d 2e69 6420  and bsym.sym.id 
+0001c9f0: 696e 2061 7567 6d65 6e74 6564 5f66 6f72  in augmented_for
+0001ca00: 7761 7264 5f69 6d70 6c73 3a0a 2020 2020  ward_impls:.    
+0001ca10: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0001ca20: 0a20 2020 2069 6620 6273 796d 2e73 796d  .    if bsym.sym
+0001ca30: 2e69 6420 696e 205f 6772 6164 5f66 6e5f  .id in _grad_fn_
+0001ca40: 6d61 703a 0a20 2020 2020 2020 2072 6574  map:.        ret
+0001ca50: 7572 6e20 5472 7565 0a0a 2020 2020 2320  urn True..    # 
+0001ca60: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
+0001ca70: 6420 6120 564a 5020 666f 7220 7468 6973  d a VJP for this
+0001ca80: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
+0001ca90: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
+0001caa0: 6974 0a20 2020 2023 2069 6e74 6f20 7375  it.    # into su
+0001cab0: 622d 7379 6d62 6f6c 7320 616e 6420 6368  b-symbols and ch
+0001cac0: 6563 6b20 6966 2074 6865 7920 6172 6520  eck if they are 
+0001cad0: 7375 7070 6f72 7465 640a 2020 2020 6966  supported.    if
+0001cae0: 206c 656e 2862 7379 6d2e 7375 6273 796d   len(bsym.subsym
+0001caf0: 626f 6c73 2920 3e20 3020 616e 6420 6e6f  bols) > 0 and no
+0001cb00: 7420 6273 796d 2e73 796d 2e69 735f 7072  t bsym.sym.is_pr
+0001cb10: 696d 3a0a 2020 2020 2020 2020 7375 6274  im:.        subt
+0001cb20: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
+0001cb30: 5f74 7261 6365 2829 2862 7379 6d2e 7379  _trace()(bsym.sy
+0001cb40: 6d2c 202a 6273 796d 2e61 7267 732c 202a  m, *bsym.args, *
+0001cb50: 2a62 7379 6d2e 6b77 6172 6773 290a 2020  *bsym.kwargs).  
+0001cb60: 2020 2020 2020 7375 6274 7261 6365 203d        subtrace =
+0001cb70: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
+0001cb80: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
+0001cb90: 7375 6274 7261 6365 290a 2020 2020 2020  subtrace).      
+0001cba0: 2020 616c 6c5f 7375 7070 6f72 7465 6420    all_supported 
+0001cbb0: 3d20 616c 6c28 6368 6563 6b5f 6273 796d  = all(check_bsym
+0001cbc0: 5f66 6f72 5f76 6a70 2873 7562 6273 796d  _for_vjp(subbsym
+0001cbd0: 2920 666f 7220 7375 6262 7379 6d20 696e  ) for subbsym in
+0001cbe0: 2073 7562 7472 6163 652e 626f 756e 645f   subtrace.bound_
+0001cbf0: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
+0001cc00: 2072 6574 7572 6e20 616c 6c5f 7375 7070   return all_supp
+0001cc10: 6f72 7465 640a 0a20 2020 2072 6574 7572  orted..    retur
+0001cc20: 6e20 4661 6c73 650a 0a0a 6465 6620 6175  n False...def au
+0001cc30: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+0001cc40: 7061 7373 282a 6172 6773 2c20 7472 6163  pass(*args, trac
+0001cc50: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
+0001cc60: 6773 293a 0a20 2020 2022 2222 4175 676d  gs):.    """Augm
+0001cc70: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
+0001cc80: 7373 2066 6f72 2074 6865 2056 4a50 2074  ss for the VJP t
+0001cc90: 7261 6e73 666f 726d 2e0a 0a20 2020 2054  ransform...    T
+0001cca0: 6865 2061 7567 6d65 6e74 6564 2066 6f72  he augmented for
+0001ccb0: 7761 7264 2070 6173 7320 6973 2061 2066  ward pass is a f
+0001ccc0: 6f72 7761 7264 2070 6173 7320 7468 6174  orward pass that
+0001ccd0: 2072 6574 7572 6e73 2074 6865 2072 6573   returns the res
+0001cce0: 6964 7561 6c73 0a20 2020 206f 6620 7468  iduals.    of th
+0001ccf0: 6520 666f 7277 6172 6420 7061 7373 2e0a  e forward pass..
+0001cd00: 2020 2020 5468 6573 6520 7265 7369 6475      These residu
+0001cd10: 616c 7320 6172 6520 7573 6564 2069 6e20  als are used in 
+0001cd20: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+0001cd30: 7320 746f 2063 6f6d 7075 7465 2074 6865  s to compute the
+0001cd40: 2056 4a50 2061 6e64 2074 6865 790a 2020   VJP and they.  
+0001cd50: 2020 6172 6520 7265 636f 7264 6564 2069    are recorded i
+0001cd60: 6e20 7468 6520 656e 7669 726f 6e6d 656e  n the environmen
+0001cd70: 7420 6469 6374 696f 6e61 7279 2066 6f72  t dictionary for
+0001cd80: 2065 6163 6820 7661 7269 6162 6c65 2e0a   each variable..
+0001cd90: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001cda0: 2020 2061 7267 7320 2854 7570 6c65 5b56     args (Tuple[V
+0001cdb0: 6172 6961 626c 655d 293a 2041 7267 756d  ariable]): Argum
+0001cdc0: 656e 7473 2074 6f20 7468 6520 6675 6e63  ents to the func
+0001cdd0: 7469 6f6e 2e0a 2020 2020 2020 2020 7472  tion..        tr
+0001cde0: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
+0001cdf0: 6365 206f 6620 7468 6520 6675 6e63 7469  ce of the functi
+0001ce00: 6f6e 2e0a 2020 2020 2020 2020 6b77 6172  on..        kwar
+0001ce10: 6773 2028 4469 6374 5b73 7472 2c20 5661  gs (Dict[str, Va
+0001ce20: 7269 6162 6c65 5d29 3a20 4b65 7977 6f72  riable]): Keywor
+0001ce30: 6420 6172 6775 6d65 6e74 7320 746f 2074  d arguments to t
+0001ce40: 6865 2066 756e 6374 696f 6e2e 0a0a 2020  he function...  
+0001ce50: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0001ce60: 2020 2054 7570 6c65 5b41 6e79 2c20 4469     Tuple[Any, Di
+0001ce70: 6374 5b73 7472 2c20 416e 795d 5d3a 2054  ct[str, Any]]: T
+0001ce80: 7570 6c65 206f 6620 7468 6520 7072 696d  uple of the prim
+0001ce90: 616c 206f 7574 7075 7473 2061 6e64 2074  al outputs and t
+0001cea0: 6865 2065 6e76 6972 6f6e 6d65 6e74 2e0a  he environment..
+0001ceb0: 2020 2020 2222 220a 2020 2020 6172 6773      """.    args
+0001cec0: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
+0001ced0: 6d61 7028 6c61 6d62 6461 2078 3a20 564a  map(lambda x: VJ
+0001cee0: 5044 7561 6c28 782c 2074 7570 6c65 2829  PDual(x, tuple()
+0001cef0: 292c 2028 6172 6773 2c20 6b77 6172 6773  ), (args, kwargs
+0001cf00: 2929 0a20 2020 2072 6573 756c 742c 2065  )).    result, e
+0001cf10: 6e76 203d 2065 7661 6c5f 7472 6163 6528  nv = eval_trace(
+0001cf20: 0a20 2020 2020 2020 2074 7261 6365 2c0a  .        trace,.
+0001cf30: 2020 2020 2020 2020 2a61 7267 732c 0a20          *args,. 
+0001cf40: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0001cf50: 0a20 2020 2020 2020 2077 6974 685f 656e  .        with_en
+0001cf60: 763d 5472 7565 2c0a 2020 2020 2020 2020  v=True,.        
+0001cf70: 7379 6d62 6f6c 5f6d 6170 7065 723d 766a  symbol_mapper=vj
+0001cf80: 705f 7379 6d62 6f6c 5f6d 6170 7065 722c  p_symbol_mapper,
+0001cf90: 0a20 2020 2029 0a20 2020 2072 6573 756c  .    ).    resul
+0001cfa0: 7420 3d20 7472 6565 5f6d 6170 286c 616d  t = tree_map(lam
+0001cfb0: 6264 6120 783a 2078 2e70 7269 6d61 6c20  bda x: x.primal 
+0001cfc0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001cfd0: 2056 4a50 4475 616c 2920 656c 7365 2078   VJPDual) else x
+0001cfe0: 2c20 7265 7375 6c74 290a 2020 2020 7265  , result).    re
+0001cff0: 7475 726e 2072 6573 756c 742c 2065 6e76  turn result, env
+0001d000: 0a0a 0a23 2054 4f44 4f3a 2049 6e73 7465  ...# TODO: Inste
+0001d010: 6164 206f 6620 7573 696e 6720 7468 6520  ad of using the 
+0001d020: 656e 7669 726f 6e6d 656e 7420 6469 6374  environment dict
+0001d030: 696f 6e61 7279 2c20 7765 2063 6f75 6c64  ionary, we could
+0001d040: 2075 7365 2074 6865 2074 7261 6365 0a23   use the trace.#
+0001d050: 2073 796d 626f 6c73 206f 7264 6572 2028   symbols order (
+0001d060: 7468 6174 2073 686f 756c 6420 6265 2064  that should be d
+0001d070: 6574 6572 6d69 6e69 7374 6963 2920 746f  eterministic) to
+0001d080: 2072 6574 7269 6576 6520 7468 6520 7265   retrieve the re
+0001d090: 7369 6475 616c 7320 6e65 6564 6564 0a23  siduals needed.#
+0001d0a0: 2066 6f72 2074 6865 2062 6163 6b77 6172   for the backwar
+0001d0b0: 6420 7061 7373 2e0a 6465 6620 6261 636b  d pass..def back
+0001d0c0: 7761 7264 5f70 6173 7328 666f 7277 6172  ward_pass(forwar
+0001d0d0: 645f 656e 762c 2074 7261 6365 2c20 696e  d_env, trace, in
+0001d0e0: 6974 5f63 6f74 616e 6765 6e74 7329 3a0a  it_cotangents):.
+0001d0f0: 2020 2020 2222 2242 6163 6b77 6172 6420      """Backward 
+0001d100: 7061 7373 2066 6f72 2074 6865 2056 4a50  pass for the VJP
+0001d110: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
+0001d120: 2054 6865 2062 6163 6b77 6172 6420 7061   The backward pa
+0001d130: 7373 2069 7320 6120 7265 7665 7273 6520  ss is a reverse 
+0001d140: 6d6f 6465 2061 7574 6f6d 6174 6963 2064  mode automatic d
+0001d150: 6966 6665 7265 6e74 6961 7469 6f6e 2070  ifferentiation p
+0001d160: 6173 7320 7468 6174 0a20 2020 2063 6f6d  ass that.    com
+0001d170: 7075 7465 7320 7468 6520 7665 6374 6f72  putes the vector
+0001d180: 2d4a 6163 6f62 6961 6e20 7072 6f64 7563  -Jacobian produc
+0001d190: 7420 2856 4a50 2920 6f66 2074 6865 2066  t (VJP) of the f
+0001d1a0: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
+0001d1b0: 6773 3a0a 2020 2020 2020 2020 666f 7277  gs:.        forw
+0001d1c0: 6172 645f 656e 7620 2844 6963 745b 7374  ard_env (Dict[st
+0001d1d0: 722c 2041 6e79 5d29 3a20 456e 7669 726f  r, Any]): Enviro
+0001d1e0: 6e6d 656e 7420 6f66 2074 6865 2066 6f72  nment of the for
+0001d1f0: 7761 7264 2070 6173 732e 0a20 2020 2020  ward pass..     
+0001d200: 2020 2074 7261 6365 2028 5472 6163 6529     trace (Trace)
+0001d210: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
+0001d220: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
+0001d230: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
+0001d240: 2028 5475 706c 655b 5661 7269 6162 6c65   (Tuple[Variable
+0001d250: 5d29 3a20 496e 6974 6961 6c20 636f 7461  ]): Initial cota
+0001d260: 6e67 656e 7473 2e0a 0a20 2020 2052 6574  ngents...    Ret
+0001d270: 7572 6e73 3a0a 2020 2020 2020 2020 5475  urns:.        Tu
+0001d280: 706c 655b 5072 6f78 792c 202e 2e2e 5d3a  ple[Proxy, ...]:
+0001d290: 2054 7570 6c65 206f 6620 7468 6520 7265   Tuple of the re
+0001d2a0: 7375 6c74 7320 6f66 2074 6865 2062 6163  sults of the bac
+0001d2b0: 6b77 6172 6420 7061 7373 2066 6f72 2065  kward pass for e
+0001d2c0: 6163 6820 696e 7075 742e 0a20 2020 2022  ach input..    "
+0001d2d0: 2222 0a20 2020 2065 6e76 203d 207b 7d0a  "".    env = {}.
+0001d2e0: 0a20 2020 2064 6566 2067 6574 5f67 7261  .    def get_gra
+0001d2f0: 6428 783a 2056 6172 6961 626c 6529 3a0a  d(x: Variable):.
+0001d300: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001d310: 7461 6e63 6528 782c 2056 6172 6961 626c  tance(x, Variabl
+0001d320: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001d330: 2320 5265 7475 726e 204e 6f6e 6520 6966  # Return None if
+0001d340: 2074 6865 2076 6172 6961 626c 6520 7761   the variable wa
+0001d350: 7320 6e6f 7420 7573 6564 2069 6e20 7468  s not used in th
+0001d360: 6520 636f 6d70 7574 6174 696f 6e20 616e  e computation an
+0001d370: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+0001d380: 6865 6e63 6520 6e6f 7420 696e 2074 6865  hence not in the
+0001d390: 2065 6e76 0a20 2020 2020 2020 2020 2020   env.           
+0001d3a0: 2072 6574 7572 6e20 656e 762e 6765 7428   return env.get(
+0001d3b0: 782e 6e61 6d65 2c20 4e6f 6e65 290a 2020  x.name, None).  
+0001d3c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001d3d0: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+0001d3e0: 0a0a 2020 2020 6465 6620 7075 745f 6772  ..    def put_gr
+0001d3f0: 6164 2876 3a20 5661 7269 6162 6c65 2c20  ad(v: Variable, 
+0001d400: 7661 6c3a 2041 6e79 2920 2d3e 204e 6f6e  val: Any) -> Non
+0001d410: 653a 0a20 2020 2020 2020 2069 6620 6973  e:.        if is
+0001d420: 696e 7374 616e 6365 2876 2c20 5661 7269  instance(v, Vari
+0001d430: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
+0001d440: 2020 2069 6620 762e 6e61 6d65 2069 6e20     if v.name in 
+0001d450: 656e 763a 0a20 2020 2020 2020 2020 2020  env:.           
+0001d460: 2020 2020 2069 6620 7661 6c20 6973 204e       if val is N
+0001d470: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001d480: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4a0: 2320 4163 6375 6d75 6c61 7465 2063 6f74  # Accumulate cot
+0001d4b0: 616e 6765 6e74 730a 2020 2020 2020 2020  angents.        
+0001d4c0: 2020 2020 2020 2020 656e 765b 762e 6e61          env[v.na
+0001d4d0: 6d65 5d20 3d20 636c 616e 672e 6164 6428  me] = clang.add(
+0001d4e0: 656e 765b 762e 6e61 6d65 5d2c 2076 616c  env[v.name], val
+0001d4f0: 2920 6966 2065 6e76 5b76 2e6e 616d 655d  ) if env[v.name]
+0001d500: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+0001d510: 6520 7661 6c0a 2020 2020 2020 2020 2020  e val.          
+0001d520: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0001d530: 2020 2020 2020 2020 2065 6e76 5b76 2e6e           env[v.n
+0001d540: 616d 655d 203d 2076 616c 0a20 2020 2020  ame] = val.     
+0001d550: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0001d560: 6365 2876 2c20 5365 7175 656e 6365 2920  ce(v, Sequence) 
+0001d570: 616e 6420 616c 6c28 6973 696e 7374 616e  and all(isinstan
+0001d580: 6365 2878 2c20 696e 7429 2066 6f72 2078  ce(x, int) for x
+0001d590: 2069 6e20 7629 3a0a 2020 2020 2020 2020   in v):.        
+0001d5a0: 2020 2020 2320 544f 444f 3a20 7265 6d6f      # TODO: remo
+0001d5b0: 7665 2077 6865 6e20 7765 206d 6f76 6520  ve when we move 
+0001d5c0: 6469 6d73 2074 6f20 6b77 6172 6773 0a20  dims to kwargs. 
+0001d5d0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0001d5e0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+0001d5f0: 6e73 7461 6e63 6528 762c 2073 7472 293a  nstance(v, str):
+0001d600: 0a20 2020 2020 2020 2020 2020 2065 6e76  .            env
+0001d610: 5b76 5d20 3d20 7661 6c0a 2020 2020 2020  [v] = val.      
+0001d620: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001d630: 6528 762c 2053 6571 7565 6e63 6529 2061  e(v, Sequence) a
+0001d640: 6e64 2076 616c 2069 7320 4e6f 6e65 3a0a  nd val is None:.
+0001d650: 2020 2020 2020 2020 2020 2020 2320 6272              # br
+0001d660: 6f61 6463 6173 7420 4e6f 6e65 2074 6f20  oadcast None to 
+0001d670: 7468 6520 7269 6768 7420 7368 6170 650a  the right shape.
+0001d680: 2020 2020 2020 2020 2020 2020 7361 6665              safe
+0001d690: 5f6d 6170 2870 7574 5f67 7261 642c 2076  _map(put_grad, v
+0001d6a0: 2c20 5b4e 6f6e 655d 202a 206c 656e 2876  , [None] * len(v
+0001d6b0: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
+0001d6c0: 6973 696e 7374 616e 6365 2876 2c20 5365  isinstance(v, Se
+0001d6d0: 7175 656e 6365 2920 616e 6420 6973 696e  quence) and isin
+0001d6e0: 7374 616e 6365 2876 616c 2c20 5365 7175  stance(val, Sequ
+0001d6f0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+0001d700: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
+0001d710: 2870 7574 5f67 7261 642c 2076 2c20 7661  (put_grad, v, va
+0001d720: 6c29 0a20 2020 2020 2020 2065 6c73 653a  l).        else:
+0001d730: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0001d740: 6b69 7020 7772 6974 696e 6720 746f 2063  kip writing to c
+0001d750: 6f6e 7374 616e 7473 0a20 2020 2020 2020  onstants.       
+0001d760: 2020 2020 2070 6173 730a 0a20 2020 2069       pass..    i
+0001d770: 6620 6973 696e 7374 616e 6365 2869 6e69  f isinstance(ini
+0001d780: 745f 636f 7461 6e67 656e 7473 2c20 5365  t_cotangents, Se
+0001d790: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
+0001d7a0: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
+0001d7b0: 203d 3d20 3120 616e 6420 6e6f 7420 6973   == 1 and not is
+0001d7c0: 696e 7374 616e 6365 2874 7261 6365 2e6f  instance(trace.o
+0001d7d0: 7574 7075 742c 2053 6571 7565 6e63 6529  utput, Sequence)
+0001d7e0: 3a0a 2020 2020 2020 2020 696e 6974 5f63  :.        init_c
+0001d7f0: 6f74 616e 6765 6e74 7320 3d20 696e 6974  otangents = init
+0001d800: 5f63 6f74 616e 6765 6e74 735b 305d 0a20  _cotangents[0]. 
+0001d810: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
+0001d820: 2870 7574 5f67 7261 642c 2074 7261 6365  (put_grad, trace
+0001d830: 2e6f 7574 7075 742c 2069 6e69 745f 636f  .output, init_co
+0001d840: 7461 6e67 656e 7473 290a 0a20 2020 2066  tangents)..    f
+0001d850: 6f72 2073 796d 626f 6c20 696e 2072 6576  or symbol in rev
+0001d860: 6572 7365 6428 6c69 7374 2869 7465 725f  ersed(list(iter_
+0001d870: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
+0001d880: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001d890: 7329 2929 3a0a 2020 2020 2020 2020 7379  s))):.        sy
+0001d8a0: 6d62 6f6c 5f6f 7574 7075 7420 3d20 7365  mbol_output = se
+0001d8b0: 7175 656e 6369 6679 2873 796d 626f 6c2e  quencify(symbol.
+0001d8c0: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
+0001d8d0: 2063 6f74 616e 6765 6e74 7320 3d20 7472   cotangents = tr
+0001d8e0: 6565 5f6d 6170 2867 6574 5f67 7261 642c  ee_map(get_grad,
+0001d8f0: 2073 796d 626f 6c5f 6f75 7470 7574 290a   symbol_output).
+0001d900: 2020 2020 2020 2020 2320 4861 7669 6e67          # Having
+0001d910: 2061 2073 696e 676c 6520 636f 7461 6e67   a single cotang
+0001d920: 656e 7420 6973 2061 2063 6f6d 6d6f 6e20  ent is a common 
+0001d930: 6361 7365 2c20 736f 2077 6520 666c 6174  case, so we flat
+0001d940: 7465 6e20 6974 0a20 2020 2020 2020 2023  ten it.        #
+0001d950: 204f 7468 6572 7769 7365 2c20 7765 2077   Otherwise, we w
+0001d960: 696c 6c20 6e65 6564 2074 6f20 7265 7772  ill need to rewr
+0001d970: 6974 6520 7468 6520 7075 6c6c 6261 636b  ite the pullback
+0001d980: 2066 756e 6374 696f 6e73 0a20 2020 2020   functions.     
+0001d990: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
+0001d9a0: 7472 6565 5f66 6c61 7474 656e 2863 6f74  tree_flatten(cot
+0001d9b0: 616e 6765 6e74 7329 5b30 5d0a 2020 2020  angents)[0].    
+0001d9c0: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
+0001d9d0: 666f 7277 6172 645f 656e 765b 7379 6d62  forward_env[symb
+0001d9e0: 6f6c 5f6f 7574 7075 745b 305d 2e6e 616d  ol_output[0].nam
+0001d9f0: 655d 2e72 6573 6964 7561 6c73 0a20 2020  e].residuals.   
+0001da00: 2020 2020 2069 6620 6973 5f63 6f6e 7374       if is_const
+0001da10: 616e 745f 666f 725f 766a 7028 7379 6d62  ant_for_vjp(symb
+0001da20: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
+0001da30: 2023 2057 6520 6361 6e20 736b 6970 2074   # We can skip t
+0001da40: 6865 2070 756c 6c62 6163 6b20 6966 2061  he pullback if a
+0001da50: 6c6c 2074 6865 2061 7267 756d 656e 7473  ll the arguments
+0001da60: 2061 7265 2063 6f6e 7374 616e 740a 2020   are constant.  
+0001da70: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001da80: 7565 0a0a 2020 2020 2020 2020 6966 2061  ue..        if a
+0001da90: 6c6c 2863 6f74 616e 6765 6e74 2069 7320  ll(cotangent is 
+0001daa0: 4e6f 6e65 2066 6f72 2063 6f74 616e 6765  None for cotange
+0001dab0: 6e74 2069 6e20 636f 7461 6e67 656e 7473  nt in cotangents
+0001dac0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001dad0: 2057 6520 6361 6e20 736b 6970 2074 6865   We can skip the
+0001dae0: 2070 756c 6c62 6163 6b20 6966 2074 6865   pullback if the
+0001daf0: 2063 6f74 616e 6765 6e74 2069 7320 4e6f   cotangent is No
+0001db00: 6e65 0a20 2020 2020 2020 2020 2020 2073  ne.            s
+0001db10: 6166 655f 6d61 7028 7075 745f 6772 6164  afe_map(put_grad
+0001db20: 2c20 7379 6d62 6f6c 2e61 7267 732c 2028  , symbol.args, (
+0001db30: 4e6f 6e65 2c29 202a 206c 656e 2873 796d  None,) * len(sym
+0001db40: 626f 6c2e 6172 6773 2929 0a20 2020 2020  bol.args)).     
+0001db50: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0001db60: 0a20 2020 2020 2020 2069 6620 7379 6d62  .        if symb
+0001db70: 6f6c 2e73 796d 2e69 6420 3d3d 2022 746f  ol.sym.id == "to
+0001db80: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+0001db90: 6c2e 6472 6f70 6f75 7422 2061 6e64 206e  l.dropout" and n
+0001dba0: 6f74 2073 796d 626f 6c2e 7375 6273 796d  ot symbol.subsym
+0001dbb0: 626f 6c73 3a0a 2020 2020 2020 2020 2020  bols:.          
+0001dbc0: 2020 2320 5765 2063 616e 2073 6b69 7020    # We can skip 
+0001dbd0: 7468 6520 7075 6c6c 6261 636b 2069 6620  the pullback if 
+0001dbe0: 7468 6520 6472 6f70 6f75 7420 7072 6f62  the dropout prob
+0001dbf0: 6162 696c 6974 7920 6973 2030 2e30 0a20  ability is 0.0. 
+0001dc00: 2020 2020 2020 2020 2020 2023 2041 7373             # Ass
+0001dc10: 756d 696e 6720 7468 6174 2074 6865 2064  uming that the d
+0001dc20: 726f 706f 7574 2073 796d 626f 6c20 6861  ropout symbol ha
+0001dc30: 7320 7468 6520 7361 6d65 206f 7574 7075  s the same outpu
+0001dc40: 7420 616e 6420 6172 6775 6d65 6e74 0a20  t and argument. 
+0001dc50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001dc60: 7420 7379 6d62 6f6c 2e6f 7574 7075 742e  t symbol.output.
+0001dc70: 6e61 6d65 203d 3d20 7379 6d62 6f6c 2e61  name == symbol.a
+0001dc80: 7267 735b 305d 2e6e 616d 652c 2022 4472  rgs[0].name, "Dr
+0001dc90: 6f70 6f75 7420 7379 6d62 6f6c 2068 6173  opout symbol has
+0001dca0: 2061 2064 6966 6665 7265 6e74 206f 7574   a different out
+0001dcb0: 7075 7420 616e 6420 6172 6775 6d65 6e74  put and argument
+0001dcc0: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
+0001dcd0: 2073 796d 626f 6c2e 6172 6773 5b31 5d20   symbol.args[1] 
+0001dce0: 3d3d 2030 2e30 206f 7220 7379 6d62 6f6c  == 0.0 or symbol
+0001dcf0: 2e61 7267 735b 325d 2069 7320 4661 6c73  .args[2] is Fals
+0001dd00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001dd10: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+0001dd20: 2020 2020 2062 6163 6b77 6172 6420 3d20       backward = 
+0001dd30: 6261 636b 7761 7264 5f69 6d70 6c73 2e67  backward_impls.g
+0001dd40: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
+0001dd50: 290a 2020 2020 2020 2020 6175 675f 666f  ).        aug_fo
+0001dd60: 7277 6172 6420 3d20 6175 676d 656e 7465  rward = augmente
+0001dd70: 645f 666f 7277 6172 645f 696d 706c 732e  d_forward_impls.
+0001dd80: 6765 7428 7379 6d62 6f6c 2e73 796d 2e69  get(symbol.sym.i
+0001dd90: 6429 0a0a 2020 2020 2020 2020 6966 205f  d)..        if _
+0001dda0: 6765 745f 6772 6164 666e 5f61 6e64 5f65  get_gradfn_and_e
+0001ddb0: 7865 6375 746f 7228 7379 6d62 6f6c 295b  xecutor(symbol)[
+0001ddc0: 305d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  0] is not None:.
+0001ddd0: 2020 2020 2020 2020 2020 2020 6175 675f              aug_
+0001dde0: 666f 7277 6172 642c 2062 6163 6b77 6172  forward, backwar
+0001ddf0: 6420 3d20 6d61 6b65 5f61 7567 5f66 6f72  d = make_aug_for
+0001de00: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
+0001de10: 6428 7379 6d62 6f6c 290a 0a20 2020 2020  d(symbol)..     
+0001de20: 2020 2069 6620 6261 636b 7761 7264 2069     if backward i
+0001de30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001de40: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
+0001de50: 6c2e 7375 6273 796d 626f 6c73 2920 3e20  l.subsymbols) > 
+0001de60: 3020 616e 6420 6e6f 7420 6973 696e 7374  0 and not isinst
+0001de70: 616e 6365 2873 796d 626f 6c2e 7379 6d2e  ance(symbol.sym.
+0001de80: 6964 2c20 7072 696d 732e 5072 696d 4944  id, prims.PrimID
+0001de90: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0001dea0: 2020 2020 2320 5765 2063 6f75 6c64 206e      # We could n
+0001deb0: 6f74 2066 696e 6420 6120 6261 636b 7761  ot find a backwa
+0001dec0: 7264 2066 6f72 2074 6869 7320 7379 6d62  rd for this symb
+0001ded0: 6f6c 2c20 736f 2077 6520 7472 7920 746f  ol, so we try to
+0001dee0: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
+0001def0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+0001df00: 636b 7761 7264 203d 2070 6172 7469 616c  ckward = partial
+0001df10: 2864 6563 6f6d 706f 7365 645f 666e 5f62  (decomposed_fn_b
+0001df20: 6163 6b77 6172 645f 7275 6c65 2c20 7379  ackward_rule, sy
+0001df30: 6d62 6f6c 2e73 796d 290a 2020 2020 2020  mbol.sym).      
+0001df40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001df50: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0001df60: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
+0001df70: 6120 6261 636b 7761 7264 2066 6f72 2074  a backward for t
+0001df80: 6869 7320 7379 6d62 6f6c 2061 6e64 2077  his symbol and w
+0001df90: 6520 636f 756c 6420 6e6f 7420 6465 636f  e could not deco
+0001dfa0: 6d70 6f73 6520 6974 0a20 2020 2020 2020  mpose it.       
+0001dfb0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+0001dfc0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+0001dfd0: 6f72 2866 2242 6163 6b77 6172 6420 666f  or(f"Backward fo
+0001dfe0: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
+0001dff0: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
+0001e000: 6e74 6564 2229 0a0a 2020 2020 2020 2020  nted")..        
+0001e010: 7265 7375 6c74 203d 2062 6163 6b77 6172  result = backwar
+0001e020: 6428 2a72 6573 6964 7561 6c73 2c20 2a63  d(*residuals, *c
+0001e030: 6f74 616e 6765 6e74 7329 0a20 2020 2020  otangents).     
+0001e040: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001e050: 2872 6573 756c 742c 2064 6963 7429 3a0a  (result, dict):.
+0001e060: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0001e070: 2074 6865 2062 6163 6b77 6172 6420 7265   the backward re
+0001e080: 7475 726e 7320 6120 6469 6374 2c20 7765  turns a dict, we
+0001e090: 2061 7373 756d 6520 7468 6174 2069 7420   assume that it 
+0001e0a0: 6973 2061 2064 6963 7420 6f66 0a20 2020  is a dict of.   
+0001e0b0: 2020 2020 2020 2020 2023 2066 6f72 7761           # forwa
+0001e0c0: 7264 2061 7267 756d 656e 7473 2074 6f20  rd arguments to 
+0001e0d0: 7468 6520 636f 7272 6573 706f 6e64 696e  the correspondin
+0001e0e0: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
+0001e0f0: 6772 6164 6965 6e74 732f 636f 7461 6e67  gradients/cotang
+0001e100: 656e 7473 2f61 646a 6f69 6e74 732f 7365  ents/adjoints/se
+0001e110: 6e73 6974 6976 6974 6965 732e 0a20 2020  nsitivities..   
+0001e120: 2020 2020 2020 2020 2075 7365 645f 6e61           used_na
+0001e130: 6d65 7320 3d20 7365 7428 290a 2020 2020  mes = set().    
+0001e140: 2020 2020 2020 2020 666f 7220 692c 2028          for i, (
+0001e150: 6b2c 2076 2920 696e 2065 6e75 6d65 7261  k, v) in enumera
+0001e160: 7465 2869 6e73 7065 6374 2e73 6967 6e61  te(inspect.signa
+0001e170: 7475 7265 2861 7567 5f66 6f72 7761 7264  ture(aug_forward
+0001e180: 292e 7061 7261 6d65 7465 7273 2e69 7465  ).parameters.ite
+0001e190: 6d73 2829 293a 0a20 2020 2020 2020 2020  ms()):.         
+0001e1a0: 2020 2020 2020 2069 6620 762e 6b69 6e64         if v.kind
+0001e1b0: 2069 6e20 2869 6e73 7065 6374 2e50 6172   in (inspect.Par
+0001e1c0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
+0001e1d0: 4c5f 4f4e 4c59 2c20 696e 7370 6563 742e  L_ONLY, inspect.
+0001e1e0: 5061 7261 6d65 7465 722e 504f 5349 5449  Parameter.POSITI
+0001e1f0: 4f4e 414c 5f4f 525f 4b45 5957 4f52 4429  ONAL_OR_KEYWORD)
+0001e200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e210: 2020 2020 2020 7075 745f 6772 6164 2873        put_grad(s
+0001e220: 796d 626f 6c2e 6172 6773 5b69 5d2c 2072  ymbol.args[i], r
+0001e230: 6573 756c 742e 6765 7428 6b2c 204e 6f6e  esult.get(k, Non
+0001e240: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+0001e250: 2020 2020 2020 2020 7573 6564 5f6e 616d          used_nam
+0001e260: 6573 2e61 6464 286b 290a 0a20 2020 2020  es.add(k)..     
+0001e270: 2020 2020 2020 2023 2046 6f72 2064 6576         # For dev
+0001e280: 656c 6f70 6572 2063 6f6e 7665 6e69 656e  eloper convenien
+0001e290: 6365 2c20 7765 2061 6c6c 6f77 2075 7369  ce, we allow usi
+0001e2a0: 6e67 2074 6865 206e 616d 6520 6672 6f6d  ng the name from
+0001e2b0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0001e2c0: 2023 2066 6f72 7761 7264 206d 6574 6120   # forward meta 
+0001e2d0: 696e 2061 6464 6974 696f 6e20 746f 2074  in addition to t
+0001e2e0: 6865 206e 616d 6520 6672 6f6d 2074 6865  he name from the
+0001e2f0: 2061 7567 6d65 6e74 6564 2066 6f72 7761   augmented forwa
+0001e300: 7264 0a20 2020 2020 2020 2020 2020 2023  rd.            #
+0001e310: 2073 6967 6e61 7475 7265 2e0a 2020 2020   signature..    
+0001e320: 2020 2020 2020 2020 2320 4966 2062 6f74          # If bot
+0001e330: 6820 6e61 6d65 7320 6172 6520 7573 6564  h names are used
+0001e340: 2c20 7468 6520 6f6e 6520 6672 6f6d 2074  , the one from t
+0001e350: 6865 2066 6f72 7761 7264 206d 6574 6120  he forward meta 
+0001e360: 7461 6b65 730a 2020 2020 2020 2020 2020  takes.          
+0001e370: 2020 2320 7072 6563 6564 656e 6365 2e0a    # precedence..
+0001e380: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001e390: 692c 2028 6b2c 2076 2920 696e 2065 6e75  i, (k, v) in enu
+0001e3a0: 6d65 7261 7465 2869 6e73 7065 6374 2e73  merate(inspect.s
+0001e3b0: 6967 6e61 7475 7265 2873 796d 626f 6c2e  ignature(symbol.
+0001e3c0: 7379 6d2e 6d65 7461 292e 7061 7261 6d65  sym.meta).parame
+0001e3d0: 7465 7273 2e69 7465 6d73 2829 293a 0a20  ters.items()):. 
+0001e3e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001e3f0: 6620 762e 6b69 6e64 2069 6e20 2869 6e73  f v.kind in (ins
+0001e400: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
+0001e410: 4f53 4954 494f 4e41 4c5f 4f4e 4c59 2c20  OSITIONAL_ONLY, 
+0001e420: 696e 7370 6563 742e 5061 7261 6d65 7465  inspect.Paramete
+0001e430: 722e 504f 5349 5449 4f4e 414c 5f4f 525f  r.POSITIONAL_OR_
+0001e440: 4b45 5957 4f52 4429 3a0a 2020 2020 2020  KEYWORD):.      
+0001e450: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001e460: 206b 206e 6f74 2069 6e20 7573 6564 5f6e   k not in used_n
+0001e470: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+0001e480: 2020 2020 2020 2020 2020 2020 2020 7075                pu
+0001e490: 745f 6772 6164 2873 796d 626f 6c2e 6172  t_grad(symbol.ar
+0001e4a0: 6773 5b69 5d2c 2072 6573 756c 742e 6765  gs[i], result.ge
+0001e4b0: 7428 6b2c 204e 6f6e 6529 290a 2020 2020  t(k, None)).    
+0001e4c0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0001e4d0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0001e4e0: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+0001e4f0: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
+0001e500: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0001e510: 7420 3d20 2872 6573 756c 742c 290a 0a20  t = (result,).. 
+0001e520: 2020 2020 2020 2064 6566 2069 735f 6469         def is_di
+0001e530: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
+0001e540: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
+0001e550: 6174 6368 2061 7267 3a0a 2020 2020 2020  atch arg:.      
+0001e560: 2020 2020 2020 2020 2020 6361 7365 2054            case T
+0001e570: 656e 736f 7250 726f 7879 2829 3a0a 2020  ensorProxy():.  
+0001e580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e590: 2020 7265 7475 726e 2064 7479 7065 732e    return dtypes.
+0001e5a0: 6973 5f69 6e65 7861 6374 5f64 7479 7065  is_inexact_dtype
+0001e5b0: 2861 7267 2e64 7479 7065 290a 2020 2020  (arg.dtype).    
+0001e5c0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0001e5d0: 2053 6571 7565 6e63 6528 293a 0a20 2020   Sequence():.   
+0001e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5f0: 2072 6574 7572 6e20 6172 6720 616e 6420   return arg and 
+0001e600: 616c 6c28 6973 696e 7374 616e 6365 2878  all(isinstance(x
+0001e610: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
+0001e620: 6e64 2064 7479 7065 732e 6973 5f69 6e65  nd dtypes.is_ine
+0001e630: 7861 6374 5f64 7479 7065 2878 2e64 7479  xact_dtype(x.dty
+0001e640: 7065 2920 666f 7220 7820 696e 2061 7267  pe) for x in arg
+0001e650: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001e660: 2020 6361 7365 205f 3a0a 2020 2020 2020    case _:.      
+0001e670: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001e680: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+0001e690: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
+0001e6a0: 6c2e 6172 6773 2920 213d 2028 6f72 6967  l.args) != (orig
+0001e6b0: 5f72 6573 5f6c 656e 203a 3d20 6c65 6e28  _res_len := len(
+0001e6c0: 7265 7375 6c74 2929 3a0a 2020 2020 2020  result)):.      
+0001e6d0: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
+0001e6e0: 2020 2020 2020 2020 2020 2020 206f 7269               ori
+0001e6f0: 675f 7265 735f 6c65 6e20 3c3d 206c 656e  g_res_len <= len
+0001e700: 2873 796d 626f 6c2e 6172 6773 292c 0a20  (symbol.args),. 
+0001e710: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001e720: 616d 6264 613a 2066 2242 6163 6b77 6172  ambda: f"Backwar
+0001e730: 6420 666f 7220 7b73 796d 626f 6c2e 7379  d for {symbol.sy
+0001e740: 6d2e 6964 7d20 7265 7475 726e 6564 207b  m.id} returned {
+0001e750: 6f72 6967 5f72 6573 5f6c 656e 7d20 7661  orig_res_len} va
+0001e760: 6c75 6573 2c20 220a 2020 2020 2020 2020  lues, ".        
+0001e770: 2020 2020 2020 2020 2b20 6622 6275 7420          + f"but 
+0001e780: 6578 7065 6374 6564 2061 7420 6d6f 7374  expected at most
+0001e790: 207b 6c65 6e28 7379 6d62 6f6c 2e61 7267   {len(symbol.arg
+0001e7a0: 7329 7d22 2c0a 2020 2020 2020 2020 2020  s)}",.          
+0001e7b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001e7c0: 2320 4173 7375 6d69 6e67 2074 6861 7420  # Assuming that 
+0001e7d0: 7468 6520 6e6f 6e2d 6469 6666 6572 656e  the non-differen
+0001e7e0: 7469 6162 6c65 2061 7267 756d 656e 7473  tiable arguments
+0001e7f0: 2077 6572 6520 6472 6f70 7065 6420 6672   were dropped fr
+0001e800: 6f6d 0a20 2020 2020 2020 2020 2020 2023  om.            #
+0001e810: 2074 6865 2062 6163 6b77 6172 6420 6675   the backward fu
+0001e820: 6e63 7469 6f6e 2c20 7765 2061 7265 2067  nction, we are g
+0001e830: 6f69 6e67 2074 6f20 6170 7065 6e64 204e  oing to append N
+0001e840: 6f6e 6520 746f 2074 6865 2072 6573 756c  one to the resul
+0001e850: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0001e860: 746f 206d 6174 6368 2074 6865 206e 756d  to match the num
+0001e870: 6265 7220 6f66 2061 7267 756d 656e 7473  ber of arguments
+0001e880: 2e20 416c 7465 726e 6174 6976 656c 792c  . Alternatively,
+0001e890: 2077 6520 636f 756c 6420 6a75 7374 0a20   we could just. 
+0001e8a0: 2020 2020 2020 2020 2020 2023 2068 6176             # hav
+0001e8b0: 6520 6120 666f 722d 6c6f 6f70 2077 6974  e a for-loop wit
+0001e8c0: 6820 6120 636f 6e64 6974 696f 6e61 6c20  h a conditional 
+0001e8d0: 7768 656e 2077 7269 7469 6e67 2074 6f20  when writing to 
+0001e8e0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+0001e8f0: 2320 656e 7669 726f 6e6d 656e 742e 0a0a  # environment...
+0001e900: 2020 2020 2020 2020 2020 2020 6974 6572              iter
+0001e910: 5f72 6573 756c 7420 3d20 6974 6572 2872  _result = iter(r
+0001e920: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
+0001e930: 2020 206e 5f64 6966 6665 7265 6e74 6961     n_differentia
+0001e940: 626c 655f 6172 6773 203d 2073 756d 2862  ble_args = sum(b
+0001e950: 6f6f 6c28 6973 5f64 6966 6665 7265 6e74  ool(is_different
+0001e960: 6961 626c 6528 6172 6729 2920 666f 7220  iable(arg)) for 
+0001e970: 6172 6720 696e 2073 796d 626f 6c2e 6172  arg in symbol.ar
+0001e980: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0001e990: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
+0001e9a0: 2020 2020 2020 206e 5f64 6966 6665 7265         n_differe
+0001e9b0: 6e74 6961 626c 655f 6172 6773 203c 3d20  ntiable_args <= 
+0001e9c0: 6f72 6967 5f72 6573 5f6c 656e 2c0a 2020  orig_res_len,.  
+0001e9d0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0001e9e0: 6d62 6461 3a20 6622 4261 636b 7761 7264  mbda: f"Backward
+0001e9f0: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
+0001ea00: 2e69 647d 2072 6574 7572 6e65 6420 7b6f  .id} returned {o
+0001ea10: 7269 675f 7265 735f 6c65 6e7d 2076 616c  rig_res_len} val
+0001ea20: 7565 2873 292c 2022 0a20 2020 2020 2020  ue(s), ".       
+0001ea30: 2020 2020 2020 2020 202b 2066 2262 7574           + f"but
+0001ea40: 2065 7870 6563 7465 6420 7b6e 5f64 6966   expected {n_dif
+0001ea50: 6665 7265 6e74 6961 626c 655f 6172 6773  ferentiable_args
+0001ea60: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+0001ea70: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+0001ea80: 6573 756c 7420 3d20 7475 706c 6528 6e65  esult = tuple(ne
+0001ea90: 7874 2869 7465 725f 7265 7375 6c74 2920  xt(iter_result) 
+0001eaa0: 6966 2069 735f 6469 6666 6572 656e 7469  if is_differenti
+0001eab0: 6162 6c65 2861 7267 2920 656c 7365 204e  able(arg) else N
+0001eac0: 6f6e 6520 666f 7220 6172 6720 696e 2073  one for arg in s
+0001ead0: 796d 626f 6c2e 6172 6773 290a 0a20 2020  ymbol.args)..   
+0001eae0: 2020 2020 2023 2053 6565 2022 4261 636b       # See "Back
+0001eaf0: 7761 7264 2069 6d70 6c20 666f 7220 6f70  ward impl for op
+0001eb00: 7320 6f66 2074 6865 2074 7970 6520 5365  s of the type Se
+0001eb10: 7175 656e 6365 5b54 656e 736f 7250 726f  quence[TensorPro
+0001eb20: 7879 5d2c 202e 2e2e 202d 3e20 2e2e 2e20  xy], ... -> ... 
+0001eb30: 7265 7375 6c74 7320 696e 204e 6f6e 6520  results in None 
+0001eb40: 6772 6164 732e 220a 2020 2020 2020 2020  grads.".        
+0001eb50: 2320 5468 6973 2069 7320 6120 7465 6d70  # This is a temp
+0001eb60: 6f72 6172 7920 776f 726b 6172 6f75 6e64  orary workaround
+0001eb70: 2e0a 2020 2020 2020 2020 6966 2073 796d  ..        if sym
+0001eb80: 626f 6c2e 7379 6d2e 6964 2069 6e20 2870  bol.sym.id in (p
+0001eb90: 7269 6d73 2e50 7269 6d49 4473 2e43 4154  rims.PrimIDs.CAT
+0001eba0: 2c20 2274 6f72 6368 2e63 6174 222c 2022  , "torch.cat", "
+0001ebb0: 746f 7263 682e 7374 6163 6b22 293a 0a20  torch.stack"):. 
+0001ebc0: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
+0001ebd0: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
+0001ebe0: 642c 2073 796d 626f 6c2e 6172 6773 2c20  d, symbol.args, 
+0001ebf0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
+0001ec00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001ec10: 2020 7361 6665 5f6d 6170 2870 7574 5f67    safe_map(put_g
+0001ec20: 7261 642c 2073 796d 626f 6c2e 6172 6773  rad, symbol.args
+0001ec30: 2c20 7265 7375 6c74 290a 0a20 2020 2064  , result)..    d
+0001ec40: 6566 2067 6574 5f69 6e65 7861 6374 5f64  ef get_inexact_d
+0001ec50: 7479 7065 5f6f 725f 6e6f 6e65 2878 293a  type_or_none(x):
+0001ec60: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0001ec70: 7374 616e 6365 2878 2c20 2854 656e 736f  stance(x, (Tenso
+0001ec80: 7250 726f 7879 2c20 4675 7475 7265 5465  rProxy, FutureTe
+0001ec90: 6e73 6f72 5072 6f78 7929 2920 616e 6420  nsorProxy)) and 
+0001eca0: 6474 7970 6573 2e69 735f 696e 6578 6163  dtypes.is_inexac
+0001ecb0: 745f 6474 7970 6528 782e 6474 7970 6529  t_dtype(x.dtype)
+0001ecc0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001ecd0: 7475 726e 2078 0a20 2020 2020 2020 2065  turn x.        e
+0001ece0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001ecf0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+0001ed00: 2020 6761 7267 7320 3d20 7472 6565 5f6d    gargs = tree_m
+0001ed10: 6170 2867 6574 5f67 7261 642c 2074 7570  ap(get_grad, tup
+0001ed20: 6c65 2874 7261 6365 2e61 7267 7329 290a  le(trace.args)).
+0001ed30: 2020 2020 676b 7761 7267 7320 3d20 7472      gkwargs = tr
+0001ed40: 6565 5f6d 6170 2867 6574 5f67 7261 642c  ee_map(get_grad,
+0001ed50: 2074 7261 6365 2e6b 7761 7267 7329 0a20   trace.kwargs). 
+0001ed60: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
+0001ed70: 2076 2066 6f72 206b 2c20 7620 696e 2067   v for k, v in g
+0001ed80: 6b77 6172 6773 2e69 7465 6d73 2829 2069  kwargs.items() i
+0001ed90: 6620 7620 6973 206e 6f74 204e 6f6e 657d  f v is not None}
+0001eda0: 0a20 2020 2067 6172 6773 2c20 676b 7761  .    gargs, gkwa
+0001edb0: 7267 7320 3d20 7472 6565 5f6d 6170 2867  rgs = tree_map(g
+0001edc0: 6574 5f69 6e65 7861 6374 5f64 7479 7065  et_inexact_dtype
+0001edd0: 5f6f 725f 6e6f 6e65 2c20 2867 6172 6773  _or_none, (gargs
+0001ede0: 2c20 676b 7761 7267 7329 290a 2020 2020  , gkwargs)).    
+0001edf0: 7265 7475 726e 2067 6172 6773 202b 2028  return gargs + (
+0001ee00: 676b 7761 7267 732c 2920 6966 206c 656e  gkwargs,) if len
+0001ee10: 2867 6b77 6172 6773 2920 213d 2030 2065  (gkwargs) != 0 e
+0001ee20: 6c73 6520 6761 7267 730a 0a0a 6465 6620  lse gargs...def 
+0001ee30: 766a 705f 6361 6c6c 5f6d 6574 6166 756e  vjp_call_metafun
+0001ee40: 6328 6465 7461 6368 6564 3a20 626f 6f6c  c(detached: bool
+0001ee50: 2c20 7072 696d 616c 732c 2063 6f74 616e  , primals, cotan
+0001ee60: 6765 6e74 732c 2074 7261 6365 3a20 5472  gents, trace: Tr
+0001ee70: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
+0001ee80: 2020 2020 2320 4173 7375 6d69 6e67 2070      # Assuming p
+0001ee90: 7269 6d61 6c73 2069 7320 666c 6174 0a0a  rimals is flat..
+0001eea0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+0001eeb0: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
+0001eec0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+0001eed0: 2020 7072 696d 616c 7320 3d20 2870 7269    primals = (pri
+0001eee0: 6d61 6c73 2c29 0a0a 2020 2020 6374 7820  mals,)..    ctx 
+0001eef0: 3d20 6465 7461 6368 6564 5f74 7261 6365  = detached_trace
+0001ef00: 2829 2069 6620 6465 7461 6368 6564 2065  () if detached e
+0001ef10: 6c73 6520 6e75 6c6c 636f 6e74 6578 7428  lse nullcontext(
+0001ef20: 290a 2020 2020 7769 7468 2063 7478 3a0a  ).    with ctx:.
+0001ef30: 2020 2020 2020 2020 7265 7375 6c74 2c20          result, 
+0001ef40: 656e 7620 3d20 6175 676d 656e 7465 645f  env = augmented_
+0001ef50: 666f 7277 6172 645f 7061 7373 282a 7072  forward_pass(*pr
+0001ef60: 696d 616c 732c 2074 7261 6365 3d74 7261  imals, trace=tra
+0001ef70: 6365 2c20 2a2a 6b77 6172 6773 290a 2020  ce, **kwargs).  
+0001ef80: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
+0001ef90: 2020 2020 2020 2020 206c 656e 2872 6573           len(res
+0001efa0: 756c 7429 203d 3d20 6c65 6e28 636f 7461  ult) == len(cota
+0001efb0: 6e67 656e 7473 2920 6966 2069 7369 6e73  ngents) if isins
+0001efc0: 7461 6e63 6528 7265 7375 6c74 2c20 5365  tance(result, Se
+0001efd0: 7175 656e 6365 2920 656c 7365 2054 7275  quence) else Tru
+0001efe0: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
+0001eff0: 616d 6264 613a 2066 2245 7870 6563 7465  ambda: f"Expecte
+0001f000: 6420 636f 7461 6e67 656e 7473 2074 6f20  d cotangents to 
+0001f010: 6265 2061 2073 6571 7565 6e63 6520 6f66  be a sequence of
+0001f020: 206c 656e 6774 6820 7b6c 656e 2872 6573   length {len(res
+0001f030: 756c 7429 7d2c 2067 6f74 2061 2073 6571  ult)}, got a seq
+0001f040: 7565 6e63 6520 6f66 206c 656e 6774 6820  uence of length 
+0001f050: 7b6c 656e 2863 6f74 616e 6765 6e74 7329  {len(cotangents)
+0001f060: 7d22 2c0a 2020 2020 2020 2020 290a 2020  }",.        ).  
+0001f070: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0001f080: 756c 742c 2062 6163 6b77 6172 645f 7061  ult, backward_pa
+0001f090: 7373 2865 6e76 2c20 7472 6163 652c 2063  ss(env, trace, c
+0001f0a0: 6f74 616e 6765 6e74 7329 0a0a 0a23 2054  otangents)...# T
+0001f0b0: 4f44 4f3a 2043 616e 2774 2075 7365 2061  ODO: Can't use a
+0001f0c0: 2053 796d 626f 6c20 6865 7265 2062 6563   Symbol here bec
+0001f0d0: 6175 7365 206d 6978 6564 2065 7865 6375  ause mixed execu
+0001f0e0: 746f 7220 7379 6273 796d 626f 6c73 2073  tor sybsymbols s
+0001f0f0: 6565 6d20 746f 2062 650a 2320 756e 7375  eem to be.# unsu
+0001f100: 7070 6f72 7465 642e 2053 6565 2069 7373  pported. See iss
+0001f110: 7565 2022 436f 756c 6420 6e6f 7420 6669  ue "Could not fi
+0001f120: 6e64 2061 6e20 6578 6563 7574 6f72 2066  nd an executor f
+0001f130: 6f72 2062 6f75 6e64 2073 796d 626f 6c20  or bound symbol 
+0001f140: 7768 656e 2069 7473 2073 7562 7379 6d62  when its subsymb
+0001f150: 6f6c 730a 2320 6172 6520 6e6f 7420 6675  ols.# are not fu
+0001f160: 6c6c 7920 7375 7070 6f72 7465 6420 6279  lly supported by
+0001f170: 2061 2073 696e 676c 6520 6578 6563 7574   a single execut
+0001f180: 6f72 220a 766a 705f 6361 6c6c 203d 2070  or".vjp_call = p
+0001f190: 6172 7469 616c 280a 2020 2020 766a 705f  artial(.    vjp_
+0001f1a0: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
+0001f1b0: 616c 7365 0a29 2020 2320 5379 6d62 6f6c  alse.)  # Symbol
+0001f1c0: 2869 643d 5472 616e 7366 6f72 6d73 2e56  (id=Transforms.V
+0001f1d0: 6a70 4f70 2c20 6e61 6d65 3d22 766a 705f  jpOp, name="vjp_
+0001f1e0: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
+0001f1f0: 6961 6c28 766a 705f 6361 6c6c 5f6d 6574  ial(vjp_call_met
+0001f200: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
+0001f210: 0a64 6566 2076 6a70 2866 756e 6329 3a0a  .def vjp(func):.
+0001f220: 2020 2020 2222 2243 6f6d 7075 7465 7320      """Computes 
+0001f230: 7468 6520 564a 5020 6f66 2061 2066 756e  the VJP of a fun
+0001f240: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
+0001f250: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
+0001f260: 4361 6c6c 6162 6c65 293a 2046 756e 6374  Callable): Funct
+0001f270: 696f 6e20 746f 2062 6520 6469 6666 6572  ion to be differ
+0001f280: 656e 7469 6174 6564 2e0a 2020 2020 2222  entiated..    ""
+0001f290: 220a 0a20 2020 2064 6566 205f 766a 7028  "..    def _vjp(
+0001f2a0: 7072 696d 616c 732c 2063 6f74 616e 6765  primals, cotange
+0001f2b0: 6e74 732c 202a 2a6b 7761 7267 7329 3a0a  nts, **kwargs):.
+0001f2c0: 2020 2020 2020 2020 666c 6174 5f66 756e          flat_fun
+0001f2d0: 632c 2066 6c61 745f 6172 6773 2c20 7370  c, flat_args, sp
+0001f2e0: 6563 203d 2066 6c61 7474 656e 5f66 756e  ec = flatten_fun
+0001f2f0: 6328 6675 6e63 2c20 7072 696d 616c 732c  c(func, primals,
+0001f300: 206b 7761 7267 7329 0a20 2020 2020 2020   kwargs).       
+0001f310: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
+0001f320: 6374 5f74 7261 6365 2829 2866 6c61 745f  ct_trace()(flat_
+0001f330: 6675 6e63 2c20 2a66 6c61 745f 6172 6773  func, *flat_args
+0001f340: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
+0001f350: 2c20 766a 705f 7265 7375 6c74 203d 2076  , vjp_result = v
+0001f360: 6a70 5f63 616c 6c28 666c 6174 5f61 7267  jp_call(flat_arg
+0001f370: 732c 2063 6f74 616e 6765 6e74 732c 2074  s, cotangents, t
+0001f380: 7261 6365 3d74 7261 6365 290a 2020 2020  race=trace).    
+0001f390: 2020 2020 6770 7269 6d61 6c73 2c20 676b      gprimals, gk
+0001f3a0: 7761 7267 7320 3d20 7472 6565 5f75 6e66  wargs = tree_unf
+0001f3b0: 6c61 7474 656e 2876 6a70 5f72 6573 756c  latten(vjp_resul
+0001f3c0: 742c 2073 7065 6329 0a20 2020 2020 2020  t, spec).       
+0001f3d0: 2067 7261 6473 203d 2067 7072 696d 616c   grads = gprimal
+0001f3e0: 7320 2b20 2867 6b77 6172 6773 2c29 2069  s + (gkwargs,) i
+0001f3f0: 6620 6c65 6e28 676b 7761 7267 7329 2021  f len(gkwargs) !
+0001f400: 3d20 3020 656c 7365 2067 7072 696d 616c  = 0 else gprimal
+0001f410: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
+0001f420: 2072 6573 756c 742c 2067 7261 6473 0a0a   result, grads..
+0001f430: 2020 2020 7265 7475 726e 205f 766a 700a      return _vjp.
+0001f440: 0a0a 6465 6620 7661 6c75 655f 616e 645f  ..def value_and_
+0001f450: 6772 6164 2866 756e 6329 3a0a 2020 2020  grad(func):.    
+0001f460: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
+0001f470: 7661 6c75 6520 616e 6420 6772 6164 6965  value and gradie
+0001f480: 6e74 206f 6620 6120 6675 6e63 7469 6f6e  nt of a function
+0001f490: 2e0a 0a20 2020 2054 6869 7320 6973 2061  ...    This is a
+0001f4a0: 2063 6f6e 7665 6e69 656e 6365 2066 756e   convenience fun
+0001f4b0: 6374 696f 6e20 7468 6174 2063 6f6d 6269  ction that combi
+0001f4c0: 6e65 7320 7468 6520 6675 6e63 7469 6f6e  nes the function
+0001f4d0: 616c 6974 7920 6f66 0a20 2020 2060 766a  ality of.    `vj
+0001f4e0: 705f 6361 6c6c 6020 7769 7468 2069 6d70  p_call` with imp
+0001f4f0: 6c69 6369 7420 696e 6974 6961 6c69 7a61  licit initializa
+0001f500: 7469 6f6e 206f 6620 7468 6520 636f 7461  tion of the cota
+0001f510: 6e67 656e 7420 746f 2031 2e0a 0a20 2020  ngent to 1...   
+0001f520: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+0001f530: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+0001f540: 4675 6e63 7469 6f6e 2074 6f20 6265 2064  Function to be d
+0001f550: 6966 6665 7265 6e74 6961 7465 642e 0a20  ifferentiated.. 
+0001f560: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+0001f570: 6f6e 6573 5f6c 696b 6528 7829 3a0a 2020  ones_like(x):.  
+0001f580: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0001f590: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+0001f5a0: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+0001f5b0: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
+0001f5c0: 6528 782c 2066 696c 6c5f 7661 6c75 653d  e(x, fill_value=
+0001f5d0: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
+0001f5e0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+0001f5f0: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
+0001f600: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0001f610: 7970 6528 782e 7661 6c75 6529 2831 290a  ype(x.value)(1).
+0001f620: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f630: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f640: 204e 6f6e 650a 0a20 2020 2064 6566 205f   None..    def _
+0001f650: 7661 6c75 655f 616e 645f 6772 6164 282a  value_and_grad(*
+0001f660: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+0001f670: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
+0001f680: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0001f690: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
+0001f6a0: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+0001f6b0: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
+0001f6c0: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
+0001f6d0: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
+0001f6e0: 7472 6163 652e 6f75 7470 7574 290a 2020  trace.output).  
+0001f6f0: 2020 2020 2020 7265 7475 726e 2076 6a70        return vjp
+0001f700: 2866 756e 6329 2861 7267 732c 2063 6f74  (func)(args, cot
+0001f710: 616e 6765 6e74 732c 202a 2a6b 7761 7267  angents, **kwarg
+0001f720: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
+0001f730: 7661 6c75 655f 616e 645f 6772 6164 0a0a  value_and_grad..
+0001f740: 0a46 6f72 7761 7264 4261 636b 7761 7264  .ForwardBackward
+0001f750: 5472 6163 6573 203d 206e 616d 6564 7475  Traces = namedtu
+0001f760: 706c 6528 2246 6f72 7761 7264 4261 636b  ple("ForwardBack
+0001f770: 7761 7264 5472 6163 6573 222c 205b 2266  wardTraces", ["f
+0001f780: 6f72 7761 7264 5f74 7261 6365 222c 2022  orward_trace", "
+0001f790: 6261 636b 7761 7264 5f74 7261 6365 225d  backward_trace"]
+0001f7a0: 290a 0a0a 6465 6620 5f73 706c 6974 5f73  )...def _split_s
+0001f7b0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f7c0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
+0001f7d0: 6e64 5f6f 7468 6572 280a 2020 2020 7361  nd_other(.    sa
+0001f7e0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f7f0: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
+0001f800: 626c 655d 2c0a 2920 2d3e 2074 7570 6c65  ble],.) -> tuple
+0001f810: 5b53 6571 7565 6e63 655b 5661 7269 6162  [Sequence[Variab
+0001f820: 6c65 5d2c 2053 6571 7565 6e63 655b 5661  le], Sequence[Va
+0001f830: 7269 6162 6c65 5d5d 3a0a 2020 2020 2222  riable]]:.    ""
+0001f840: 2253 706c 6974 7320 7361 7665 645f 666f  "Splits saved_fo
+0001f850: 725f 6261 636b 7761 7264 2069 6e74 6f20  r_backward into 
+0001f860: 7465 6e73 6f72 7320 616e 6420 6f74 6865  tensors and othe
+0001f870: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
+0001f880: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
+0001f890: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
+0001f8a0: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
+0001f8b0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f8c0: 6420 746f 2073 706c 6974 2e0a 0a20 2020  d to split...   
+0001f8d0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001f8e0: 2020 7475 706c 655b 5365 7175 656e 6365    tuple[Sequence
+0001f8f0: 5b56 6172 6961 626c 655d 2c20 5365 7175  [Variable], Sequ
+0001f900: 656e 6365 5b56 6172 6961 626c 655d 5d3a  ence[Variable]]:
+0001f910: 2054 7570 6c65 206f 6620 7465 6e73 6f72   Tuple of tensor
+0001f920: 7320 616e 6420 6f74 6865 722e 0a20 2020  s and other..   
+0001f930: 2022 2222 0a20 2020 2069 735f 7465 6e73   """.    is_tens
+0001f940: 6f72 203d 206c 616d 6264 6120 783a 2069  or = lambda x: i
+0001f950: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
+0001f960: 736f 7250 726f 7879 290a 2020 2020 6f74  sorProxy).    ot
+0001f970: 6865 722c 2074 656e 736f 7273 203d 2075  her, tensors = u
+0001f980: 7469 6c73 2e70 6172 7469 7469 6f6e 2869  tils.partition(i
+0001f990: 735f 7465 6e73 6f72 2c20 7361 7665 645f  s_tensor, saved_
+0001f9a0: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
+0001f9b0: 2020 7265 7475 726e 2074 7570 6c65 2874    return tuple(t
+0001f9c0: 656e 736f 7273 292c 2074 7570 6c65 286f  ensors), tuple(o
+0001f9d0: 7468 6572 290a 0a0a 6465 6620 5f75 7064  ther)...def _upd
+0001f9e0: 6174 655f 666f 7277 6172 645f 7769 7468  ate_forward_with
+0001f9f0: 5f6e 6577 5f73 6176 6564 5f66 6f72 5f62  _new_saved_for_b
+0001fa00: 6163 6b77 6172 6428 666f 7277 6172 645f  ackward(forward_
+0001fa10: 7472 6163 653a 2054 7261 6365 2c20 7361  trace: Trace, sa
+0001fa20: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001fa30: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
+0001fa40: 626c 655d 2920 2d3e 204e 6f6e 653a 0a20  ble]) -> None:. 
+0001fa50: 2020 2022 2222 5570 6461 7465 7320 7468     """Updates th
+0001fa60: 6520 666f 7277 6172 6420 7472 6163 6520  e forward trace 
+0001fa70: 7769 7468 206e 6577 2073 6176 6564 5f66  with new saved_f
+0001fa80: 6f72 5f62 6163 6b77 6172 642e 0a0a 2020  or_backward...  
+0001fa90: 2020 5468 6973 2069 7320 6e65 6365 7373    This is necess
+0001faa0: 6172 7920 6265 6361 7573 6520 7468 6520  ary because the 
+0001fab0: 7570 6461 7465 6420 7361 7665 645f 666f  updated saved_fo
+0001fac0: 725f 6261 636b 7761 7264 2069 7320 6e6f  r_backward is no
+0001fad0: 7420 6176 6169 6c61 626c 650a 2020 2020  t available.    
+0001fae0: 7768 656e 2074 6865 2066 6f72 7761 7264  when the forward
+0001faf0: 2061 6e64 2062 6163 6b77 6172 6420 7472   and backward tr
+0001fb00: 6163 6573 2061 7265 2063 6f6e 7374 7275  aces are constru
+0001fb10: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
+0001fb20: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
+0001fb30: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
+0001fb40: 466f 7277 6172 6420 7472 6163 6520 746f  Forward trace to
+0001fb50: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
+0001fb60: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001fb70: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
+0001fb80: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
+0001fb90: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
+0001fba0: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
+0001fbb0: 2020 2075 7064 6174 6520 7468 6520 666f     update the fo
+0001fbc0: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
+0001fbd0: 2022 2222 0a20 2020 2073 6176 6564 5f66   """.    saved_f
+0001fbe0: 6f72 5f62 6163 6b77 6172 6420 3d20 7472  or_backward = tr
+0001fbf0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+0001fc00: 2078 2e76 616c 7565 2069 6620 6973 696e   x.value if isin
+0001fc10: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
+0001fc20: 5072 6f78 7929 2065 6c73 6520 782c 2073  Proxy) else x, s
+0001fc30: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001fc40: 6429 0a20 2020 2073 6176 6564 5f74 656e  d).    saved_ten
+0001fc50: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
+0001fc60: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
+0001fc70: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
+0001fc80: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
+0001fc90: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
+0001fca0: 6163 6b77 6172 6429 0a20 2020 2061 7373  ackward).    ass
+0001fcb0: 6572 7420 666f 7277 6172 645f 7472 6163  ert forward_trac
+0001fcc0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
+0001fcd0: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
+0001fce0: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
+0001fcf0: 524e 0a20 2020 206e 6577 5f72 6574 7572  RN.    new_retur
+0001fd00: 6e20 3d20 2866 6f72 7761 7264 5f74 7261  n = (forward_tra
+0001fd10: 6365 2e6f 7574 7075 745b 305d 2c20 2873  ce.output[0], (s
+0001fd20: 6176 6564 5f74 656e 736f 7273 2c20 7361  aved_tensors, sa
+0001fd30: 7665 645f 6f74 6865 7229 290a 2020 2020  ved_other)).    
+0001fd40: 666f 7277 6172 645f 7472 6163 652e 626f  forward_trace.bo
+0001fd50: 756e 645f 7379 6d62 6f6c 735b 2d31 5d20  und_symbols[-1] 
+0001fd60: 3d20 7265 706c 6163 6528 666f 7277 6172  = replace(forwar
+0001fd70: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
+0001fd80: 6d62 6f6c 735b 2d31 5d2c 2061 7267 733d  mbols[-1], args=
+0001fd90: 6e65 775f 7265 7475 726e 290a 0a0a 6465  new_return)...de
+0001fda0: 6620 5f75 7064 6174 655f 6261 636b 7761  f _update_backwa
+0001fdb0: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
+0001fdc0: 645f 666f 725f 6261 636b 7761 7264 2862  d_for_backward(b
+0001fdd0: 6163 6b77 6172 645f 7472 6163 653a 2054  ackward_trace: T
+0001fde0: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
+0001fdf0: 6261 636b 7761 7264 3a20 5365 7175 656e  backward: Sequen
+0001fe00: 6365 5b56 6172 6961 626c 655d 2920 2d3e  ce[Variable]) ->
+0001fe10: 204e 6f6e 653a 0a20 2020 2022 2222 5570   None:.    """Up
+0001fe20: 6461 7465 7320 7468 6520 6261 636b 7761  dates the backwa
+0001fe30: 7264 2074 7261 6365 2077 6974 6820 6e65  rd trace with ne
+0001fe40: 7720 7361 7665 645f 666f 725f 6261 636b  w saved_for_back
+0001fe50: 7761 7264 2e0a 0a20 2020 2054 6869 7320  ward...    This 
+0001fe60: 6973 206e 6563 6573 7361 7279 2062 6563  is necessary bec
+0001fe70: 6175 7365 2074 6865 2075 7064 6174 6564  ause the updated
+0001fe80: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001fe90: 6172 6420 6973 0a20 2020 206e 6f74 2061  ard is.    not a
+0001fea0: 7661 696c 6162 6c65 2077 6865 6e20 7468  vailable when th
+0001feb0: 6520 6261 636b 7761 7264 2074 7261 6365  e backward trace
+0001fec0: 2069 7320 636f 6e73 7472 7563 7465 642e   is constructed.
+0001fed0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001fee0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+0001fef0: 6365 2028 5472 6163 6529 3a20 4261 636b  ce (Trace): Back
+0001ff00: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
+0001ff10: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
+0001ff20: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001ff30: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
+0001ff40: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
+0001ff50: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
+0001ff60: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
+0001ff70: 7570 6461 7465 2074 6865 2062 6163 6b77  update the backw
+0001ff80: 6172 6420 7472 6163 652e 0a20 2020 2022  ard trace..    "
+0001ff90: 2222 0a0a 2020 2020 6465 6620 756e 7061  ""..    def unpa
+0001ffa0: 636b 696e 675f 666e 2873 6176 6564 5f66  cking_fn(saved_f
+0001ffb0: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
+0001ffc0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+0001ffd0: 2020 7061 7373 0a0a 2020 2020 636f 7461    pass..    cota
+0001ffe0: 6e67 656e 7473 203d 2062 6163 6b77 6172  ngents = backwar
+0001fff0: 645f 7472 6163 652e 6172 6773 5b31 5d0a  d_trace.args[1].
+00020000: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
+00020010: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
+00020020: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
+00020030: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
+00020040: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
+00020050: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
+00020060: 7761 7264 290a 2020 2020 756e 7061 636b  ward).    unpack
+00020070: 696e 675f 7472 6163 6520 3d20 636f 6e73  ing_trace = cons
+00020080: 7472 7563 745f 7472 6163 6528 7265 6e61  truct_trace(rena
+00020090: 6d65 5f70 726f 7869 6573 3d46 616c 7365  me_proxies=False
+000200a0: 2c20 7573 655f 6463 653d 4661 6c73 6529  , use_dce=False)
+000200b0: 280a 2020 2020 2020 2020 756e 7061 636b  (.        unpack
+000200c0: 696e 675f 666e 2c20 2873 6176 6564 5f74  ing_fn, (saved_t
+000200d0: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
+000200e0: 6865 7229 2c20 636f 7461 6e67 656e 7473  her), cotangents
+000200f0: 0a20 2020 2029 0a20 2020 2061 7373 6572  .    ).    asser
+00020100: 7420 756e 7061 636b 696e 675f 7472 6163  t unpacking_trac
+00020110: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
+00020120: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
+00020130: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
+00020140: 524e 0a0a 2020 2020 6261 636b 7761 7264  RN..    backward
+00020150: 5f74 7261 6365 2e61 7267 7320 3d20 756e  _trace.args = un
+00020160: 7061 636b 696e 675f 7472 6163 652e 6172  packing_trace.ar
+00020170: 6773 0a20 2020 2062 6163 6b77 6172 645f  gs.    backward_
+00020180: 7472 6163 655f 6273 796d 735f 7769 7468  trace_bsyms_with
+00020190: 6f75 745f 756e 7061 636b 696e 6720 3d20  out_unpacking = 
+000201a0: 280a 2020 2020 2020 2020 6273 796d 0a20  (.        bsym. 
+000201b0: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
+000201c0: 696e 2062 6163 6b77 6172 645f 7472 6163  in backward_trac
+000201d0: 652e 626f 756e 645f 7379 6d62 6f6c 730a  e.bound_symbols.
+000201e0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
+000201f0: 7379 6d2e 6964 0a20 2020 2020 2020 206e  sym.id.        n
+00020200: 6f74 2069 6e20 280a 2020 2020 2020 2020  ot in (.        
+00020210: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00020220: 732e 554e 5041 434b 5f45 4d50 5459 5f44  s.UNPACK_EMPTY_D
+00020230: 4943 542c 0a20 2020 2020 2020 2020 2020  ICT,.           
+00020240: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
+00020250: 4e50 4143 4b5f 4b45 592c 0a20 2020 2020  NPACK_KEY,.     
+00020260: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
+00020270: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
+00020280: 454e 4345 2c0a 2020 2020 2020 2020 2020  ENCE,.          
+00020290: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+000202a0: 554e 5041 434b 5f54 5249 5649 414c 2c0a  UNPACK_TRIVIAL,.
+000202b0: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
+000202c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+000202d0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
+000202e0: 203d 206c 6973 7428 282a 756e 7061 636b   = list((*unpack
+000202f0: 696e 675f 7472 6163 652e 626f 756e 645f  ing_trace.bound_
+00020300: 7379 6d62 6f6c 735b 3a2d 315d 2c20 2a62  symbols[:-1], *b
+00020310: 6163 6b77 6172 645f 7472 6163 655f 6273  ackward_trace_bs
+00020320: 796d 735f 7769 7468 6f75 745f 756e 7061  yms_without_unpa
+00020330: 636b 696e 6729 290a 0a0a 2320 4e4f 5445  cking))...# NOTE
+00020340: 3a20 5265 7475 726e 696e 6720 6e61 6d65  : Returning name
+00020350: 6474 7570 6c65 7320 6672 6f6d 2063 6f6d  dtuples from com
+00020360: 7069 6c65 6420 6675 6e63 7469 6f6e 7320  piled functions 
+00020370: 646f 6573 6e27 7420 776f 726b 2e20 5365  doesn't work. Se
+00020380: 653a 0a23 2022 416c 6c6f 7720 7265 7475  e:.# "Allow retu
+00020390: 726e 696e 6720 6e61 6d65 6474 7570 6c65  rning namedtuple
+000203a0: 7320 6672 6f6d 2063 6f6d 7069 6c65 6420  s from compiled 
+000203b0: 6675 6e63 7469 6f6e 7322 0a23 204e 6f74  functions".# Not
+000203c0: 6520 5b47 7261 6420 666f 7277 6172 6420  e [Grad forward 
+000203d0: 6f75 7470 7574 2073 7065 635d 0a23 2049  output spec].# I
+000203e0: 6620 6974 2064 6964 2077 6f72 6b20 6974  f it did work it
+000203f0: 2077 6f75 6c64 2062 6520 6e69 6365 2074   would be nice t
+00020400: 6f20 7573 6520 7468 6973 206e 616d 6564  o use this named
+00020410: 7475 706c 650a 2320 696e 7374 6561 6420  tuple.# instead 
+00020420: 6f66 2074 6865 2070 6c61 696e 2074 7570  of the plain tup
+00020430: 6c65 206f 7220 6469 6374 2074 6861 7420  le or dict that 
+00020440: 7765 2772 6520 7573 696e 6720 6e6f 772e  we're using now.
+00020450: 0a54 6f72 6368 4175 746f 6772 6164 466f  .TorchAutogradFo
+00020460: 7277 6172 6444 6174 6120 3d20 6e61 6d65  rwardData = name
+00020470: 6474 7570 6c65 280a 2020 2020 2254 6f72  dtuple(.    "Tor
+00020480: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
+00020490: 6444 6174 6122 2c0a 2020 2020 5b22 6f75  dData",.    ["ou
+000204a0: 7470 7574 222c 2022 666c 6174 5f61 7267  tput", "flat_arg
+000204b0: 7322 2c20 2266 6c61 745f 6f75 7470 7574  s", "flat_output
+000204c0: 225d 2c0a 290a 0a0a 6465 6620 666f 7277  "],.)...def forw
+000204d0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
+000204e0: 5f66 726f 6d5f 7472 6163 6528 7472 6163  _from_trace(trac
+000204f0: 653a 2054 7261 6365 2c20 746f 7263 685f  e: Trace, torch_
+00020500: 6175 746f 6772 6164 3d46 616c 7365 2920  autograd=False) 
+00020510: 2d3e 2046 6f72 7761 7264 4261 636b 7761  -> ForwardBackwa
+00020520: 7264 5472 6163 6573 3a0a 2020 2020 2222  rdTraces:.    ""
+00020530: 2247 656e 6572 6174 6573 2074 6865 2066  "Generates the f
+00020540: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
+00020550: 6172 6420 7061 7373 6573 2066 726f 6d20  ard passes from 
+00020560: 6120 7472 6163 652e 0a0a 2020 2020 5468  a trace...    Th
+00020570: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
+00020580: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
+00020590: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
+000205a0: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
+000205b0: 2020 2020 6061 7567 6d65 6e74 6564 5f66      `augmented_f
+000205c0: 6f72 7761 7264 5f70 6173 7360 2061 6e64  orward_pass` and
+000205d0: 2060 6261 636b 7761 7264 5f70 6173 7360   `backward_pass`
+000205e0: 2e20 5468 6520 6d61 696e 2064 6966 6665  . The main diffe
+000205f0: 7265 6e63 6520 6973 2074 6861 740a 2020  rence is that.  
+00020600: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
+00020610: 646f 6573 206e 6f74 2072 6571 7569 7265  does not require
+00020620: 2074 6865 2075 7365 7220 746f 2070 726f   the user to pro
+00020630: 7669 6465 206e 6577 2069 6e70 7574 7320  vide new inputs 
+00020640: 666f 7220 7468 650a 2020 2020 7472 6163  for the.    trac
+00020650: 6520 6576 616c 7561 7469 6f6e 2e20 496e  e evaluation. In
+00020660: 7374 6561 6420 6974 2075 7365 7320 7468  stead it uses th
+00020670: 6520 696e 7075 7473 2074 6861 7420 7765  e inputs that we
+00020680: 7265 2075 7365 6420 746f 2063 6f6e 7374  re used to const
+00020690: 7275 6374 0a20 2020 2074 6865 2074 7261  ruct.    the tra
+000206a0: 6365 2e0a 0a20 2020 2041 7267 733a 0a20  ce...    Args:. 
+000206b0: 2020 2020 2020 2074 7261 6365 2028 5472         trace (Tr
+000206c0: 6163 6529 3a20 5472 6163 6520 746f 2067  ace): Trace to g
+000206d0: 656e 6572 6174 6520 7468 6520 666f 7277  enerate the forw
+000206e0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+000206f0: 2070 6173 7365 7320 6672 6f6d 2e0a 0a20   passes from... 
+00020700: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00020710: 2020 2020 466f 7277 6172 6442 6163 6b77      ForwardBackw
+00020720: 6172 6454 7261 6365 733a 2041 206e 616d  ardTraces: A nam
+00020730: 6564 2074 7570 6c65 2063 6f6e 7461 696e  ed tuple contain
+00020740: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
+00020750: 616e 6420 6261 636b 7761 7264 0a20 2020  and backward.   
+00020760: 2020 2020 2020 2020 2074 7261 6365 732e           traces.
+00020770: 0a0a 2020 2020 4578 616d 706c 653a 0a20  ..    Example:. 
+00020780: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
+00020790: 7420 746f 7263 680a 2020 2020 2020 2020  t torch.        
+000207a0: 3e3e 3e20 6672 6f6d 2074 6875 6e64 6572  >>> from thunder
+000207b0: 2069 6d70 6f72 7420 636f 6d70 696c 652c   import compile,
+000207c0: 206c 6173 745f 7472 6163 6573 0a20 2020   last_traces.   
+000207d0: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
+000207e0: 756e 6465 722e 636f 7265 2e74 7261 6e73  under.core.trans
+000207f0: 666f 726d 7320 696d 706f 7274 2066 6f72  forms import for
+00020800: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
+00020810: 645f 6672 6f6d 5f74 7261 6365 0a20 2020  d_from_trace.   
+00020820: 2020 2020 203e 3e3e 2064 6566 2066 2878       >>> def f(x
+00020830: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
+00020840: 2020 2072 6574 7572 6e20 746f 7263 682e     return torch.
+00020850: 7369 6e28 7829 0a20 2020 2020 2020 203e  sin(x).        >
+00020860: 3e3e 2078 203d 2074 6f72 6368 2e74 656e  >> x = torch.ten
+00020870: 736f 7228 332e 3029 0a20 2020 2020 2020  sor(3.0).       
+00020880: 203e 3e3e 2063 6620 3d20 636f 6d70 696c   >>> cf = compil
+00020890: 6528 6629 0a20 2020 2020 2020 203e 3e3e  e(f).        >>>
+000208a0: 206f 7574 203d 2063 6628 7829 0a20 2020   out = cf(x).   
+000208b0: 2020 2020 203e 3e3e 2074 7261 6365 203d       >>> trace =
+000208c0: 206c 6173 745f 7472 6163 6573 2863 6629   last_traces(cf)
+000208d0: 5b30 5d0a 2020 2020 2020 2020 3e3e 3e20  [0].        >>> 
+000208e0: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
+000208f0: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
+00020900: 7472 6163 6529 0a20 2020 2020 2020 202e  trace).        .
+00020910: 2e2e 2046 6f72 7761 7264 4261 636b 7761  .. ForwardBackwa
+00020920: 7264 5472 6163 6573 280a 2020 2020 2020  rdTraces(.      
+00020930: 2020 2e2e 2e20 666f 7277 6172 645f 7472    ... forward_tr
+00020940: 6163 653d 2320 696d 706f 7274 2074 6875  ace=# import thu
+00020950: 6e64 6572 2061 7320 7468 756e 6465 720a  nder as thunder.
+00020960: 2020 2020 2020 2020 2e2e 2e20 2320 696d          ... # im
+00020970: 706f 7274 2074 6875 6e64 6572 2e63 6f72  port thunder.cor
+00020980: 652e 7072 696d 7320 6173 2070 7269 6d73  e.prims as prims
+00020990: 0a20 2020 2020 2020 202e 2e2e 2069 6d70  .        ... imp
+000209a0: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
+000209b0: 2020 2e2e 2e0a 2020 2020 2020 2020 2e2e    ....        ..
+000209c0: 2e20 4074 6f72 6368 2e6e 6f5f 6772 6164  . @torch.no_grad
+000209d0: 2829 0a20 2020 2020 2020 202e 2e2e 2064  ().        ... d
+000209e0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
+000209f0: 7761 7264 5f66 6e28 2a61 7267 7329 3a0a  ward_fn(*args):.
+00020a00: 2020 2020 2020 2020 2e2e 2e20 2020 2320          ...   # 
+00020a10: 6172 6773 3a20 2243 6f6c 6c65 6374 696f  args: "Collectio
+00020a20: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
+00020a30: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
+00020a40: 2020 2020 2020 2e2e 2e20 2020 7430 2c20        ...   t0, 
+00020a50: 5c0a 2020 2020 2020 2020 2e2e 2e20 2020  \.        ...   
+00020a60: 3d20 6172 6773 0a20 2020 2020 2020 202e  = args.        .
+00020a70: 2e2e 2020 2074 3120 3d20 7072 696d 732e  ..   t1 = prims.
+00020a80: 7369 6e28 7430 2920 2023 2074 313a 2022  sin(t0)  # t1: "
+00020a90: 6370 7520 6633 325b 5d22 0a20 2020 2020  cpu f32[]".     
+00020aa0: 2020 202e 2e2e 2020 2072 6574 7572 6e20     ...   return 
+00020ab0: 7431 2c20 2874 302c 292c 0a20 2020 2020  t1, (t0,),.     
+00020ac0: 2020 202e 2e2e 2062 6163 6b77 6172 645f     ... backward_
+00020ad0: 7472 6163 653d 2320 696d 706f 7274 2074  trace=# import t
+00020ae0: 6875 6e64 6572 2061 7320 7468 756e 6465  hunder as thunde
+00020af0: 720a 2020 2020 2020 2020 2e2e 2e20 2320  r.        ... # 
+00020b00: 696d 706f 7274 2074 6875 6e64 6572 2e63  import thunder.c
+00020b10: 6f72 652e 7072 696d 7320 6173 2070 7269  ore.prims as pri
+00020b20: 6d73 0a20 2020 2020 2020 202e 2e2e 2069  ms.        ... i
+00020b30: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
+00020b40: 2020 2020 2e2e 2e0a 2020 2020 2020 2020      ....        
+00020b50: 2e2e 2e20 4074 6f72 6368 2e6e 6f5f 6772  ... @torch.no_gr
+00020b60: 6164 2829 0a20 2020 2020 2020 202e 2e2e  ad().        ...
+00020b70: 2064 6566 2062 6163 6b77 6172 645f 666e   def backward_fn
+00020b80: 2873 6176 6564 5f66 6f72 5f62 6163 6b77  (saved_for_backw
+00020b90: 6172 642c 2063 6f74 616e 6765 6e74 7329  ard, cotangents)
+00020ba0: 3a0a 2020 2020 2020 2020 2e2e 2e20 2020  :.        ...   
+00020bb0: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
+00020bc0: 7761 7264 3a20 2243 6f6c 6c65 6374 696f  ward: "Collectio
+00020bd0: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
+00020be0: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
+00020bf0: 2020 2020 2020 2e2e 2e20 2020 2320 636f        ...   # co
+00020c00: 7461 6e67 656e 7473 3a20 2263 7075 2066  tangents: "cpu f
+00020c10: 3332 5b5d 2220 3d20 2063 6f74 616e 6765  32[]" =  cotange
+00020c20: 6e74 7320 2028 7472 6976 6961 6c20 756e  nts  (trivial un
+00020c30: 7061 636b 290a 2020 2020 2020 2020 2e2e  pack).        ..
+00020c40: 2e20 2020 7430 2c20 5c0a 2020 2020 2020  .   t0, \.      
+00020c50: 2020 2e2e 2e20 2020 3d20 7361 7665 645f    ...   = saved_
+00020c60: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
+00020c70: 2020 2020 202e 2e2e 2020 2074 3120 3d20       ...   t1 = 
+00020c80: 7072 696d 732e 636f 7328 7430 2920 2023  prims.cos(t0)  #
+00020c90: 2074 313a 2022 6370 7520 6633 325b 5d22   t1: "cpu f32[]"
+00020ca0: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
+00020cb0: 3220 3d20 7072 696d 732e 6d75 6c28 636f  2 = prims.mul(co
+00020cc0: 7461 6e67 656e 7473 2c20 7431 2920 2023  tangents, t1)  #
+00020cd0: 2074 323a 2022 6370 7520 6633 325b 5d22   t2: "cpu f32[]"
+00020ce0: 0a20 2020 2020 2020 202e 2e2e 2020 2072  .        ...   r
+00020cf0: 6574 7572 6e20 2874 322c 2929 0a20 2020  eturn (t2,)).   
+00020d00: 2022 2222 0a0a 2020 2020 6f75 7470 7574   """..    output
+00020d10: 5f73 7065 6320 3d20 4e6f 6e65 0a0a 2020  _spec = None..  
+00020d20: 2020 6465 6620 6175 676d 656e 7465 645f    def augmented_
+00020d30: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
+00020d40: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00020d50: 2020 2020 2072 6573 756c 742c 2065 6e76       result, env
+00020d60: 203d 2061 7567 6d65 6e74 6564 5f66 6f72   = augmented_for
+00020d70: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
+00020d80: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
+00020d90: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00020da0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00020db0: 7264 203d 2064 6563 6f6e 7374 7275 6374  rd = deconstruct
+00020dc0: 5f66 6f72 7761 7264 5f65 6e76 5f66 6f72  _forward_env_for
+00020dd0: 5f62 6163 6b77 6172 6428 7472 6163 652c  _backward(trace,
+00020de0: 2065 6e76 290a 2020 2020 2020 2020 6966   env).        if
+00020df0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+00020e00: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
+00020e10: 6c6f 6361 6c20 6f75 7470 7574 5f73 7065  local output_spe
+00020e20: 630a 2020 2020 2020 2020 2020 2020 666c  c.            fl
+00020e30: 6174 5f61 7267 732c 205f 203d 2074 7265  at_args, _ = tre
+00020e40: 655f 666c 6174 7465 6e28 2861 7267 732c  e_flatten((args,
+00020e50: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
+00020e60: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
+00020e70: 742c 206f 7574 7075 745f 7370 6563 203d  t, output_spec =
+00020e80: 2074 7265 655f 666c 6174 7465 6e28 7265   tree_flatten(re
+00020e90: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00020ea0: 2020 666c 6174 5f6f 7574 7075 7420 3d20    flat_output = 
+00020eb0: 7475 706c 6528 666c 6174 5f6f 7574 7075  tuple(flat_outpu
+00020ec0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
+00020ed0: 2053 6565 204e 6f74 6520 5b47 7261 6420   See Note [Grad 
+00020ee0: 666f 7277 6172 6420 6f75 7470 7574 2073  forward output s
+00020ef0: 7065 635d 0a20 2020 2020 2020 2020 2020  pec].           
+00020f00: 2066 6f72 5f61 7574 6f67 7261 6420 3d20   for_autograd = 
+00020f10: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
+00020f20: 7761 7264 4461 7461 280a 2020 2020 2020  wardData(.      
+00020f30: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00020f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020f50: 2020 666c 6174 5f61 7267 732c 0a20 2020    flat_args,.   
+00020f60: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+00020f70: 745f 6f75 7470 7574 2c0a 2020 2020 2020  t_output,.      
+00020f80: 2020 2020 2020 292e 5f61 7364 6963 7428        )._asdict(
+00020f90: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00020fa0: 7475 726e 2028 666f 725f 6175 746f 6772  turn (for_autogr
+00020fb0: 6164 2c20 7361 7665 645f 666f 725f 6261  ad, saved_for_ba
+00020fc0: 636b 7761 7264 290a 2020 2020 2020 2020  ckward).        
+00020fd0: 7265 7475 726e 2072 6573 756c 742c 2073  return result, s
+00020fe0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+00020ff0: 640a 0a20 2020 2023 2043 6f70 7920 7468  d..    # Copy th
+00021000: 6520 7369 676e 6174 7572 6520 6f66 2074  e signature of t
+00021010: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
+00021020: 7469 6f6e 2073 6f20 7468 6174 2074 6865  tion so that the
+00021030: 2061 7267 756d 656e 7473 2061 7265 0a20   arguments are. 
+00021040: 2020 2023 206e 616d 6564 2063 6f72 7265     # named corre
+00021050: 6374 6c79 2069 6e20 7468 6520 6175 676d  ctly in the augm
+00021060: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
+00021070: 7373 2069 6e73 7465 6164 206f 6620 6265  ss instead of be
+00021080: 696e 6720 6e61 6d65 640a 2020 2020 2320  ing named.    # 
+00021090: 2261 7267 7322 2061 6e64 2022 6b77 6172  "args" and "kwar
+000210a0: 6773 222e 0a20 2020 2061 7567 6d65 6e74  gs"..    augment
+000210b0: 6564 5f66 6f72 7761 7264 5f66 6e2e 5f5f  ed_forward_fn.__
+000210c0: 7369 676e 6174 7572 655f 5f20 3d20 696e  signature__ = in
+000210d0: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
+000210e0: 7472 6163 652e 666e 206f 7220 7472 6163  trace.fn or trac
+000210f0: 652e 7079 7468 6f6e 5f63 616c 6c61 626c  e.python_callabl
+00021100: 6528 2929 0a0a 2020 2020 6465 6620 6f6e  e())..    def on
+00021110: 6573 5f6c 696b 6528 7829 3a0a 2020 2020  es_like(x):.    
+00021120: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00021130: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
+00021140: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00021150: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
+00021160: 782c 2066 696c 6c5f 7661 6c75 653d 3129  x, fill_value=1)
+00021170: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00021180: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
+00021190: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
+000211a0: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
+000211b0: 6528 782e 7661 6c75 6529 2831 290a 2020  e(x.value)(1).  
+000211c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000211d0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+000211e0: 6f6e 650a 0a20 2020 2066 6f72 7761 7264  one..    forward
+000211f0: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
+00021200: 6374 5f74 7261 6365 2829 2861 7567 6d65  ct_trace()(augme
+00021210: 6e74 6564 5f66 6f72 7761 7264 5f66 6e2c  nted_forward_fn,
+00021220: 202a 7472 6163 652e 6172 6773 2c20 2a2a   *trace.args, **
+00021230: 7472 6163 652e 6b77 6172 6773 290a 2020  trace.kwargs).  
+00021240: 2020 2320 5765 2073 6574 2066 6f72 7761    # We set forwa
+00021250: 7264 2074 7261 6365 2074 6f20 636f 6e73  rd trace to cons
+00021260: 7472 7563 7420 7072 6f78 6965 7320 6265  truct proxies be
+00021270: 6361 7573 6520 7765 206e 6565 6420 7468  cause we need th
+00021280: 6573 6520 7072 6f78 6965 7320 746f 0a20  ese proxies to. 
+00021290: 2020 2023 2068 6176 6520 6469 6666 6572     # have differ
+000212a0: 656e 7420 6e61 6d65 7320 7468 616e 2074  ent names than t
+000212b0: 6865 206f 6e65 7320 696e 2074 6865 2066  he ones in the f
+000212c0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
+000212d0: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
+000212e0: 7261 6365 6374 785f 746f 6b65 6e20 3d20  racectx_token = 
+000212f0: 7365 745f 7472 6163 6563 7478 2866 6f72  set_tracectx(for
+00021300: 7761 7264 5f74 7261 6365 290a 2020 2020  ward_trace).    
+00021310: 2020 2020 2320 5765 2064 6f6e 2774 2077      # We don't w
+00021320: 616e 7420 746f 2072 6563 6f72 6420 7468  ant to record th
+00021330: 6f73 6520 6f6e 6573 5f6c 696b 6520 6361  ose ones_like ca
+00021340: 6c6c 7320 696e 2074 6865 2066 6f72 7761  lls in the forwa
+00021350: 7264 2074 7261 6365 2e0a 2020 2020 2020  rd trace..      
+00021360: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
+00021370: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
+00021380: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
+00021390: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
+000213a0: 2020 2020 2020 2020 2320 4974 2773 2061          # It's a
+000213b0: 7373 756d 6564 2074 6861 7420 666f 7277  ssumed that forw
+000213c0: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
+000213d0: 5b30 5d20 6973 2061 2064 6963 7420 6672  [0] is a dict fr
+000213e0: 6f6d 2054 6f72 6368 4175 746f 6772 6164  om TorchAutograd
+000213f0: 466f 7277 6172 6444 6174 610a 2020 2020  ForwardData.    
+00021400: 2020 2020 2020 2020 2020 2020 666c 6174              flat
+00021410: 5f6f 7574 7075 7420 3d20 666f 7277 6172  _output = forwar
+00021420: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
+00021430: 5d5b 2266 6c61 745f 6f75 7470 7574 225d  ]["flat_output"]
+00021440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021450: 2063 6f74 616e 6765 6e74 7320 3d20 7574   cotangents = ut
+00021460: 696c 732e 7365 7175 656e 6369 6679 2874  ils.sequencify(t
+00021470: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
+00021480: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
+00021490: 666c 6174 5f6f 7574 7075 7429 290a 2020  flat_output)).  
+000214a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000214b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214c0: 636f 7461 6e67 656e 7473 203d 2075 7469  cotangents = uti
+000214d0: 6c73 2e73 6571 7565 6e63 6966 7928 7472  ls.sequencify(tr
+000214e0: 6565 5f6d 6170 286c 616d 6264 6120 763a  ee_map(lambda v:
+000214f0: 206f 6e65 735f 6c69 6b65 2876 292c 2074   ones_like(v), t
+00021500: 7261 6365 2e6f 7574 7075 7429 290a 2020  race.output)).  
+00021510: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+00021520: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
+00021530: 7828 7472 6163 6563 7478 5f74 6f6b 656e  x(tracectx_token
+00021540: 290a 0a20 2020 2064 6566 2062 6163 6b77  )..    def backw
+00021550: 6172 645f 666e 2873 6176 6564 5f66 6f72  ard_fn(saved_for
+00021560: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
+00021570: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
+00021580: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
+00021590: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
+000215a0: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
+000215b0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+000215c0: 7761 7264 290a 2020 2020 2020 2020 6966  ward).        if
+000215d0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+000215e0: 0a20 2020 2020 2020 2020 2020 2063 6f74  .            cot
+000215f0: 616e 6765 6e74 7320 3d20 7472 6565 5f75  angents = tree_u
+00021600: 6e66 6c61 7474 656e 2863 6f74 616e 6765  nflatten(cotange
+00021610: 6e74 732c 206f 7574 7075 745f 7370 6563  nts, output_spec
+00021620: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+00021630: 6261 636b 7761 7264 5f70 6173 7328 656e  backward_pass(en
+00021640: 762c 2074 7261 6365 2c20 636f 7461 6e67  v, trace, cotang
+00021650: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
+00021660: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+00021670: 0a20 2020 2020 2020 2020 2020 2067 6b77  .            gkw
+00021680: 6172 6773 203d 206f 7574 5b2d 315d 2069  args = out[-1] i
+00021690: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+000216a0: 5b2d 315d 2c20 6469 6374 2920 656c 7365  [-1], dict) else
+000216b0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+000216c0: 6761 7267 7320 3d20 6f75 745b 3a2d 315d  gargs = out[:-1]
+000216d0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+000216e0: 7574 5b2d 315d 2c20 6469 6374 2920 656c  ut[-1], dict) el
+000216f0: 7365 206f 7574 0a20 2020 2020 2020 2020  se out.         
+00021700: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
+00021710: 2067 6b77 6172 6773 2e67 6574 286b 2c20   gkwargs.get(k, 
+00021720: 4e6f 6e65 2920 666f 7220 6b20 696e 2074  None) for k in t
+00021730: 7261 6365 2e6b 7761 7267 737d 0a20 2020  race.kwargs}.   
+00021740: 2020 2020 2020 2020 206f 7574 203d 2028           out = (
+00021750: 2a67 6172 6773 2c20 676b 7761 7267 7329  *gargs, gkwargs)
+00021760: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00021770: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+00021780: 6f75 7429 5b30 5d0a 2020 2020 2020 2020  out)[0].        
+00021790: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+000217a0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+000217b0: 7264 203d 2066 6f72 7761 7264 5f74 7261  rd = forward_tra
+000217c0: 6365 2e6f 7574 7075 745b 315d 0a20 2020  ce.output[1].   
+000217d0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
+000217e0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+000217f0: 6528 7265 6e61 6d65 5f70 726f 7869 6573  e(rename_proxies
+00021800: 3d46 616c 7365 2928 6261 636b 7761 7264  =False)(backward
+00021810: 5f66 6e2c 2073 6176 6564 5f66 6f72 5f62  _fn, saved_for_b
+00021820: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
+00021830: 6e74 7329 0a0a 2020 2020 2320 5765 2061  nts)..    # We a
+00021840: 7265 2064 6f6e 6520 7769 7468 2063 6f6e  re done with con
+00021850: 7374 7275 6374 696e 6720 7468 6520 666f  structing the fo
+00021860: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
+00021870: 7264 2070 6173 7365 7320 6174 2074 6869  rd passes at thi
+00021880: 730a 2020 2020 2320 7374 6167 652e 2054  s.    # stage. T
+00021890: 6865 2066 6f6c 6c6f 7769 6e67 2069 7320  he following is 
+000218a0: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
+000218b0: 6573 7361 7279 2c20 6275 7420 6974 2773  essary, but it's
+000218c0: 2067 6f6f 6420 746f 2066 696c 7465 720a   good to filter.
+000218d0: 2020 2020 2320 6f75 7420 7468 6520 756e      # out the un
+000218e0: 7573 6564 2065 6c65 6d65 6e74 7320 6f66  used elements of
+000218f0: 2074 6865 2073 6176 6564 5f66 6f72 5f62   the saved_for_b
+00021900: 6163 6b77 6172 6420 616e 6420 666c 6174  ackward and flat
+00021910: 7465 6e20 6974 2066 6f72 206d 6f72 650a  ten it for more.
+00021920: 2020 2020 2320 636f 6d70 6163 7420 6261      # compact ba
+00021930: 636b 7761 7264 2074 7261 6365 2e0a 0a20  ckward trace... 
+00021940: 2020 2023 204e 6f77 2077 6520 6361 6e20     # Now we can 
+00021950: 6465 7465 726d 696e 6520 6578 6163 746c  determine exactl
+00021960: 7920 7768 6174 2773 2075 7365 6420 696e  y what's used in
+00021970: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
+00021980: 7373 2066 726f 6d20 7468 650a 2020 2020  ss from the.    
+00021990: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
+000219a0: 7761 7264 2e20 5765 2063 616e 2066 6c61  ward. We can fla
+000219b0: 7474 656e 2061 6e64 2066 696c 7465 7220  tten and filter 
+000219c0: 7468 6520 7361 7665 645f 666f 725f 6261  the saved_for_ba
+000219d0: 636b 7761 7264 0a20 2020 2063 6f6e 7375  ckward.    consu
+000219e0: 6d65 7273 203d 2075 7469 6c73 2e63 6f6e  mers = utils.con
+000219f0: 7375 6d65 7273 2862 6163 6b77 6172 645f  sumers(backward_
+00021a00: 7472 6163 6529 0a0a 2020 2020 2320 466f  trace)..    # Fo
+00021a10: 7277 6172 6427 7320 616e 6420 6261 636b  rward's and back
+00021a20: 7761 7264 2773 2022 7361 7665 645f 666f  ward's "saved_fo
+00021a30: 725f 6261 636b 7761 7264 2220 6172 6520  r_backward" are 
+00021a40: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
+00021a50: 7468 6520 7361 6d65 0a20 2020 2023 2061  the same.    # a
+00021a60: 7320 7468 6520 7361 7665 645f 666f 725f  s the saved_for_
+00021a70: 6261 636b 7761 7264 2c20 6265 6361 7573  backward, becaus
+00021a80: 6520 736f 6d65 206f 7220 616c 6c20 656c  e some or all el
+00021a90: 656d 656e 7473 206f 6620 7468 650a 2020  ements of the.  
+00021aa0: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
+00021ab0: 636b 7761 7264 2072 6573 756c 7473 206d  ckward results m
+00021ac0: 6967 6874 2062 6520 7265 2d70 726f 7869  ight be re-proxi
+00021ad0: 6669 6564 2e0a 2020 2020 6277 5f66 6c61  fied..    bw_fla
+00021ae0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+00021af0: 7761 7264 2c20 7370 6563 203d 2074 7265  ward, spec = tre
+00021b00: 655f 666c 6174 7465 6e28 6261 636b 7761  e_flatten(backwa
+00021b10: 7264 5f74 7261 6365 2e61 7267 735b 305d  rd_trace.args[0]
+00021b20: 290a 2020 2020 6677 5f66 6c61 745f 7361  ).    fw_flat_sa
+00021b30: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021b40: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
+00021b50: 656e 2866 6f72 7761 7264 5f74 7261 6365  en(forward_trace
+00021b60: 2e6f 7574 7075 745b 315d 290a 2020 2020  .output[1]).    
+00021b70: 7573 6564 5f6d 6173 6b20 3d20 6c69 7374  used_mask = list
+00021b80: 286c 656e 2863 6f6e 7375 6d65 7273 2e67  (len(consumers.g
+00021b90: 6574 2878 2c20 2829 2929 203e 2030 2066  et(x, ())) > 0 f
+00021ba0: 6f72 2078 2069 6e20 6277 5f66 6c61 745f  or x in bw_flat_
+00021bb0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021bc0: 7264 290a 0a20 2020 2023 2044 6f6e 2774  rd)..    # Don't
+00021bd0: 2075 7365 2074 6865 2073 616d 6520 7661   use the same va
+00021be0: 7269 6162 6c65 2074 7769 6365 2069 6e20  riable twice in 
+00021bf0: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+00021c00: 730a 2020 2020 7365 656e 203d 2073 6574  s.    seen = set
+00021c10: 2829 0a20 2020 2066 726f 6d20 7468 756e  ().    from thun
+00021c20: 6465 722e 636f 7265 2e70 726f 7869 6573  der.core.proxies
+00021c30: 2069 6d70 6f72 7420 5661 7269 6162 6c65   import Variable
+00021c40: 0a0a 2020 2020 666f 7220 692c 2078 2069  ..    for i, x i
+00021c50: 6e20 656e 756d 6572 6174 6528 6677 5f66  n enumerate(fw_f
+00021c60: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
+00021c70: 636b 7761 7264 293a 0a20 2020 2020 2020  ckward):.       
+00021c80: 2078 203d 2076 6172 6961 626c 6569 6679   x = variableify
+00021c90: 2878 290a 2020 2020 2020 2020 6966 206e  (x).        if n
+00021ca0: 6f74 2069 7369 6e73 7461 6e63 6528 782c  ot isinstance(x,
+00021cb0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
+00021cc0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00021cd0: 0a20 2020 2020 2020 2069 6620 7820 696e  .        if x in
+00021ce0: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
+00021cf0: 2020 2075 7365 645f 6d61 736b 5b69 5d20     used_mask[i] 
+00021d00: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00021d10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021d20: 2020 7365 656e 2e61 6464 2878 290a 0a20    seen.add(x).. 
+00021d30: 2020 206f 6e6c 795f 7573 6564 5f66 775f     only_used_fw_
+00021d40: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021d50: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
+00021d60: 6573 7328 6677 5f66 6c61 745f 7361 7665  ess(fw_flat_save
+00021d70: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+00021d80: 7573 6564 5f6d 6173 6b29 290a 2020 2020  used_mask)).    
+00021d90: 6f6e 6c79 5f75 7365 645f 6277 5f73 6176  only_used_bw_sav
+00021da0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+00021db0: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
+00021dc0: 2862 775f 666c 6174 5f73 6176 6564 5f66  (bw_flat_saved_f
+00021dd0: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
+00021de0: 645f 6d61 736b 2929 0a0a 2020 2020 2320  d_mask))..    # 
+00021df0: 5765 206e 6565 6420 746f 2075 7064 6174  We need to updat
+00021e00: 6520 7468 6520 7472 6163 6573 2077 6974  e the traces wit
+00021e10: 6820 7468 6520 6e65 7720 7361 7665 645f  h the new saved_
+00021e20: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
+00021e30: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
+00021e40: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
+00021e50: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
+00021e60: 7761 7264 5f74 7261 6365 2c20 6f6e 6c79  ward_trace, only
+00021e70: 5f75 7365 645f 6677 5f73 6176 6564 5f66  _used_fw_saved_f
+00021e80: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+00021e90: 205f 7570 6461 7465 5f62 6163 6b77 6172   _update_backwar
+00021ea0: 645f 7769 7468 5f6e 6577 5f73 6176 6564  d_with_new_saved
+00021eb0: 5f66 6f72 5f62 6163 6b77 6172 6428 6261  _for_backward(ba
+00021ec0: 636b 7761 7264 5f74 7261 6365 2c20 6f6e  ckward_trace, on
+00021ed0: 6c79 5f75 7365 645f 6277 5f73 6176 6564  ly_used_bw_saved
+00021ee0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
+00021ef0: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
+00021f00: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
+00021f10: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
+00021f20: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
+00021f30: 7264 2070 6173 7322 2929 0a20 2020 2062  rd pass")).    b
+00021f40: 6163 6b77 6172 645f 7472 6163 652e 7365  ackward_trace.se
+00021f50: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
+00021f60: 6365 5072 6f76 656e 616e 6365 2822 4261  ceProvenance("Ba
+00021f70: 636b 7761 7264 2070 6173 7322 2929 0a20  ckward pass")). 
+00021f80: 2020 2072 6574 7572 6e20 466f 7277 6172     return Forwar
+00021f90: 6442 6163 6b77 6172 6454 7261 6365 7328  dBackwardTraces(
+00021fa0: 666f 7277 6172 645f 7472 6163 652c 2062  forward_trace, b
+00021fb0: 6163 6b77 6172 645f 7472 6163 6529 0a0a  ackward_trace)..
+00021fc0: 0a23 2064 6f20 7765 2068 6170 7065 6e20  .# do we happen 
+00021fd0: 746f 2077 616e 7420 746f 2072 6567 6973  to want to regis
+00021fe0: 7465 7220 606c 746f 7263 6860 206f 7073  ter `ltorch` ops
+00021ff0: 2073 7563 6820 6173 2060 6c74 6f72 6368   such as `ltorch
+00022000: 2e6c 6179 6572 5f6e 6f72 6d60 2061 7320  .layer_norm` as 
+00022010: 7765 6c6c 3f0a 6175 746f 6361 7374 5f69  well?.autocast_i
+00022020: 6d70 6c73 3a20 6469 6374 5b70 7269 6d73  mpls: dict[prims
+00022030: 2e50 7269 6d49 4473 2c20 4361 6c6c 6162  .PrimIDs, Callab
+00022040: 6c65 5d20 3d20 7b7d 0a0a 0a64 6566 2072  le] = {}...def r
+00022050: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
+00022060: 5f72 756c 6528 6f70 293a 0a20 2020 2064  _rule(op):.    d
+00022070: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
+00022080: 6329 3a0a 2020 2020 2020 2020 6175 746f  c):.        auto
+00022090: 6361 7374 5f69 6d70 6c73 5b6f 705d 203d  cast_impls[op] =
+000220a0: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
+000220b0: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
+000220c0: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
+000220d0: 0a0a 6465 6620 6d61 7962 655f 646f 776e  ..def maybe_down
+000220e0: 6361 7374 5f74 6f28 6474 7970 652c 2061  cast_to(dtype, a
+000220f0: 7267 7329 3a0a 2020 2020 616c 6c6f 7765  rgs):.    allowe
+00022100: 645f 646f 776e 6361 7374 5f74 7970 6573  d_downcast_types
+00022110: 203d 2028 6474 7970 6573 2e66 6c6f 6174   = (dtypes.float
+00022120: 3136 2c20 6474 7970 6573 2e62 666c 6f61  16, dtypes.bfloa
+00022130: 7431 362c 2064 7479 7065 732e 666c 6f61  t16, dtypes.floa
+00022140: 7433 3229 0a0a 2020 2020 6465 6620 6d61  t32)..    def ma
+00022150: 705f 666e 2861 293a 0a20 2020 2020 2020  p_fn(a):.       
+00022160: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
+00022170: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
+00022180: 6e64 2061 2e64 7479 7065 2069 6e20 616c  nd a.dtype in al
+00022190: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
+000221a0: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
+000221b0: 2020 7265 7475 726e 206d 6179 6265 5f63    return maybe_c
+000221c0: 6f6e 7665 7274 5f74 6f5f 6474 7970 6528  onvert_to_dtype(
+000221d0: 612c 2064 7479 7065 290a 2020 2020 2020  a, dtype).      
+000221e0: 2020 7265 7475 726e 2061 0a0a 2020 2020    return a..    
+000221f0: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
+00022200: 6d61 705f 666e 2c20 6172 6773 290a 0a0a  map_fn, args)...
+00022210: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
+00022220: 7374 5f72 756c 6528 2274 6f72 6368 2e6d  st_rule("torch.m
+00022230: 6174 6d75 6c22 290a 4072 6567 6973 7465  atmul").@registe
+00022240: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
+00022250: 7072 696d 732e 5072 696d 4944 732e 4d41  prims.PrimIDs.MA
+00022260: 544d 554c 290a 6465 6620 6175 746f 6361  TMUL).def autoca
+00022270: 7374 5f6d 6174 6d75 6c5f 7275 6c65 2861  st_matmul_rule(a
+00022280: 2c20 622c 2064 7479 7065 293a 0a20 2020  , b, dtype):.   
+00022290: 2022 2222 4175 746f 6361 7374 2072 756c   """Autocast rul
+000222a0: 6520 666f 7220 6d61 746d 756c 2222 220a  e for matmul""".
+000222b0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+000222c0: 2e6d 6174 6d75 6c28 2a28 6d61 7962 655f  .matmul(*(maybe_
+000222d0: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
+000222e0: 652c 2028 612c 2062 2929 2929 0a0a 0a40  e, (a, b))))...@
+000222f0: 7265 6769 7374 6572 5f61 7574 6f63 6173  register_autocas
+00022300: 745f 7275 6c65 2822 746f 7263 682e 6e6e  t_rule("torch.nn
+00022310: 2e66 756e 6374 696f 6e61 6c2e 6c69 6e65  .functional.line
+00022320: 6172 2229 0a40 7265 6769 7374 6572 5f61  ar").@register_a
+00022330: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
+00022340: 6d73 2e50 7269 6d49 4473 2e4c 494e 4541  ms.PrimIDs.LINEA
+00022350: 5229 0a64 6566 2061 7574 6f63 6173 745f  R).def autocast_
+00022360: 6c69 6e65 6172 5f72 756c 6528 612c 2077  linear_rule(a, w
+00022370: 2c20 6269 6173 2c20 6474 7970 6529 3a0a  , bias, dtype):.
+00022380: 2020 2020 6966 2062 6961 7320 6973 204e      if bias is N
+00022390: 6f6e 653a 0a20 2020 2020 2020 2023 2044  one:.        # D
+000223a0: 6f6e 2774 2070 6173 7320 6062 6961 7360  on't pass `bias`
+000223b0: 2074 6f20 6d61 7962 655f 646f 776e 6361   to maybe_downca
+000223c0: 7374 5f74 6f2e 0a20 2020 2020 2020 2064  st_to..        d
+000223d0: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
+000223e0: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
+000223f0: 2864 7479 7065 2c20 2861 2c20 7729 2920  (dtype, (a, w)) 
+00022400: 2b20 2862 6961 732c 290a 2020 2020 656c  + (bias,).    el
+00022410: 7365 3a0a 2020 2020 2020 2020 646f 776e  se:.        down
+00022420: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
+00022430: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
+00022440: 7970 652c 2028 612c 2077 2c20 6269 6173  ype, (a, w, bias
+00022450: 2929 0a0a 2020 2020 7265 7475 726e 2070  ))..    return p
+00022460: 7269 6d73 2e6c 696e 6561 7228 2a64 6f77  rims.linear(*dow
+00022470: 6e63 6173 745f 6172 6773 290a 0a0a 4072  ncast_args)...@r
+00022480: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
+00022490: 5f72 756c 6528 2274 6f72 6368 2e6e 6e2e  _rule("torch.nn.
+000224a0: 6675 6e63 7469 6f6e 616c 2e73 6361 6c65  functional.scale
+000224b0: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
+000224c0: 7465 6e74 696f 6e22 290a 6465 6620 6175  tention").def au
+000224d0: 746f 6361 7374 5f73 6361 6c65 645f 646f  tocast_scaled_do
+000224e0: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
+000224f0: 696f 6e28 0a20 2020 2071 7565 7279 2c0a  ion(.    query,.
+00022500: 2020 2020 6b65 792c 0a20 2020 2076 616c      key,.    val
+00022510: 7565 2c0a 2020 2020 6174 746e 5f6d 6173  ue,.    attn_mas
+00022520: 6b2c 0a20 2020 2064 726f 706f 7574 5f70  k,.    dropout_p
+00022530: 2c0a 2020 2020 6973 5f63 6175 7361 6c2c  ,.    is_causal,
+00022540: 0a20 2020 202a 2c0a 2020 2020 6474 7970  .    *,.    dtyp
+00022550: 652c 0a20 2020 2073 6361 6c65 2c0a 293a  e,.    scale,.):
+00022560: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00022570: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
+00022580: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
+00022590: 745f 6174 7465 6e74 696f 6e0a 0a20 2020  t_attention..   
+000225a0: 2071 2c20 6b2c 2076 203d 206d 6179 6265   q, k, v = maybe
+000225b0: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
+000225c0: 7065 2c20 2871 7565 7279 2c20 6b65 792c  pe, (query, key,
+000225d0: 2076 616c 7565 2929 0a20 2020 2072 6574   value)).    ret
+000225e0: 7572 6e20 7363 616c 6564 5f64 6f74 5f70  urn scaled_dot_p
+000225f0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
+00022600: 2871 2c20 6b2c 2076 2c20 6174 746e 5f6d  (q, k, v, attn_m
+00022610: 6173 6b2c 2064 726f 706f 7574 5f70 2c20  ask, dropout_p, 
+00022620: 6973 5f63 6175 7361 6c2c 2073 6361 6c65  is_causal, scale
+00022630: 3d73 6361 6c65 290a 0a0a 6465 6620 6175  =scale)...def au
+00022640: 746f 6361 7374 5f73 796d 626f 6c5f 6d61  tocast_symbol_ma
+00022650: 7070 6572 2862 6f75 6e64 5f73 796d 626f  pper(bound_symbo
+00022660: 6c3a 2042 6f75 6e64 5379 6d62 6f6c 496e  l: BoundSymbolIn
+00022670: 7465 7266 6163 652c 2064 7479 7065 3a20  terface, dtype: 
+00022680: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
+00022690: 2020 2022 2222 5265 7475 726e 2074 6865     """Return the
+000226a0: 2063 616c 6c61 626c 6520 696d 706c 656d   callable implem
+000226b0: 656e 7469 6e67 2074 6865 2061 7574 6f63  enting the autoc
+000226c0: 6173 7420 7275 6c65 2066 6f72 2074 6865  ast rule for the
+000226d0: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
+000226e0: 6773 3a0a 2020 2020 2020 2020 626f 756e  gs:.        boun
+000226f0: 645f 7379 6d62 6f6c 3a20 4d61 7070 6564  d_symbol: Mapped
+00022700: 2074 6f20 6974 7320 6175 746f 6361 7374   to its autocast
+00022710: 2072 756c 652e 0a0a 2020 2020 5265 7475   rule...    Retu
+00022720: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+00022730: 6c61 626c 653a 2054 6865 2063 616c 6c61  lable: The calla
+00022740: 626c 6520 696d 706c 656d 656e 7469 6e67  ble implementing
+00022750: 2074 6865 2061 7574 6f63 6173 7420 7275   the autocast ru
+00022760: 6c65 2066 6f72 2074 6865 2073 796d 626f  le for the symbo
+00022770: 6c2e 0a20 2020 2022 2222 0a20 2020 2061  l..    """.    a
+00022780: 7574 6f63 6173 745f 696d 706c 3a20 4361  utocast_impl: Ca
+00022790: 6c6c 6162 6c65 207c 204e 6f6e 6520 3d20  llable | None = 
+000227a0: 6175 746f 6361 7374 5f69 6d70 6c73 2e67  autocast_impls.g
+000227b0: 6574 2862 6f75 6e64 5f73 796d 626f 6c2e  et(bound_symbol.
+000227c0: 7379 6d2e 6964 290a 2020 2020 7265 7475  sym.id).    retu
+000227d0: 726e 2062 6f75 6e64 5f73 796d 626f 6c2e  rn bound_symbol.
+000227e0: 7379 6d20 6966 2061 7574 6f63 6173 745f  sym if autocast_
+000227f0: 696d 706c 2069 7320 4e6f 6e65 2065 6c73  impl is None els
+00022800: 6520 7061 7274 6961 6c28 6175 746f 6361  e partial(autoca
+00022810: 7374 5f69 6d70 6c2c 2064 7479 7065 3d64  st_impl, dtype=d
+00022820: 7479 7065 290a 0a0a 6465 6620 6175 746f  type)...def auto
+00022830: 6361 7374 2866 756e 633a 2043 616c 6c61  cast(func: Calla
+00022840: 626c 652c 2064 7479 7065 3a20 6474 7970  ble, dtype: dtyp
+00022850: 6573 2e64 7479 7065 293a 0a20 2020 2022  es.dtype):.    "
+00022860: 2222 5472 616e 7366 6f72 6d73 2061 2066  ""Transforms a f
+00022870: 756e 6374 696f 6e20 746f 2061 7574 6f63  unction to autoc
+00022880: 6173 7420 6365 7274 6169 6e20 6f70 6572  ast certain oper
+00022890: 6174 696f 6e73 2e0a 0a20 2020 2041 7267  ations...    Arg
+000228a0: 733a 0a20 2020 2020 2020 2066 756e 633a  s:.        func:
+000228b0: 2054 6865 2066 756e 6374 696f 6e20 746f   The function to
+000228c0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+000228d0: 0a20 2020 2020 2020 2064 7479 7065 3a20  .        dtype: 
+000228e0: 5468 6520 6461 7461 2074 7970 6520 746f  The data type to
+000228f0: 2077 6869 6368 2061 7267 756d 656e 7473   which arguments
+00022900: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+00022910: 206f 7220 7375 6220 6675 6e63 7469 6f6e   or sub function
+00022920: 7320 636f 756c 6420 6765 7420 6361 7374  s could get cast
+00022930: 2069 660a 2020 2020 2020 2020 2020 2020   if.            
+00022940: 7468 6579 2061 7265 2060 6474 7970 6573  they are `dtypes
+00022950: 2e66 6c6f 6174 3332 602e 0a0a 2020 2020  .float32`...    
+00022960: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00022970: 2043 616c 6c61 626c 653a 2054 6865 2074   Callable: The t
+00022980: 7261 6e73 666f 726d 6564 2066 756e 6374  ransformed funct
+00022990: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
+000229a0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+000229b0: 6365 2864 7479 7065 2c20 6474 7970 6573  ce(dtype, dtypes
+000229c0: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
+000229d0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000229e0: 7228 6622 6064 7479 7065 6020 6973 2065  r(f"`dtype` is e
+000229f0: 7870 6563 7465 6420 746f 2062 6520 6074  xpected to be `t
+00022a00: 6875 6e64 6572 2e64 7479 7065 2e64 7479  hunder.dtype.dty
+00022a10: 7065 6020 6275 7420 7b74 7970 6528 6474  pe` but {type(dt
+00022a20: 7970 6529 7d22 290a 2020 2020 6966 2064  ype)}").    if d
+00022a30: 7479 7065 206e 6f74 2069 6e20 7b64 7479  type not in {dty
+00022a40: 7065 732e 666c 6f61 7431 362c 2064 7479  pes.float16, dty
+00022a50: 7065 732e 6266 6c6f 6174 3136 7d3a 0a20  pes.bfloat16}:. 
+00022a60: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00022a70: 7565 4572 726f 7228 6622 6064 7479 7065  ueError(f"`dtype
+00022a80: 6020 6973 2065 7870 6563 7465 6420 746f  ` is expected to
+00022a90: 2062 6520 6569 7468 6572 2060 7468 756e   be either `thun
+00022aa0: 6465 722e 666c 6f61 7431 3660 206f 7220  der.float16` or 
+00022ab0: 6074 6875 6e64 6572 2e62 666c 6f61 7431  `thunder.bfloat1
+00022ac0: 3660 2c20 6275 7420 7b64 7479 7065 7d22  6`, but {dtype}"
+00022ad0: 290a 0a20 2020 2040 7772 6170 7328 6675  )..    @wraps(fu
+00022ae0: 6e63 290a 2020 2020 6465 6620 7772 6170  nc).    def wrap
+00022af0: 7065 7228 2a61 7267 732c 202a 2a6b 7761  per(*args, **kwa
+00022b00: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
+00022b10: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+00022b20: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
+00022b30: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+00022b40: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
+00022b50: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
+00022b60: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
+00022b70: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
+00022b80: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
+00022b90: 7379 6d62 6f6c 5f6d 6170 7065 722c 2064  symbol_mapper, d
+00022ba0: 7479 7065 3d64 7479 7065 2929 0a0a 2020  type=dtype))..  
+00022bb0: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+00022bc0: 0a                                       .
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -427,29 +427,30 @@
             # Move leftover params and buffers to device. This is at least required to broadcast.
             # Cannot `submodule.to(device)` because we don't want it to recurse
             for n, p in module_copy.named_parameters(recurse=False, prefix=module_name):
                 if p.device != device:
                     thunder_model._overrides[n] = torch.nn.Parameter(p.to(device=device), requires_grad=p.requires_grad)
                     device_adjustments[n] = device
             for n, b in module_copy.named_buffers(recurse=False, prefix=module_name):
-                if p.device != device:
+                if b.device != device:
                     thunder_model._overrides[n] = b.to(device=device)
                     device_adjustments[n] = device
 
         # Broadcast parameters if requested
         if broadcast_from is not None:
             for pn, _ in submodule.named_parameters(recurse=False, prefix=module_name):
                 tdist.broadcast(
                     thunder_model.get_parameter(pn), src=broadcast_from, group=process_group, async_op=False
                 )
             for pn, _ in submodule.named_buffers(recurse=False, prefix=module_name):
                 tdist.broadcast(thunder_model.get_buffer(pn), src=broadcast_from, group=process_group, async_op=False)
 
         for pn, p in submodule.named_parameters(recurse=False, prefix=module_name):
-            if pn not in thunder_model._overrides:
+            # if we don't have an override or it is just the original, do create a copy
+            if thunder_model._overrides.get(pn, p) is p:
                 thunder_model._overrides[pn] = copy.copy(p)
             # we collect shapes and devices because we do not know if other transforms also change it...
             old_shape = thunder_model._overrides[pn].shape
             _shard_param(thunder_model._overrides[pn], global_rank, world_size, pn, allow_padding_for_fsdp=True)
             new_shape = thunder_model._overrides[pn].shape
             sharded_params[pn] = (old_shape, new_shape, thunder_model._overrides[pn].device)
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/transforms/fsdp_v2.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp_v2.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240526/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnnex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex_impl.py`

 * *Files 1% similar despite different names*

```diff
@@ -5,14 +5,15 @@
 from types import NoneType
 from collections.abc import Callable, Mapping, Hashable, Sequence
 import os
 import time
 from copy import copy
 from itertools import chain, filterfalse
 from functools import partial
+import warnings
 
 from looseversion import LooseVersion
 import torch
 
 import thunder.core.dtypes as dtypes
 import thunder.torch as ltorch
 from thunder.core import prims, utils
@@ -2196,26 +2197,25 @@
     return rrctrace
 
 
 def _linear_check(a: TensorProxy, b: TensorProxy, bias: TensorProxy | None) -> bool:
     if nv_version < LooseVersion("0.2.3"):
         return False
 
-    enable_linear: None | bool = get_compile_option("nv_enable_linear", "Enable nvFuser matmul.")
+    enable_linear: None | bool = get_compile_option("nv_enable_linear", "Enable nvFuser linear.")
     if not enable_linear:
         return False
     # Verify linear inputs and bias (optional) are supported tensors.
-    if not are_supported_tensors(a, b):
-        return False
-    if bias is not None and not is_supported_tensor(bias):
-        return False
-
-    # nvFuser only supports 2D inputs in v0.2.3.
-    if not a.ndim == 2:
+    if not are_supported_tensors(a, b) or (bias is not None and not is_supported_tensor(bias)):
         return False
+    if nv_version < LooseVersion("0.2.5"):
+        warnings.warn("nvFuser v0.2.3 has limited support for linear. Consider using v0.2.5 or above")
+        # nvFuser only supports 2D inputs in v0.2.3.
+        if not a.ndim == 2:
+            return False
     return True
 
 
 def linear(
     a: TensorProxy,
     b: TensorProxy,
     bias: TensorProxy | None,
@@ -2236,20 +2236,21 @@
     a: TensorProxy,
     b: TensorProxy,
 ) -> bool:
     if nv_version < LooseVersion("0.2.2"):
         return False
 
     enable_matmul: None | bool = get_compile_option("nv_enable_matmul", "Enable nvFuser matmul.")
-    if not enable_matmul:
-        return False
-    if not are_supported_tensors(a, b):
-        return False
-    if not (a.ndim == b.ndim and a.ndim == 2):
+
+    if not enable_matmul or not are_supported_tensors(a, b):
         return False
+    if nv_version < LooseVersion("0.2.4"):
+        warnings.warn("nvFuser v0.2.2 has limited support for matmuls. Consider using v0.2.4 or above")
+        if not (a.ndim == b.ndim and a.ndim == 2):
+            return False
     return True
 
 
 def matmul(
     a: TensorProxy,
     b: TensorProxy,
     *,
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_autograd.py`

 * *Files 0% similar despite different names*

```diff
@@ -94,17 +94,20 @@
         ctx.maybe_clear_saved_tensors()  # Delete the reference to all saved tensors in the context
         grads = ctx.compiled_backward([saved_tensors_list, ctx.saved_other], args)
 
         # Inside the compiled backward we must clear the saved_tensors_list
         assert not saved_tensors_list, "saved_tensors_list must be empty after calling compiled_backward"
         # TODO(crcrpar): Remove if-else once `dist_prims.stash_grad_for_fsdp` starts to return `None`
         # NOTE(crcrpar): In fsdp no-sync, unsharded gradients are attached and accumulated to their parameters as the attr of `_thunder_fsdp_unsharded_grad` in order to avoid shape mismatch of a param and its grad. When exiting the no_sync context, the accumulated, unsharded gradients are reduce-scattered into the attr of `grad` and `_thunder_fsdp_unsharded_grad` is removed.
-        if ctx.return_none_instead_of_grads:
-            return (None, None, None, None, None, *([None] * len(grads)))
-        return (None, None, None, None, None, *grads)
+        if not ctx.return_none_instead_of_grads:
+            return (None, None, None, None, None, *grads)
+        else:
+            n_grads = len(grads)
+            del grads
+            return (None, None, None, None, None, *([None] * n_grads))
 
 
 def split_forward_backward(computation_trc: TraceCtx, compile_data, compile_stats, /, *flat_args):
     from thunder.core.rematerialization import rematerialize_all_gather, rematerialize_forward_and_backward
     from thunder.core.transforms import forward_and_backward_from_trace
     from thunder.distributed.transforms import FSDPCommBucketing
     from thunder.distributed.utils import sort_data_parallel_syncs, sort_waits, sort_waits_for_zero3
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_compile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/torchex.py`

 * *Files 1% similar despite different names*

```diff
@@ -1272,14 +1272,18 @@
 log_softmax = _register_torch_operation("log_softmax", module=torch.nn.functional)
 log_softmax_backward = _register_torch_operation(
     "torch.ops.aten._log_softmax_backward_data", like=ltorch.log_softmax_backward
 )
 max_pool1d = _register_torch_operation("max_pool1d", module=torch.nn.functional)
 max_pool2d = _register_torch_operation("max_pool2d", module=torch.nn.functional)
 max_pool3d = _register_torch_operation("max_pool3d", module=torch.nn.functional)
+adaptive_avg_pool2d = _register_torch_operation("adaptive_avg_pool2d", module=torch.nn.functional)
+adaptive_avg_pool2d_backward = _register_torch_operation(
+    "torch.ops.aten._adaptive_avg_pool2d_backward", like=ltorch.adaptive_avg_pool2d_backward
+)
 
 
 def _max_pool_with_indices_helper(
     ndim: int,
     a: TensorProxy,
     /,
     kernel_size: int | Sequence[int],
@@ -1664,14 +1668,37 @@
 # ltorch.max_pool2d/3d decomposition uses convolution, which has performance issue running through torchex. We added grad_transform that keep both forward and backward max_pool as a torch composite operator, which avoids the performance issue. For details: https://github.com/Lightning-AI/lightning-thunder/issues/164. Aten doesn't have explicit functions for max_pool1d fwd/bwd. So the specialization is only done for 2d/3d case.
 ex.register_implementation(
     ltorch.max_pool2d, max_pool2d, checker=_always_executable, grad_transform=max_pool2d_bwd_wrapper
 )
 ex.register_implementation(
     ltorch.max_pool3d, max_pool3d, checker=_always_executable, grad_transform=max_pool3d_bwd_wrapper
 )
+
+
+def adaptive_avg_pool2d_bwd_wrapper(
+    a: TensorProxy,
+    /,
+    output_size: int | Sequence[int],
+) -> TensorProxy:
+    primals = adaptive_avg_pool2d(a, output_size)
+
+    grad = get_grad(primals)
+    grad_a = adaptive_avg_pool2d_backward(grad, a)
+    put_grad(a, grad_a)
+
+    return primals
+
+
+ex.register_implementation(
+    ltorch.adaptive_avg_pool2d,
+    adaptive_avg_pool2d,
+    checker=_always_executable,
+    grad_transform=adaptive_avg_pool2d_bwd_wrapper,
+)
+_register_implementation(ltorch.adaptive_avg_pool2d_backward, adaptive_avg_pool2d_backward, checker=_always_executable)
 _register_implementation(ltorch.nll_loss, checker=_always_executable, execution_transform=_nll_loss_transform)
 nll_loss_backward = ex.register_operator(
     "torch_nll_loss_backward_impl", meta=ltorch.nll_loss_backward, fn=_nll_loss_backward_impl
 )
 _register_implementation(ltorch.nll_loss_backward, nll_loss_backward, checker=_always_executable)
 _register_implementation(ltorch.pad, pad, checker=_always_executable)
 pad_prim_impl = ex.register_operator("torch_pad_prim_impl", meta=prims.pad.meta, fn=_pad_prim_impl)
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/transformer_engineex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240526/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/extend/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240526/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240526/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240526/thunder/torch/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -1997,14 +1997,45 @@
         keepdims=keepdim,
         dtype=None,
         has_identity=False,
         output_dtype_kind=REDUCTION_OUTPUT_TYPE_KIND.SAME,
     )
 
 
+# Clone is unique in that it's not registered as a symbol; as such we add it to
+# the appropriate maps manually, instead of through the @torchsymbol decorator.
+# This means that clone will not appear in the trace; instead, this basically
+# just gets inlined into the code.
+def clone(a: TensorProxy, *, memory_format=torch.preserve_format) -> TensorProxy:
+    """
+    Produce a copy of a tensor as a distinct new tensor.
+
+    Note: the implementation currently creates an alias instead of a copy.
+    """
+    # Our implementation currently does not introduce a copy, and so nothing
+    # except preserve_format is feasible to support.
+    # If you're hitting this you could try commenting this check out; if your
+    # model does not actually rely on specified memory formats then it should
+    # be fine.
+    if memory_format is not torch.preserve_format:
+        raise NotImplementedError("only preserve_format is currently supported")
+    # This implementation just creates an alias instead of a copy. This may
+    # introduce problems; such problems would be fixable when we get to adding an
+    # SSA pass, but for now we do not expect that aliasing the tensor will
+    # introduce many problems.
+    return a
+
+
+# Because we do not use @torchsymbol, we need to manually register the
+# implementation.
+_torch_to_thunder_function_map[torch.clone] = clone
+_torch_to_thunder_function_map[torch.Tensor.clone] = clone
+register_method("clone", clone)
+
+
 @torchsymbol(torch.mean, is_method=True)
 def mean(a: TensorProxy, /, dim=None, keepdim: bool = False, *, dtype=None):
     dtype = dtype if dtype is not None else a.dtype
     utils.check(
         not utils.is_integer_dtype(dtype) and not utils.is_boolean_dtype(dtype),
         lambda: f"dtype={dtype} is not a floating point or complex dtype",
     )
@@ -3337,14 +3368,71 @@
     ceil_mode: bool = False,
     count_include_pad: bool = True,
     divisor_override: NumberLike | None = None,
 ) -> TensorProxy:
     return _avg_pool_helper(3, a, kernel_size, stride, padding, ceil_mode, count_include_pad, divisor_override)
 
 
+@torchsymbol(
+    torch.nn.functional.adaptive_avg_pool2d, id="torch.nn.functional.adaptive_avg_pool2d", is_method=False, is_prim=True
+)
+def adaptive_avg_pool2d(
+    a: TensorProxy,
+    /,
+    output_size: int | Sequence[int],
+) -> TensorProxy:
+    from thunder.core.baseutils import check_valid_shape, check_valid_length
+
+    utils.check_type(output_size, (int, IntegerProxy, Sequence))
+    if isinstance(output_size, Sequence):
+        utils.check(len(output_size) == 2, lambda: f"adaptive_avg_pool2d: output_size must be 2")
+        utils.check_types(output_size, (int, IntegerProxy))
+        check_valid_shape(output_size)
+    else:
+        check_valid_length(output_size)
+        output_size = (output_size, output_size)
+
+    utils.check_type(a, TensorProxy)
+    a_ndim = a.ndim
+    utils.check(
+        a_ndim == 3 or a_ndim == 4,
+        lambda: f"adaptive_avg_pool2d: Expected 3D or 4D tensor, but got {a.shape}",
+    )
+    for i in (-2, -1):
+        utils.check(
+            a.shape[i] > 0,
+            lambda: f"adaptive_avg_pool2d: Expected input to have non-zero size for non-batch dimensions, but input has sizes {a.shape} with dimension {i + a_ndim} being empty",
+        )
+    output_shape_ = a.shape[:-2] + tuple(output_size)
+    return TensorProxy(like=a, shape=output_shape_)
+
+
+@torchsymbol("adaptive_avg_pool2d_backward", id="adaptive_avg_pool2d_backward", is_prim=True)
+def adaptive_avg_pool2d_backward(g: TensorProxy, a: TensorProxy, /) -> TensorProxy:
+    # Followed the cuda implementation in Pytorch for adaptive_avg_pool2d_backward here
+    # short cut for empty tensor
+    if 0 in a.shape:
+        return TensorProxy(like=a)
+    utils.check_type(g, TensorProxy)
+    utils.check_type(a, TensorProxy)
+    utils.check_same_device(g, a)
+    utils.check_same_dtype(g, a)
+    grad_ndim = g.ndim
+    utils.check(
+        grad_ndim == 3 or grad_ndim == 4,
+        lambda: f"adaptive_avg_pool2d_backward: Expected 3D or 4D tensor, but got {g.shape}",
+    )
+    for i in range(1, grad_ndim):
+        utils.check(
+            g.shape[i] > 0,
+            lambda: f"adaptive_avg_pool2d_backward: Expected grad to have non-zero size for non-batch dimensions, but grad has sizes {g.shape} with dimension {i} being empty",
+        )
+    return TensorProxy(like=a)
+
+
 @torchsymbol(torch.max_pool1d, torch.nn.functional.max_pool1d, id="torch.nn.functional.max_pool1d", is_method=False)
 def max_pool1d(
     a: TensorProxy,
     /,
     kernel_size: int | Sequence[int],
     stride: int | Sequence[int] | None = None,
     padding: int | Sequence[int] = 0,
```

### Comparing `lightning_thunder-0.2.0.dev20240519/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240526/thunder/torch/langctx.py`

 * *Files identical despite different names*

