# Comparing `tmp/degenbot-0.2.2.tar.gz` & `tmp/degenbot-0.2.3.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "degenbot-0.2.2.tar", last modified: Sun Mar 17 03:53:58 2024, max compression
+gzip compressed data, was "degenbot-0.2.3.tar", last modified: Sat May 25 23:23:30 2024, max compression
```

## Comparing `degenbot-0.2.2.tar` & `degenbot-0.2.3.tar`

### file list

```diff
@@ -1,94 +1,86 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.363585 degenbot-0.2.2/
--rw-r--r--   0 runner    (1001) docker     (127)     1072 2024-03-17 03:53:53.000000 degenbot-0.2.2/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)    36117 2024-03-17 03:53:58.363585 degenbot-0.2.2/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    34892 2024-03-17 03:53:53.000000 degenbot-0.2.2/README.md
--rw-r--r--   0 runner    (1001) docker     (127)     1905 2024-03-17 03:53:53.000000 degenbot-0.2.2/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-03-17 03:53:58.363585 degenbot-0.2.2/setup.cfg
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.347585 degenbot-0.2.2/src/
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.351585 degenbot-0.2.2/src/degenbot/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.351585 degenbot-0.2.2/src/degenbot/arbitrage/
--rw-r--r--   0 runner    (1001) docker     (127)      442 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1130 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/arbitrage_dataclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)    10351 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/flash_borrow_to_lp_swap.py
--rw-r--r--   0 runner    (1001) docker     (127)    16969 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/flash_borrow_to_lp_swap_new.py
--rw-r--r--   0 runner    (1001) docker     (127)    19077 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/flash_borrow_to_lp_swap_with_future.py
--rw-r--r--   0 runner    (1001) docker     (127)     8043 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/flash_borrow_to_router_swap.py
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/lp_swap_with_future.py
--rw-r--r--   0 runner    (1001) docker     (127)    41728 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/uniswap_curve_cycle.py
--rw-r--r--   0 runner    (1001) docker     (127)    36117 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/arbitrage/uniswap_lp_cycle.py
--rw-r--r--   0 runner    (1001) docker     (127)     3736 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/baseclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)    18039 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/builder_endpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)     6992 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/chainlink.py
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     1487 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/constants.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/curve/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/curve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    54518 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/curve/abi.py
--rw-r--r--   0 runner    (1001) docker     (127)     1232 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/curve/curve_stableswap_dataclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)    92764 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/curve/curve_stableswap_liquidity_pool.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/dex/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/dex/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   306934 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/dex/curve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3058 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/dex/uniswap.py
--rw-r--r--   0 runner    (1001) docker     (127)    16180 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/erc20_token.py
--rw-r--r--   0 runner    (1001) docker     (127)     3422 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/exceptions.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/fork/
--rw-r--r--   0 runner    (1001) docker     (127)       55 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/fork/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     9335 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/fork/anvil_fork.py
--rw-r--r--   0 runner    (1001) docker     (127)     2921 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/functions.py
--rw-r--r--   0 runner    (1001) docker     (127)      275 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/manager/
--rw-r--r--   0 runner    (1001) docker     (127)      158 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/manager/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2162 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/manager/token_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/registry/
--rw-r--r--   0 runner    (1001) docker     (127)       87 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/registry/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1663 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/registry/all_pools.py
--rw-r--r--   0 runner    (1001) docker     (127)     1049 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/registry/all_tokens.py
--rw-r--r--   0 runner    (1001) docker     (127)     1011 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/subscription_mixins.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.355585 degenbot-0.2.2/src/degenbot/transaction/
--rw-r--r--   0 runner    (1001) docker     (127)       73 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/transaction/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5081 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/transaction/simulation_ledger.py
--rw-r--r--   0 runner    (1001) docker     (127)   106421 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/transaction/uniswap_transaction.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.359585 degenbot-0.2.2/src/degenbot/uniswap/
--rw-r--r--   0 runner    (1001) docker     (127)      488 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   105787 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/abi.py
--rw-r--r--   0 runner    (1001) docker     (127)    17694 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/managers.py
--rw-r--r--   0 runner    (1001) docker     (127)     4425 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/mixins.py
--rw-r--r--   0 runner    (1001) docker     (127)     1014 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v2_dataclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)     1551 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v2_functions.py
--rw-r--r--   0 runner    (1001) docker     (127)    34626 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v2_liquidity_pool.py
--rw-r--r--   0 runner    (1001) docker     (127)      256 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v2_multi_liquidity_pool.py
--rw-r--r--   0 runner    (1001) docker     (127)     2345 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_dataclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)     2140 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_functions.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.359585 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/
--rw-r--r--   0 runner    (1001) docker     (127)      387 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1252 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/bit_math.py
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     1339 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/full_math.py
--rw-r--r--   0 runner    (1001) docker     (127)      829 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/functions.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/liquidity_math.py
--rw-r--r--   0 runner    (1001) docker     (127)     5409 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/sqrt_price_math.py
--rw-r--r--   0 runner    (1001) docker     (127)     3310 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/swap_math.py
--rw-r--r--   0 runner    (1001) docker     (127)      405 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/tick.py
--rw-r--r--   0 runner    (1001) docker     (127)     3484 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/tick_bitmap.py
--rw-r--r--   0 runner    (1001) docker     (127)     6364 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/tick_math.py
--rw-r--r--   0 runner    (1001) docker     (127)      140 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/unsafe_math.py
--rw-r--r--   0 runner    (1001) docker     (127)      454 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/yul_operations.py
--rw-r--r--   0 runner    (1001) docker     (127)    46267 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_liquidity_pool.py
--rw-r--r--   0 runner    (1001) docker     (127)     8424 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_snapshot.py
--rw-r--r--   0 runner    (1001) docker     (127)      657 2024-03-17 03:53:53.000000 degenbot-0.2.2/src/degenbot/uniswap/v3_tick_lens.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.363585 degenbot-0.2.2/src/degenbot.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    36117 2024-03-17 03:53:58.000000 degenbot-0.2.2/src/degenbot.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2856 2024-03-17 03:53:58.000000 degenbot-0.2.2/src/degenbot.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-03-17 03:53:58.000000 degenbot-0.2.2/src/degenbot.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)      132 2024-03-17 03:53:58.000000 degenbot-0.2.2/src/degenbot.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        9 2024-03-17 03:53:58.000000 degenbot-0.2.2/src/degenbot.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-17 03:53:58.363585 degenbot-0.2.2/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      943 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_baseclasses.py
--rw-r--r--   0 runner    (1001) docker     (127)     6271 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_builder_endpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)      472 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_chainlink_price_feed.py
--rw-r--r--   0 runner    (1001) docker     (127)      538 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     2936 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_erc20_token.py
--rw-r--r--   0 runner    (1001) docker     (127)     2380 2024-03-17 03:53:53.000000 degenbot-0.2.2/tests/test_functions.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.912309 degenbot-0.2.3/
+-rw-r--r--   0 runner    (1001) docker     (127)     1072 2024-05-25 23:23:23.000000 degenbot-0.2.3/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)    36117 2024-05-25 23:23:30.912309 degenbot-0.2.3/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    34892 2024-05-25 23:23:23.000000 degenbot-0.2.3/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)     2025 2024-05-25 23:23:23.000000 degenbot-0.2.3/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-25 23:23:30.912309 degenbot-0.2.3/setup.cfg
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.896309 degenbot-0.2.3/src/
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.900309 degenbot-0.2.3/src/degenbot/
+-rw-r--r--   0 runner    (1001) docker     (127)     1347 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.900309 degenbot-0.2.3/src/degenbot/arbitrage/
+-rw-r--r--   0 runner    (1001) docker     (127)      177 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/arbitrage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1176 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/arbitrage/arbitrage_dataclasses.py
+-rw-r--r--   0 runner    (1001) docker     (127)    41515 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/arbitrage/uniswap_curve_cycle.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34274 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/arbitrage/uniswap_lp_cycle.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4682 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/baseclasses.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17917 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/builder_endpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6992 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/chainlink.py
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1487 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/constants.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.900309 degenbot-0.2.3/src/degenbot/curve/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/curve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54518 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/curve/abi.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1154 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/curve/curve_stableswap_dataclasses.py
+-rw-r--r--   0 runner    (1001) docker     (127)    92798 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/curve/curve_stableswap_liquidity_pool.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.904309 degenbot-0.2.3/src/degenbot/dex/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/dex/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   306934 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/dex/curve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3058 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/dex/uniswap.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15283 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/erc20_token.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3422 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/exceptions.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.904309 degenbot-0.2.3/src/degenbot/fork/
+-rw-r--r--   0 runner    (1001) docker     (127)       55 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/fork/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9847 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/fork/anvil_fork.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2921 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/functions.py
+-rw-r--r--   0 runner    (1001) docker     (127)      275 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.904309 degenbot-0.2.3/src/degenbot/manager/
+-rw-r--r--   0 runner    (1001) docker     (127)      158 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/manager/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2162 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/manager/token_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.904309 degenbot-0.2.3/src/degenbot/registry/
+-rw-r--r--   0 runner    (1001) docker     (127)       87 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/registry/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1950 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/registry/all_pools.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1940 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/registry/all_tokens.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.904309 degenbot-0.2.3/src/degenbot/transaction/
+-rw-r--r--   0 runner    (1001) docker     (127)       73 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/transaction/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5081 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/transaction/simulation_ledger.py
+-rw-r--r--   0 runner    (1001) docker     (127)   124604 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/transaction/uniswap_transaction.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.908309 degenbot-0.2.3/src/degenbot/uniswap/
+-rw-r--r--   0 runner    (1001) docker     (127)      488 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   105787 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/abi.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18005 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1084 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v2_dataclasses.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1551 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v2_functions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35694 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v2_liquidity_pool.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2468 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_dataclasses.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2757 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_functions.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.908309 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/
+-rw-r--r--   0 runner    (1001) docker     (127)      387 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1252 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/bit_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1339 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/full_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)      829 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/functions.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/liquidity_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5134 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/sqrt_price_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3310 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/swap_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)      405 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/tick.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3484 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/tick_bitmap.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6364 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/tick_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)      140 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/unsafe_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)      454 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/yul_operations.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46275 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_liquidity_pool.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7333 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_snapshot.py
+-rw-r--r--   0 runner    (1001) docker     (127)      657 2024-05-25 23:23:23.000000 degenbot-0.2.3/src/degenbot/uniswap/v3_tick_lens.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.908309 degenbot-0.2.3/src/degenbot.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    36117 2024-05-25 23:23:30.000000 degenbot-0.2.3/src/degenbot.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2472 2024-05-25 23:23:30.000000 degenbot-0.2.3/src/degenbot.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-25 23:23:30.000000 degenbot-0.2.3/src/degenbot.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      132 2024-05-25 23:23:30.000000 degenbot-0.2.3/src/degenbot.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        9 2024-05-25 23:23:30.000000 degenbot-0.2.3/src/degenbot.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-25 23:23:30.908309 degenbot-0.2.3/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)     7602 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_builder_endpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)      517 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_chainlink_price_feed.py
+-rw-r--r--   0 runner    (1001) docker     (127)      601 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3303 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_erc20_token.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2895 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_functions.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2198 2024-05-25 23:23:23.000000 degenbot-0.2.3/tests/test_registry.py
```

### Comparing `degenbot-0.2.2/LICENSE` & `degenbot-0.2.3/LICENSE`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/PKG-INFO` & `degenbot-0.2.3/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: degenbot
-Version: 0.2.2
+Version: 0.2.3
 Summary: Python classes to aid rapid development of Uniswap V2 & V3, and Curve V1 arbitrage bots on EVM-compatible blockchains
 Author-email: BowTiedDevil <devil@bowtieddevil.com>
 License: MIT
 Project-URL: Homepage, https://www.degencode.com
 Project-URL: Repository, https://github.com/BowTiedDevil/degenbot
 Project-URL: Tracker, https://github.com/BowTiedDevil/degenbot/issues
 Project-URL: Twitter, https://twitter.com/BowTiedDevil
```

### Comparing `degenbot-0.2.2/README.md` & `degenbot-0.2.3/README.md`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/pyproject.toml` & `degenbot-0.2.3/pyproject.toml`

 * *Files 14% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [project]
 name = "degenbot"
-version = "0.2.2"
+version = "0.2.3"
 authors = [
     { name="BowTiedDevil", email="devil@bowtieddevil.com" },
 ]
 description = "Python classes to aid rapid development of Uniswap V2 & V3, and Curve V1 arbitrage bots on EVM-compatible blockchains"
 readme = "README.md"
 requires-python = ">=3.10"
 dependencies = [
@@ -39,45 +39,54 @@
 Twitter = "https://twitter.com/BowTiedDevil"
 
 [build-system]
 requires = ["setuptools"]
 build-backend = "setuptools.build_meta"
 
 [tool.mypy]
-files="src/degenbot"
-strict = true
+files=[
+    "src/degenbot", 
+    "tests/",
+]
 python_version = "3.10"
 
 [[tool.mypy.overrides]]
+module="degenbot.*"
+strict = true
+
+[[tool.mypy.overrides]]
+module="tests.*"
+disable_error_code = [
+    "no-untyped-def",
+]
+
+[[tool.mypy.overrides]]
 module=[
     "eth_abi.*",    
     "scipy.*",
     "ujson.*",
 ]
 ignore_missing_imports = true
 
 [tool.ruff]
 line-length = 100
 indent-width = 4
 
 [tool.coverage.run]
-omit = [
-    "conftest.py",
-    "tests/*"
-]
+source = ["src/degenbot"]
 
 [tool.coverage.report]
 exclude_also = [
     "if TYPE_CHECKING:", # exclude type checking imports and checks
     "except Exception", # exclude catch-alls
     "return NotImplemented", # required for __eq__, __lt__, __gt__
-    "def __repr__(self):",
-    "def __str__(self):",
-    "def __hash__(self):",
+    "def __hash__",
+    "def __repr__",
+    "def __str__",
     "logger.debug",
 ]
 
 [tool.pytest.ini_options]
 asyncio_mode = "auto"
-addopts = "--cov --cov-append --cov-report=html"
+addopts = "--cov --cov-branch --cov-report=html"
 python_files = "test_*.py"
-testpaths = "tests"
+testpaths = "tests"
```

### Comparing `degenbot-0.2.2/src/degenbot/__init__.py` & `degenbot-0.2.3/src/degenbot/__init__.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,16 +1,12 @@
 # ruff: noqa: F401
 
 
 from . import exceptions, uniswap
 from .arbitrage.arbitrage_dataclasses import ArbitrageCalculationResult
-from .arbitrage.flash_borrow_to_lp_swap import FlashBorrowToLpSwap
-from .arbitrage.flash_borrow_to_lp_swap_new import FlashBorrowToLpSwapNew
-from .arbitrage.flash_borrow_to_lp_swap_with_future import FlashBorrowToLpSwapWithFuture
-from .arbitrage.flash_borrow_to_router_swap import FlashBorrowToRouterSwap
 from .arbitrage.uniswap_curve_cycle import UniswapCurveCycle
 from .arbitrage.uniswap_lp_cycle import UniswapLpCycle
 from .builder_endpoint import BuilderEndpoint
 from .chainlink import ChainlinkPriceContract
 from .config import get_web3, set_web3
 from .curve.curve_stableswap_liquidity_pool import CurveStableswapPool
 from .erc20_token import Erc20Token
```

### Comparing `degenbot-0.2.2/src/degenbot/arbitrage/arbitrage_dataclasses.py` & `degenbot-0.2.3/src/degenbot/arbitrage/arbitrage_dataclasses.py`

 * *Files 12% similar despite different names*

```diff
@@ -31,14 +31,15 @@
     token_out: Erc20Token
     zero_for_one: bool
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV2PoolSwapAmounts:
     amounts: Tuple[int, int]
+    amounts_in: Tuple[int, int] | None = None
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV3PoolSwapAmounts:
     amount_specified: int
     zero_for_one: bool
     sqrt_price_limit_x96: int
```

### Comparing `degenbot-0.2.2/src/degenbot/arbitrage/uniswap_curve_cycle.py` & `degenbot-0.2.3/src/degenbot/arbitrage/uniswap_curve_cycle.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,24 +9,25 @@
 from scipy.optimize import minimize_scalar
 from web3 import Web3
 
 from ..baseclasses import (
     BaseArbitrage,
     BaseLiquidityPool,
     BasePoolState,
+    Publisher,
+    Subscriber,
     UniswapSimulationResult,
 )
 from ..config import get_web3
 from ..constants import MAX_UINT256
 from ..curve.curve_stableswap_dataclasses import CurveStableswapPoolState
 from ..curve.curve_stableswap_liquidity_pool import CurveStableswapPool
 from ..erc20_token import Erc20Token
 from ..exceptions import ArbitrageError, EVMRevertError, LiquidityPoolError, ZeroLiquidityError
 from ..logging import logger
-from ..subscription_mixins import Publisher, Subscriber
 from ..uniswap.v2_dataclasses import UniswapV2PoolSimulationResult, UniswapV2PoolState
 from ..uniswap.v2_liquidity_pool import LiquidityPool
 from ..uniswap.v3_dataclasses import UniswapV3PoolSimulationResult, UniswapV3PoolState
 from ..uniswap.v3_libraries import TickMath
 from ..uniswap.v3_liquidity_pool import V3LiquidityPool
 from .arbitrage_dataclasses import (
     ArbitrageCalculationResult,
@@ -72,14 +73,17 @@
 
         for pool in swap_pools:
             pool.subscribe(self)
 
         self.id = id
         self.input_token = input_token
 
+        if max_input == 0:
+            raise ValueError("Maximum input must be positive.")
+
         if max_input is None:
             logger.warning("No maximum input provided, setting to 100 WETH")
             max_input = 100 * 10**18
         self.max_input = max_input
 
         self.gas_estimate: int
 
@@ -139,15 +143,15 @@
                     # This assumes the first shared token is the correct one to continue
                     token_out = shared_tokens[0]
 
                     _swap_vectors.append(
                         CurveStableSwapPoolVector(token_in=token_in, token_out=token_out)
                     )
 
-                case _:
+                case _:  # pragma: no cover
                     raise ValueError("Pool type could not be identified")
 
         self._swap_vectors = tuple(_swap_vectors)
 
     def __getstate__(self) -> Dict[str, Any]:
         # Remove objects that cannot be pickled and are unnecessary to perform
         # the calculation
@@ -196,16 +200,16 @@
                 override,
                 (
                     # CurveStableswapPoolSimulationResult, <----- todo
                     UniswapV2PoolSimulationResult,
                     UniswapV3PoolSimulationResult,
                 ),
             ):
-                logger.debug(f"Applying override {override.future_state} to {pool}")
-                sorted_overrides[pool.address] = override.future_state
+                logger.debug(f"Applying override {override.final_state} to {pool}")
+                sorted_overrides[pool.address] = override.final_state
             else:
                 raise ValueError(f"Override for {pool} has unsupported type {type(override)}")
 
         return sorted_overrides
 
     def _build_amounts_out(
         self,
@@ -254,26 +258,28 @@
                                 UniswapV2PoolState,
                             )
                         _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
                             token_in=token_in,
                             token_in_quantity=_token_in_quantity,
                             override_state=pool_state_override,
                         )
+
                     case V3LiquidityPool():
                         pool_state_override = pool_state_overrides.get(pool.address)
                         if TYPE_CHECKING:
                             assert pool_state_override is None or isinstance(
                                 pool_state_override,
                                 UniswapV3PoolState,
                             )
                         _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
                             token_in=token_in,
                             token_in_quantity=_token_in_quantity,
                             override_state=pool_state_override,
                         )
+
                     case CurveStableswapPool():
                         pool_state_override = pool_state_overrides.get(pool.address)
                         if TYPE_CHECKING:
                             assert pool_state_override is None or isinstance(
                                 pool_state_override,
                                 CurveStableswapPoolState,
                             )
@@ -283,16 +289,15 @@
                                 token_in=token_in,
                                 token_out=token_out,
                                 token_in_quantity=_token_in_quantity,
                                 override_state=pool_state_override,
                                 block_identifier=block_number,
                             )
                         )
-                    case _:
-                        raise ValueError(f"Could not determine pool type for {pool}")
+
             except LiquidityPoolError as e:
                 raise ArbitrageError(f"(calculate_tokens_out_from_tokens_in): {e}")
             else:
                 if _token_out_quantity == 0:
                     raise ArbitrageError(f"Zero-output swap through pool {pool} @ {pool.address}")
 
             match pool:
@@ -300,24 +305,26 @@
                     pools_amounts_out.append(
                         UniswapV2PoolSwapAmounts(
                             amounts=(0, _token_out_quantity)
                             if zero_for_one
                             else (_token_out_quantity, 0),
                         )
                     )
+
                 case V3LiquidityPool():
                     pools_amounts_out.append(
                         UniswapV3PoolSwapAmounts(
                             amount_specified=_token_in_quantity,
                             zero_for_one=zero_for_one,
                             sqrt_price_limit_x96=TickMath.MIN_SQRT_RATIO + 1
                             if zero_for_one
                             else TickMath.MAX_SQRT_RATIO - 1,
                         )
                     )
+
                 case CurveStableswapPool():
                     pools_amounts_out.append(
                         CurveStableSwapPoolSwapAmounts(
                             token_in=token_in,
                             token_in_index=pool.tokens.index(token_in),
                             token_out=token_out,
                             token_out_index=pool.tokens.index(token_out),
@@ -330,18 +337,14 @@
                                     token_in in pool.tokens_underlying
                                     or token_out in pool.tokens_underlying
                                 )
                             )
                             else False,
                         )
                     )
-                case _:
-                    raise ValueError(
-                        f"Could not identify Uniswap version for pool: {self.swap_pools[i]}"
-                    )
 
         return pools_amounts_out
 
     def _update_pool_states(self, pools: Iterable[BaseLiquidityPool]) -> None:
         """
         Update `self.pool_states` with state values from the `pools` iterable
         """
@@ -439,17 +442,14 @@
                     )
 
                 case CurveStableswapPool():
                     price = 1.0 * (10**vector.token_out.decimals) / (10**vector.token_in.decimals)
                     fee = Fraction(pool.fee, pool.FEE_DENOMINATOR)
                     profit_factor *= price * ((fee.denominator - fee.numerator) / fee.denominator)
 
-                case _:
-                    raise ValueError("Could not identify pool")
-
             # print(f"{profit_factor=}")
 
         if profit_factor < 1.0:
             raise ArbitrageError(
                 f"No profitable arbitrage at current prices. Profit factor: {profit_factor}"
             )
 
@@ -495,24 +495,26 @@
                             token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
                                 token_in=swap_vector.token_in,
                                 token_in_quantity=token_in_quantity
                                 if i == 0
                                 else token_out_quantity,
                                 override_state=pool_override,
                             )
+
                         case V3LiquidityPool():
                             if TYPE_CHECKING:
                                 assert isinstance(pool_override, UniswapV3PoolState)
                             token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
                                 token_in=swap_vector.token_in,
                                 token_in_quantity=token_in_quantity
                                 if i == 0
                                 else token_out_quantity,
                                 override_state=pool_override,
                             )
+
                         case CurveStableswapPool():
                             if TYPE_CHECKING:
                                 assert isinstance(pool_override, CurveStableswapPoolState)
                             token_out_quantity = int(
                                 self.curve_discount_factor
                                 * pool.calculate_tokens_out_from_tokens_in(
                                     token_in=swap_vector.token_in,
@@ -520,16 +522,14 @@
                                         token_in_quantity if i == 0 else token_out_quantity
                                     ),
                                     token_out=swap_vector.token_out,
                                     override_state=pool_override,
                                     block_identifier=block_number,
                                 )
                             )
-                        case _:
-                            raise ValueError
 
                 except (EVMRevertError, LiquidityPoolError):
                     # The optimizer might send invalid amounts into the swap
                     # calculation during iteration. We don't want it to stop,
                     # so catch the exception and pretend the swap results in
                     # token_out_quantity = 0.
                     token_out_quantity = 0
@@ -935,11 +935,15 @@
                     )
         except Exception as e:
             logger.exception("generate_payloads catch-all")
             raise ArbitrageError(f"generate_payloads (catch-all)): {e}") from e
 
         return payloads
 
-    def notify(self, publisher: Publisher) -> None:
-        # On receipt of a notification from a publishing pool, update the pool state
-        if isinstance(publisher, (LiquidityPool, V3LiquidityPool)):
-            self._update_pool_states((publisher,))
+    def notify(self, publisher: Publisher, message: Any) -> None:
+        match publisher:
+            case LiquidityPool() | V3LiquidityPool() | CurveStableswapPool():
+                self._update_pool_states((publisher,))
+            case _:  # pragma: no cover
+                logger.info(
+                    f"{self} received message {message} from unsupported subscriber {publisher}"
+                )
```

### Comparing `degenbot-0.2.2/src/degenbot/arbitrage/uniswap_lp_cycle.py` & `degenbot-0.2.3/src/degenbot/arbitrage/uniswap_lp_cycle.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,56 +1,55 @@
 import asyncio
-import asyncio.futures
 from concurrent.futures import ProcessPoolExecutor, ThreadPoolExecutor
 from fractions import Fraction
 from typing import TYPE_CHECKING, Any, Awaitable, Dict, Iterable, List, Sequence, Tuple
 
 import eth_abi.abi
 from eth_typing import ChecksumAddress
 from eth_utils.address import to_checksum_address
-from scipy.optimize import minimize_scalar
+from scipy.optimize import OptimizeResult, minimize_scalar
 from web3 import Web3
 
-from ..baseclasses import BaseArbitrage, BaseLiquidityPool, BasePoolState
+from ..baseclasses import BaseArbitrage, Publisher, Subscriber
 from ..erc20_token import Erc20Token
 from ..exceptions import ArbitrageError, EVMRevertError, LiquidityPoolError, ZeroLiquidityError
 from ..logging import logger
-from ..subscription_mixins import Publisher, Subscriber
-from ..uniswap.v2_dataclasses import UniswapV2PoolSimulationResult, UniswapV2PoolState
+from ..uniswap.v2_dataclasses import (
+    UniswapV2PoolSimulationResult,
+    UniswapV2PoolState,
+    UniswapV2PoolStateUpdated,
+)
 from ..uniswap.v2_liquidity_pool import CamelotLiquidityPool, LiquidityPool
-from ..uniswap.v3_dataclasses import UniswapV3PoolSimulationResult, UniswapV3PoolState
+from ..uniswap.v3_dataclasses import (
+    UniswapV3PoolSimulationResult,
+    UniswapV3PoolState,
+    UniswapV3PoolStateUpdated,
+)
 from ..uniswap.v3_libraries import TickMath
 from ..uniswap.v3_liquidity_pool import V3LiquidityPool
 from .arbitrage_dataclasses import (
     ArbitrageCalculationResult,
     UniswapPoolSwapVector,
     UniswapV2PoolSwapAmounts,
     UniswapV3PoolSwapAmounts,
 )
 
 
 class UniswapLpCycle(Subscriber, BaseArbitrage):
     def __init__(
         self,
         input_token: Erc20Token,
-        swap_pools: Iterable[BaseLiquidityPool],
+        swap_pools: Iterable[LiquidityPool | V3LiquidityPool],
         id: str,
         max_input: int | None = None,
     ):
         if any([not isinstance(pool, (LiquidityPool, V3LiquidityPool)) for pool in swap_pools]):
             raise ValueError("Must provide only Uniswap liquidity pools.")
 
-        self.swap_pools: Tuple[LiquidityPool | V3LiquidityPool, ...]
-        _swap_pools = []
-        for pool in swap_pools:
-            if not isinstance(pool, (LiquidityPool, V3LiquidityPool)):
-                raise ValueError(f"{pool} must be a Uniswap V2 or V3 pool")
-            _swap_pools.append(pool)
-
-        self.swap_pools = tuple(_swap_pools)
+        self.swap_pools: Tuple[LiquidityPool | V3LiquidityPool, ...] = tuple(swap_pools)
         self.name = " → ".join([pool.name for pool in self.swap_pools])
 
         for pool in swap_pools:
             pool.subscribe(self)
 
         self.id = id
         self.input_token = input_token
@@ -59,73 +58,58 @@
             raise ValueError("Maximum input must be positive.")
 
         if max_input is None:
             logger.warning("No maximum input provided, setting to 100 WETH")
             max_input = 100 * 10**18
         self.max_input = max_input
 
-        # Set up pre-determined "swap vectors", which allows the helper
-        # to identify the tokens and direction of each swap along the path
-        _swap_vectors: List[UniswapPoolSwapVector] = []
+        self._swap_vectors: List[UniswapPoolSwapVector] = []
         for i, pool in enumerate(self.swap_pools):
             if i == 0:
                 if self.input_token == pool.token0:
                     token_in = pool.token0
                     token_out = pool.token1
                     zero_for_one = True
                 elif self.input_token == pool.token1:
                     token_in = pool.token1
                     token_out = pool.token0
                     zero_for_one = False
-                else:
+                else:  # pragma: no cover
                     raise ValueError("Input token could not be identified!")
             else:
                 # token_out references the output from the previous pool
                 if token_out == pool.token0:
                     token_in = pool.token0
                     token_out = pool.token1
                     zero_for_one = True
                 elif token_out == pool.token1:
                     token_in = pool.token1
                     token_out = pool.token0
                     zero_for_one = False
-                else:
-                    raise ValueError("Input token could not be identified!")
-            _swap_vectors.append(
+
+            self._swap_vectors.append(
                 UniswapPoolSwapVector(
                     token_in=token_in,
                     token_out=token_out,
                     zero_for_one=zero_for_one,
                 )
             )
-        self._swap_vectors = tuple(_swap_vectors)
-
-        self.pool_states: Dict[
-            ChecksumAddress,
-            # UniswapV2PoolState | UniswapV3PoolState | None,
-            BasePoolState | None,
-        ] = {pool.address: None for pool in self.swap_pools}
 
         self.best: Dict[str, Any] = {
             "input_token": self.input_token,
             "last_swap_amount": 0,
             "profit_amount": 0,
             "profit_token": self.input_token,
             "strategy": "cycle",
             "swap_amount": 0,
             "swap_pool_amounts": [],
         }
 
     def __getstate__(self) -> Dict[str, Any]:
-        # Remove objects that cannot be pickled and are unnecessary to perform
-        # the calculation
-        dropped_attributes = (
-            "_lock",
-            "_subscribers",
-        )
+        dropped_attributes = ("_subscribers",)
         copied_attributes = ()
 
         return {
             k: (v.copy() if k in copied_attributes else v)
             for k, v in self.__dict__.items()
             if k not in dropped_attributes
         }
@@ -150,312 +134,243 @@
 
         if overrides is None:
             return {}
 
         sorted_overrides: Dict[ChecksumAddress, UniswapV2PoolState | UniswapV3PoolState] = {}
 
         for pool, override in overrides:
-            if isinstance(
-                override,
-                (
-                    UniswapV2PoolState,
-                    UniswapV3PoolState,
-                ),
-            ):
-                logger.debug(f"Applying override {override} to {pool}")
-                sorted_overrides[pool.address] = override
-            elif isinstance(
-                override,
-                (
-                    UniswapV2PoolSimulationResult,
-                    UniswapV3PoolSimulationResult,
-                ),
-            ):
-                logger.debug(f"Applying override {override.future_state} to {pool}")
-                sorted_overrides[pool.address] = override.future_state
-            else:
-                raise ValueError(f"Override for {pool} has unsupported type {type(override)}")
+            match override:
+                case UniswapV2PoolState() | UniswapV3PoolState():
+                    logger.debug(f"Applying override {override} to {pool}")
+                    sorted_overrides[pool.address] = override
+                case UniswapV2PoolSimulationResult() | UniswapV3PoolSimulationResult():
+                    logger.debug(f"Applying override {override.final_state} to {pool}")
+                    sorted_overrides[pool.address] = override.final_state
+                case _:  # pragma: no cover
+                    raise ValueError(f"Override for {pool} has unsupported type {type(override)}")
 
         return sorted_overrides
 
     def _build_amounts_out(
         self,
         token_in: Erc20Token,
         token_in_quantity: int,
         pool_state_overrides: Dict[ChecksumAddress, UniswapV2PoolState | UniswapV3PoolState]
         | None = None,
     ) -> List[UniswapV2PoolSwapAmounts | UniswapV3PoolSwapAmounts]:
         """
-        Generate human-readable inputs for a complete swap along the arbitrage
-        path, starting with `token_in_quantity` amount of `token_in`.
+        Generate human-readable inputs for a swap along the arbitrage path, starting with the
+        specified amount of the given input token.
         """
 
         if pool_state_overrides is None:
             pool_state_overrides = {}
 
         pools_amounts_out: List[UniswapV2PoolSwapAmounts | UniswapV3PoolSwapAmounts] = []
 
         _token_in_quantity: int = 0
         _token_out_quantity: int = 0
 
         for i, (pool, swap_vector) in enumerate(zip(self.swap_pools, self._swap_vectors)):
             token_in = swap_vector.token_in
             zero_for_one = swap_vector.zero_for_one
+            pool_state_override = pool_state_overrides.get(pool.address)
 
             if i == 0:
                 _token_in_quantity = token_in_quantity
             else:
                 _token_in_quantity = _token_out_quantity
 
             try:
-                if isinstance(pool, LiquidityPool):
-                    pool_state_override = pool_state_overrides.get(pool.address)
-                    if TYPE_CHECKING:
-                        assert pool_state_override is None or isinstance(
-                            pool_state_override,
-                            UniswapV2PoolState,
+                match pool:
+                    case LiquidityPool():
+                        if TYPE_CHECKING:
+                            assert pool_state_override is None or isinstance(
+                                pool_state_override,
+                                UniswapV2PoolState,
+                            )
+                        _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
+                            token_in=token_in,
+                            token_in_quantity=_token_in_quantity,
+                            override_state=pool_state_override,
                         )
-                    _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
-                        token_in=token_in,
-                        token_in_quantity=_token_in_quantity,
-                        override_state=pool_state_override,
-                    )
-                elif isinstance(pool, V3LiquidityPool):
-                    pool_state_override = pool_state_overrides.get(pool.address)
-                    if TYPE_CHECKING:
-                        assert pool_state_override is None or isinstance(
-                            pool_state_override,
-                            UniswapV3PoolState,
+                    case V3LiquidityPool():
+                        if TYPE_CHECKING:
+                            assert pool_state_override is None or isinstance(
+                                pool_state_override,
+                                UniswapV3PoolState,
+                            )
+                        _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
+                            token_in=token_in,
+                            token_in_quantity=_token_in_quantity,
+                            override_state=pool_state_override,
                         )
-                    _token_out_quantity = pool.calculate_tokens_out_from_tokens_in(
-                        token_in=token_in,
-                        token_in_quantity=_token_in_quantity,
-                        override_state=pool_state_override,
-                    )
-                else:
-                    raise ValueError(f"Could not determine Uniswap version for pool {pool}")
-            except LiquidityPoolError as e:
+            except LiquidityPoolError as e:  # pragma: no cover
                 raise ArbitrageError(f"(calculate_tokens_out_from_tokens_in): {e}")
             else:
-                if _token_out_quantity == 0:
+                if _token_out_quantity == 0:  # pragma: no cover
                     raise ArbitrageError(f"Zero-output swap through pool {pool} @ {pool.address}")
 
-            if isinstance(pool, LiquidityPool):
-                pools_amounts_out.append(
-                    UniswapV2PoolSwapAmounts(
-                        amounts=(0, _token_out_quantity)
-                        if zero_for_one
-                        else (_token_out_quantity, 0),
+            match pool:
+                case LiquidityPool():
+                    pools_amounts_out.append(
+                        UniswapV2PoolSwapAmounts(
+                            amounts=(0, _token_out_quantity)
+                            if zero_for_one
+                            else (_token_out_quantity, 0),
+                        )
                     )
-                )
-            elif isinstance(pool, V3LiquidityPool):
-                pools_amounts_out.append(
-                    UniswapV3PoolSwapAmounts(
-                        amount_specified=_token_in_quantity,
-                        zero_for_one=zero_for_one,
-                        sqrt_price_limit_x96=TickMath.MIN_SQRT_RATIO + 1
-                        if zero_for_one
-                        else TickMath.MAX_SQRT_RATIO - 1,
+                case V3LiquidityPool():
+                    pools_amounts_out.append(
+                        UniswapV3PoolSwapAmounts(
+                            amount_specified=_token_in_quantity,
+                            zero_for_one=zero_for_one,
+                            sqrt_price_limit_x96=TickMath.MIN_SQRT_RATIO + 1
+                            if zero_for_one
+                            else TickMath.MAX_SQRT_RATIO - 1,
+                        )
                     )
-                )
-            else:
-                raise ValueError(
-                    f"Could not identify Uniswap version for pool: {self.swap_pools[i]}"
-                )
 
         return pools_amounts_out
 
-    def _update_pool_states(self, pools: Iterable[BaseLiquidityPool]) -> None:
-        """
-        Update `self.pool_states` with state values from the `pools` iterable
-        """
-        self.pool_states.update({pool.address: pool.state for pool in pools})
-
-    def auto_update(
-        self,
-        silent: bool = True,
-        block_number: int | None = None,
-        override_update_method: str | None = None,
-    ) -> bool:
-        """
-        TBD
-        """
-
-        found_updates = False
-
-        if None in self.pool_states.values():
-            found_updates = True
-            self._update_pool_states(self.swap_pools)
-            self.clear_best()
-
-            return found_updates
-
-        if override_update_method:
-            logger.debug(f"OVERRIDDEN UPDATE METHOD: {override_update_method}")
-
-        for pool in self.swap_pools:
-            pool_updated = False
-            if isinstance(pool, LiquidityPool):
-                if pool._update_method == "polling" or override_update_method == "polling":
-                    pool_updated = pool.update_reserves(
-                        silent=silent,
-                        override_update_method=override_update_method,
-                        update_block=block_number,
-                    )
-                elif pool._update_method == "external":
-                    if pool.state != self.pool_states[pool.address]:
-                        logger.debug(f"(UniswapLpCycle) found update for pool {pool}")
-                        pool_updated = True
-
-                if pool_updated:
-                    logger.debug(f"(UniswapLpCycle) found update for pool {pool}")
-                    self._update_pool_states((pool,))
-                    found_updates = True
-                    break
-
-            elif isinstance(pool, V3LiquidityPool):
-                pool_updated, _ = pool.auto_update(
-                    silent=silent,
-                    block_number=block_number,
-                )
-
-                if pool_updated:
-                    logger.debug(f"(UniswapLpCycle) found update for pool {pool}")
-                    self._update_pool_states((pool,))
-                    found_updates = True
-                    break
-            else:
-                raise ValueError(f"Could not identify pool {pool}!")
-
-        if found_updates:
-            self.clear_best()
-
-        return found_updates
-
     def _pre_calculation_check(
         self,
         override_state: Sequence[
             Tuple[LiquidityPool, UniswapV2PoolState]
             | Tuple[LiquidityPool, UniswapV2PoolSimulationResult]
             | Tuple[V3LiquidityPool, UniswapV3PoolState]
             | Tuple[V3LiquidityPool, UniswapV3PoolSimulationResult]
         ]
         | None = None,
+        min_rate_of_exchange: Fraction | None = None,
     ) -> None:
+        def _check_v2_pool_liquidity(
+            pool: LiquidityPool,
+            vector: UniswapPoolSwapVector,
+            pool_state: UniswapV2PoolState,
+        ) -> None:
+            if TYPE_CHECKING:
+                assert isinstance(pool_state, UniswapV2PoolState)
+
+            if all(
+                [
+                    pool_state.reserves_token0 > 1,
+                    pool_state.reserves_token1 > 1,
+                ]
+            ):
+                return  # No liquidity issues
+            elif pool_state.reserves_token0 == 0 or pool_state.reserves_token1 == 0:
+                raise ZeroLiquidityError(f"V2 pool {pool.address} has no liquidity")
+            elif pool_state.reserves_token1 == 1 and vector.zero_for_one is True:
+                raise ZeroLiquidityError(
+                    f"V2 pool {pool.address} has no liquidity for a 0 -> 1 swap"
+                )
+            elif pool_state.reserves_token0 == 1 and vector.zero_for_one is False:
+                raise ZeroLiquidityError(
+                    f"V2 pool {pool.address} has no liquidity for a 1 -> 0 swap"
+                )
+
+        def _check_v3_pool_liquidity(
+            pool: V3LiquidityPool,
+            vector: UniswapPoolSwapVector,
+            pool_state: UniswapV3PoolState,
+        ) -> None:
+            if TYPE_CHECKING:
+                assert isinstance(pool_state, UniswapV3PoolState)
+
+            if pool_state.sqrt_price_x96 == 0:
+                raise ZeroLiquidityError(
+                    f"V3 pool {pool.address} has no liquidity (not initialized)"
+                )
+
+            if pool_state.tick_bitmap == {}:
+                # TODO: add housekeeping to `V3LiquidityPool` to remove tick_bitmaps set to 0
+                raise ZeroLiquidityError(f"V3 pool {pool.address} has no liquidity (empty bitmap)")
+
+            if pool_state.tick_data == {}:
+                raise ZeroLiquidityError(
+                    f"V3 pool {pool.address} has no liquidity (no initialized ticks)"
+                )
+
+            if pool_state.liquidity == 0:
+                if (
+                    pool_state.sqrt_price_x96 == TickMath.MIN_SQRT_RATIO + 1
+                    and vector.zero_for_one is True
+                ):
+                    # Swap is 0 -> 1 and cannot swap any more token0 for token1
+                    raise ZeroLiquidityError(f"{pool} has no liquidity for a 0 -> 1 swap")
+                elif (
+                    pool_state.sqrt_price_x96 == TickMath.MAX_SQRT_RATIO - 1
+                    and vector.zero_for_one is False
+                ):
+                    # Swap is 1 -> 0  and cannot swap any more token1 for token0
+                    raise ZeroLiquidityError(f"{pool} has no liquidity for a 1 -> 0 swap")
+
         state_overrides = self._sort_overrides(override_state)
 
-        # A scalar value representing the net amount of 1 input token across
-        # the complete path (including fees).
-        # profit_factor > 1.0 indicates a profitable trade.
-        profit_factor: float = 1.0
+        if min_rate_of_exchange is None:
+            min_rate_of_exchange = Fraction(1, 1)
+
+        # A scalar value representing the net amount of 1 input token across the complete path
+        # including fees. A net rate > 1.0 indicates a profitable swap.
+        net_rate_of_exchange = Fraction(1)
 
         # Check the pool state liquidity in the direction of the trade
         for pool, vector in zip(self.swap_pools, self._swap_vectors):
             pool_state = state_overrides.get(pool.address) or pool.state
 
             match pool:
                 case LiquidityPool():
                     if TYPE_CHECKING:
                         assert isinstance(pool_state, UniswapV2PoolState)
-
-                    if pool_state.reserves_token0 == 0 or pool_state.reserves_token1 == 0:
-                        raise ZeroLiquidityError(f"V2 pool {pool.address} has no liquidity")
-
-                    if pool_state.reserves_token1 == 1 and vector.zero_for_one:
-                        raise ZeroLiquidityError(
-                            f"V2 pool {pool.address} has no liquidity for a 0 -> 1 swap"
-                        )
-                    elif pool_state.reserves_token0 == 1 and not vector.zero_for_one:
-                        raise ZeroLiquidityError(
-                            f"V2 pool {pool.address} has no liquidity for a 1 -> 0 swap"
-                        )
-
-                    # V2 fee is 0.3% by default, represented by 3/1000 = Fraction(3,1000)
+                    _check_v2_pool_liquidity(pool, vector, pool_state)
+                    exchange_rate = Fraction(pool_state.reserves_token1, pool_state.reserves_token0)
                     fee = pool.fee_token0 if vector.zero_for_one else pool.fee_token1
-                    price = pool_state.reserves_token1 / pool_state.reserves_token0
 
                 case V3LiquidityPool():
                     if TYPE_CHECKING:
                         assert isinstance(pool_state, UniswapV3PoolState)
+                    _check_v3_pool_liquidity(pool, vector, pool_state)
+                    exchange_rate = Fraction(pool_state.sqrt_price_x96**2, 2**192)
+                    fee = Fraction(
+                        pool._fee, 1000000
+                    )  # V3 fees are in hundredths of a bip (0.0001), e.g. 3000 == 0.3%
+
+            net_rate_of_exchange *= (
+                exchange_rate if vector.zero_for_one is True else 1 / exchange_rate
+            ) * Fraction(fee.denominator - fee.numerator, fee.denominator)
 
-                    if pool_state.sqrt_price_x96 == 0:
-                        raise ZeroLiquidityError(
-                            f"V3 pool {pool.address} has no liquidity (not initialized)"
-                        )
-
-                    if pool_state.tick_bitmap == {}:
-                        raise ZeroLiquidityError(
-                            f"V3 pool {pool.address} has no liquidity (empty bitmap)"
-                        )
-
-                    if pool_state.liquidity == 0:
-                        # Check if the swap is 0 -> 1 and cannot swap any more
-                        # token0 for token1
-                        if (
-                            pool_state.sqrt_price_x96 == TickMath.MIN_SQRT_RATIO + 1
-                            and vector.zero_for_one
-                        ):
-                            raise ZeroLiquidityError(
-                                f"V3 pool {pool.address} has no liquidity for a 0 -> 1 swap"
-                            )
-                        # Check if the swap is 1 -> 0 (zeroForOne=False) and
-                        # cannot swap any more token1 for token0
-                        elif (
-                            pool_state.sqrt_price_x96 == TickMath.MAX_SQRT_RATIO - 1
-                            and not vector.zero_for_one
-                        ):
-                            raise ZeroLiquidityError(
-                                f"V3 pool {pool.address} has no liquidity for a 1 -> 0 swap"
-                            )
-
-                    price = pool_state.sqrt_price_x96**2 / (2**192)
-
-                    # V3 fees are integer values representing hundredths of a bip (0.0001)
-                    # e.g. fee=3000 represents 0.3%
-                    fee = Fraction(pool._fee, 1000000)
-
-                case _:
-                    ...
-
-            profit_factor *= (price if vector.zero_for_one else 1 / price) * (
-                (fee.denominator - fee.numerator) / fee.denominator
-            )
-
-        if profit_factor < 1.0:
+        if net_rate_of_exchange < min_rate_of_exchange:
             raise ArbitrageError(
-                f"No profitable arbitrage at current prices. Profit factor: {profit_factor}"
+                f"No acceptable arbitrage at current rate of exchange ({float(net_rate_of_exchange)}), minimum {float(min_rate_of_exchange)}."
             )
 
     def _calculate(
         self,
         override_state: Sequence[
             Tuple[LiquidityPool, UniswapV2PoolState]
             | Tuple[LiquidityPool, UniswapV2PoolSimulationResult]
             | Tuple[V3LiquidityPool, UniswapV3PoolState]
             | Tuple[V3LiquidityPool, UniswapV3PoolSimulationResult]
         ]
         | None = None,
     ) -> ArbitrageCalculationResult:
-        self._pre_calculation_check(override_state)
+        """
+        Calculate the optimal arbitrage profit using the maximum input as an upper bound.
+        """
 
         state_overrides = self._sort_overrides(override_state)
 
-        # bound the amount to be swapped
+        # The bounded Brent optimizer requires bounds for the input amount, and a bracketed guess
+        # to initiate the search
         bounds: Tuple[float, float] = (
             1.0,
             float(self.max_input),
         )
-
-        # bracket the initial guess for the algo
-        bracket_amount: int = self.max_input
-        bracket: Tuple[float, float, float] = (
-            0.45 * bracket_amount,
-            0.50 * bracket_amount,
-            0.55 * bracket_amount,
-        )
+        bracket: Tuple[float, float] = (0.25 * self.max_input, 0.50 * self.max_input)
 
         def arb_profit(x: float) -> float:
             token_in_quantity = int(x)  # round the input down
             token_out_quantity: int = 0
 
             for i, (pool, swap_vector) in enumerate(zip(self.swap_pools, self._swap_vectors)):
                 pool_override = state_overrides.get(pool.address)
@@ -495,15 +410,15 @@
                     break
 
             # minimize_scalar requires the function to have a minimum value
             # for the solver to settle on an optimum input, so return the
             # negated profit
             return -float(token_out_quantity - token_in_quantity)
 
-        opt = minimize_scalar(
+        opt: OptimizeResult = minimize_scalar(
             fun=arb_profit,
             method="bounded",
             bounds=bounds,
             bracket=bracket,
             options={"xatol": 1.0},
         )
 
@@ -541,33 +456,38 @@
         override_state: Sequence[
             Tuple[LiquidityPool, UniswapV2PoolState]
             | Tuple[LiquidityPool, UniswapV2PoolSimulationResult]
             | Tuple[V3LiquidityPool, UniswapV3PoolState]
             | Tuple[V3LiquidityPool, UniswapV3PoolSimulationResult]
         ]
         | None = None,
+        min_rate_of_exchange: Fraction | None = None,
     ) -> ArbitrageCalculationResult:
         """
         Stateless calculation that does not use `self.best`
         """
 
-        self._pre_calculation_check(override_state)
+        self._pre_calculation_check(
+            override_state,
+            min_rate_of_exchange=min_rate_of_exchange,
+        )
 
         return self._calculate(override_state=override_state)
 
     async def calculate_with_pool(
         self,
         executor: ProcessPoolExecutor | ThreadPoolExecutor,
         override_state: Sequence[
             Tuple[LiquidityPool, UniswapV2PoolState]
             | Tuple[LiquidityPool, UniswapV2PoolSimulationResult]
             | Tuple[V3LiquidityPool, UniswapV3PoolState]
             | Tuple[V3LiquidityPool, UniswapV3PoolSimulationResult]
         ]
         | None = None,
+        min_rate_of_exchange: Fraction | None = None,
     ) -> Awaitable[Any]:
         """
         Wrap the arbitrage calculation into an asyncio future using the
         specified executor.
 
         Arguments
         ---------
@@ -592,15 +512,18 @@
         if any(
             [pool._sparse_bitmap for pool in self.swap_pools if isinstance(pool, V3LiquidityPool)]
         ):
             raise ValueError(
                 f"Cannot calculate {self} with executor. One or more V3 pools has a sparse bitmap."
             )
 
-        self._pre_calculation_check(override_state)
+        self._pre_calculation_check(
+            override_state=override_state,
+            min_rate_of_exchange=min_rate_of_exchange,
+        )
 
         return asyncio.get_running_loop().run_in_executor(
             executor,
             self._calculate,
             override_state,
         )
 
@@ -628,19 +551,25 @@
         override_state: Sequence[
             Tuple[LiquidityPool, UniswapV2PoolState]
             | Tuple[LiquidityPool, UniswapV2PoolSimulationResult]
             | Tuple[V3LiquidityPool, UniswapV3PoolState]
             | Tuple[V3LiquidityPool, UniswapV3PoolSimulationResult]
         ]
         | None = None,
+        min_rate_of_exchange: Fraction | None = None,
     ) -> Tuple[bool, Tuple[int, int]]:
         """
         TBD
         """
 
+        self._pre_calculation_check(
+            override_state=override_state,
+            min_rate_of_exchange=min_rate_of_exchange,
+        )
+
         result = self._calculate(override_state=override_state)
 
         if override_state is None:
             self.best.update(
                 {
                     "last_swap_amount": result.input_amount,
                     "profit_amount": result.profit_amount,
@@ -688,28 +617,27 @@
         max_input: int, optional
             The maximum input amount for the input token (limited by the
             balance of the deployed contract or operating EOA)
         id: str, optional
             A unique identifier for bookkeeping purposes, not validated
         """
 
-        # create the token object
         token = Erc20Token(input_token_address)
 
-        # create the pool objects
         pool_objects: List[LiquidityPool | V3LiquidityPool | CamelotLiquidityPool] = []
         for pool_address, pool_type in swap_pool_addresses:
-            if pool_type == "V2":
-                pool_objects.append(LiquidityPool(address=pool_address))
-            elif pool_type == "V3":
-                pool_objects.append(V3LiquidityPool(address=pool_address))
-            elif pool_type == "CamelotV2":
-                pool_objects.append(CamelotLiquidityPool(address=pool_address))
-            else:
-                raise ArbitrageError(f"Pool type {pool_type} unknown!")
+            match pool_type:
+                case "V2":
+                    pool_objects.append(LiquidityPool(address=pool_address))
+                case "V3":
+                    pool_objects.append(V3LiquidityPool(address=pool_address))
+                case "CamelotV2":
+                    pool_objects.append(CamelotLiquidityPool(address=pool_address))
+                case _:  # pragma: no cover
+                    raise ArbitrageError(f"Pool type {pool_type} unknown!")
 
         return cls(
             input_token=token,
             swap_pools=pool_objects,
             max_input=max_input,
             id=id,
         )
@@ -819,86 +747,93 @@
                     elif isinstance(next_pool, V3LiquidityPool):
                         swap_destination_address = from_address
                 else:
                     # Set the destination address for the last swap to the
                     # sending address
                     swap_destination_address = from_address
 
-                if isinstance(swap_pool, LiquidityPool):
-                    if TYPE_CHECKING:
-                        assert isinstance(_swap_amounts, UniswapV2PoolSwapAmounts)
-
-                    logger.debug(f"PAYLOAD: building V2 swap at pool {i}")
-                    logger.debug(f"PAYLOAD: pool address {swap_pool.address}")
-                    logger.debug(f"PAYLOAD: swap amounts {_swap_amounts}")
-                    logger.debug(f"PAYLOAD: destination address {swap_destination_address}")
-
-                    payloads.append(
-                        (
-                            # address
-                            swap_pool.address,
-                            # bytes calldata
-                            Web3.keccak(text="swap(uint256,uint256,address,bytes)")[:4]
-                            + eth_abi.abi.encode(
-                                types=(
-                                    "uint256",
-                                    "uint256",
-                                    "address",
-                                    "bytes",
-                                ),
-                                args=(
-                                    *_swap_amounts.amounts,
-                                    swap_destination_address,
-                                    b"",
+                match swap_pool:
+                    case LiquidityPool():
+                        if TYPE_CHECKING:
+                            assert isinstance(_swap_amounts, UniswapV2PoolSwapAmounts)
+
+                        logger.debug(f"PAYLOAD: building V2 swap at pool {i}")
+                        logger.debug(f"PAYLOAD: pool address {swap_pool.address}")
+                        logger.debug(f"PAYLOAD: swap amounts {_swap_amounts}")
+                        logger.debug(f"PAYLOAD: destination address {swap_destination_address}")
+
+                        payloads.append(
+                            (
+                                # address
+                                swap_pool.address,
+                                # bytes calldata
+                                Web3.keccak(text="swap(uint256,uint256,address,bytes)")[:4]
+                                + eth_abi.abi.encode(
+                                    types=(
+                                        "uint256",
+                                        "uint256",
+                                        "address",
+                                        "bytes",
+                                    ),
+                                    args=(
+                                        *_swap_amounts.amounts,
+                                        swap_destination_address,
+                                        b"",
+                                    ),
                                 ),
-                            ),
-                            msg_value,
+                                msg_value,
+                            )
                         )
-                    )
-                elif isinstance(swap_pool, V3LiquidityPool):
-                    if TYPE_CHECKING:
-                        assert isinstance(_swap_amounts, UniswapV3PoolSwapAmounts)
-
-                    logger.debug(f"PAYLOAD: building V3 swap at pool {i}")
-                    logger.debug(f"PAYLOAD: pool address {swap_pool.address}")
-                    logger.debug(f"PAYLOAD: swap amounts {_swap_amounts}")
-                    logger.debug(f"PAYLOAD: destination address {swap_destination_address}")
-
-                    payloads.append(
-                        (
-                            # address
-                            swap_pool.address,
-                            # bytes calldata
-                            Web3.keccak(text="swap(address,bool,int256,uint160,bytes)")[:4]
-                            + eth_abi.abi.encode(
-                                types=(
-                                    "address",
-                                    "bool",
-                                    "int256",
-                                    "uint160",
-                                    "bytes",
-                                ),
-                                args=(
-                                    swap_destination_address,
-                                    _swap_amounts.zero_for_one,
-                                    _swap_amounts.amount_specified,
-                                    _swap_amounts.sqrt_price_limit_x96,
-                                    b"",
+                    case V3LiquidityPool():
+                        if TYPE_CHECKING:
+                            assert isinstance(_swap_amounts, UniswapV3PoolSwapAmounts)
+
+                        logger.debug(f"PAYLOAD: building V3 swap at pool {i}")
+                        logger.debug(f"PAYLOAD: pool address {swap_pool.address}")
+                        logger.debug(f"PAYLOAD: swap amounts {_swap_amounts}")
+                        logger.debug(f"PAYLOAD: destination address {swap_destination_address}")
+
+                        payloads.append(
+                            (
+                                # address
+                                swap_pool.address,
+                                # bytes calldata
+                                Web3.keccak(text="swap(address,bool,int256,uint160,bytes)")[:4]
+                                + eth_abi.abi.encode(
+                                    types=(
+                                        "address",
+                                        "bool",
+                                        "int256",
+                                        "uint160",
+                                        "bytes",
+                                    ),
+                                    args=(
+                                        swap_destination_address,
+                                        _swap_amounts.zero_for_one,
+                                        _swap_amounts.amount_specified,
+                                        _swap_amounts.sqrt_price_limit_x96,
+                                        b"",
+                                    ),
                                 ),
-                            ),
-                            msg_value,
+                                msg_value,
+                            )
                         )
-                    )
-                else:
-                    raise ValueError(
-                        f"Could not identify pool: {swap_pool}, type={type(swap_pool)}"
-                    )
         except Exception as e:
             logger.exception("generate_payloads catch-all")
             raise ArbitrageError(f"generate_payloads (catch-all)): {e}") from e
 
         return payloads
 
-    def notify(self, publisher: Publisher) -> None:
-        # On receipt of a notification from a publishing pool, update the pool state
-        if isinstance(publisher, (LiquidityPool, V3LiquidityPool)):
-            self._update_pool_states((publisher,))
+    def notify(self, publisher: Publisher, message: Any) -> None:
+        match publisher:
+            case LiquidityPool() | V3LiquidityPool():
+                match message:
+                    case UniswapV2PoolStateUpdated() | UniswapV3PoolStateUpdated():
+                        pass
+                    case _:  # pragma: no cover
+                        logger.info(
+                            f"{self} unhandled message {message} from subscriber {publisher}"
+                        )
+            case _:  # pragma: no cover
+                logger.info(
+                    f"{self} unhandled message {message} from unsupported subscriber {publisher}"
+                )
```

### Comparing `degenbot-0.2.2/src/degenbot/builder_endpoint.py` & `degenbot-0.2.3/src/degenbot/builder_endpoint.py`

 * *Files 10% similar despite different names*

```diff
@@ -79,20 +79,20 @@
                 headers=headers,
             ) as resp:
                 relay_response = await resp.json(
                     # Some builders omit or return an invalid MIME type, so use None to bypass the
                     # check in the `json` method
                     content_type=None,
                 )
-        except aiohttp.ClientError as exc:
+        except aiohttp.ClientError as exc:  # pragma: no cover
             raise ExternalServiceError(f"HTTP Error: {exc}") from None
         else:
-            if "error" in relay_response:
-                return relay_response["error"]
-            return relay_response["result"]
+            return (
+                relay_response["error"] if "error" in relay_response else relay_response["result"]
+            )
         finally:
             if close_session_after_post:
                 await session.close()
 
     async def call_eth_bundle(
         self,
         bundle: Iterable[HexBytes],
@@ -104,15 +104,15 @@
     ) -> Any:
         """
         Send a formatted bundle to the eth_callBundle endpoint for simulation against some block state
         """
 
         ENDPOINT_METHOD = "eth_callBundle"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         bundle_params: Dict[str, Any] = {
             "txs": (
                 # Array[String], A list of signed transactions to execute in an atomic bundle
@@ -121,15 +121,15 @@
             "blockNumber": (
                 # String, a hex encoded block number for which this bundle is valid on
                 hex(block_number)
             ),
         }
 
         if isinstance(state_block, str):
-            if state_block != "latest":
+            if state_block != "latest":  # pragma: no cover
                 raise ValueError("state_block tag may only be an integer, or the string 'latest'")
             bundle_params["stateBlockNumber"] = state_block
         elif isinstance(state_block, int):
             bundle_params[
                 # String, either a hex encoded number or a block tag for which state to base this simulation on. Can use "latest"
                 "stateBlockNumber"
             ] = hex(state_block)
@@ -168,15 +168,15 @@
     ) -> Any:
         """
         Send a cancellation for the specified UUID.
         """
 
         ENDPOINT_METHOD = "eth_cancelBundle"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
@@ -219,15 +219,15 @@
         Send a cancellation for the specified private transaction hash.
 
         The signer key used for the request must match the signer key for the transaction.
         """
 
         ENDPOINT_METHOD = "eth_cancelPrivateTransaction"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
@@ -271,15 +271,15 @@
     ) -> Any:
         """
         Get the Flashbots V2 user stats for the given searcher identity.
         """
 
         ENDPOINT_METHOD = "flashbots_getUserStatsV2"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
@@ -319,32 +319,24 @@
         self,
         bundle_hash: str,
         block_number: int,
         signer_key: str,
         http_session: aiohttp.ClientSession | None = None,
     ) -> Any:
         """
-        Get the Flashbots V2 user stats for the given searcher identity.
+        Get the Flashbots V2 bundle stats for the given searcher identity.
         """
 
         ENDPOINT_METHOD = "flashbots_getBundleStatsV2"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
-        if self.authentication_header_label is not None and signer_key is None:
-            raise ValueError(
-                f"Must provide signing address and key for required header {self.authentication_header_label}"
-            )
-
-        if block_number is None:
-            block_number = get_web3().eth.block_number
-
         payload = ujson.dumps(
             {
                 "jsonrpc": "2.0",
                 "id": 1,
                 "method": ENDPOINT_METHOD,
                 "params": [
                     {
@@ -382,15 +374,15 @@
     ) -> Any:
         """
         Send a formatted bundle to the eth_sendBundle endpoint
         """
 
         ENDPOINT_METHOD = "eth_sendBundle"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
@@ -464,15 +456,15 @@
     ) -> Any:
         """
         Send a private raw transaction.
         """
 
         ENDPOINT_METHOD = "eth_sendPrivateTransaction"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
@@ -525,15 +517,15 @@
     ) -> Any:
         """
         Send a private raw transaction.
         """
 
         ENDPOINT_METHOD = "eth_sendPrivateRawTransaction"
 
-        if ENDPOINT_METHOD not in self.endpoints:
+        if ENDPOINT_METHOD not in self.endpoints:  # pragma: no cover
             raise ValueError(
                 f"{ENDPOINT_METHOD} was not included in the list of supported endpoints."
             )
 
         if self.authentication_header_label is not None and signer_key is None:
             raise ValueError(
                 f"Must provide signing address and key for required header {self.authentication_header_label}"
```

### Comparing `degenbot-0.2.2/src/degenbot/chainlink.py` & `degenbot-0.2.3/src/degenbot/chainlink.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/constants.py` & `degenbot-0.2.3/src/degenbot/constants.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/curve/abi.py` & `degenbot-0.2.3/src/degenbot/curve/abi.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/curve/curve_stableswap_liquidity_pool.py` & `degenbot-0.2.3/src/degenbot/curve/curve_stableswap_liquidity_pool.py`

 * *Files 0% similar despite different names*

```diff
@@ -4,15 +4,15 @@
 # high          write state_update method
 # high          create a manager for Curve pools
 # medium        add liquidity modifying mode for external_update
 # medium        investigate differences in get_dy_underlying vs exchange_underlying at GUSD-3Crv
 
 
 from threading import Lock
-from typing import TYPE_CHECKING, Any, Dict, List, Set, Tuple
+from typing import TYPE_CHECKING, Any, Dict, List, Tuple
 
 import eth_abi.abi
 import web3.exceptions
 from eth_abi.exceptions import InsufficientDataBytes
 from eth_typing import AnyAddress, ChecksumAddress
 from eth_utils.address import to_checksum_address
 from hexbytes import HexBytes
@@ -31,20 +31,23 @@
 )
 from ..erc20_token import Erc20Token
 from ..exceptions import BrokenPool, EVMRevertError, ZeroLiquidityError, ZeroSwapError
 from ..functions import get_number_for_block_identifier
 from ..logging import logger
 from ..manager.token_manager import Erc20TokenHelperManager
 from ..registry.all_pools import AllPools
-from ..subscription_mixins import Subscriber, SubscriptionMixin
 from .abi import CURVE_V1_FACTORY_ABI, CURVE_V1_POOL_ABI, CURVE_V1_REGISTRY_ABI
-from .curve_stableswap_dataclasses import CurveStableSwapPoolAttributes, CurveStableswapPoolState
+from .curve_stableswap_dataclasses import (
+    CurveStableSwapPoolAttributes,
+    CurveStableswapPoolState,
+    CurveStableSwapPoolStateUpdated,
+)
 
 
-class CurveStableswapPool(SubscriptionMixin, BaseLiquidityPool):
+class CurveStableswapPool(BaseLiquidityPool):
     # Constants from contract
     # ref: https://github.com/curvefi/curve-contract/blob/master/contracts/pool-templates/base/SwapTemplateBase.vy
     PRECISION_DECIMALS = 18
     PRECISION = 10**PRECISION_DECIMALS
     LENDING_PRECISION = PRECISION
     FEE_DENOMINATOR = 10**10
     A_PRECISION = 100
@@ -448,21 +451,21 @@
 
         _set_pool_specific_attributes()
 
         fee_string = f"{100*self.fee/self.FEE_DENOMINATOR:.2f}"
         token_string = "-".join([token.symbol for token in self.tokens])
         self.name = f"{token_string} (CurveStable, {fee_string}%)"
 
-        self._subscribers: Set[Subscriber] = set()
+        self._subscribers = set()
+
         self.state: CurveStableswapPoolState
         self._update_pool_state()
         self._pool_state_archive: Dict[int, CurveStableswapPoolState] = {
             0: CurveStableswapPoolState(
-                pool=self,
-                address=self.address,
+                pool=self.address,
                 balances=self.balances,
                 base=getattr(self, "base_pool", None),
             ),
             state_block: self.state,
         }
 
         AllPools(chain_id)[self.address] = self
@@ -501,18 +504,18 @@
             return {k: v for k, v in self.__dict__.items() if k not in dropped_attributes}
 
     def __repr__(self) -> str:  # pragma: no cover
         token_string = "-".join([token.symbol for token in self.tokens])
         return f"CurveStableswapPool(address={self.address}, tokens={token_string}, fee={100*self.fee/self.FEE_DENOMINATOR:.2f}%, A={self.a_coefficient})"
 
     def _update_pool_state(self) -> None:
-        self.state = CurveStableswapPoolState(
-            pool=self, address=self.address, balances=self.balances
+        self.state = CurveStableswapPoolState(pool=self.address, balances=self.balances)
+        self._notify_subscribers(
+            message=CurveStableSwapPoolStateUpdated(self.state),
         )
-        self._notify_subscribers()
 
     @property
     def _w3_contract(self) -> Contract:
         return config.get_web3().eth.contract(
             address=self.address,
             abi=self.abi,
         )
@@ -1730,14 +1733,16 @@
             "0x3b21C2868B6028CfB38Ff86127eF22E68d16d53B",
             "0x3F1B0278A9ee595635B61817630cC19DE792f506",
             "0x3Fb78e61784C9c637D560eDE23Ad57CA1294c14a",
             "0x453D92C7d4263201C69aACfaf589Ed14202d83a4",
             "0x69ACcb968B19a53790f43e57558F5E443A91aF22",
             "0x875DF0bA24ccD867f8217593ee27253280772A97",
             "0x9D0464996170c6B9e75eED71c68B99dDEDf279e8",
+            "0xB657B895B265C38c53FFF00166cF7F6A3C70587d",
+            "0xD6Ac1CB9019137a896343Da59dDE6d097F710538",
         ):
             for _ in range(255):
                 D_P = D * D // _xp[0] * D // _xp[1] // N_COINS**2
                 Dprev = D
                 D = (
                     (Ann * S // self.A_PRECISION + D_P * N_COINS)
                     * D
@@ -2254,17 +2259,15 @@
 
         if token_balances != self.balances:
             found_updates = True
             self.balances = token_balances
 
         self.update_block = block_number
 
-        return found_updates, CurveStableswapPoolState(
-            pool=self, address=self.address, balances=self.balances
-        )
+        return found_updates, CurveStableswapPoolState(pool=self.address, balances=self.balances)
 
     # def external_update(self, update: CurveStableswapPoolExternalUpdate) -> bool:
     #     with self._state_lock:
     #         i = update.sold_id
     #         j = update.bought_id
     #         dx = update.tokens_sold
     #         dy_out = update.tokens_bought
```

### Comparing `degenbot-0.2.2/src/degenbot/dex/curve.py` & `degenbot-0.2.3/src/degenbot/dex/curve.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/dex/uniswap.py` & `degenbot-0.2.3/src/degenbot/dex/uniswap.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/erc20_token.py` & `degenbot-0.2.3/src/degenbot/erc20_token.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,8 +1,7 @@
-import warnings
 from typing import Any, Dict, List, Tuple
 
 import eth_abi.abi
 import ujson
 from eth_typing import AnyAddress, ChecksumAddress
 from eth_utils.address import to_checksum_address
 from web3 import Web3
@@ -54,43 +53,21 @@
 
     def __init__(
         self,
         address: str,
         abi: List[Any] | None = None,
         oracle_address: str | None = None,
         silent: bool = False,
-        unload_brownie_contract_after_init: bool = False,  # deprecated
-        min_abi: bool = False,  # deprecated
-        user: Any | None = None,  # deprecated
     ) -> None:
         self.address: ChecksumAddress = to_checksum_address(address)
         self.abi = abi if abi is not None else ERC20_ABI_MINIMAL
 
         _w3 = config.get_web3()
         _w3_contract = self._w3_contract
 
-        if user:  # pragma: no cover
-            warnings.warn(
-                "Instantiating with a single user is deprecated. You may use "
-                "the get_balance() method to retrieve token balances for a "
-                "particular address."
-            )
-
-        if min_abi:  # pragma: no cover
-            warnings.warn(
-                "Using a minimal ABI is now the default behavior. Remove "
-                "min_abi constructor argument to stop seeing this message."
-            )
-
-        if unload_brownie_contract_after_init:  # pragma: no cover
-            warnings.warn(
-                "unload_brownie_contract_after_init is deprecated. Remove "
-                "constructor argument to stop seeing this message."
-            )
-
         try:
             self.name: str
             self.name = _w3_contract.functions.name().call()
         except (ContractLogicError, OverflowError, BadFunctionCallOutput):
             # Workaround for non-ERC20 compliant tokens
             for func in ("name", "NAME"):
                 try:
@@ -108,23 +85,22 @@
                     break
         except Exception as e:
             print(f"(token.name @ {self.address}) {type(e)}: {e}")
             raise
 
         try:
             self.name
-        except AttributeError:  # pragma: no cover
-            if not _w3.eth.get_code(self.address):
+        except AttributeError:
+            if not _w3.eth.get_code(self.address):  # pragma: no cover
                 raise ValueError("No contract deployed at this address")
-            self.name = f"Unknown @ {self.address}"
+            self.name = "Unknown"
+            self.name = self.name.strip("\x00")
             logger.warning(
                 f"Token contract at {self.address} does not implement a 'name' function. Setting to '{self.name}'"
             )
-        finally:
-            self.name = self.name.strip("\x00")
 
         try:
             self.symbol: str
             self.symbol = _w3_contract.functions.symbol().call()
         except (ContractLogicError, OverflowError, BadFunctionCallOutput):
             for func in ("symbol", "SYMBOL"):
                 # Workaround for non-ERC20 compliant tokens
@@ -198,15 +174,15 @@
 
         AllTokens(chain_id=_w3.eth.chain_id)[self.address] = self
 
         self._cached_approval: Dict[Tuple[int, ChecksumAddress, ChecksumAddress], int] = {}
         self._cached_balance: Dict[Tuple[int, ChecksumAddress], int] = {}
         self._cached_total_supply: Dict[int, int] = {}
 
-        if not silent:
+        if not silent:  # pragma: no cover
             logger.info(f"• {self.symbol} ({self.name})")
 
     def __repr__(self) -> str:  # pragma: no cover
         return f"Erc20Token(address={self.address}, symbol='{self.symbol}', name='{self.name}', decimals={self.decimals})"
 
     @property
     def _w3_contract(self) -> Contract:
@@ -313,16 +289,19 @@
         return total_supply
 
     def get_total_supply(self, block_identifier: BlockIdentifier | None = None) -> int:
         """
         Retrieve the total supply for this token.
         """
 
-        if block_identifier is None:
-            block_identifier = config.get_web3().eth.get_block_number()
+        block_identifier = (
+            config.get_web3().eth.get_block_number()
+            if block_identifier is None
+            else block_identifier
+        )
 
         return self._get_total_supply_cachable(
             block_number=get_number_for_block_identifier(block_identifier)
         )
 
     def update_price(self) -> None:
         self._price_oracle.update_price()
```

### Comparing `degenbot-0.2.2/src/degenbot/exceptions.py` & `degenbot-0.2.3/src/degenbot/exceptions.py`

 * *Files 3% similar despite different names*

```diff
@@ -17,20 +17,14 @@
 # 1st level exceptions (derived from `DegenbotError`)
 class ArbitrageError(DegenbotError):
     """
     Exception raised inside arbitrage helpers
     """
 
 
-class BlockUnavailableError(DegenbotError):
-    """
-    Exception raised when a call for a specific block fails (trie node unavailable)
-    """
-
-
 class Erc20TokenError(DegenbotError):
     """
     Exception raised inside ERC-20 token helpers
     """
 
 
 class EVMRevertError(DegenbotError):
@@ -101,14 +95,20 @@
 
 class ExternalUpdateError(LiquidityPoolError):
     """
     Raised when an external update does not pass sanity checks
     """
 
 
+class InsufficientAmountOutError(LiquidityPoolError):
+    """
+    Raised if an exact output swap results in fewer tokens than requested
+    """
+
+
 class MissingTickWordError(LiquidityPoolError):
     """
     Raised by the TickBitmap library when calling for an operation on a word that
     should be available, but is not
     """
```

### Comparing `degenbot-0.2.2/src/degenbot/fork/anvil_fork.py` & `degenbot-0.2.3/src/degenbot/fork/anvil_fork.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,61 +1,68 @@
 import os
 import shutil
 import socket
 import subprocess
-from typing import Any, Dict, Iterable, List, Tuple
+from typing import Any, Dict, Iterable, List, Literal, Tuple, cast
 
 import ujson
 from eth_typing import HexAddress
 from eth_utils.address import to_checksum_address
 from hexbytes import HexBytes
 from web3 import IPCProvider, Web3
 from web3.types import Middleware
 
 from ..constants import MAX_UINT256
+from ..logging import logger
 
 _SOCKET_READ_BUFFER_SIZE = 4096  # https://docs.python.org/3/library/socket.html#socket.socket.recv
 
 
 class AnvilFork:
     """
-    Launch an Anvil fork via subprocess and provide various methods for
-    interacting with it via JSON-RPC over the built-in IPC socket.
+    Launch an Anvil fork as a separate process and expose methods for commonly-used RPC calls.
+
+    Provides a `Web3` connector to Anvil's IPC socket endpoint at the `.w3` attribute.
     """
 
     def __init__(
         self,
         fork_url: str,
         fork_block: int | None = None,
         hardfork: str = "latest",
         gas_limit: int = 30_000_000,
         port: int | None = None,
         chain_id: int | None = None,
+        mining_mode: Literal["auto", "interval", "none"] = "auto",
+        mining_interval: int = 12,
+        storage_caching: bool = True,
         base_fee: int | None = None,
         ipc_path: str | None = None,
         mnemonic: str = (
             # Default mnemonic used by Brownie for Ganache forks
             "patient rude simple dog close planet oval animal hunt sketch suspect slim"
         ),
         coinbase: HexAddress | None = None,
         middlewares: List[Tuple[Middleware, int]] | None = None,
         balance_overrides: Iterable[Tuple[HexAddress, int]] | None = None,
         bytecode_overrides: Iterable[Tuple[HexAddress, bytes]] | None = None,
+        ipc_provider_kwargs: Dict[str, Any] | None = None,
     ):
-        if shutil.which("anvil") is None:  # pragma: no cover
-            raise Exception("Anvil is not installed or not accessible in the current path.")
-
-        if not port:
+        def get_free_port_number() -> int:
             with socket.socket() as sock:
                 sock.bind(("", 0))
                 _, port = sock.getsockname()
-        self.port = port
+                return cast(int, port)
+
+        if shutil.which("anvil") is None:  # pragma: no cover
+            raise Exception("Anvil is not installed or not accessible in the current path.")
 
-        if not ipc_path:
-            ipc_path = f"/tmp/anvil-{self.port}.ipc"
+        self.port = port if port is not None else get_free_port_number()
+
+        ipc_path = f"/tmp/anvil-{self.port}.ipc" if ipc_path is None else ipc_path
 
         command = []
         command.append("anvil")
         command.append("--silent")
         command.append("--auto-impersonate")
         command.append("--no-rate-limit")
         command.append(f"--fork-url={fork_url}")
@@ -66,40 +73,52 @@
         command.append(f"--mnemonic={mnemonic}")
         if fork_block:
             command.append(f"--fork-block-number={fork_block}")
         if chain_id:
             command.append(f"--chain-id={chain_id}")
         if base_fee:
             command.append(f"--base-fee={base_fee}")
+        if storage_caching is False:
+            command.append("--no-storage-caching")
+        match mining_mode:
+            case "auto":
+                pass
+            case "interval":
+                logger.debug(f"Using 'interval' mining with {mining_interval}s block times.")
+                command.append(f"--block-time={mining_interval}")
+            case "none":
+                command.append("--no-mining")
+                command.append("--order=fifo")
+            case _:
+                raise ValueError(f"Unknown mining mode '{mining_mode}'.")
 
         self._process = subprocess.Popen(command)
         self.fork_url = fork_url
         self.http_url = f"http://localhost:{self.port}"
         self.ws_url = f"ws://localhost:{self.port}"
         self.ipc_path = ipc_path
-        self.w3 = Web3(IPCProvider(ipc_path))
+
+        if ipc_provider_kwargs is None:
+            ipc_provider_kwargs = dict()
+        self.w3 = Web3(IPCProvider(ipc_path=ipc_path, **ipc_provider_kwargs))
 
         if middlewares is not None:
             for middleware, layer in middlewares:
                 self.w3.middleware_onion.inject(middleware, layer=layer)
 
         while self.w3.is_connected() is False:
             continue
 
         self.socket = socket.socket(socket.AF_UNIX)
         self.socket.connect(self.ipc_path)
 
-        self.block_number = fork_block if fork_block is not None else self.w3.eth.get_block_number()
-        self.base_fee = (
-            base_fee
-            if base_fee is not None
-            else self.w3.eth.get_block(self.block_number)["baseFeePerGas"]
+        self._initial_block_number = (
+            fork_block if fork_block is not None else self.w3.eth.get_block_number()
         )
-        self.base_fee_next: int | None = None
-        self.chain_id: int = chain_id if chain_id is not None else self.w3.eth.chain_id
+        self.chain_id = chain_id if chain_id is not None else self.w3.eth.chain_id
 
         if balance_overrides is not None:
             for account, balance in balance_overrides:
                 self.set_balance(account, balance)
 
         if bytecode_overrides is not None:
             for account, bytecode in bytecode_overrides:
@@ -107,18 +126,20 @@
 
         if coinbase is not None:
             self.set_coinbase(coinbase)
 
     def __del__(self) -> None:
         self._process.terminate()
         self._process.wait()
-        if os.path.exists(self.ipc_path):
+        try:
             os.remove(self.ipc_path)
+        except Exception:
+            pass
 
-    def _send_request(self, method: str, params: List[Any] | None = None) -> None:
+    def _socket_request(self, method: str, params: List[Any] | None = None) -> None:
         """
         Send a JSON-formatted request through the socket.
         """
         if params is None:
             params = []
 
         self.socket.sendall(
@@ -131,43 +152,30 @@
                         "params": params,
                     }
                 ),
                 encoding="utf-8",
             ),
         )
 
-    def _get_response(self) -> Any:
+    def _socket_response(self) -> Any:
         """
         Read the response payload from socket and return the JSON-decoded result.
         """
         raw_response = b""
         response: Dict[str, Any]
         while True:
             try:
                 raw_response += self.socket.recv(_SOCKET_READ_BUFFER_SIZE).rstrip()
-            except socket.timeout:
+                response = ujson.loads(raw_response)
+                break
+            except socket.timeout:  # pragma: no cover
+                continue
+            except ujson.JSONDecodeError:  # pragma: no cover
+                # Typically thrown if a long response does not fit in buffer length
                 continue
-
-            if raw_response.endswith(
-                (
-                    b"}",
-                    b"]",
-                )
-            ):
-                # Valid JSON RPC responses will end in } or ]
-                # ref: http://www.jsonrpc.org/specification
-                try:
-                    response = ujson.loads(raw_response)
-                except ujson.JSONDecodeError:
-                    # The end of the response might end in } or ] if the last byte is the closing
-                    # character of an array or map. If there are more bytes remaining, the JSON
-                    # string will fail to decode correctly, so continue reading from the socket.
-                    continue
-                else:
-                    break
 
         if response.get("error"):
             raise Exception(f"Error in response: {response}")
         return response["result"]
 
     def create_access_list(self, transaction: Dict[Any, Any]) -> Any:
         # Exclude transaction values that are irrelevant for the JSON-RPC method
@@ -175,96 +183,96 @@
         keys_to_drop = ("gasPrice", "maxFeePerGas", "maxPriorityFeePerGas", "gas", "chainId")
         sanitized_tx = {k: v for k, v in transaction.items() if k not in keys_to_drop}
 
         # Apply int->hex conversion to some transaction values
         # ref: https://docs.infura.io/networks/ethereum/json-rpc-methods/eth_createaccesslist
         keys_to_hexify = ("value", "nonce")
         for key in keys_to_hexify:
-            if key in sanitized_tx:
-                if isinstance(sanitized_tx[key], int):
-                    sanitized_tx[key] = hex(sanitized_tx[key])
+            if key in sanitized_tx and isinstance(sanitized_tx[key], int):
+                sanitized_tx[key] = hex(sanitized_tx[key])
 
-        self._send_request(
+        self._socket_request(
             method="eth_createAccessList",
             params=[sanitized_tx],
         )
-        response: Dict[Any, Any] = self._get_response()
+        response: Dict[Any, Any] = self._socket_response()
         return response["accessList"]
 
+    def mine(self) -> None:
+        self._socket_request(method="evm_mine")
+        self._socket_response()
+
     def reset(
         self,
         fork_url: str | None = None,
         block_number: int | None = None,
+        base_fee: int | None = None,
     ) -> None:
         forking_params: Dict[str, Any] = {
             "jsonRpcUrl": fork_url if fork_url is not None else self.fork_url,
-            "blockNumber": block_number if block_number is not None else self.block_number,
+            "blockNumber": block_number if block_number is not None else self._initial_block_number,
         }
 
-        self._send_request(
+        self._socket_request(
             method="anvil_reset",
             params=[{"forking": forking_params}],
         )
-        self._get_response()
+        self._socket_response()
 
-        if block_number:
-            self.block_number = block_number
-        if fork_url:
+        if fork_url is not None:
             self.fork_url = fork_url
-
-    def mine(self) -> None:
-        self._send_request(method="evm_mine")
-        self._get_response()
+        if base_fee is not None:
+            self.set_next_base_fee(base_fee)
 
     def return_to_snapshot(self, id: int) -> bool:
         if id < 0:
             raise ValueError("ID cannot be negative")
-        self._send_request(
+        self._socket_request(
             method="evm_revert",
             params=[id],
         )
-        return bool(self._get_response())
+        return bool(self._socket_response())
 
     def set_balance(self, address: str, balance: int) -> None:
         if not (0 <= balance <= MAX_UINT256):
             raise ValueError("Invalid balance, must be within range: 0 <= balance <= 2**256 - 1")
-        self._send_request(
+        self._socket_request(
             method="anvil_setBalance",
             params=[
                 to_checksum_address(address),
                 hex(balance),
             ],
         )
-        self._get_response()
-
-    def set_coinbase(self, address: str) -> None:
-        self._send_request(
-            method="anvil_setCoinbase",
-            params=[HexBytes(address).hex()],
-        )
-        self._get_response()
+        self._socket_response()
 
     def set_code(self, address: str, bytecode: bytes) -> None:
-        self._send_request(
+        self._socket_request(
             method="anvil_setCode",
             params=[
                 HexBytes(address).hex(),
                 HexBytes(bytecode).hex(),
             ],
         )
-        self._get_response()
+        self._socket_response()
+
+    def set_coinbase(self, address: str) -> None:
+        self._socket_request(
+            method="anvil_setCoinbase",
+            params=[HexBytes(address).hex()],
+        )
+        self._socket_response()
 
     def set_next_base_fee(self, fee: int) -> None:
         if not (0 <= fee <= MAX_UINT256):
             raise ValueError("Fee outside valid range 0 <= fee <= 2**256-1")
-        self._send_request(
+        self._socket_request(
             method="anvil_setNextBlockBaseFeePerGas",
             params=[hex(fee)],
         )
-        self._get_response()
+        self._socket_response()
         self.base_fee_next = fee
 
     def set_snapshot(self) -> int:
-        self._send_request(
+        self._socket_request(
             method="evm_snapshot",
         )
-        return int(self._get_response(), 16)
+        return int(self._socket_response(), 16)
```

### Comparing `degenbot-0.2.2/src/degenbot/functions.py` & `degenbot-0.2.3/src/degenbot/functions.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/manager/token_manager.py` & `degenbot-0.2.3/src/degenbot/manager/token_manager.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/registry/all_pools.py` & `degenbot-0.2.3/src/degenbot/registry/all_pools.py`

 * *Files 5% similar despite different names*

```diff
@@ -2,17 +2,16 @@
 
 from eth_typing import ChecksumAddress
 from eth_utils.address import to_checksum_address
 
 from ..baseclasses import BaseLiquidityPool
 from ..logging import logger
 
-# Internal state dictionary that maintains a keyed dictionary of all
-# pool helper objects. The top level dict is keyed by chain ID, and
-# sub-dicts are keyed by the checksummed pool address.
+# Internal state dictionary that maintains a keyed dictionary of all pool objects. The top level
+# dict is keyed by chain ID, and sub-dicts are keyed by the checksummed pool address.
 _all_pools: Dict[
     int,
     Dict[ChecksumAddress, BaseLiquidityPool],
 ] = {}
 
 
 class AllPools:
@@ -20,30 +19,37 @@
         try:
             _all_pools[chain_id]
         except KeyError:
             _all_pools[chain_id] = {}
         finally:
             self.pools = _all_pools[chain_id]
 
+    def __contains__(self, pool: BaseLiquidityPool | str) -> bool:
+        if isinstance(pool, BaseLiquidityPool):
+            _pool_address = pool.address
+        else:
+            _pool_address = to_checksum_address(pool)
+        return _pool_address in self.pools
+
     def __delitem__(self, pool: BaseLiquidityPool | str) -> None:
         if isinstance(pool, BaseLiquidityPool):
             _pool_address = pool.address
         else:
             _pool_address = to_checksum_address(pool)
         del self.pools[_pool_address]
 
     def __getitem__(self, pool_address: str) -> BaseLiquidityPool:
         return self.pools[to_checksum_address(pool_address)]
 
     def __setitem__(self, pool_address: str, pool_helper: BaseLiquidityPool) -> None:
         _pool_address = to_checksum_address(pool_address)
-        if self.pools.get(_pool_address):
+        if _pool_address in self.pools:  # pragma: no cover
             logger.warning(
-                f"A pool helper with address {_pool_address} already exists! It has been overwritten."
+                f"Pool with address {_pool_address} already known. It has been overwritten."
             )
         self.pools[_pool_address] = pool_helper
 
-    def __len__(self) -> int:
+    def __len__(self) -> int:  # pragma: no cover
         return len(self.pools)
 
     def get(self, pool_address: str) -> BaseLiquidityPool | None:
         return self.pools.get(to_checksum_address(pool_address))
```

### Comparing `degenbot-0.2.2/src/degenbot/transaction/simulation_ledger.py` & `degenbot-0.2.3/src/degenbot/transaction/simulation_ledger.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/transaction/uniswap_transaction.py` & `degenbot-0.2.3/src/degenbot/transaction/uniswap_transaction.py`

 * *Files 24% similar despite different names*

```diff
@@ -7,6646 +7,7782 @@
 00000060: 706f 7261 7465 2074 7279 2f65 7863 6570  porate try/excep
 00000070: 7420 666f 7220 616c 6c20 5633 2070 6f6f  t for all V3 poo
 00000080: 6c20 6d61 6e61 6765 7220 6765 745f 706f  l manager get_po
 00000090: 6f6c 2063 616c 6c73 0a23 2054 4f44 4f3a  ol calls.# TODO:
 000000a0: 2061 6464 2073 7461 7465 2062 6c6f 636b   add state block
 000000b0: 2061 7267 756d 656e 7420 666f 7220 706f   argument for po
 000000c0: 6f6c 2073 696d 756c 6174 696f 6e20 6361  ol simulation ca
-000000d0: 6c6c 730a 0a69 6d70 6f72 7420 7070 7269  lls..import ppri
-000000e0: 6e74 0a66 726f 6d20 7479 7069 6e67 2069  nt.from typing i
-000000f0: 6d70 6f72 7420 5459 5045 5f43 4845 434b  mport TYPE_CHECK
-00000100: 494e 472c 2041 6e79 2c20 4469 6374 2c20  ING, Any, Dict, 
-00000110: 4c69 7374 2c20 5365 742c 2054 7570 6c65  List, Set, Tuple
-00000120: 2c20 6361 7374 0a0a 696d 706f 7274 2065  , cast..import e
-00000130: 7468 5f61 6269 2e61 6269 0a66 726f 6d20  th_abi.abi.from 
-00000140: 6574 685f 7479 7069 6e67 2069 6d70 6f72  eth_typing impor
-00000150: 7420 426c 6f63 6b4e 756d 6265 722c 2043  t BlockNumber, C
-00000160: 6861 696e 4964 2c20 4368 6563 6b73 756d  hainId, Checksum
-00000170: 4164 6472 6573 730a 6672 6f6d 2065 7468  Address.from eth
-00000180: 5f75 7469 6c73 2e61 6464 7265 7373 2069  _utils.address i
-00000190: 6d70 6f72 7420 746f 5f63 6865 636b 7375  mport to_checksu
-000001a0: 6d5f 6164 6472 6573 730a 6672 6f6d 2068  m_address.from h
-000001b0: 6578 6279 7465 7320 696d 706f 7274 2048  exbytes import H
-000001c0: 6578 4279 7465 730a 6672 6f6d 2077 6562  exBytes.from web
-000001d0: 3320 696d 706f 7274 2057 6562 330a 0a66  3 import Web3..f
-000001e0: 726f 6d20 2e2e 2069 6d70 6f72 7420 636f  rom .. import co
-000001f0: 6e66 6967 0a66 726f 6d20 2e2e 6261 7365  nfig.from ..base
-00000200: 636c 6173 7365 7320 696d 706f 7274 2042  classes import B
-00000210: 6173 6553 696d 756c 6174 696f 6e52 6573  aseSimulationRes
-00000220: 756c 742c 2042 6173 6554 7261 6e73 6163  ult, BaseTransac
-00000230: 7469 6f6e 0a66 726f 6d20 2e2e 636f 6e73  tion.from ..cons
-00000240: 7461 6e74 7320 696d 706f 7274 2057 5241  tants import WRA
-00000250: 5050 4544 5f4e 4154 4956 455f 544f 4b45  PPED_NATIVE_TOKE
-00000260: 4e53 0a66 726f 6d20 2e2e 6572 6332 305f  NS.from ..erc20_
-00000270: 746f 6b65 6e20 696d 706f 7274 2045 7263  token import Erc
-00000280: 3230 546f 6b65 6e0a 6672 6f6d 202e 2e65  20Token.from ..e
-00000290: 7863 6570 7469 6f6e 7320 696d 706f 7274  xceptions import
-000002a0: 2028 0a20 2020 2044 6567 656e 626f 7445   (.    DegenbotE
-000002b0: 7272 6f72 2c0a 2020 2020 4556 4d52 6576  rror,.    EVMRev
-000002c0: 6572 7445 7272 6f72 2c0a 2020 2020 4c65  ertError,.    Le
-000002d0: 6467 6572 4572 726f 722c 0a20 2020 204c  dgerError,.    L
-000002e0: 6971 7569 6469 7479 506f 6f6c 4572 726f  iquidityPoolErro
-000002f0: 722c 0a20 2020 204d 616e 6167 6572 4572  r,.    ManagerEr
-00000300: 726f 722c 0a20 2020 2054 7261 6e73 6163  ror,.    Transac
-00000310: 7469 6f6e 4572 726f 722c 0a29 0a66 726f  tionError,.).fro
-00000320: 6d20 2e2e 6c6f 6767 696e 6720 696d 706f  m ..logging impo
-00000330: 7274 206c 6f67 6765 720a 6672 6f6d 202e  rt logger.from .
-00000340: 2e75 6e69 7377 6170 2e61 6269 2069 6d70  .uniswap.abi imp
-00000350: 6f72 7420 554e 4953 5741 505f 5633 5f52  ort UNISWAP_V3_R
-00000360: 4f55 5445 5232 5f41 4249 2c20 554e 4953  OUTER2_ABI, UNIS
-00000370: 5741 505f 5633 5f52 4f55 5445 525f 4142  WAP_V3_ROUTER_AB
-00000380: 490a 6672 6f6d 202e 2e75 6e69 7377 6170  I.from ..uniswap
-00000390: 2e6d 616e 6167 6572 7320 696d 706f 7274  .managers import
-000003a0: 2055 6e69 7377 6170 5632 4c69 7175 6964   UniswapV2Liquid
-000003b0: 6974 7950 6f6f 6c4d 616e 6167 6572 2c20  ityPoolManager, 
-000003c0: 556e 6973 7761 7056 334c 6971 7569 6469  UniswapV3Liquidi
-000003d0: 7479 506f 6f6c 4d61 6e61 6765 720a 6672  tyPoolManager.fr
-000003e0: 6f6d 202e 2e75 6e69 7377 6170 2e76 325f  om ..uniswap.v2_
-000003f0: 6461 7461 636c 6173 7365 7320 696d 706f  dataclasses impo
-00000400: 7274 2055 6e69 7377 6170 5632 506f 6f6c  rt UniswapV2Pool
-00000410: 5369 6d75 6c61 7469 6f6e 5265 7375 6c74  SimulationResult
-00000420: 2c20 556e 6973 7761 7056 3250 6f6f 6c53  , UniswapV2PoolS
-00000430: 7461 7465 0a66 726f 6d20 2e2e 756e 6973  tate.from ..unis
-00000440: 7761 702e 7632 5f66 756e 6374 696f 6e73  wap.v2_functions
-00000450: 2069 6d70 6f72 7420 6765 6e65 7261 7465   import generate
-00000460: 5f76 325f 706f 6f6c 5f61 6464 7265 7373  _v2_pool_address
-00000470: 2c20 6765 745f 7632 5f70 6f6f 6c73 5f66  , get_v2_pools_f
-00000480: 726f 6d5f 746f 6b65 6e5f 7061 7468 0a66  rom_token_path.f
-00000490: 726f 6d20 2e2e 756e 6973 7761 702e 7632  rom ..uniswap.v2
-000004a0: 5f6c 6971 7569 6469 7479 5f70 6f6f 6c20  _liquidity_pool 
-000004b0: 696d 706f 7274 204c 6971 7569 6469 7479  import Liquidity
-000004c0: 506f 6f6c 0a66 726f 6d20 2e2e 756e 6973  Pool.from ..unis
-000004d0: 7761 702e 7633 5f64 6174 6163 6c61 7373  wap.v3_dataclass
-000004e0: 6573 2069 6d70 6f72 7420 556e 6973 7761  es import Uniswa
-000004f0: 7056 3350 6f6f 6c53 696d 756c 6174 696f  pV3PoolSimulatio
-00000500: 6e52 6573 756c 742c 2055 6e69 7377 6170  nResult, Uniswap
-00000510: 5633 506f 6f6c 5374 6174 650a 6672 6f6d  V3PoolState.from
-00000520: 202e 2e75 6e69 7377 6170 2e76 335f 6675   ..uniswap.v3_fu
-00000530: 6e63 7469 6f6e 7320 696d 706f 7274 2064  nctions import d
-00000540: 6563 6f64 655f 7633 5f70 6174 680a 6672  ecode_v3_path.fr
-00000550: 6f6d 202e 2e75 6e69 7377 6170 2e76 335f  om ..uniswap.v3_
-00000560: 6c69 7175 6964 6974 795f 706f 6f6c 2069  liquidity_pool i
-00000570: 6d70 6f72 7420 5633 4c69 7175 6964 6974  mport V3Liquidit
-00000580: 7950 6f6f 6c0a 6672 6f6d 202e 7369 6d75  yPool.from .simu
-00000590: 6c61 7469 6f6e 5f6c 6564 6765 7220 696d  lation_ledger im
-000005a0: 706f 7274 2053 696d 756c 6174 696f 6e4c  port SimulationL
-000005b0: 6564 6765 720a 0a23 2049 6e74 6572 6e61  edger..# Interna
-000005c0: 6c20 6469 6374 206f 6620 6b6e 6f77 6e20  l dict of known 
-000005d0: 726f 7574 6572 2063 6f6e 7472 6163 7473  router contracts
-000005e0: 2062 7920 6368 6169 6e20 4944 2e20 5072   by chain ID. Pr
-000005f0: 652d 706f 7075 6c61 7465 6420 7769 7468  e-populated with
-00000600: 0a23 206d 6169 6e6e 6574 2061 6464 7265  .# mainnet addre
-00000610: 7373 6573 2e20 4e65 7720 726f 7574 6572  sses. New router
-00000620: 7320 6361 6e20 6265 2061 6464 6564 2062  s can be added b
-00000630: 7920 636c 6173 7320 6d65 7468 6f64 2060  y class method `
-00000640: 6164 645f 726f 7574 6572 600a 5f52 4f55  add_router`._ROU
-00000650: 5445 5253 3a20 4469 6374 5b0a 2020 2020  TERS: Dict[.    
-00000660: 696e 742c 2020 2320 6368 6169 6e20 4944  int,  # chain ID
-00000670: 0a20 2020 2044 6963 745b 4368 6563 6b73  .    Dict[Checks
-00000680: 756d 4164 6472 6573 732c 2044 6963 745b  umAddress, Dict[
-00000690: 7374 722c 2041 6e79 5d5d 2c0a 5d0a 5f52  str, Any]],.]._R
-000006a0: 4f55 5445 5253 203d 207b 0a20 2020 2043  OUTERS = {.    C
-000006b0: 6861 696e 4964 2e45 5448 3a20 7b0a 2020  hainId.ETH: {.  
-000006c0: 2020 2020 2020 746f 5f63 6865 636b 7375        to_checksu
-000006d0: 6d5f 6164 6472 6573 7328 2230 7864 3965  m_address("0xd9e
-000006e0: 3163 4531 3766 3236 3431 6632 3461 4538  1cE17f2641f24aE8
-000006f0: 3336 3337 6162 3636 6132 6363 6139 4333  3637ab66a2cca9C3
-00000700: 3738 4239 4622 293a 207b 0a20 2020 2020  78B9F"): {.     
-00000710: 2020 2020 2020 2022 6e61 6d65 223a 2022         "name": "
-00000720: 5375 7368 6973 7761 703a 2052 6f75 7465  Sushiswap: Route
-00000730: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-00000740: 2266 6163 746f 7279 5f61 6464 7265 7373  "factory_address
-00000750: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00000760: 2020 2020 2032 3a20 746f 5f63 6865 636b       2: to_check
-00000770: 7375 6d5f 6164 6472 6573 7328 2230 7843  sum_address("0xC
-00000780: 3041 4565 3437 3865 3336 3538 6532 3631  0AEe478e3658e261
-00000790: 3063 3546 3741 3441 3245 3137 3737 6345  0c5F7A4A2E1777cE
-000007a0: 3965 3466 3241 6322 290a 2020 2020 2020  9e4f2Ac").      
-000007b0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000007c0: 207d 2c0a 2020 2020 2020 2020 746f 5f63   },.        to_c
-000007d0: 6865 636b 7375 6d5f 6164 6472 6573 7328  hecksum_address(
-000007e0: 2230 7866 3136 3466 4330 4563 3445 3933  "0xf164fC0Ec4E93
-000007f0: 3039 3562 3830 3461 3437 3935 6242 6531  095b804a4795bBe1
-00000800: 6530 3431 3439 3762 3932 6122 293a 207b  e041497b92a"): {
-00000810: 0a20 2020 2020 2020 2020 2020 2022 6e61  .            "na
-00000820: 6d65 223a 2022 556e 6973 7761 7056 323a  me": "UniswapV2:
-00000830: 2052 6f75 7465 7222 2c0a 2020 2020 2020   Router",.      
-00000840: 2020 2020 2020 2266 6163 746f 7279 5f61        "factory_a
-00000850: 6464 7265 7373 223a 207b 0a20 2020 2020  ddress": {.     
-00000860: 2020 2020 2020 2020 2020 2032 3a20 746f             2: to
-00000870: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
-00000880: 7328 2230 7835 4336 3962 4565 3730 3165  s("0x5C69bEe701e
-00000890: 6638 3134 6132 4236 6133 4544 4434 4231  f814a2B6a3EDD4B1
-000008a0: 3635 3243 4239 6363 3561 4136 6622 290a  652CB9cc5aA6f").
-000008b0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-000008c0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000008d0: 2020 746f 5f63 6865 636b 7375 6d5f 6164    to_checksum_ad
-000008e0: 6472 6573 7328 2230 7837 6132 3530 6435  dress("0x7a250d5
-000008f0: 3633 3042 3463 4635 3339 3733 3964 4632  630B4cF539739dF2
-00000900: 4335 6441 6362 3463 3635 3946 3234 3838  C5dAcb4c659F2488
-00000910: 4422 293a 207b 0a20 2020 2020 2020 2020  D"): {.         
-00000920: 2020 2022 6e61 6d65 223a 2022 556e 6973     "name": "Unis
-00000930: 7761 7056 323a 2052 6f75 7465 7220 3222  wapV2: Router 2"
-00000940: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
-00000950: 6163 746f 7279 5f61 6464 7265 7373 223a  actory_address":
-00000960: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00000970: 2020 2032 3a20 746f 5f63 6865 636b 7375     2: to_checksu
-00000980: 6d5f 6164 6472 6573 7328 2230 7835 4336  m_address("0x5C6
-00000990: 3962 4565 3730 3165 6638 3134 6132 4236  9bEe701ef814a2B6
-000009a0: 6133 4544 4434 4231 3635 3243 4239 6363  a3EDD4B1652CB9cc
-000009b0: 3561 4136 6622 290a 2020 2020 2020 2020  5aA6f").        
-000009c0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-000009d0: 2c0a 2020 2020 2020 2020 746f 5f63 6865  ,.        to_che
-000009e0: 636b 7375 6d5f 6164 6472 6573 7328 2230  cksum_address("0
-000009f0: 7845 3539 3234 3237 4130 4145 6365 3932  xE592427A0AEce92
-00000a00: 4465 3345 6465 6531 4631 3845 3031 3537  De3Edee1F18E0157
-00000a10: 4330 3538 3631 3536 3422 293a 207b 0a20  C05861564"): {. 
-00000a20: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-00000a30: 223a 2022 556e 6973 7761 7056 333a 2052  ": "UniswapV3: R
-00000a40: 6f75 7465 7222 2c0a 2020 2020 2020 2020  outer",.        
-00000a50: 2020 2020 2266 6163 746f 7279 5f61 6464      "factory_add
-00000a60: 7265 7373 223a 207b 0a20 2020 2020 2020  ress": {.       
-00000a70: 2020 2020 2020 2020 2033 3a20 746f 5f63           3: to_c
-00000a80: 6865 636b 7375 6d5f 6164 6472 6573 7328  hecksum_address(
-00000a90: 2230 7831 4639 3834 3331 6338 6144 3938  "0x1F98431c8aD98
-00000aa0: 3532 3336 3331 4145 3461 3539 6632 3637  523631AE4a59f267
-00000ab0: 3334 3665 6133 3146 3938 3422 290a 2020  346ea31F984").  
-00000ac0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00000ad0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00000ae0: 746f 5f63 6865 636b 7375 6d5f 6164 6472  to_checksum_addr
-00000af0: 6573 7328 2230 7836 3862 3334 3635 3833  ess("0x68b346583
-00000b00: 3366 6237 3241 3730 6563 4446 3438 3545  3fb72A70ecDF485E
-00000b10: 3065 3443 3762 4438 3636 3546 6334 3522  0e4C7bD8665Fc45"
-00000b20: 293a 207b 0a20 2020 2020 2020 2020 2020  ): {.           
-00000b30: 2022 6e61 6d65 223a 2022 556e 6973 7761   "name": "Uniswa
-00000b40: 7056 333a 2052 6f75 7465 7220 3222 2c0a  pV3: Router 2",.
-00000b50: 2020 2020 2020 2020 2020 2020 2266 6163              "fac
-00000b60: 746f 7279 5f61 6464 7265 7373 223a 207b  tory_address": {
-00000b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000b80: 2032 3a20 746f 5f63 6865 636b 7375 6d5f   2: to_checksum_
-00000b90: 6164 6472 6573 7328 2230 7835 4336 3962  address("0x5C69b
-00000ba0: 4565 3730 3165 6638 3134 6132 4236 6133  Ee701ef814a2B6a3
-00000bb0: 4544 4434 4231 3635 3243 4239 6363 3561  EDD4B1652CB9cc5a
-00000bc0: 4136 6622 292c 0a20 2020 2020 2020 2020  A6f"),.         
-00000bd0: 2020 2020 2020 2033 3a20 746f 5f63 6865         3: to_che
-00000be0: 636b 7375 6d5f 6164 6472 6573 7328 2230  cksum_address("0
-00000bf0: 7831 4639 3834 3331 6338 6144 3938 3532  x1F98431c8aD9852
-00000c00: 3336 3331 4145 3461 3539 6632 3637 3334  3631AE4a59f26734
-00000c10: 3665 6133 3146 3938 3422 292c 0a20 2020  6ea31F984"),.   
-00000c20: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00000c30: 2020 2020 7d2c 0a20 2020 2020 2020 2074      },.        t
-00000c40: 6f5f 6368 6563 6b73 756d 5f61 6464 7265  o_checksum_addre
-00000c50: 7373 2822 3078 4566 3163 3645 3637 3730  ss("0xEf1c6E6770
-00000c60: 3363 3742 4437 3130 3765 6564 3833 3033  3c7BD7107eed8303
-00000c70: 4662 6536 4543 3235 3534 4246 3642 2229  Fbe6EC2554BF6B")
-00000c80: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00000c90: 226e 616d 6522 3a20 2255 6e69 7377 6170  "name": "Uniswap
-00000ca0: 2055 6e69 7665 7273 616c 2052 6f75 7465   Universal Route
-00000cb0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-00000cc0: 2266 6163 746f 7279 5f61 6464 7265 7373  "factory_address
-00000cd0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
-00000ce0: 2020 2020 2032 3a20 746f 5f63 6865 636b       2: to_check
-00000cf0: 7375 6d5f 6164 6472 6573 7328 2230 7835  sum_address("0x5
-00000d00: 4336 3962 4565 3730 3165 6638 3134 6132  C69bEe701ef814a2
-00000d10: 4236 6133 4544 4434 4231 3635 3243 4239  B6a3EDD4B1652CB9
-00000d20: 6363 3561 4136 6622 292c 0a20 2020 2020  cc5aA6f"),.     
-00000d30: 2020 2020 2020 2020 2020 2033 3a20 746f             3: to
-00000d40: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
-00000d50: 7328 2230 7831 4639 3834 3331 6338 6144  s("0x1F98431c8aD
-00000d60: 3938 3532 3336 3331 4145 3461 3539 6632  98523631AE4a59f2
-00000d70: 3637 3334 3665 6133 3146 3938 3422 292c  67346ea31F984"),
-00000d80: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-00000d90: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00000da0: 2020 2074 6f5f 6368 6563 6b73 756d 5f61     to_checksum_a
-00000db0: 6464 7265 7373 2822 3078 3366 4339 3141  ddress("0x3fC91A
-00000dc0: 3361 6664 3730 3339 3543 6434 3936 4336  3afd70395Cd496C6
-00000dd0: 3437 6435 6136 4343 3944 3442 3262 3746  47d5a6CC9D4B2b7F
-00000de0: 4144 2229 3a20 7b0a 2020 2020 2020 2020  AD"): {.        
-00000df0: 2020 2020 226e 616d 6522 3a20 2255 6e69      "name": "Uni
-00000e00: 7665 7273 616c 2055 6e69 7665 7273 616c  versal Universal
-00000e10: 2052 6f75 7465 7220 2856 315f 3229 222c   Router (V1_2)",
-00000e20: 0a20 2020 2020 2020 2020 2020 2022 6661  .            "fa
-00000e30: 6374 6f72 795f 6164 6472 6573 7322 3a20  ctory_address": 
-00000e40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00000e50: 2020 323a 2074 6f5f 6368 6563 6b73 756d    2: to_checksum
-00000e60: 5f61 6464 7265 7373 2822 3078 3543 3639  _address("0x5C69
-00000e70: 6245 6537 3031 6566 3831 3461 3242 3661  bEe701ef814a2B6a
-00000e80: 3345 4444 3442 3136 3532 4342 3963 6335  3EDD4B1652CB9cc5
-00000e90: 6141 3666 2229 2c0a 2020 2020 2020 2020  aA6f"),.        
-00000ea0: 2020 2020 2020 2020 333a 2074 6f5f 6368          3: to_ch
-00000eb0: 6563 6b73 756d 5f61 6464 7265 7373 2822  ecksum_address("
-00000ec0: 3078 3146 3938 3433 3163 3861 4439 3835  0x1F98431c8aD985
-00000ed0: 3233 3633 3141 4534 6135 3966 3236 3733  23631AE4a59f2673
-00000ee0: 3436 6561 3331 4639 3834 2229 2c0a 2020  46ea31F984"),.  
-00000ef0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00000f00: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00000f10: 746f 5f63 6865 636b 7375 6d5f 6164 6472  to_checksum_addr
-00000f20: 6573 7328 2230 7833 4636 3332 3836 3639  ess("0x3F6328669
-00000f30: 6138 3662 6566 3433 3144 6336 4639 3230  a86bef431Dc6F920
-00000f40: 3141 3542 3930 4637 3937 3561 3032 3322  1A5B90F7975a023"
-00000f50: 293a 207b 0a20 2020 2020 2020 2020 2020  ): {.           
-00000f60: 2022 6e61 6d65 223a 2022 556e 6976 6572   "name": "Univer
-00000f70: 7361 6c20 556e 6976 6572 7361 6c20 526f  sal Universal Ro
-00000f80: 7574 6572 2028 5631 5f33 2922 2c0a 2020  uter (V1_3)",.  
-00000f90: 2020 2020 2020 2020 2020 2266 6163 746f            "facto
-00000fa0: 7279 5f61 6464 7265 7373 223a 207b 0a20  ry_address": {. 
-00000fb0: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-00000fc0: 3a20 746f 5f63 6865 636b 7375 6d5f 6164  : to_checksum_ad
-00000fd0: 6472 6573 7328 2230 7835 4336 3962 4565  dress("0x5C69bEe
-00000fe0: 3730 3165 6638 3134 6132 4236 6133 4544  701ef814a2B6a3ED
-00000ff0: 4434 4231 3635 3243 4239 6363 3561 4136  D4B1652CB9cc5aA6
-00001000: 6622 292c 0a20 2020 2020 2020 2020 2020  f"),.           
-00001010: 2020 2020 2033 3a20 746f 5f63 6865 636b       3: to_check
-00001020: 7375 6d5f 6164 6472 6573 7328 2230 7831  sum_address("0x1
-00001030: 4639 3834 3331 6338 6144 3938 3532 3336  F98431c8aD985236
-00001040: 3331 4145 3461 3539 6632 3637 3334 3665  31AE4a59f267346e
-00001050: 6133 3146 3938 3422 292c 0a20 2020 2020  a31F984"),.     
-00001060: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00001070: 2020 7d2c 0a20 2020 207d 0a7d 0a0a 0a63    },.    }.}...c
-00001080: 6c61 7373 2055 6e69 7665 7273 616c 526f  lass UniversalRo
-00001090: 7574 6572 5370 6563 6961 6c41 6464 7265  uterSpecialAddre
-000010a0: 7373 3a0a 2020 2020 2320 7265 663a 2068  ss:.    # ref: h
-000010b0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-000010c0: 6d2f 556e 6973 7761 702f 756e 6976 6572  m/Uniswap/univer
-000010d0: 7361 6c2d 726f 7574 6572 2f62 6c6f 622f  sal-router/blob/
-000010e0: 6465 706c 6f79 6564 2d63 6f6d 6d69 742f  deployed-commit/
-000010f0: 636f 6e74 7261 6374 732f 6c69 6272 6172  contracts/librar
-00001100: 6965 732f 436f 6e73 7461 6e74 732e 736f  ies/Constants.so
-00001110: 6c0a 2020 2020 4554 4820 3d20 746f 5f63  l.    ETH = to_c
-00001120: 6865 636b 7375 6d5f 6164 6472 6573 7328  hecksum_address(
-00001130: 2230 7830 3030 3030 3030 3030 3030 3030  "0x0000000000000
-00001140: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-00001150: 3030 3030 3030 3030 3030 3022 290a 2020  00000000000").  
-00001160: 2020 4d53 475f 5345 4e44 4552 203d 2074    MSG_SENDER = t
-00001170: 6f5f 6368 6563 6b73 756d 5f61 6464 7265  o_checksum_addre
-00001180: 7373 2822 3078 3030 3030 3030 3030 3030  ss("0x0000000000
+000000d0: 6c6c 730a 2320 544f 444f 3a20 696e 7374  lls.# TODO: inst
+000000e0: 6561 6420 6f66 2061 7070 656e 6469 6e67  ead of appending
+000000f0: 2070 6f6f 6c20 7374 6174 6573 2074 6f20   pool states to 
+00000100: 6c69 7374 2c20 7265 706c 6163 6520 7769  list, replace wi
+00000110: 7468 2064 6963 7420 616e 6420 6f6e 6c79  th dict and only
+00000120: 2072 6574 7572 6e20 6669 6e61 6c20 7374   return final st
+00000130: 6174 6520 7374 6174 650a 0a66 726f 6d20  ate state..from 
+00000140: 7479 7069 6e67 2069 6d70 6f72 7420 5459  typing import TY
+00000150: 5045 5f43 4845 434b 494e 472c 2041 6e79  PE_CHECKING, Any
+00000160: 2c20 4469 6374 2c20 4c69 7374 2c20 5365  , Dict, List, Se
+00000170: 742c 2054 7570 6c65 2c20 6361 7374 0a0a  t, Tuple, cast..
+00000180: 696d 706f 7274 2065 7468 5f61 6269 2e61  import eth_abi.a
+00000190: 6269 0a66 726f 6d20 6574 685f 7479 7069  bi.from eth_typi
+000001a0: 6e67 2069 6d70 6f72 7420 426c 6f63 6b4e  ng import BlockN
+000001b0: 756d 6265 722c 2043 6861 696e 4964 2c20  umber, ChainId, 
+000001c0: 4368 6563 6b73 756d 4164 6472 6573 730a  ChecksumAddress.
+000001d0: 6672 6f6d 2065 7468 5f75 7469 6c73 2e61  from eth_utils.a
+000001e0: 6464 7265 7373 2069 6d70 6f72 7420 746f  ddress import to
+000001f0: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
+00000200: 730a 6672 6f6d 2068 6578 6279 7465 7320  s.from hexbytes 
+00000210: 696d 706f 7274 2048 6578 4279 7465 730a  import HexBytes.
+00000220: 6672 6f6d 2077 6562 3320 696d 706f 7274  from web3 import
+00000230: 2057 6562 330a 0a66 726f 6d20 2e2e 2069   Web3..from .. i
+00000240: 6d70 6f72 7420 636f 6e66 6967 0a66 726f  mport config.fro
+00000250: 6d20 2e2e 6261 7365 636c 6173 7365 7320  m ..baseclasses 
+00000260: 696d 706f 7274 2042 6173 6553 696d 756c  import BaseSimul
+00000270: 6174 696f 6e52 6573 756c 742c 2042 6173  ationResult, Bas
+00000280: 6554 7261 6e73 6163 7469 6f6e 0a66 726f  eTransaction.fro
+00000290: 6d20 2e2e 636f 6e73 7461 6e74 7320 696d  m ..constants im
+000002a0: 706f 7274 2057 5241 5050 4544 5f4e 4154  port WRAPPED_NAT
+000002b0: 4956 455f 544f 4b45 4e53 0a66 726f 6d20  IVE_TOKENS.from 
+000002c0: 2e2e 6572 6332 305f 746f 6b65 6e20 696d  ..erc20_token im
+000002d0: 706f 7274 2045 7263 3230 546f 6b65 6e0a  port Erc20Token.
+000002e0: 6672 6f6d 202e 2e65 7863 6570 7469 6f6e  from ..exception
+000002f0: 7320 696d 706f 7274 2028 0a20 2020 2044  s import (.    D
+00000300: 6567 656e 626f 7445 7272 6f72 2c0a 2020  egenbotError,.  
+00000310: 2020 4556 4d52 6576 6572 7445 7272 6f72    EVMRevertError
+00000320: 2c0a 2020 2020 4c65 6467 6572 4572 726f  ,.    LedgerErro
+00000330: 722c 0a20 2020 204c 6971 7569 6469 7479  r,.    Liquidity
+00000340: 506f 6f6c 4572 726f 722c 0a20 2020 204d  PoolError,.    M
+00000350: 616e 6167 6572 4572 726f 722c 0a20 2020  anagerError,.   
+00000360: 2054 7261 6e73 6163 7469 6f6e 4572 726f   TransactionErro
+00000370: 722c 0a29 0a66 726f 6d20 2e2e 6c6f 6767  r,.).from ..logg
+00000380: 696e 6720 696d 706f 7274 206c 6f67 6765  ing import logge
+00000390: 720a 6672 6f6d 202e 2e75 6e69 7377 6170  r.from ..uniswap
+000003a0: 2e61 6269 2069 6d70 6f72 7420 554e 4953  .abi import UNIS
+000003b0: 5741 505f 5633 5f52 4f55 5445 5232 5f41  WAP_V3_ROUTER2_A
+000003c0: 4249 2c20 554e 4953 5741 505f 5633 5f52  BI, UNISWAP_V3_R
+000003d0: 4f55 5445 525f 4142 490a 6672 6f6d 202e  OUTER_ABI.from .
+000003e0: 2e75 6e69 7377 6170 2e6d 616e 6167 6572  .uniswap.manager
+000003f0: 7320 696d 706f 7274 2055 6e69 7377 6170  s import Uniswap
+00000400: 5632 4c69 7175 6964 6974 7950 6f6f 6c4d  V2LiquidityPoolM
+00000410: 616e 6167 6572 2c20 556e 6973 7761 7056  anager, UniswapV
+00000420: 334c 6971 7569 6469 7479 506f 6f6c 4d61  3LiquidityPoolMa
+00000430: 6e61 6765 720a 6672 6f6d 202e 2e75 6e69  nager.from ..uni
+00000440: 7377 6170 2e76 325f 6461 7461 636c 6173  swap.v2_dataclas
+00000450: 7365 7320 696d 706f 7274 2055 6e69 7377  ses import Unisw
+00000460: 6170 5632 506f 6f6c 5369 6d75 6c61 7469  apV2PoolSimulati
+00000470: 6f6e 5265 7375 6c74 2c20 556e 6973 7761  onResult, Uniswa
+00000480: 7056 3250 6f6f 6c53 7461 7465 0a66 726f  pV2PoolState.fro
+00000490: 6d20 2e2e 756e 6973 7761 702e 7632 5f66  m ..uniswap.v2_f
+000004a0: 756e 6374 696f 6e73 2069 6d70 6f72 7420  unctions import 
+000004b0: 6765 6e65 7261 7465 5f76 325f 706f 6f6c  generate_v2_pool
+000004c0: 5f61 6464 7265 7373 2c20 6765 745f 7632  _address, get_v2
+000004d0: 5f70 6f6f 6c73 5f66 726f 6d5f 746f 6b65  _pools_from_toke
+000004e0: 6e5f 7061 7468 0a66 726f 6d20 2e2e 756e  n_path.from ..un
+000004f0: 6973 7761 702e 7632 5f6c 6971 7569 6469  iswap.v2_liquidi
+00000500: 7479 5f70 6f6f 6c20 696d 706f 7274 204c  ty_pool import L
+00000510: 6971 7569 6469 7479 506f 6f6c 0a66 726f  iquidityPool.fro
+00000520: 6d20 2e2e 756e 6973 7761 702e 7633 5f64  m ..uniswap.v3_d
+00000530: 6174 6163 6c61 7373 6573 2069 6d70 6f72  ataclasses impor
+00000540: 7420 556e 6973 7761 7056 3350 6f6f 6c53  t UniswapV3PoolS
+00000550: 696d 756c 6174 696f 6e52 6573 756c 742c  imulationResult,
+00000560: 2055 6e69 7377 6170 5633 506f 6f6c 5374   UniswapV3PoolSt
+00000570: 6174 650a 6672 6f6d 202e 2e75 6e69 7377  ate.from ..unisw
+00000580: 6170 2e76 335f 6675 6e63 7469 6f6e 7320  ap.v3_functions 
+00000590: 696d 706f 7274 2064 6563 6f64 655f 7633  import decode_v3
+000005a0: 5f70 6174 680a 6672 6f6d 202e 2e75 6e69  _path.from ..uni
+000005b0: 7377 6170 2e76 335f 6c69 7175 6964 6974  swap.v3_liquidit
+000005c0: 795f 706f 6f6c 2069 6d70 6f72 7420 5633  y_pool import V3
+000005d0: 4c69 7175 6964 6974 7950 6f6f 6c0a 6672  LiquidityPool.fr
+000005e0: 6f6d 202e 7369 6d75 6c61 7469 6f6e 5f6c  om .simulation_l
+000005f0: 6564 6765 7220 696d 706f 7274 2053 696d  edger import Sim
+00000600: 756c 6174 696f 6e4c 6564 6765 720a 0a23  ulationLedger..#
+00000610: 2049 6e74 6572 6e61 6c20 6469 6374 206f   Internal dict o
+00000620: 6620 6b6e 6f77 6e20 726f 7574 6572 2063  f known router c
+00000630: 6f6e 7472 6163 7473 2062 7920 6368 6169  ontracts by chai
+00000640: 6e20 4944 2e20 5072 652d 706f 7075 6c61  n ID. Pre-popula
+00000650: 7465 6420 7769 7468 0a23 206d 6169 6e6e  ted with.# mainn
+00000660: 6574 2061 6464 7265 7373 6573 2e20 4e65  et addresses. Ne
+00000670: 7720 726f 7574 6572 7320 6361 6e20 6265  w routers can be
+00000680: 2061 6464 6564 2062 7920 636c 6173 7320   added by class 
+00000690: 6d65 7468 6f64 2060 6164 645f 726f 7574  method `add_rout
+000006a0: 6572 600a 5f52 4f55 5445 5253 3a20 4469  er`._ROUTERS: Di
+000006b0: 6374 5b0a 2020 2020 696e 742c 2020 2320  ct[.    int,  # 
+000006c0: 6368 6169 6e20 4944 0a20 2020 2044 6963  chain ID.    Dic
+000006d0: 745b 4368 6563 6b73 756d 4164 6472 6573  t[ChecksumAddres
+000006e0: 732c 2044 6963 745b 7374 722c 2041 6e79  s, Dict[str, Any
+000006f0: 5d5d 2c0a 5d0a 5f52 4f55 5445 5253 203d  ]],.]._ROUTERS =
+00000700: 207b 0a20 2020 2043 6861 696e 4964 2e45   {.    ChainId.E
+00000710: 5448 3a20 7b0a 2020 2020 2020 2020 746f  TH: {.        to
+00000720: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
+00000730: 7328 2230 7864 3965 3163 4531 3766 3236  s("0xd9e1cE17f26
+00000740: 3431 6632 3461 4538 3336 3337 6162 3636  41f24aE83637ab66
+00000750: 6132 6363 6139 4333 3738 4239 4622 293a  a2cca9C378B9F"):
+00000760: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00000770: 6e61 6d65 223a 2022 5375 7368 6973 7761  name": "Sushiswa
+00000780: 703a 2052 6f75 7465 7222 2c0a 2020 2020  p: Router",.    
+00000790: 2020 2020 2020 2020 2266 6163 746f 7279          "factory
+000007a0: 5f61 6464 7265 7373 223a 207b 0a20 2020  _address": {.   
+000007b0: 2020 2020 2020 2020 2020 2020 2032 3a20               2: 
+000007c0: 746f 5f63 6865 636b 7375 6d5f 6164 6472  to_checksum_addr
+000007d0: 6573 7328 2230 7843 3041 4565 3437 3865  ess("0xC0AEe478e
+000007e0: 3336 3538 6532 3631 3063 3546 3741 3441  3658e2610c5F7A4A
+000007f0: 3245 3137 3737 6345 3965 3466 3241 6322  2E1777cE9e4f2Ac"
+00000800: 290a 2020 2020 2020 2020 2020 2020 7d2c  ).            },
+00000810: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00000820: 2020 2020 746f 5f63 6865 636b 7375 6d5f      to_checksum_
+00000830: 6164 6472 6573 7328 2230 7866 3136 3466  address("0xf164f
+00000840: 4330 4563 3445 3933 3039 3562 3830 3461  C0Ec4E93095b804a
+00000850: 3437 3935 6242 6531 6530 3431 3439 3762  4795bBe1e041497b
+00000860: 3932 6122 293a 207b 0a20 2020 2020 2020  92a"): {.       
+00000870: 2020 2020 2022 6e61 6d65 223a 2022 556e       "name": "Un
+00000880: 6973 7761 7056 323a 2052 6f75 7465 7222  iswapV2: Router"
+00000890: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
+000008a0: 6163 746f 7279 5f61 6464 7265 7373 223a  actory_address":
+000008b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000008c0: 2020 2032 3a20 746f 5f63 6865 636b 7375     2: to_checksu
+000008d0: 6d5f 6164 6472 6573 7328 2230 7835 4336  m_address("0x5C6
+000008e0: 3962 4565 3730 3165 6638 3134 6132 4236  9bEe701ef814a2B6
+000008f0: 6133 4544 4434 4231 3635 3243 4239 6363  a3EDD4B1652CB9cc
+00000900: 3561 4136 6622 290a 2020 2020 2020 2020  5aA6f").        
+00000910: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
+00000920: 2c0a 2020 2020 2020 2020 746f 5f63 6865  ,.        to_che
+00000930: 636b 7375 6d5f 6164 6472 6573 7328 2230  cksum_address("0
+00000940: 7837 6132 3530 6435 3633 3042 3463 4635  x7a250d5630B4cF5
+00000950: 3339 3733 3964 4632 4335 6441 6362 3463  39739dF2C5dAcb4c
+00000960: 3635 3946 3234 3838 4422 293a 207b 0a20  659F2488D"): {. 
+00000970: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+00000980: 223a 2022 556e 6973 7761 7056 323a 2052  ": "UniswapV2: R
+00000990: 6f75 7465 7220 3222 2c0a 2020 2020 2020  outer 2",.      
+000009a0: 2020 2020 2020 2266 6163 746f 7279 5f61        "factory_a
+000009b0: 6464 7265 7373 223a 207b 0a20 2020 2020  ddress": {.     
+000009c0: 2020 2020 2020 2020 2020 2032 3a20 746f             2: to
+000009d0: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
+000009e0: 7328 2230 7835 4336 3962 4565 3730 3165  s("0x5C69bEe701e
+000009f0: 6638 3134 6132 4236 6133 4544 4434 4231  f814a2B6a3EDD4B1
+00000a00: 3635 3243 4239 6363 3561 4136 6622 290a  652CB9cc5aA6f").
+00000a10: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00000a20: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00000a30: 2020 746f 5f63 6865 636b 7375 6d5f 6164    to_checksum_ad
+00000a40: 6472 6573 7328 2230 7845 3539 3234 3237  dress("0xE592427
+00000a50: 4130 4145 6365 3932 4465 3345 6465 6531  A0AEce92De3Edee1
+00000a60: 4631 3845 3031 3537 4330 3538 3631 3536  F18E0157C0586156
+00000a70: 3422 293a 207b 0a20 2020 2020 2020 2020  4"): {.         
+00000a80: 2020 2022 6e61 6d65 223a 2022 556e 6973     "name": "Unis
+00000a90: 7761 7056 333a 2052 6f75 7465 7222 2c0a  wapV3: Router",.
+00000aa0: 2020 2020 2020 2020 2020 2020 2266 6163              "fac
+00000ab0: 746f 7279 5f61 6464 7265 7373 223a 207b  tory_address": {
+00000ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000ad0: 2033 3a20 746f 5f63 6865 636b 7375 6d5f   3: to_checksum_
+00000ae0: 6164 6472 6573 7328 2230 7831 4639 3834  address("0x1F984
+00000af0: 3331 6338 6144 3938 3532 3336 3331 4145  31c8aD98523631AE
+00000b00: 3461 3539 6632 3637 3334 3665 6133 3146  4a59f267346ea31F
+00000b10: 3938 3422 290a 2020 2020 2020 2020 2020  984").          
+00000b20: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
+00000b30: 2020 2020 2020 2020 746f 5f63 6865 636b          to_check
+00000b40: 7375 6d5f 6164 6472 6573 7328 2230 7836  sum_address("0x6
+00000b50: 3862 3334 3635 3833 3366 6237 3241 3730  8b3465833fb72A70
+00000b60: 6563 4446 3438 3545 3065 3443 3762 4438  ecDF485E0e4C7bD8
+00000b70: 3636 3546 6334 3522 293a 207b 0a20 2020  665Fc45"): {.   
+00000b80: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+00000b90: 2022 556e 6973 7761 7056 333a 2052 6f75   "UniswapV3: Rou
+00000ba0: 7465 7220 3222 2c0a 2020 2020 2020 2020  ter 2",.        
+00000bb0: 2020 2020 2266 6163 746f 7279 5f61 6464      "factory_add
+00000bc0: 7265 7373 223a 207b 0a20 2020 2020 2020  ress": {.       
+00000bd0: 2020 2020 2020 2020 2032 3a20 746f 5f63           2: to_c
+00000be0: 6865 636b 7375 6d5f 6164 6472 6573 7328  hecksum_address(
+00000bf0: 2230 7835 4336 3962 4565 3730 3165 6638  "0x5C69bEe701ef8
+00000c00: 3134 6132 4236 6133 4544 4434 4231 3635  14a2B6a3EDD4B165
+00000c10: 3243 4239 6363 3561 4136 6622 292c 0a20  2CB9cc5aA6f"),. 
+00000c20: 2020 2020 2020 2020 2020 2020 2020 2033                 3
+00000c30: 3a20 746f 5f63 6865 636b 7375 6d5f 6164  : to_checksum_ad
+00000c40: 6472 6573 7328 2230 7831 4639 3834 3331  dress("0x1F98431
+00000c50: 6338 6144 3938 3532 3336 3331 4145 3461  c8aD98523631AE4a
+00000c60: 3539 6632 3637 3334 3665 6133 3146 3938  59f267346ea31F98
+00000c70: 3422 292c 0a20 2020 2020 2020 2020 2020  4"),.           
+00000c80: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
+00000c90: 2020 2020 2020 2074 6f5f 6368 6563 6b73         to_checks
+00000ca0: 756d 5f61 6464 7265 7373 2822 3078 4566  um_address("0xEf
+00000cb0: 3163 3645 3637 3730 3363 3742 4437 3130  1c6E67703c7BD710
+00000cc0: 3765 6564 3833 3033 4662 6536 4543 3235  7eed8303Fbe6EC25
+00000cd0: 3534 4246 3642 2229 3a20 7b0a 2020 2020  54BF6B"): {.    
+00000ce0: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+00000cf0: 2255 6e69 7377 6170 2055 6e69 7665 7273  "Uniswap Univers
+00000d00: 616c 2052 6f75 7465 7222 2c0a 2020 2020  al Router",.    
+00000d10: 2020 2020 2020 2020 2266 6163 746f 7279          "factory
+00000d20: 5f61 6464 7265 7373 223a 207b 0a20 2020  _address": {.   
+00000d30: 2020 2020 2020 2020 2020 2020 2032 3a20               2: 
+00000d40: 746f 5f63 6865 636b 7375 6d5f 6164 6472  to_checksum_addr
+00000d50: 6573 7328 2230 7835 4336 3962 4565 3730  ess("0x5C69bEe70
+00000d60: 3165 6638 3134 6132 4236 6133 4544 4434  1ef814a2B6a3EDD4
+00000d70: 4231 3635 3243 4239 6363 3561 4136 6622  B1652CB9cc5aA6f"
+00000d80: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00000d90: 2020 2033 3a20 746f 5f63 6865 636b 7375     3: to_checksu
+00000da0: 6d5f 6164 6472 6573 7328 2230 7831 4639  m_address("0x1F9
+00000db0: 3834 3331 6338 6144 3938 3532 3336 3331  8431c8aD98523631
+00000dc0: 4145 3461 3539 6632 3637 3334 3665 6133  AE4a59f267346ea3
+00000dd0: 3146 3938 3422 292c 0a20 2020 2020 2020  1F984"),.       
+00000de0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00000df0: 7d2c 0a20 2020 2020 2020 2074 6f5f 6368  },.        to_ch
+00000e00: 6563 6b73 756d 5f61 6464 7265 7373 2822  ecksum_address("
+00000e10: 3078 3366 4339 3141 3361 6664 3730 3339  0x3fC91A3afd7039
+00000e20: 3543 6434 3936 4336 3437 6435 6136 4343  5Cd496C647d5a6CC
+00000e30: 3944 3442 3262 3746 4144 2229 3a20 7b0a  9D4B2b7FAD"): {.
+00000e40: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
+00000e50: 6522 3a20 2255 6e69 7665 7273 616c 2055  e": "Universal U
+00000e60: 6e69 7665 7273 616c 2052 6f75 7465 7220  niversal Router 
+00000e70: 2856 315f 3229 222c 0a20 2020 2020 2020  (V1_2)",.       
+00000e80: 2020 2020 2022 6661 6374 6f72 795f 6164       "factory_ad
+00000e90: 6472 6573 7322 3a20 7b0a 2020 2020 2020  dress": {.      
+00000ea0: 2020 2020 2020 2020 2020 323a 2074 6f5f            2: to_
+00000eb0: 6368 6563 6b73 756d 5f61 6464 7265 7373  checksum_address
+00000ec0: 2822 3078 3543 3639 6245 6537 3031 6566  ("0x5C69bEe701ef
+00000ed0: 3831 3461 3242 3661 3345 4444 3442 3136  814a2B6a3EDD4B16
+00000ee0: 3532 4342 3963 6335 6141 3666 2229 2c0a  52CB9cc5aA6f"),.
+00000ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f00: 333a 2074 6f5f 6368 6563 6b73 756d 5f61  3: to_checksum_a
+00000f10: 6464 7265 7373 2822 3078 3146 3938 3433  ddress("0x1F9843
+00000f20: 3163 3861 4439 3835 3233 3633 3141 4534  1c8aD98523631AE4
+00000f30: 6135 3966 3236 3733 3436 6561 3331 4639  a59f267346ea31F9
+00000f40: 3834 2229 2c0a 2020 2020 2020 2020 2020  84"),.          
+00000f50: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
+00000f60: 2020 2020 2020 2020 746f 5f63 6865 636b          to_check
+00000f70: 7375 6d5f 6164 6472 6573 7328 2230 7833  sum_address("0x3
+00000f80: 4636 3332 3836 3639 6138 3662 6566 3433  F6328669a86bef43
+00000f90: 3144 6336 4639 3230 3141 3542 3930 4637  1Dc6F9201A5B90F7
+00000fa0: 3937 3561 3032 3322 293a 207b 0a20 2020  975a023"): {.   
+00000fb0: 2020 2020 2020 2020 2022 6e61 6d65 223a           "name":
+00000fc0: 2022 556e 6976 6572 7361 6c20 556e 6976   "Universal Univ
+00000fd0: 6572 7361 6c20 526f 7574 6572 2028 5631  ersal Router (V1
+00000fe0: 5f33 2922 2c0a 2020 2020 2020 2020 2020  _3)",.          
+00000ff0: 2020 2266 6163 746f 7279 5f61 6464 7265    "factory_addre
+00001000: 7373 223a 207b 0a20 2020 2020 2020 2020  ss": {.         
+00001010: 2020 2020 2020 2032 3a20 746f 5f63 6865         2: to_che
+00001020: 636b 7375 6d5f 6164 6472 6573 7328 2230  cksum_address("0
+00001030: 7835 4336 3962 4565 3730 3165 6638 3134  x5C69bEe701ef814
+00001040: 6132 4236 6133 4544 4434 4231 3635 3243  a2B6a3EDD4B1652C
+00001050: 4239 6363 3561 4136 6622 292c 0a20 2020  B9cc5aA6f"),.   
+00001060: 2020 2020 2020 2020 2020 2020 2033 3a20               3: 
+00001070: 746f 5f63 6865 636b 7375 6d5f 6164 6472  to_checksum_addr
+00001080: 6573 7328 2230 7831 4639 3834 3331 6338  ess("0x1F98431c8
+00001090: 6144 3938 3532 3336 3331 4145 3461 3539  aD98523631AE4a59
+000010a0: 6632 3637 3334 3665 6133 3146 3938 3422  f267346ea31F984"
+000010b0: 292c 0a20 2020 2020 2020 2020 2020 207d  ),.            }
+000010c0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+000010d0: 207d 0a7d 0a0a 0a63 6c61 7373 2055 6e69   }.}...class Uni
+000010e0: 7665 7273 616c 526f 7574 6572 5370 6563  versalRouterSpec
+000010f0: 6961 6c41 6464 7265 7373 3a0a 2020 2020  ialAddress:.    
+00001100: 2320 7265 663a 2068 7474 7073 3a2f 2f67  # ref: https://g
+00001110: 6974 6875 622e 636f 6d2f 556e 6973 7761  ithub.com/Uniswa
+00001120: 702f 756e 6976 6572 7361 6c2d 726f 7574  p/universal-rout
+00001130: 6572 2f62 6c6f 622f 6465 706c 6f79 6564  er/blob/deployed
+00001140: 2d63 6f6d 6d69 742f 636f 6e74 7261 6374  -commit/contract
+00001150: 732f 6c69 6272 6172 6965 732f 436f 6e73  s/libraries/Cons
+00001160: 7461 6e74 732e 736f 6c0a 2020 2020 4554  tants.sol.    ET
+00001170: 4820 3d20 746f 5f63 6865 636b 7375 6d5f  H = to_checksum_
+00001180: 6164 6472 6573 7328 2230 7830 3030 3030  address("0x00000
 00001190: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-000011a0: 3030 3030 3030 3030 3030 3030 3031 2229  00000000000001")
-000011b0: 0a20 2020 2052 4f55 5445 5220 3d20 746f  .    ROUTER = to
-000011c0: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
-000011d0: 7328 2230 7830 3030 3030 3030 3030 3030  s("0x00000000000
+000011a0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+000011b0: 3030 3022 290a 2020 2020 4d53 475f 5345  000").    MSG_SE
+000011c0: 4e44 4552 203d 2074 6f5f 6368 6563 6b73  NDER = to_checks
+000011d0: 756d 5f61 6464 7265 7373 2822 3078 3030  um_address("0x00
 000011e0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-000011f0: 3030 3030 3030 3030 3030 3030 3222 290a  0000000000002").
-00001200: 0a0a 636c 6173 7320 556e 6976 6572 7361  ..class Universa
-00001210: 6c52 6f75 7465 7253 7065 6369 616c 5661  lRouterSpecialVa
-00001220: 6c75 6573 3a0a 2020 2020 2320 7265 663a  lues:.    # ref:
-00001230: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
-00001240: 636f 6d2f 556e 6973 7761 702f 756e 6976  com/Uniswap/univ
-00001250: 6572 7361 6c2d 726f 7574 6572 2f62 6c6f  ersal-router/blo
-00001260: 622f 6465 706c 6f79 6564 2d63 6f6d 6d69  b/deployed-commi
-00001270: 742f 636f 6e74 7261 6374 732f 6c69 6272  t/contracts/libr
-00001280: 6172 6965 732f 436f 6e73 7461 6e74 732e  aries/Constants.
-00001290: 736f 6c0a 2020 2020 5632 5f50 4149 525f  sol.    V2_PAIR_
-000012a0: 414c 5245 4144 595f 5041 4944 203d 2030  ALREADY_PAID = 0
-000012b0: 0a20 2020 2055 5345 5f43 4f4e 5452 4143  .    USE_CONTRAC
-000012c0: 545f 4241 4c41 4e43 4520 3d20 3120 3c3c  T_BALANCE = 1 <<
-000012d0: 2032 3535 0a0a 0a63 6c61 7373 2056 3352   255...class V3R
-000012e0: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
-000012f0: 6573 733a 0a20 2020 2023 2053 7761 7052  ess:.    # SwapR
-00001300: 6f75 7465 722e 736f 6c20 6368 6563 6b73  outer.sol checks
-00001310: 2066 6f72 2061 6464 7265 7373 2830 290a   for address(0).
-00001320: 2020 2020 2320 7265 663a 2068 7474 7073      # ref: https
-00001330: 3a2f 2f67 6974 6875 622e 636f 6d2f 556e  ://github.com/Un
-00001340: 6973 7761 702f 7633 2d70 6572 6970 6865  iswap/v3-periphe
-00001350: 7279 2f62 6c6f 622f 6d61 696e 2f63 6f6e  ry/blob/main/con
-00001360: 7472 6163 7473 2f53 7761 7052 6f75 7465  tracts/SwapRoute
-00001370: 722e 736f 6c0a 2020 2020 524f 5554 4552  r.sol.    ROUTER
-00001380: 5f31 203d 2074 6f5f 6368 6563 6b73 756d  _1 = to_checksum
-00001390: 5f61 6464 7265 7373 2822 3078 3030 3030  _address("0x0000
-000013a0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-000013b0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-000013c0: 3030 3030 2229 0a0a 2020 2020 2320 7265  0000")..    # re
-000013d0: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
-000013e0: 622e 636f 6d2f 556e 6973 7761 702f 7377  b.com/Uniswap/sw
-000013f0: 6170 2d72 6f75 7465 722d 636f 6e74 7261  ap-router-contra
-00001400: 6374 732f 626c 6f62 2f6d 6169 6e2f 636f  cts/blob/main/co
-00001410: 6e74 7261 6374 732f 6c69 6272 6172 6965  ntracts/librarie
-00001420: 732f 436f 6e73 7461 6e74 732e 736f 6c0a  s/Constants.sol.
-00001430: 2020 2020 4d53 475f 5345 4e44 4552 203d      MSG_SENDER =
-00001440: 2074 6f5f 6368 6563 6b73 756d 5f61 6464   to_checksum_add
-00001450: 7265 7373 2822 3078 3030 3030 3030 3030  ress("0x00000000
-00001460: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-00001470: 3030 3030 3030 3030 3030 3030 3030 3031  0000000000000001
-00001480: 2229 0a20 2020 2052 4f55 5445 525f 3220  ").    ROUTER_2 
-00001490: 3d20 746f 5f63 6865 636b 7375 6d5f 6164  = to_checksum_ad
-000014a0: 6472 6573 7328 2230 7830 3030 3030 3030  dress("0x0000000
+000011f0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+00001200: 3030 3030 3031 2229 0a20 2020 2052 4f55  000001").    ROU
+00001210: 5445 5220 3d20 746f 5f63 6865 636b 7375  TER = to_checksu
+00001220: 6d5f 6164 6472 6573 7328 2230 7830 3030  m_address("0x000
+00001230: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+00001240: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+00001250: 3030 3030 3222 290a 0a0a 636c 6173 7320  00002")...class 
+00001260: 556e 6976 6572 7361 6c52 6f75 7465 7253  UniversalRouterS
+00001270: 7065 6369 616c 5661 6c75 6573 3a0a 2020  pecialValues:.  
+00001280: 2020 2320 7265 663a 2068 7474 7073 3a2f    # ref: https:/
+00001290: 2f67 6974 6875 622e 636f 6d2f 556e 6973  /github.com/Unis
+000012a0: 7761 702f 756e 6976 6572 7361 6c2d 726f  wap/universal-ro
+000012b0: 7574 6572 2f62 6c6f 622f 6465 706c 6f79  uter/blob/deploy
+000012c0: 6564 2d63 6f6d 6d69 742f 636f 6e74 7261  ed-commit/contra
+000012d0: 6374 732f 6c69 6272 6172 6965 732f 436f  cts/libraries/Co
+000012e0: 6e73 7461 6e74 732e 736f 6c0a 2020 2020  nstants.sol.    
+000012f0: 5632 5f50 4149 525f 414c 5245 4144 595f  V2_PAIR_ALREADY_
+00001300: 5041 4944 203d 2030 0a20 2020 2055 5345  PAID = 0.    USE
+00001310: 5f43 4f4e 5452 4143 545f 4241 4c41 4e43  _CONTRACT_BALANC
+00001320: 4520 3d20 3120 3c3c 2032 3535 0a0a 0a63  E = 1 << 255...c
+00001330: 6c61 7373 2056 3352 6f75 7465 7253 7065  lass V3RouterSpe
+00001340: 6369 616c 4164 6472 6573 733a 0a20 2020  cialAddress:.   
+00001350: 2023 2053 7761 7052 6f75 7465 722e 736f   # SwapRouter.so
+00001360: 6c20 6368 6563 6b73 2066 6f72 2061 6464  l checks for add
+00001370: 7265 7373 2830 290a 2020 2020 2320 7265  ress(0).    # re
+00001380: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
+00001390: 622e 636f 6d2f 556e 6973 7761 702f 7633  b.com/Uniswap/v3
+000013a0: 2d70 6572 6970 6865 7279 2f62 6c6f 622f  -periphery/blob/
+000013b0: 6d61 696e 2f63 6f6e 7472 6163 7473 2f53  main/contracts/S
+000013c0: 7761 7052 6f75 7465 722e 736f 6c0a 2020  wapRouter.sol.  
+000013d0: 2020 524f 5554 4552 5f31 203d 2074 6f5f    ROUTER_1 = to_
+000013e0: 6368 6563 6b73 756d 5f61 6464 7265 7373  checksum_address
+000013f0: 2822 3078 3030 3030 3030 3030 3030 3030  ("0x000000000000
+00001400: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+00001410: 3030 3030 3030 3030 3030 3030 2229 0a0a  000000000000")..
+00001420: 2020 2020 2320 7265 663a 2068 7474 7073      # ref: https
+00001430: 3a2f 2f67 6974 6875 622e 636f 6d2f 556e  ://github.com/Un
+00001440: 6973 7761 702f 7377 6170 2d72 6f75 7465  iswap/swap-route
+00001450: 722d 636f 6e74 7261 6374 732f 626c 6f62  r-contracts/blob
+00001460: 2f6d 6169 6e2f 636f 6e74 7261 6374 732f  /main/contracts/
+00001470: 6c69 6272 6172 6965 732f 436f 6e73 7461  libraries/Consta
+00001480: 6e74 732e 736f 6c0a 2020 2020 4d53 475f  nts.sol.    MSG_
+00001490: 5345 4e44 4552 203d 2074 6f5f 6368 6563  SENDER = to_chec
+000014a0: 6b73 756d 5f61 6464 7265 7373 2822 3078  ksum_address("0x
 000014b0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
 000014c0: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
-000014d0: 3222 290a 0a0a 636c 6173 7320 5633 526f  2")...class V3Ro
-000014e0: 7574 6572 5370 6563 6961 6c56 616c 7565  uterSpecialValue
-000014f0: 733a 0a20 2020 2023 2072 6566 3a20 6874  s:.    # ref: ht
-00001500: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-00001510: 2f55 6e69 7377 6170 2f73 7761 702d 726f  /Uniswap/swap-ro
-00001520: 7574 6572 2d63 6f6e 7472 6163 7473 2f62  uter-contracts/b
-00001530: 6c6f 622f 6d61 696e 2f63 6f6e 7472 6163  lob/main/contrac
-00001540: 7473 2f6c 6962 7261 7269 6573 2f43 6f6e  ts/libraries/Con
-00001550: 7374 616e 7473 2e73 6f6c 0a20 2020 2055  stants.sol.    U
-00001560: 5345 5f43 4f4e 5452 4143 545f 4241 4c41  SE_CONTRACT_BALA
-00001570: 4e43 4520 3d20 300a 0a0a 636c 6173 7320  NCE = 0...class 
-00001580: 556e 6973 7761 7054 7261 6e73 6163 7469  UniswapTransacti
-00001590: 6f6e 2842 6173 6554 7261 6e73 6163 7469  on(BaseTransacti
-000015a0: 6f6e 293a 0a20 2020 2040 636c 6173 736d  on):.    @classm
-000015b0: 6574 686f 640a 2020 2020 6465 6620 6164  ethod.    def ad
-000015c0: 645f 6368 6169 6e28 636c 732c 2063 6861  d_chain(cls, cha
-000015d0: 696e 5f69 643a 2069 6e74 2920 2d3e 204e  in_id: int) -> N
-000015e0: 6f6e 653a 0a20 2020 2020 2020 2074 7279  one:.        try
-000015f0: 3a0a 2020 2020 2020 2020 2020 2020 5f52  :.            _R
-00001600: 4f55 5445 5253 5b63 6861 696e 5f69 645d  OUTERS[chain_id]
-00001610: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00001620: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00001630: 2020 2020 2020 205f 524f 5554 4552 535b         _ROUTERS[
-00001640: 6368 6169 6e5f 6964 5d20 3d20 7b7d 0a0a  chain_id] = {}..
-00001650: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
-00001660: 0a20 2020 2064 6566 2061 6464 5f72 6f75  .    def add_rou
-00001670: 7465 7228 636c 732c 2063 6861 696e 5f69  ter(cls, chain_i
-00001680: 643a 2069 6e74 2c20 726f 7574 6572 5f61  d: int, router_a
-00001690: 6464 7265 7373 3a20 7374 722c 2072 6f75  ddress: str, rou
-000016a0: 7465 725f 6469 6374 3a20 4469 6374 5b41  ter_dict: Dict[A
-000016b0: 6e79 2c20 416e 795d 2920 2d3e 204e 6f6e  ny, Any]) -> Non
-000016c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-000016d0: 2020 2020 2020 2041 6464 2061 206e 6577         Add a new
-000016e0: 2072 6f75 7465 7220 6164 6472 6573 7320   router address 
-000016f0: 666f 7220 6120 6769 7665 6e20 6368 6169  for a given chai
-00001700: 6e20 4944 2e0a 0a20 2020 2020 2020 2054  n ID...        T
-00001710: 6865 2060 726f 7574 6572 5f64 6963 7460  he `router_dict`
-00001720: 2061 7267 756d 656e 7420 7368 6f75 6c64   argument should
-00001730: 2063 6f6e 7461 696e 2061 7420 6d69 6e69   contain at mini
-00001740: 6d75 6d20 7468 6520 666f 6c6c 6f77 696e  mum the followin
-00001750: 6720 6b65 792d 7661 6c75 6520 7061 6972  g key-value pair
-00001760: 733a 0a20 2020 2020 2020 2020 2020 202d  s:.            -
-00001770: 2027 6e61 6d65 273a 205b 7374 725d 0a20   'name': [str]. 
-00001780: 2020 2020 2020 2020 2020 202d 2027 6661             - 'fa
-00001790: 6374 6f72 795f 6164 6472 6573 7327 3a20  ctory_address': 
-000017a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000017b0: 2020 5b69 6e74 5d3a 205b 6164 6472 6573    [int]: [addres
-000017c0: 735d 2c0a 2020 2020 2020 2020 2020 2020  s],.            
-000017d0: 2020 2020 5b69 6e74 5d3a 205b 6164 6472      [int]: [addr
-000017e0: 6573 735d 2c0a 2020 2020 2020 2020 2020  ess],.          
-000017f0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00001800: 2054 6865 2064 6963 7473 2069 6e73 6964   The dicts insid
-00001810: 6520 2766 6163 746f 7279 5f61 6464 7265  e 'factory_addre
-00001820: 7373 2720 6172 6520 6b65 7965 6420 6279  ss' are keyed by
-00001830: 2074 6865 2055 6e69 7377 6170 2076 6572   the Uniswap ver
-00001840: 7369 6f6e 2061 7373 6f63 6961 7465 6420  sion associated 
-00001850: 7769 7468 2074 6865 6972 2063 6f6e 7472  with their contr
-00001860: 6163 7473 2c20 652e 672e 0a20 2020 2020  acts, e.g..     
-00001870: 2020 2020 2020 2072 6f75 7465 725f 6469         router_di
-00001880: 6374 203d 207b 0a20 2020 2020 2020 2020  ct = {.         
-00001890: 2020 2020 2020 2027 6e61 6d65 273a 2027         'name': '
-000018a0: 536f 6d65 4445 5827 2c0a 2020 2020 2020  SomeDEX',.      
-000018b0: 2020 2020 2020 2020 2020 2766 6163 746f            'facto
-000018c0: 7279 5f61 6464 7265 7373 273a 207b 0a20  ry_address': {. 
-000018d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000018e0: 2020 2032 3a20 2730 782e 2e2e 272c 0a20     2: '0x...',. 
-000018f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001900: 2020 2033 3a20 2730 782e 2e2e 272c 0a20     3: '0x...',. 
-00001910: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00001920: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00001930: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00001940: 2020 2072 6f75 7465 725f 6164 6472 6573     router_addres
-00001950: 7320 3d20 746f 5f63 6865 636b 7375 6d5f  s = to_checksum_
-00001960: 6164 6472 6573 7328 726f 7574 6572 5f61  address(router_a
-00001970: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-00001980: 2066 6f72 206b 6579 2069 6e20 5b0a 2020   for key in [.  
-00001990: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
-000019a0: 2c0a 2020 2020 2020 2020 2020 2020 2266  ,.            "f
-000019b0: 6163 746f 7279 5f61 6464 7265 7373 222c  actory_address",
-000019c0: 0a20 2020 2020 2020 205d 3a0a 2020 2020  .        ]:.    
-000019d0: 2020 2020 2020 2020 6966 206b 6579 206e          if key n
-000019e0: 6f74 2069 6e20 726f 7574 6572 5f64 6963  ot in router_dic
-000019f0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00001a00: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00001a10: 726f 7228 6622 7b6b 6579 7d20 6e6f 7420  ror(f"{key} not 
-00001a20: 666f 756e 6420 696e 2072 6f75 7465 725f  found in router_
-00001a30: 6469 6374 2229 0a0a 2020 2020 2020 2020  dict")..        
-00001a40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00001a50: 205f 524f 5554 4552 535b 6368 6169 6e5f   _ROUTERS[chain_
-00001a60: 6964 5d5b 726f 7574 6572 5f61 6464 7265  id][router_addre
-00001a70: 7373 5d0a 2020 2020 2020 2020 6578 6365  ss].        exce
-00001a80: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-00001a90: 2020 2020 2020 2020 2020 5f52 4f55 5445            _ROUTE
-00001aa0: 5253 5b63 6861 696e 5f69 645d 5b72 6f75  RS[chain_id][rou
-00001ab0: 7465 725f 6164 6472 6573 735d 203d 2072  ter_address] = r
-00001ac0: 6f75 7465 725f 6469 6374 0a0a 2020 2020  outer_dict..    
-00001ad0: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-00001ae0: 2064 6566 2061 6464 5f77 7261 7070 6564   def add_wrapped
-00001af0: 5f74 6f6b 656e 2863 6c73 2c20 6368 6169  _token(cls, chai
-00001b00: 6e5f 6964 3a20 696e 742c 2074 6f6b 656e  n_id: int, token
-00001b10: 5f61 6464 7265 7373 3a20 7374 7229 202d  _address: str) -
-00001b20: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00001b30: 2222 220a 2020 2020 2020 2020 4164 6420  """.        Add 
-00001b40: 6120 7772 6170 7065 6420 746f 6b65 6e20  a wrapped token 
-00001b50: 6164 6472 6573 7320 666f 7220 6120 6769  address for a gi
-00001b60: 7665 6e20 6368 6169 6e20 4944 2e0a 0a20  ven chain ID... 
-00001b70: 2020 2020 2020 2054 6865 206d 6574 686f         The metho
-00001b80: 6420 6368 6563 6b73 756d 7320 7468 6520  d checksums the 
-00001b90: 746f 6b65 6e20 6164 6472 6573 732e 0a20  token address.. 
-00001ba0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00001bb0: 2020 2020 5f74 6f6b 656e 5f61 6464 7265      _token_addre
-00001bc0: 7373 203d 2074 6f5f 6368 6563 6b73 756d  ss = to_checksum
-00001bd0: 5f61 6464 7265 7373 2874 6f6b 656e 5f61  _address(token_a
-00001be0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-00001bf0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00001c00: 2020 5752 4150 5045 445f 4e41 5449 5645    WRAPPED_NATIVE
-00001c10: 5f54 4f4b 454e 535b 6368 6169 6e5f 6964  _TOKENS[chain_id
-00001c20: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
-00001c30: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
-00001c40: 2020 2020 2020 2057 5241 5050 4544 5f4e         WRAPPED_N
-00001c50: 4154 4956 455f 544f 4b45 4e53 5b63 6861  ATIVE_TOKENS[cha
-00001c60: 696e 5f69 645d 203d 205f 746f 6b65 6e5f  in_id] = _token_
-00001c70: 6164 6472 6573 730a 0a20 2020 2064 6566  address..    def
-00001c80: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
-00001c90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00001ca0: 2063 6861 696e 5f69 643a 2069 6e74 207c   chain_id: int |
-00001cb0: 2073 7472 2c0a 2020 2020 2020 2020 7478   str,.        tx
-00001cc0: 5f68 6173 683a 2048 6578 4279 7465 7320  _hash: HexBytes 
-00001cd0: 7c20 6279 7465 7320 7c20 7374 722c 0a20  | bytes | str,. 
-00001ce0: 2020 2020 2020 2074 785f 6e6f 6e63 653a         tx_nonce:
-00001cf0: 2069 6e74 207c 2073 7472 2c0a 2020 2020   int | str,.    
-00001d00: 2020 2020 7478 5f76 616c 7565 3a20 696e      tx_value: in
-00001d10: 7420 7c20 7374 722c 0a20 2020 2020 2020  t | str,.       
-00001d20: 2074 785f 7365 6e64 6572 3a20 7374 722c   tx_sender: str,
-00001d30: 0a20 2020 2020 2020 2066 756e 635f 6e61  .        func_na
-00001d40: 6d65 3a20 7374 722c 0a20 2020 2020 2020  me: str,.       
-00001d50: 2066 756e 635f 7061 7261 6d73 3a20 4469   func_params: Di
-00001d60: 6374 5b73 7472 2c20 416e 795d 2c0a 2020  ct[str, Any],.  
-00001d70: 2020 2020 2020 726f 7574 6572 5f61 6464        router_add
-00001d80: 7265 7373 3a20 7374 722c 0a20 2020 2029  ress: str,.    )
-00001d90: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00001da0: 2020 2020 2020 4275 696c 6420 6120 7374        Build a st
-00001db0: 616e 6461 6c6f 6e65 2072 6570 7265 7365  andalone represe
-00001dc0: 6e74 6174 696f 6e20 6f66 2061 2074 7261  ntation of a tra
-00001dd0: 6e73 6163 7469 6f6e 2073 7562 6d69 7474  nsaction submitt
-00001de0: 6564 2074 6f20 6120 6b6e 6f77 6e20 556e  ed to a known Un
-00001df0: 6973 7761 702d 6261 7365 6420 726f 7574  iswap-based rout
-00001e00: 6572 2063 6f6e 7472 6163 7420 6164 6472  er contract addr
-00001e10: 6573 732e 0a0a 2020 2020 2020 2020 5375  ess...        Su
-00001e20: 7070 6f72 7465 6420 6164 6472 6573 7365  pported addresse
-00001e30: 733a 0a20 2020 2020 2020 2020 2020 202d  s:.            -
-00001e40: 2030 7864 3965 3163 4531 3766 3236 3431   0xd9e1cE17f2641
-00001e50: 6632 3461 4538 3336 3337 6162 3636 6132  f24aE83637ab66a2
-00001e60: 6363 6139 4333 3738 4239 4620 2853 7573  cca9C378B9F (Sus
-00001e70: 6869 7377 6170 2052 6f75 7465 7229 0a20  hiswap Router). 
-00001e80: 2020 2020 2020 2020 2020 202d 2030 7866             - 0xf
-00001e90: 3136 3466 4330 4563 3445 3933 3039 3562  164fC0Ec4E93095b
-00001ea0: 3830 3461 3437 3935 6242 6531 6530 3431  804a4795bBe1e041
-00001eb0: 3439 3762 3932 6120 2855 6e69 7377 6170  497b92a (Uniswap
-00001ec0: 2056 3220 526f 7574 6572 290a 2020 2020   V2 Router).    
-00001ed0: 2020 2020 2020 2020 2d20 3078 3761 3235          - 0x7a25
-00001ee0: 3064 3536 3330 4234 6346 3533 3937 3339  0d5630B4cF539739
-00001ef0: 6446 3243 3564 4163 6234 6336 3539 4632  dF2C5dAcb4c659F2
-00001f00: 3438 3844 2028 556e 6973 7761 7020 5632  488D (Uniswap V2
-00001f10: 2052 6f75 7465 7220 3229 0a20 2020 2020   Router 2).     
-00001f20: 2020 2020 2020 202d 2030 7845 3539 3234         - 0xE5924
-00001f30: 3237 4130 4145 6365 3932 4465 3345 6465  27A0AEce92De3Ede
-00001f40: 6531 4631 3845 3031 3537 4330 3538 3631  e1F18E0157C05861
-00001f50: 3536 3420 2855 6e69 7377 6170 2056 3320  564 (Uniswap V3 
-00001f60: 526f 7574 6572 290a 2020 2020 2020 2020  Router).        
-00001f70: 2020 2020 2d20 3078 3638 6233 3436 3538      - 0x68b34658
-00001f80: 3333 6662 3732 4137 3065 6344 4634 3835  33fb72A70ecDF485
-00001f90: 4530 6534 4337 6244 3836 3635 4663 3435  E0e4C7bD8665Fc45
-00001fa0: 2028 556e 6973 7761 7020 5633 2052 6f75   (Uniswap V3 Rou
-00001fb0: 7465 7220 3229 0a20 2020 2020 2020 2020  ter 2).         
-00001fc0: 2020 202d 2030 7845 6631 6336 4536 3737     - 0xEf1c6E677
-00001fd0: 3033 6337 4244 3731 3037 6565 6438 3330  03c7BD7107eed830
-00001fe0: 3346 6265 3645 4332 3535 3442 4636 4220  3Fbe6EC2554BF6B 
-00001ff0: 2855 6e69 7377 6170 2055 6e69 7665 7273  (Uniswap Univers
-00002000: 616c 2052 6f75 7465 7229 0a20 2020 2020  al Router).     
-00002010: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00002020: 2320 4064 6576 2054 6865 2060 7365 6c66  # @dev The `self
-00002030: 2e6c 6564 6765 7260 2069 7320 7573 6564  .ledger` is used
-00002040: 2074 6f20 7472 6163 6b20 746f 6b65 6e20   to track token 
-00002050: 6261 6c61 6e63 6573 2066 6f72 2061 6c6c  balances for all
-00002060: 0a20 2020 2020 2020 2023 2061 6464 7265  .        # addre
-00002070: 7373 6573 2069 6e76 6f6c 7665 6420 696e  sses involved in
-00002080: 2074 6865 2073 7761 702e 2041 2070 6f73   the swap. A pos
-00002090: 6974 6976 6520 6261 6c61 6e63 6520 7265  itive balance re
-000020a0: 7072 6573 656e 7473 0a20 2020 2020 2020  presents.       
-000020b0: 2023 2061 2070 7265 2d73 7761 7020 6465   # a pre-swap de
-000020c0: 706f 7369 742c 2061 206e 6567 6174 6976  posit, a negativ
-000020d0: 6520 6261 6c61 6e63 6520 7265 7072 6573  e balance repres
-000020e0: 656e 7473 2061 6e20 6f75 7473 7461 6e64  ents an outstand
-000020f0: 696e 670a 2020 2020 2020 2020 2320 7769  ing.        # wi
-00002100: 7468 6472 6177 616c 2e20 4120 6675 6c6c  thdrawal. A full
-00002110: 2074 7261 6e73 6163 7469 6f6e 2073 686f   transaction sho
-00002120: 756c 6420 656e 6420 7769 7468 2061 2070  uld end with a p
-00002130: 6f73 6974 6976 6520 6261 6c61 6e63 6520  ositive balance 
-00002140: 6f66 0a20 2020 2020 2020 2023 2074 6865  of.        # the
-00002150: 2064 6573 6972 6564 206f 7574 7075 7420   desired output 
-00002160: 746f 6b65 6e2c 2063 7265 6469 7465 6420  token, credited 
-00002170: 746f 2060 7365 6c66 2e73 656e 6465 7260  to `self.sender`
-00002180: 206f 7220 6f6e 6520 6f72 206d 6f72 650a   or one or more.
-00002190: 2020 2020 2020 2020 2320 7265 6369 7069          # recipi
-000021a0: 656e 7473 2c20 7768 6963 6820 6172 6520  ents, which are 
-000021b0: 636f 6c6c 6563 7465 6420 696e 2074 6865  collected in the
-000021c0: 2060 7365 6c66 2e74 6f60 2073 6574 2e0a   `self.to` set..
-000021d0: 0a20 2020 2020 2020 2023 2040 6465 7620  .        # @dev 
-000021e0: 536f 6d65 2072 6f75 7465 7273 2068 6176  Some routers hav
-000021f0: 6520 7370 6563 6961 6c20 666c 6167 7320  e special flags 
-00002200: 7468 6174 2073 6967 6e69 6679 2074 6865  that signify the
-00002210: 2073 7761 7020 616d 6f75 6e74 0a20 2020   swap amount.   
-00002220: 2020 2020 2023 2073 686f 756c 6420 6265       # should be
-00002230: 206c 6f6f 6b65 6420 7570 2061 7420 7468   looked up at th
-00002240: 6520 7469 6d65 206f 6620 7468 6520 7377  e time of the sw
-00002250: 6170 2c20 6173 206f 7070 6f73 6564 2074  ap, as opposed t
-00002260: 6f20 610a 2020 2020 2020 2020 2320 7370  o a.        # sp
-00002270: 6563 6966 6965 6420 616d 6f75 6e74 2061  ecified amount a
-00002280: 7420 7468 6520 7469 6d65 2074 6865 2074  t the time the t
-00002290: 7261 6e73 6163 7469 6f6e 2069 7320 6275  ransaction is bu
-000022a0: 696c 742e 2054 6865 206c 6564 6765 7220  ilt. The ledger 
-000022b0: 6973 0a20 2020 2020 2020 2023 2075 7365  is.        # use
-000022c0: 6420 746f 206c 6f6f 6b20 7570 2074 6865  d to look up the
-000022d0: 2062 616c 616e 6365 2061 7420 616e 7920   balance at any 
-000022e0: 706f 696e 7420 696e 7369 6465 2074 6865  point inside the
-000022f0: 2073 7761 702c 2061 6e64 2061 7420 7468   swap, and at th
-00002300: 650a 2020 2020 2020 2020 2320 656e 6420  e.        # end 
-00002310: 746f 2063 6f6e 6669 726d 2074 6861 7420  to confirm that 
-00002320: 616c 6c20 6261 6c61 6e63 6573 2068 6176  all balances hav
-00002330: 6520 6265 656e 2061 6363 6f75 6e74 6564  e been accounted
-00002340: 2066 6f72 2e0a 0a20 2020 2020 2020 2073   for...        s
-00002350: 656c 662e 6c65 6467 6572 203d 2053 696d  elf.ledger = Sim
-00002360: 756c 6174 696f 6e4c 6564 6765 7228 290a  ulationLedger().
-00002370: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-00002380: 6169 6e5f 6964 203d 2069 6e74 2863 6861  ain_id = int(cha
-00002390: 696e 5f69 642c 2031 3629 2069 6620 6973  in_id, 16) if is
-000023a0: 696e 7374 616e 6365 2863 6861 696e 5f69  instance(chain_i
-000023b0: 642c 2073 7472 2920 656c 7365 2063 6861  d, str) else cha
-000023c0: 696e 5f69 640a 2020 2020 2020 2020 7365  in_id.        se
-000023d0: 6c66 2e72 6f75 7465 7273 203d 205f 524f  lf.routers = _RO
-000023e0: 5554 4552 535b 7365 6c66 2e63 6861 696e  UTERS[self.chain
-000023f0: 5f69 645d 0a20 2020 2020 2020 2073 656c  _id].        sel
-00002400: 662e 7365 6e64 6572 203d 2074 6f5f 6368  f.sender = to_ch
-00002410: 6563 6b73 756d 5f61 6464 7265 7373 2874  ecksum_address(t
-00002420: 785f 7365 6e64 6572 290a 2020 2020 2020  x_sender).      
-00002430: 2020 7365 6c66 2e72 6563 6970 6965 6e74    self.recipient
-00002440: 733a 2053 6574 5b43 6865 636b 7375 6d41  s: Set[ChecksumA
-00002450: 6464 7265 7373 5d20 3d20 7365 7428 290a  ddress] = set().
-00002460: 0a20 2020 2020 2020 2072 6f75 7465 725f  .        router_
-00002470: 6164 6472 6573 7320 3d20 746f 5f63 6865  address = to_che
-00002480: 636b 7375 6d5f 6164 6472 6573 7328 726f  cksum_address(ro
-00002490: 7574 6572 5f61 6464 7265 7373 290a 2020  uter_address).  
-000024a0: 2020 2020 2020 6966 2072 6f75 7465 725f        if router_
-000024b0: 6164 6472 6573 7320 6e6f 7420 696e 2073  address not in s
-000024c0: 656c 662e 726f 7574 6572 733a 0a20 2020  elf.routers:.   
-000024d0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-000024e0: 616c 7565 4572 726f 7228 6622 526f 7574  alueError(f"Rout
-000024f0: 6572 2061 6464 7265 7373 207b 726f 7574  er address {rout
-00002500: 6572 5f61 6464 7265 7373 7d20 756e 6b6e  er_address} unkn
-00002510: 6f77 6e21 2229 0a0a 2020 2020 2020 2020  own!")..        
-00002520: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
-00002530: 6573 7320 3d20 726f 7574 6572 5f61 6464  ess = router_add
-00002540: 7265 7373 0a0a 2020 2020 2020 2020 7365  ress..        se
-00002550: 6c66 2e76 325f 706f 6f6c 5f6d 616e 6167  lf.v2_pool_manag
-00002560: 6572 3a20 556e 6973 7761 7056 324c 6971  er: UniswapV2Liq
-00002570: 7569 6469 7479 506f 6f6c 4d61 6e61 6765  uidityPoolManage
-00002580: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
-00002590: 2020 2020 2020 2020 7365 6c66 2e76 335f          self.v3_
-000025a0: 706f 6f6c 5f6d 616e 6167 6572 3a20 556e  pool_manager: Un
-000025b0: 6973 7761 7056 334c 6971 7569 6469 7479  iswapV3Liquidity
-000025c0: 506f 6f6c 4d61 6e61 6765 7220 7c20 4e6f  PoolManager | No
-000025d0: 6e65 203d 204e 6f6e 650a 0a20 2020 2020  ne = None..     
-000025e0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000025f0: 2020 2020 7365 6c66 2e76 325f 706f 6f6c      self.v2_pool
-00002600: 5f6d 616e 6167 6572 203d 2055 6e69 7377  _manager = Unisw
-00002610: 6170 5632 4c69 7175 6964 6974 7950 6f6f  apV2LiquidityPoo
-00002620: 6c4d 616e 6167 6572 280a 2020 2020 2020  lManager(.      
-00002630: 2020 2020 2020 2020 2020 6661 6374 6f72            factor
-00002640: 795f 6164 6472 6573 733d 7365 6c66 2e72  y_address=self.r
-00002650: 6f75 7465 7273 5b72 6f75 7465 725f 6164  outers[router_ad
-00002660: 6472 6573 735d 5b22 6661 6374 6f72 795f  dress]["factory_
-00002670: 6164 6472 6573 7322 5d5b 325d 0a20 2020  address"][2].   
-00002680: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00002690: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-000026a0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-000026b0: 7061 7373 0a0a 2020 2020 2020 2020 7472  pass..        tr
-000026c0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-000026d0: 656c 662e 7633 5f70 6f6f 6c5f 6d61 6e61  elf.v3_pool_mana
-000026e0: 6765 7220 3d20 556e 6973 7761 7056 334c  ger = UniswapV3L
-000026f0: 6971 7569 6469 7479 506f 6f6c 4d61 6e61  iquidityPoolMana
-00002700: 6765 7228 0a20 2020 2020 2020 2020 2020  ger(.           
-00002710: 2020 2020 2066 6163 746f 7279 5f61 6464       factory_add
-00002720: 7265 7373 3d73 656c 662e 726f 7574 6572  ress=self.router
-00002730: 735b 726f 7574 6572 5f61 6464 7265 7373  s[router_address
-00002740: 5d5b 2266 6163 746f 7279 5f61 6464 7265  ]["factory_addre
-00002750: 7373 225d 5b33 5d0a 2020 2020 2020 2020  ss"][3].        
-00002760: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
-00002770: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
-00002780: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00002790: 0a20 2020 2020 2020 2073 656c 662e 6861  .        self.ha
-000027a0: 7368 203d 2048 6578 4279 7465 7328 7478  sh = HexBytes(tx
-000027b0: 5f68 6173 6829 0a20 2020 2020 2020 2073  _hash).        s
-000027c0: 656c 662e 6e6f 6e63 6520 3d20 696e 7428  elf.nonce = int(
-000027d0: 7478 5f6e 6f6e 6365 2c20 3136 2920 6966  tx_nonce, 16) if
-000027e0: 2069 7369 6e73 7461 6e63 6528 7478 5f6e   isinstance(tx_n
-000027f0: 6f6e 6365 2c20 7374 7229 2065 6c73 6520  once, str) else 
-00002800: 7478 5f6e 6f6e 6365 0a20 2020 2020 2020  tx_nonce.       
-00002810: 2073 656c 662e 7661 6c75 6520 3d20 696e   self.value = in
-00002820: 7428 7478 5f76 616c 7565 2c20 3136 2920  t(tx_value, 16) 
-00002830: 6966 2069 7369 6e73 7461 6e63 6528 7478  if isinstance(tx
-00002840: 5f76 616c 7565 2c20 7374 7229 2065 6c73  _value, str) els
-00002850: 6520 7478 5f76 616c 7565 0a20 2020 2020  e tx_value.     
-00002860: 2020 2073 656c 662e 6675 6e63 5f6e 616d     self.func_nam
-00002870: 6520 3d20 6675 6e63 5f6e 616d 650a 2020  e = func_name.  
-00002880: 2020 2020 2020 7365 6c66 2e66 756e 635f        self.func_
-00002890: 7061 7261 6d73 203d 2066 756e 635f 7061  params = func_pa
-000028a0: 7261 6d73 0a20 2020 2020 2020 2069 6620  rams.        if 
-000028b0: 7072 6576 696f 7573 5f62 6c6f 636b 5f68  previous_block_h
-000028c0: 6173 6820 3a3d 2073 656c 662e 6675 6e63  ash := self.func
-000028d0: 5f70 6172 616d 732e 6765 7428 2270 7265  _params.get("pre
-000028e0: 7669 6f75 7342 6c6f 636b 6861 7368 2229  viousBlockhash")
-000028f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00002900: 6c66 2e66 756e 635f 7072 6576 696f 7573  lf.func_previous
-00002910: 5f62 6c6f 636b 5f68 6173 6820 3d20 7072  _block_hash = pr
-00002920: 6576 696f 7573 5f62 6c6f 636b 5f68 6173  evious_block_has
-00002930: 682e 6865 7828 290a 0a20 2020 2020 2020  h.hex()..       
-00002940: 2073 656c 662e 7369 6c65 6e74 203d 2046   self.silent = F
-00002950: 616c 7365 0a0a 2020 2020 6465 6620 5f72  alse..    def _r
-00002960: 6169 7365 5f69 665f 6578 7069 7265 6428  aise_if_expired(
-00002970: 7365 6c66 2c20 6465 6164 6c69 6e65 3a20  self, deadline: 
-00002980: 696e 7429 202d 3e20 4e6f 6e65 3a0a 2020  int) -> None:.  
-00002990: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-000029a0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-000029b0: 655f 626c 6f63 6b20 6973 206e 6f74 204e  e_block is not N
-000029c0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-000029d0: 616e 6420 636f 6e66 6967 2e67 6574 5f77  and config.get_w
-000029e0: 6562 3328 292e 6574 682e 6765 745f 626c  eb3().eth.get_bl
-000029f0: 6f63 6b28 7365 6c66 2e73 7461 7465 5f62  ock(self.state_b
-00002a00: 6c6f 636b 295b 2274 696d 6573 7461 6d70  lock)["timestamp
-00002a10: 225d 203e 2064 6561 646c 696e 650a 2020  "] > deadline.  
-00002a20: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00002a30: 2020 2020 2072 6169 7365 2054 7261 6e73       raise Trans
-00002a40: 6163 7469 6f6e 4572 726f 7228 2244 6561  actionError("Dea
-00002a50: 646c 696e 6520 6578 7069 7265 6422 290a  dline expired").
-00002a60: 0a20 2020 2064 6566 205f 7368 6f77 5f70  .    def _show_p
-00002a70: 6f6f 6c5f 7374 6174 6573 280a 2020 2020  ool_states(.    
-00002a80: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00002a90: 2020 7369 6d5f 7265 7375 6c74 3a20 556e    sim_result: Un
-00002aa0: 6973 7761 7056 3250 6f6f 6c53 696d 756c  iswapV2PoolSimul
-00002ab0: 6174 696f 6e52 6573 756c 7420 7c20 556e  ationResult | Un
-00002ac0: 6973 7761 7056 3350 6f6f 6c53 696d 756c  iswapV3PoolSimul
-00002ad0: 6174 696f 6e52 6573 756c 742c 0a20 2020  ationResult,.   
-00002ae0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00002af0: 2020 2020 6375 7272 656e 745f 7374 6174      current_stat
-00002b00: 6520 3d20 7369 6d5f 7265 7375 6c74 2e63  e = sim_result.c
-00002b10: 7572 7265 6e74 5f73 7461 7465 0a20 2020  urrent_state.   
-00002b20: 2020 2020 2066 7574 7572 655f 7374 6174       future_stat
-00002b30: 6520 3d20 7369 6d5f 7265 7375 6c74 2e66  e = sim_result.f
-00002b40: 7574 7572 655f 7374 6174 650a 2020 2020  uture_state.    
-00002b50: 2020 2020 706f 6f6c 203d 2063 7572 7265      pool = curre
-00002b60: 6e74 5f73 7461 7465 2e70 6f6f 6c0a 0a20  nt_state.pool.. 
-00002b70: 2020 2020 2020 2023 2061 6d6f 756e 7420         # amount 
-00002b80: 6f75 7420 6973 206e 6567 6174 6976 650a  out is negative.
-00002b90: 2020 2020 2020 2020 6966 2073 696d 5f72          if sim_r
-00002ba0: 6573 756c 742e 616d 6f75 6e74 305f 6465  esult.amount0_de
-00002bb0: 6c74 6120 3c20 7369 6d5f 7265 7375 6c74  lta < sim_result
-00002bc0: 2e61 6d6f 756e 7431 5f64 656c 7461 3a0a  .amount1_delta:.
-00002bd0: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-00002be0: 6e5f 696e 203d 2070 6f6f 6c2e 746f 6b65  n_in = pool.toke
-00002bf0: 6e31 0a20 2020 2020 2020 2020 2020 2074  n1.            t
-00002c00: 6f6b 656e 5f6f 7574 203d 2070 6f6f 6c2e  oken_out = pool.
-00002c10: 746f 6b65 6e30 0a20 2020 2020 2020 2020  token0.         
-00002c20: 2020 2061 6d6f 756e 745f 696e 203d 2073     amount_in = s
-00002c30: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
-00002c40: 315f 6465 6c74 610a 2020 2020 2020 2020  1_delta.        
-00002c50: 2020 2020 616d 6f75 6e74 5f6f 7574 203d      amount_out =
-00002c60: 202d 7369 6d5f 7265 7375 6c74 2e61 6d6f   -sim_result.amo
-00002c70: 756e 7430 5f64 656c 7461 0a20 2020 2020  unt0_delta.     
-00002c80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00002c90: 2020 2020 2074 6f6b 656e 5f69 6e20 3d20       token_in = 
-00002ca0: 706f 6f6c 2e74 6f6b 656e 300a 2020 2020  pool.token0.    
-00002cb0: 2020 2020 2020 2020 746f 6b65 6e5f 6f75          token_ou
-00002cc0: 7420 3d20 706f 6f6c 2e74 6f6b 656e 310a  t = pool.token1.
-00002cd0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-00002ce0: 6e74 5f69 6e20 3d20 7369 6d5f 7265 7375  nt_in = sim_resu
-00002cf0: 6c74 2e61 6d6f 756e 7430 5f64 656c 7461  lt.amount0_delta
-00002d00: 0a20 2020 2020 2020 2020 2020 2061 6d6f  .            amo
-00002d10: 756e 745f 6f75 7420 3d20 2d73 696d 5f72  unt_out = -sim_r
-00002d20: 6573 756c 742e 616d 6f75 6e74 315f 6465  esult.amount1_de
-00002d30: 6c74 610a 0a20 2020 2020 2020 206c 6f67  lta..        log
-00002d40: 6765 722e 696e 666f 2866 2253 696d 756c  ger.info(f"Simul
-00002d50: 6174 696e 6720 7377 6170 2074 6872 6f75  ating swap throu
-00002d60: 6768 2070 6f6f 6c3a 207b 706f 6f6c 7d22  gh pool: {pool}"
-00002d70: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
-00002d80: 2e69 6e66 6f28 6622 5c74 7b61 6d6f 756e  .info(f"\t{amoun
-00002d90: 745f 696e 7d20 7b74 6f6b 656e 5f69 6e7d  t_in} {token_in}
-00002da0: 202d 3e20 7b61 6d6f 756e 745f 6f75 747d   -> {amount_out}
-00002db0: 207b 746f 6b65 6e5f 6f75 747d 2229 0a20   {token_out}"). 
-00002dc0: 2020 2020 2020 206d 6174 6368 2073 696d         match sim
-00002dd0: 5f72 6573 756c 743a 0a20 2020 2020 2020  _result:.       
-00002de0: 2020 2020 2063 6173 6520 556e 6973 7761       case Uniswa
-00002df0: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
-00002e00: 6e52 6573 756c 7428 293a 0a20 2020 2020  nResult():.     
-00002e10: 2020 2020 2020 2020 2020 2069 6620 5459             if TY
-00002e20: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
-00002e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e40: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00002e50: 6365 2863 7572 7265 6e74 5f73 7461 7465  ce(current_state
-00002e60: 2c20 556e 6973 7761 7056 3250 6f6f 6c53  , UniswapV2PoolS
-00002e70: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
-00002e80: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00002e90: 2069 7369 6e73 7461 6e63 6528 6675 7475   isinstance(futu
-00002ea0: 7265 5f73 7461 7465 2c20 556e 6973 7761  re_state, Uniswa
-00002eb0: 7056 3250 6f6f 6c53 7461 7465 290a 2020  pV2PoolState).  
-00002ec0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00002ed0: 6767 6572 2e69 6e66 6f28 225c 7428 4355  gger.info("\t(CU
-00002ee0: 5252 454e 5429 2229 0a20 2020 2020 2020  RRENT)").       
-00002ef0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00002f00: 696e 666f 2866 225c 747b 706f 6f6c 2e74  info(f"\t{pool.t
-00002f10: 6f6b 656e 307d 3a20 7b63 7572 7265 6e74  oken0}: {current
-00002f20: 5f73 7461 7465 2e72 6573 6572 7665 735f  _state.reserves_
-00002f30: 746f 6b65 6e30 7d22 290a 2020 2020 2020  token0}").      
-00002f40: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00002f50: 2e69 6e66 6f28 6622 5c74 7b70 6f6f 6c2e  .info(f"\t{pool.
-00002f60: 746f 6b65 6e31 7d3a 207b 6375 7272 656e  token1}: {curren
-00002f70: 745f 7374 6174 652e 7265 7365 7276 6573  t_state.reserves
-00002f80: 5f74 6f6b 656e 317d 2229 0a20 2020 2020  _token1}").     
-00002f90: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00002fa0: 722e 696e 666f 2822 5c74 2846 5554 5552  r.info("\t(FUTUR
-00002fb0: 4529 2229 0a20 2020 2020 2020 2020 2020  E)").           
-00002fc0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00002fd0: 2866 225c 747b 706f 6f6c 2e74 6f6b 656e  (f"\t{pool.token
-00002fe0: 307d 3a20 7b66 7574 7572 655f 7374 6174  0}: {future_stat
-00002ff0: 652e 7265 7365 7276 6573 5f74 6f6b 656e  e.reserves_token
-00003000: 307d 2229 0a20 2020 2020 2020 2020 2020  0}").           
-00003010: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00003020: 2866 225c 747b 706f 6f6c 2e74 6f6b 656e  (f"\t{pool.token
-00003030: 317d 3a20 7b66 7574 7572 655f 7374 6174  1}: {future_stat
-00003040: 652e 7265 7365 7276 6573 5f74 6f6b 656e  e.reserves_token
-00003050: 317d 2229 0a20 2020 2020 2020 2020 2020  1}").           
-00003060: 2063 6173 6520 556e 6973 7761 7056 3350   case UniswapV3P
-00003070: 6f6f 6c53 696d 756c 6174 696f 6e52 6573  oolSimulationRes
-00003080: 756c 7428 293a 0a20 2020 2020 2020 2020  ult():.         
-00003090: 2020 2020 2020 2069 6620 5459 5045 5f43         if TYPE_C
-000030a0: 4845 434b 494e 473a 0a20 2020 2020 2020  HECKING:.       
-000030b0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000030c0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
-000030d0: 7572 7265 6e74 5f73 7461 7465 2c20 556e  urrent_state, Un
-000030e0: 6973 7761 7056 3350 6f6f 6c53 7461 7465  iswapV3PoolState
-000030f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00003100: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00003110: 6e73 7461 6e63 6528 6675 7475 7265 5f73  nstance(future_s
-00003120: 7461 7465 2c20 556e 6973 7761 7056 3350  tate, UniswapV3P
-00003130: 6f6f 6c53 7461 7465 290a 2020 2020 2020  oolState).      
-00003140: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00003150: 2e69 6e66 6f28 6622 5c74 7b61 6d6f 756e  .info(f"\t{amoun
-00003160: 745f 696e 7d20 7b74 6f6b 656e 5f69 6e7d  t_in} {token_in}
-00003170: 202d 3e20 7b61 6d6f 756e 745f 6f75 747d   -> {amount_out}
-00003180: 207b 746f 6b65 6e5f 6f75 747d 2229 0a20   {token_out}"). 
-00003190: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000031a0: 6f67 6765 722e 696e 666f 2822 5c74 2843  ogger.info("\t(C
-000031b0: 5552 5245 4e54 2922 290a 2020 2020 2020  URRENT)").      
-000031c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000031d0: 2e69 6e66 6f28 6622 5c74 7072 6963 653d  .info(f"\tprice=
-000031e0: 7b63 7572 7265 6e74 5f73 7461 7465 2e73  {current_state.s
-000031f0: 7172 745f 7072 6963 655f 7839 367d 2229  qrt_price_x96}")
-00003200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003210: 206c 6f67 6765 722e 696e 666f 2866 225c   logger.info(f"\
-00003220: 746c 6971 7569 6469 7479 3d7b 6375 7272  tliquidity={curr
-00003230: 656e 745f 7374 6174 652e 6c69 7175 6964  ent_state.liquid
-00003240: 6974 797d 2229 0a20 2020 2020 2020 2020  ity}").         
-00003250: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00003260: 666f 2866 225c 7474 6963 6b3d 7b63 7572  fo(f"\ttick={cur
-00003270: 7265 6e74 5f73 7461 7465 2e74 6963 6b7d  rent_state.tick}
-00003280: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00003290: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-000032a0: 5c74 2846 5554 5552 4529 2229 0a20 2020  \t(FUTURE)").   
-000032b0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000032c0: 6765 722e 696e 666f 2866 225c 7470 7269  ger.info(f"\tpri
-000032d0: 6365 3d7b 6675 7475 7265 5f73 7461 7465  ce={future_state
-000032e0: 2e73 7172 745f 7072 6963 655f 7839 367d  .sqrt_price_x96}
-000032f0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00003300: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-00003310: 225c 746c 6971 7569 6469 7479 3d7b 6675  "\tliquidity={fu
-00003320: 7475 7265 5f73 7461 7465 2e6c 6971 7569  ture_state.liqui
-00003330: 6469 7479 7d22 290a 2020 2020 2020 2020  dity}").        
-00003340: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00003350: 6e66 6f28 6622 5c74 7469 636b 3d7b 6675  nfo(f"\ttick={fu
-00003360: 7475 7265 5f73 7461 7465 2e74 6963 6b7d  ture_state.tick}
-00003370: 2229 0a0a 2020 2020 6465 6620 5f73 696d  ")..    def _sim
-00003380: 756c 6174 655f 7632 5f73 7761 705f 6578  ulate_v2_swap_ex
-00003390: 6163 745f 696e 280a 2020 2020 2020 2020  act_in(.        
-000033a0: 7365 6c66 2c0a 2020 2020 2020 2020 706f  self,.        po
-000033b0: 6f6c 3a20 4c69 7175 6964 6974 7950 6f6f  ol: LiquidityPoo
-000033c0: 6c2c 0a20 2020 2020 2020 2072 6563 6970  l,.        recip
-000033d0: 6965 6e74 3a20 4368 6563 6b73 756d 4164  ient: ChecksumAd
-000033e0: 6472 6573 7320 7c20 7374 722c 0a20 2020  dress | str,.   
-000033f0: 2020 2020 2074 6f6b 656e 5f69 6e3a 2045       token_in: E
-00003400: 7263 3230 546f 6b65 6e2c 0a20 2020 2020  rc20Token,.     
-00003410: 2020 2061 6d6f 756e 745f 696e 3a20 696e     amount_in: in
-00003420: 742c 0a20 2020 2020 2020 2061 6d6f 756e  t,.        amoun
-00003430: 745f 6f75 745f 6d69 6e3a 2069 6e74 207c  t_out_min: int |
-00003440: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00003450: 2020 2020 2020 6669 7273 745f 7377 6170        first_swap
-00003460: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00003470: 2020 2020 2020 2020 6c61 7374 5f73 7761          last_swa
-00003480: 703a 2062 6f6f 6c20 3d20 4661 6c73 652c  p: bool = False,
-00003490: 0a20 2020 2029 202d 3e20 5475 706c 655b  .    ) -> Tuple[
-000034a0: 0a20 2020 2020 2020 204c 6971 7569 6469  .        Liquidi
-000034b0: 7479 506f 6f6c 2c0a 2020 2020 2020 2020  tyPool,.        
-000034c0: 556e 6973 7761 7056 3250 6f6f 6c53 696d  UniswapV2PoolSim
-000034d0: 756c 6174 696f 6e52 6573 756c 742c 0a20  ulationResult,. 
-000034e0: 2020 205d 3a0a 2020 2020 2020 2020 6173     ]:.        as
-000034f0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-00003500: 706f 6f6c 2c20 4c69 7175 6964 6974 7950  pool, LiquidityP
-00003510: 6f6f 6c29 2c20 6622 4361 6c6c 6564 205f  ool), f"Called _
-00003520: 7369 6d75 6c61 7465 5f76 325f 7377 6170  simulate_v2_swap
-00003530: 5f65 7861 6374 5f69 6e20 6f6e 2070 6f6f  _exact_in on poo
-00003540: 6c20 7b70 6f6f 6c7d 220a 0a20 2020 2020  l {pool}"..     
-00003550: 2020 2073 696c 656e 7420 3d20 7365 6c66     silent = self
-00003560: 2e73 696c 656e 740a 0a20 2020 2020 2020  .silent..       
-00003570: 2069 6620 746f 6b65 6e5f 696e 206e 6f74   if token_in not
-00003580: 2069 6e20 706f 6f6c 2e74 6f6b 656e 733a   in pool.tokens:
-00003590: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000035a0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-000035b0: 546f 6b65 6e20 7b74 6f6b 656e 5f69 6e7d  Token {token_in}
-000035c0: 206e 6f74 2066 6f75 6e64 2069 6e20 706f   not found in po
-000035d0: 6f6c 207b 706f 6f6c 7d22 290a 0a20 2020  ol {pool}")..   
-000035e0: 2020 2020 2074 6f6b 656e 5f6f 7574 203d       token_out =
-000035f0: 2070 6f6f 6c2e 746f 6b65 6e31 2069 6620   pool.token1 if 
-00003600: 746f 6b65 6e5f 696e 203d 3d20 706f 6f6c  token_in == pool
-00003610: 2e74 6f6b 656e 3020 656c 7365 2070 6f6f  .token0 else poo
-00003620: 6c2e 746f 6b65 6e30 0a0a 2020 2020 2020  l.token0..      
-00003630: 2020 6966 2061 6d6f 756e 745f 696e 2069    if amount_in i
-00003640: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00003650: 556e 6976 6572 7361 6c52 6f75 7465 7253  UniversalRouterS
-00003660: 7065 6369 616c 5661 6c75 6573 2e55 5345  pecialValues.USE
-00003670: 5f43 4f4e 5452 4143 545f 4241 4c41 4e43  _CONTRACT_BALANC
-00003680: 452c 0a20 2020 2020 2020 2020 2020 2056  E,.            V
-00003690: 3352 6f75 7465 7253 7065 6369 616c 5661  3RouterSpecialVa
-000036a0: 6c75 6573 2e55 5345 5f43 4f4e 5452 4143  lues.USE_CONTRAC
-000036b0: 545f 4241 4c41 4e43 452c 0a20 2020 2020  T_BALANCE,.     
-000036c0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-000036d0: 2020 5f62 616c 616e 6365 203d 2073 656c    _balance = sel
-000036e0: 662e 6c65 6467 6572 2e74 6f6b 656e 5f62  f.ledger.token_b
-000036f0: 616c 616e 6365 2873 656c 662e 726f 7574  alance(self.rout
-00003700: 6572 5f61 6464 7265 7373 2c20 746f 6b65  er_address, toke
-00003710: 6e5f 696e 290a 0a20 2020 2020 2020 2020  n_in)..         
-00003720: 2020 2073 656c 662e 6c65 6467 6572 2e74     self.ledger.t
-00003730: 7261 6e73 6665 7228 0a20 2020 2020 2020  ransfer(.       
-00003740: 2020 2020 2020 2020 2074 6f6b 656e 3d74           token=t
-00003750: 6f6b 656e 5f69 6e2c 0a20 2020 2020 2020  oken_in,.       
-00003760: 2020 2020 2020 2020 2061 6d6f 756e 743d           amount=
-00003770: 5f62 616c 616e 6365 2c0a 2020 2020 2020  _balance,.      
-00003780: 2020 2020 2020 2020 2020 746f 5f61 6464            to_add
-00003790: 723d 706f 6f6c 2e61 6464 7265 7373 2c0a  r=pool.address,.
-000037a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037b0: 6672 6f6d 5f61 6464 723d 7365 6c66 2e72  from_addr=self.r
-000037c0: 6f75 7465 725f 6164 6472 6573 732c 0a20  outer_address,. 
-000037d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000037e0: 2020 2020 2020 2020 2061 6d6f 756e 745f           amount_
-000037f0: 696e 203d 2073 656c 662e 6c65 6467 6572  in = self.ledger
-00003800: 2e74 6f6b 656e 5f62 616c 616e 6365 2870  .token_balance(p
-00003810: 6f6f 6c2e 6164 6472 6573 732c 2074 6f6b  ool.address, tok
-00003820: 656e 5f69 6e29 0a0a 2020 2020 2020 2020  en_in)..        
-00003830: 7369 6d5f 7265 7375 6c74 203d 2070 6f6f  sim_result = poo
-00003840: 6c2e 7369 6d75 6c61 7465 5f73 7761 7028  l.simulate_swap(
-00003850: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
-00003860: 656e 5f69 6e3d 746f 6b65 6e5f 696e 2c0a  en_in=token_in,.
-00003870: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-00003880: 6e5f 696e 5f71 7561 6e74 6974 793d 616d  n_in_quantity=am
-00003890: 6f75 6e74 5f69 6e2c 0a20 2020 2020 2020  ount_in,.       
-000038a0: 2029 0a0a 2020 2020 2020 2020 5f61 6d6f   )..        _amo
-000038b0: 756e 745f 6f75 7420 3d20 2d6d 696e 280a  unt_out = -min(.
-000038c0: 2020 2020 2020 2020 2020 2020 7369 6d5f              sim_
-000038d0: 7265 7375 6c74 2e61 6d6f 756e 7430 5f64  result.amount0_d
-000038e0: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
-000038f0: 2020 7369 6d5f 7265 7375 6c74 2e61 6d6f    sim_result.amo
-00003900: 756e 7431 5f64 656c 7461 2c0a 2020 2020  unt1_delta,.    
-00003910: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
-00003920: 6620 6669 7273 745f 7377 6170 2061 6e64  f first_swap and
-00003930: 206e 6f74 2073 656c 662e 6c65 6467 6572   not self.ledger
-00003940: 2e74 6f6b 656e 5f62 616c 616e 6365 2870  .token_balance(p
-00003950: 6f6f 6c2e 6164 6472 6573 732c 2074 6f6b  ool.address, tok
-00003960: 656e 5f69 6e29 3a0a 2020 2020 2020 2020  en_in):.        
-00003970: 2020 2020 2320 6372 6564 6974 2074 6865      # credit the
-00003980: 2072 6f75 7465 7220 6966 2074 6865 7265   router if there
-00003990: 2069 7320 6120 7a65 726f 2062 616c 616e   is a zero balan
-000039a0: 6365 0a20 2020 2020 2020 2020 2020 2069  ce.            i
-000039b0: 6620 6e6f 7420 7365 6c66 2e6c 6564 6765  f not self.ledge
-000039c0: 722e 746f 6b65 6e5f 6261 6c61 6e63 6528  r.token_balance(
-000039d0: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
-000039e0: 6573 732c 2074 6f6b 656e 5f69 6e29 3a0a  ess, token_in):.
-000039f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a00: 7365 6c66 2e6c 6564 6765 722e 6164 6a75  self.ledger.adju
-00003a10: 7374 2873 656c 662e 726f 7574 6572 5f61  st(self.router_a
-00003a20: 6464 7265 7373 2c20 746f 6b65 6e5f 696e  ddress, token_in
-00003a30: 2e61 6464 7265 7373 2c20 616d 6f75 6e74  .address, amount
-00003a40: 5f69 6e29 0a20 2020 2020 2020 2020 2020  _in).           
-00003a50: 2073 656c 662e 6c65 6467 6572 2e74 7261   self.ledger.tra
-00003a60: 6e73 6665 7228 0a20 2020 2020 2020 2020  nsfer(.         
-00003a70: 2020 2020 2020 2074 6f6b 656e 5f69 6e2c         token_in,
-00003a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003a90: 2061 6d6f 756e 743d 616d 6f75 6e74 5f69   amount=amount_i
-00003aa0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00003ab0: 2020 2066 726f 6d5f 6164 6472 3d73 656c     from_addr=sel
-00003ac0: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
-00003ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003ae0: 2020 746f 5f61 6464 723d 706f 6f6c 2e61    to_addr=pool.a
-00003af0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-00003b00: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-00003b10: 2070 726f 6365 7373 2074 6865 2073 7761   process the swa
-00003b20: 700a 2020 2020 2020 2020 7365 6c66 2e6c  p.        self.l
-00003b30: 6564 6765 722e 6164 6a75 7374 2870 6f6f  edger.adjust(poo
-00003b40: 6c2e 6164 6472 6573 732c 2074 6f6b 656e  l.address, token
-00003b50: 5f69 6e2e 6164 6472 6573 732c 202d 616d  _in.address, -am
-00003b60: 6f75 6e74 5f69 6e29 0a20 2020 2020 2020  ount_in).       
-00003b70: 2073 656c 662e 6c65 6467 6572 2e61 646a   self.ledger.adj
-00003b80: 7573 7428 706f 6f6c 2e61 6464 7265 7373  ust(pool.address
-00003b90: 2c20 746f 6b65 6e5f 6f75 742e 6164 6472  , token_out.addr
-00003ba0: 6573 732c 205f 616d 6f75 6e74 5f6f 7574  ess, _amount_out
-00003bb0: 290a 0a20 2020 2020 2020 2023 2074 7261  )..        # tra
-00003bc0: 6e73 6665 7220 746f 2074 6865 2072 6563  nsfer to the rec
-00003bd0: 6970 6965 6e74 0a20 2020 2020 2020 2073  ipient.        s
-00003be0: 656c 662e 6c65 6467 6572 2e74 7261 6e73  elf.ledger.trans
-00003bf0: 6665 7228 0a20 2020 2020 2020 2020 2020  fer(.           
-00003c00: 2074 6f6b 656e 3d74 6f6b 656e 5f6f 7574   token=token_out
-00003c10: 2c0a 2020 2020 2020 2020 2020 2020 616d  ,.            am
-00003c20: 6f75 6e74 3d5f 616d 6f75 6e74 5f6f 7574  ount=_amount_out
-00003c30: 2c0a 2020 2020 2020 2020 2020 2020 6672  ,.            fr
-00003c40: 6f6d 5f61 6464 723d 706f 6f6c 2e61 6464  om_addr=pool.add
-00003c50: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00003c60: 2020 746f 5f61 6464 723d 7265 6369 7069    to_addr=recipi
-00003c70: 656e 742c 0a20 2020 2020 2020 2029 0a0a  ent,.        )..
-00003c80: 2020 2020 2020 2020 6966 206c 6173 745f          if last_
-00003c90: 7377 6170 3a0a 2020 2020 2020 2020 2020  swap:.          
-00003ca0: 2020 7365 6c66 2e72 6563 6970 6965 6e74    self.recipient
-00003cb0: 732e 6164 6428 746f 5f63 6865 636b 7375  s.add(to_checksu
-00003cc0: 6d5f 6164 6472 6573 7328 7265 6369 7069  m_address(recipi
-00003cd0: 656e 7429 290a 0a20 2020 2020 2020 2069  ent))..        i
-00003ce0: 6620 6c61 7374 5f73 7761 7020 616e 6420  f last_swap and 
-00003cf0: 616d 6f75 6e74 5f6f 7574 5f6d 696e 2069  amount_out_min i
-00003d00: 7320 6e6f 7420 4e6f 6e65 2061 6e64 205f  s not None and _
-00003d10: 616d 6f75 6e74 5f6f 7574 203c 2061 6d6f  amount_out < amo
-00003d20: 756e 745f 6f75 745f 6d69 6e3a 0a20 2020  unt_out_min:.   
-00003d30: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-00003d40: 7261 6e73 6163 7469 6f6e 4572 726f 7228  ransactionError(
-00003d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003d60: 2066 2249 6e73 7566 6669 6369 656e 7420   f"Insufficient 
-00003d70: 6f75 7470 7574 2066 6f72 2073 7761 7021  output for swap!
-00003d80: 207b 5f61 6d6f 756e 745f 6f75 747d 207b   {_amount_out} {
-00003d90: 746f 6b65 6e5f 6f75 747d 2072 6563 6569  token_out} recei
-00003da0: 7665 642c 207b 616d 6f75 6e74 5f6f 7574  ved, {amount_out
-00003db0: 5f6d 696e 7d20 7265 7175 6972 6564 220a  _min} required".
-00003dc0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00003dd0: 2020 2020 2020 2069 6620 6e6f 7420 7369         if not si
-00003de0: 6c65 6e74 3a0a 2020 2020 2020 2020 2020  lent:.          
-00003df0: 2020 7365 6c66 2e5f 7368 6f77 5f70 6f6f    self._show_poo
-00003e00: 6c5f 7374 6174 6573 2873 696d 5f72 6573  l_states(sim_res
-00003e10: 756c 7429 0a0a 2020 2020 2020 2020 7265  ult)..        re
-00003e20: 7475 726e 2070 6f6f 6c2c 2073 696d 5f72  turn pool, sim_r
-00003e30: 6573 756c 740a 0a20 2020 2064 6566 205f  esult..    def _
-00003e40: 7369 6d75 6c61 7465 5f76 325f 6164 645f  simulate_v2_add_
-00003e50: 6c69 7175 6964 6974 7928 0a20 2020 2020  liquidity(.     
-00003e60: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00003e70: 2070 6f6f 6c3a 204c 6971 7569 6469 7479   pool: Liquidity
-00003e80: 506f 6f6c 2c0a 2020 2020 2020 2020 6164  Pool,.        ad
-00003e90: 6465 645f 7265 7365 7276 6573 5f74 6f6b  ded_reserves_tok
-00003ea0: 656e 303a 2069 6e74 2c0a 2020 2020 2020  en0: int,.      
-00003eb0: 2020 6164 6465 645f 7265 7365 7276 6573    added_reserves
-00003ec0: 5f74 6f6b 656e 313a 2069 6e74 2c0a 2020  _token1: int,.  
-00003ed0: 2020 2920 2d3e 2055 6e69 7377 6170 5632    ) -> UniswapV2
-00003ee0: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
-00003ef0: 7375 6c74 3a0a 2020 2020 2020 2020 7265  sult:.        re
-00003f00: 7475 726e 2070 6f6f 6c2e 7369 6d75 6c61  turn pool.simula
-00003f10: 7465 5f61 6464 5f6c 6971 7569 6469 7479  te_add_liquidity
-00003f20: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
-00003f30: 6465 645f 7265 7365 7276 6573 5f74 6f6b  ded_reserves_tok
-00003f40: 656e 303d 6164 6465 645f 7265 7365 7276  en0=added_reserv
-00003f50: 6573 5f74 6f6b 656e 302c 0a20 2020 2020  es_token0,.     
-00003f60: 2020 2020 2020 2061 6464 6564 5f72 6573         added_res
-00003f70: 6572 7665 735f 746f 6b65 6e31 3d61 6464  erves_token1=add
-00003f80: 6564 5f72 6573 6572 7665 735f 746f 6b65  ed_reserves_toke
-00003f90: 6e31 2c0a 2020 2020 2020 2020 290a 0a20  n1,.        ).. 
-00003fa0: 2020 2064 6566 205f 7369 6d75 6c61 7465     def _simulate
-00003fb0: 5f76 325f 7377 6170 5f65 7861 6374 5f6f  _v2_swap_exact_o
-00003fc0: 7574 280a 2020 2020 2020 2020 7365 6c66  ut(.        self
-00003fd0: 2c0a 2020 2020 2020 2020 706f 6f6c 3a20  ,.        pool: 
-00003fe0: 4c69 7175 6964 6974 7950 6f6f 6c2c 0a20  LiquidityPool,. 
-00003ff0: 2020 2020 2020 2072 6563 6970 6965 6e74         recipient
-00004000: 3a20 4368 6563 6b73 756d 4164 6472 6573  : ChecksumAddres
-00004010: 7320 7c20 7374 722c 0a20 2020 2020 2020  s | str,.       
-00004020: 2074 6f6b 656e 5f69 6e3a 2045 7263 3230   token_in: Erc20
-00004030: 546f 6b65 6e2c 0a20 2020 2020 2020 2061  Token,.        a
-00004040: 6d6f 756e 745f 6f75 743a 2069 6e74 2c0a  mount_out: int,.
-00004050: 2020 2020 2020 2020 616d 6f75 6e74 5f69          amount_i
-00004060: 6e5f 6d61 783a 2069 6e74 207c 204e 6f6e  n_max: int | Non
-00004070: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00004080: 2020 6669 7273 745f 7377 6170 3a20 626f    first_swap: bo
-00004090: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-000040a0: 2920 2d3e 2054 7570 6c65 5b4c 6971 7569  ) -> Tuple[Liqui
-000040b0: 6469 7479 506f 6f6c 2c20 556e 6973 7761  dityPool, Uniswa
-000040c0: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
-000040d0: 6e52 6573 756c 745d 3a0a 2020 2020 2020  nResult]:.      
-000040e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000040f0: 6e63 6528 706f 6f6c 2c20 4c69 7175 6964  nce(pool, Liquid
-00004100: 6974 7950 6f6f 6c29 2c20 6622 4361 6c6c  ityPool), f"Call
-00004110: 6564 205f 7369 6d75 6c61 7465 5f76 325f  ed _simulate_v2_
-00004120: 7377 6170 5f65 7861 6374 5f6f 7574 206f  swap_exact_out o
-00004130: 6e20 706f 6f6c 207b 706f 6f6c 7d22 0a0a  n pool {pool}"..
-00004140: 2020 2020 2020 2020 7369 6c65 6e74 203d          silent =
-00004150: 2073 656c 662e 7369 6c65 6e74 0a0a 2020   self.silent..  
-00004160: 2020 2020 2020 6966 2074 6f6b 656e 5f69        if token_i
-00004170: 6e20 6e6f 7420 696e 2070 6f6f 6c2e 746f  n not in pool.to
-00004180: 6b65 6e73 3a0a 2020 2020 2020 2020 2020  kens:.          
-00004190: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000041a0: 6f72 2866 2254 6f6b 656e 207b 746f 6b65  or(f"Token {toke
-000041b0: 6e5f 696e 7d20 6e6f 7420 666f 756e 6420  n_in} not found 
-000041c0: 696e 2070 6f6f 6c20 7b70 6f6f 6c7d 2229  in pool {pool}")
-000041d0: 0a0a 2020 2020 2020 2020 746f 6b65 6e5f  ..        token_
-000041e0: 6f75 7420 3d20 706f 6f6c 2e74 6f6b 656e  out = pool.token
-000041f0: 3120 6966 2074 6f6b 656e 5f69 6e20 3d3d  1 if token_in ==
-00004200: 2070 6f6f 6c2e 746f 6b65 6e30 2065 6c73   pool.token0 els
-00004210: 6520 706f 6f6c 2e74 6f6b 656e 300a 0a20  e pool.token0.. 
-00004220: 2020 2020 2020 2073 696d 5f72 6573 756c         sim_resul
-00004230: 7420 3d20 706f 6f6c 2e73 696d 756c 6174  t = pool.simulat
-00004240: 655f 7377 6170 280a 2020 2020 2020 2020  e_swap(.        
-00004250: 2020 2020 746f 6b65 6e5f 6f75 743d 746f      token_out=to
-00004260: 6b65 6e5f 6f75 742c 0a20 2020 2020 2020  ken_out,.       
-00004270: 2020 2020 2074 6f6b 656e 5f6f 7574 5f71       token_out_q
-00004280: 7561 6e74 6974 793d 616d 6f75 6e74 5f6f  uantity=amount_o
-00004290: 7574 2c0a 2020 2020 2020 2020 290a 0a20  ut,.        ).. 
-000042a0: 2020 2020 2020 205f 616d 6f75 6e74 5f69         _amount_i
-000042b0: 6e20 3d20 6d61 7828 0a20 2020 2020 2020  n = max(.       
-000042c0: 2020 2020 2073 696d 5f72 6573 756c 742e       sim_result.
-000042d0: 616d 6f75 6e74 305f 6465 6c74 612c 0a20  amount0_delta,. 
-000042e0: 2020 2020 2020 2020 2020 2073 696d 5f72             sim_r
-000042f0: 6573 756c 742e 616d 6f75 6e74 315f 6465  esult.amount1_de
-00004300: 6c74 612c 0a20 2020 2020 2020 2029 0a0a  lta,.        )..
-00004310: 2020 2020 2020 2020 6966 2066 6972 7374          if first
-00004320: 5f73 7761 703a 0a20 2020 2020 2020 2020  _swap:.         
-00004330: 2020 2023 2074 7261 6e73 6665 7220 7468     # transfer th
-00004340: 6520 696e 7075 7420 746f 6b65 6e20 616d  e input token am
-00004350: 6f75 6e74 2066 726f 6d20 7468 6520 7365  ount from the se
-00004360: 6e64 6572 2074 6f20 7468 6520 6669 7273  nder to the firs
-00004370: 7420 706f 6f6c 0a20 2020 2020 2020 2020  t pool.         
-00004380: 2020 2073 656c 662e 6c65 6467 6572 2e74     self.ledger.t
-00004390: 7261 6e73 6665 7228 0a20 2020 2020 2020  ransfer(.       
-000043a0: 2020 2020 2020 2020 2074 6f6b 656e 3d74           token=t
-000043b0: 6f6b 656e 5f69 6e2e 6164 6472 6573 732c  oken_in.address,
-000043c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000043d0: 2061 6d6f 756e 743d 5f61 6d6f 756e 745f   amount=_amount_
-000043e0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-000043f0: 2020 2020 6672 6f6d 5f61 6464 723d 7365      from_addr=se
-00004400: 6c66 2e73 656e 6465 722c 0a20 2020 2020  lf.sender,.     
-00004410: 2020 2020 2020 2020 2020 2074 6f5f 6164             to_ad
-00004420: 6472 3d70 6f6f 6c2e 6164 6472 6573 732c  dr=pool.address,
-00004430: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00004440: 2020 2020 2020 2020 2320 7072 6f63 6573          # proces
-00004450: 7320 7468 6520 7377 6170 0a20 2020 2020  s the swap.     
-00004460: 2020 2073 656c 662e 6c65 6467 6572 2e61     self.ledger.a
-00004470: 646a 7573 7428 706f 6f6c 2e61 6464 7265  djust(pool.addre
-00004480: 7373 2c20 746f 6b65 6e5f 696e 2e61 6464  ss, token_in.add
-00004490: 7265 7373 2c20 2d5f 616d 6f75 6e74 5f69  ress, -_amount_i
-000044a0: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
-000044b0: 6c65 6467 6572 2e61 646a 7573 7428 706f  ledger.adjust(po
-000044c0: 6f6c 2e61 6464 7265 7373 2c20 746f 6b65  ol.address, toke
-000044d0: 6e5f 6f75 742e 6164 6472 6573 732c 2061  n_out.address, a
-000044e0: 6d6f 756e 745f 6f75 7429 0a0a 2020 2020  mount_out)..    
-000044f0: 2020 2020 2320 7472 616e 7366 6572 2074      # transfer t
-00004500: 6865 206f 7574 7075 7420 746f 6b65 6e20  he output token 
-00004510: 6672 6f6d 2074 6865 2070 6f6f 6c20 746f  from the pool to
-00004520: 2074 6865 2072 6563 6970 6965 6e74 0a20   the recipient. 
-00004530: 2020 2020 2020 2073 656c 662e 6c65 6467         self.ledg
-00004540: 6572 2e74 7261 6e73 6665 7228 0a20 2020  er.transfer(.   
-00004550: 2020 2020 2020 2020 2074 6f6b 656e 3d74           token=t
-00004560: 6f6b 656e 5f6f 7574 2e61 6464 7265 7373  oken_out.address
-00004570: 2c0a 2020 2020 2020 2020 2020 2020 616d  ,.            am
-00004580: 6f75 6e74 3d61 6d6f 756e 745f 6f75 742c  ount=amount_out,
-00004590: 0a20 2020 2020 2020 2020 2020 2066 726f  .            fro
-000045a0: 6d5f 6164 6472 3d70 6f6f 6c2e 6164 6472  m_addr=pool.addr
-000045b0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-000045c0: 2074 6f5f 6164 6472 3d72 6563 6970 6965   to_addr=recipie
-000045d0: 6e74 2c0a 2020 2020 2020 2020 290a 0a20  nt,.        ).. 
-000045e0: 2020 2020 2020 2069 6620 6669 7273 745f         if first_
-000045f0: 7377 6170 2061 6e64 2061 6d6f 756e 745f  swap and amount_
-00004600: 696e 5f6d 6178 2069 7320 6e6f 7420 4e6f  in_max is not No
-00004610: 6e65 2061 6e64 205f 616d 6f75 6e74 5f69  ne and _amount_i
-00004620: 6e20 3e20 616d 6f75 6e74 5f69 6e5f 6d61  n > amount_in_ma
-00004630: 783a 0a20 2020 2020 2020 2020 2020 2072  x:.            r
-00004640: 6169 7365 2054 7261 6e73 6163 7469 6f6e  aise Transaction
-00004650: 4572 726f 7228 6622 5265 7175 6972 6564  Error(f"Required
-00004660: 2069 6e70 7574 207b 5f61 6d6f 756e 745f   input {_amount_
-00004670: 696e 7d20 6578 6365 6564 7320 6d61 7869  in} exceeds maxi
-00004680: 6d75 6d20 7b61 6d6f 756e 745f 696e 5f6d  mum {amount_in_m
-00004690: 6178 7d22 290a 0a20 2020 2020 2020 2069  ax}")..        i
-000046a0: 6620 6e6f 7420 7369 6c65 6e74 3a0a 2020  f not silent:.  
-000046b0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000046c0: 7368 6f77 5f70 6f6f 6c5f 7374 6174 6573  show_pool_states
-000046d0: 2873 696d 5f72 6573 756c 7429 0a0a 2020  (sim_result)..  
-000046e0: 2020 2020 2020 7265 7475 726e 2070 6f6f        return poo
-000046f0: 6c2c 2073 696d 5f72 6573 756c 740a 0a20  l, sim_result.. 
-00004700: 2020 2064 6566 205f 7369 6d75 6c61 7465     def _simulate
-00004710: 5f76 335f 7377 6170 5f65 7861 6374 5f69  _v3_swap_exact_i
-00004720: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-00004730: 0a20 2020 2020 2020 2070 6f6f 6c3a 2056  .        pool: V
-00004740: 334c 6971 7569 6469 7479 506f 6f6c 2c0a  3LiquidityPool,.
-00004750: 2020 2020 2020 2020 7265 6369 7069 656e          recipien
-00004760: 743a 2073 7472 2c0a 2020 2020 2020 2020  t: str,.        
-00004770: 746f 6b65 6e5f 696e 3a20 4572 6332 3054  token_in: Erc20T
-00004780: 6f6b 656e 2c0a 2020 2020 2020 2020 616d  oken,.        am
-00004790: 6f75 6e74 5f69 6e3a 2069 6e74 2c0a 2020  ount_in: int,.  
-000047a0: 2020 2020 2020 616d 6f75 6e74 5f6f 7574        amount_out
-000047b0: 5f6d 696e 3a20 696e 7420 7c20 4e6f 6e65  _min: int | None
-000047c0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000047d0: 2073 7172 745f 7072 6963 655f 6c69 6d69   sqrt_price_limi
-000047e0: 745f 7839 363a 2069 6e74 207c 204e 6f6e  t_x96: int | Non
-000047f0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00004800: 2020 6669 7273 745f 7377 6170 3a20 626f    first_swap: bo
-00004810: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00004820: 2920 2d3e 2054 7570 6c65 5b56 334c 6971  ) -> Tuple[V3Liq
-00004830: 7569 6469 7479 506f 6f6c 2c20 556e 6973  uidityPool, Unis
-00004840: 7761 7056 3350 6f6f 6c53 696d 756c 6174  wapV3PoolSimulat
-00004850: 696f 6e52 6573 756c 745d 3a0a 2020 2020  ionResult]:.    
-00004860: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00004870: 7461 6e63 6528 0a20 2020 2020 2020 2020  tance(.         
-00004880: 2020 2070 6f6f 6c2c 2056 334c 6971 7569     pool, V3Liqui
-00004890: 6469 7479 506f 6f6c 0a20 2020 2020 2020  dityPool.       
-000048a0: 2029 2c20 6622 4361 6c6c 6564 205f 7369   ), f"Called _si
-000048b0: 6d75 6c61 7465 5f76 335f 7377 6170 5f65  mulate_v3_swap_e
-000048c0: 7861 6374 5f69 6e20 6f6e 2070 6f6f 6c20  xact_in on pool 
-000048d0: 7b70 6f6f 6c7d 220a 0a20 2020 2020 2020  {pool}"..       
-000048e0: 2073 696c 656e 7420 3d20 7365 6c66 2e73   silent = self.s
-000048f0: 696c 656e 740a 0a20 2020 2020 2020 2073  ilent..        s
-00004900: 656c 662e 7265 6369 7069 656e 7473 2e61  elf.recipients.a
-00004910: 6464 2874 6f5f 6368 6563 6b73 756d 5f61  dd(to_checksum_a
-00004920: 6464 7265 7373 2872 6563 6970 6965 6e74  ddress(recipient
-00004930: 2929 0a0a 2020 2020 2020 2020 6966 2074  ))..        if t
-00004940: 6f6b 656e 5f69 6e20 6e6f 7420 696e 2070  oken_in not in p
-00004950: 6f6f 6c2e 746f 6b65 6e73 3a0a 2020 2020  ool.tokens:.    
-00004960: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00004970: 6c75 6545 7272 6f72 2866 2254 6f6b 656e  lueError(f"Token
-00004980: 207b 746f 6b65 6e5f 696e 7d20 6e6f 7420   {token_in} not 
-00004990: 666f 756e 6420 696e 2070 6f6f 6c20 7b70  found in pool {p
-000049a0: 6f6f 6c7d 2229 0a0a 2020 2020 2020 2020  ool}")..        
-000049b0: 746f 6b65 6e5f 6f75 7420 3d20 706f 6f6c  token_out = pool
-000049c0: 2e74 6f6b 656e 3120 6966 2074 6f6b 656e  .token1 if token
-000049d0: 5f69 6e20 3d3d 2070 6f6f 6c2e 746f 6b65  _in == pool.toke
-000049e0: 6e30 2065 6c73 6520 706f 6f6c 2e74 6f6b  n0 else pool.tok
-000049f0: 656e 300a 0a20 2020 2020 2020 2069 6620  en0..        if 
-00004a00: 616d 6f75 6e74 5f69 6e20 696e 2028 0a20  amount_in in (. 
-00004a10: 2020 2020 2020 2020 2020 2055 6e69 7665             Unive
-00004a20: 7273 616c 526f 7574 6572 5370 6563 6961  rsalRouterSpecia
-00004a30: 6c56 616c 7565 732e 5553 455f 434f 4e54  lValues.USE_CONT
-00004a40: 5241 4354 5f42 414c 414e 4345 2c0a 2020  RACT_BALANCE,.  
-00004a50: 2020 2020 2020 2020 2020 5633 526f 7574            V3Rout
-00004a60: 6572 5370 6563 6961 6c56 616c 7565 732e  erSpecialValues.
-00004a70: 5553 455f 434f 4e54 5241 4354 5f42 414c  USE_CONTRACT_BAL
-00004a80: 414e 4345 2c0a 2020 2020 2020 2020 293a  ANCE,.        ):
-00004a90: 0a20 2020 2020 2020 2020 2020 2061 6d6f  .            amo
-00004aa0: 756e 745f 696e 203d 2073 656c 662e 6c65  unt_in = self.le
-00004ab0: 6467 6572 2e74 6f6b 656e 5f62 616c 616e  dger.token_balan
-00004ac0: 6365 2873 656c 662e 726f 7574 6572 5f61  ce(self.router_a
-00004ad0: 6464 7265 7373 2c20 746f 6b65 6e5f 696e  ddress, token_in
-00004ae0: 2e61 6464 7265 7373 290a 0a20 2020 2020  .address)..     
-00004af0: 2020 2023 2074 6865 2073 7761 7020 6d61     # the swap ma
-00004b00: 7920 6f63 6375 7220 6166 7465 7220 7772  y occur after wr
-00004b10: 6170 7069 6e67 2045 5448 2c20 696e 2077  apping ETH, in w
-00004b20: 6869 6368 2063 6173 6520 616d 6f75 6e74  hich case amount
-00004b30: 496e 2077 696c 6c0a 2020 2020 2020 2020  In will.        
-00004b40: 2320 6265 2061 6c72 6561 6479 2073 6574  # be already set
-00004b50: 2e20 4966 206e 6f74 2c20 6372 6564 6974  . If not, credit
-00004b60: 2074 6865 2072 6f75 7465 7220 2875 7365   the router (use
-00004b70: 7220 7472 616e 7366 6572 7320 7468 6520  r transfers the 
-00004b80: 696e 7075 7429 0a20 2020 2020 2020 2069  input).        i
-00004b90: 6620 6669 7273 745f 7377 6170 2061 6e64  f first_swap and
-00004ba0: 206e 6f74 2073 656c 662e 6c65 6467 6572   not self.ledger
-00004bb0: 2e74 6f6b 656e 5f62 616c 616e 6365 2873  .token_balance(s
-00004bc0: 656c 662e 726f 7574 6572 5f61 6464 7265  elf.router_addre
-00004bd0: 7373 2c20 746f 6b65 6e5f 696e 2e61 6464  ss, token_in.add
-00004be0: 7265 7373 293a 0a20 2020 2020 2020 2020  ress):.         
-00004bf0: 2020 2073 656c 662e 6c65 6467 6572 2e61     self.ledger.a
-00004c00: 646a 7573 7428 0a20 2020 2020 2020 2020  djust(.         
-00004c10: 2020 2020 2020 2073 656c 662e 726f 7574         self.rout
-00004c20: 6572 5f61 6464 7265 7373 2c0a 2020 2020  er_address,.    
-00004c30: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-00004c40: 6e5f 696e 2e61 6464 7265 7373 2c0a 2020  n_in.address,.  
-00004c50: 2020 2020 2020 2020 2020 2020 2020 616d                am
-00004c60: 6f75 6e74 5f69 6e2c 0a20 2020 2020 2020  ount_in,.       
-00004c70: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00004c80: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00004c90: 205f 7369 6d5f 7265 7375 6c74 203d 2070   _sim_result = p
-00004ca0: 6f6f 6c2e 7369 6d75 6c61 7465 5f73 7761  ool.simulate_swa
-00004cb0: 7028 0a20 2020 2020 2020 2020 2020 2020  p(.             
-00004cc0: 2020 2074 6f6b 656e 5f69 6e3d 746f 6b65     token_in=toke
-00004cd0: 6e5f 696e 2c0a 2020 2020 2020 2020 2020  n_in,.          
-00004ce0: 2020 2020 2020 746f 6b65 6e5f 696e 5f71        token_in_q
-00004cf0: 7561 6e74 6974 793d 616d 6f75 6e74 5f69  uantity=amount_i
-00004d00: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-00004d10: 2020 2073 7172 745f 7072 6963 655f 6c69     sqrt_price_li
-00004d20: 6d69 743d 7371 7274 5f70 7269 6365 5f6c  mit=sqrt_price_l
-00004d30: 696d 6974 5f78 3936 2c0a 2020 2020 2020  imit_x96,.      
-00004d40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00004d50: 6578 6365 7074 2045 564d 5265 7665 7274  except EVMRevert
-00004d60: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
-00004d70: 2020 2020 2020 2020 7261 6973 6520 5472          raise Tr
-00004d80: 616e 7361 6374 696f 6e45 7272 6f72 2866  ansactionError(f
-00004d90: 2256 3320 7265 7665 7274 3a20 7b65 7d22  "V3 revert: {e}"
-00004da0: 290a 0a20 2020 2020 2020 205f 616d 6f75  )..        _amou
-00004db0: 6e74 5f6f 7574 203d 202d 6d69 6e28 0a20  nt_out = -min(. 
-00004dc0: 2020 2020 2020 2020 2020 205f 7369 6d5f             _sim_
-00004dd0: 7265 7375 6c74 2e61 6d6f 756e 7430 5f64  result.amount0_d
-00004de0: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
-00004df0: 2020 5f73 696d 5f72 6573 756c 742e 616d    _sim_result.am
-00004e00: 6f75 6e74 315f 6465 6c74 612c 0a20 2020  ount1_delta,.   
-00004e10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00004e20: 7365 6c66 2e6c 6564 6765 722e 6164 6a75  self.ledger.adju
-00004e30: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00004e40: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
-00004e50: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00004e60: 2074 6f6b 656e 5f69 6e2e 6164 6472 6573   token_in.addres
-00004e70: 732c 0a20 2020 2020 2020 2020 2020 202d  s,.            -
-00004e80: 616d 6f75 6e74 5f69 6e2c 0a20 2020 2020  amount_in,.     
-00004e90: 2020 2029 0a0a 2020 2020 2020 2020 6c6f     )..        lo
-00004ea0: 6767 6572 2e64 6562 7567 2866 227b 7265  gger.debug(f"{re
-00004eb0: 6369 7069 656e 743d 7d22 290a 2020 2020  cipient=}").    
-00004ec0: 2020 2020 6d61 7463 6820 7265 6369 7069      match recipi
-00004ed0: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
-00004ee0: 2063 6173 6520 556e 6976 6572 7361 6c52   case UniversalR
-00004ef0: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
-00004f00: 6573 732e 4d53 475f 5345 4e44 4552 3a0a  ess.MSG_SENDER:.
-00004f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f20: 7265 6369 7069 656e 7420 3d20 7365 6c66  recipient = self
-00004f30: 2e73 656e 6465 720a 2020 2020 2020 2020  .sender.        
-00004f40: 2020 2020 6361 7365 2028 0a20 2020 2020      case (.     
-00004f50: 2020 2020 2020 2020 2020 2055 6e69 7665             Unive
-00004f60: 7273 616c 526f 7574 6572 5370 6563 6961  rsalRouterSpecia
-00004f70: 6c41 6464 7265 7373 2e52 4f55 5445 520a  lAddress.ROUTER.
-00004f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f90: 7c20 5633 526f 7574 6572 5370 6563 6961  | V3RouterSpecia
-00004fa0: 6c41 6464 7265 7373 2e52 4f55 5445 525f  lAddress.ROUTER_
-00004fb0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00004fc0: 2020 7c20 5633 526f 7574 6572 5370 6563    | V3RouterSpec
-00004fd0: 6961 6c41 6464 7265 7373 2e52 4f55 5445  ialAddress.ROUTE
-00004fe0: 525f 320a 2020 2020 2020 2020 2020 2020  R_2.            
-00004ff0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00005000: 2020 2072 6563 6970 6965 6e74 203d 2073     recipient = s
-00005010: 656c 662e 726f 7574 6572 5f61 6464 7265  elf.router_addre
-00005020: 7373 0a20 2020 2020 2020 2020 2020 2063  ss.            c
-00005030: 6173 6520 5f3a 0a20 2020 2020 2020 2020  ase _:.         
-00005040: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00005050: 2020 2020 2073 656c 662e 6c65 6467 6572       self.ledger
-00005060: 2e61 646a 7573 7428 0a20 2020 2020 2020  .adjust(.       
-00005070: 2020 2020 2072 6563 6970 6965 6e74 2c0a       recipient,.
-00005080: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-00005090: 6e5f 6f75 742e 6164 6472 6573 732c 0a20  n_out.address,. 
-000050a0: 2020 2020 2020 2020 2020 205f 616d 6f75             _amou
-000050b0: 6e74 5f6f 7574 2c0a 2020 2020 2020 2020  nt_out,.        
-000050c0: 290a 0a20 2020 2020 2020 2069 6620 616d  )..        if am
-000050d0: 6f75 6e74 5f6f 7574 5f6d 696e 2069 7320  ount_out_min is 
-000050e0: 6e6f 7420 4e6f 6e65 2061 6e64 205f 616d  not None and _am
-000050f0: 6f75 6e74 5f6f 7574 203c 2061 6d6f 756e  ount_out < amoun
-00005100: 745f 6f75 745f 6d69 6e3a 0a20 2020 2020  t_out_min:.     
-00005110: 2020 2020 2020 2072 6169 7365 2054 7261         raise Tra
-00005120: 6e73 6163 7469 6f6e 4572 726f 7228 0a20  nsactionError(. 
-00005130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00005140: 2249 6e73 7566 6669 6369 656e 7420 6f75  "Insufficient ou
-00005150: 7470 7574 2066 6f72 2073 7761 7021 207b  tput for swap! {
-00005160: 5f61 6d6f 756e 745f 6f75 747d 207b 746f  _amount_out} {to
-00005170: 6b65 6e5f 6f75 747d 2072 6563 6569 7665  ken_out} receive
-00005180: 642c 207b 616d 6f75 6e74 5f6f 7574 5f6d  d, {amount_out_m
-00005190: 696e 7d20 7265 7175 6972 6564 220a 2020  in} required".  
-000051a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000051b0: 2020 2020 2069 6620 6e6f 7420 7369 6c65       if not sile
-000051c0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-000051d0: 7365 6c66 2e5f 7368 6f77 5f70 6f6f 6c5f  self._show_pool_
-000051e0: 7374 6174 6573 285f 7369 6d5f 7265 7375  states(_sim_resu
-000051f0: 6c74 290a 0a20 2020 2020 2020 2072 6574  lt)..        ret
-00005200: 7572 6e20 706f 6f6c 2c20 5f73 696d 5f72  urn pool, _sim_r
-00005210: 6573 756c 740a 0a20 2020 2064 6566 205f  esult..    def _
-00005220: 7369 6d75 6c61 7465 5f76 335f 7377 6170  simulate_v3_swap
-00005230: 5f65 7861 6374 5f6f 7574 280a 2020 2020  _exact_out(.    
-00005240: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00005250: 2020 706f 6f6c 3a20 5633 4c69 7175 6964    pool: V3Liquid
-00005260: 6974 7950 6f6f 6c2c 0a20 2020 2020 2020  ityPool,.       
-00005270: 2072 6563 6970 6965 6e74 3a20 7374 722c   recipient: str,
-00005280: 0a20 2020 2020 2020 2074 6f6b 656e 5f69  .        token_i
-00005290: 6e3a 2045 7263 3230 546f 6b65 6e2c 0a20  n: Erc20Token,. 
-000052a0: 2020 2020 2020 2061 6d6f 756e 745f 6f75         amount_ou
-000052b0: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
-000052c0: 616d 6f75 6e74 5f69 6e5f 6d61 783a 2069  amount_in_max: i
-000052d0: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
-000052e0: 2c0a 2020 2020 2020 2020 7371 7274 5f70  ,.        sqrt_p
-000052f0: 7269 6365 5f6c 696d 6974 5f78 3936 3a20  rice_limit_x96: 
-00005300: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-00005310: 652c 0a20 2020 2020 2020 2066 6972 7374  e,.        first
-00005320: 5f73 7761 703a 2062 6f6f 6c20 3d20 4661  _swap: bool = Fa
-00005330: 6c73 652c 0a20 2020 2020 2020 206c 6173  lse,.        las
-00005340: 745f 7377 6170 3a20 626f 6f6c 203d 2046  t_swap: bool = F
-00005350: 616c 7365 2c0a 2020 2020 2920 2d3e 2054  alse,.    ) -> T
-00005360: 7570 6c65 5b56 334c 6971 7569 6469 7479  uple[V3Liquidity
-00005370: 506f 6f6c 2c20 556e 6973 7761 7056 3350  Pool, UniswapV3P
-00005380: 6f6f 6c53 696d 756c 6174 696f 6e52 6573  oolSimulationRes
-00005390: 756c 745d 3a0a 2020 2020 2020 2020 6173  ult]:.        as
-000053a0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-000053b0: 0a20 2020 2020 2020 2020 2020 2070 6f6f  .            poo
-000053c0: 6c2c 2056 334c 6971 7569 6469 7479 506f  l, V3LiquidityPo
-000053d0: 6f6c 0a20 2020 2020 2020 2029 2c20 6622  ol.        ), f"
-000053e0: 4361 6c6c 6564 205f 7369 6d75 6c61 7465  Called _simulate
-000053f0: 5f76 335f 7377 6170 5f65 7861 6374 5f6f  _v3_swap_exact_o
-00005400: 7574 206f 6e20 706f 6f6c 207b 706f 6f6c  ut on pool {pool
-00005410: 7d22 0a0a 2020 2020 2020 2020 7369 6c65  }"..        sile
-00005420: 6e74 203d 2073 656c 662e 7369 6c65 6e74  nt = self.silent
-00005430: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00005440: 6563 6970 6965 6e74 732e 6164 6428 746f  ecipients.add(to
-00005450: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
-00005460: 7328 7265 6369 7069 656e 7429 290a 0a20  s(recipient)).. 
-00005470: 2020 2020 2020 2069 6620 746f 6b65 6e5f         if token_
-00005480: 696e 206e 6f74 2069 6e20 706f 6f6c 2e74  in not in pool.t
-00005490: 6f6b 656e 733a 0a20 2020 2020 2020 2020  okens:.         
-000054a0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000054b0: 726f 7228 6622 546f 6b65 6e20 7b74 6f6b  ror(f"Token {tok
-000054c0: 656e 5f69 6e7d 206e 6f74 2066 6f75 6e64  en_in} not found
-000054d0: 2069 6e20 706f 6f6c 207b 706f 6f6c 7d22   in pool {pool}"
-000054e0: 290a 0a20 2020 2020 2020 2074 6f6b 656e  )..        token
-000054f0: 5f6f 7574 203d 2070 6f6f 6c2e 746f 6b65  _out = pool.toke
-00005500: 6e31 2069 6620 746f 6b65 6e5f 696e 203d  n1 if token_in =
-00005510: 3d20 706f 6f6c 2e74 6f6b 656e 3020 656c  = pool.token0 el
-00005520: 7365 2070 6f6f 6c2e 746f 6b65 6e30 0a0a  se pool.token0..
-00005530: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00005540: 2020 2020 2020 2020 205f 7369 6d5f 7265           _sim_re
-00005550: 7375 6c74 203d 2070 6f6f 6c2e 7369 6d75  sult = pool.simu
-00005560: 6c61 7465 5f73 7761 7028 0a20 2020 2020  late_swap(.     
-00005570: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-00005580: 5f6f 7574 3d74 6f6b 656e 5f6f 7574 2c0a  _out=token_out,.
-00005590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055a0: 746f 6b65 6e5f 6f75 745f 7175 616e 7469  token_out_quanti
-000055b0: 7479 3d61 6d6f 756e 745f 6f75 742c 0a20  ty=amount_out,. 
-000055c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000055d0: 7172 745f 7072 6963 655f 6c69 6d69 743d  qrt_price_limit=
-000055e0: 7371 7274 5f70 7269 6365 5f6c 696d 6974  sqrt_price_limit
-000055f0: 5f78 3936 2c0a 2020 2020 2020 2020 2020  _x96,.          
-00005600: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-00005610: 7074 2045 564d 5265 7665 7274 4572 726f  pt EVMRevertErro
-00005620: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-00005630: 2020 2020 7261 6973 6520 5472 616e 7361      raise Transa
-00005640: 6374 696f 6e45 7272 6f72 2866 2256 3320  ctionError(f"V3 
-00005650: 7265 7665 7274 3a20 7b65 7d22 290a 0a20  revert: {e}").. 
-00005660: 2020 2020 2020 205f 616d 6f75 6e74 5f69         _amount_i
-00005670: 6e20 3d20 6d61 7828 0a20 2020 2020 2020  n = max(.       
-00005680: 2020 2020 205f 7369 6d5f 7265 7375 6c74       _sim_result
-00005690: 2e61 6d6f 756e 7430 5f64 656c 7461 2c0a  .amount0_delta,.
-000056a0: 2020 2020 2020 2020 2020 2020 5f73 696d              _sim
-000056b0: 5f72 6573 756c 742e 616d 6f75 6e74 315f  _result.amount1_
-000056c0: 6465 6c74 612c 0a20 2020 2020 2020 2029  delta,.        )
-000056d0: 0a20 2020 2020 2020 205f 616d 6f75 6e74  .        _amount
-000056e0: 5f6f 7574 203d 202d 6d69 6e28 0a20 2020  _out = -min(.   
-000056f0: 2020 2020 2020 2020 205f 7369 6d5f 7265           _sim_re
-00005700: 7375 6c74 2e61 6d6f 756e 7430 5f64 656c  sult.amount0_del
-00005710: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00005720: 5f73 696d 5f72 6573 756c 742e 616d 6f75  _sim_result.amou
-00005730: 6e74 315f 6465 6c74 612c 0a20 2020 2020  nt1_delta,.     
-00005740: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00005750: 6164 6a75 7374 2074 6865 2070 6f73 742d  adjust the post-
-00005760: 7377 6170 2062 616c 616e 6365 7320 666f  swap balances fo
-00005770: 7220 6561 6368 2074 6f6b 656e 0a20 2020  r each token.   
-00005780: 2020 2020 2073 656c 662e 6c65 6467 6572       self.ledger
-00005790: 2e61 646a 7573 7428 0a20 2020 2020 2020  .adjust(.       
-000057a0: 2020 2020 2073 656c 662e 726f 7574 6572       self.router
-000057b0: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
-000057c0: 2020 2020 2020 746f 6b65 6e5f 696e 2c0a        token_in,.
-000057d0: 2020 2020 2020 2020 2020 2020 2d5f 616d              -_am
-000057e0: 6f75 6e74 5f69 6e2c 0a20 2020 2020 2020  ount_in,.       
-000057f0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00005800: 6c65 6467 6572 2e61 646a 7573 7428 0a20  ledger.adjust(. 
-00005810: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005820: 726f 7574 6572 5f61 6464 7265 7373 2c0a  router_address,.
-00005830: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
-00005840: 6e5f 6f75 742c 0a20 2020 2020 2020 2020  n_out,.         
-00005850: 2020 205f 616d 6f75 6e74 5f6f 7574 2c0a     _amount_out,.
-00005860: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005870: 2020 2069 6620 6669 7273 745f 7377 6170     if first_swap
-00005880: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00005890: 4578 6163 7420 6f75 7470 7574 2073 7761  Exact output swa
-000058a0: 7073 2070 726f 6365 6564 2069 6e20 7265  ps proceed in re
-000058b0: 7665 7273 6520 6f72 6465 722c 2073 6f20  verse order, so 
-000058c0: 7468 6520 6c61 7374 0a20 2020 2020 2020  the last.       
-000058d0: 2020 2020 2023 2069 7465 7261 7469 6f6e       # iteration
-000058e0: 2077 696c 6c20 7368 6f77 2061 206e 6567   will show a neg
-000058f0: 6174 6976 6520 6261 6c61 6e63 6520 6f66  ative balance of
-00005900: 2074 6865 2069 6e70 7574 2074 6f6b 656e   the input token
-00005910: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00005920: 7768 6963 6820 6d75 7374 2062 6520 6163  which must be ac
-00005930: 636f 756e 7465 6420 666f 722e 0a0a 2020  counted for...  
-00005940: 2020 2020 2020 2020 2020 726f 7574 6572            router
-00005950: 5f69 6e70 7574 5f74 6f6b 656e 5f62 616c  _input_token_bal
-00005960: 616e 6365 203d 2073 656c 662e 6c65 6467  ance = self.ledg
-00005970: 6572 2e74 6f6b 656e 5f62 616c 616e 6365  er.token_balance
-00005980: 2873 656c 662e 726f 7574 6572 5f61 6464  (self.router_add
-00005990: 7265 7373 2c20 746f 6b65 6e5f 696e 290a  ress, token_in).
-000059a0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-000059b0: 6865 636b 2066 6f72 2061 2062 616c 616e  heck for a balan
-000059c0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-000059d0: 2320 2020 2d20 4966 207a 6572 6f20 6f72  #   - If zero or
-000059e0: 2070 6f73 6974 6976 652c 2074 616b 6520   positive, take 
-000059f0: 6e6f 2061 6374 696f 6e0a 2020 2020 2020  no action.      
-00005a00: 2020 2020 2020 2320 2020 2d20 4966 206e        #   - If n
-00005a10: 6567 6174 6976 652c 2061 646a 7573 7420  egative, adjust 
-00005a20: 7769 7468 2074 6865 2061 7373 756d 7074  with the assumpt
-00005a30: 696f 6e20 7468 6520 7573 6572 2068 6173  ion the user has
-00005a40: 2070 6169 640a 2020 2020 2020 2020 2020   paid.          
-00005a50: 2020 2320 2020 2020 7468 6174 2061 6d6f    #     that amo
-00005a60: 756e 7420 7769 7468 2074 6865 2074 7261  unt with the tra
-00005a70: 6e73 6163 7469 6f6e 2063 616c 6c0a 2020  nsaction call.  
-00005a80: 2020 2020 2020 2020 2020 6966 2072 6f75            if rou
-00005a90: 7465 725f 696e 7075 745f 746f 6b65 6e5f  ter_input_token_
-00005aa0: 6261 6c61 6e63 6520 3c20 303a 0a20 2020  balance < 0:.   
-00005ab0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00005ac0: 662e 6c65 6467 6572 2e61 646a 7573 7428  f.ledger.adjust(
-00005ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005ae0: 2020 2020 2073 656c 662e 726f 7574 6572       self.router
-00005af0: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
-00005b00: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00005b10: 6b65 6e5f 696e 2c0a 2020 2020 2020 2020  ken_in,.        
-00005b20: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
-00005b30: 756e 745f 696e 2c0a 2020 2020 2020 2020  unt_in,.        
-00005b40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005b50: 2020 2020 2020 2069 6620 616d 6f75 6e74         if amount
-00005b60: 5f69 6e5f 6d61 7820 6973 206e 6f74 204e  _in_max is not N
-00005b70: 6f6e 6520 616e 6420 616d 6f75 6e74 5f69  one and amount_i
-00005b80: 6e5f 6d61 7820 3c20 5f61 6d6f 756e 745f  n_max < _amount_
-00005b90: 696e 3a0a 2020 2020 2020 2020 2020 2020  in:.            
-00005ba0: 2020 2020 7261 6973 6520 5472 616e 7361      raise Transa
-00005bb0: 6374 696f 6e45 7272 6f72 280a 2020 2020  ctionError(.    
-00005bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005bd0: 6622 496e 7375 6666 6963 6965 6e74 2069  f"Insufficient i
-00005be0: 6e70 7574 2066 6f72 2065 7861 6374 206f  nput for exact o
-00005bf0: 7574 7075 7420 7377 6170 2120 7b5f 616d  utput swap! {_am
-00005c00: 6f75 6e74 5f69 6e7d 207b 746f 6b65 6e5f  ount_in} {token_
-00005c10: 696e 7d20 7265 7175 6972 6564 2c20 7b61  in} required, {a
-00005c20: 6d6f 756e 745f 696e 5f6d 6178 7d20 7072  mount_in_max} pr
-00005c30: 6f76 6964 6564 220a 2020 2020 2020 2020  ovided".        
-00005c40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00005c50: 2020 2069 6620 6c61 7374 5f73 7761 703a     if last_swap:
-00005c60: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
-00005c70: 6368 2072 6563 6970 6965 6e74 3a0a 2020  ch recipient:.  
-00005c80: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00005c90: 7365 2055 6e69 7665 7273 616c 526f 7574  se UniversalRout
-00005ca0: 6572 5370 6563 6961 6c41 6464 7265 7373  erSpecialAddress
-00005cb0: 2e4d 5347 5f53 454e 4445 523a 0a20 2020  .MSG_SENDER:.   
-00005cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cd0: 205f 7265 6369 7069 656e 7420 3d20 7365   _recipient = se
-00005ce0: 6c66 2e73 656e 6465 720a 2020 2020 2020  lf.sender.      
-00005cf0: 2020 2020 2020 2020 2020 6361 7365 2028            case (
-00005d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005d10: 2020 2020 2055 6e69 7665 7273 616c 526f       UniversalRo
-00005d20: 7574 6572 5370 6563 6961 6c41 6464 7265  uterSpecialAddre
-00005d30: 7373 2e52 4f55 5445 520a 2020 2020 2020  ss.ROUTER.      
-00005d40: 2020 2020 2020 2020 2020 2020 2020 7c20                | 
-00005d50: 5633 526f 7574 6572 5370 6563 6961 6c41  V3RouterSpecialA
-00005d60: 6464 7265 7373 2e52 4f55 5445 525f 310a  ddress.ROUTER_1.
-00005d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d80: 2020 2020 7c20 5633 526f 7574 6572 5370      | V3RouterSp
-00005d90: 6563 6961 6c41 6464 7265 7373 2e52 4f55  ecialAddress.ROU
-00005da0: 5445 525f 320a 2020 2020 2020 2020 2020  TER_2.          
-00005db0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00005dc0: 2020 2020 2020 2020 2020 2020 205f 7265               _re
-00005dd0: 6369 7069 656e 7420 3d20 7365 6c66 2e72  cipient = self.r
-00005de0: 6f75 7465 725f 6164 6472 6573 730a 2020  outer_address.  
-00005df0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00005e00: 7365 205f 3a0a 2020 2020 2020 2020 2020  se _:.          
-00005e10: 2020 2020 2020 2020 2020 5f72 6563 6970            _recip
-00005e20: 6965 6e74 203d 2074 6f5f 6368 6563 6b73  ient = to_checks
-00005e30: 756d 5f61 6464 7265 7373 2872 6563 6970  um_address(recip
-00005e40: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
-00005e50: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00005e60: 6563 6970 6965 6e74 732e 6164 6428 5f72  ecipients.add(_r
-00005e70: 6563 6970 6965 6e74 290a 0a20 2020 2020  ecipient)..     
-00005e80: 2020 2020 2020 2073 656c 662e 6c65 6467         self.ledg
-00005e90: 6572 2e74 7261 6e73 6665 7228 0a20 2020  er.transfer(.   
-00005ea0: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-00005eb0: 656e 3d74 6f6b 656e 5f6f 7574 2e61 6464  en=token_out.add
-00005ec0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
-00005ed0: 2020 2020 2020 616d 6f75 6e74 3d5f 616d        amount=_am
-00005ee0: 6f75 6e74 5f6f 7574 2c0a 2020 2020 2020  ount_out,.      
-00005ef0: 2020 2020 2020 2020 2020 6672 6f6d 5f61            from_a
-00005f00: 6464 723d 7365 6c66 2e72 6f75 7465 725f  ddr=self.router_
-00005f10: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-00005f20: 2020 2020 2020 2020 2074 6f5f 6164 6472           to_addr
-00005f30: 3d5f 7265 6369 7069 656e 742c 0a20 2020  =_recipient,.   
-00005f40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00005f50: 2020 2020 6966 206e 6f74 2073 696c 656e      if not silen
-00005f60: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-00005f70: 656c 662e 5f73 686f 775f 706f 6f6c 5f73  elf._show_pool_s
-00005f80: 7461 7465 7328 5f73 696d 5f72 6573 756c  tates(_sim_resul
-00005f90: 7429 0a0a 2020 2020 2020 2020 7265 7475  t)..        retu
-00005fa0: 726e 2070 6f6f 6c2c 205f 7369 6d5f 7265  rn pool, _sim_re
-00005fb0: 7375 6c74 0a0a 2020 2020 6465 6620 5f73  sult..    def _s
-00005fc0: 696d 756c 6174 655f 756e 7772 6170 2873  imulate_unwrap(s
-00005fd0: 656c 662c 2077 7261 7070 6564 5f74 6f6b  elf, wrapped_tok
-00005fe0: 656e 3a20 7374 7229 202d 3e20 4e6f 6e65  en: str) -> None
-00005ff0: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
-00006000: 2e64 6562 7567 2866 2255 6e77 7261 7070  .debug(f"Unwrapp
-00006010: 696e 6720 7b77 7261 7070 6564 5f74 6f6b  ing {wrapped_tok
-00006020: 656e 7d22 290a 0a20 2020 2020 2020 2077  en}")..        w
-00006030: 7261 7070 6564 5f74 6f6b 656e 5f62 616c  rapped_token_bal
-00006040: 616e 6365 203d 2073 656c 662e 6c65 6467  ance = self.ledg
-00006050: 6572 2e74 6f6b 656e 5f62 616c 616e 6365  er.token_balance
-00006060: 2873 656c 662e 726f 7574 6572 5f61 6464  (self.router_add
-00006070: 7265 7373 2c20 7772 6170 7065 645f 746f  ress, wrapped_to
-00006080: 6b65 6e29 0a0a 2020 2020 2020 2020 7365  ken)..        se
-00006090: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
-000060a0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-000060b0: 6c66 2e72 6f75 7465 725f 6164 6472 6573  lf.router_addres
-000060c0: 732c 0a20 2020 2020 2020 2020 2020 2077  s,.            w
-000060d0: 7261 7070 6564 5f74 6f6b 656e 2c0a 2020  rapped_token,.  
-000060e0: 2020 2020 2020 2020 2020 2d77 7261 7070            -wrapp
-000060f0: 6564 5f74 6f6b 656e 5f62 616c 616e 6365  ed_token_balance
-00006100: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00006110: 2064 6566 205f 7369 6d75 6c61 7465 5f73   def _simulate_s
-00006120: 7765 6570 2873 656c 662c 2074 6f6b 656e  weep(self, token
-00006130: 3a20 7374 722c 2072 6563 6970 6965 6e74  : str, recipient
-00006140: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-00006150: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-00006160: 6562 7567 2866 2253 7765 6570 696e 6720  ebug(f"Sweeping 
-00006170: 7b74 6f6b 656e 7d20 746f 207b 7265 6369  {token} to {reci
-00006180: 7069 656e 747d 2229 0a0a 2020 2020 2020  pient}")..      
-00006190: 2020 746f 6b65 6e5f 6261 6c61 6e63 6520    token_balance 
-000061a0: 3d20 7365 6c66 2e6c 6564 6765 722e 746f  = self.ledger.to
-000061b0: 6b65 6e5f 6261 6c61 6e63 6528 7365 6c66  ken_balance(self
-000061c0: 2e72 6f75 7465 725f 6164 6472 6573 732c  .router_address,
-000061d0: 2074 6f6b 656e 290a 2020 2020 2020 2020   token).        
-000061e0: 7365 6c66 2e6c 6564 6765 722e 6164 6a75  self.ledger.adju
-000061f0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00006200: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
-00006210: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00006220: 2074 6f6b 656e 2c0a 2020 2020 2020 2020   token,.        
-00006230: 2020 2020 2d74 6f6b 656e 5f62 616c 616e      -token_balan
-00006240: 6365 2c0a 2020 2020 2020 2020 290a 2020  ce,.        ).  
-00006250: 2020 2020 2020 7365 6c66 2e6c 6564 6765        self.ledge
-00006260: 722e 6164 6a75 7374 280a 2020 2020 2020  r.adjust(.      
-00006270: 2020 2020 2020 7265 6369 7069 656e 742c        recipient,
-00006280: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
-00006290: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
-000062a0: 746f 6b65 6e5f 6261 6c61 6e63 652c 0a20  token_balance,. 
-000062b0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000062c0: 6620 5f73 696d 756c 6174 6528 0a20 2020  f _simulate(.   
-000062d0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000062e0: 2020 2066 756e 635f 6e61 6d65 3a20 7374     func_name: st
-000062f0: 722c 0a20 2020 2020 2020 2066 756e 635f  r,.        func_
-00006300: 7061 7261 6d73 3a20 4469 6374 5b73 7472  params: Dict[str
-00006310: 2c20 416e 795d 2c0a 2020 2020 2920 2d3e  , Any],.    ) ->
-00006320: 204c 6973 745b 0a20 2020 2020 2020 2054   List[.        T
-00006330: 7570 6c65 5b4c 6971 7569 6469 7479 506f  uple[LiquidityPo
-00006340: 6f6c 2c20 556e 6973 7761 7056 3250 6f6f  ol, UniswapV2Poo
-00006350: 6c53 696d 756c 6174 696f 6e52 6573 756c  lSimulationResul
-00006360: 745d 0a20 2020 2020 2020 207c 2054 7570  t].        | Tup
-00006370: 6c65 5b56 334c 6971 7569 6469 7479 506f  le[V3LiquidityPo
-00006380: 6f6c 2c20 556e 6973 7761 7056 3350 6f6f  ol, UniswapV3Poo
-00006390: 6c53 696d 756c 6174 696f 6e52 6573 756c  lSimulationResul
-000063a0: 745d 0a20 2020 205d 3a0a 2020 2020 2020  t].    ]:.      
-000063b0: 2020 2222 220a 2020 2020 2020 2020 5461    """.        Ta
-000063c0: 6b65 2061 2055 6e69 7377 6170 2056 3220  ke a Uniswap V2 
-000063d0: 2f20 5633 2074 7261 6e73 6163 7469 6f6e  / V3 transaction
-000063e0: 2028 7370 6563 6966 6965 6420 6279 206e   (specified by n
-000063f0: 616d 6520 616e 6420 6120 6469 6374 696f  ame and a dictio
-00006400: 6e61 7279 0a20 2020 2020 2020 206f 6620  nary.        of 
-00006410: 6172 6775 6d65 6e74 7320 746f 2074 6861  arguments to tha
-00006420: 7420 6675 6e63 7469 6f6e 2920 616e 6420  t function) and 
-00006430: 7265 7475 726e 2061 206c 6973 7420 6f66  return a list of
-00006440: 2070 6f6f 6c73 2061 6e64 2073 7461 7465   pools and state
-00006450: 0a20 2020 2020 2020 2064 6963 7469 6f6e  .        diction
-00006460: 6172 6965 7320 666f 7220 616c 6c20 706f  aries for all po
-00006470: 6f6c 7320 7573 6564 2062 7920 7468 6520  ols used by the 
-00006480: 7472 616e 7361 6374 696f 6e0a 2020 2020  transaction.    
-00006490: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-000064a0: 2061 6c6c 5f66 7574 7572 655f 706f 6f6c   all_future_pool
-000064b0: 5f73 7461 7465 733a 204c 6973 745b 0a20  _states: List[. 
-000064c0: 2020 2020 2020 2020 2020 2054 7570 6c65             Tuple
-000064d0: 5b4c 6971 7569 6469 7479 506f 6f6c 2c20  [LiquidityPool, 
-000064e0: 556e 6973 7761 7056 3250 6f6f 6c53 696d  UniswapV2PoolSim
-000064f0: 756c 6174 696f 6e52 6573 756c 745d 0a20  ulationResult]. 
-00006500: 2020 2020 2020 2020 2020 207c 2054 7570             | Tup
-00006510: 6c65 5b56 334c 6971 7569 6469 7479 506f  le[V3LiquidityPo
-00006520: 6f6c 2c20 556e 6973 7761 7056 3350 6f6f  ol, UniswapV3Poo
-00006530: 6c53 696d 756c 6174 696f 6e52 6573 756c  lSimulationResul
-00006540: 745d 0a20 2020 2020 2020 205d 203d 205b  t].        ] = [
-00006550: 5d0a 0a20 2020 2020 2020 2056 325f 4655  ]..        V2_FU
-00006560: 4e43 5449 4f4e 5320 3d20 7b0a 2020 2020  NCTIONS = {.    
-00006570: 2020 2020 2020 2020 2261 6464 4c69 7175          "addLiqu
-00006580: 6964 6974 7922 2c0a 2020 2020 2020 2020  idity",.        
-00006590: 2020 2020 2261 6464 4c69 7175 6964 6974      "addLiquidit
-000065a0: 7945 5448 222c 0a20 2020 2020 2020 2020  yETH",.         
-000065b0: 2020 2022 7377 6170 4578 6163 7454 6f6b     "swapExactTok
-000065c0: 656e 7346 6f72 4554 4822 2c0a 2020 2020  ensForETH",.    
-000065d0: 2020 2020 2020 2020 2273 7761 7045 7861          "swapExa
-000065e0: 6374 546f 6b65 6e73 466f 7245 5448 5375  ctTokensForETHSu
-000065f0: 7070 6f72 7469 6e67 4665 654f 6e54 7261  pportingFeeOnTra
-00006600: 6e73 6665 7254 6f6b 656e 7322 2c0a 2020  nsferTokens",.  
-00006610: 2020 2020 2020 2020 2020 2273 7761 7045            "swapE
-00006620: 7861 6374 4554 4846 6f72 546f 6b65 6e73  xactETHForTokens
-00006630: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00006640: 7377 6170 4578 6163 7445 5448 466f 7254  swapExactETHForT
-00006650: 6f6b 656e 7353 7570 706f 7274 696e 6746  okensSupportingF
-00006660: 6565 4f6e 5472 616e 7366 6572 546f 6b65  eeOnTransferToke
-00006670: 6e73 222c 0a20 2020 2020 2020 2020 2020  ns",.           
-00006680: 2022 7377 6170 4578 6163 7454 6f6b 656e   "swapExactToken
-00006690: 7346 6f72 546f 6b65 6e73 222c 0a20 2020  sForTokens",.   
-000066a0: 2020 2020 2020 2020 2022 7377 6170 4578           "swapEx
-000066b0: 6163 7454 6f6b 656e 7346 6f72 546f 6b65  actTokensForToke
-000066c0: 6e73 5375 7070 6f72 7469 6e67 4665 654f  nsSupportingFeeO
-000066d0: 6e54 7261 6e73 6665 7254 6f6b 656e 7322  nTransferTokens"
-000066e0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-000066f0: 7761 7054 6f6b 656e 7346 6f72 4578 6163  wapTokensForExac
-00006700: 7445 5448 222c 0a20 2020 2020 2020 2020  tETH",.         
-00006710: 2020 2022 7377 6170 546f 6b65 6e73 466f     "swapTokensFo
-00006720: 7245 7861 6374 546f 6b65 6e73 222c 0a20  rExactTokens",. 
-00006730: 2020 2020 2020 2020 2020 2022 7377 6170             "swap
-00006740: 4554 4846 6f72 4578 6163 7454 6f6b 656e  ETHForExactToken
-00006750: 7322 2c0a 2020 2020 2020 2020 7d0a 0a20  s",.        }.. 
-00006760: 2020 2020 2020 2056 335f 4655 4e43 5449         V3_FUNCTI
-00006770: 4f4e 5320 3d20 7b0a 2020 2020 2020 2020  ONS = {.        
-00006780: 2020 2020 2265 7861 6374 496e 7075 7453      "exactInputS
-00006790: 696e 676c 6522 2c0a 2020 2020 2020 2020  ingle",.        
-000067a0: 2020 2020 2265 7861 6374 496e 7075 7422      "exactInput"
-000067b0: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
-000067c0: 7861 6374 4f75 7470 7574 5369 6e67 6c65  xactOutputSingle
-000067d0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-000067e0: 6578 6163 744f 7574 7075 7422 2c0a 2020  exactOutput",.  
-000067f0: 2020 2020 2020 2020 2020 226d 756c 7469            "multi
-00006800: 6361 6c6c 222c 0a20 2020 2020 2020 2020  call",.         
-00006810: 2020 2022 7377 6565 7054 6f6b 656e 222c     "sweepToken",
-00006820: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
-00006830: 7772 6170 5745 5448 3922 2c0a 2020 2020  wrapWETH9",.    
-00006840: 2020 2020 2020 2020 2275 6e77 7261 7057          "unwrapW
-00006850: 4554 4839 5769 7468 4665 6522 2c0a 2020  ETH9WithFee",.  
-00006860: 2020 2020 2020 2020 2020 2277 7261 7045            "wrapE
-00006870: 5448 222c 0a20 2020 2020 2020 207d 0a0a  TH",.        }..
-00006880: 2020 2020 2020 2020 554e 4956 4552 5341          UNIVERSA
-00006890: 4c5f 524f 5554 4552 5f46 554e 4354 494f  L_ROUTER_FUNCTIO
-000068a0: 4e53 203d 207b 0a20 2020 2020 2020 2020  NS = {.         
-000068b0: 2020 2022 6578 6563 7574 6522 2c0a 2020     "execute",.  
-000068c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000068d0: 2023 2054 4f44 4f3a 2068 616e 646c 6520   # TODO: handle 
-000068e0: 7468 6573 650a 2020 2020 2020 2020 554e  these.        UN
-000068f0: 4841 4e44 4c45 445f 4655 4e43 5449 4f4e  HANDLED_FUNCTION
-00006900: 5320 3d20 7b0a 2020 2020 2020 2020 2020  S = {.          
-00006910: 2020 2272 656d 6f76 654c 6971 7569 6469    "removeLiquidi
-00006920: 7479 222c 0a20 2020 2020 2020 2020 2020  ty",.           
-00006930: 2022 7265 6d6f 7665 4c69 7175 6964 6974   "removeLiquidit
-00006940: 7945 5448 222c 0a20 2020 2020 2020 2020  yETH",.         
-00006950: 2020 2022 7265 6d6f 7665 4c69 7175 6964     "removeLiquid
-00006960: 6974 7945 5448 5769 7468 5065 726d 6974  ityETHWithPermit
-00006970: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00006980: 7265 6d6f 7665 4c69 7175 6964 6974 7945  removeLiquidityE
-00006990: 5448 5375 7070 6f72 7469 6e67 4665 654f  THSupportingFeeO
-000069a0: 6e54 7261 6e73 6665 7254 6f6b 656e 7322  nTransferTokens"
-000069b0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-000069c0: 656d 6f76 654c 6971 7569 6469 7479 4554  emoveLiquidityET
-000069d0: 4857 6974 6850 6572 6d69 7453 7570 706f  HWithPermitSuppo
-000069e0: 7274 696e 6746 6565 4f6e 5472 616e 7366  rtingFeeOnTransf
-000069f0: 6572 546f 6b65 6e73 222c 0a20 2020 2020  erTokens",.     
-00006a00: 2020 2020 2020 2022 7265 6d6f 7665 4c69         "removeLi
-00006a10: 7175 6964 6974 7957 6974 6850 6572 6d69  quidityWithPermi
-00006a20: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00006a30: 2273 7765 6570 546f 6b65 6e57 6974 6846  "sweepTokenWithF
-00006a40: 6565 222c 0a20 2020 2020 2020 2020 2020  ee",.           
-00006a50: 2023 2056 3320 6d75 6c74 6963 616c 6c20   # V3 multicall 
-00006a60: 6675 6e63 7469 6f6e 730a 2020 2020 2020  functions.      
-00006a70: 2020 2020 2020 2320 7265 663a 2068 7474        # ref: htt
-00006a80: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00006a90: 556e 6973 7761 702f 7377 6170 2d72 6f75  Uniswap/swap-rou
-00006aa0: 7465 722d 636f 6e74 7261 6374 732f 626c  ter-contracts/bl
-00006ab0: 6f62 2f6d 6169 6e2f 636f 6e74 7261 6374  ob/main/contract
-00006ac0: 732f 6261 7365 2f41 7070 726f 7665 416e  s/base/ApproveAn
-00006ad0: 6443 616c 6c2e 736f 6c0a 2020 2020 2020  dCall.sol.      
-00006ae0: 2020 2020 2020 226d 696e 7422 2c0a 2020        "mint",.  
-00006af0: 2020 2020 2020 2020 2020 2269 6e63 7265            "incre
-00006b00: 6173 654c 6971 7569 6469 7479 222c 0a20  aseLiquidity",. 
-00006b10: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00006b20: 2020 2320 4675 6e63 7469 6f6e 7320 7468    # Functions th
-00006b30: 6174 2064 6f20 6e6f 7420 6166 6665 6374  at do not affect
-00006b40: 2074 6865 2070 6f6f 6c20 7374 6174 652e   the pool state.
-00006b50: 0a20 2020 2020 2020 2023 2054 7970 6963  .        # Typic
-00006b60: 616c 6c79 2072 656c 6174 6564 2074 6f20  ally related to 
-00006b70: 616c 6c6f 7761 6e63 6573 2e0a 2020 2020  allowances..    
-00006b80: 2020 2020 4e4f 5f4f 505f 4655 4e43 5449      NO_OP_FUNCTI
-00006b90: 4f4e 5320 3d20 7b0a 2020 2020 2020 2020  ONS = {.        
-00006ba0: 2020 2020 2320 2d2d 2d0a 2020 2020 2020      # ---.      
-00006bb0: 2020 2020 2020 2320 7265 663a 2068 7474        # ref: htt
-00006bc0: 7073 3a2f 2f64 6f63 732e 756e 6973 7761  ps://docs.uniswa
-00006bd0: 702e 6f72 672f 636f 6e74 7261 6374 732f  p.org/contracts/
-00006be0: 7633 2f72 6566 6572 656e 6365 2f70 6572  v3/reference/per
-00006bf0: 6970 6865 7279 2f69 6e74 6572 6661 6365  iphery/interface
-00006c00: 732f 4950 6572 6970 6865 7279 5061 796d  s/IPeripheryPaym
-00006c10: 656e 7473 2372 6566 756e 6465 7468 0a20  ents#refundeth. 
-00006c20: 2020 2020 2020 2020 2020 2022 7265 6675             "refu
-00006c30: 6e64 4554 4822 2c0a 2020 2020 2020 2020  ndETH",.        
-00006c40: 2020 2020 2320 2d2d 2d0a 2020 2020 2020      # ---.      
-00006c50: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-00006c60: 2020 2020 2320 4549 502d 3236 3132 2074      # EIP-2612 t
-00006c70: 6f6b 656e 2070 6572 6d69 7420 6675 6e63  oken permit func
-00006c80: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-00006c90: 2020 2320 7265 663a 2068 7474 7073 3a2f    # ref: https:/
-00006ca0: 2f64 6f63 732e 756e 6973 7761 702e 6f72  /docs.uniswap.or
-00006cb0: 672f 636f 6e74 7261 6374 732f 7633 2f72  g/contracts/v3/r
-00006cc0: 6566 6572 656e 6365 2f70 6572 6970 6865  eference/periphe
-00006cd0: 7279 2f62 6173 652f 5365 6c66 5065 726d  ry/base/SelfPerm
-00006ce0: 6974 0a20 2020 2020 2020 2020 2020 2022  it.            "
-00006cf0: 7365 6c66 5065 726d 6974 222c 0a20 2020  selfPermit",.   
-00006d00: 2020 2020 2020 2020 2022 7365 6c66 5065           "selfPe
-00006d10: 726d 6974 416c 6c6f 7765 6422 2c0a 2020  rmitAllowed",.  
-00006d20: 2020 2020 2020 2020 2020 2273 656c 6650            "selfP
-00006d30: 6572 6d69 7441 6c6c 6f77 6564 4966 4e65  ermitAllowedIfNe
-00006d40: 6365 7373 6172 7922 2c0a 2020 2020 2020  cessary",.      
-00006d50: 2020 2020 2020 2273 656c 6650 6572 6d69        "selfPermi
-00006d60: 7449 664e 6563 6573 7361 7279 222c 0a20  tIfNecessary",. 
-00006d70: 2020 2020 2020 2020 2020 2023 202d 2d2d             # ---
-00006d80: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-00006d90: 6566 3a20 6874 7470 733a 2f2f 6769 7468  ef: https://gith
-00006da0: 7562 2e63 6f6d 2f55 6e69 7377 6170 2f73  ub.com/Uniswap/s
-00006db0: 7761 702d 726f 7574 6572 2d63 6f6e 7472  wap-router-contr
-00006dc0: 6163 7473 2f62 6c6f 622f 6d61 696e 2f63  acts/blob/main/c
-00006dd0: 6f6e 7472 6163 7473 2f62 6173 652f 5065  ontracts/base/Pe
-00006de0: 7269 7068 6572 7950 6179 6d65 6e74 7345  ripheryPaymentsE
-00006df0: 7874 656e 6465 642e 736f 6c0a 2020 2020  xtended.sol.    
-00006e00: 2020 2020 2020 2020 2270 756c 6c22 2c0a          "pull",.
-00006e10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00006e20: 2020 2064 6566 205f 7072 6f63 6573 735f     def _process_
-00006e30: 756e 6976 6572 7361 6c5f 726f 7574 6572  universal_router
-00006e40: 5f63 6f6d 6d61 6e64 280a 2020 2020 2020  _command(.      
-00006e50: 2020 2020 2020 636f 6d6d 616e 645f 7479        command_ty
-00006e60: 7065 3a20 696e 742c 0a20 2020 2020 2020  pe: int,.       
-00006e70: 2020 2020 2069 6e70 7574 733a 2062 7974       inputs: byt
-00006e80: 6573 2c0a 2020 2020 2020 2020 2920 2d3e  es,.        ) ->
-00006e90: 2028 0a20 2020 2020 2020 2020 2020 204c   (.            L
-00006ea0: 6973 745b 0a20 2020 2020 2020 2020 2020  ist[.           
-00006eb0: 2020 2020 2054 7570 6c65 5b4c 6971 7569       Tuple[Liqui
-00006ec0: 6469 7479 506f 6f6c 2c20 556e 6973 7761  dityPool, Uniswa
-00006ed0: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
-00006ee0: 6e52 6573 756c 745d 0a20 2020 2020 2020  nResult].       
-00006ef0: 2020 2020 2020 2020 207c 2054 7570 6c65           | Tuple
-00006f00: 5b56 334c 6971 7569 6469 7479 506f 6f6c  [V3LiquidityPool
-00006f10: 2c20 556e 6973 7761 7056 3350 6f6f 6c53  , UniswapV3PoolS
-00006f20: 696d 756c 6174 696f 6e52 6573 756c 745d  imulationResult]
-00006f30: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-00006f40: 2020 2020 2020 2020 2020 207c 204e 6f6e             | Non
-00006f50: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
-00006f60: 2020 2020 2020 2020 2023 2072 6566 3a20           # ref: 
-00006f70: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-00006f80: 6f6d 2f55 6e69 7377 6170 2f75 6e69 7665  om/Uniswap/unive
-00006f90: 7273 616c 2d72 6f75 7465 722f 626c 6f62  rsal-router/blob
-00006fa0: 2f6d 6169 6e2f 636f 6e74 7261 6374 732f  /main/contracts/
-00006fb0: 6c69 6272 6172 6965 732f 436f 6d6d 616e  libraries/Comman
-00006fc0: 6473 2e73 6f6c 0a20 2020 2020 2020 2020  ds.sol.         
-00006fd0: 2020 2055 4e49 5645 5253 414c 5f52 4f55     UNIVERSAL_ROU
-00006fe0: 5445 525f 434f 4d4d 414e 445f 5641 4c55  TER_COMMAND_VALU
-00006ff0: 4553 3a20 4469 6374 5b69 6e74 2c20 7374  ES: Dict[int, st
-00007000: 7220 7c20 4e6f 6e65 5d20 3d20 7b0a 2020  r | None] = {.  
-00007010: 2020 2020 2020 2020 2020 2020 2020 3078                0x
-00007020: 3030 3a20 2256 335f 5357 4150 5f45 5841  00: "V3_SWAP_EXA
-00007030: 4354 5f49 4e22 2c0a 2020 2020 2020 2020  CT_IN",.        
-00007040: 2020 2020 2020 2020 3078 3031 3a20 2256          0x01: "V
-00007050: 335f 5357 4150 5f45 5841 4354 5f4f 5554  3_SWAP_EXACT_OUT
-00007060: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00007070: 2020 2030 7830 323a 2022 5045 524d 4954     0x02: "PERMIT
-00007080: 325f 5452 414e 5346 4552 5f46 524f 4d22  2_TRANSFER_FROM"
-00007090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000070a0: 2020 3078 3033 3a20 2250 4552 4d49 5432    0x03: "PERMIT2
-000070b0: 5f50 4552 4d49 545f 4241 5443 4822 2c0a  _PERMIT_BATCH",.
-000070c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070d0: 3078 3034 3a20 2253 5745 4550 222c 0a20  0x04: "SWEEP",. 
-000070e0: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-000070f0: 7830 353a 2022 5452 414e 5346 4552 222c  x05: "TRANSFER",
-00007100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007110: 2030 7830 363a 2022 5041 595f 504f 5254   0x06: "PAY_PORT
-00007120: 494f 4e22 2c0a 2020 2020 2020 2020 2020  ION",.          
-00007130: 2020 2020 2020 3078 3037 3a20 4e6f 6e65        0x07: None
-00007140: 2c20 2023 2043 4f4d 4d41 4e44 5f50 4c41  ,  # COMMAND_PLA
-00007150: 4345 484f 4c44 4552 0a20 2020 2020 2020  CEHOLDER.       
-00007160: 2020 2020 2020 2020 2030 7830 383a 2022           0x08: "
-00007170: 5632 5f53 5741 505f 4558 4143 545f 494e  V2_SWAP_EXACT_IN
-00007180: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00007190: 2020 2030 7830 393a 2022 5632 5f53 5741     0x09: "V2_SWA
-000071a0: 505f 4558 4143 545f 4f55 5422 2c0a 2020  P_EXACT_OUT",.  
-000071b0: 2020 2020 2020 2020 2020 2020 2020 3078                0x
-000071c0: 3041 3a20 2250 4552 4d49 5432 5f50 4552  0A: "PERMIT2_PER
-000071d0: 4d49 5422 2c0a 2020 2020 2020 2020 2020  MIT",.          
-000071e0: 2020 2020 2020 3078 3042 3a20 2257 5241        0x0B: "WRA
-000071f0: 505f 4554 4822 2c0a 2020 2020 2020 2020  P_ETH",.        
-00007200: 2020 2020 2020 2020 3078 3043 3a20 2255          0x0C: "U
-00007210: 4e57 5241 505f 5745 5448 222c 0a20 2020  NWRAP_WETH",.   
-00007220: 2020 2020 2020 2020 2020 2020 2030 7830               0x0
-00007230: 443a 2022 5045 524d 4954 325f 5452 414e  D: "PERMIT2_TRAN
-00007240: 5346 4552 5f46 524f 4d5f 4241 5443 4822  SFER_FROM_BATCH"
-00007250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007260: 2020 3078 3045 3a20 2242 414c 414e 4345    0x0E: "BALANCE
-00007270: 5f43 4845 434b 5f45 5243 3230 222c 0a20  _CHECK_ERC20",. 
-00007280: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00007290: 7830 463a 204e 6f6e 652c 2020 2320 434f  x0F: None,  # CO
-000072a0: 4d4d 414e 445f 504c 4143 4548 4f4c 4445  MMAND_PLACEHOLDE
-000072b0: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
-000072c0: 2020 3078 3130 3a20 2253 4541 504f 5254    0x10: "SEAPORT
-000072d0: 5f56 315f 3522 2c0a 2020 2020 2020 2020  _V1_5",.        
-000072e0: 2020 2020 2020 2020 3078 3131 3a20 224c          0x11: "L
-000072f0: 4f4f 4b53 5f52 4152 455f 5632 222c 0a20  OOKS_RARE_V2",. 
-00007300: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00007310: 7831 323a 2022 4e46 5458 222c 0a20 2020  x12: "NFTX",.   
-00007320: 2020 2020 2020 2020 2020 2020 2030 7831               0x1
-00007330: 333a 2022 4352 5950 544f 5055 4e4b 5322  3: "CRYPTOPUNKS"
-00007340: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007350: 2020 3078 3134 3a20 224c 4f4f 4b53 5f52    0x14: "LOOKS_R
-00007360: 4152 455f 3131 3535 222c 2020 2320 6472  ARE_1155",  # dr
-00007370: 6f70 7065 6420 696e 2056 315f 330a 2020  opped in V1_3.  
-00007380: 2020 2020 2020 2020 2020 2020 2020 3078                0x
-00007390: 3135 3a20 224f 574e 4552 5f43 4845 434b  15: "OWNER_CHECK
-000073a0: 5f37 3231 222c 0a20 2020 2020 2020 2020  _721",.         
-000073b0: 2020 2020 2020 2030 7831 363a 2022 4f57         0x16: "OW
-000073c0: 4e45 525f 4348 4543 4b5f 3131 3535 222c  NER_CHECK_1155",
-000073d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000073e0: 2030 7831 373a 2022 5357 4545 505f 4552   0x17: "SWEEP_ER
-000073f0: 4337 3231 222c 0a20 2020 2020 2020 2020  C721",.         
-00007400: 2020 2020 2020 2030 7831 383a 2022 5832         0x18: "X2
-00007410: 5932 5f37 3231 222c 0a20 2020 2020 2020  Y2_721",.       
-00007420: 2020 2020 2020 2020 2030 7831 393a 2022           0x19: "
-00007430: 5355 444f 5357 4150 222c 0a20 2020 2020  SUDOSWAP",.     
-00007440: 2020 2020 2020 2020 2020 2030 7831 413a             0x1A:
-00007450: 2022 4e46 5432 3022 2c0a 2020 2020 2020   "NFT20",.      
-00007460: 2020 2020 2020 2020 2020 3078 3142 3a20            0x1B: 
-00007470: 2258 3259 325f 3131 3535 222c 0a20 2020  "X2Y2_1155",.   
-00007480: 2020 2020 2020 2020 2020 2020 2030 7831               0x1
-00007490: 433a 2022 464f 554e 4441 5449 4f4e 222c  C: "FOUNDATION",
-000074a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000074b0: 2030 7831 443a 2022 5357 4545 505f 4552   0x1D: "SWEEP_ER
-000074c0: 4331 3135 3522 2c0a 2020 2020 2020 2020  C1155",.        
-000074d0: 2020 2020 2020 2020 3078 3145 3a20 2245          0x1E: "E
-000074e0: 4c45 4d45 4e54 5f4d 4152 4b45 5422 2c0a  LEMENT_MARKET",.
+000014d0: 3030 3030 3030 3031 2229 0a20 2020 2052  00000001").    R
+000014e0: 4f55 5445 525f 3220 3d20 746f 5f63 6865  OUTER_2 = to_che
+000014f0: 636b 7375 6d5f 6164 6472 6573 7328 2230  cksum_address("0
+00001500: 7830 3030 3030 3030 3030 3030 3030 3030  x000000000000000
+00001510: 3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+00001520: 3030 3030 3030 3030 3222 290a 0a0a 636c  000000002")...cl
+00001530: 6173 7320 5633 526f 7574 6572 5370 6563  ass V3RouterSpec
+00001540: 6961 6c56 616c 7565 733a 0a20 2020 2023  ialValues:.    #
+00001550: 2072 6566 3a20 6874 7470 733a 2f2f 6769   ref: https://gi
+00001560: 7468 7562 2e63 6f6d 2f55 6e69 7377 6170  thub.com/Uniswap
+00001570: 2f73 7761 702d 726f 7574 6572 2d63 6f6e  /swap-router-con
+00001580: 7472 6163 7473 2f62 6c6f 622f 6d61 696e  tracts/blob/main
+00001590: 2f63 6f6e 7472 6163 7473 2f6c 6962 7261  /contracts/libra
+000015a0: 7269 6573 2f43 6f6e 7374 616e 7473 2e73  ries/Constants.s
+000015b0: 6f6c 0a20 2020 2055 5345 5f43 4f4e 5452  ol.    USE_CONTR
+000015c0: 4143 545f 4241 4c41 4e43 4520 3d20 300a  ACT_BALANCE = 0.
+000015d0: 0a0a 636c 6173 7320 556e 6973 7761 7054  ..class UniswapT
+000015e0: 7261 6e73 6163 7469 6f6e 2842 6173 6554  ransaction(BaseT
+000015f0: 7261 6e73 6163 7469 6f6e 293a 0a20 2020  ransaction):.   
+00001600: 2063 6c61 7373 204c 6566 746f 7665 7252   class LeftoverR
+00001610: 6f75 7465 7242 616c 616e 6365 284c 6564  outerBalance(Led
+00001620: 6765 7245 7272 6f72 293a 0a20 2020 2020  gerError):.     
+00001630: 2020 2070 6173 730a 0a20 2020 2040 636c     pass..    @cl
+00001640: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+00001650: 6620 6164 645f 6368 6169 6e28 636c 732c  f add_chain(cls,
+00001660: 2063 6861 696e 5f69 643a 2069 6e74 2920   chain_id: int) 
+00001670: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00001680: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00001690: 2020 5f52 4f55 5445 5253 5b63 6861 696e    _ROUTERS[chain
+000016a0: 5f69 645d 0a20 2020 2020 2020 2065 7863  _id].        exc
+000016b0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+000016c0: 2020 2020 2020 2020 2020 205f 524f 5554             _ROUT
+000016d0: 4552 535b 6368 6169 6e5f 6964 5d20 3d20  ERS[chain_id] = 
+000016e0: 7b7d 0a0a 2020 2020 4063 6c61 7373 6d65  {}..    @classme
+000016f0: 7468 6f64 0a20 2020 2064 6566 2061 6464  thod.    def add
+00001700: 5f72 6f75 7465 7228 636c 732c 2063 6861  _router(cls, cha
+00001710: 696e 5f69 643a 2069 6e74 2c20 726f 7574  in_id: int, rout
+00001720: 6572 5f61 6464 7265 7373 3a20 7374 722c  er_address: str,
+00001730: 2072 6f75 7465 725f 6469 6374 3a20 4469   router_dict: Di
+00001740: 6374 5b41 6e79 2c20 416e 795d 2920 2d3e  ct[Any, Any]) ->
+00001750: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00001760: 2222 0a20 2020 2020 2020 2041 6464 2061  "".        Add a
+00001770: 206e 6577 2072 6f75 7465 7220 6164 6472   new router addr
+00001780: 6573 7320 666f 7220 6120 6769 7665 6e20  ess for a given 
+00001790: 6368 6169 6e20 4944 2e0a 0a20 2020 2020  chain ID...     
+000017a0: 2020 2054 6865 2060 726f 7574 6572 5f64     The `router_d
+000017b0: 6963 7460 2061 7267 756d 656e 7420 7368  ict` argument sh
+000017c0: 6f75 6c64 2063 6f6e 7461 696e 2061 7420  ould contain at 
+000017d0: 6d69 6e69 6d75 6d20 7468 6520 666f 6c6c  minimum the foll
+000017e0: 6f77 696e 6720 6b65 792d 7661 6c75 6520  owing key-value 
+000017f0: 7061 6972 733a 0a20 2020 2020 2020 2020  pairs:.         
+00001800: 2020 202d 2027 6e61 6d65 273a 205b 7374     - 'name': [st
+00001810: 725d 0a20 2020 2020 2020 2020 2020 202d  r].            -
+00001820: 2027 6661 6374 6f72 795f 6164 6472 6573   'factory_addres
+00001830: 7327 3a20 7b0a 2020 2020 2020 2020 2020  s': {.          
+00001840: 2020 2020 2020 5b69 6e74 5d3a 205b 6164        [int]: [ad
+00001850: 6472 6573 735d 2c0a 2020 2020 2020 2020  dress],.        
+00001860: 2020 2020 2020 2020 5b69 6e74 5d3a 205b          [int]: [
+00001870: 6164 6472 6573 735d 2c0a 2020 2020 2020  address],.      
+00001880: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00001890: 2020 2020 2054 6865 2064 6963 7473 2069       The dicts i
+000018a0: 6e73 6964 6520 2766 6163 746f 7279 5f61  nside 'factory_a
+000018b0: 6464 7265 7373 2720 6172 6520 6b65 7965  ddress' are keye
+000018c0: 6420 6279 2074 6865 2055 6e69 7377 6170  d by the Uniswap
+000018d0: 2076 6572 7369 6f6e 2061 7373 6f63 6961   version associa
+000018e0: 7465 6420 7769 7468 2074 6865 6972 2063  ted with their c
+000018f0: 6f6e 7472 6163 7473 2c20 652e 672e 0a20  ontracts, e.g.. 
+00001900: 2020 2020 2020 2020 2020 2072 6f75 7465             route
+00001910: 725f 6469 6374 203d 207b 0a20 2020 2020  r_dict = {.     
+00001920: 2020 2020 2020 2020 2020 2027 6e61 6d65             'name
+00001930: 273a 2027 536f 6d65 4445 5827 2c0a 2020  ': 'SomeDEX',.  
+00001940: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00001950: 6163 746f 7279 5f61 6464 7265 7373 273a  actory_address':
+00001960: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00001970: 2020 2020 2020 2032 3a20 2730 782e 2e2e         2: '0x...
+00001980: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00001990: 2020 2020 2020 2033 3a20 2730 782e 2e2e         3: '0x...
+000019a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000019b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000019c0: 207d 0a20 2020 2020 2020 2022 2222 0a20   }.        """. 
+000019d0: 2020 2020 2020 2072 6f75 7465 725f 6164         router_ad
+000019e0: 6472 6573 7320 3d20 746f 5f63 6865 636b  dress = to_check
+000019f0: 7375 6d5f 6164 6472 6573 7328 726f 7574  sum_address(rout
+00001a00: 6572 5f61 6464 7265 7373 290a 0a20 2020  er_address)..   
+00001a10: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00001a20: 5b0a 2020 2020 2020 2020 2020 2020 226e  [.            "n
+00001a30: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
+00001a40: 2020 2266 6163 746f 7279 5f61 6464 7265    "factory_addre
+00001a50: 7373 222c 0a20 2020 2020 2020 205d 3a0a  ss",.        ]:.
+00001a60: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00001a70: 6579 206e 6f74 2069 6e20 726f 7574 6572  ey not in router
+00001a80: 5f64 6963 743a 0a20 2020 2020 2020 2020  _dict:.         
+00001a90: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00001aa0: 7565 4572 726f 7228 6622 7b6b 6579 7d20  ueError(f"{key} 
+00001ab0: 6e6f 7420 666f 756e 6420 696e 2072 6f75  not found in rou
+00001ac0: 7465 725f 6469 6374 2229 0a0a 2020 2020  ter_dict")..    
+00001ad0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00001ae0: 2020 2020 205f 524f 5554 4552 535b 6368       _ROUTERS[ch
+00001af0: 6169 6e5f 6964 5d5b 726f 7574 6572 5f61  ain_id][router_a
+00001b00: 6464 7265 7373 5d0a 2020 2020 2020 2020  ddress].        
+00001b10: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00001b20: 3a0a 2020 2020 2020 2020 2020 2020 5f52  :.            _R
+00001b30: 4f55 5445 5253 5b63 6861 696e 5f69 645d  OUTERS[chain_id]
+00001b40: 5b72 6f75 7465 725f 6164 6472 6573 735d  [router_address]
+00001b50: 203d 2072 6f75 7465 725f 6469 6374 0a0a   = router_dict..
+00001b60: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00001b70: 0a20 2020 2064 6566 2061 6464 5f77 7261  .    def add_wra
+00001b80: 7070 6564 5f74 6f6b 656e 2863 6c73 2c20  pped_token(cls, 
+00001b90: 6368 6169 6e5f 6964 3a20 696e 742c 2074  chain_id: int, t
+00001ba0: 6f6b 656e 5f61 6464 7265 7373 3a20 7374  oken_address: st
+00001bb0: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+00001bc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00001bd0: 4164 6420 6120 7772 6170 7065 6420 746f  Add a wrapped to
+00001be0: 6b65 6e20 6164 6472 6573 7320 666f 7220  ken address for 
+00001bf0: 6120 6769 7665 6e20 6368 6169 6e20 4944  a given chain ID
+00001c00: 2e0a 0a20 2020 2020 2020 2054 6865 206d  ...        The m
+00001c10: 6574 686f 6420 6368 6563 6b73 756d 7320  ethod checksums 
+00001c20: 7468 6520 746f 6b65 6e20 6164 6472 6573  the token addres
+00001c30: 732e 0a20 2020 2020 2020 2022 2222 0a0a  s..        """..
+00001c40: 2020 2020 2020 2020 5f74 6f6b 656e 5f61          _token_a
+00001c50: 6464 7265 7373 203d 2074 6f5f 6368 6563  ddress = to_chec
+00001c60: 6b73 756d 5f61 6464 7265 7373 2874 6f6b  ksum_address(tok
+00001c70: 656e 5f61 6464 7265 7373 290a 0a20 2020  en_address)..   
+00001c80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00001c90: 2020 2020 2020 5752 4150 5045 445f 4e41        WRAPPED_NA
+00001ca0: 5449 5645 5f54 4f4b 454e 535b 6368 6169  TIVE_TOKENS[chai
+00001cb0: 6e5f 6964 5d0a 2020 2020 2020 2020 6578  n_id].        ex
+00001cc0: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00001cd0: 2020 2020 2020 2020 2020 2057 5241 5050             WRAPP
+00001ce0: 4544 5f4e 4154 4956 455f 544f 4b45 4e53  ED_NATIVE_TOKENS
+00001cf0: 5b63 6861 696e 5f69 645d 203d 205f 746f  [chain_id] = _to
+00001d00: 6b65 6e5f 6164 6472 6573 730a 0a20 2020  ken_address..   
+00001d10: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+00001d20: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00001d30: 2020 2020 2063 6861 696e 5f69 643a 2069       chain_id: i
+00001d40: 6e74 207c 2073 7472 2c0a 2020 2020 2020  nt | str,.      
+00001d50: 2020 7478 5f68 6173 683a 2048 6578 4279    tx_hash: HexBy
+00001d60: 7465 7320 7c20 6279 7465 7320 7c20 7374  tes | bytes | st
+00001d70: 722c 0a20 2020 2020 2020 2074 785f 6e6f  r,.        tx_no
+00001d80: 6e63 653a 2069 6e74 207c 2073 7472 2c0a  nce: int | str,.
+00001d90: 2020 2020 2020 2020 7478 5f76 616c 7565          tx_value
+00001da0: 3a20 696e 7420 7c20 7374 722c 0a20 2020  : int | str,.   
+00001db0: 2020 2020 2074 785f 7365 6e64 6572 3a20       tx_sender: 
+00001dc0: 7374 722c 0a20 2020 2020 2020 2066 756e  str,.        fun
+00001dd0: 635f 6e61 6d65 3a20 7374 722c 0a20 2020  c_name: str,.   
+00001de0: 2020 2020 2066 756e 635f 7061 7261 6d73       func_params
+00001df0: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+00001e00: 2c0a 2020 2020 2020 2020 726f 7574 6572  ,.        router
+00001e10: 5f61 6464 7265 7373 3a20 7374 722c 0a20  _address: str,. 
+00001e20: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+00001e30: 220a 2020 2020 2020 2020 4275 696c 6420  ".        Build 
+00001e40: 6120 7374 616e 6461 6c6f 6e65 2072 6570  a standalone rep
+00001e50: 7265 7365 6e74 6174 696f 6e20 6f66 2061  resentation of a
+00001e60: 2074 7261 6e73 6163 7469 6f6e 2073 7562   transaction sub
+00001e70: 6d69 7474 6564 2074 6f20 6120 6b6e 6f77  mitted to a know
+00001e80: 6e20 556e 6973 7761 702d 6261 7365 640a  n Uniswap-based.
+00001e90: 2020 2020 2020 2020 726f 7574 6572 2063          router c
+00001ea0: 6f6e 7472 6163 742e 0a0a 2020 2020 2020  ontract...      
+00001eb0: 2020 5375 7070 6f72 7465 6420 636f 6e74    Supported cont
+00001ec0: 7261 6374 733a 0a20 2020 2020 2020 2020  racts:.         
+00001ed0: 2020 2055 6e69 7377 6170 2056 3220 526f     Uniswap V2 Ro
+00001ee0: 7574 6572 0a20 2020 2020 2020 2020 2020  uter.           
+00001ef0: 2055 6e69 7377 6170 2056 3220 526f 7574   Uniswap V2 Rout
+00001f00: 6572 2032 0a20 2020 2020 2020 2020 2020  er 2.           
+00001f10: 2055 6e69 7377 6170 2056 3320 526f 7574   Uniswap V3 Rout
+00001f20: 6572 0a20 2020 2020 2020 2020 2020 2055  er.            U
+00001f30: 6e69 7377 6170 2056 3320 526f 7574 6572  niswap V3 Router
+00001f40: 2032 0a20 2020 2020 2020 2020 2020 2055   2.            U
+00001f50: 6e69 7377 6170 2055 6e69 7665 7273 616c  niswap Universal
+00001f60: 2052 6f75 7465 720a 2020 2020 2020 2020   Router.        
+00001f70: 2222 220a 0a20 2020 2020 2020 2023 2040  """..        # @
+00001f80: 6465 7620 5468 6520 6073 656c 662e 6c65  dev The `self.le
+00001f90: 6467 6572 6020 6973 2075 7365 6420 746f  dger` is used to
+00001fa0: 2074 7261 636b 2074 6f6b 656e 2062 616c   track token bal
+00001fb0: 616e 6365 7320 666f 7220 616c 6c0a 2020  ances for all.  
+00001fc0: 2020 2020 2020 2320 6164 6472 6573 7365        # addresse
+00001fd0: 7320 696e 766f 6c76 6564 2069 6e20 7468  s involved in th
+00001fe0: 6520 7377 6170 2e20 4120 706f 7369 7469  e swap. A positi
+00001ff0: 7665 2062 616c 616e 6365 2072 6570 7265  ve balance repre
+00002000: 7365 6e74 730a 2020 2020 2020 2020 2320  sents.        # 
+00002010: 6120 7072 652d 7377 6170 2064 6570 6f73  a pre-swap depos
+00002020: 6974 2c20 6120 6e65 6761 7469 7665 2062  it, a negative b
+00002030: 616c 616e 6365 2072 6570 7265 7365 6e74  alance represent
+00002040: 7320 616e 206f 7574 7374 616e 6469 6e67  s an outstanding
+00002050: 0a20 2020 2020 2020 2023 2077 6974 6864  .        # withd
+00002060: 7261 7761 6c2e 2041 2066 756c 6c20 7472  rawal. A full tr
+00002070: 616e 7361 6374 696f 6e20 7368 6f75 6c64  ansaction should
+00002080: 2065 6e64 2077 6974 6820 6120 706f 7369   end with a posi
+00002090: 7469 7665 2062 616c 616e 6365 206f 660a  tive balance of.
+000020a0: 2020 2020 2020 2020 2320 7468 6520 6465          # the de
+000020b0: 7369 7265 6420 6f75 7470 7574 2074 6f6b  sired output tok
+000020c0: 656e 2c20 6372 6564 6974 6564 2074 6f20  en, credited to 
+000020d0: 6073 656c 662e 7365 6e64 6572 6020 6f72  `self.sender` or
+000020e0: 206f 6e65 206f 7220 6d6f 7265 0a20 2020   one or more.   
+000020f0: 2020 2020 2023 2072 6563 6970 6965 6e74       # recipient
+00002100: 732c 2077 6869 6368 2061 7265 2063 6f6c  s, which are col
+00002110: 6c65 6374 6564 2069 6e20 7468 6520 6073  lected in the `s
+00002120: 656c 662e 746f 6020 7365 742e 0a0a 2020  elf.to` set...  
+00002130: 2020 2020 2020 2320 4064 6576 2053 6f6d        # @dev Som
+00002140: 6520 726f 7574 6572 7320 6861 7665 2073  e routers have s
+00002150: 7065 6369 616c 2066 6c61 6773 2074 6861  pecial flags tha
+00002160: 7420 7369 676e 6966 7920 7468 6520 7377  t signify the sw
+00002170: 6170 2061 6d6f 756e 740a 2020 2020 2020  ap amount.      
+00002180: 2020 2320 7368 6f75 6c64 2062 6520 6c6f    # should be lo
+00002190: 6f6b 6564 2075 7020 6174 2074 6865 2074  oked up at the t
+000021a0: 696d 6520 6f66 2074 6865 2073 7761 702c  ime of the swap,
+000021b0: 2061 7320 6f70 706f 7365 6420 746f 2061   as opposed to a
+000021c0: 0a20 2020 2020 2020 2023 2073 7065 6369  .        # speci
+000021d0: 6669 6564 2061 6d6f 756e 7420 6174 2074  fied amount at t
+000021e0: 6865 2074 696d 6520 7468 6520 7472 616e  he time the tran
+000021f0: 7361 6374 696f 6e20 6973 2062 7569 6c74  saction is built
+00002200: 2e20 5468 6520 6c65 6467 6572 2069 730a  . The ledger is.
+00002210: 2020 2020 2020 2020 2320 7573 6564 2074          # used t
+00002220: 6f20 6c6f 6f6b 2075 7020 7468 6520 6261  o look up the ba
+00002230: 6c61 6e63 6520 6174 2061 6e79 2070 6f69  lance at any poi
+00002240: 6e74 2069 6e73 6964 6520 7468 6520 7377  nt inside the sw
+00002250: 6170 2c20 616e 6420 6174 2074 6865 0a20  ap, and at the. 
+00002260: 2020 2020 2020 2023 2065 6e64 2074 6f20         # end to 
+00002270: 636f 6e66 6972 6d20 7468 6174 2061 6c6c  confirm that all
+00002280: 2062 616c 616e 6365 7320 6861 7665 2062   balances have b
+00002290: 6565 6e20 6163 636f 756e 7465 6420 666f  een accounted fo
+000022a0: 722e 0a0a 2020 2020 2020 2020 7365 6c66  r...        self
+000022b0: 2e6c 6564 6765 7220 3d20 5369 6d75 6c61  .ledger = Simula
+000022c0: 7469 6f6e 4c65 6467 6572 2829 0a0a 2020  tionLedger()..  
+000022d0: 2020 2020 2020 7365 6c66 2e63 6861 696e        self.chain
+000022e0: 5f69 6420 3d20 696e 7428 6368 6169 6e5f  _id = int(chain_
+000022f0: 6964 2c20 3136 2920 6966 2069 7369 6e73  id, 16) if isins
+00002300: 7461 6e63 6528 6368 6169 6e5f 6964 2c20  tance(chain_id, 
+00002310: 7374 7229 2065 6c73 6520 6368 6169 6e5f  str) else chain_
+00002320: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
+00002330: 726f 7574 6572 7320 3d20 5f52 4f55 5445  routers = _ROUTE
+00002340: 5253 5b73 656c 662e 6368 6169 6e5f 6964  RS[self.chain_id
+00002350: 5d0a 2020 2020 2020 2020 7365 6c66 2e73  ].        self.s
+00002360: 656e 6465 7220 3d20 746f 5f63 6865 636b  ender = to_check
+00002370: 7375 6d5f 6164 6472 6573 7328 7478 5f73  sum_address(tx_s
+00002380: 656e 6465 7229 0a20 2020 2020 2020 2073  ender).        s
+00002390: 656c 662e 7265 6369 7069 656e 7473 3a20  elf.recipients: 
+000023a0: 5365 745b 4368 6563 6b73 756d 4164 6472  Set[ChecksumAddr
+000023b0: 6573 735d 203d 2073 6574 2829 0a0a 2020  ess] = set()..  
+000023c0: 2020 2020 2020 726f 7574 6572 5f61 6464        router_add
+000023d0: 7265 7373 203d 2074 6f5f 6368 6563 6b73  ress = to_checks
+000023e0: 756d 5f61 6464 7265 7373 2872 6f75 7465  um_address(route
+000023f0: 725f 6164 6472 6573 7329 0a20 2020 2020  r_address).     
+00002400: 2020 2069 6620 726f 7574 6572 5f61 6464     if router_add
+00002410: 7265 7373 206e 6f74 2069 6e20 7365 6c66  ress not in self
+00002420: 2e72 6f75 7465 7273 3a0a 2020 2020 2020  .routers:.      
+00002430: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00002440: 6545 7272 6f72 2866 2252 6f75 7465 7220  eError(f"Router 
+00002450: 6164 6472 6573 7320 7b72 6f75 7465 725f  address {router_
+00002460: 6164 6472 6573 737d 2075 6e6b 6e6f 776e  address} unknown
+00002470: 2122 290a 0a20 2020 2020 2020 2073 656c  !")..        sel
+00002480: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
+00002490: 203d 2072 6f75 7465 725f 6164 6472 6573   = router_addres
+000024a0: 730a 0a20 2020 2020 2020 2073 656c 662e  s..        self.
+000024b0: 7632 5f70 6f6f 6c5f 6d61 6e61 6765 723a  v2_pool_manager:
+000024c0: 2055 6e69 7377 6170 5632 4c69 7175 6964   UniswapV2Liquid
+000024d0: 6974 7950 6f6f 6c4d 616e 6167 6572 207c  ityPoolManager |
+000024e0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
+000024f0: 2020 2020 2073 656c 662e 7633 5f70 6f6f       self.v3_poo
+00002500: 6c5f 6d61 6e61 6765 723a 2055 6e69 7377  l_manager: Unisw
+00002510: 6170 5633 4c69 7175 6964 6974 7950 6f6f  apV3LiquidityPoo
+00002520: 6c4d 616e 6167 6572 207c 204e 6f6e 6520  lManager | None 
+00002530: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+00002540: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00002550: 2073 656c 662e 7632 5f70 6f6f 6c5f 6d61   self.v2_pool_ma
+00002560: 6e61 6765 7220 3d20 556e 6973 7761 7056  nager = UniswapV
+00002570: 324c 6971 7569 6469 7479 506f 6f6c 4d61  2LiquidityPoolMa
+00002580: 6e61 6765 7228 0a20 2020 2020 2020 2020  nager(.         
+00002590: 2020 2020 2020 2066 6163 746f 7279 5f61         factory_a
+000025a0: 6464 7265 7373 3d73 656c 662e 726f 7574  ddress=self.rout
+000025b0: 6572 735b 726f 7574 6572 5f61 6464 7265  ers[router_addre
+000025c0: 7373 5d5b 2266 6163 746f 7279 5f61 6464  ss]["factory_add
+000025d0: 7265 7373 225d 5b32 5d0a 2020 2020 2020  ress"][2].      
+000025e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000025f0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00002600: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00002610: 730a 0a20 2020 2020 2020 2074 7279 3a0a  s..        try:.
+00002620: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002630: 2e76 335f 706f 6f6c 5f6d 616e 6167 6572  .v3_pool_manager
+00002640: 203d 2055 6e69 7377 6170 5633 4c69 7175   = UniswapV3Liqu
+00002650: 6964 6974 7950 6f6f 6c4d 616e 6167 6572  idityPoolManager
+00002660: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002670: 2020 6661 6374 6f72 795f 6164 6472 6573    factory_addres
+00002680: 733d 7365 6c66 2e72 6f75 7465 7273 5b72  s=self.routers[r
+00002690: 6f75 7465 725f 6164 6472 6573 735d 5b22  outer_address]["
+000026a0: 6661 6374 6f72 795f 6164 6472 6573 7322  factory_address"
+000026b0: 5d5b 335d 0a20 2020 2020 2020 2020 2020  ][3].           
+000026c0: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+000026d0: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+000026e0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+000026f0: 2020 2020 2020 7365 6c66 2e68 6173 6820        self.hash 
+00002700: 3d20 4865 7842 7974 6573 2874 785f 6861  = HexBytes(tx_ha
+00002710: 7368 290a 2020 2020 2020 2020 7365 6c66  sh).        self
+00002720: 2e6e 6f6e 6365 203d 2069 6e74 2874 785f  .nonce = int(tx_
+00002730: 6e6f 6e63 652c 2031 3629 2069 6620 6973  nonce, 16) if is
+00002740: 696e 7374 616e 6365 2874 785f 6e6f 6e63  instance(tx_nonc
+00002750: 652c 2073 7472 2920 656c 7365 2074 785f  e, str) else tx_
+00002760: 6e6f 6e63 650a 2020 2020 2020 2020 7365  nonce.        se
+00002770: 6c66 2e76 616c 7565 203d 2069 6e74 2874  lf.value = int(t
+00002780: 785f 7661 6c75 652c 2031 3629 2069 6620  x_value, 16) if 
+00002790: 6973 696e 7374 616e 6365 2874 785f 7661  isinstance(tx_va
+000027a0: 6c75 652c 2073 7472 2920 656c 7365 2074  lue, str) else t
+000027b0: 785f 7661 6c75 650a 2020 2020 2020 2020  x_value.        
+000027c0: 7365 6c66 2e66 756e 635f 6e61 6d65 203d  self.func_name =
+000027d0: 2066 756e 635f 6e61 6d65 0a20 2020 2020   func_name.     
+000027e0: 2020 2073 656c 662e 6675 6e63 5f70 6172     self.func_par
+000027f0: 616d 7320 3d20 6675 6e63 5f70 6172 616d  ams = func_param
+00002800: 730a 2020 2020 2020 2020 6966 2070 7265  s.        if pre
+00002810: 7669 6f75 735f 626c 6f63 6b5f 6861 7368  vious_block_hash
+00002820: 203a 3d20 7365 6c66 2e66 756e 635f 7061   := self.func_pa
+00002830: 7261 6d73 2e67 6574 2822 7072 6576 696f  rams.get("previo
+00002840: 7573 426c 6f63 6b68 6173 6822 293a 0a20  usBlockhash"):. 
+00002850: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00002860: 6675 6e63 5f70 7265 7669 6f75 735f 626c  func_previous_bl
+00002870: 6f63 6b5f 6861 7368 203d 2048 6578 4279  ock_hash = HexBy
+00002880: 7465 7328 7072 6576 696f 7573 5f62 6c6f  tes(previous_blo
+00002890: 636b 5f68 6173 6829 0a0a 2020 2020 2020  ck_hash)..      
+000028a0: 2020 7365 6c66 2e73 696c 656e 7420 3d20    self.silent = 
+000028b0: 4661 6c73 650a 0a20 2020 2064 6566 205f  False..    def _
+000028c0: 7261 6973 655f 6966 5f70 6173 745f 6465  raise_if_past_de
+000028d0: 6164 6c69 6e65 2873 656c 662c 2064 6561  adline(self, dea
+000028e0: 646c 696e 653a 2069 6e74 2920 2d3e 204e  dline: int) -> N
+000028f0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+00002900: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00002910: 6c66 2e73 7461 7465 5f62 6c6f 636b 2069  lf.state_block i
+00002920: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+00002930: 2020 2020 2020 2061 6e64 2063 6f6e 6669         and confi
+00002940: 672e 6765 745f 7765 6233 2829 2e65 7468  g.get_web3().eth
+00002950: 2e67 6574 5f62 6c6f 636b 2873 656c 662e  .get_block(self.
+00002960: 7374 6174 655f 626c 6f63 6b29 5b22 7469  state_block)["ti
+00002970: 6d65 7374 616d 7022 5d20 3e20 6465 6164  mestamp"] > dead
+00002980: 6c69 6e65 0a20 2020 2020 2020 2029 3a0a  line.        ):.
+00002990: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000029a0: 6520 5472 616e 7361 6374 696f 6e45 7272  e TransactionErr
+000029b0: 6f72 2822 4465 6164 6c69 6e65 2065 7870  or("Deadline exp
+000029c0: 6972 6564 2229 0a0a 2020 2020 6465 6620  ired")..    def 
+000029d0: 5f72 6169 7365 5f69 665f 626c 6f63 6b5f  _raise_if_block_
+000029e0: 6861 7368 5f6d 6973 6d61 7463 6828 7365  hash_mismatch(se
+000029f0: 6c66 2c20 626c 6f63 6b5f 6861 7368 3a20  lf, block_hash: 
+00002a00: 4865 7842 7974 6573 2920 2d3e 204e 6f6e  HexBytes) -> Non
+00002a10: 653a 0a20 2020 2020 2020 206c 6f67 6765  e:.        logge
+00002a20: 722e 696e 666f 2866 2243 6865 636b 696e  r.info(f"Checkin
+00002a30: 6720 7072 6576 696f 7573 426c 6f63 6b68  g previousBlockh
+00002a40: 6173 683a 207b 626c 6f63 6b5f 6861 7368  ash: {block_hash
+00002a50: 2172 7d22 290a 2020 2020 2020 2020 6966  !r}").        if
+00002a60: 2063 6f6e 6669 672e 6765 745f 7765 6233   config.get_web3
+00002a70: 2829 2e65 7468 2e67 6574 5f62 6c6f 636b  ().eth.get_block
+00002a80: 2822 6c61 7465 7374 2229 5b22 6861 7368  ("latest")["hash
+00002a90: 225d 2021 3d20 626c 6f63 6b5f 6861 7368  "] != block_hash
+00002aa0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00002ab0: 6973 6520 5472 616e 7361 6374 696f 6e45  ise TransactionE
+00002ac0: 7272 6f72 2822 5072 6576 696f 7573 2062  rror("Previous b
+00002ad0: 6c6f 636b 2068 6173 6820 6d69 736d 6174  lock hash mismat
+00002ae0: 6368 2229 0a0a 2020 2020 6465 6620 5f73  ch")..    def _s
+00002af0: 686f 775f 706f 6f6c 5f73 7461 7465 7328  how_pool_states(
+00002b00: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00002b10: 2020 2020 2020 2070 6f6f 6c3a 204c 6971         pool: Liq
+00002b20: 7569 6469 7479 506f 6f6c 207c 2056 334c  uidityPool | V3L
+00002b30: 6971 7569 6469 7479 506f 6f6c 2c0a 2020  iquidityPool,.  
+00002b40: 2020 2020 2020 7369 6d5f 7265 7375 6c74        sim_result
+00002b50: 3a20 556e 6973 7761 7056 3250 6f6f 6c53  : UniswapV2PoolS
+00002b60: 696d 756c 6174 696f 6e52 6573 756c 7420  imulationResult 
+00002b70: 7c20 556e 6973 7761 7056 3350 6f6f 6c53  | UniswapV3PoolS
+00002b80: 696d 756c 6174 696f 6e52 6573 756c 742c  imulationResult,
+00002b90: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00002ba0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00002bb0: 7374 6174 6520 3d20 7369 6d5f 7265 7375  state = sim_resu
+00002bc0: 6c74 2e69 6e69 7469 616c 5f73 7461 7465  lt.initial_state
+00002bd0: 0a20 2020 2020 2020 2066 7574 7572 655f  .        future_
+00002be0: 7374 6174 6520 3d20 7369 6d5f 7265 7375  state = sim_resu
+00002bf0: 6c74 2e66 696e 616c 5f73 7461 7465 0a0a  lt.final_state..
+00002c00: 2020 2020 2020 2020 2320 616d 6f75 6e74          # amount
+00002c10: 206f 7574 2069 7320 6e65 6761 7469 7665   out is negative
+00002c20: 0a20 2020 2020 2020 2069 6620 7369 6d5f  .        if sim_
+00002c30: 7265 7375 6c74 2e61 6d6f 756e 7430 5f64  result.amount0_d
+00002c40: 656c 7461 203c 2073 696d 5f72 6573 756c  elta < sim_resul
+00002c50: 742e 616d 6f75 6e74 315f 6465 6c74 613a  t.amount1_delta:
+00002c60: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+00002c70: 656e 5f69 6e20 3d20 706f 6f6c 2e74 6f6b  en_in = pool.tok
+00002c80: 656e 310a 2020 2020 2020 2020 2020 2020  en1.            
+00002c90: 746f 6b65 6e5f 6f75 7420 3d20 706f 6f6c  token_out = pool
+00002ca0: 2e74 6f6b 656e 300a 2020 2020 2020 2020  .token0.        
+00002cb0: 2020 2020 616d 6f75 6e74 5f69 6e20 3d20      amount_in = 
+00002cc0: 7369 6d5f 7265 7375 6c74 2e61 6d6f 756e  sim_result.amoun
+00002cd0: 7431 5f64 656c 7461 0a20 2020 2020 2020  t1_delta.       
+00002ce0: 2020 2020 2061 6d6f 756e 745f 6f75 7420       amount_out 
+00002cf0: 3d20 2d73 696d 5f72 6573 756c 742e 616d  = -sim_result.am
+00002d00: 6f75 6e74 305f 6465 6c74 610a 2020 2020  ount0_delta.    
+00002d10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00002d20: 2020 2020 2020 746f 6b65 6e5f 696e 203d        token_in =
+00002d30: 2070 6f6f 6c2e 746f 6b65 6e30 0a20 2020   pool.token0.   
+00002d40: 2020 2020 2020 2020 2074 6f6b 656e 5f6f           token_o
+00002d50: 7574 203d 2070 6f6f 6c2e 746f 6b65 6e31  ut = pool.token1
+00002d60: 0a20 2020 2020 2020 2020 2020 2061 6d6f  .            amo
+00002d70: 756e 745f 696e 203d 2073 696d 5f72 6573  unt_in = sim_res
+00002d80: 756c 742e 616d 6f75 6e74 305f 6465 6c74  ult.amount0_delt
+00002d90: 610a 2020 2020 2020 2020 2020 2020 616d  a.            am
+00002da0: 6f75 6e74 5f6f 7574 203d 202d 7369 6d5f  ount_out = -sim_
+00002db0: 7265 7375 6c74 2e61 6d6f 756e 7431 5f64  result.amount1_d
+00002dc0: 656c 7461 0a0a 2020 2020 2020 2020 6c6f  elta..        lo
+00002dd0: 6767 6572 2e69 6e66 6f28 6622 5369 6d75  gger.info(f"Simu
+00002de0: 6c61 7469 6e67 2073 7761 7020 7468 726f  lating swap thro
+00002df0: 7567 6820 706f 6f6c 3a20 7b70 6f6f 6c7d  ugh pool: {pool}
+00002e00: 2229 0a20 2020 2020 2020 206c 6f67 6765  ").        logge
+00002e10: 722e 696e 666f 2866 225c 747b 616d 6f75  r.info(f"\t{amou
+00002e20: 6e74 5f69 6e7d 207b 746f 6b65 6e5f 696e  nt_in} {token_in
+00002e30: 7d20 2d3e 207b 616d 6f75 6e74 5f6f 7574  } -> {amount_out
+00002e40: 7d20 7b74 6f6b 656e 5f6f 7574 7d22 290a  } {token_out}").
+00002e50: 2020 2020 2020 2020 6d61 7463 6820 7369          match si
+00002e60: 6d5f 7265 7375 6c74 3a0a 2020 2020 2020  m_result:.      
+00002e70: 2020 2020 2020 6361 7365 2055 6e69 7377        case Unisw
+00002e80: 6170 5632 506f 6f6c 5369 6d75 6c61 7469  apV2PoolSimulati
+00002e90: 6f6e 5265 7375 6c74 2829 3a0a 2020 2020  onResult():.    
+00002ea0: 2020 2020 2020 2020 2020 2020 6966 2054              if T
+00002eb0: 5950 455f 4348 4543 4b49 4e47 3a0a 2020  YPE_CHECKING:.  
+00002ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ed0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00002ee0: 6e63 6528 6375 7272 656e 745f 7374 6174  nce(current_stat
+00002ef0: 652c 2055 6e69 7377 6170 5632 506f 6f6c  e, UniswapV2Pool
+00002f00: 5374 6174 6529 0a20 2020 2020 2020 2020  State).         
+00002f10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00002f20: 7420 6973 696e 7374 616e 6365 2866 7574  t isinstance(fut
+00002f30: 7572 655f 7374 6174 652c 2055 6e69 7377  ure_state, Unisw
+00002f40: 6170 5632 506f 6f6c 5374 6174 6529 0a20  apV2PoolState). 
+00002f50: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00002f60: 6f67 6765 722e 696e 666f 2822 5c74 2843  ogger.info("\t(C
+00002f70: 5552 5245 4e54 2922 290a 2020 2020 2020  URRENT)").      
+00002f80: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00002f90: 2e69 6e66 6f28 6622 5c74 7b70 6f6f 6c2e  .info(f"\t{pool.
+00002fa0: 746f 6b65 6e30 7d3a 207b 6375 7272 656e  token0}: {curren
+00002fb0: 745f 7374 6174 652e 7265 7365 7276 6573  t_state.reserves
+00002fc0: 5f74 6f6b 656e 307d 2229 0a20 2020 2020  _token0}").     
+00002fd0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00002fe0: 722e 696e 666f 2866 225c 747b 706f 6f6c  r.info(f"\t{pool
+00002ff0: 2e74 6f6b 656e 317d 3a20 7b63 7572 7265  .token1}: {curre
+00003000: 6e74 5f73 7461 7465 2e72 6573 6572 7665  nt_state.reserve
+00003010: 735f 746f 6b65 6e31 7d22 290a 2020 2020  s_token1}").    
+00003020: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00003030: 6572 2e69 6e66 6f28 225c 7428 4655 5455  er.info("\t(FUTU
+00003040: 5245 2922 290a 2020 2020 2020 2020 2020  RE)").          
+00003050: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00003060: 6f28 6622 5c74 7b70 6f6f 6c2e 746f 6b65  o(f"\t{pool.toke
+00003070: 6e30 7d3a 207b 6675 7475 7265 5f73 7461  n0}: {future_sta
+00003080: 7465 2e72 6573 6572 7665 735f 746f 6b65  te.reserves_toke
+00003090: 6e30 7d22 290a 2020 2020 2020 2020 2020  n0}").          
+000030a0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+000030b0: 6f28 6622 5c74 7b70 6f6f 6c2e 746f 6b65  o(f"\t{pool.toke
+000030c0: 6e31 7d3a 207b 6675 7475 7265 5f73 7461  n1}: {future_sta
+000030d0: 7465 2e72 6573 6572 7665 735f 746f 6b65  te.reserves_toke
+000030e0: 6e31 7d22 290a 2020 2020 2020 2020 2020  n1}").          
+000030f0: 2020 6361 7365 2055 6e69 7377 6170 5633    case UniswapV3
+00003100: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
+00003110: 7375 6c74 2829 3a0a 2020 2020 2020 2020  sult():.        
+00003120: 2020 2020 2020 2020 6966 2054 5950 455f          if TYPE_
+00003130: 4348 4543 4b49 4e47 3a0a 2020 2020 2020  CHECKING:.      
+00003140: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00003150: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00003160: 6375 7272 656e 745f 7374 6174 652c 2055  current_state, U
+00003170: 6e69 7377 6170 5633 506f 6f6c 5374 6174  niswapV3PoolStat
+00003180: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00003190: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+000031a0: 696e 7374 616e 6365 2866 7574 7572 655f  instance(future_
+000031b0: 7374 6174 652c 2055 6e69 7377 6170 5633  state, UniswapV3
+000031c0: 506f 6f6c 5374 6174 6529 0a20 2020 2020  PoolState).     
+000031d0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000031e0: 722e 696e 666f 2866 225c 747b 616d 6f75  r.info(f"\t{amou
+000031f0: 6e74 5f69 6e7d 207b 746f 6b65 6e5f 696e  nt_in} {token_in
+00003200: 7d20 2d3e 207b 616d 6f75 6e74 5f6f 7574  } -> {amount_out
+00003210: 7d20 7b74 6f6b 656e 5f6f 7574 7d22 290a  } {token_out}").
+00003220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003230: 6c6f 6767 6572 2e69 6e66 6f28 225c 7428  logger.info("\t(
+00003240: 4355 5252 454e 5429 2229 0a20 2020 2020  CURRENT)").     
+00003250: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00003260: 722e 696e 666f 2866 225c 7470 7269 6365  r.info(f"\tprice
+00003270: 3d7b 6375 7272 656e 745f 7374 6174 652e  ={current_state.
+00003280: 7371 7274 5f70 7269 6365 5f78 3936 7d22  sqrt_price_x96}"
+00003290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000032a0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+000032b0: 5c74 6c69 7175 6964 6974 793d 7b63 7572  \tliquidity={cur
+000032c0: 7265 6e74 5f73 7461 7465 2e6c 6971 7569  rent_state.liqui
+000032d0: 6469 7479 7d22 290a 2020 2020 2020 2020  dity}").        
+000032e0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+000032f0: 6e66 6f28 6622 5c74 7469 636b 3d7b 6375  nfo(f"\ttick={cu
+00003300: 7272 656e 745f 7374 6174 652e 7469 636b  rrent_state.tick
+00003310: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+00003320: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00003330: 225c 7428 4655 5455 5245 2922 290a 2020  "\t(FUTURE)").  
+00003340: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00003350: 6767 6572 2e69 6e66 6f28 6622 5c74 7072  gger.info(f"\tpr
+00003360: 6963 653d 7b66 7574 7572 655f 7374 6174  ice={future_stat
+00003370: 652e 7371 7274 5f70 7269 6365 5f78 3936  e.sqrt_price_x96
+00003380: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+00003390: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+000033a0: 6622 5c74 6c69 7175 6964 6974 793d 7b66  f"\tliquidity={f
+000033b0: 7574 7572 655f 7374 6174 652e 6c69 7175  uture_state.liqu
+000033c0: 6964 6974 797d 2229 0a20 2020 2020 2020  idity}").       
+000033d0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+000033e0: 696e 666f 2866 225c 7474 6963 6b3d 7b66  info(f"\ttick={f
+000033f0: 7574 7572 655f 7374 6174 652e 7469 636b  uture_state.tick
+00003400: 7d22 290a 0a20 2020 2064 6566 205f 7369  }")..    def _si
+00003410: 6d75 6c61 7465 5f76 325f 7377 6170 5f65  mulate_v2_swap_e
+00003420: 7861 6374 5f69 6e28 0a20 2020 2020 2020  xact_in(.       
+00003430: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+00003440: 6f6f 6c3a 204c 6971 7569 6469 7479 506f  ool: LiquidityPo
+00003450: 6f6c 2c0a 2020 2020 2020 2020 7265 6369  ol,.        reci
+00003460: 7069 656e 743a 2043 6865 636b 7375 6d41  pient: ChecksumA
+00003470: 6464 7265 7373 207c 2073 7472 2c0a 2020  ddress | str,.  
+00003480: 2020 2020 2020 746f 6b65 6e5f 696e 3a20        token_in: 
+00003490: 4572 6332 3054 6f6b 656e 2c0a 2020 2020  Erc20Token,.    
+000034a0: 2020 2020 616d 6f75 6e74 5f69 6e3a 2069      amount_in: i
+000034b0: 6e74 2c0a 2020 2020 2020 2020 616d 6f75  nt,.        amou
+000034c0: 6e74 5f6f 7574 5f6d 696e 3a20 696e 7420  nt_out_min: int 
+000034d0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000034e0: 2020 2020 2020 2066 6972 7374 5f73 7761         first_swa
+000034f0: 703a 2062 6f6f 6c20 3d20 4661 6c73 652c  p: bool = False,
+00003500: 0a20 2020 2020 2020 206c 6173 745f 7377  .        last_sw
+00003510: 6170 3a20 626f 6f6c 203d 2046 616c 7365  ap: bool = False
+00003520: 2c0a 2020 2020 2920 2d3e 2054 7570 6c65  ,.    ) -> Tuple
+00003530: 5b0a 2020 2020 2020 2020 4c69 7175 6964  [.        Liquid
+00003540: 6974 7950 6f6f 6c2c 0a20 2020 2020 2020  ityPool,.       
+00003550: 2055 6e69 7377 6170 5632 506f 6f6c 5369   UniswapV2PoolSi
+00003560: 6d75 6c61 7469 6f6e 5265 7375 6c74 2c0a  mulationResult,.
+00003570: 2020 2020 5d3a 0a20 2020 2020 2020 2061      ]:.        a
+00003580: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00003590: 2870 6f6f 6c2c 204c 6971 7569 6469 7479  (pool, Liquidity
+000035a0: 506f 6f6c 292c 2066 2243 616c 6c65 6420  Pool), f"Called 
+000035b0: 5f73 696d 756c 6174 655f 7632 5f73 7761  _simulate_v2_swa
+000035c0: 705f 6578 6163 745f 696e 206f 6e20 706f  p_exact_in on po
+000035d0: 6f6c 207b 706f 6f6c 7d22 0a0a 2020 2020  ol {pool}"..    
+000035e0: 2020 2020 7369 6c65 6e74 203d 2073 656c      silent = sel
+000035f0: 662e 7369 6c65 6e74 0a0a 2020 2020 2020  f.silent..      
+00003600: 2020 6966 2074 6f6b 656e 5f69 6e20 6e6f    if token_in no
+00003610: 7420 696e 2070 6f6f 6c2e 746f 6b65 6e73  t in pool.tokens
+00003620: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00003630: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00003640: 2254 6f6b 656e 207b 746f 6b65 6e5f 696e  "Token {token_in
+00003650: 7d20 6e6f 7420 666f 756e 6420 696e 2070  } not found in p
+00003660: 6f6f 6c20 7b70 6f6f 6c7d 2229 0a0a 2020  ool {pool}")..  
+00003670: 2020 2020 2020 746f 6b65 6e5f 6f75 7420        token_out 
+00003680: 3d20 706f 6f6c 2e74 6f6b 656e 3120 6966  = pool.token1 if
+00003690: 2074 6f6b 656e 5f69 6e20 3d3d 2070 6f6f   token_in == poo
+000036a0: 6c2e 746f 6b65 6e30 2065 6c73 6520 706f  l.token0 else po
+000036b0: 6f6c 2e74 6f6b 656e 300a 0a20 2020 2020  ol.token0..     
+000036c0: 2020 2069 6620 616d 6f75 6e74 5f69 6e20     if amount_in 
+000036d0: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
+000036e0: 2055 6e69 7665 7273 616c 526f 7574 6572   UniversalRouter
+000036f0: 5370 6563 6961 6c56 616c 7565 732e 5553  SpecialValues.US
+00003700: 455f 434f 4e54 5241 4354 5f42 414c 414e  E_CONTRACT_BALAN
+00003710: 4345 2c0a 2020 2020 2020 2020 2020 2020  CE,.            
+00003720: 5633 526f 7574 6572 5370 6563 6961 6c56  V3RouterSpecialV
+00003730: 616c 7565 732e 5553 455f 434f 4e54 5241  alues.USE_CONTRA
+00003740: 4354 5f42 414c 414e 4345 2c0a 2020 2020  CT_BALANCE,.    
+00003750: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00003760: 2020 205f 6261 6c61 6e63 6520 3d20 7365     _balance = se
+00003770: 6c66 2e6c 6564 6765 722e 746f 6b65 6e5f  lf.ledger.token_
+00003780: 6261 6c61 6e63 6528 7365 6c66 2e72 6f75  balance(self.rou
+00003790: 7465 725f 6164 6472 6573 732c 2074 6f6b  ter_address, tok
+000037a0: 656e 5f69 6e29 0a0a 2020 2020 2020 2020  en_in)..        
+000037b0: 2020 2020 7365 6c66 2e6c 6564 6765 722e      self.ledger.
+000037c0: 7472 616e 7366 6572 280a 2020 2020 2020  transfer(.      
+000037d0: 2020 2020 2020 2020 2020 746f 6b65 6e3d            token=
+000037e0: 746f 6b65 6e5f 696e 2c0a 2020 2020 2020  token_in,.      
+000037f0: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+00003800: 3d5f 6261 6c61 6e63 652c 0a20 2020 2020  =_balance,.     
+00003810: 2020 2020 2020 2020 2020 2074 6f5f 6164             to_ad
+00003820: 6472 3d70 6f6f 6c2e 6164 6472 6573 732c  dr=pool.address,
+00003830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003840: 2066 726f 6d5f 6164 6472 3d73 656c 662e   from_addr=self.
+00003850: 726f 7574 6572 5f61 6464 7265 7373 2c0a  router_address,.
+00003860: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00003870: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+00003880: 5f69 6e20 3d20 7365 6c66 2e6c 6564 6765  _in = self.ledge
+00003890: 722e 746f 6b65 6e5f 6261 6c61 6e63 6528  r.token_balance(
+000038a0: 706f 6f6c 2e61 6464 7265 7373 2c20 746f  pool.address, to
+000038b0: 6b65 6e5f 696e 290a 0a20 2020 2020 2020  ken_in)..       
+000038c0: 2073 696d 5f72 6573 756c 7420 3d20 706f   sim_result = po
+000038d0: 6f6c 2e73 696d 756c 6174 655f 6578 6163  ol.simulate_exac
+000038e0: 745f 696e 7075 745f 7377 6170 280a 2020  t_input_swap(.  
+000038f0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+00003900: 696e 3d74 6f6b 656e 5f69 6e2c 0a20 2020  in=token_in,.   
+00003910: 2020 2020 2020 2020 2074 6f6b 656e 5f69           token_i
+00003920: 6e5f 7175 616e 7469 7479 3d61 6d6f 756e  n_quantity=amoun
+00003930: 745f 696e 2c0a 2020 2020 2020 2020 290a  t_in,.        ).
+00003940: 0a20 2020 2020 2020 205f 616d 6f75 6e74  .        _amount
+00003950: 5f6f 7574 203d 202d 6d69 6e28 0a20 2020  _out = -min(.   
+00003960: 2020 2020 2020 2020 2073 696d 5f72 6573           sim_res
+00003970: 756c 742e 616d 6f75 6e74 305f 6465 6c74  ult.amount0_delt
+00003980: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
+00003990: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
+000039a0: 315f 6465 6c74 612c 0a20 2020 2020 2020  1_delta,.       
+000039b0: 2029 0a0a 2020 2020 2020 2020 6966 2066   )..        if f
+000039c0: 6972 7374 5f73 7761 7020 616e 6420 6e6f  irst_swap and no
+000039d0: 7420 7365 6c66 2e6c 6564 6765 722e 746f  t self.ledger.to
+000039e0: 6b65 6e5f 6261 6c61 6e63 6528 706f 6f6c  ken_balance(pool
+000039f0: 2e61 6464 7265 7373 2c20 746f 6b65 6e5f  .address, token_
+00003a00: 696e 293a 0a20 2020 2020 2020 2020 2020  in):.           
+00003a10: 2023 2063 7265 6469 7420 7468 6520 726f   # credit the ro
+00003a20: 7574 6572 2069 6620 7468 6572 6520 6973  uter if there is
+00003a30: 2061 207a 6572 6f20 6261 6c61 6e63 650a   a zero balance.
+00003a40: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00003a50: 6f74 2073 656c 662e 6c65 6467 6572 2e74  ot self.ledger.t
+00003a60: 6f6b 656e 5f62 616c 616e 6365 2873 656c  oken_balance(sel
+00003a70: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
+00003a80: 2c20 746f 6b65 6e5f 696e 293a 0a20 2020  , token_in):.   
+00003a90: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00003aa0: 662e 6c65 6467 6572 2e61 646a 7573 7428  f.ledger.adjust(
+00003ab0: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
+00003ac0: 6573 732c 2074 6f6b 656e 5f69 6e2e 6164  ess, token_in.ad
+00003ad0: 6472 6573 732c 2061 6d6f 756e 745f 696e  dress, amount_in
+00003ae0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00003af0: 6c66 2e6c 6564 6765 722e 7472 616e 7366  lf.ledger.transf
+00003b00: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00003b10: 2020 2020 746f 6b65 6e5f 696e 2c0a 2020      token_in,.  
+00003b20: 2020 2020 2020 2020 2020 2020 2020 616d                am
+00003b30: 6f75 6e74 3d61 6d6f 756e 745f 696e 2c0a  ount=amount_in,.
+00003b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b50: 6672 6f6d 5f61 6464 723d 7365 6c66 2e72  from_addr=self.r
+00003b60: 6f75 7465 725f 6164 6472 6573 732c 0a20  outer_address,. 
+00003b70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00003b80: 6f5f 6164 6472 3d70 6f6f 6c2e 6164 6472  o_addr=pool.addr
+00003b90: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+00003ba0: 2029 0a0a 2020 2020 2020 2020 2320 7072   )..        # pr
+00003bb0: 6f63 6573 7320 7468 6520 7377 6170 0a20  ocess the swap. 
+00003bc0: 2020 2020 2020 2073 656c 662e 6c65 6467         self.ledg
+00003bd0: 6572 2e61 646a 7573 7428 706f 6f6c 2e61  er.adjust(pool.a
+00003be0: 6464 7265 7373 2c20 746f 6b65 6e5f 696e  ddress, token_in
+00003bf0: 2e61 6464 7265 7373 2c20 2d61 6d6f 756e  .address, -amoun
+00003c00: 745f 696e 290a 2020 2020 2020 2020 7365  t_in).        se
+00003c10: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
+00003c20: 2870 6f6f 6c2e 6164 6472 6573 732c 2074  (pool.address, t
+00003c30: 6f6b 656e 5f6f 7574 2e61 6464 7265 7373  oken_out.address
+00003c40: 2c20 5f61 6d6f 756e 745f 6f75 7429 0a0a  , _amount_out)..
+00003c50: 2020 2020 2020 2020 2320 7472 616e 7366          # transf
+00003c60: 6572 2074 6f20 7468 6520 7265 6369 7069  er to the recipi
+00003c70: 656e 740a 2020 2020 2020 2020 7365 6c66  ent.        self
+00003c80: 2e6c 6564 6765 722e 7472 616e 7366 6572  .ledger.transfer
+00003c90: 280a 2020 2020 2020 2020 2020 2020 746f  (.            to
+00003ca0: 6b65 6e3d 746f 6b65 6e5f 6f75 742c 0a20  ken=token_out,. 
+00003cb0: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
+00003cc0: 743d 5f61 6d6f 756e 745f 6f75 742c 0a20  t=_amount_out,. 
+00003cd0: 2020 2020 2020 2020 2020 2066 726f 6d5f             from_
+00003ce0: 6164 6472 3d70 6f6f 6c2e 6164 6472 6573  addr=pool.addres
+00003cf0: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
+00003d00: 6f5f 6164 6472 3d72 6563 6970 6965 6e74  o_addr=recipient
+00003d10: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00003d20: 2020 2020 2069 6620 6c61 7374 5f73 7761       if last_swa
+00003d30: 703a 0a20 2020 2020 2020 2020 2020 2073  p:.            s
+00003d40: 656c 662e 7265 6369 7069 656e 7473 2e61  elf.recipients.a
+00003d50: 6464 2874 6f5f 6368 6563 6b73 756d 5f61  dd(to_checksum_a
+00003d60: 6464 7265 7373 2872 6563 6970 6965 6e74  ddress(recipient
+00003d70: 2929 0a0a 2020 2020 2020 2020 6966 206c  ))..        if l
+00003d80: 6173 745f 7377 6170 2061 6e64 2061 6d6f  ast_swap and amo
+00003d90: 756e 745f 6f75 745f 6d69 6e20 6973 206e  unt_out_min is n
+00003da0: 6f74 204e 6f6e 6520 616e 6420 5f61 6d6f  ot None and _amo
+00003db0: 756e 745f 6f75 7420 3c20 616d 6f75 6e74  unt_out < amount
+00003dc0: 5f6f 7574 5f6d 696e 3a0a 2020 2020 2020  _out_min:.      
+00003dd0: 2020 2020 2020 7261 6973 6520 5472 616e        raise Tran
+00003de0: 7361 6374 696f 6e45 7272 6f72 280a 2020  sactionError(.  
+00003df0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00003e00: 496e 7375 6666 6963 6965 6e74 206f 7574  Insufficient out
+00003e10: 7075 7420 666f 7220 7377 6170 2120 7b5f  put for swap! {_
+00003e20: 616d 6f75 6e74 5f6f 7574 7d20 7b74 6f6b  amount_out} {tok
+00003e30: 656e 5f6f 7574 7d20 7265 6365 6976 6564  en_out} received
+00003e40: 2c20 7b61 6d6f 756e 745f 6f75 745f 6d69  , {amount_out_mi
+00003e50: 6e7d 2072 6571 7569 7265 6422 0a20 2020  n} required".   
+00003e60: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00003e70: 2020 2020 6966 206e 6f74 2073 696c 656e      if not silen
+00003e80: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+00003e90: 656c 662e 5f73 686f 775f 706f 6f6c 5f73  elf._show_pool_s
+00003ea0: 7461 7465 7328 706f 6f6c 2c20 7369 6d5f  tates(pool, sim_
+00003eb0: 7265 7375 6c74 290a 0a20 2020 2020 2020  result)..       
+00003ec0: 2072 6574 7572 6e20 706f 6f6c 2c20 7369   return pool, si
+00003ed0: 6d5f 7265 7375 6c74 0a0a 2020 2020 6465  m_result..    de
+00003ee0: 6620 5f73 696d 756c 6174 655f 7632 5f61  f _simulate_v2_a
+00003ef0: 6464 5f6c 6971 7569 6469 7479 280a 2020  dd_liquidity(.  
+00003f00: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00003f10: 2020 2020 706f 6f6c 3a20 4c69 7175 6964      pool: Liquid
+00003f20: 6974 7950 6f6f 6c2c 0a20 2020 2020 2020  ityPool,.       
+00003f30: 2061 6464 6564 5f72 6573 6572 7665 735f   added_reserves_
+00003f40: 746f 6b65 6e30 3a20 696e 742c 0a20 2020  token0: int,.   
+00003f50: 2020 2020 2061 6464 6564 5f72 6573 6572       added_reser
+00003f60: 7665 735f 746f 6b65 6e31 3a20 696e 742c  ves_token1: int,
+00003f70: 0a20 2020 2020 2020 206f 7665 7272 6964  .        overrid
+00003f80: 655f 7374 6174 653a 2055 6e69 7377 6170  e_state: Uniswap
+00003f90: 5632 506f 6f6c 5374 6174 6520 7c20 4e6f  V2PoolState | No
+00003fa0: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+00003fb0: 202d 3e20 556e 6973 7761 7056 3250 6f6f   -> UniswapV2Poo
+00003fc0: 6c53 696d 756c 6174 696f 6e52 6573 756c  lSimulationResul
+00003fd0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+00003fe0: 6e20 706f 6f6c 2e73 696d 756c 6174 655f  n pool.simulate_
+00003ff0: 6164 645f 6c69 7175 6964 6974 7928 0a20  add_liquidity(. 
+00004000: 2020 2020 2020 2020 2020 2061 6464 6564             added
+00004010: 5f72 6573 6572 7665 735f 746f 6b65 6e30  _reserves_token0
+00004020: 3d61 6464 6564 5f72 6573 6572 7665 735f  =added_reserves_
+00004030: 746f 6b65 6e30 2c0a 2020 2020 2020 2020  token0,.        
+00004040: 2020 2020 6164 6465 645f 7265 7365 7276      added_reserv
+00004050: 6573 5f74 6f6b 656e 313d 6164 6465 645f  es_token1=added_
+00004060: 7265 7365 7276 6573 5f74 6f6b 656e 312c  reserves_token1,
+00004070: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
+00004080: 7272 6964 655f 7374 6174 653d 6f76 6572  rride_state=over
+00004090: 7269 6465 5f73 7461 7465 2c0a 2020 2020  ride_state,.    
+000040a0: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+000040b0: 7369 6d75 6c61 7465 5f76 325f 7377 6170  simulate_v2_swap
+000040c0: 5f65 7861 6374 5f6f 7574 280a 2020 2020  _exact_out(.    
+000040d0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000040e0: 2020 706f 6f6c 3a20 4c69 7175 6964 6974    pool: Liquidit
+000040f0: 7950 6f6f 6c2c 0a20 2020 2020 2020 2072  yPool,.        r
+00004100: 6563 6970 6965 6e74 3a20 4368 6563 6b73  ecipient: Checks
+00004110: 756d 4164 6472 6573 7320 7c20 7374 722c  umAddress | str,
+00004120: 0a20 2020 2020 2020 2074 6f6b 656e 5f69  .        token_i
+00004130: 6e3a 2045 7263 3230 546f 6b65 6e2c 0a20  n: Erc20Token,. 
+00004140: 2020 2020 2020 2061 6d6f 756e 745f 6f75         amount_ou
+00004150: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
+00004160: 616d 6f75 6e74 5f69 6e5f 6d61 783a 2069  amount_in_max: i
+00004170: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+00004180: 2c0a 2020 2020 2020 2020 6669 7273 745f  ,.        first_
+00004190: 7377 6170 3a20 626f 6f6c 203d 2046 616c  swap: bool = Fal
+000041a0: 7365 2c0a 2020 2020 2920 2d3e 2054 7570  se,.    ) -> Tup
+000041b0: 6c65 5b4c 6971 7569 6469 7479 506f 6f6c  le[LiquidityPool
+000041c0: 2c20 556e 6973 7761 7056 3250 6f6f 6c53  , UniswapV2PoolS
+000041d0: 696d 756c 6174 696f 6e52 6573 756c 745d  imulationResult]
+000041e0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+000041f0: 2069 7369 6e73 7461 6e63 6528 706f 6f6c   isinstance(pool
+00004200: 2c20 4c69 7175 6964 6974 7950 6f6f 6c29  , LiquidityPool)
+00004210: 2c20 6622 4361 6c6c 6564 205f 7369 6d75  , f"Called _simu
+00004220: 6c61 7465 5f76 325f 7377 6170 5f65 7861  late_v2_swap_exa
+00004230: 6374 5f6f 7574 206f 6e20 706f 6f6c 207b  ct_out on pool {
+00004240: 706f 6f6c 7d22 0a0a 2020 2020 2020 2020  pool}"..        
+00004250: 7369 6c65 6e74 203d 2073 656c 662e 7369  silent = self.si
+00004260: 6c65 6e74 0a0a 2020 2020 2020 2020 6966  lent..        if
+00004270: 2074 6f6b 656e 5f69 6e20 6e6f 7420 696e   token_in not in
+00004280: 2070 6f6f 6c2e 746f 6b65 6e73 3a0a 2020   pool.tokens:.  
+00004290: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000042a0: 5661 6c75 6545 7272 6f72 2866 2254 6f6b  ValueError(f"Tok
+000042b0: 656e 207b 746f 6b65 6e5f 696e 7d20 6e6f  en {token_in} no
+000042c0: 7420 666f 756e 6420 696e 2070 6f6f 6c20  t found in pool 
+000042d0: 7b70 6f6f 6c7d 2229 0a0a 2020 2020 2020  {pool}")..      
+000042e0: 2020 746f 6b65 6e5f 6f75 7420 3d20 706f    token_out = po
+000042f0: 6f6c 2e74 6f6b 656e 3120 6966 2074 6f6b  ol.token1 if tok
+00004300: 656e 5f69 6e20 3d3d 2070 6f6f 6c2e 746f  en_in == pool.to
+00004310: 6b65 6e30 2065 6c73 6520 706f 6f6c 2e74  ken0 else pool.t
+00004320: 6f6b 656e 300a 0a20 2020 2020 2020 2073  oken0..        s
+00004330: 696d 5f72 6573 756c 7420 3d20 706f 6f6c  im_result = pool
+00004340: 2e73 696d 756c 6174 655f 6578 6163 745f  .simulate_exact_
+00004350: 6f75 7470 7574 5f73 7761 7028 0a20 2020  output_swap(.   
+00004360: 2020 2020 2020 2020 2074 6f6b 656e 5f6f           token_o
+00004370: 7574 3d74 6f6b 656e 5f6f 7574 2c0a 2020  ut=token_out,.  
+00004380: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+00004390: 6f75 745f 7175 616e 7469 7479 3d61 6d6f  out_quantity=amo
+000043a0: 756e 745f 6f75 742c 0a20 2020 2020 2020  unt_out,.       
+000043b0: 2029 0a0a 2020 2020 2020 2020 5f61 6d6f   )..        _amo
+000043c0: 756e 745f 696e 203d 206d 6178 280a 2020  unt_in = max(.  
+000043d0: 2020 2020 2020 2020 2020 7369 6d5f 7265            sim_re
+000043e0: 7375 6c74 2e61 6d6f 756e 7430 5f64 656c  sult.amount0_del
+000043f0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00004400: 7369 6d5f 7265 7375 6c74 2e61 6d6f 756e  sim_result.amoun
+00004410: 7431 5f64 656c 7461 2c0a 2020 2020 2020  t1_delta,.      
+00004420: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+00004430: 6669 7273 745f 7377 6170 3a0a 2020 2020  first_swap:.    
+00004440: 2020 2020 2020 2020 2320 7472 616e 7366          # transf
+00004450: 6572 2074 6865 2069 6e70 7574 2074 6f6b  er the input tok
+00004460: 656e 2061 6d6f 756e 7420 6672 6f6d 2074  en amount from t
+00004470: 6865 2073 656e 6465 7220 746f 2074 6865  he sender to the
+00004480: 2066 6972 7374 2070 6f6f 6c0a 2020 2020   first pool.    
+00004490: 2020 2020 2020 2020 7365 6c66 2e6c 6564          self.led
+000044a0: 6765 722e 7472 616e 7366 6572 280a 2020  ger.transfer(.  
+000044b0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000044c0: 6b65 6e3d 746f 6b65 6e5f 696e 2e61 6464  ken=token_in.add
+000044d0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+000044e0: 2020 2020 2020 616d 6f75 6e74 3d5f 616d        amount=_am
+000044f0: 6f75 6e74 5f69 6e2c 0a20 2020 2020 2020  ount_in,.       
+00004500: 2020 2020 2020 2020 2066 726f 6d5f 6164           from_ad
+00004510: 6472 3d73 656c 662e 7365 6e64 6572 2c0a  dr=self.sender,.
+00004520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004530: 746f 5f61 6464 723d 706f 6f6c 2e61 6464  to_addr=pool.add
+00004540: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+00004550: 2020 290a 0a20 2020 2020 2020 2023 2070    )..        # p
+00004560: 726f 6365 7373 2074 6865 2073 7761 700a  rocess the swap.
+00004570: 2020 2020 2020 2020 7365 6c66 2e6c 6564          self.led
+00004580: 6765 722e 6164 6a75 7374 2870 6f6f 6c2e  ger.adjust(pool.
+00004590: 6164 6472 6573 732c 2074 6f6b 656e 5f69  address, token_i
+000045a0: 6e2e 6164 6472 6573 732c 202d 5f61 6d6f  n.address, -_amo
+000045b0: 756e 745f 696e 290a 2020 2020 2020 2020  unt_in).        
+000045c0: 7365 6c66 2e6c 6564 6765 722e 6164 6a75  self.ledger.adju
+000045d0: 7374 2870 6f6f 6c2e 6164 6472 6573 732c  st(pool.address,
+000045e0: 2074 6f6b 656e 5f6f 7574 2e61 6464 7265   token_out.addre
+000045f0: 7373 2c20 616d 6f75 6e74 5f6f 7574 290a  ss, amount_out).
+00004600: 0a20 2020 2020 2020 2023 2074 7261 6e73  .        # trans
+00004610: 6665 7220 7468 6520 6f75 7470 7574 2074  fer the output t
+00004620: 6f6b 656e 2066 726f 6d20 7468 6520 706f  oken from the po
+00004630: 6f6c 2074 6f20 7468 6520 7265 6369 7069  ol to the recipi
+00004640: 656e 740a 2020 2020 2020 2020 7365 6c66  ent.        self
+00004650: 2e6c 6564 6765 722e 7472 616e 7366 6572  .ledger.transfer
+00004660: 280a 2020 2020 2020 2020 2020 2020 746f  (.            to
+00004670: 6b65 6e3d 746f 6b65 6e5f 6f75 742e 6164  ken=token_out.ad
+00004680: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
+00004690: 2020 2061 6d6f 756e 743d 616d 6f75 6e74     amount=amount
+000046a0: 5f6f 7574 2c0a 2020 2020 2020 2020 2020  _out,.          
+000046b0: 2020 6672 6f6d 5f61 6464 723d 706f 6f6c    from_addr=pool
+000046c0: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+000046d0: 2020 2020 2020 746f 5f61 6464 723d 7265        to_addr=re
+000046e0: 6369 7069 656e 742c 0a20 2020 2020 2020  cipient,.       
+000046f0: 2029 0a0a 2020 2020 2020 2020 6966 2066   )..        if f
+00004700: 6972 7374 5f73 7761 7020 616e 6420 616d  irst_swap and am
+00004710: 6f75 6e74 5f69 6e5f 6d61 7820 6973 206e  ount_in_max is n
+00004720: 6f74 204e 6f6e 6520 616e 6420 5f61 6d6f  ot None and _amo
+00004730: 756e 745f 696e 203e 2061 6d6f 756e 745f  unt_in > amount_
+00004740: 696e 5f6d 6178 3a0a 2020 2020 2020 2020  in_max:.        
+00004750: 2020 2020 7261 6973 6520 5472 616e 7361      raise Transa
+00004760: 6374 696f 6e45 7272 6f72 2866 2252 6571  ctionError(f"Req
+00004770: 7569 7265 6420 696e 7075 7420 7b5f 616d  uired input {_am
+00004780: 6f75 6e74 5f69 6e7d 2065 7863 6565 6473  ount_in} exceeds
+00004790: 206d 6178 696d 756d 207b 616d 6f75 6e74   maximum {amount
+000047a0: 5f69 6e5f 6d61 787d 2229 0a0a 2020 2020  _in_max}")..    
+000047b0: 2020 2020 6966 206e 6f74 2073 696c 656e      if not silen
+000047c0: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+000047d0: 656c 662e 5f73 686f 775f 706f 6f6c 5f73  elf._show_pool_s
+000047e0: 7461 7465 7328 706f 6f6c 2c20 7369 6d5f  tates(pool, sim_
+000047f0: 7265 7375 6c74 290a 0a20 2020 2020 2020  result)..       
+00004800: 2072 6574 7572 6e20 706f 6f6c 2c20 7369   return pool, si
+00004810: 6d5f 7265 7375 6c74 0a0a 2020 2020 6465  m_result..    de
+00004820: 6620 5f73 696d 756c 6174 655f 7633 5f73  f _simulate_v3_s
+00004830: 7761 705f 6578 6163 745f 696e 280a 2020  wap_exact_in(.  
+00004840: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00004850: 2020 2020 706f 6f6c 3a20 5633 4c69 7175      pool: V3Liqu
+00004860: 6964 6974 7950 6f6f 6c2c 0a20 2020 2020  idityPool,.     
+00004870: 2020 2072 6563 6970 6965 6e74 3a20 7374     recipient: st
+00004880: 722c 0a20 2020 2020 2020 2074 6f6b 656e  r,.        token
+00004890: 5f69 6e3a 2045 7263 3230 546f 6b65 6e2c  _in: Erc20Token,
+000048a0: 0a20 2020 2020 2020 2061 6d6f 756e 745f  .        amount_
+000048b0: 696e 3a20 696e 742c 0a20 2020 2020 2020  in: int,.       
+000048c0: 2061 6d6f 756e 745f 6f75 745f 6d69 6e3a   amount_out_min:
+000048d0: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
+000048e0: 6e65 2c0a 2020 2020 2020 2020 7371 7274  ne,.        sqrt
+000048f0: 5f70 7269 6365 5f6c 696d 6974 5f78 3936  _price_limit_x96
+00004900: 3a20 696e 7420 7c20 4e6f 6e65 203d 204e  : int | None = N
+00004910: 6f6e 652c 0a20 2020 2020 2020 2066 6972  one,.        fir
+00004920: 7374 5f73 7761 703a 2062 6f6f 6c20 3d20  st_swap: bool = 
+00004930: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
+00004940: 5475 706c 655b 5633 4c69 7175 6964 6974  Tuple[V3Liquidit
+00004950: 7950 6f6f 6c2c 2055 6e69 7377 6170 5633  yPool, UniswapV3
+00004960: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
+00004970: 7375 6c74 5d3a 0a20 2020 2020 2020 2061  sult]:.        a
+00004980: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00004990: 280a 2020 2020 2020 2020 2020 2020 706f  (.            po
+000049a0: 6f6c 2c20 5633 4c69 7175 6964 6974 7950  ol, V3LiquidityP
+000049b0: 6f6f 6c0a 2020 2020 2020 2020 292c 2066  ool.        ), f
+000049c0: 2243 616c 6c65 6420 5f73 696d 756c 6174  "Called _simulat
+000049d0: 655f 7633 5f73 7761 705f 6578 6163 745f  e_v3_swap_exact_
+000049e0: 696e 206f 6e20 706f 6f6c 207b 706f 6f6c  in on pool {pool
+000049f0: 7d22 0a0a 2020 2020 2020 2020 7369 6c65  }"..        sile
+00004a00: 6e74 203d 2073 656c 662e 7369 6c65 6e74  nt = self.silent
+00004a10: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00004a20: 6563 6970 6965 6e74 732e 6164 6428 746f  ecipients.add(to
+00004a30: 5f63 6865 636b 7375 6d5f 6164 6472 6573  _checksum_addres
+00004a40: 7328 7265 6369 7069 656e 7429 290a 0a20  s(recipient)).. 
+00004a50: 2020 2020 2020 2069 6620 746f 6b65 6e5f         if token_
+00004a60: 696e 206e 6f74 2069 6e20 706f 6f6c 2e74  in not in pool.t
+00004a70: 6f6b 656e 733a 0a20 2020 2020 2020 2020  okens:.         
+00004a80: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00004a90: 726f 7228 6622 546f 6b65 6e20 7b74 6f6b  ror(f"Token {tok
+00004aa0: 656e 5f69 6e7d 206e 6f74 2066 6f75 6e64  en_in} not found
+00004ab0: 2069 6e20 706f 6f6c 207b 706f 6f6c 7d22   in pool {pool}"
+00004ac0: 290a 0a20 2020 2020 2020 2074 6f6b 656e  )..        token
+00004ad0: 5f6f 7574 203d 2070 6f6f 6c2e 746f 6b65  _out = pool.toke
+00004ae0: 6e31 2069 6620 746f 6b65 6e5f 696e 203d  n1 if token_in =
+00004af0: 3d20 706f 6f6c 2e74 6f6b 656e 3020 656c  = pool.token0 el
+00004b00: 7365 2070 6f6f 6c2e 746f 6b65 6e30 0a0a  se pool.token0..
+00004b10: 2020 2020 2020 2020 6966 2061 6d6f 756e          if amoun
+00004b20: 745f 696e 2069 6e20 280a 2020 2020 2020  t_in in (.      
+00004b30: 2020 2020 2020 556e 6976 6572 7361 6c52        UniversalR
+00004b40: 6f75 7465 7253 7065 6369 616c 5661 6c75  outerSpecialValu
+00004b50: 6573 2e55 5345 5f43 4f4e 5452 4143 545f  es.USE_CONTRACT_
+00004b60: 4241 4c41 4e43 452c 0a20 2020 2020 2020  BALANCE,.       
+00004b70: 2020 2020 2056 3352 6f75 7465 7253 7065       V3RouterSpe
+00004b80: 6369 616c 5661 6c75 6573 2e55 5345 5f43  cialValues.USE_C
+00004b90: 4f4e 5452 4143 545f 4241 4c41 4e43 452c  ONTRACT_BALANCE,
+00004ba0: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+00004bb0: 2020 2020 2020 2020 616d 6f75 6e74 5f69          amount_i
+00004bc0: 6e20 3d20 7365 6c66 2e6c 6564 6765 722e  n = self.ledger.
+00004bd0: 746f 6b65 6e5f 6261 6c61 6e63 6528 7365  token_balance(se
+00004be0: 6c66 2e72 6f75 7465 725f 6164 6472 6573  lf.router_addres
+00004bf0: 732c 2074 6f6b 656e 5f69 6e2e 6164 6472  s, token_in.addr
+00004c00: 6573 7329 0a0a 2020 2020 2020 2020 2320  ess)..        # 
+00004c10: 7468 6520 7377 6170 206d 6179 206f 6363  the swap may occ
+00004c20: 7572 2061 6674 6572 2077 7261 7070 696e  ur after wrappin
+00004c30: 6720 4554 482c 2069 6e20 7768 6963 6820  g ETH, in which 
+00004c40: 6361 7365 2061 6d6f 756e 7449 6e20 7769  case amountIn wi
+00004c50: 6c6c 0a20 2020 2020 2020 2023 2062 6520  ll.        # be 
+00004c60: 616c 7265 6164 7920 7365 742e 2049 6620  already set. If 
+00004c70: 6e6f 742c 2063 7265 6469 7420 7468 6520  not, credit the 
+00004c80: 726f 7574 6572 2028 7573 6572 2074 7261  router (user tra
+00004c90: 6e73 6665 7273 2074 6865 2069 6e70 7574  nsfers the input
+00004ca0: 290a 2020 2020 2020 2020 6966 2066 6972  ).        if fir
+00004cb0: 7374 5f73 7761 7020 616e 6420 6e6f 7420  st_swap and not 
+00004cc0: 7365 6c66 2e6c 6564 6765 722e 746f 6b65  self.ledger.toke
+00004cd0: 6e5f 6261 6c61 6e63 6528 7365 6c66 2e72  n_balance(self.r
+00004ce0: 6f75 7465 725f 6164 6472 6573 732c 2074  outer_address, t
+00004cf0: 6f6b 656e 5f69 6e2e 6164 6472 6573 7329  oken_in.address)
+00004d00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00004d10: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
+00004d20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004d30: 2020 7365 6c66 2e72 6f75 7465 725f 6164    self.router_ad
+00004d40: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
+00004d50: 2020 2020 2020 2074 6f6b 656e 5f69 6e2e         token_in.
+00004d60: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+00004d70: 2020 2020 2020 2020 2061 6d6f 756e 745f           amount_
+00004d80: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00004d90: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
+00004da0: 2020 2020 2020 2020 2020 2020 5f73 696d              _sim
+00004db0: 5f72 6573 756c 7420 3d20 706f 6f6c 2e73  _result = pool.s
+00004dc0: 696d 756c 6174 655f 6578 6163 745f 696e  imulate_exact_in
+00004dd0: 7075 745f 7377 6170 280a 2020 2020 2020  put_swap(.      
+00004de0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+00004df0: 696e 3d74 6f6b 656e 5f69 6e2c 0a20 2020  in=token_in,.   
+00004e00: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+00004e10: 656e 5f69 6e5f 7175 616e 7469 7479 3d61  en_in_quantity=a
+00004e20: 6d6f 756e 745f 696e 2c0a 2020 2020 2020  mount_in,.      
+00004e30: 2020 2020 2020 2020 2020 7371 7274 5f70            sqrt_p
+00004e40: 7269 6365 5f6c 696d 6974 5f78 3936 3d73  rice_limit_x96=s
+00004e50: 7172 745f 7072 6963 655f 6c69 6d69 745f  qrt_price_limit_
+00004e60: 7839 362c 0a20 2020 2020 2020 2020 2020  x96,.           
+00004e70: 2029 0a20 2020 2020 2020 2065 7863 6570   ).        excep
+00004e80: 7420 4556 4d52 6576 6572 7445 7272 6f72  t EVMRevertError
+00004e90: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00004ea0: 2020 2072 6169 7365 2054 7261 6e73 6163     raise Transac
+00004eb0: 7469 6f6e 4572 726f 7228 6622 5633 2072  tionError(f"V3 r
+00004ec0: 6576 6572 743a 207b 657d 2229 0a0a 2020  evert: {e}")..  
+00004ed0: 2020 2020 2020 5f61 6d6f 756e 745f 6f75        _amount_ou
+00004ee0: 7420 3d20 2d6d 696e 280a 2020 2020 2020  t = -min(.      
+00004ef0: 2020 2020 2020 5f73 696d 5f72 6573 756c        _sim_resul
+00004f00: 742e 616d 6f75 6e74 305f 6465 6c74 612c  t.amount0_delta,
+00004f10: 0a20 2020 2020 2020 2020 2020 205f 7369  .            _si
+00004f20: 6d5f 7265 7375 6c74 2e61 6d6f 756e 7431  m_result.amount1
+00004f30: 5f64 656c 7461 2c0a 2020 2020 2020 2020  _delta,.        
+00004f40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00004f50: 6c65 6467 6572 2e61 646a 7573 7428 0a20  ledger.adjust(. 
+00004f60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00004f70: 726f 7574 6572 5f61 6464 7265 7373 2c0a  router_address,.
+00004f80: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
+00004f90: 6e5f 696e 2e61 6464 7265 7373 2c0a 2020  n_in.address,.  
+00004fa0: 2020 2020 2020 2020 2020 2d61 6d6f 756e            -amoun
+00004fb0: 745f 696e 2c0a 2020 2020 2020 2020 290a  t_in,.        ).
+00004fc0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+00004fd0: 6465 6275 6728 6622 7b72 6563 6970 6965  debug(f"{recipie
+00004fe0: 6e74 3d7d 2229 0a20 2020 2020 2020 206d  nt=}").        m
+00004ff0: 6174 6368 2072 6563 6970 6965 6e74 3a0a  atch recipient:.
+00005000: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00005010: 2055 6e69 7665 7273 616c 526f 7574 6572   UniversalRouter
+00005020: 5370 6563 6961 6c41 6464 7265 7373 2e4d  SpecialAddress.M
+00005030: 5347 5f53 454e 4445 523a 0a20 2020 2020  SG_SENDER:.     
+00005040: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+00005050: 6965 6e74 203d 2073 656c 662e 7365 6e64  ient = self.send
+00005060: 6572 0a20 2020 2020 2020 2020 2020 2063  er.            c
+00005070: 6173 6520 280a 2020 2020 2020 2020 2020  ase (.          
+00005080: 2020 2020 2020 556e 6976 6572 7361 6c52        UniversalR
+00005090: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
+000050a0: 6573 732e 524f 5554 4552 0a20 2020 2020  ess.ROUTER.     
+000050b0: 2020 2020 2020 2020 2020 207c 2056 3352             | V3R
+000050c0: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
+000050d0: 6573 732e 524f 5554 4552 5f31 0a20 2020  ess.ROUTER_1.   
+000050e0: 2020 2020 2020 2020 2020 2020 207c 2056               | V
+000050f0: 3352 6f75 7465 7253 7065 6369 616c 4164  3RouterSpecialAd
+00005100: 6472 6573 732e 524f 5554 4552 5f32 0a20  dress.ROUTER_2. 
+00005110: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
+00005120: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00005130: 6369 7069 656e 7420 3d20 7365 6c66 2e72  cipient = self.r
+00005140: 6f75 7465 725f 6164 6472 6573 730a 2020  outer_address.  
+00005150: 2020 2020 2020 2020 2020 6361 7365 205f            case _
+00005160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005170: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+00005180: 7365 6c66 2e6c 6564 6765 722e 6164 6a75  self.ledger.adju
+00005190: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+000051a0: 7265 6369 7069 656e 742c 0a20 2020 2020  recipient,.     
+000051b0: 2020 2020 2020 2074 6f6b 656e 5f6f 7574         token_out
+000051c0: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+000051d0: 2020 2020 2020 5f61 6d6f 756e 745f 6f75        _amount_ou
+000051e0: 742c 0a20 2020 2020 2020 2029 0a0a 2020  t,.        )..  
+000051f0: 2020 2020 2020 6966 2061 6d6f 756e 745f        if amount_
+00005200: 6f75 745f 6d69 6e20 6973 206e 6f74 204e  out_min is not N
+00005210: 6f6e 6520 616e 6420 5f61 6d6f 756e 745f  one and _amount_
+00005220: 6f75 7420 3c20 616d 6f75 6e74 5f6f 7574  out < amount_out
+00005230: 5f6d 696e 3a0a 2020 2020 2020 2020 2020  _min:.          
+00005240: 2020 7261 6973 6520 5472 616e 7361 6374    raise Transact
+00005250: 696f 6e45 7272 6f72 280a 2020 2020 2020  ionError(.      
+00005260: 2020 2020 2020 2020 2020 6622 496e 7375            f"Insu
+00005270: 6666 6963 6965 6e74 206f 7574 7075 7420  fficient output 
+00005280: 666f 7220 7377 6170 2120 7b5f 616d 6f75  for swap! {_amou
+00005290: 6e74 5f6f 7574 7d20 7b74 6f6b 656e 5f6f  nt_out} {token_o
+000052a0: 7574 7d20 7265 6365 6976 6564 2c20 7b61  ut} received, {a
+000052b0: 6d6f 756e 745f 6f75 745f 6d69 6e7d 2072  mount_out_min} r
+000052c0: 6571 7569 7265 6422 0a20 2020 2020 2020  equired".       
+000052d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000052e0: 6966 206e 6f74 2073 696c 656e 743a 0a20  if not silent:. 
+000052f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00005300: 5f73 686f 775f 706f 6f6c 5f73 7461 7465  _show_pool_state
+00005310: 7328 706f 6f6c 2c20 5f73 696d 5f72 6573  s(pool, _sim_res
+00005320: 756c 7429 0a0a 2020 2020 2020 2020 7265  ult)..        re
+00005330: 7475 726e 2070 6f6f 6c2c 205f 7369 6d5f  turn pool, _sim_
+00005340: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
+00005350: 5f73 696d 756c 6174 655f 7633 5f73 7761  _simulate_v3_swa
+00005360: 705f 6578 6163 745f 6f75 7428 0a20 2020  p_exact_out(.   
+00005370: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00005380: 2020 2070 6f6f 6c3a 2056 334c 6971 7569     pool: V3Liqui
+00005390: 6469 7479 506f 6f6c 2c0a 2020 2020 2020  dityPool,.      
+000053a0: 2020 7265 6369 7069 656e 743a 2073 7472    recipient: str
+000053b0: 2c0a 2020 2020 2020 2020 746f 6b65 6e5f  ,.        token_
+000053c0: 696e 3a20 4572 6332 3054 6f6b 656e 2c0a  in: Erc20Token,.
+000053d0: 2020 2020 2020 2020 616d 6f75 6e74 5f6f          amount_o
+000053e0: 7574 3a20 696e 742c 0a20 2020 2020 2020  ut: int,.       
+000053f0: 2061 6d6f 756e 745f 696e 5f6d 6178 3a20   amount_in_max: 
+00005400: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
+00005410: 652c 0a20 2020 2020 2020 2073 7172 745f  e,.        sqrt_
+00005420: 7072 6963 655f 6c69 6d69 745f 7839 363a  price_limit_x96:
+00005430: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
+00005440: 6e65 2c0a 2020 2020 2020 2020 6669 7273  ne,.        firs
+00005450: 745f 7377 6170 3a20 626f 6f6c 203d 2046  t_swap: bool = F
+00005460: 616c 7365 2c0a 2020 2020 2020 2020 6c61  alse,.        la
+00005470: 7374 5f73 7761 703a 2062 6f6f 6c20 3d20  st_swap: bool = 
+00005480: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
+00005490: 5475 706c 655b 5633 4c69 7175 6964 6974  Tuple[V3Liquidit
+000054a0: 7950 6f6f 6c2c 2055 6e69 7377 6170 5633  yPool, UniswapV3
+000054b0: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
+000054c0: 7375 6c74 5d3a 0a20 2020 2020 2020 2061  sult]:.        a
+000054d0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000054e0: 280a 2020 2020 2020 2020 2020 2020 706f  (.            po
+000054f0: 6f6c 2c20 5633 4c69 7175 6964 6974 7950  ol, V3LiquidityP
+00005500: 6f6f 6c0a 2020 2020 2020 2020 292c 2066  ool.        ), f
+00005510: 2243 616c 6c65 6420 5f73 696d 756c 6174  "Called _simulat
+00005520: 655f 7633 5f73 7761 705f 6578 6163 745f  e_v3_swap_exact_
+00005530: 6f75 7420 6f6e 2070 6f6f 6c20 7b70 6f6f  out on pool {poo
+00005540: 6c7d 220a 0a20 2020 2020 2020 2073 696c  l}"..        sil
+00005550: 656e 7420 3d20 7365 6c66 2e73 696c 656e  ent = self.silen
+00005560: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+00005570: 7265 6369 7069 656e 7473 2e61 6464 2874  recipients.add(t
+00005580: 6f5f 6368 6563 6b73 756d 5f61 6464 7265  o_checksum_addre
+00005590: 7373 2872 6563 6970 6965 6e74 2929 0a0a  ss(recipient))..
+000055a0: 2020 2020 2020 2020 6966 2074 6f6b 656e          if token
+000055b0: 5f69 6e20 6e6f 7420 696e 2070 6f6f 6c2e  _in not in pool.
+000055c0: 746f 6b65 6e73 3a0a 2020 2020 2020 2020  tokens:.        
+000055d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000055e0: 7272 6f72 2866 2254 6f6b 656e 207b 746f  rror(f"Token {to
+000055f0: 6b65 6e5f 696e 7d20 6e6f 7420 666f 756e  ken_in} not foun
+00005600: 6420 696e 2070 6f6f 6c20 7b70 6f6f 6c7d  d in pool {pool}
+00005610: 2229 0a0a 2020 2020 2020 2020 746f 6b65  ")..        toke
+00005620: 6e5f 6f75 7420 3d20 706f 6f6c 2e74 6f6b  n_out = pool.tok
+00005630: 656e 3120 6966 2074 6f6b 656e 5f69 6e20  en1 if token_in 
+00005640: 3d3d 2070 6f6f 6c2e 746f 6b65 6e30 2065  == pool.token0 e
+00005650: 6c73 6520 706f 6f6c 2e74 6f6b 656e 300a  lse pool.token0.
+00005660: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00005670: 2020 2020 2020 2020 2020 5f73 696d 5f72            _sim_r
+00005680: 6573 756c 7420 3d20 706f 6f6c 2e73 696d  esult = pool.sim
+00005690: 756c 6174 655f 6578 6163 745f 6f75 7470  ulate_exact_outp
+000056a0: 7574 5f73 7761 7028 0a20 2020 2020 2020  ut_swap(.       
+000056b0: 2020 2020 2020 2020 2074 6f6b 656e 5f6f           token_o
+000056c0: 7574 3d74 6f6b 656e 5f6f 7574 2c0a 2020  ut=token_out,.  
+000056d0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000056e0: 6b65 6e5f 6f75 745f 7175 616e 7469 7479  ken_out_quantity
+000056f0: 3d61 6d6f 756e 745f 6f75 742c 0a20 2020  =amount_out,.   
+00005700: 2020 2020 2020 2020 2020 2020 2073 7172               sqr
+00005710: 745f 7072 6963 655f 6c69 6d69 745f 7839  t_price_limit_x9
+00005720: 363d 7371 7274 5f70 7269 6365 5f6c 696d  6=sqrt_price_lim
+00005730: 6974 5f78 3936 2c0a 2020 2020 2020 2020  it_x96,.        
+00005740: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+00005750: 6365 7074 2045 564d 5265 7665 7274 4572  cept EVMRevertEr
+00005760: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+00005770: 2020 2020 2020 7261 6973 6520 5472 616e        raise Tran
+00005780: 7361 6374 696f 6e45 7272 6f72 2866 2256  sactionError(f"V
+00005790: 3320 7265 7665 7274 3a20 7b65 7d22 290a  3 revert: {e}").
+000057a0: 0a20 2020 2020 2020 205f 616d 6f75 6e74  .        _amount
+000057b0: 5f69 6e20 3d20 6d61 7828 0a20 2020 2020  _in = max(.     
+000057c0: 2020 2020 2020 205f 7369 6d5f 7265 7375         _sim_resu
+000057d0: 6c74 2e61 6d6f 756e 7430 5f64 656c 7461  lt.amount0_delta
+000057e0: 2c0a 2020 2020 2020 2020 2020 2020 5f73  ,.            _s
+000057f0: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
+00005800: 315f 6465 6c74 612c 0a20 2020 2020 2020  1_delta,.       
+00005810: 2029 0a20 2020 2020 2020 205f 616d 6f75   ).        _amou
+00005820: 6e74 5f6f 7574 203d 202d 6d69 6e28 0a20  nt_out = -min(. 
+00005830: 2020 2020 2020 2020 2020 205f 7369 6d5f             _sim_
+00005840: 7265 7375 6c74 2e61 6d6f 756e 7430 5f64  result.amount0_d
+00005850: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
+00005860: 2020 5f73 696d 5f72 6573 756c 742e 616d    _sim_result.am
+00005870: 6f75 6e74 315f 6465 6c74 612c 0a20 2020  ount1_delta,.   
+00005880: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00005890: 2320 6164 6a75 7374 2074 6865 2070 6f73  # adjust the pos
+000058a0: 742d 7377 6170 2062 616c 616e 6365 7320  t-swap balances 
+000058b0: 666f 7220 6561 6368 2074 6f6b 656e 0a20  for each token. 
+000058c0: 2020 2020 2020 2073 656c 662e 6c65 6467         self.ledg
+000058d0: 6572 2e61 646a 7573 7428 0a20 2020 2020  er.adjust(.     
+000058e0: 2020 2020 2020 2073 656c 662e 726f 7574         self.rout
+000058f0: 6572 5f61 6464 7265 7373 2c0a 2020 2020  er_address,.    
+00005900: 2020 2020 2020 2020 746f 6b65 6e5f 696e          token_in
+00005910: 2c0a 2020 2020 2020 2020 2020 2020 2d5f  ,.            -_
+00005920: 616d 6f75 6e74 5f69 6e2c 0a20 2020 2020  amount_in,.     
+00005930: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00005940: 662e 6c65 6467 6572 2e61 646a 7573 7428  f.ledger.adjust(
+00005950: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00005960: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
+00005970: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+00005980: 6b65 6e5f 6f75 742c 0a20 2020 2020 2020  ken_out,.       
+00005990: 2020 2020 205f 616d 6f75 6e74 5f6f 7574       _amount_out
+000059a0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000059b0: 2020 2020 2069 6620 6669 7273 745f 7377       if first_sw
+000059c0: 6170 3a0a 2020 2020 2020 2020 2020 2020  ap:.            
+000059d0: 2320 4578 6163 7420 6f75 7470 7574 2073  # Exact output s
+000059e0: 7761 7073 2070 726f 6365 6564 2069 6e20  waps proceed in 
+000059f0: 7265 7665 7273 6520 6f72 6465 722c 2073  reverse order, s
+00005a00: 6f20 7468 6520 6c61 7374 0a20 2020 2020  o the last.     
+00005a10: 2020 2020 2020 2023 2069 7465 7261 7469         # iterati
+00005a20: 6f6e 2077 696c 6c20 7368 6f77 2061 206e  on will show a n
+00005a30: 6567 6174 6976 6520 6261 6c61 6e63 6520  egative balance 
+00005a40: 6f66 2074 6865 2069 6e70 7574 2074 6f6b  of the input tok
+00005a50: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
+00005a60: 2320 7768 6963 6820 6d75 7374 2062 6520  # which must be 
+00005a70: 6163 636f 756e 7465 6420 666f 722e 0a0a  accounted for...
+00005a80: 2020 2020 2020 2020 2020 2020 726f 7574              rout
+00005a90: 6572 5f69 6e70 7574 5f74 6f6b 656e 5f62  er_input_token_b
+00005aa0: 616c 616e 6365 203d 2073 656c 662e 6c65  alance = self.le
+00005ab0: 6467 6572 2e74 6f6b 656e 5f62 616c 616e  dger.token_balan
+00005ac0: 6365 2873 656c 662e 726f 7574 6572 5f61  ce(self.router_a
+00005ad0: 6464 7265 7373 2c20 746f 6b65 6e5f 696e  ddress, token_in
+00005ae0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00005af0: 2043 6865 636b 2066 6f72 2061 2062 616c   Check for a bal
+00005b00: 616e 6365 3a0a 2020 2020 2020 2020 2020  ance:.          
+00005b10: 2020 2320 2020 2d20 4966 207a 6572 6f20    #   - If zero 
+00005b20: 6f72 2070 6f73 6974 6976 652c 2074 616b  or positive, tak
+00005b30: 6520 6e6f 2061 6374 696f 6e0a 2020 2020  e no action.    
+00005b40: 2020 2020 2020 2020 2320 2020 2d20 4966          #   - If
+00005b50: 206e 6567 6174 6976 652c 2061 646a 7573   negative, adjus
+00005b60: 7420 7769 7468 2074 6865 2061 7373 756d  t with the assum
+00005b70: 7074 696f 6e20 7468 6520 7573 6572 2068  ption the user h
+00005b80: 6173 2070 6169 640a 2020 2020 2020 2020  as paid.        
+00005b90: 2020 2020 2320 2020 2020 7468 6174 2061      #     that a
+00005ba0: 6d6f 756e 7420 7769 7468 2074 6865 2074  mount with the t
+00005bb0: 7261 6e73 6163 7469 6f6e 2063 616c 6c0a  ransaction call.
+00005bc0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00005bd0: 6f75 7465 725f 696e 7075 745f 746f 6b65  outer_input_toke
+00005be0: 6e5f 6261 6c61 6e63 6520 3c20 303a 0a20  n_balance < 0:. 
+00005bf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005c00: 656c 662e 6c65 6467 6572 2e61 646a 7573  elf.ledger.adjus
+00005c10: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00005c20: 2020 2020 2020 2073 656c 662e 726f 7574         self.rout
+00005c30: 6572 5f61 6464 7265 7373 2c0a 2020 2020  er_address,.    
+00005c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c50: 746f 6b65 6e5f 696e 2c0a 2020 2020 2020  token_in,.      
+00005c60: 2020 2020 2020 2020 2020 2020 2020 5f61                _a
+00005c70: 6d6f 756e 745f 696e 2c0a 2020 2020 2020  mount_in,.      
+00005c80: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00005c90: 2020 2020 2020 2020 2069 6620 616d 6f75           if amou
+00005ca0: 6e74 5f69 6e5f 6d61 7820 6973 206e 6f74  nt_in_max is not
+00005cb0: 204e 6f6e 6520 616e 6420 616d 6f75 6e74   None and amount
+00005cc0: 5f69 6e5f 6d61 7820 3c20 5f61 6d6f 756e  _in_max < _amoun
+00005cd0: 745f 696e 3a0a 2020 2020 2020 2020 2020  t_in:.          
+00005ce0: 2020 2020 2020 7261 6973 6520 5472 616e        raise Tran
+00005cf0: 7361 6374 696f 6e45 7272 6f72 280a 2020  sactionError(.  
+00005d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d10: 2020 6622 496e 7375 6666 6963 6965 6e74    f"Insufficient
+00005d20: 2069 6e70 7574 2066 6f72 2065 7861 6374   input for exact
+00005d30: 206f 7574 7075 7420 7377 6170 2120 7b5f   output swap! {_
+00005d40: 616d 6f75 6e74 5f69 6e7d 207b 746f 6b65  amount_in} {toke
+00005d50: 6e5f 696e 7d20 7265 7175 6972 6564 2c20  n_in} required, 
+00005d60: 7b61 6d6f 756e 745f 696e 5f6d 6178 7d20  {amount_in_max} 
+00005d70: 7072 6f76 6964 6564 220a 2020 2020 2020  provided".      
+00005d80: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00005d90: 2020 2020 2069 6620 6c61 7374 5f73 7761       if last_swa
+00005da0: 703a 0a20 2020 2020 2020 2020 2020 206d  p:.            m
+00005db0: 6174 6368 2072 6563 6970 6965 6e74 3a0a  atch recipient:.
+00005dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005dd0: 6361 7365 2055 6e69 7665 7273 616c 526f  case UniversalRo
+00005de0: 7574 6572 5370 6563 6961 6c41 6464 7265  uterSpecialAddre
+00005df0: 7373 2e4d 5347 5f53 454e 4445 523a 0a20  ss.MSG_SENDER:. 
+00005e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e10: 2020 205f 7265 6369 7069 656e 7420 3d20     _recipient = 
+00005e20: 7365 6c66 2e73 656e 6465 720a 2020 2020  self.sender.    
+00005e30: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00005e40: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00005e50: 2020 2020 2020 2055 6e69 7665 7273 616c         Universal
+00005e60: 526f 7574 6572 5370 6563 6961 6c41 6464  RouterSpecialAdd
+00005e70: 7265 7373 2e52 4f55 5445 520a 2020 2020  ress.ROUTER.    
+00005e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e90: 7c20 5633 526f 7574 6572 5370 6563 6961  | V3RouterSpecia
+00005ea0: 6c41 6464 7265 7373 2e52 4f55 5445 525f  lAddress.ROUTER_
+00005eb0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00005ec0: 2020 2020 2020 7c20 5633 526f 7574 6572        | V3Router
+00005ed0: 5370 6563 6961 6c41 6464 7265 7373 2e52  SpecialAddress.R
+00005ee0: 4f55 5445 525f 320a 2020 2020 2020 2020  OUTER_2.        
+00005ef0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00005f00: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00005f10: 7265 6369 7069 656e 7420 3d20 7365 6c66  recipient = self
+00005f20: 2e72 6f75 7465 725f 6164 6472 6573 730a  .router_address.
+00005f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f40: 6361 7365 205f 3a0a 2020 2020 2020 2020  case _:.        
+00005f50: 2020 2020 2020 2020 2020 2020 5f72 6563              _rec
+00005f60: 6970 6965 6e74 203d 2074 6f5f 6368 6563  ipient = to_chec
+00005f70: 6b73 756d 5f61 6464 7265 7373 2872 6563  ksum_address(rec
+00005f80: 6970 6965 6e74 290a 2020 2020 2020 2020  ipient).        
+00005f90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005fa0: 2e72 6563 6970 6965 6e74 732e 6164 6428  .recipients.add(
+00005fb0: 5f72 6563 6970 6965 6e74 290a 0a20 2020  _recipient)..   
+00005fc0: 2020 2020 2020 2020 2073 656c 662e 6c65           self.le
+00005fd0: 6467 6572 2e74 7261 6e73 6665 7228 0a20  dger.transfer(. 
+00005fe0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00005ff0: 6f6b 656e 3d74 6f6b 656e 5f6f 7574 2e61  oken=token_out.a
+00006000: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+00006010: 2020 2020 2020 2020 616d 6f75 6e74 3d5f          amount=_
+00006020: 616d 6f75 6e74 5f6f 7574 2c0a 2020 2020  amount_out,.    
+00006030: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00006040: 5f61 6464 723d 7365 6c66 2e72 6f75 7465  _addr=self.route
+00006050: 725f 6164 6472 6573 732c 0a20 2020 2020  r_address,.     
+00006060: 2020 2020 2020 2020 2020 2074 6f5f 6164             to_ad
+00006070: 6472 3d5f 7265 6369 7069 656e 742c 0a20  dr=_recipient,. 
+00006080: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00006090: 2020 2020 2020 6966 206e 6f74 2073 696c        if not sil
+000060a0: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+000060b0: 2073 656c 662e 5f73 686f 775f 706f 6f6c   self._show_pool
+000060c0: 5f73 7461 7465 7328 706f 6f6c 2c20 5f73  _states(pool, _s
+000060d0: 696d 5f72 6573 756c 7429 0a0a 2020 2020  im_result)..    
+000060e0: 2020 2020 7265 7475 726e 2070 6f6f 6c2c      return pool,
+000060f0: 205f 7369 6d5f 7265 7375 6c74 0a0a 2020   _sim_result..  
+00006100: 2020 6465 6620 5f73 696d 756c 6174 655f    def _simulate_
+00006110: 756e 7772 6170 2873 656c 662c 2077 7261  unwrap(self, wra
+00006120: 7070 6564 5f74 6f6b 656e 3a20 7374 7229  pped_token: str)
+00006130: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006140: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+00006150: 2255 6e77 7261 7070 696e 6720 7b77 7261  "Unwrapping {wra
+00006160: 7070 6564 5f74 6f6b 656e 7d22 290a 0a20  pped_token}").. 
+00006170: 2020 2020 2020 2077 7261 7070 6564 5f74         wrapped_t
+00006180: 6f6b 656e 5f62 616c 616e 6365 203d 2073  oken_balance = s
+00006190: 656c 662e 6c65 6467 6572 2e74 6f6b 656e  elf.ledger.token
+000061a0: 5f62 616c 616e 6365 2873 656c 662e 726f  _balance(self.ro
+000061b0: 7574 6572 5f61 6464 7265 7373 2c20 7772  uter_address, wr
+000061c0: 6170 7065 645f 746f 6b65 6e29 0a0a 2020  apped_token)..  
+000061d0: 2020 2020 2020 7365 6c66 2e6c 6564 6765        self.ledge
+000061e0: 722e 6164 6a75 7374 280a 2020 2020 2020  r.adjust(.      
+000061f0: 2020 2020 2020 7365 6c66 2e72 6f75 7465        self.route
+00006200: 725f 6164 6472 6573 732c 0a20 2020 2020  r_address,.     
+00006210: 2020 2020 2020 2077 7261 7070 6564 5f74         wrapped_t
+00006220: 6f6b 656e 2c0a 2020 2020 2020 2020 2020  oken,.          
+00006230: 2020 2d77 7261 7070 6564 5f74 6f6b 656e    -wrapped_token
+00006240: 5f62 616c 616e 6365 2c0a 2020 2020 2020  _balance,.      
+00006250: 2020 290a 0a20 2020 2064 6566 205f 7369    )..    def _si
+00006260: 6d75 6c61 7465 5f73 7765 6570 2873 656c  mulate_sweep(sel
+00006270: 662c 2074 6f6b 656e 3a20 7374 722c 2072  f, token: str, r
+00006280: 6563 6970 6965 6e74 3a20 7374 7229 202d  ecipient: str) -
+00006290: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000062a0: 6c6f 6767 6572 2e64 6562 7567 2866 2253  logger.debug(f"S
+000062b0: 7765 6570 696e 6720 7b74 6f6b 656e 7d20  weeping {token} 
+000062c0: 746f 207b 7265 6369 7069 656e 747d 2229  to {recipient}")
+000062d0: 0a0a 2020 2020 2020 2020 746f 6b65 6e5f  ..        token_
+000062e0: 6261 6c61 6e63 6520 3d20 7365 6c66 2e6c  balance = self.l
+000062f0: 6564 6765 722e 746f 6b65 6e5f 6261 6c61  edger.token_bala
+00006300: 6e63 6528 7365 6c66 2e72 6f75 7465 725f  nce(self.router_
+00006310: 6164 6472 6573 732c 2074 6f6b 656e 290a  address, token).
+00006320: 2020 2020 2020 2020 7365 6c66 2e6c 6564          self.led
+00006330: 6765 722e 6164 6a75 7374 280a 2020 2020  ger.adjust(.    
+00006340: 2020 2020 2020 2020 7365 6c66 2e72 6f75          self.rou
+00006350: 7465 725f 6164 6472 6573 732c 0a20 2020  ter_address,.   
+00006360: 2020 2020 2020 2020 2074 6f6b 656e 2c0a           token,.
+00006370: 2020 2020 2020 2020 2020 2020 2d74 6f6b              -tok
+00006380: 656e 5f62 616c 616e 6365 2c0a 2020 2020  en_balance,.    
+00006390: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+000063a0: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
+000063b0: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
+000063c0: 6369 7069 656e 742c 0a20 2020 2020 2020  cipient,.       
+000063d0: 2020 2020 2074 6f6b 656e 2c0a 2020 2020       token,.    
+000063e0: 2020 2020 2020 2020 746f 6b65 6e5f 6261          token_ba
+000063f0: 6c61 6e63 652c 0a20 2020 2020 2020 2029  lance,.        )
+00006400: 0a0a 2020 2020 6465 6620 5f73 696d 756c  ..    def _simul
+00006410: 6174 6528 0a20 2020 2020 2020 2073 656c  ate(.        sel
+00006420: 662c 0a20 2020 2020 2020 2066 756e 635f  f,.        func_
+00006430: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+00006440: 2020 2066 756e 635f 7061 7261 6d73 3a20     func_params: 
+00006450: 4469 6374 5b73 7472 2c20 416e 795d 2c0a  Dict[str, Any],.
+00006460: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00006470: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00006480: 2020 2054 616b 6520 6120 556e 6973 7761     Take a Uniswa
+00006490: 7020 5632 202f 2056 3320 7472 616e 7361  p V2 / V3 transa
+000064a0: 6374 696f 6e20 2873 7065 6369 6669 6564  ction (specified
+000064b0: 2062 7920 6e61 6d65 2061 6e64 2061 2064   by name and a d
+000064c0: 6963 7469 6f6e 6172 790a 2020 2020 2020  ictionary.      
+000064d0: 2020 6f66 2061 7267 756d 656e 7473 2074    of arguments t
+000064e0: 6f20 7468 6174 2066 756e 6374 696f 6e29  o that function)
+000064f0: 2061 6e64 2072 6574 7572 6e20 6120 6c69   and return a li
+00006500: 7374 206f 6620 706f 6f6c 7320 616e 6420  st of pools and 
+00006510: 7374 6174 650a 2020 2020 2020 2020 6469  state.        di
+00006520: 6374 696f 6e61 7269 6573 2066 6f72 2061  ctionaries for a
+00006530: 6c6c 2070 6f6f 6c73 2075 7365 6420 6279  ll pools used by
+00006540: 2074 6865 2074 7261 6e73 6163 7469 6f6e   the transaction
+00006550: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00006560: 2020 2020 2020 5632 5f46 554e 4354 494f        V2_FUNCTIO
+00006570: 4e53 203d 207b 0a20 2020 2020 2020 2020  NS = {.         
+00006580: 2020 2022 6164 644c 6971 7569 6469 7479     "addLiquidity
+00006590: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000065a0: 6164 644c 6971 7569 6469 7479 4554 4822  addLiquidityETH"
+000065b0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+000065c0: 7761 7045 7861 6374 546f 6b65 6e73 466f  wapExactTokensFo
+000065d0: 7245 5448 222c 0a20 2020 2020 2020 2020  rETH",.         
+000065e0: 2020 2022 7377 6170 4578 6163 7454 6f6b     "swapExactTok
+000065f0: 656e 7346 6f72 4554 4853 7570 706f 7274  ensForETHSupport
+00006600: 696e 6746 6565 4f6e 5472 616e 7366 6572  ingFeeOnTransfer
+00006610: 546f 6b65 6e73 222c 0a20 2020 2020 2020  Tokens",.       
+00006620: 2020 2020 2022 7377 6170 4578 6163 7445       "swapExactE
+00006630: 5448 466f 7254 6f6b 656e 7322 2c0a 2020  THForTokens",.  
+00006640: 2020 2020 2020 2020 2020 2273 7761 7045            "swapE
+00006650: 7861 6374 4554 4846 6f72 546f 6b65 6e73  xactETHForTokens
+00006660: 5375 7070 6f72 7469 6e67 4665 654f 6e54  SupportingFeeOnT
+00006670: 7261 6e73 6665 7254 6f6b 656e 7322 2c0a  ransferTokens",.
+00006680: 2020 2020 2020 2020 2020 2020 2273 7761              "swa
+00006690: 7045 7861 6374 546f 6b65 6e73 466f 7254  pExactTokensForT
+000066a0: 6f6b 656e 7322 2c0a 2020 2020 2020 2020  okens",.        
+000066b0: 2020 2020 2273 7761 7045 7861 6374 546f      "swapExactTo
+000066c0: 6b65 6e73 466f 7254 6f6b 656e 7353 7570  kensForTokensSup
+000066d0: 706f 7274 696e 6746 6565 4f6e 5472 616e  portingFeeOnTran
+000066e0: 7366 6572 546f 6b65 6e73 222c 0a20 2020  sferTokens",.   
+000066f0: 2020 2020 2020 2020 2022 7377 6170 546f           "swapTo
+00006700: 6b65 6e73 466f 7245 7861 6374 4554 4822  kensForExactETH"
+00006710: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00006720: 7761 7054 6f6b 656e 7346 6f72 4578 6163  wapTokensForExac
+00006730: 7454 6f6b 656e 7322 2c0a 2020 2020 2020  tTokens",.      
+00006740: 2020 2020 2020 2273 7761 7045 5448 466f        "swapETHFo
+00006750: 7245 7861 6374 546f 6b65 6e73 222c 0a20  rExactTokens",. 
+00006760: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00006770: 2020 5633 5f46 554e 4354 494f 4e53 203d    V3_FUNCTIONS =
+00006780: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00006790: 6578 6163 7449 6e70 7574 5369 6e67 6c65  exactInputSingle
+000067a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000067b0: 6578 6163 7449 6e70 7574 222c 0a20 2020  exactInput",.   
+000067c0: 2020 2020 2020 2020 2022 6578 6163 744f           "exactO
+000067d0: 7574 7075 7453 696e 676c 6522 2c0a 2020  utputSingle",.  
+000067e0: 2020 2020 2020 2020 2020 2265 7861 6374            "exact
+000067f0: 4f75 7470 7574 222c 0a20 2020 2020 2020  Output",.       
+00006800: 2020 2020 2022 696e 6372 6561 7365 4c69       "increaseLi
+00006810: 7175 6964 6974 7922 2c0a 2020 2020 2020  quidity",.      
+00006820: 2020 2020 2020 226d 756c 7469 6361 6c6c        "multicall
+00006830: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00006840: 7377 6565 7054 6f6b 656e 222c 0a20 2020  sweepToken",.   
+00006850: 2020 2020 2020 2020 2022 756e 7772 6170           "unwrap
+00006860: 5745 5448 3922 2c0a 2020 2020 2020 2020  WETH9",.        
+00006870: 2020 2020 2275 6e77 7261 7057 4554 4839      "unwrapWETH9
+00006880: 5769 7468 4665 6522 2c0a 2020 2020 2020  WithFee",.      
+00006890: 2020 2020 2020 2277 7261 7045 5448 222c        "wrapETH",
+000068a0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000068b0: 2020 2020 554e 4956 4552 5341 4c5f 524f      UNIVERSAL_RO
+000068c0: 5554 4552 5f46 554e 4354 494f 4e53 203d  UTER_FUNCTIONS =
+000068d0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+000068e0: 6578 6563 7574 6522 2c0a 2020 2020 2020  execute",.      
+000068f0: 2020 7d0a 0a20 2020 2020 2020 2055 4e48    }..        UNH
+00006900: 414e 444c 4544 5f46 554e 4354 494f 4e53  ANDLED_FUNCTIONS
+00006910: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00006920: 2023 2054 4f44 4f3a 2068 616e 646c 6520   # TODO: handle 
+00006930: 7468 6573 650a 2020 2020 2020 2020 2020  these.          
+00006940: 2020 2272 656d 6f76 654c 6971 7569 6469    "removeLiquidi
+00006950: 7479 222c 0a20 2020 2020 2020 2020 2020  ty",.           
+00006960: 2022 7265 6d6f 7665 4c69 7175 6964 6974   "removeLiquidit
+00006970: 7945 5448 222c 0a20 2020 2020 2020 2020  yETH",.         
+00006980: 2020 2022 7265 6d6f 7665 4c69 7175 6964     "removeLiquid
+00006990: 6974 7945 5448 5769 7468 5065 726d 6974  ityETHWithPermit
+000069a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000069b0: 7265 6d6f 7665 4c69 7175 6964 6974 7945  removeLiquidityE
+000069c0: 5448 5375 7070 6f72 7469 6e67 4665 654f  THSupportingFeeO
+000069d0: 6e54 7261 6e73 6665 7254 6f6b 656e 7322  nTransferTokens"
+000069e0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+000069f0: 656d 6f76 654c 6971 7569 6469 7479 4554  emoveLiquidityET
+00006a00: 4857 6974 6850 6572 6d69 7453 7570 706f  HWithPermitSuppo
+00006a10: 7274 696e 6746 6565 4f6e 5472 616e 7366  rtingFeeOnTransf
+00006a20: 6572 546f 6b65 6e73 222c 0a20 2020 2020  erTokens",.     
+00006a30: 2020 2020 2020 2022 7265 6d6f 7665 4c69         "removeLi
+00006a40: 7175 6964 6974 7957 6974 6850 6572 6d69  quidityWithPermi
+00006a50: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00006a60: 2273 7765 6570 546f 6b65 6e57 6974 6846  "sweepTokenWithF
+00006a70: 6565 222c 0a20 2020 2020 2020 2020 2020  ee",.           
+00006a80: 2023 2056 3320 6d75 6c74 6963 616c 6c20   # V3 multicall 
+00006a90: 6675 6e63 7469 6f6e 730a 2020 2020 2020  functions.      
+00006aa0: 2020 2020 2020 2320 7265 663a 2068 7474        # ref: htt
+00006ab0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00006ac0: 556e 6973 7761 702f 7377 6170 2d72 6f75  Uniswap/swap-rou
+00006ad0: 7465 722d 636f 6e74 7261 6374 732f 626c  ter-contracts/bl
+00006ae0: 6f62 2f6d 6169 6e2f 636f 6e74 7261 6374  ob/main/contract
+00006af0: 732f 6261 7365 2f41 7070 726f 7665 416e  s/base/ApproveAn
+00006b00: 6443 616c 6c2e 736f 6c0a 2020 2020 2020  dCall.sol.      
+00006b10: 2020 2020 2020 226d 696e 7422 2c0a 2020        "mint",.  
+00006b20: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00006b30: 204e 4f5f 4f50 5f46 554e 4354 494f 4e53   NO_OP_FUNCTIONS
+00006b40: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00006b50: 2023 2054 6865 7365 2066 756e 6374 696f   # These functio
+00006b60: 6e73 2064 6f20 6e6f 7420 6166 6665 6374  ns do not affect
+00006b70: 2074 6865 2070 6f6f 6c20 7374 6174 652e   the pool state.
+00006b80: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
+00006b90: 2d2d 0a20 2020 2020 2020 2020 2020 2023  --.            #
+00006ba0: 2072 6566 3a20 6874 7470 733a 2f2f 646f   ref: https://do
+00006bb0: 6373 2e75 6e69 7377 6170 2e6f 7267 2f63  cs.uniswap.org/c
+00006bc0: 6f6e 7472 6163 7473 2f76 332f 7265 6665  ontracts/v3/refe
+00006bd0: 7265 6e63 652f 7065 7269 7068 6572 792f  rence/periphery/
+00006be0: 696e 7465 7266 6163 6573 2f49 5065 7269  interfaces/IPeri
+00006bf0: 7068 6572 7950 6179 6d65 6e74 7323 7265  pheryPayments#re
+00006c00: 6675 6e64 6574 680a 2020 2020 2020 2020  fundeth.        
+00006c10: 2020 2020 2272 6566 756e 6445 5448 222c      "refundETH",
+00006c20: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
+00006c30: 2d2d 0a20 2020 2020 2020 2020 2020 2023  --.            #
+00006c40: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00006c50: 4950 2d32 3631 3220 746f 6b65 6e20 7065  IP-2612 token pe
+00006c60: 726d 6974 2066 756e 6374 696f 6e73 0a20  rmit functions. 
+00006c70: 2020 2020 2020 2020 2020 2023 2072 6566             # ref
+00006c80: 3a20 6874 7470 733a 2f2f 646f 6373 2e75  : https://docs.u
+00006c90: 6e69 7377 6170 2e6f 7267 2f63 6f6e 7472  niswap.org/contr
+00006ca0: 6163 7473 2f76 332f 7265 6665 7265 6e63  acts/v3/referenc
+00006cb0: 652f 7065 7269 7068 6572 792f 6261 7365  e/periphery/base
+00006cc0: 2f53 656c 6650 6572 6d69 740a 2020 2020  /SelfPermit.    
+00006cd0: 2020 2020 2020 2020 2273 656c 6650 6572          "selfPer
+00006ce0: 6d69 7422 2c0a 2020 2020 2020 2020 2020  mit",.          
+00006cf0: 2020 2273 656c 6650 6572 6d69 7441 6c6c    "selfPermitAll
+00006d00: 6f77 6564 222c 0a20 2020 2020 2020 2020  owed",.         
+00006d10: 2020 2022 7365 6c66 5065 726d 6974 416c     "selfPermitAl
+00006d20: 6c6f 7765 6449 664e 6563 6573 7361 7279  lowedIfNecessary
+00006d30: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00006d40: 7365 6c66 5065 726d 6974 4966 4e65 6365  selfPermitIfNece
+00006d50: 7373 6172 7922 2c0a 2020 2020 2020 2020  ssary",.        
+00006d60: 2020 2020 2320 2d2d 2d0a 2020 2020 2020      # ---.      
+00006d70: 2020 2020 2020 2320 7265 663a 2068 7474        # ref: htt
+00006d80: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00006d90: 556e 6973 7761 702f 7377 6170 2d72 6f75  Uniswap/swap-rou
+00006da0: 7465 722d 636f 6e74 7261 6374 732f 626c  ter-contracts/bl
+00006db0: 6f62 2f6d 6169 6e2f 636f 6e74 7261 6374  ob/main/contract
+00006dc0: 732f 6261 7365 2f50 6572 6970 6865 7279  s/base/Periphery
+00006dd0: 5061 796d 656e 7473 4578 7465 6e64 6564  PaymentsExtended
+00006de0: 2e73 6f6c 0a20 2020 2020 2020 2020 2020  .sol.           
+00006df0: 2022 7075 6c6c 222c 0a20 2020 2020 2020   "pull",.       
+00006e00: 207d 0a0a 2020 2020 2020 2020 6465 6620   }..        def 
+00006e10: 5f70 726f 6365 7373 5f75 6e69 7665 7273  _process_univers
+00006e20: 616c 5f72 6f75 7465 725f 636f 6d6d 616e  al_router_comman
+00006e30: 6428 0a20 2020 2020 2020 2020 2020 2063  d(.            c
+00006e40: 6f6d 6d61 6e64 5f74 7970 653a 2069 6e74  ommand_type: int
+00006e50: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00006e60: 7075 7473 3a20 6279 7465 732c 0a20 2020  puts: bytes,.   
+00006e70: 2020 2020 2029 202d 3e20 4e6f 6e65 3a0a       ) -> None:.
+00006e80: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00006e90: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
+00006ea0: 622e 636f 6d2f 556e 6973 7761 702f 756e  b.com/Uniswap/un
+00006eb0: 6976 6572 7361 6c2d 726f 7574 6572 2f62  iversal-router/b
+00006ec0: 6c6f 622f 6d61 696e 2f63 6f6e 7472 6163  lob/main/contrac
+00006ed0: 7473 2f6c 6962 7261 7269 6573 2f43 6f6d  ts/libraries/Com
+00006ee0: 6d61 6e64 732e 736f 6c0a 2020 2020 2020  mands.sol.      
+00006ef0: 2020 2020 2020 554e 4956 4552 5341 4c5f        UNIVERSAL_
+00006f00: 524f 5554 4552 5f43 4f4d 4d41 4e44 5f56  ROUTER_COMMAND_V
+00006f10: 414c 5545 533a 2044 6963 745b 696e 742c  ALUES: Dict[int,
+00006f20: 2073 7472 207c 204e 6f6e 655d 203d 207b   str | None] = {
+00006f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006f40: 2030 7830 303a 2022 5633 5f53 5741 505f   0x00: "V3_SWAP_
+00006f50: 4558 4143 545f 494e 222c 0a20 2020 2020  EXACT_IN",.     
+00006f60: 2020 2020 2020 2020 2020 2030 7830 313a             0x01:
+00006f70: 2022 5633 5f53 5741 505f 4558 4143 545f   "V3_SWAP_EXACT_
+00006f80: 4f55 5422 2c0a 2020 2020 2020 2020 2020  OUT",.          
+00006f90: 2020 2020 2020 3078 3032 3a20 2250 4552        0x02: "PER
+00006fa0: 4d49 5432 5f54 5241 4e53 4645 525f 4652  MIT2_TRANSFER_FR
+00006fb0: 4f4d 222c 0a20 2020 2020 2020 2020 2020  OM",.           
+00006fc0: 2020 2020 2030 7830 333a 2022 5045 524d       0x03: "PERM
+00006fd0: 4954 325f 5045 524d 4954 5f42 4154 4348  IT2_PERMIT_BATCH
+00006fe0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00006ff0: 2020 2030 7830 343a 2022 5357 4545 5022     0x04: "SWEEP"
+00007000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007010: 2020 3078 3035 3a20 2254 5241 4e53 4645    0x05: "TRANSFE
+00007020: 5222 2c0a 2020 2020 2020 2020 2020 2020  R",.            
+00007030: 2020 2020 3078 3036 3a20 2250 4159 5f50      0x06: "PAY_P
+00007040: 4f52 5449 4f4e 222c 0a20 2020 2020 2020  ORTION",.       
+00007050: 2020 2020 2020 2020 2030 7830 373a 204e           0x07: N
+00007060: 6f6e 652c 2020 2320 434f 4d4d 414e 445f  one,  # COMMAND_
+00007070: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
+00007080: 2020 2020 2020 2020 2020 2020 3078 3038              0x08
+00007090: 3a20 2256 325f 5357 4150 5f45 5841 4354  : "V2_SWAP_EXACT
+000070a0: 5f49 4e22 2c0a 2020 2020 2020 2020 2020  _IN",.          
+000070b0: 2020 2020 2020 3078 3039 3a20 2256 325f        0x09: "V2_
+000070c0: 5357 4150 5f45 5841 4354 5f4f 5554 222c  SWAP_EXACT_OUT",
+000070d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000070e0: 2030 7830 413a 2022 5045 524d 4954 325f   0x0A: "PERMIT2_
+000070f0: 5045 524d 4954 222c 0a20 2020 2020 2020  PERMIT",.       
+00007100: 2020 2020 2020 2020 2030 7830 423a 2022           0x0B: "
+00007110: 5752 4150 5f45 5448 222c 0a20 2020 2020  WRAP_ETH",.     
+00007120: 2020 2020 2020 2020 2020 2030 7830 433a             0x0C:
+00007130: 2022 554e 5752 4150 5f57 4554 4822 2c0a   "UNWRAP_WETH",.
+00007140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007150: 3078 3044 3a20 2250 4552 4d49 5432 5f54  0x0D: "PERMIT2_T
+00007160: 5241 4e53 4645 525f 4652 4f4d 5f42 4154  RANSFER_FROM_BAT
+00007170: 4348 222c 0a20 2020 2020 2020 2020 2020  CH",.           
+00007180: 2020 2020 2030 7830 453a 2022 4241 4c41       0x0E: "BALA
+00007190: 4e43 455f 4348 4543 4b5f 4552 4332 3022  NCE_CHECK_ERC20"
+000071a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000071b0: 2020 3078 3046 3a20 4e6f 6e65 2c20 2023    0x0F: None,  #
+000071c0: 2043 4f4d 4d41 4e44 5f50 4c41 4345 484f   COMMAND_PLACEHO
+000071d0: 4c44 4552 0a20 2020 2020 2020 2020 2020  LDER.           
+000071e0: 2020 2020 2030 7831 303a 2022 5345 4150       0x10: "SEAP
+000071f0: 4f52 545f 5631 5f35 222c 0a20 2020 2020  ORT_V1_5",.     
+00007200: 2020 2020 2020 2020 2020 2030 7831 313a             0x11:
+00007210: 2022 4c4f 4f4b 535f 5241 5245 5f56 3222   "LOOKS_RARE_V2"
+00007220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007230: 2020 3078 3132 3a20 224e 4654 5822 2c0a    0x12: "NFTX",.
+00007240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007250: 3078 3133 3a20 2243 5259 5054 4f50 554e  0x13: "CRYPTOPUN
+00007260: 4b53 222c 0a20 2020 2020 2020 2020 2020  KS",.           
+00007270: 2020 2020 2030 7831 343a 2022 4c4f 4f4b       0x14: "LOOK
+00007280: 535f 5241 5245 5f31 3135 3522 2c20 2023  S_RARE_1155",  #
+00007290: 2064 726f 7070 6564 2069 6e20 5631 5f33   dropped in V1_3
+000072a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000072b0: 2030 7831 353a 2022 4f57 4e45 525f 4348   0x15: "OWNER_CH
+000072c0: 4543 4b5f 3732 3122 2c0a 2020 2020 2020  ECK_721",.      
+000072d0: 2020 2020 2020 2020 2020 3078 3136 3a20            0x16: 
+000072e0: 224f 574e 4552 5f43 4845 434b 5f31 3135  "OWNER_CHECK_115
+000072f0: 3522 2c0a 2020 2020 2020 2020 2020 2020  5",.            
+00007300: 2020 2020 3078 3137 3a20 2253 5745 4550      0x17: "SWEEP
+00007310: 5f45 5243 3732 3122 2c0a 2020 2020 2020  _ERC721",.      
+00007320: 2020 2020 2020 2020 2020 3078 3138 3a20            0x18: 
+00007330: 2258 3259 325f 3732 3122 2c0a 2020 2020  "X2Y2_721",.    
+00007340: 2020 2020 2020 2020 2020 2020 3078 3139              0x19
+00007350: 3a20 2253 5544 4f53 5741 5022 2c0a 2020  : "SUDOSWAP",.  
+00007360: 2020 2020 2020 2020 2020 2020 2020 3078                0x
+00007370: 3141 3a20 224e 4654 3230 222c 0a20 2020  1A: "NFT20",.   
+00007380: 2020 2020 2020 2020 2020 2020 2030 7831               0x1
+00007390: 423a 2022 5832 5932 5f31 3135 3522 2c0a  B: "X2Y2_1155",.
+000073a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073b0: 3078 3143 3a20 2246 4f55 4e44 4154 494f  0x1C: "FOUNDATIO
+000073c0: 4e22 2c0a 2020 2020 2020 2020 2020 2020  N",.            
+000073d0: 2020 2020 3078 3144 3a20 2253 5745 4550      0x1D: "SWEEP
+000073e0: 5f45 5243 3131 3535 222c 0a20 2020 2020  _ERC1155",.     
+000073f0: 2020 2020 2020 2020 2020 2030 7831 453a             0x1E:
+00007400: 2022 454c 454d 454e 545f 4d41 524b 4554   "ELEMENT_MARKET
+00007410: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00007420: 2020 2030 7831 463a 204e 6f6e 652c 2020     0x1F: None,  
+00007430: 2320 434f 4d4d 414e 445f 504c 4143 4548  # COMMAND_PLACEH
+00007440: 4f4c 4445 520a 2020 2020 2020 2020 2020  OLDER.          
+00007450: 2020 2020 2020 3078 3230 3a20 2253 4541        0x20: "SEA
+00007460: 504f 5254 5f56 315f 3422 2c0a 2020 2020  PORT_V1_4",.    
+00007470: 2020 2020 2020 2020 2020 2020 3078 3231              0x21
+00007480: 3a20 2245 5845 4355 5445 5f53 5542 5f50  : "EXECUTE_SUB_P
+00007490: 4c41 4e22 2c0a 2020 2020 2020 2020 2020  LAN",.          
+000074a0: 2020 2020 2020 3078 3232 3a20 2241 5050        0x22: "APP
+000074b0: 524f 5645 5f45 5243 3230 222c 0a20 2020  ROVE_ERC20",.   
+000074c0: 2020 2020 2020 2020 2020 2020 2030 7832               0x2
+000074d0: 333a 204e 6f6e 652c 2020 2320 434f 4d4d  3: None,  # COMM
+000074e0: 414e 445f 504c 4143 4548 4f4c 4445 520a  AND_PLACEHOLDER.
 000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007500: 3078 3146 3a20 4e6f 6e65 2c20 2023 2043  0x1F: None,  # C
+00007500: 3078 3234 3a20 4e6f 6e65 2c20 2023 2043  0x24: None,  # C
 00007510: 4f4d 4d41 4e44 5f50 4c41 4345 484f 4c44  OMMAND_PLACEHOLD
 00007520: 4552 0a20 2020 2020 2020 2020 2020 2020  ER.             
-00007530: 2020 2030 7832 303a 2022 5345 4150 4f52     0x20: "SEAPOR
-00007540: 545f 5631 5f34 222c 0a20 2020 2020 2020  T_V1_4",.       
-00007550: 2020 2020 2020 2020 2030 7832 313a 2022           0x21: "
-00007560: 4558 4543 5554 455f 5355 425f 504c 414e  EXECUTE_SUB_PLAN
-00007570: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00007580: 2020 2030 7832 323a 2022 4150 5052 4f56     0x22: "APPROV
-00007590: 455f 4552 4332 3022 2c0a 2020 2020 2020  E_ERC20",.      
-000075a0: 2020 2020 2020 2020 2020 3078 3233 3a20            0x23: 
-000075b0: 4e6f 6e65 2c20 2023 2043 4f4d 4d41 4e44  None,  # COMMAND
-000075c0: 5f50 4c41 4345 484f 4c44 4552 0a20 2020  _PLACEHOLDER.   
-000075d0: 2020 2020 2020 2020 2020 2020 2030 7832               0x2
-000075e0: 343a 204e 6f6e 652c 2020 2320 434f 4d4d  4: None,  # COMM
-000075f0: 414e 445f 504c 4143 4548 4f4c 4445 520a  AND_PLACEHOLDER.
-00007600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007610: 3078 3235 3a20 4e6f 6e65 2c20 2023 2043  0x25: None,  # C
-00007620: 4f4d 4d41 4e44 5f50 4c41 4345 484f 4c44  OMMAND_PLACEHOLD
-00007630: 4552 0a20 2020 2020 2020 2020 2020 2020  ER.             
-00007640: 2020 2030 7832 363a 204e 6f6e 652c 2020     0x26: None,  
-00007650: 2320 434f 4d4d 414e 445f 504c 4143 4548  # COMMAND_PLACEH
-00007660: 4f4c 4445 520a 2020 2020 2020 2020 2020  OLDER.          
-00007670: 2020 2020 2020 3078 3237 3a20 4e6f 6e65        0x27: None
-00007680: 2c20 2023 2043 4f4d 4d41 4e44 5f50 4c41  ,  # COMMAND_PLA
-00007690: 4345 484f 4c44 4552 0a20 2020 2020 2020  CEHOLDER.       
-000076a0: 2020 2020 2020 2020 2030 7832 383a 204e           0x28: N
-000076b0: 6f6e 652c 2020 2320 434f 4d4d 414e 445f  one,  # COMMAND_
-000076c0: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
-000076d0: 2020 2020 2020 2020 2020 2020 3078 3239              0x29
-000076e0: 3a20 4e6f 6e65 2c20 2023 2043 4f4d 4d41  : None,  # COMMA
-000076f0: 4e44 5f50 4c41 4345 484f 4c44 4552 0a20  ND_PLACEHOLDER. 
-00007700: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00007710: 7832 413a 204e 6f6e 652c 2020 2320 434f  x2A: None,  # CO
-00007720: 4d4d 414e 445f 504c 4143 4548 4f4c 4445  MMAND_PLACEHOLDE
-00007730: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
-00007740: 2020 3078 3242 3a20 4e6f 6e65 2c20 2023    0x2B: None,  #
-00007750: 2043 4f4d 4d41 4e44 5f50 4c41 4345 484f   COMMAND_PLACEHO
-00007760: 4c44 4552 0a20 2020 2020 2020 2020 2020  LDER.           
-00007770: 2020 2020 2030 7832 433a 204e 6f6e 652c       0x2C: None,
-00007780: 2020 2320 434f 4d4d 414e 445f 504c 4143    # COMMAND_PLAC
-00007790: 4548 4f4c 4445 520a 2020 2020 2020 2020  EHOLDER.        
-000077a0: 2020 2020 2020 2020 3078 3244 3a20 4e6f          0x2D: No
-000077b0: 6e65 2c20 2023 2043 4f4d 4d41 4e44 5f50  ne,  # COMMAND_P
-000077c0: 4c41 4345 484f 4c44 4552 0a20 2020 2020  LACEHOLDER.     
-000077d0: 2020 2020 2020 2020 2020 2030 7832 453a             0x2E:
-000077e0: 204e 6f6e 652c 2020 2320 434f 4d4d 414e   None,  # COMMAN
-000077f0: 445f 504c 4143 4548 4f4c 4445 520a 2020  D_PLACEHOLDER.  
-00007800: 2020 2020 2020 2020 2020 2020 2020 3078                0x
-00007810: 3246 3a20 4e6f 6e65 2c20 2023 2043 4f4d  2F: None,  # COM
-00007820: 4d41 4e44 5f50 4c41 4345 484f 4c44 4552  MAND_PLACEHOLDER
-00007830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007840: 2030 7833 303a 204e 6f6e 652c 2020 2320   0x30: None,  # 
-00007850: 434f 4d4d 414e 445f 504c 4143 4548 4f4c  COMMAND_PLACEHOL
-00007860: 4445 520a 2020 2020 2020 2020 2020 2020  DER.            
-00007870: 2020 2020 3078 3331 3a20 4e6f 6e65 2c20      0x31: None, 
-00007880: 2023 2043 4f4d 4d41 4e44 5f50 4c41 4345   # COMMAND_PLACE
-00007890: 484f 4c44 4552 0a20 2020 2020 2020 2020  HOLDER.         
-000078a0: 2020 2020 2020 2030 7833 323a 204e 6f6e         0x32: Non
-000078b0: 652c 2020 2320 434f 4d4d 414e 445f 504c  e,  # COMMAND_PL
-000078c0: 4143 4548 4f4c 4445 520a 2020 2020 2020  ACEHOLDER.      
-000078d0: 2020 2020 2020 2020 2020 3078 3333 3a20            0x33: 
-000078e0: 4e6f 6e65 2c20 2023 2043 4f4d 4d41 4e44  None,  # COMMAND
-000078f0: 5f50 4c41 4345 484f 4c44 4552 0a20 2020  _PLACEHOLDER.   
-00007900: 2020 2020 2020 2020 2020 2020 2030 7833               0x3
-00007910: 343a 204e 6f6e 652c 2020 2320 434f 4d4d  4: None,  # COMM
-00007920: 414e 445f 504c 4143 4548 4f4c 4445 520a  AND_PLACEHOLDER.
-00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007940: 3078 3335 3a20 4e6f 6e65 2c20 2023 2043  0x35: None,  # C
-00007950: 4f4d 4d41 4e44 5f50 4c41 4345 484f 4c44  OMMAND_PLACEHOLD
-00007960: 4552 0a20 2020 2020 2020 2020 2020 2020  ER.             
-00007970: 2020 2030 7833 363a 204e 6f6e 652c 2020     0x36: None,  
-00007980: 2320 434f 4d4d 414e 445f 504c 4143 4548  # COMMAND_PLACEH
-00007990: 4f4c 4445 520a 2020 2020 2020 2020 2020  OLDER.          
-000079a0: 2020 2020 2020 3078 3337 3a20 4e6f 6e65        0x37: None
-000079b0: 2c20 2023 2043 4f4d 4d41 4e44 5f50 4c41  ,  # COMMAND_PLA
-000079c0: 4345 484f 4c44 4552 0a20 2020 2020 2020  CEHOLDER.       
-000079d0: 2020 2020 2020 2020 2030 7833 383a 204e           0x38: N
-000079e0: 6f6e 652c 2020 2320 434f 4d4d 414e 445f  one,  # COMMAND_
-000079f0: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
-00007a00: 2020 2020 2020 2020 2020 2020 3078 3339              0x39
-00007a10: 3a20 4e6f 6e65 2c20 2023 2043 4f4d 4d41  : None,  # COMMA
-00007a20: 4e44 5f50 4c41 4345 484f 4c44 4552 0a20  ND_PLACEHOLDER. 
-00007a30: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00007a40: 7833 413a 204e 6f6e 652c 2020 2320 434f  x3A: None,  # CO
-00007a50: 4d4d 414e 445f 504c 4143 4548 4f4c 4445  MMAND_PLACEHOLDE
-00007a60: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
-00007a70: 2020 3078 3342 3a20 4e6f 6e65 2c20 2023    0x3B: None,  #
-00007a80: 2043 4f4d 4d41 4e44 5f50 4c41 4345 484f   COMMAND_PLACEHO
-00007a90: 4c44 4552 0a20 2020 2020 2020 2020 2020  LDER.           
-00007aa0: 2020 2020 2030 7833 433a 204e 6f6e 652c       0x3C: None,
-00007ab0: 2020 2320 434f 4d4d 414e 445f 504c 4143    # COMMAND_PLAC
-00007ac0: 4548 4f4c 4445 520a 2020 2020 2020 2020  EHOLDER.        
-00007ad0: 2020 2020 2020 2020 3078 3344 3a20 4e6f          0x3D: No
-00007ae0: 6e65 2c20 2023 2043 4f4d 4d41 4e44 5f50  ne,  # COMMAND_P
-00007af0: 4c41 4345 484f 4c44 4552 0a20 2020 2020  LACEHOLDER.     
-00007b00: 2020 2020 2020 2020 2020 2030 7833 453a             0x3E:
-00007b10: 204e 6f6e 652c 2020 2320 434f 4d4d 414e   None,  # COMMAN
-00007b20: 445f 504c 4143 4548 4f4c 4445 520a 2020  D_PLACEHOLDER.  
-00007b30: 2020 2020 2020 2020 2020 2020 2020 3078                0x
-00007b40: 3346 3a20 4e6f 6e65 2c20 2023 2043 4f4d  3F: None,  # COM
-00007b50: 4d41 4e44 5f50 4c41 4345 484f 4c44 4552  MAND_PLACEHOLDER
-00007b60: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00007b70: 2020 2020 2020 2020 2020 2020 554e 494d              UNIM
-00007b80: 504c 454d 454e 5445 445f 554e 4956 4552  PLEMENTED_UNIVER
-00007b90: 414c 5f52 4f55 5445 525f 434f 4d4d 414e  AL_ROUTER_COMMAN
-00007ba0: 4453 203d 207b 0a20 2020 2020 2020 2020  DS = {.         
-00007bb0: 2020 2020 2020 2022 4150 5052 4f56 455f         "APPROVE_
-00007bc0: 4552 4332 3022 2c0a 2020 2020 2020 2020  ERC20",.        
-00007bd0: 2020 2020 2020 2020 2242 414c 414e 4345          "BALANCE
-00007be0: 5f43 4845 434b 5f45 5243 3230 222c 0a20  _CHECK_ERC20",. 
-00007bf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007c00: 4352 5950 544f 5055 4e4b 5322 2c0a 2020  CRYPTOPUNKS",.  
-00007c10: 2020 2020 2020 2020 2020 2020 2020 2245                "E
-00007c20: 4c45 4d45 4e54 5f4d 4152 4b45 5422 2c0a  LEMENT_MARKET",.
-00007c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c40: 2245 5845 4355 5445 5f53 5542 5f50 4c41  "EXECUTE_SUB_PLA
-00007c50: 4e22 2c0a 2020 2020 2020 2020 2020 2020  N",.            
-00007c60: 2020 2020 2246 4f55 4e44 4154 494f 4e22      "FOUNDATION"
-00007c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007c80: 2020 224c 4f4f 4b53 5f52 4152 455f 3131    "LOOKS_RARE_11
-00007c90: 3535 222c 0a20 2020 2020 2020 2020 2020  55",.           
-00007ca0: 2020 2020 2022 4c4f 4f4b 535f 5241 5245       "LOOKS_RARE
-00007cb0: 5f37 3231 222c 0a20 2020 2020 2020 2020  _721",.         
-00007cc0: 2020 2020 2020 2022 4e46 5432 3022 2c0a         "NFT20",.
-00007cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ce0: 224e 4654 5822 2c0a 2020 2020 2020 2020  "NFTX",.        
-00007cf0: 2020 2020 2020 2020 224f 574e 4552 5f43          "OWNER_C
-00007d00: 4845 434b 5f31 3135 3522 2c0a 2020 2020  HECK_1155",.    
-00007d10: 2020 2020 2020 2020 2020 2020 224f 574e              "OWN
-00007d20: 4552 5f43 4845 434b 5f37 3231 222c 0a20  ER_CHECK_721",. 
-00007d30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007d40: 5045 524d 4954 325f 5045 524d 4954 5f42  PERMIT2_PERMIT_B
-00007d50: 4154 4348 222c 0a20 2020 2020 2020 2020  ATCH",.         
-00007d60: 2020 2020 2020 2022 5045 524d 4954 325f         "PERMIT2_
-00007d70: 5045 524d 4954 222c 0a20 2020 2020 2020  PERMIT",.       
-00007d80: 2020 2020 2020 2020 2022 5045 524d 4954           "PERMIT
-00007d90: 325f 5452 414e 5346 4552 5f46 524f 4d5f  2_TRANSFER_FROM_
-00007da0: 4241 5443 4822 2c0a 2020 2020 2020 2020  BATCH",.        
-00007db0: 2020 2020 2020 2020 2250 4552 4d49 5432          "PERMIT2
-00007dc0: 5f54 5241 4e53 4645 525f 4652 4f4d 222c  _TRANSFER_FROM",
-00007dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007de0: 2022 5345 4150 4f52 545f 5632 222c 0a20   "SEAPORT_V2",. 
-00007df0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00007e00: 5345 4150 4f52 5422 2c0a 2020 2020 2020  SEAPORT",.      
-00007e10: 2020 2020 2020 2020 2020 2253 5544 4f53            "SUDOS
-00007e20: 5741 5022 2c0a 2020 2020 2020 2020 2020  WAP",.          
-00007e30: 2020 2020 2020 2253 5745 4550 5f45 5243        "SWEEP_ERC
-00007e40: 3131 3535 222c 0a20 2020 2020 2020 2020  1155",.         
-00007e50: 2020 2020 2020 2022 5357 4545 505f 4552         "SWEEP_ER
-00007e60: 4337 3231 222c 0a20 2020 2020 2020 2020  C721",.         
-00007e70: 2020 2020 2020 2022 5452 414e 5346 4552         "TRANSFER
-00007e80: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00007e90: 2020 2022 5832 5932 5f31 3135 3522 2c0a     "X2Y2_1155",.
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007eb0: 2258 3259 325f 3732 3122 2c0a 2020 2020  "X2Y2_721",.    
-00007ec0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00007ed0: 2020 2020 2020 2043 4f4d 4d41 4e44 5f54         COMMAND_T
-00007ee0: 5950 455f 4d41 534b 203d 2030 7833 460a  YPE_MASK = 0x3F.
-00007ef0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00007f00: 616e 6420 3d20 554e 4956 4552 5341 4c5f  and = UNIVERSAL_
-00007f10: 524f 5554 4552 5f43 4f4d 4d41 4e44 5f56  ROUTER_COMMAND_V
-00007f20: 414c 5545 535b 636f 6d6d 616e 645f 7479  ALUES[command_ty
-00007f30: 7065 2026 2043 4f4d 4d41 4e44 5f54 5950  pe & COMMAND_TYP
-00007f40: 455f 4d41 534b 5d0a 0a20 2020 2020 2020  E_MASK]..       
-00007f50: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00007f60: 6728 6622 5072 6f63 6573 7369 6e67 2055  g(f"Processing U
-00007f70: 6e69 7665 7273 616c 2052 6f75 7465 7220  niversal Router 
-00007f80: 636f 6d6d 616e 643a 207b 636f 6d6d 616e  command: {comman
-00007f90: 647d 2229 0a0a 2020 2020 2020 2020 2020  d}")..          
-00007fa0: 2020 6966 2054 5950 455f 4348 4543 4b49    if TYPE_CHECKI
-00007fb0: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
-00007fc0: 2020 2020 5f61 6d6f 756e 745f 696e 3a20      _amount_in: 
-00007fd0: 696e 7420 3d20 300a 2020 2020 2020 2020  int = 0.        
-00007fe0: 2020 2020 2020 2020 5f61 6d6f 756e 745f          _amount_
-00007ff0: 6f75 743a 2069 6e74 203d 2030 0a20 2020  out: int = 0.   
-00008000: 2020 2020 2020 2020 2020 2020 205f 7369               _si
-00008010: 6d5f 7265 7375 6c74 3a20 556e 6973 7761  m_result: Uniswa
-00008020: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
-00008030: 6e52 6573 756c 7420 7c20 556e 6973 7761  nResult | Uniswa
-00008040: 7056 3350 6f6f 6c53 696d 756c 6174 696f  pV3PoolSimulatio
-00008050: 6e52 6573 756c 740a 0a20 2020 2020 2020  nResult..       
-00008060: 2020 2020 205f 756e 6976 6572 7361 6c5f       _universal_
-00008070: 726f 7574 6572 5f63 6f6d 6d61 6e64 5f66  router_command_f
-00008080: 7574 7572 655f 706f 6f6c 5f73 7461 7465  uture_pool_state
-00008090: 733a 204c 6973 745b 0a20 2020 2020 2020  s: List[.       
-000080a0: 2020 2020 2020 2020 2054 7570 6c65 5b4c           Tuple[L
-000080b0: 6971 7569 6469 7479 506f 6f6c 2c20 556e  iquidityPool, Un
-000080c0: 6973 7761 7056 3250 6f6f 6c53 696d 756c  iswapV2PoolSimul
-000080d0: 6174 696f 6e52 6573 756c 745d 0a20 2020  ationResult].   
-000080e0: 2020 2020 2020 2020 2020 2020 207c 2054               | T
-000080f0: 7570 6c65 5b56 334c 6971 7569 6469 7479  uple[V3Liquidity
-00008100: 506f 6f6c 2c20 556e 6973 7761 7056 3350  Pool, UniswapV3P
-00008110: 6f6f 6c53 696d 756c 6174 696f 6e52 6573  oolSimulationRes
-00008120: 756c 745d 0a20 2020 2020 2020 2020 2020  ult].           
-00008130: 205d 203d 205b 5d0a 0a20 2020 2020 2020   ] = []..       
-00008140: 2020 2020 206d 6174 6368 2063 6f6d 6d61       match comma
-00008150: 6e64 3a0a 2020 2020 2020 2020 2020 2020  nd:.            
-00008160: 2020 2020 6361 7365 2022 5357 4545 5022      case "SWEEP"
-00008170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008180: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008190: 2020 2020 2020 2020 2020 2020 2020 5468                Th
-000081a0: 6973 2066 756e 6374 696f 6e20 7472 616e  is function tran
-000081b0: 7366 6572 7320 7468 6520 6375 7272 656e  sfers the curren
-000081c0: 7420 746f 6b65 6e20 6261 6c61 6e63 6520  t token balance 
-000081d0: 6865 6c64 2062 7920 7468 6520 636f 6e74  held by the cont
-000081e0: 7261 6374 2074 6f20 6072 6563 6970 6965  ract to `recipie
-000081f0: 6e74 600a 2020 2020 2020 2020 2020 2020  nt`.            
-00008200: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008220: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00008230: 2020 2020 2020 2020 2020 2020 2020 280a                (.
+00007530: 2020 2030 7832 353a 204e 6f6e 652c 2020     0x25: None,  
+00007540: 2320 434f 4d4d 414e 445f 504c 4143 4548  # COMMAND_PLACEH
+00007550: 4f4c 4445 520a 2020 2020 2020 2020 2020  OLDER.          
+00007560: 2020 2020 2020 3078 3236 3a20 4e6f 6e65        0x26: None
+00007570: 2c20 2023 2043 4f4d 4d41 4e44 5f50 4c41  ,  # COMMAND_PLA
+00007580: 4345 484f 4c44 4552 0a20 2020 2020 2020  CEHOLDER.       
+00007590: 2020 2020 2020 2020 2030 7832 373a 204e           0x27: N
+000075a0: 6f6e 652c 2020 2320 434f 4d4d 414e 445f  one,  # COMMAND_
+000075b0: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
+000075c0: 2020 2020 2020 2020 2020 2020 3078 3238              0x28
+000075d0: 3a20 4e6f 6e65 2c20 2023 2043 4f4d 4d41  : None,  # COMMA
+000075e0: 4e44 5f50 4c41 4345 484f 4c44 4552 0a20  ND_PLACEHOLDER. 
+000075f0: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+00007600: 7832 393a 204e 6f6e 652c 2020 2320 434f  x29: None,  # CO
+00007610: 4d4d 414e 445f 504c 4143 4548 4f4c 4445  MMAND_PLACEHOLDE
+00007620: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
+00007630: 2020 3078 3241 3a20 4e6f 6e65 2c20 2023    0x2A: None,  #
+00007640: 2043 4f4d 4d41 4e44 5f50 4c41 4345 484f   COMMAND_PLACEHO
+00007650: 4c44 4552 0a20 2020 2020 2020 2020 2020  LDER.           
+00007660: 2020 2020 2030 7832 423a 204e 6f6e 652c       0x2B: None,
+00007670: 2020 2320 434f 4d4d 414e 445f 504c 4143    # COMMAND_PLAC
+00007680: 4548 4f4c 4445 520a 2020 2020 2020 2020  EHOLDER.        
+00007690: 2020 2020 2020 2020 3078 3243 3a20 4e6f          0x2C: No
+000076a0: 6e65 2c20 2023 2043 4f4d 4d41 4e44 5f50  ne,  # COMMAND_P
+000076b0: 4c41 4345 484f 4c44 4552 0a20 2020 2020  LACEHOLDER.     
+000076c0: 2020 2020 2020 2020 2020 2030 7832 443a             0x2D:
+000076d0: 204e 6f6e 652c 2020 2320 434f 4d4d 414e   None,  # COMMAN
+000076e0: 445f 504c 4143 4548 4f4c 4445 520a 2020  D_PLACEHOLDER.  
+000076f0: 2020 2020 2020 2020 2020 2020 2020 3078                0x
+00007700: 3245 3a20 4e6f 6e65 2c20 2023 2043 4f4d  2E: None,  # COM
+00007710: 4d41 4e44 5f50 4c41 4345 484f 4c44 4552  MAND_PLACEHOLDER
+00007720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007730: 2030 7832 463a 204e 6f6e 652c 2020 2320   0x2F: None,  # 
+00007740: 434f 4d4d 414e 445f 504c 4143 4548 4f4c  COMMAND_PLACEHOL
+00007750: 4445 520a 2020 2020 2020 2020 2020 2020  DER.            
+00007760: 2020 2020 3078 3330 3a20 4e6f 6e65 2c20      0x30: None, 
+00007770: 2023 2043 4f4d 4d41 4e44 5f50 4c41 4345   # COMMAND_PLACE
+00007780: 484f 4c44 4552 0a20 2020 2020 2020 2020  HOLDER.         
+00007790: 2020 2020 2020 2030 7833 313a 204e 6f6e         0x31: Non
+000077a0: 652c 2020 2320 434f 4d4d 414e 445f 504c  e,  # COMMAND_PL
+000077b0: 4143 4548 4f4c 4445 520a 2020 2020 2020  ACEHOLDER.      
+000077c0: 2020 2020 2020 2020 2020 3078 3332 3a20            0x32: 
+000077d0: 4e6f 6e65 2c20 2023 2043 4f4d 4d41 4e44  None,  # COMMAND
+000077e0: 5f50 4c41 4345 484f 4c44 4552 0a20 2020  _PLACEHOLDER.   
+000077f0: 2020 2020 2020 2020 2020 2020 2030 7833               0x3
+00007800: 333a 204e 6f6e 652c 2020 2320 434f 4d4d  3: None,  # COMM
+00007810: 414e 445f 504c 4143 4548 4f4c 4445 520a  AND_PLACEHOLDER.
+00007820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007830: 3078 3334 3a20 4e6f 6e65 2c20 2023 2043  0x34: None,  # C
+00007840: 4f4d 4d41 4e44 5f50 4c41 4345 484f 4c44  OMMAND_PLACEHOLD
+00007850: 4552 0a20 2020 2020 2020 2020 2020 2020  ER.             
+00007860: 2020 2030 7833 353a 204e 6f6e 652c 2020     0x35: None,  
+00007870: 2320 434f 4d4d 414e 445f 504c 4143 4548  # COMMAND_PLACEH
+00007880: 4f4c 4445 520a 2020 2020 2020 2020 2020  OLDER.          
+00007890: 2020 2020 2020 3078 3336 3a20 4e6f 6e65        0x36: None
+000078a0: 2c20 2023 2043 4f4d 4d41 4e44 5f50 4c41  ,  # COMMAND_PLA
+000078b0: 4345 484f 4c44 4552 0a20 2020 2020 2020  CEHOLDER.       
+000078c0: 2020 2020 2020 2020 2030 7833 373a 204e           0x37: N
+000078d0: 6f6e 652c 2020 2320 434f 4d4d 414e 445f  one,  # COMMAND_
+000078e0: 504c 4143 4548 4f4c 4445 520a 2020 2020  PLACEHOLDER.    
+000078f0: 2020 2020 2020 2020 2020 2020 3078 3338              0x38
+00007900: 3a20 4e6f 6e65 2c20 2023 2043 4f4d 4d41  : None,  # COMMA
+00007910: 4e44 5f50 4c41 4345 484f 4c44 4552 0a20  ND_PLACEHOLDER. 
+00007920: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+00007930: 7833 393a 204e 6f6e 652c 2020 2320 434f  x39: None,  # CO
+00007940: 4d4d 414e 445f 504c 4143 4548 4f4c 4445  MMAND_PLACEHOLDE
+00007950: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
+00007960: 2020 3078 3341 3a20 4e6f 6e65 2c20 2023    0x3A: None,  #
+00007970: 2043 4f4d 4d41 4e44 5f50 4c41 4345 484f   COMMAND_PLACEHO
+00007980: 4c44 4552 0a20 2020 2020 2020 2020 2020  LDER.           
+00007990: 2020 2020 2030 7833 423a 204e 6f6e 652c       0x3B: None,
+000079a0: 2020 2320 434f 4d4d 414e 445f 504c 4143    # COMMAND_PLAC
+000079b0: 4548 4f4c 4445 520a 2020 2020 2020 2020  EHOLDER.        
+000079c0: 2020 2020 2020 2020 3078 3343 3a20 4e6f          0x3C: No
+000079d0: 6e65 2c20 2023 2043 4f4d 4d41 4e44 5f50  ne,  # COMMAND_P
+000079e0: 4c41 4345 484f 4c44 4552 0a20 2020 2020  LACEHOLDER.     
+000079f0: 2020 2020 2020 2020 2020 2030 7833 443a             0x3D:
+00007a00: 204e 6f6e 652c 2020 2320 434f 4d4d 414e   None,  # COMMAN
+00007a10: 445f 504c 4143 4548 4f4c 4445 520a 2020  D_PLACEHOLDER.  
+00007a20: 2020 2020 2020 2020 2020 2020 2020 3078                0x
+00007a30: 3345 3a20 4e6f 6e65 2c20 2023 2043 4f4d  3E: None,  # COM
+00007a40: 4d41 4e44 5f50 4c41 4345 484f 4c44 4552  MAND_PLACEHOLDER
+00007a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007a60: 2030 7833 463a 204e 6f6e 652c 2020 2320   0x3F: None,  # 
+00007a70: 434f 4d4d 414e 445f 504c 4143 4548 4f4c  COMMAND_PLACEHOL
+00007a80: 4445 520a 2020 2020 2020 2020 2020 2020  DER.            
+00007a90: 7d0a 0a20 2020 2020 2020 2020 2020 2055  }..            U
+00007aa0: 4e49 4d50 4c45 4d45 4e54 4544 5f55 4e49  NIMPLEMENTED_UNI
+00007ab0: 5645 5241 4c5f 524f 5554 4552 5f43 4f4d  VERAL_ROUTER_COM
+00007ac0: 4d41 4e44 5320 3d20 7b0a 2020 2020 2020  MANDS = {.      
+00007ad0: 2020 2020 2020 2020 2020 2241 5050 524f            "APPRO
+00007ae0: 5645 5f45 5243 3230 222c 0a20 2020 2020  VE_ERC20",.     
+00007af0: 2020 2020 2020 2020 2020 2022 4241 4c41             "BALA
+00007b00: 4e43 455f 4348 4543 4b5f 4552 4332 3022  NCE_CHECK_ERC20"
+00007b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007b20: 2020 2243 5259 5054 4f50 554e 4b53 222c    "CRYPTOPUNKS",
+00007b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007b40: 2022 454c 454d 454e 545f 4d41 524b 4554   "ELEMENT_MARKET
+00007b50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00007b60: 2020 2022 4558 4543 5554 455f 5355 425f     "EXECUTE_SUB_
+00007b70: 504c 414e 222c 0a20 2020 2020 2020 2020  PLAN",.         
+00007b80: 2020 2020 2020 2022 464f 554e 4441 5449         "FOUNDATI
+00007b90: 4f4e 222c 0a20 2020 2020 2020 2020 2020  ON",.           
+00007ba0: 2020 2020 2022 4c4f 4f4b 535f 5241 5245       "LOOKS_RARE
+00007bb0: 5f31 3135 3522 2c0a 2020 2020 2020 2020  _1155",.        
+00007bc0: 2020 2020 2020 2020 224c 4f4f 4b53 5f52          "LOOKS_R
+00007bd0: 4152 455f 3732 3122 2c0a 2020 2020 2020  ARE_721",.      
+00007be0: 2020 2020 2020 2020 2020 224e 4654 3230            "NFT20
+00007bf0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00007c00: 2020 2022 4e46 5458 222c 0a20 2020 2020     "NFTX",.     
+00007c10: 2020 2020 2020 2020 2020 2022 4f57 4e45             "OWNE
+00007c20: 525f 4348 4543 4b5f 3131 3535 222c 0a20  R_CHECK_1155",. 
+00007c30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00007c40: 4f57 4e45 525f 4348 4543 4b5f 3732 3122  OWNER_CHECK_721"
+00007c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007c60: 2020 2250 4552 4d49 5432 5f50 4552 4d49    "PERMIT2_PERMI
+00007c70: 545f 4241 5443 4822 2c0a 2020 2020 2020  T_BATCH",.      
+00007c80: 2020 2020 2020 2020 2020 2250 4552 4d49            "PERMI
+00007c90: 5432 5f50 4552 4d49 5422 2c0a 2020 2020  T2_PERMIT",.    
+00007ca0: 2020 2020 2020 2020 2020 2020 2250 4552              "PER
+00007cb0: 4d49 5432 5f54 5241 4e53 4645 525f 4652  MIT2_TRANSFER_FR
+00007cc0: 4f4d 5f42 4154 4348 222c 0a20 2020 2020  OM_BATCH",.     
+00007cd0: 2020 2020 2020 2020 2020 2022 5045 524d             "PERM
+00007ce0: 4954 325f 5452 414e 5346 4552 5f46 524f  IT2_TRANSFER_FRO
+00007cf0: 4d22 2c0a 2020 2020 2020 2020 2020 2020  M",.            
+00007d00: 2020 2020 2253 4541 504f 5254 5f56 3222      "SEAPORT_V2"
+00007d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007d20: 2020 2253 4541 504f 5254 222c 0a20 2020    "SEAPORT",.   
+00007d30: 2020 2020 2020 2020 2020 2020 2022 5355               "SU
+00007d40: 444f 5357 4150 222c 0a20 2020 2020 2020  DOSWAP",.       
+00007d50: 2020 2020 2020 2020 2022 5357 4545 505f           "SWEEP_
+00007d60: 4552 4331 3135 3522 2c0a 2020 2020 2020  ERC1155",.      
+00007d70: 2020 2020 2020 2020 2020 2253 5745 4550            "SWEEP
+00007d80: 5f45 5243 3732 3122 2c0a 2020 2020 2020  _ERC721",.      
+00007d90: 2020 2020 2020 2020 2020 2254 5241 4e53            "TRANS
+00007da0: 4645 5222 2c0a 2020 2020 2020 2020 2020  FER",.          
+00007db0: 2020 2020 2020 2258 3259 325f 3131 3535        "X2Y2_1155
+00007dc0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00007dd0: 2020 2022 5832 5932 5f37 3231 222c 0a20     "X2Y2_721",. 
+00007de0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00007df0: 2020 2020 2020 2020 2020 434f 4d4d 414e            COMMAN
+00007e00: 445f 5459 5045 5f4d 4153 4b20 3d20 3078  D_TYPE_MASK = 0x
+00007e10: 3346 0a20 2020 2020 2020 2020 2020 2063  3F.            c
+00007e20: 6f6d 6d61 6e64 203d 2055 4e49 5645 5253  ommand = UNIVERS
+00007e30: 414c 5f52 4f55 5445 525f 434f 4d4d 414e  AL_ROUTER_COMMAN
+00007e40: 445f 5641 4c55 4553 5b63 6f6d 6d61 6e64  D_VALUES[command
+00007e50: 5f74 7970 6520 2620 434f 4d4d 414e 445f  _type & COMMAND_
+00007e60: 5459 5045 5f4d 4153 4b5d 0a0a 2020 2020  TYPE_MASK]..    
+00007e70: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00007e80: 6562 7567 2866 2250 726f 6365 7373 696e  ebug(f"Processin
+00007e90: 6720 556e 6976 6572 7361 6c20 526f 7574  g Universal Rout
+00007ea0: 6572 2063 6f6d 6d61 6e64 3a20 7b63 6f6d  er command: {com
+00007eb0: 6d61 6e64 7d22 290a 0a20 2020 2020 2020  mand}")..       
+00007ec0: 2020 2020 2069 6620 5459 5045 5f43 4845       if TYPE_CHE
+00007ed0: 434b 494e 473a 0a20 2020 2020 2020 2020  CKING:.         
+00007ee0: 2020 2020 2020 205f 616d 6f75 6e74 5f69         _amount_i
+00007ef0: 6e3a 2069 6e74 203d 2030 0a20 2020 2020  n: int = 0.     
+00007f00: 2020 2020 2020 2020 2020 205f 616d 6f75             _amou
+00007f10: 6e74 5f6f 7574 3a20 696e 7420 3d20 300a  nt_out: int = 0.
+00007f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f30: 5f73 696d 5f72 6573 756c 743a 2055 6e69  _sim_result: Uni
+00007f40: 7377 6170 5632 506f 6f6c 5369 6d75 6c61  swapV2PoolSimula
+00007f50: 7469 6f6e 5265 7375 6c74 207c 2055 6e69  tionResult | Uni
+00007f60: 7377 6170 5633 506f 6f6c 5369 6d75 6c61  swapV3PoolSimula
+00007f70: 7469 6f6e 5265 7375 6c74 0a0a 2020 2020  tionResult..    
+00007f80: 2020 2020 2020 2020 6d61 7463 6820 636f          match co
+00007f90: 6d6d 616e 643a 0a20 2020 2020 2020 2020  mmand:.         
+00007fa0: 2020 2020 2020 2063 6173 6520 2253 5745         case "SWE
+00007fb0: 4550 223a 0a20 2020 2020 2020 2020 2020  EP":.           
+00007fc0: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+00007fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fe0: 2054 6869 7320 6675 6e63 7469 6f6e 2074   This function t
+00007ff0: 7261 6e73 6665 7273 2074 6865 2063 7572  ransfers the cur
+00008000: 7265 6e74 2074 6f6b 656e 2062 616c 616e  rent token balan
+00008010: 6365 2068 656c 6420 6279 2074 6865 2063  ce held by the c
+00008020: 6f6e 7472 6163 7420 746f 2060 7265 6369  ontract to `reci
+00008030: 7069 656e 7460 0a20 2020 2020 2020 2020  pient`.         
+00008040: 2020 2020 2020 2020 2020 2022 2222 0a0a             """..
+00008050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008060: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00008070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008080: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00008090: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000080a0: 7765 6570 5f74 6f6b 656e 5f61 6464 7265  weep_token_addre
+000080b0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+000080c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080d0: 7377 6565 705f 7265 6369 7069 656e 742c  sweep_recipient,
+000080e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000080f0: 2020 2020 2020 2020 2020 2020 2073 7765               swe
+00008100: 6570 5f61 6d6f 756e 745f 6d69 6e2c 0a20  ep_amount_min,. 
+00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008120: 2020 2020 2020 2029 203d 2065 7468 5f61         ) = eth_a
+00008130: 6269 2e61 6269 2e64 6563 6f64 6528 0a20  bi.abi.decode(. 
+00008140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008150: 2020 2020 2020 2020 2020 2074 7970 6573             types
+00008160: 3d28 2261 6464 7265 7373 222c 2022 6164  =("address", "ad
+00008170: 6472 6573 7322 2c20 2275 696e 7432 3536  dress", "uint256
+00008180: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00008190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081a0: 6461 7461 3d69 6e70 7574 732c 0a20 2020  data=inputs,.   
+000081b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081c0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000081d0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000081e0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+000081f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008200: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00008210: 4572 726f 7228 6622 436f 756c 6420 6e6f  Error(f"Could no
+00008220: 7420 6465 636f 6465 2069 6e70 7574 2066  t decode input f
+00008230: 6f72 207b 636f 6d6d 616e 647d 2229 0a0a  or {command}")..
 00008240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008250: 2020 2020 2020 2020 2020 2020 7377 6565              swee
-00008260: 705f 746f 6b65 6e5f 6164 6472 6573 732c  p_token_address,
-00008270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008280: 2020 2020 2020 2020 2020 2020 2073 7765               swe
-00008290: 6570 5f72 6563 6970 6965 6e74 2c0a 2020  ep_recipient,.  
-000082a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082b0: 2020 2020 2020 2020 2020 7377 6565 705f            sweep_
-000082c0: 616d 6f75 6e74 5f6d 696e 2c0a 2020 2020  amount_min,.    
-000082d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082e0: 2020 2020 2920 3d20 6574 685f 6162 692e      ) = eth_abi.
-000082f0: 6162 692e 6465 636f 6465 280a 2020 2020  abi.decode(.    
-00008300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008310: 2020 2020 2020 2020 7479 7065 733d 2822          types=("
-00008320: 6164 6472 6573 7322 2c20 2261 6464 7265  address", "addre
-00008330: 7373 222c 2022 7569 6e74 3235 3622 292c  ss", "uint256"),
-00008340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008350: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00008360: 613d 696e 7075 7473 2c0a 2020 2020 2020  a=inputs,.      
-00008370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008380: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00008390: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-000083a0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-000083b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083c0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000083d0: 6f72 2866 2243 6f75 6c64 206e 6f74 2064  or(f"Could not d
-000083e0: 6563 6f64 6520 696e 7075 7420 666f 7220  ecode input for 
-000083f0: 7b63 6f6d 6d61 6e64 7d22 290a 0a20 2020  {command}")..   
-00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 206d 6174 6368 2073 7765 6570 5f72 6563   match sweep_rec
-00008420: 6970 6965 6e74 3a0a 2020 2020 2020 2020  ipient:.        
-00008430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008440: 6361 7365 2055 6e69 7665 7273 616c 526f  case UniversalRo
-00008450: 7574 6572 5370 6563 6961 6c41 6464 7265  uterSpecialAddre
-00008460: 7373 2e4d 5347 5f53 454e 4445 523a 0a20  ss.MSG_SENDER:. 
-00008470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008480: 2020 2020 2020 2020 2020 2073 7765 6570             sweep
-00008490: 5f72 6563 6970 6965 6e74 203d 2073 656c  _recipient = sel
-000084a0: 662e 7365 6e64 6572 0a20 2020 2020 2020  f.sender.       
-000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084c0: 2063 6173 6520 556e 6976 6572 7361 6c52   case UniversalR
-000084d0: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
-000084e0: 6573 732e 524f 5554 4552 3a0a 2020 2020  ess.ROUTER:.    
+00008250: 2020 2020 6d61 7463 6820 7377 6565 705f      match sweep_
+00008260: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
+00008270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008280: 2020 2063 6173 6520 556e 6976 6572 7361     case Universa
+00008290: 6c52 6f75 7465 7253 7065 6369 616c 4164  lRouterSpecialAd
+000082a0: 6472 6573 732e 4d53 475f 5345 4e44 4552  dress.MSG_SENDER
+000082b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000082c0: 2020 2020 2020 2020 2020 2020 2020 7377                sw
+000082d0: 6565 705f 7265 6369 7069 656e 7420 3d20  eep_recipient = 
+000082e0: 7365 6c66 2e73 656e 6465 720a 2020 2020  self.sender.    
+000082f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008300: 2020 2020 6361 7365 2055 6e69 7665 7273      case Univers
+00008310: 616c 526f 7574 6572 5370 6563 6961 6c41  alRouterSpecialA
+00008320: 6464 7265 7373 2e52 4f55 5445 523a 0a20  ddress.ROUTER:. 
+00008330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008340: 2020 2020 2020 2020 2020 2073 7765 6570             sweep
+00008350: 5f72 6563 6970 6965 6e74 203d 2073 656c  _recipient = sel
+00008360: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
+00008370: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008380: 2020 2020 2020 7377 6565 705f 746f 6b65        sweep_toke
+00008390: 6e5f 6261 6c61 6e63 6520 3d20 7365 6c66  n_balance = self
+000083a0: 2e6c 6564 6765 722e 746f 6b65 6e5f 6261  .ledger.token_ba
+000083b0: 6c61 6e63 6528 0a20 2020 2020 2020 2020  lance(.         
+000083c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000083d0: 656c 662e 726f 7574 6572 5f61 6464 7265  elf.router_addre
+000083e0: 7373 2c20 7377 6565 705f 746f 6b65 6e5f  ss, sweep_token_
+000083f0: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00008400: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00008410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008420: 2020 2069 6620 7377 6565 705f 746f 6b65     if sweep_toke
+00008430: 6e5f 6261 6c61 6e63 6520 3c20 7377 6565  n_balance < swee
+00008440: 705f 616d 6f75 6e74 5f6d 696e 3a0a 2020  p_amount_min:.  
+00008450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008460: 2020 2020 2020 7261 6973 6520 5472 616e        raise Tran
+00008470: 7361 6374 696f 6e45 7272 6f72 280a 2020  sactionError(.  
+00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008490: 2020 2020 2020 2020 2020 6622 5265 7175            f"Requ
+000084a0: 6573 7465 6420 7377 6565 7020 6f66 206d  ested sweep of m
+000084b0: 696e 2e20 7b73 7765 6570 5f61 6d6f 756e  in. {sweep_amoun
+000084c0: 745f 6d69 6e7d 2057 4554 482c 2072 6563  t_min} WETH, rec
+000084d0: 6569 7665 6420 7b73 7765 6570 5f74 6f6b  eived {sweep_tok
+000084e0: 656e 5f62 616c 616e 6365 7d22 0a20 2020  en_balance}".   
 000084f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008500: 2020 2020 2020 2020 7377 6565 705f 7265          sweep_re
-00008510: 6369 7069 656e 7420 3d20 7365 6c66 2e72  cipient = self.r
-00008520: 6f75 7465 725f 6164 6472 6573 730a 0a20  outer_address.. 
-00008530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008540: 2020 2073 7765 6570 5f74 6f6b 656e 5f62     sweep_token_b
-00008550: 616c 616e 6365 203d 2073 656c 662e 6c65  alance = self.le
-00008560: 6467 6572 2e74 6f6b 656e 5f62 616c 616e  dger.token_balan
-00008570: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00008580: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00008590: 2e72 6f75 7465 725f 6164 6472 6573 732c  .router_address,
-000085a0: 2073 7765 6570 5f74 6f6b 656e 5f61 6464   sweep_token_add
-000085b0: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
-000085c0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000085d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085e0: 6966 2073 7765 6570 5f74 6f6b 656e 5f62  if sweep_token_b
-000085f0: 616c 616e 6365 203c 2073 7765 6570 5f61  alance < sweep_a
-00008600: 6d6f 756e 745f 6d69 6e3a 0a20 2020 2020  mount_min:.     
-00008610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008620: 2020 2072 6169 7365 2054 7261 6e73 6163     raise Transac
-00008630: 7469 6f6e 4572 726f 7228 0a20 2020 2020  tionError(.     
-00008640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008650: 2020 2020 2020 2066 2252 6571 7565 7374         f"Request
-00008660: 6564 2073 7765 6570 206f 6620 6d69 6e2e  ed sweep of min.
-00008670: 207b 7377 6565 705f 616d 6f75 6e74 5f6d   {sweep_amount_m
-00008680: 696e 7d20 5745 5448 2c20 7265 6365 6976  in} WETH, receiv
-00008690: 6564 207b 7377 6565 705f 746f 6b65 6e5f  ed {sweep_token_
-000086a0: 6261 6c61 6e63 657d 220a 2020 2020 2020  balance}".      
-000086b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086c0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-000086d0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-000086e0: 696d 756c 6174 655f 7377 6565 7028 7377  imulate_sweep(sw
-000086f0: 6565 705f 746f 6b65 6e5f 6164 6472 6573  eep_token_addres
-00008700: 732c 2073 7765 6570 5f72 6563 6970 6965  s, sweep_recipie
-00008710: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-00008720: 2020 2020 2063 6173 6520 2250 4159 5f50       case "PAY_P
-00008730: 4f52 5449 4f4e 223a 0a20 2020 2020 2020  ORTION":.       
-00008740: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00008750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008760: 2020 2020 2054 7261 6e73 6665 7273 2061       Transfers a
-00008770: 2070 6f72 7469 6f6e 206f 6620 7468 6520   portion of the 
-00008780: 6375 7272 656e 7420 746f 6b65 6e20 6261  current token ba
-00008790: 6c61 6e63 6520 6865 6c64 2062 7920 7468  lance held by th
-000087a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000087b0: 2020 2020 2020 636f 6e74 7261 6374 2074        contract t
-000087c0: 6f20 6072 6563 6970 6965 6e74 600a 2020  o `recipient`.  
-000087d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000087e0: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-000087f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00008800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008810: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008830: 2020 2020 2020 5f70 6179 5f70 6f72 7469        _pay_porti
-00008840: 6f6e 5f74 6f6b 656e 5f61 6464 7265 7373  on_token_address
-00008850: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008860: 2020 2020 2020 2020 2020 2020 2020 5f70                _p
-00008870: 6179 5f70 6f72 7469 6f6e 5f72 6563 6970  ay_portion_recip
-00008880: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-00008890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000088a0: 2020 5f70 6179 5f70 6f72 7469 6f6e 5f62    _pay_portion_b
-000088b0: 6970 732c 0a20 2020 2020 2020 2020 2020  ips,.           
-000088c0: 2020 2020 2020 2020 2020 2020 2029 203d               ) =
-000088d0: 2065 7468 5f61 6269 2e61 6269 2e64 6563   eth_abi.abi.dec
-000088e0: 6f64 6528 0a20 2020 2020 2020 2020 2020  ode(.           
-000088f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008900: 2074 7970 6573 3d28 2261 6464 7265 7373   types=("address
-00008910: 222c 2022 6164 6472 6573 7322 2c20 2275  ", "address", "u
-00008920: 696e 7432 3536 2229 2c0a 2020 2020 2020  int256"),.      
-00008930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008940: 2020 2020 2020 6461 7461 3d69 6e70 7574        data=input
-00008950: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00008960: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00008970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008980: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00008990: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-000089a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000089b0: 2056 616c 7565 4572 726f 7228 6622 436f   ValueError(f"Co
-000089c0: 756c 6420 6e6f 7420 6465 636f 6465 2069  uld not decode i
-000089d0: 6e70 7574 2066 6f72 207b 636f 6d6d 616e  nput for {comman
-000089e0: 647d 2229 0a0a 2020 2020 2020 2020 2020  d}")..          
-000089f0: 2020 2020 2020 2020 2020 2320 7265 663a            # ref:
-00008a00: 2068 7474 7073 3a2f 2f64 6f63 732e 756e   https://docs.un
-00008a10: 6973 7761 702e 6f72 672f 636f 6e74 7261  iswap.org/contra
-00008a20: 6374 732f 756e 6976 6572 7361 6c2d 726f  cts/universal-ro
-00008a30: 7574 6572 2f74 6563 686e 6963 616c 2d72  uter/technical-r
-00008a40: 6566 6572 656e 6365 2370 6179 5f70 6f72  eference#pay_por
-00008a50: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00008a60: 2020 2020 2020 2020 2023 2072 6566 3a20           # ref: 
-00008a70: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-00008a80: 6f6d 2f55 6e69 7377 6170 2f75 6e69 7665  om/Uniswap/unive
-00008a90: 7273 616c 2d72 6f75 7465 722f 626c 6f62  rsal-router/blob
-00008aa0: 2f6d 6169 6e2f 636f 6e74 7261 6374 732f  /main/contracts/
-00008ab0: 6c69 6272 6172 6965 732f 436f 6e73 7461  libraries/Consta
-00008ac0: 6e74 732e 736f 6c0a 2020 2020 2020 2020  nts.sol.        
-00008ad0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-00008ae0: 444f 3a20 7265 6661 6374 6f72 2069 6620  DO: refactor if 
-00008af0: 6c65 6467 6572 206e 6565 6473 2074 6f20  ledger needs to 
-00008b00: 7375 7070 6f72 7420 4554 4820 6261 6c61  support ETH bala
-00008b10: 6e63 6573 0a20 2020 2020 2020 2020 2020  nces.           
-00008b20: 2020 2020 2020 2020 2069 6620 5f70 6179           if _pay
-00008b30: 5f70 6f72 7469 6f6e 5f74 6f6b 656e 5f61  _portion_token_a
-00008b40: 6464 7265 7373 203d 3d20 556e 6976 6572  ddress == Univer
-00008b50: 7361 6c52 6f75 7465 7253 7065 6369 616c  salRouterSpecial
-00008b60: 4164 6472 6573 732e 4554 483a 0a20 2020  Address.ETH:.   
-00008b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b80: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00008b90: 2822 5041 595f 504f 5254 494f 4e20 6361  ("PAY_PORTION ca
-00008ba0: 6c6c 6564 2077 6974 6820 4554 4820 7368  lled with ETH sh
-00008bb0: 6f72 7468 616e 6422 290a 0a20 2020 2020  orthand")..     
-00008bc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00008bd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00008be0: 2020 2020 2020 2020 2020 2020 2073 7765               swe
-00008bf0: 6570 5f74 6f6b 656e 5f62 616c 616e 6365  ep_token_balance
-00008c00: 203d 2073 656c 662e 6c65 6467 6572 2e74   = self.ledger.t
-00008c10: 6f6b 656e 5f62 616c 616e 6365 280a 2020  oken_balance(.  
-00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c30: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00008c40: 6f75 7465 725f 6164 6472 6573 732c 205f  outer_address, _
-00008c50: 7061 795f 706f 7274 696f 6e5f 746f 6b65  pay_portion_toke
-00008c60: 6e5f 6164 6472 6573 730a 2020 2020 2020  n_address.      
-00008c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00008c90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00008ca0: 2e6c 6564 6765 722e 7472 616e 7366 6572  .ledger.transfer
-00008cb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008cc0: 2020 2020 2020 2020 2020 2020 2020 5f70                _p
-00008cd0: 6179 5f70 6f72 7469 6f6e 5f74 6f6b 656e  ay_portion_token
-00008ce0: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d00: 2020 2020 2020 7377 6565 705f 746f 6b65        sweep_toke
-00008d10: 6e5f 6261 6c61 6e63 6520 2a20 5f70 6179  n_balance * _pay
-00008d20: 5f70 6f72 7469 6f6e 5f62 6970 7320 2f2f  _portion_bips //
-00008d30: 2031 305f 3030 302c 0a20 2020 2020 2020   10_000,.       
-00008d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d50: 2020 2020 2073 656c 662e 726f 7574 6572       self.router
-00008d60: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
-00008d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d80: 2020 2020 2020 5f70 6179 5f70 6f72 7469        _pay_porti
-00008d90: 6f6e 5f72 6563 6970 6965 6e74 2c0a 2020  on_recipient,.  
-00008da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008db0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00008dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008dd0: 7365 6c66 2e72 6563 6970 6965 6e74 732e  self.recipients.
-00008de0: 6164 6428 746f 5f63 6865 636b 7375 6d5f  add(to_checksum_
-00008df0: 6164 6472 6573 7328 5f70 6179 5f70 6f72  address(_pay_por
-00008e00: 7469 6f6e 5f72 6563 6970 6965 6e74 2929  tion_recipient))
-00008e10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00008e20: 2020 6361 7365 2022 5752 4150 5f45 5448    case "WRAP_ETH
-00008e30: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00008e40: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00008e50: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-00008e60: 6869 7320 6675 6e63 7469 6f6e 2077 7261  his function wra
-00008e70: 7073 2061 2071 7561 6e74 6974 7920 6f66  ps a quantity of
-00008e80: 2045 5448 2074 6f20 5745 5448 2061 6e64   ETH to WETH and
-00008e90: 2074 7261 6e73 6665 7273 2069 740a 2020   transfers it.  
-00008ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008eb0: 2020 746f 2060 7265 6369 7069 656e 7460    to `recipient`
-00008ec0: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
-00008ed0: 2020 2020 2020 2054 6865 206d 6169 6e6e         The mainn
-00008ee0: 6574 2057 4554 4820 636f 6e74 7261 6374  et WETH contract
-00008ef0: 206f 6e6c 7920 696d 706c 656d 656e 7473   only implements
-00008f00: 2074 6865 2060 6465 706f 7369 7460 206d   the `deposit` m
-00008f10: 6574 686f 642c 0a20 2020 2020 2020 2020  ethod,.         
-00008f20: 2020 2020 2020 2020 2020 2073 6f20 6072             so `r
-00008f30: 6563 6970 6965 6e74 6020 7769 6c6c 2061  ecipient` will a
-00008f40: 6c77 6179 7320 6265 2074 6865 2072 6f75  lways be the rou
-00008f50: 7465 7220 6164 6472 6573 732e 0a0a 2020  ter address...  
+00008500: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00008510: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008520: 2e5f 7369 6d75 6c61 7465 5f73 7765 6570  ._simulate_sweep
+00008530: 2873 7765 6570 5f74 6f6b 656e 5f61 6464  (sweep_token_add
+00008540: 7265 7373 2c20 7377 6565 705f 7265 6369  ress, sweep_reci
+00008550: 7069 656e 7429 0a0a 2020 2020 2020 2020  pient)..        
+00008560: 2020 2020 2020 2020 6361 7365 2022 5041          case "PA
+00008570: 595f 504f 5254 494f 4e22 3a0a 2020 2020  Y_PORTION":.    
+00008580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008590: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+000085a0: 2020 2020 2020 2020 5472 616e 7366 6572          Transfer
+000085b0: 7320 6120 706f 7274 696f 6e20 6f66 2074  s a portion of t
+000085c0: 6865 2063 7572 7265 6e74 2074 6f6b 656e  he current token
+000085d0: 2062 616c 616e 6365 2068 656c 6420 6279   balance held by
+000085e0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+000085f0: 2020 2020 2020 2020 2063 6f6e 7472 6163           contrac
+00008600: 7420 746f 2060 7265 6369 7069 656e 7460  t to `recipient`
+00008610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008620: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00008630: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00008640: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00008650: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+00008660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008670: 2020 2020 2020 2020 205f 7061 795f 706f           _pay_po
+00008680: 7274 696f 6e5f 746f 6b65 6e5f 6164 6472  rtion_token_addr
+00008690: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+000086a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086b0: 205f 7061 795f 706f 7274 696f 6e5f 7265   _pay_portion_re
+000086c0: 6369 7069 656e 742c 0a20 2020 2020 2020  cipient,.       
+000086d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086e0: 2020 2020 205f 7061 795f 706f 7274 696f       _pay_portio
+000086f0: 6e5f 6269 7073 2c0a 2020 2020 2020 2020  n_bips,.        
+00008700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008710: 2920 3d20 6574 685f 6162 692e 6162 692e  ) = eth_abi.abi.
+00008720: 6465 636f 6465 280a 2020 2020 2020 2020  decode(.        
+00008730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008740: 2020 2020 7479 7065 733d 2822 6164 6472      types=("addr
+00008750: 6573 7322 2c20 2261 6464 7265 7373 222c  ess", "address",
+00008760: 2022 7569 6e74 3235 3622 292c 0a20 2020   "uint256"),.   
+00008770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008780: 2020 2020 2020 2020 2064 6174 613d 696e           data=in
+00008790: 7075 7473 2c0a 2020 2020 2020 2020 2020  puts,.          
+000087a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000087d0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+000087e0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000087f0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00008800: 2243 6f75 6c64 206e 6f74 2064 6563 6f64  "Could not decod
+00008810: 6520 696e 7075 7420 666f 7220 7b63 6f6d  e input for {com
+00008820: 6d61 6e64 7d22 290a 0a20 2020 2020 2020  mand}")..       
+00008830: 2020 2020 2020 2020 2020 2020 2023 2072               # r
+00008840: 6566 3a20 6874 7470 733a 2f2f 646f 6373  ef: https://docs
+00008850: 2e75 6e69 7377 6170 2e6f 7267 2f63 6f6e  .uniswap.org/con
+00008860: 7472 6163 7473 2f75 6e69 7665 7273 616c  tracts/universal
+00008870: 2d72 6f75 7465 722f 7465 6368 6e69 6361  -router/technica
+00008880: 6c2d 7265 6665 7265 6e63 6523 7061 795f  l-reference#pay_
+00008890: 706f 7274 696f 6e0a 2020 2020 2020 2020  portion.        
+000088a0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+000088b0: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
+000088c0: 622e 636f 6d2f 556e 6973 7761 702f 756e  b.com/Uniswap/un
+000088d0: 6976 6572 7361 6c2d 726f 7574 6572 2f62  iversal-router/b
+000088e0: 6c6f 622f 6d61 696e 2f63 6f6e 7472 6163  lob/main/contrac
+000088f0: 7473 2f6c 6962 7261 7269 6573 2f43 6f6e  ts/libraries/Con
+00008900: 7374 616e 7473 2e73 6f6c 0a20 2020 2020  stants.sol.     
+00008910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00008920: 2054 4f44 4f3a 2072 6566 6163 746f 7220   TODO: refactor 
+00008930: 6966 206c 6564 6765 7220 6e65 6564 7320  if ledger needs 
+00008940: 746f 2073 7570 706f 7274 2045 5448 2062  to support ETH b
+00008950: 616c 616e 6365 730a 2020 2020 2020 2020  alances.        
+00008960: 2020 2020 2020 2020 2020 2020 6966 205f              if _
+00008970: 7061 795f 706f 7274 696f 6e5f 746f 6b65  pay_portion_toke
+00008980: 6e5f 6164 6472 6573 7320 3d3d 2055 6e69  n_address == Uni
+00008990: 7665 7273 616c 526f 7574 6572 5370 6563  versalRouterSpec
+000089a0: 6961 6c41 6464 7265 7373 2e45 5448 3a0a  ialAddress.ETH:.
+000089b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089c0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+000089d0: 6e66 6f28 2250 4159 5f50 4f52 5449 4f4e  nfo("PAY_PORTION
+000089e0: 2063 616c 6c65 6420 7769 7468 2045 5448   called with ETH
+000089f0: 2073 686f 7274 6861 6e64 2229 0a0a 2020   shorthand")..  
+00008a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00008a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a30: 7377 6565 705f 746f 6b65 6e5f 6261 6c61  sweep_token_bala
+00008a40: 6e63 6520 3d20 7365 6c66 2e6c 6564 6765  nce = self.ledge
+00008a50: 722e 746f 6b65 6e5f 6261 6c61 6e63 6528  r.token_balance(
+00008a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008a70: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00008a80: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
+00008a90: 2c20 5f70 6179 5f70 6f72 7469 6f6e 5f74  , _pay_portion_t
+00008aa0: 6f6b 656e 5f61 6464 7265 7373 0a20 2020  oken_address.   
+00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ac0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00008ad0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008ae0: 656c 662e 6c65 6467 6572 2e74 7261 6e73  elf.ledger.trans
+00008af0: 6665 7228 0a20 2020 2020 2020 2020 2020  fer(.           
+00008b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b10: 205f 7061 795f 706f 7274 696f 6e5f 746f   _pay_portion_to
+00008b20: 6b65 6e5f 6164 6472 6573 732c 0a20 2020  ken_address,.   
+00008b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b40: 2020 2020 2020 2020 2073 7765 6570 5f74           sweep_t
+00008b50: 6f6b 656e 5f62 616c 616e 6365 202a 205f  oken_balance * _
+00008b60: 7061 795f 706f 7274 696f 6e5f 6269 7073  pay_portion_bips
+00008b70: 202f 2f20 3130 5f30 3030 2c0a 2020 2020   // 10_000,.    
+00008b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b90: 2020 2020 2020 2020 7365 6c66 2e72 6f75          self.rou
+00008ba0: 7465 725f 6164 6472 6573 732c 0a20 2020  ter_address,.   
+00008bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bc0: 2020 2020 2020 2020 205f 7061 795f 706f           _pay_po
+00008bd0: 7274 696f 6e5f 7265 6369 7069 656e 742c  rtion_recipient,
+00008be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008bf0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00008c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c10: 2020 2073 656c 662e 7265 6369 7069 656e     self.recipien
+00008c20: 7473 2e61 6464 2874 6f5f 6368 6563 6b73  ts.add(to_checks
+00008c30: 756d 5f61 6464 7265 7373 285f 7061 795f  um_address(_pay_
+00008c40: 706f 7274 696f 6e5f 7265 6369 7069 656e  portion_recipien
+00008c50: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
+00008c60: 2020 2020 2063 6173 6520 2257 5241 505f       case "WRAP_
+00008c70: 4554 4822 3a0a 2020 2020 2020 2020 2020  ETH":.          
+00008c80: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
+00008c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ca0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+00008cb0: 7772 6170 7320 6120 7175 616e 7469 7479  wraps a quantity
+00008cc0: 206f 6620 4554 4820 746f 2057 4554 4820   of ETH to WETH 
+00008cd0: 616e 6420 7472 616e 7366 6572 7320 6974  and transfers it
+00008ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008cf0: 2020 2020 2074 6f20 6072 6563 6970 6965       to `recipie
+00008d00: 6e74 602e 0a0a 2020 2020 2020 2020 2020  nt`...          
+00008d10: 2020 2020 2020 2020 2020 5468 6520 6d61            The ma
+00008d20: 696e 6e65 7420 5745 5448 2063 6f6e 7472  innet WETH contr
+00008d30: 6163 7420 6f6e 6c79 2069 6d70 6c65 6d65  act only impleme
+00008d40: 6e74 7320 7468 6520 6064 6570 6f73 6974  nts the `deposit
+00008d50: 6020 6d65 7468 6f64 2c0a 2020 2020 2020  ` method,.      
+00008d60: 2020 2020 2020 2020 2020 2020 2020 736f                so
+00008d70: 2060 7265 6369 7069 656e 7460 2077 696c   `recipient` wil
+00008d80: 6c20 616c 7761 7973 2062 6520 7468 6520  l always be the 
+00008d90: 726f 7574 6572 2061 6464 7265 7373 2e0a  router address..
+00008da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008db0: 2020 2020 2053 6f6d 6520 4c32 7320 616e       Some L2s an
+00008dc0: 6420 7369 6465 2063 6861 696e 7320 696d  d side chains im
+00008dd0: 706c 656d 656e 7420 6120 6064 6570 6f73  plement a `depos
+00008de0: 6974 546f 6020 6d65 7468 6f64 2c20 736f  itTo` method, so
+00008df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008e00: 2020 2020 2060 7265 6369 7069 656e 7460       `recipient`
+00008e10: 2069 7320 6576 616c 7561 7465 6420 6265   is evaluated be
+00008e20: 666f 7265 2061 646a 7573 7469 6e67 2074  fore adjusting t
+00008e30: 6865 206c 6564 6765 7220 6261 6c61 6e63  he ledger balanc
+00008e40: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+00008e50: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00008e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e70: 7478 5f72 6563 6970 6965 6e74 3a20 4368  tx_recipient: Ch
+00008e80: 6563 6b73 756d 4164 6472 6573 730a 2020  ecksumAddress.  
+00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ea0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00008eb0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00008ec0: 7478 5f72 6563 6970 6965 6e74 2c20 5f77  tx_recipient, _w
+00008ed0: 7261 705f 616d 6f75 6e74 5f6d 696e 203d  rap_amount_min =
+00008ee0: 2065 7468 5f61 6269 2e61 6269 2e64 6563   eth_abi.abi.dec
+00008ef0: 6f64 6528 0a20 2020 2020 2020 2020 2020  ode(.           
+00008f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f10: 2074 7970 6573 3d28 2261 6464 7265 7373   types=("address
+00008f20: 222c 2022 7569 6e74 3235 3622 292c 0a20  ", "uint256"),. 
+00008f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f40: 2020 2020 2020 2020 2020 2064 6174 613d             data=
+00008f50: 696e 7075 7473 2c0a 2020 2020 2020 2020  inputs,.        
 00008f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f70: 2020 536f 6d65 204c 3273 2061 6e64 2073    Some L2s and s
-00008f80: 6964 6520 6368 6169 6e73 2069 6d70 6c65  ide chains imple
-00008f90: 6d65 6e74 2061 2060 6465 706f 7369 7454  ment a `depositT
-00008fa0: 6f60 206d 6574 686f 642c 2073 6f0a 2020  o` method, so.  
-00008fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008fc0: 2020 6072 6563 6970 6965 6e74 6020 6973    `recipient` is
-00008fd0: 2065 7661 6c75 6174 6564 2062 6566 6f72   evaluated befor
-00008fe0: 6520 6164 6a75 7374 696e 6720 7468 6520  e adjusting the 
-00008ff0: 6c65 6467 6572 2062 616c 616e 6365 2e0a  ledger balance..
-00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009010: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00009020: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00009030: 7265 6369 7069 656e 743a 2043 6865 636b  recipient: Check
-00009040: 7375 6d41 6464 7265 7373 0a20 2020 2020  sumAddress.     
-00009050: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00009060: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00009070: 2020 2020 2020 2020 2020 2020 5f74 785f              _tx_
-00009080: 7265 6369 7069 656e 742c 205f 7772 6170  recipient, _wrap
-00009090: 5f61 6d6f 756e 745f 6d69 6e20 3d20 6574  _amount_min = et
-000090a0: 685f 6162 692e 6162 692e 6465 636f 6465  h_abi.abi.decode
-000090b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000090c0: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-000090d0: 7065 733d 2822 6164 6472 6573 7322 2c20  pes=("address", 
-000090e0: 2275 696e 7432 3536 2229 2c0a 2020 2020  "uint256"),.    
-000090f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009100: 2020 2020 2020 2020 6461 7461 3d69 6e70          data=inp
-00009110: 7574 732c 0a20 2020 2020 2020 2020 2020  uts,.           
-00009120: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00008f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00008f80: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00008f90: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+00008fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fb0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00008fc0: 2866 2243 6f75 6c64 206e 6f74 2064 6563  (f"Could not dec
+00008fd0: 6f64 6520 696e 7075 7420 666f 7220 7b63  ode input for {c
+00008fe0: 6f6d 6d61 6e64 7d22 290a 0a20 2020 2020  ommand}")..     
+00008ff0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00009000: 6174 6368 205f 7478 5f72 6563 6970 6965  atch _tx_recipie
+00009010: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00009020: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00009030: 2055 6e69 7665 7273 616c 526f 7574 6572   UniversalRouter
+00009040: 5370 6563 6961 6c41 6464 7265 7373 2e52  SpecialAddress.R
+00009050: 4f55 5445 523a 0a20 2020 2020 2020 2020  OUTER:.         
+00009060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009070: 2020 205f 7265 6369 7069 656e 7420 3d20     _recipient = 
+00009080: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
+00009090: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+000090a0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+000090b0: 2055 6e69 7665 7273 616c 526f 7574 6572   UniversalRouter
+000090c0: 5370 6563 6961 6c41 6464 7265 7373 2e4d  SpecialAddress.M
+000090d0: 5347 5f53 454e 4445 523a 0a20 2020 2020  SG_SENDER:.     
+000090e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090f0: 2020 2020 2020 205f 7265 6369 7069 656e         _recipien
+00009100: 7420 3d20 7365 6c66 2e73 656e 6465 720a  t = self.sender.
+00009110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009120: 2020 2020 2020 2020 6361 7365 205f 3a0a          case _:.
 00009130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009140: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00009150: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00009160: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00009170: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00009180: 436f 756c 6420 6e6f 7420 6465 636f 6465  Could not decode
-00009190: 2069 6e70 7574 2066 6f72 207b 636f 6d6d   input for {comm
-000091a0: 616e 647d 2229 0a0a 2020 2020 2020 2020  and}")..        
-000091b0: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-000091c0: 6820 5f74 785f 7265 6369 7069 656e 743a  h _tx_recipient:
-000091d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000091e0: 2020 2020 2020 2020 2063 6173 6520 556e           case Un
-000091f0: 6976 6572 7361 6c52 6f75 7465 7253 7065  iversalRouterSpe
-00009200: 6369 616c 4164 6472 6573 732e 524f 5554  cialAddress.ROUT
-00009210: 4552 3a0a 2020 2020 2020 2020 2020 2020  ER:.            
-00009220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009230: 5f72 6563 6970 6965 6e74 203d 2073 656c  _recipient = sel
-00009240: 662e 726f 7574 6572 5f61 6464 7265 7373  f.router_address
-00009250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009260: 2020 2020 2020 2020 2063 6173 6520 556e           case Un
-00009270: 6976 6572 7361 6c52 6f75 7465 7253 7065  iversalRouterSpe
-00009280: 6369 616c 4164 6472 6573 732e 4d53 475f  cialAddress.MSG_
-00009290: 5345 4e44 4552 3a0a 2020 2020 2020 2020  SENDER:.        
-000092a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092b0: 2020 2020 5f72 6563 6970 6965 6e74 203d      _recipient =
-000092c0: 2073 656c 662e 7365 6e64 6572 0a20 2020   self.sender.   
-000092d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092e0: 2020 2020 2063 6173 6520 5f3a 0a20 2020       case _:.   
-000092f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009300: 2020 2020 2020 2020 205f 7265 6369 7069           _recipi
-00009310: 656e 7420 3d20 746f 5f63 6865 636b 7375  ent = to_checksu
-00009320: 6d5f 6164 6472 6573 7328 5f74 785f 7265  m_address(_tx_re
-00009330: 6369 7069 656e 7429 0a0a 2020 2020 2020  cipient)..      
-00009340: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00009350: 6966 2074 785f 7265 6369 7069 656e 7420  if tx_recipient 
-00009360: 3d3d 2055 6e69 7665 7273 616c 526f 7574  == UniversalRout
-00009370: 6572 5370 6563 6961 6c41 6464 7265 7373  erSpecialAddress
-00009380: 2e52 4f55 5445 523a 0a20 2020 2020 2020  .ROUTER:.       
-00009390: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-000093a0: 2020 205f 7265 6369 7069 656e 7420 3d20     _recipient = 
-000093b0: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
-000093c0: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
-000093d0: 2020 2020 2020 2020 2320 656c 7365 3a0a          # else:.
-000093e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093f0: 2020 2020 2320 2020 2020 5f72 6563 6970      #     _recip
-00009400: 6965 6e74 203d 2074 785f 7265 6369 7069  ient = tx_recipi
-00009410: 656e 740a 0a20 2020 2020 2020 2020 2020  ent..           
-00009420: 2020 2020 2020 2020 205f 7772 6170 7065           _wrappe
-00009430: 645f 746f 6b65 6e5f 6164 6472 6573 7320  d_token_address 
-00009440: 3d20 5752 4150 5045 445f 4e41 5449 5645  = WRAPPED_NATIVE
-00009450: 5f54 4f4b 454e 535b 7365 6c66 2e63 6861  _TOKENS[self.cha
-00009460: 696e 5f69 645d 0a0a 2020 2020 2020 2020  in_id]..        
-00009470: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009480: 2e6c 6564 6765 722e 6164 6a75 7374 280a  .ledger.adjust(.
-00009490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094a0: 2020 2020 2020 2020 5f72 6563 6970 6965          _recipie
-000094b0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-000094c0: 2020 2020 2020 2020 2020 2020 5f77 7261              _wra
-000094d0: 7070 6564 5f74 6f6b 656e 5f61 6464 7265  pped_token_addre
-000094e0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000094f0: 2020 2020 2020 2020 2020 2020 5f77 7261              _wra
-00009500: 705f 616d 6f75 6e74 5f6d 696e 2c0a 2020  p_amount_min,.  
-00009510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009520: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00009530: 2020 2020 2063 6173 6520 2255 4e57 5241       case "UNWRA
-00009540: 505f 5745 5448 223a 0a20 2020 2020 2020  P_WETH":.       
-00009550: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00009560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009570: 2020 2020 2054 6869 7320 6675 6e63 7469       This functi
-00009580: 6f6e 2075 6e77 7261 7073 2061 2071 7561  on unwraps a qua
-00009590: 6e74 6974 7920 6f66 2057 4554 4820 746f  ntity of WETH to
-000095a0: 2045 5448 2e0a 0a20 2020 2020 2020 2020   ETH...         
-000095b0: 2020 2020 2020 2020 2020 2045 5448 2069             ETH i
-000095c0: 7320 6375 7272 656e 746c 7920 756e 7472  s currently untr
-000095d0: 6163 6b65 6420 6279 2074 6865 206c 6564  acked by the led
-000095e0: 6765 722c 2073 6f20 6072 6563 6970 6965  ger, so `recipie
-000095f0: 6e74 6020 6973 0a20 2020 2020 2020 2020  nt` is.         
-00009600: 2020 2020 2020 2020 2020 2075 6e75 7365             unuse
-00009610: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-00009620: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00009630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009640: 2320 544f 444f 3a20 7072 6f63 6573 7320  # TODO: process 
-00009650: 4554 4820 6261 6c61 6e63 6520 696e 206c  ETH balance in l
-00009660: 6564 6765 7220 6966 206e 6565 6465 640a  edger if needed.
-00009670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009680: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00009690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096a0: 2020 5f75 6e77 7261 705f 7265 6369 7069    _unwrap_recipi
-000096b0: 656e 742c 205f 756e 7772 6170 5f61 6d6f  ent, _unwrap_amo
-000096c0: 756e 745f 6d69 6e20 3d20 6574 685f 6162  unt_min = eth_ab
-000096d0: 692e 6162 692e 6465 636f 6465 280a 2020  i.abi.decode(.  
-000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096f0: 2020 2020 2020 2020 2020 7479 7065 733d            types=
-00009700: 2822 6164 6472 6573 7322 2c20 2275 696e  ("address", "uin
-00009710: 7432 3536 2229 2c0a 2020 2020 2020 2020  t256"),.        
-00009720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009730: 2020 2020 6461 7461 3d69 6e70 7574 732c      data=inputs,
-00009740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009750: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00009760: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00009770: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00009780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009790: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-000097a0: 616c 7565 4572 726f 7228 6622 436f 756c  alueError(f"Coul
-000097b0: 6420 6e6f 7420 6465 636f 6465 2069 6e70  d not decode inp
-000097c0: 7574 2066 6f72 207b 636f 6d6d 616e 647d  ut for {command}
-000097d0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-000097e0: 2020 2020 2020 2020 5f77 7261 7070 6564          _wrapped
-000097f0: 5f74 6f6b 656e 5f61 6464 7265 7373 203d  _token_address =
-00009800: 2057 5241 5050 4544 5f4e 4154 4956 455f   WRAPPED_NATIVE_
-00009810: 544f 4b45 4e53 5b73 656c 662e 6368 6169  TOKENS[self.chai
-00009820: 6e5f 6964 5d0a 2020 2020 2020 2020 2020  n_id].          
-00009830: 2020 2020 2020 2020 2020 5f77 7261 7070            _wrapp
-00009840: 6564 5f74 6f6b 656e 5f62 616c 616e 6365  ed_token_balance
-00009850: 203d 2073 656c 662e 6c65 6467 6572 2e74   = self.ledger.t
-00009860: 6f6b 656e 5f62 616c 616e 6365 280a 2020  oken_balance(.  
-00009870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009880: 2020 2020 2020 7365 6c66 2e72 6f75 7465        self.route
-00009890: 725f 6164 6472 6573 732c 205f 7772 6170  r_address, _wrap
-000098a0: 7065 645f 746f 6b65 6e5f 6164 6472 6573  ped_token_addres
-000098b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000098c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000098d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000098e0: 5f77 7261 7070 6564 5f74 6f6b 656e 5f62  _wrapped_token_b
-000098f0: 616c 616e 6365 203c 205f 756e 7772 6170  alance < _unwrap
-00009900: 5f61 6d6f 756e 745f 6d69 6e3a 0a20 2020  _amount_min:.   
-00009910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009920: 2020 2020 2072 6169 7365 2054 7261 6e73       raise Trans
-00009930: 6163 7469 6f6e 4572 726f 7228 0a20 2020  actionError(.   
-00009940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009950: 2020 2020 2020 2020 2066 2252 6571 7565           f"Reque
-00009960: 7374 6564 2075 6e77 7261 7020 6f66 206d  sted unwrap of m
-00009970: 696e 2e20 7b5f 756e 7772 6170 5f61 6d6f  in. {_unwrap_amo
-00009980: 756e 745f 6d69 6e7d 2057 4554 482c 2072  unt_min} WETH, r
-00009990: 6563 6569 7665 6420 7b5f 7772 6170 7065  eceived {_wrappe
-000099a0: 645f 746f 6b65 6e5f 6261 6c61 6e63 657d  d_token_balance}
-000099b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000099c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00009140: 2020 2020 2020 2020 2020 2020 5f72 6563              _rec
+00009150: 6970 6965 6e74 203d 2074 6f5f 6368 6563  ipient = to_chec
+00009160: 6b73 756d 5f61 6464 7265 7373 285f 7478  ksum_address(_tx
+00009170: 5f72 6563 6970 6965 6e74 290a 0a20 2020  _recipient)..   
+00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009190: 2023 2069 6620 7478 5f72 6563 6970 6965   # if tx_recipie
+000091a0: 6e74 203d 3d20 556e 6976 6572 7361 6c52  nt == UniversalR
+000091b0: 6f75 7465 7253 7065 6369 616c 4164 6472  outerSpecialAddr
+000091c0: 6573 732e 524f 5554 4552 3a0a 2020 2020  ess.ROUTER:.    
+000091d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091e0: 2320 2020 2020 5f72 6563 6970 6965 6e74  #     _recipient
+000091f0: 203d 2073 656c 662e 726f 7574 6572 5f61   = self.router_a
+00009200: 6464 7265 7373 0a20 2020 2020 2020 2020  ddress.         
+00009210: 2020 2020 2020 2020 2020 2023 2065 6c73             # els
+00009220: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00009230: 2020 2020 2020 2023 2020 2020 205f 7265         #     _re
+00009240: 6369 7069 656e 7420 3d20 7478 5f72 6563  cipient = tx_rec
+00009250: 6970 6965 6e74 0a0a 2020 2020 2020 2020  ipient..        
+00009260: 2020 2020 2020 2020 2020 2020 5f77 7261              _wra
+00009270: 7070 6564 5f74 6f6b 656e 5f61 6464 7265  pped_token_addre
+00009280: 7373 203d 2057 5241 5050 4544 5f4e 4154  ss = WRAPPED_NAT
+00009290: 4956 455f 544f 4b45 4e53 5b73 656c 662e  IVE_TOKENS[self.
+000092a0: 6368 6169 6e5f 6964 5d0a 0a20 2020 2020  chain_id]..     
+000092b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000092c0: 656c 662e 6c65 6467 6572 2e61 646a 7573  elf.ledger.adjus
+000092d0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000092e0: 2020 2020 2020 2020 2020 205f 7265 6369             _reci
+000092f0: 7069 656e 742c 0a20 2020 2020 2020 2020  pient,.         
+00009300: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00009310: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
+00009320: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
+00009330: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00009340: 7772 6170 5f61 6d6f 756e 745f 6d69 6e2c  wrap_amount_min,
+00009350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009360: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009370: 2020 2020 2020 2020 6361 7365 2022 554e          case "UN
+00009380: 5752 4150 5f57 4554 4822 3a0a 2020 2020  WRAP_WETH":.    
+00009390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093a0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+000093b0: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
+000093c0: 6374 696f 6e20 756e 7772 6170 7320 6120  ction unwraps a 
+000093d0: 7175 616e 7469 7479 206f 6620 5745 5448  quantity of WETH
+000093e0: 2074 6f20 4554 482e 0a0a 2020 2020 2020   to ETH...      
+000093f0: 2020 2020 2020 2020 2020 2020 2020 4554                ET
+00009400: 4820 6973 2063 7572 7265 6e74 6c79 2075  H is currently u
+00009410: 6e74 7261 636b 6564 2062 7920 7468 6520  ntracked by the 
+00009420: 6c65 6467 6572 2c20 736f 2060 7265 6369  ledger, so `reci
+00009430: 7069 656e 7460 2069 730a 2020 2020 2020  pient` is.      
+00009440: 2020 2020 2020 2020 2020 2020 2020 756e                un
+00009450: 7573 6564 2e0a 2020 2020 2020 2020 2020  used..          
+00009460: 2020 2020 2020 2020 2020 2222 220a 0a20            """.. 
+00009470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009480: 2020 2023 2054 4f44 4f3a 2070 726f 6365     # TODO: proce
+00009490: 7373 2045 5448 2062 616c 616e 6365 2069  ss ETH balance i
+000094a0: 6e20 6c65 6467 6572 2069 6620 6e65 6564  n ledger if need
+000094b0: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
+000094c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000094d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094e0: 2020 2020 205f 756e 7772 6170 5f72 6563       _unwrap_rec
+000094f0: 6970 6965 6e74 2c20 5f75 6e77 7261 705f  ipient, _unwrap_
+00009500: 616d 6f75 6e74 5f6d 696e 203d 2065 7468  amount_min = eth
+00009510: 5f61 6269 2e61 6269 2e64 6563 6f64 6528  _abi.abi.decode(
+00009520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009530: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+00009540: 6573 3d28 2261 6464 7265 7373 222c 2022  es=("address", "
+00009550: 7569 6e74 3235 3622 292c 0a20 2020 2020  uint256"),.     
+00009560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009570: 2020 2020 2020 2064 6174 613d 696e 7075         data=inpu
+00009580: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00009590: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095b0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+000095c0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+000095d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000095e0: 6520 5661 6c75 6545 7272 6f72 2866 2243  e ValueError(f"C
+000095f0: 6f75 6c64 206e 6f74 2064 6563 6f64 6520  ould not decode 
+00009600: 696e 7075 7420 666f 7220 7b63 6f6d 6d61  input for {comma
+00009610: 6e64 7d22 290a 0a20 2020 2020 2020 2020  nd}")..         
+00009620: 2020 2020 2020 2020 2020 205f 7772 6170             _wrap
+00009630: 7065 645f 746f 6b65 6e5f 6164 6472 6573  ped_token_addres
+00009640: 7320 3d20 5752 4150 5045 445f 4e41 5449  s = WRAPPED_NATI
+00009650: 5645 5f54 4f4b 454e 535b 7365 6c66 2e63  VE_TOKENS[self.c
+00009660: 6861 696e 5f69 645d 0a20 2020 2020 2020  hain_id].       
+00009670: 2020 2020 2020 2020 2020 2020 205f 7772               _wr
+00009680: 6170 7065 645f 746f 6b65 6e5f 6261 6c61  apped_token_bala
+00009690: 6e63 6520 3d20 7365 6c66 2e6c 6564 6765  nce = self.ledge
+000096a0: 722e 746f 6b65 6e5f 6261 6c61 6e63 6528  r.token_balance(
+000096b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000096c0: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
+000096d0: 7574 6572 5f61 6464 7265 7373 2c20 5f77  uter_address, _w
+000096e0: 7261 7070 6564 5f74 6f6b 656e 5f61 6464  rapped_token_add
+000096f0: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
+00009700: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00009710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009720: 6966 205f 7772 6170 7065 645f 746f 6b65  if _wrapped_toke
+00009730: 6e5f 6261 6c61 6e63 6520 3c20 5f75 6e77  n_balance < _unw
+00009740: 7261 705f 616d 6f75 6e74 5f6d 696e 3a0a  rap_amount_min:.
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2020 2020 2020 2020 7261 6973 6520 5472          raise Tr
+00009770: 616e 7361 6374 696f 6e45 7272 6f72 280a  ansactionError(.
+00009780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009790: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
+000097a0: 7175 6573 7465 6420 756e 7772 6170 206f  quested unwrap o
+000097b0: 6620 6d69 6e2e 207b 5f75 6e77 7261 705f  f min. {_unwrap_
+000097c0: 616d 6f75 6e74 5f6d 696e 7d20 5745 5448  amount_min} WETH
+000097d0: 2c20 7265 6365 6976 6564 207b 5f77 7261  , received {_wra
+000097e0: 7070 6564 5f74 6f6b 656e 5f62 616c 616e  pped_token_balan
+000097f0: 6365 7d22 0a20 2020 2020 2020 2020 2020  ce}".           
+00009800: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00009810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009820: 2020 2020 7365 6c66 2e5f 7369 6d75 6c61      self._simula
+00009830: 7465 5f75 6e77 7261 7028 5f77 7261 7070  te_unwrap(_wrapp
+00009840: 6564 5f74 6f6b 656e 5f61 6464 7265 7373  ed_token_address
+00009850: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00009860: 2020 2063 6173 6520 2256 325f 5357 4150     case "V2_SWAP
+00009870: 5f45 5841 4354 5f49 4e22 3a0a 2020 2020  _EXACT_IN":.    
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+000098a0: 2020 2020 2020 2020 4465 636f 6465 2061          Decode a
+000098b0: 6e20 6578 6163 7420 696e 7075 7420 7377  n exact input sw
+000098c0: 6170 2074 6872 6f75 6768 2055 6e69 7377  ap through Unisw
+000098d0: 6170 2056 3220 6c69 7175 6964 6974 7920  ap V2 liquidity 
+000098e0: 706f 6f6c 732e 0a0a 2020 2020 2020 2020  pools...        
+000098f0: 2020 2020 2020 2020 2020 2020 5265 7475              Retu
+00009900: 726e 733a 2061 206c 6973 7420 6f66 2074  rns: a list of t
+00009910: 7570 6c65 7320 7265 7072 6573 656e 7469  uples representi
+00009920: 6e67 2074 6865 2070 6f6f 6c20 6f62 6a65  ng the pool obje
+00009930: 6374 2061 6e64 2074 6865 0a20 2020 2020  ct and the.     
+00009940: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009950: 696e 616c 2073 7461 7465 206f 6620 7468  inal state of th
+00009960: 6520 706f 6f6c 2061 6674 6572 2074 6865  e pool after the
+00009970: 2073 7761 7020 636f 6d70 6c65 7465 732e   swap completes.
+00009980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009990: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000099a0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+000099b0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+000099c0: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
 000099d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099e0: 2073 656c 662e 5f73 696d 756c 6174 655f   self._simulate_
-000099f0: 756e 7772 6170 285f 7772 6170 7065 645f  unwrap(_wrapped_
-00009a00: 746f 6b65 6e5f 6164 6472 6573 7329 0a0a  token_address)..
-00009a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a20: 6361 7365 2022 5632 5f53 5741 505f 4558  case "V2_SWAP_EX
-00009a30: 4143 545f 494e 223a 0a20 2020 2020 2020  ACT_IN":.       
-00009a40: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00009a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009a60: 2020 2020 2044 6563 6f64 6520 616e 2065       Decode an e
-00009a70: 7861 6374 2069 6e70 7574 2073 7761 7020  xact input swap 
-00009a80: 7468 726f 7567 6820 556e 6973 7761 7020  through Uniswap 
-00009a90: 5632 206c 6971 7569 6469 7479 2070 6f6f  V2 liquidity poo
-00009aa0: 6c73 2e0a 0a20 2020 2020 2020 2020 2020  ls...           
-00009ab0: 2020 2020 2020 2020 2052 6574 7572 6e73           Returns
-00009ac0: 3a20 6120 6c69 7374 206f 6620 7475 706c  : a list of tupl
-00009ad0: 6573 2072 6570 7265 7365 6e74 696e 6720  es representing 
-00009ae0: 7468 6520 706f 6f6c 206f 626a 6563 7420  the pool object 
-00009af0: 616e 6420 7468 650a 2020 2020 2020 2020  and the.        
-00009b00: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-00009b10: 6c20 7374 6174 6520 6f66 2074 6865 2070  l state of the p
-00009b20: 6f6f 6c20 6166 7465 7220 7468 6520 7377  ool after the sw
-00009b30: 6170 2063 6f6d 706c 6574 6573 2e0a 2020  ap completes..  
-00009b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b50: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-00009b60: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00009b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b80: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00009b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ba0: 2020 2020 2020 7478 5f72 6563 6970 6965        tx_recipie
-00009bb0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00009bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bd0: 7478 5f61 6d6f 756e 745f 696e 2c0a 2020  tx_amount_in,.  
-00009be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bf0: 2020 2020 2020 2020 2020 7478 5f61 6d6f            tx_amo
-00009c00: 756e 745f 6f75 745f 6d69 6e2c 0a20 2020  unt_out_min,.   
-00009c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c20: 2020 2020 2020 2020 2074 785f 7061 7468           tx_path
-00009c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009c40: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00009c50: 5f70 6179 6572 5f69 735f 7573 6572 2c0a  _payer_is_user,.
-00009c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c70: 2020 2020 2020 2020 2920 3d20 6574 685f          ) = eth_
-00009c80: 6162 692e 6162 692e 6465 636f 6465 280a  abi.abi.decode(.
-00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ca0: 2020 2020 2020 2020 2020 2020 7479 7065              type
-00009cb0: 733d 280a 2020 2020 2020 2020 2020 2020  s=(.            
-00009cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cd0: 2020 2020 2261 6464 7265 7373 222c 0a20      "address",. 
-00009ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00009d00: 7569 6e74 3235 3622 2c0a 2020 2020 2020  uint256",.      
-00009d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d20: 2020 2020 2020 2020 2020 2275 696e 7432            "uint2
-00009d30: 3536 222c 0a20 2020 2020 2020 2020 2020  56",.           
-00009d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d50: 2020 2020 2022 6164 6472 6573 735b 5d22       "address[]"
-00009d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d80: 2020 2262 6f6f 6c22 2c0a 2020 2020 2020    "bool",.      
-00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009da0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009dc0: 2020 2020 2064 6174 613d 696e 7075 7473       data=inputs
-00009dd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009de0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00009df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00009e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009e20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00009e30: 5661 6c75 6545 7272 6f72 2866 2243 6f75  ValueError(f"Cou
-00009e40: 6c64 206e 6f74 2064 6563 6f64 6520 696e  ld not decode in
-00009e50: 7075 7420 666f 7220 7b63 6f6d 6d61 6e64  put for {command
-00009e60: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
-00009e70: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00009e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e90: 2020 2020 2020 6966 2054 5950 455f 4348        if TYPE_CH
-00009ea0: 4543 4b49 4e47 3a0a 2020 2020 2020 2020  ECKING:.        
-00009eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ec0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-00009ed0: 7632 5f70 6f6f 6c5f 6d61 6e61 6765 7220  v2_pool_manager 
-00009ee0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00009ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f00: 2020 2020 706f 6f6c 7320 3d20 6765 745f      pools = get_
-00009f10: 7632 5f70 6f6f 6c73 5f66 726f 6d5f 746f  v2_pools_from_to
-00009f20: 6b65 6e5f 7061 7468 2874 785f 7061 7468  ken_path(tx_path
-00009f30: 2c20 7365 6c66 2e76 325f 706f 6f6c 5f6d  , self.v2_pool_m
-00009f40: 616e 6167 6572 290a 2020 2020 2020 2020  anager).        
-00009f50: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00009f60: 7074 2028 4c69 7175 6964 6974 7950 6f6f  pt (LiquidityPoo
-00009f70: 6c45 7272 6f72 2c20 4d61 6e61 6765 7245  lError, ManagerE
-00009f80: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00009f90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00009fa0: 6169 7365 2054 7261 6e73 6163 7469 6f6e  aise Transaction
-00009fb0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000099e0: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
+000099f0: 7069 656e 742c 0a20 2020 2020 2020 2020  pient,.         
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a10: 2020 2074 785f 616d 6f75 6e74 5f69 6e2c     tx_amount_in,
+00009a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a30: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
+00009a40: 616d 6f75 6e74 5f6f 7574 5f6d 696e 2c0a  amount_out_min,.
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a60: 2020 2020 2020 2020 2020 2020 7478 5f70              tx_p
+00009a70: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+00009a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a90: 2074 785f 7061 7965 725f 6973 5f75 7365   tx_payer_is_use
+00009aa0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00009ab0: 2020 2020 2020 2020 2020 2029 203d 2065             ) = e
+00009ac0: 7468 5f61 6269 2e61 6269 2e64 6563 6f64  th_abi.abi.decod
+00009ad0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00009af0: 7970 6573 3d28 0a20 2020 2020 2020 2020  ypes=(.         
+00009b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b10: 2020 2020 2020 2022 6164 6472 6573 7322         "address"
+00009b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b40: 2020 2275 696e 7432 3536 222c 0a20 2020    "uint256",.   
+00009b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b60: 2020 2020 2020 2020 2020 2020 2022 7569               "ui
+00009b70: 6e74 3235 3622 2c0a 2020 2020 2020 2020  nt256",.        
+00009b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b90: 2020 2020 2020 2020 2261 6464 7265 7373          "address
+00009ba0: 5b5d 222c 0a20 2020 2020 2020 2020 2020  []",.           
+00009bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bc0: 2020 2020 2022 626f 6f6c 222c 0a20 2020       "bool",.   
+00009bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009be0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00009bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c00: 2020 2020 2020 2020 6461 7461 3d69 6e70          data=inp
+00009c10: 7574 732c 0a20 2020 2020 2020 2020 2020  uts,.           
+00009c20: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00009c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c40: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00009c50: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00009c60: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00009c70: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+00009c80: 436f 756c 6420 6e6f 7420 6465 636f 6465  Could not decode
+00009c90: 2069 6e70 7574 2066 6f72 207b 636f 6d6d   input for {comm
+00009ca0: 616e 647d 2229 0a0a 2020 2020 2020 2020  and}")..        
+00009cb0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00009cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009cd0: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
+00009ce0: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
+00009cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d00: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+00009d10: 6c66 2e76 325f 706f 6f6c 5f6d 616e 6167  lf.v2_pool_manag
+00009d20: 6572 2069 7320 6e6f 7420 4e6f 6e65 0a20  er is not None. 
+00009d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d40: 2020 2020 2020 2070 6f6f 6c73 203d 2067         pools = g
+00009d50: 6574 5f76 325f 706f 6f6c 735f 6672 6f6d  et_v2_pools_from
+00009d60: 5f74 6f6b 656e 5f70 6174 6828 7478 5f70  _token_path(tx_p
+00009d70: 6174 682c 2073 656c 662e 7632 5f70 6f6f  ath, self.v2_poo
+00009d80: 6c5f 6d61 6e61 6765 7229 0a20 2020 2020  l_manager).     
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009da0: 7863 6570 7420 284c 6971 7569 6469 7479  xcept (Liquidity
+00009db0: 506f 6f6c 4572 726f 722c 204d 616e 6167  PoolError, Manag
+00009dc0: 6572 4572 726f 7229 3a0a 2020 2020 2020  erError):.      
+00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009de0: 2020 7261 6973 6520 5472 616e 7361 6374    raise Transact
+00009df0: 696f 6e45 7272 6f72 280a 2020 2020 2020  ionError(.      
+00009e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e10: 2020 2020 2020 6622 4c69 7175 6964 6974        f"Liquidit
+00009e20: 7950 6f6f 6c20 636f 756c 6420 6e6f 7420  yPool could not 
+00009e30: 6265 2062 7569 6c74 2066 6f72 2061 6c6c  be built for all
+00009e40: 2073 7465 7073 2069 6e20 7061 7468 207b   steps in path {
+00009e50: 7478 5f70 6174 687d 220a 2020 2020 2020  tx_path}".      
+00009e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e70: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00009e80: 2020 2020 2020 2020 206c 6173 745f 706f           last_po
+00009e90: 6f6c 5f70 6f73 203d 206c 656e 2874 785f  ol_pos = len(tx_
+00009ea0: 7061 7468 2920 2d20 320a 0a20 2020 2020  path) - 2..     
+00009eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009ec0: 6f72 2070 6f6f 6c5f 706f 732c 2070 6f6f  or pool_pos, poo
+00009ed0: 6c20 696e 2065 6e75 6d65 7261 7465 2870  l in enumerate(p
+00009ee0: 6f6f 6c73 293a 0a20 2020 2020 2020 2020  ools):.         
+00009ef0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009f00: 6972 7374 5f73 7761 7020 3d20 706f 6f6c  irst_swap = pool
+00009f10: 5f70 6f73 203d 3d20 300a 2020 2020 2020  _pos == 0.      
+00009f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f30: 2020 6c61 7374 5f73 7761 7020 3d20 706f    last_swap = po
+00009f40: 6f6c 5f70 6f73 203d 3d20 6c61 7374 5f70  ol_pos == last_p
+00009f50: 6f6f 6c5f 706f 730a 0a20 2020 2020 2020  ool_pos..       
+00009f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f70: 2074 6f6b 656e 5f69 6e20 3d20 706f 6f6c   token_in = pool
+00009f80: 2e74 6f6b 656e 3020 6966 2074 785f 7061  .token0 if tx_pa
+00009f90: 7468 5b70 6f6f 6c5f 706f 735d 203d 3d20  th[pool_pos] == 
+00009fa0: 706f 6f6c 2e74 6f6b 656e 3020 656c 7365  pool.token0 else
+00009fb0: 2070 6f6f 6c2e 746f 6b65 6e31 0a0a 2020   pool.token1..  
 00009fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fd0: 2020 2066 224c 6971 7569 6469 7479 506f     f"LiquidityPo
-00009fe0: 6f6c 2063 6f75 6c64 206e 6f74 2062 6520  ol could not be 
-00009ff0: 6275 696c 7420 666f 7220 616c 6c20 7374  built for all st
-0000a000: 6570 7320 696e 2070 6174 6820 7b74 785f  eps in path {tx_
-0000a010: 7061 7468 7d22 0a20 2020 2020 2020 2020  path}".         
-0000a020: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000a030: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000a040: 2020 2020 2020 6c61 7374 5f70 6f6f 6c5f        last_pool_
-0000a050: 706f 7320 3d20 6c65 6e28 7478 5f70 6174  pos = len(tx_pat
-0000a060: 6829 202d 2032 0a0a 2020 2020 2020 2020  h) - 2..        
-0000a070: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000a080: 706f 6f6c 5f70 6f73 2c20 706f 6f6c 2069  pool_pos, pool i
-0000a090: 6e20 656e 756d 6572 6174 6528 706f 6f6c  n enumerate(pool
-0000a0a0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000a0b0: 2020 2020 2020 2020 2020 2020 6669 7273              firs
-0000a0c0: 745f 7377 6170 203d 2070 6f6f 6c5f 706f  t_swap = pool_po
-0000a0d0: 7320 3d3d 2030 0a20 2020 2020 2020 2020  s == 0.         
-0000a0e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000a0f0: 6173 745f 7377 6170 203d 2070 6f6f 6c5f  ast_swap = pool_
-0000a100: 706f 7320 3d3d 206c 6173 745f 706f 6f6c  pos == last_pool
-0000a110: 5f70 6f73 0a0a 2020 2020 2020 2020 2020  _pos..          
-0000a120: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0000a130: 6b65 6e5f 696e 203d 2070 6f6f 6c2e 746f  ken_in = pool.to
-0000a140: 6b65 6e30 2069 6620 7478 5f70 6174 685b  ken0 if tx_path[
-0000a150: 706f 6f6c 5f70 6f73 5d20 3d3d 2070 6f6f  pool_pos] == poo
-0000a160: 6c2e 746f 6b65 6e30 2065 6c73 6520 706f  l.token0 else po
-0000a170: 6f6c 2e74 6f6b 656e 310a 0a20 2020 2020  ol.token1..     
-0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a190: 2020 205f 616d 6f75 6e74 5f69 6e20 3d20     _amount_in = 
-0000a1a0: 7478 5f61 6d6f 756e 745f 696e 2069 6620  tx_amount_in if 
-0000a1b0: 6669 7273 745f 7377 6170 2065 6c73 6520  first_swap else 
-0000a1c0: 5f61 6d6f 756e 745f 6f75 740a 0a20 2020  _amount_out..   
+00009fd0: 2020 2020 2020 5f61 6d6f 756e 745f 696e        _amount_in
+00009fe0: 203d 2074 785f 616d 6f75 6e74 5f69 6e20   = tx_amount_in 
+00009ff0: 6966 2066 6972 7374 5f73 7761 7020 656c  if first_swap el
+0000a000: 7365 205f 616d 6f75 6e74 5f6f 7574 0a0a  se _amount_out..
+0000a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a020: 2020 2020 2020 2020 5f72 6563 6970 6965          _recipie
+0000a030: 6e74 203d 2074 785f 7265 6369 7069 656e  nt = tx_recipien
+0000a040: 7420 6966 206c 6173 745f 7377 6170 2065  t if last_swap e
+0000a050: 6c73 6520 706f 6f6c 735b 706f 6f6c 5f70  lse pools[pool_p
+0000a060: 6f73 202b 2031 5d2e 6164 6472 6573 730a  os + 1].address.
+0000a070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a080: 2020 2020 2020 2020 206d 6174 6368 205f           match _
+0000a090: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
+0000a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0b0: 2020 2020 2020 2063 6173 6520 556e 6976         case Univ
+0000a0c0: 6572 7361 6c52 6f75 7465 7253 7065 6369  ersalRouterSpeci
+0000a0d0: 616c 4164 6472 6573 732e 4d53 475f 5345  alAddress.MSG_SE
+0000a0e0: 4e44 4552 3a0a 2020 2020 2020 2020 2020  NDER:.          
+0000a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a100: 2020 2020 2020 5f72 6563 6970 6965 6e74        _recipient
+0000a110: 203d 2073 656c 662e 7365 6e64 6572 0a20   = self.sender. 
+0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a130: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+0000a140: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a160: 2020 556e 6976 6572 7361 6c52 6f75 7465    UniversalRoute
+0000a170: 7253 7065 6369 616c 4164 6472 6573 732e  rSpecialAddress.
+0000a180: 524f 5554 4552 0a20 2020 2020 2020 2020  ROUTER.         
+0000a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1a0: 2020 2020 2020 207c 2056 3352 6f75 7465         | V3Route
+0000a1b0: 7253 7065 6369 616c 4164 6472 6573 732e  rSpecialAddress.
+0000a1c0: 524f 5554 4552 5f31 0a20 2020 2020 2020  ROUTER_1.       
 0000a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1e0: 2020 2020 205f 7265 6369 7069 656e 7420       _recipient 
-0000a1f0: 3d20 7478 5f72 6563 6970 6965 6e74 2069  = tx_recipient i
-0000a200: 6620 6c61 7374 5f73 7761 7020 656c 7365  f last_swap else
-0000a210: 2070 6f6f 6c73 5b70 6f6f 6c5f 706f 7320   pools[pool_pos 
-0000a220: 2b20 315d 2e61 6464 7265 7373 0a0a 2020  + 1].address..  
+0000a1e0: 2020 2020 2020 2020 207c 2056 3352 6f75           | V3Rou
+0000a1f0: 7465 7253 7065 6369 616c 4164 6472 6573  terSpecialAddres
+0000a200: 732e 524f 5554 4552 5f32 0a20 2020 2020  s.ROUTER_2.     
+0000a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a220: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
 0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a240: 2020 2020 2020 6d61 7463 6820 5f72 6563        match _rec
-0000a250: 6970 6965 6e74 3a0a 2020 2020 2020 2020  ipient:.        
-0000a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a270: 2020 2020 6361 7365 2055 6e69 7665 7273      case Univers
-0000a280: 616c 526f 7574 6572 5370 6563 6961 6c41  alRouterSpecialA
-0000a290: 6464 7265 7373 2e4d 5347 5f53 454e 4445  ddress.MSG_SENDE
-0000a2a0: 523a 0a20 2020 2020 2020 2020 2020 2020  R:.             
-0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2c0: 2020 205f 7265 6369 7069 656e 7420 3d20     _recipient = 
-0000a2d0: 7365 6c66 2e73 656e 6465 720a 2020 2020  self.sender.    
+0000a240: 2020 2020 2020 2020 2020 5f72 6563 6970            _recip
+0000a250: 6965 6e74 203d 2073 656c 662e 726f 7574  ient = self.rout
+0000a260: 6572 5f61 6464 7265 7373 0a0a 2020 2020  er_address..    
+0000a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a280: 2020 2020 5f2c 205f 7369 6d5f 7265 7375      _, _sim_resu
+0000a290: 6c74 203d 2073 656c 662e 5f73 696d 756c  lt = self._simul
+0000a2a0: 6174 655f 7632 5f73 7761 705f 6578 6163  ate_v2_swap_exac
+0000a2b0: 745f 696e 280a 2020 2020 2020 2020 2020  t_in(.          
+0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2d0: 2020 706f 6f6c 3d70 6f6f 6c2c 0a20 2020    pool=pool,.   
 0000a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2f0: 2020 2020 2020 2020 6361 7365 2028 0a20          case (. 
-0000a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a310: 2020 2020 2020 2020 2020 2020 2020 2055                 U
-0000a320: 6e69 7665 7273 616c 526f 7574 6572 5370  niversalRouterSp
-0000a330: 6563 6961 6c41 6464 7265 7373 2e52 4f55  ecialAddress.ROU
-0000a340: 5445 520a 2020 2020 2020 2020 2020 2020  TER.            
-0000a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a360: 2020 2020 7c20 5633 526f 7574 6572 5370      | V3RouterSp
-0000a370: 6563 6961 6c41 6464 7265 7373 2e52 4f55  ecialAddress.ROU
-0000a380: 5445 525f 310a 2020 2020 2020 2020 2020  TER_1.          
-0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3a0: 2020 2020 2020 7c20 5633 526f 7574 6572        | V3Router
-0000a3b0: 5370 6563 6961 6c41 6464 7265 7373 2e52  SpecialAddress.R
-0000a3c0: 4f55 5445 525f 320a 2020 2020 2020 2020  OUTER_2.        
+0000a2f0: 2020 2020 2020 2020 2072 6563 6970 6965           recipie
+0000a300: 6e74 3d5f 7265 6369 7069 656e 742c 0a20  nt=_recipient,. 
+0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a320: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0000a330: 5f69 6e3d 746f 6b65 6e5f 696e 2c0a 2020  _in=token_in,.  
+0000a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a350: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+0000a360: 5f69 6e3d 5f61 6d6f 756e 745f 696e 2c0a  _in=_amount_in,.
+0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a380: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
+0000a390: 6e74 5f6f 7574 5f6d 696e 3d74 785f 616d  nt_out_min=tx_am
+0000a3a0: 6f75 6e74 5f6f 7574 5f6d 696e 2069 6620  ount_out_min if 
+0000a3b0: 6c61 7374 5f73 7761 7020 656c 7365 204e  last_swap else N
+0000a3c0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
 0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3e0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a400: 2020 2020 2020 205f 7265 6369 7069 656e         _recipien
-0000a410: 7420 3d20 7365 6c66 2e72 6f75 7465 725f  t = self.router_
-0000a420: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
+0000a3e0: 2066 6972 7374 5f73 7761 703d 6669 7273   first_swap=firs
+0000a3f0: 745f 7377 6170 2c0a 2020 2020 2020 2020  t_swap,.        
+0000a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a410: 2020 2020 6c61 7374 5f73 7761 703d 6c61      last_swap=la
+0000a420: 7374 5f73 7761 702c 0a20 2020 2020 2020  st_swap,.       
 0000a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a440: 205f 2c20 5f73 696d 5f72 6573 756c 7420   _, _sim_result 
-0000a450: 3d20 7365 6c66 2e5f 7369 6d75 6c61 7465  = self._simulate
-0000a460: 5f76 325f 7377 6170 5f65 7861 6374 5f69  _v2_swap_exact_i
-0000a470: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0000a480: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000a490: 6f6f 6c3d 706f 6f6c 2c0a 2020 2020 2020  ool=pool,.      
-0000a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4b0: 2020 2020 2020 7265 6369 7069 656e 743d        recipient=
-0000a4c0: 5f72 6563 6970 6965 6e74 2c0a 2020 2020  _recipient,.    
-0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4e0: 2020 2020 2020 2020 746f 6b65 6e5f 696e          token_in
-0000a4f0: 3d74 6f6b 656e 5f69 6e2c 0a20 2020 2020  =token_in,.     
-0000a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a510: 2020 2020 2020 2061 6d6f 756e 745f 696e         amount_in
-0000a520: 3d5f 616d 6f75 6e74 5f69 6e2c 0a20 2020  =_amount_in,.   
-0000a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a540: 2020 2020 2020 2020 2061 6d6f 756e 745f           amount_
-0000a550: 6f75 745f 6d69 6e3d 7478 5f61 6d6f 756e  out_min=tx_amoun
-0000a560: 745f 6f75 745f 6d69 6e20 6966 206c 6173  t_out_min if las
-0000a570: 745f 7377 6170 2065 6c73 6520 4e6f 6e65  t_swap else None
-0000a580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a590: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000a5a0: 7273 745f 7377 6170 3d66 6972 7374 5f73  rst_swap=first_s
-0000a5b0: 7761 702c 0a20 2020 2020 2020 2020 2020  wap,.           
-0000a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a5d0: 206c 6173 745f 7377 6170 3d6c 6173 745f   last_swap=last_
-0000a5e0: 7377 6170 2c0a 2020 2020 2020 2020 2020  swap,.          
-0000a5f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000a600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a610: 2020 2020 2020 2020 205f 616d 6f75 6e74           _amount
-0000a620: 5f6f 7574 203d 202d 6d69 6e28 5f73 696d  _out = -min(_sim
-0000a630: 5f72 6573 756c 742e 616d 6f75 6e74 305f  _result.amount0_
-0000a640: 6465 6c74 612c 205f 7369 6d5f 7265 7375  delta, _sim_resu
-0000a650: 6c74 2e61 6d6f 756e 7431 5f64 656c 7461  lt.amount1_delta
-0000a660: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000a670: 2020 2020 2020 2020 2020 205f 756e 6976             _univ
-0000a680: 6572 7361 6c5f 726f 7574 6572 5f63 6f6d  ersal_router_com
-0000a690: 6d61 6e64 5f66 7574 7572 655f 706f 6f6c  mand_future_pool
-0000a6a0: 5f73 7461 7465 732e 6170 7065 6e64 2828  _states.append((
-0000a6b0: 706f 6f6c 2c20 5f73 696d 5f72 6573 756c  pool, _sim_resul
-0000a6c0: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
-0000a6d0: 2020 2020 2063 6173 6520 2256 325f 5357       case "V2_SW
-0000a6e0: 4150 5f45 5841 4354 5f4f 5554 223a 0a20  AP_EXACT_OUT":. 
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a700: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
-0000a710: 2020 2020 2020 2020 2020 2044 6563 6f64             Decod
-0000a720: 6520 616e 2065 7861 6374 206f 7574 7075  e an exact outpu
-0000a730: 7420 7377 6170 2074 6872 6f75 6768 2055  t swap through U
-0000a740: 6e69 7377 6170 2056 3220 6c69 7175 6964  niswap V2 liquid
-0000a750: 6974 7920 706f 6f6c 732e 0a0a 2020 2020  ity pools...    
-0000a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a770: 5265 7475 726e 733a 2061 206c 6973 7420  Returns: a list 
-0000a780: 6f66 2074 7570 6c65 7320 7265 7072 6573  of tuples repres
-0000a790: 656e 7469 6e67 2074 6865 2070 6f6f 6c20  enting the pool 
-0000a7a0: 6f62 6a65 6374 2061 6e64 2074 6865 0a20  object and the. 
-0000a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a7c0: 2020 2066 696e 616c 2073 7461 7465 206f     final state o
-0000a7d0: 6620 7468 6520 706f 6f6c 2061 6674 6572  f the pool after
-0000a7e0: 2074 6865 2073 7761 7020 636f 6d70 6c65   the swap comple
-0000a7f0: 7465 732e 0a20 2020 2020 2020 2020 2020  tes..           
-0000a800: 2020 2020 2020 2020 2022 2222 0a0a 2020           """..  
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a820: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000a830: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0000a840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a850: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-0000a860: 7265 6369 7069 656e 742c 0a20 2020 2020  recipient,.     
-0000a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a880: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
-0000a890: 5f6f 7574 2c0a 2020 2020 2020 2020 2020  _out,.          
-0000a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a8b0: 2020 7478 5f61 6d6f 756e 745f 696e 5f6d    tx_amount_in_m
-0000a8c0: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
-0000a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a8e0: 7478 5f70 6174 682c 0a20 2020 2020 2020  tx_path,.       
-0000a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a900: 2020 2020 2074 785f 7061 7965 725f 6973       tx_payer_is
-0000a910: 5f75 7365 722c 0a20 2020 2020 2020 2020  _user,.         
-0000a920: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000a930: 203d 2065 7468 5f61 6269 2e61 6269 2e64   = eth_abi.abi.d
-0000a940: 6563 6f64 6528 0a20 2020 2020 2020 2020  ecode(.         
+0000a440: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000a450: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
+0000a460: 756e 745f 6f75 7420 3d20 2d6d 696e 285f  unt_out = -min(_
+0000a470: 7369 6d5f 7265 7375 6c74 2e61 6d6f 756e  sim_result.amoun
+0000a480: 7430 5f64 656c 7461 2c20 5f73 696d 5f72  t0_delta, _sim_r
+0000a490: 6573 756c 742e 616d 6f75 6e74 315f 6465  esult.amount1_de
+0000a4a0: 6c74 6129 0a0a 2020 2020 2020 2020 2020  lta)..          
+0000a4b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a4c0: 6c66 2e73 696d 756c 6174 6564 5f70 6f6f  lf.simulated_poo
+0000a4d0: 6c5f 7374 6174 6573 2e61 7070 656e 6428  l_states.append(
+0000a4e0: 2870 6f6f 6c2c 205f 7369 6d5f 7265 7375  (pool, _sim_resu
+0000a4f0: 6c74 2929 0a0a 2020 2020 2020 2020 2020  lt))..          
+0000a500: 2020 2020 2020 6361 7365 2022 5632 5f53        case "V2_S
+0000a510: 5741 505f 4558 4143 545f 4f55 5422 3a0a  WAP_EXACT_OUT":.
+0000a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a530: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000a540: 2020 2020 2020 2020 2020 2020 4465 636f              Deco
+0000a550: 6465 2061 6e20 6578 6163 7420 6f75 7470  de an exact outp
+0000a560: 7574 2073 7761 7020 7468 726f 7567 6820  ut swap through 
+0000a570: 556e 6973 7761 7020 5632 206c 6971 7569  Uniswap V2 liqui
+0000a580: 6469 7479 2070 6f6f 6c73 2e0a 0a20 2020  dity pools...   
+0000a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5a0: 2052 6574 7572 6e73 3a20 6120 6c69 7374   Returns: a list
+0000a5b0: 206f 6620 7475 706c 6573 2072 6570 7265   of tuples repre
+0000a5c0: 7365 6e74 696e 6720 7468 6520 706f 6f6c  senting the pool
+0000a5d0: 206f 626a 6563 7420 616e 6420 7468 650a   object and the.
+0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5f0: 2020 2020 6669 6e61 6c20 7374 6174 6520      final state 
+0000a600: 6f66 2074 6865 2070 6f6f 6c20 6166 7465  of the pool afte
+0000a610: 7220 7468 6520 7377 6170 2063 6f6d 706c  r the swap compl
+0000a620: 6574 6573 2e0a 2020 2020 2020 2020 2020  etes..          
+0000a630: 2020 2020 2020 2020 2020 2222 220a 0a20            """.. 
+0000a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a650: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a670: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a680: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0000a690: 5f72 6563 6970 6965 6e74 2c0a 2020 2020  _recipient,.    
+0000a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6b0: 2020 2020 2020 2020 7478 5f61 6d6f 756e          tx_amoun
+0000a6c0: 745f 6f75 742c 0a20 2020 2020 2020 2020  t_out,.         
+0000a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6e0: 2020 2074 785f 616d 6f75 6e74 5f69 6e5f     tx_amount_in_
+0000a6f0: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
+0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a710: 2074 785f 7061 7468 2c0a 2020 2020 2020   tx_path,.      
+0000a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a730: 2020 2020 2020 7478 5f70 6179 6572 5f69        tx_payer_i
+0000a740: 735f 7573 6572 2c0a 2020 2020 2020 2020  s_user,.        
+0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a760: 2920 3d20 6574 685f 6162 692e 6162 692e  ) = eth_abi.abi.
+0000a770: 6465 636f 6465 280a 2020 2020 2020 2020  decode(.        
+0000a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a790: 2020 2020 7479 7065 733d 280a 2020 2020      types=(.    
+0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7b0: 2020 2020 2020 2020 2020 2020 2261 6464              "add
+0000a7c0: 7265 7373 222c 0a20 2020 2020 2020 2020  ress",.         
+0000a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7e0: 2020 2020 2020 2022 7569 6e74 3235 3622         "uint256"
+0000a7f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a810: 2020 2275 696e 7432 3536 222c 0a20 2020    "uint256",.   
+0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a830: 2020 2020 2020 2020 2020 2020 2022 6164               "ad
+0000a840: 6472 6573 735b 5d22 2c0a 2020 2020 2020  dress[]",.      
+0000a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a860: 2020 2020 2020 2020 2020 2262 6f6f 6c22            "bool"
+0000a870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a880: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+0000a890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a8a0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0000a8b0: 613d 696e 7075 7473 2c0a 2020 2020 2020  a=inputs,.      
+0000a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a8d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000a8e0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000a8f0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0000a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a910: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000a920: 6f72 2866 2243 6f75 6c64 206e 6f74 2064  or(f"Could not d
+0000a930: 6563 6f64 6520 696e 7075 7420 666f 7220  ecode input for 
+0000a940: 7b63 6f6d 6d61 6e64 7d22 290a 0a20 2020  {command}")..   
 0000a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a960: 2020 2074 7970 6573 3d28 0a20 2020 2020     types=(.     
-0000a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a980: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
-0000a990: 6573 7322 2c0a 2020 2020 2020 2020 2020  ess",.          
-0000a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9b0: 2020 2020 2020 2275 696e 7432 3536 222c        "uint256",
-0000a9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9e0: 2022 7569 6e74 3235 3622 2c0a 2020 2020   "uint256",.    
-0000a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa00: 2020 2020 2020 2020 2020 2020 2261 6464              "add
-0000aa10: 7265 7373 5b5d 222c 0a20 2020 2020 2020  ress[]",.       
-0000aa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa30: 2020 2020 2020 2020 2022 626f 6f6c 222c           "bool",
-0000aa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aa50: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0000aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa70: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0000aa80: 3d69 6e70 7574 732c 0a20 2020 2020 2020  =inputs,.       
-0000aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aaa0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000aab0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000aac0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+0000a960: 206d 6174 6368 2074 785f 7265 6369 7069   match tx_recipi
+0000a970: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+0000a980: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0000a990: 6520 556e 6976 6572 7361 6c52 6f75 7465  e UniversalRoute
+0000a9a0: 7253 7065 6369 616c 4164 6472 6573 732e  rSpecialAddress.
+0000a9b0: 524f 5554 4552 3a0a 2020 2020 2020 2020  ROUTER:.        
+0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9d0: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
+0000a9e0: 203d 2073 656c 662e 726f 7574 6572 5f61   = self.router_a
+0000a9f0: 6464 7265 7373 0a20 2020 2020 2020 2020  ddress.         
+0000aa00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000aa10: 6173 6520 556e 6976 6572 7361 6c52 6f75  ase UniversalRou
+0000aa20: 7465 7253 7065 6369 616c 4164 6472 6573  terSpecialAddres
+0000aa30: 732e 4d53 475f 5345 4e44 4552 3a0a 2020  s.MSG_SENDER:.  
+0000aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aa50: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
+0000aa60: 6970 6965 6e74 203d 2073 656c 662e 7365  ipient = self.se
+0000aa70: 6e64 6572 0a20 2020 2020 2020 2020 2020  nder.           
+0000aa80: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0000aa90: 6520 5f3a 0a20 2020 2020 2020 2020 2020  e _:.           
+0000aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aab0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
+0000aac0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
 0000aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aae0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0000aaf0: 7228 6622 436f 756c 6420 6e6f 7420 6465  r(f"Could not de
-0000ab00: 636f 6465 2069 6e70 7574 2066 6f72 207b  code input for {
-0000ab10: 636f 6d6d 616e 647d 2229 0a0a 2020 2020  command}")..    
-0000ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab30: 6d61 7463 6820 7478 5f72 6563 6970 6965  match tx_recipie
-0000ab40: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-0000ab50: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0000ab60: 2055 6e69 7665 7273 616c 526f 7574 6572   UniversalRouter
-0000ab70: 5370 6563 6961 6c41 6464 7265 7373 2e52  SpecialAddress.R
-0000ab80: 4f55 5445 523a 0a20 2020 2020 2020 2020  OUTER:.         
-0000ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aba0: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
-0000abb0: 3d20 7365 6c66 2e72 6f75 7465 725f 6164  = self.router_ad
-0000abc0: 6472 6573 730a 2020 2020 2020 2020 2020  dress.          
-0000abd0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-0000abe0: 7365 2055 6e69 7665 7273 616c 526f 7574  se UniversalRout
-0000abf0: 6572 5370 6563 6961 6c41 6464 7265 7373  erSpecialAddress
-0000ac00: 2e4d 5347 5f53 454e 4445 523a 0a20 2020  .MSG_SENDER:.   
+0000aae0: 2020 2020 2020 2020 6966 2054 5950 455f          if TYPE_
+0000aaf0: 4348 4543 4b49 4e47 3a0a 2020 2020 2020  CHECKING:.      
+0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab10: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0000ab20: 662e 7632 5f70 6f6f 6c5f 6d61 6e61 6765  f.v2_pool_manage
+0000ab30: 7220 6973 206e 6f74 204e 6f6e 650a 2020  r is not None.  
+0000ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab50: 2020 2020 2020 706f 6f6c 7320 3d20 6765        pools = ge
+0000ab60: 745f 7632 5f70 6f6f 6c73 5f66 726f 6d5f  t_v2_pools_from_
+0000ab70: 746f 6b65 6e5f 7061 7468 2874 785f 7061  token_path(tx_pa
+0000ab80: 7468 2c20 7365 6c66 2e76 325f 706f 6f6c  th, self.v2_pool
+0000ab90: 5f6d 616e 6167 6572 290a 2020 2020 2020  _manager).      
+0000aba0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000abb0: 6365 7074 2028 4c69 7175 6964 6974 7950  cept (LiquidityP
+0000abc0: 6f6f 6c45 7272 6f72 2c20 4d61 6e61 6765  oolError, Manage
+0000abd0: 7245 7272 6f72 293a 0a20 2020 2020 2020  rError):.       
+0000abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abf0: 2072 6169 7365 2054 7261 6e73 6163 7469   raise Transacti
+0000ac00: 6f6e 4572 726f 7228 0a20 2020 2020 2020  onError(.       
 0000ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac20: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
-0000ac30: 7069 656e 7420 3d20 7365 6c66 2e73 656e  pient = self.sen
-0000ac40: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
-0000ac50: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0000ac60: 205f 3a0a 2020 2020 2020 2020 2020 2020   _:.            
+0000ac20: 2020 2020 2066 224c 6971 7569 6469 7479       f"Liquidity
+0000ac30: 506f 6f6c 2063 6f75 6c64 206e 6f74 2062  Pool could not b
+0000ac40: 6520 6275 696c 7420 666f 7220 616c 6c20  e built for all 
+0000ac50: 7374 6570 7320 696e 2070 6174 6820 7b74  steps in path {t
+0000ac60: 785f 7061 7468 7d22 0a20 2020 2020 2020  x_path}".       
 0000ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac80: 7061 7373 0a0a 2020 2020 2020 2020 2020  pass..          
-0000ac90: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0000aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000acb0: 2020 2020 2020 2069 6620 5459 5045 5f43         if TYPE_C
-0000acc0: 4845 434b 494e 473a 0a20 2020 2020 2020  HECKING:.       
-0000acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ace0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-0000acf0: 2e76 325f 706f 6f6c 5f6d 616e 6167 6572  .v2_pool_manager
-0000ad00: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0000ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad20: 2020 2020 2070 6f6f 6c73 203d 2067 6574       pools = get
-0000ad30: 5f76 325f 706f 6f6c 735f 6672 6f6d 5f74  _v2_pools_from_t
-0000ad40: 6f6b 656e 5f70 6174 6828 7478 5f70 6174  oken_path(tx_pat
-0000ad50: 682c 2073 656c 662e 7632 5f70 6f6f 6c5f  h, self.v2_pool_
-0000ad60: 6d61 6e61 6765 7229 0a20 2020 2020 2020  manager).       
-0000ad70: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000ad80: 6570 7420 284c 6971 7569 6469 7479 506f  ept (LiquidityPo
-0000ad90: 6f6c 4572 726f 722c 204d 616e 6167 6572  olError, Manager
-0000ada0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0000adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adc0: 7261 6973 6520 5472 616e 7361 6374 696f  raise Transactio
-0000add0: 6e45 7272 6f72 280a 2020 2020 2020 2020  nError(.        
-0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adf0: 2020 2020 6622 4c69 7175 6964 6974 7950      f"LiquidityP
-0000ae00: 6f6f 6c20 636f 756c 6420 6e6f 7420 6265  ool could not be
-0000ae10: 2062 7569 6c74 2066 6f72 2061 6c6c 2073   built for all s
-0000ae20: 7465 7073 2069 6e20 7061 7468 207b 7478  teps in path {tx
-0000ae30: 5f70 6174 687d 220a 2020 2020 2020 2020  _path}".        
+0000ac80: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000ac90: 2020 2020 2020 2020 6c61 7374 5f70 6f6f          last_poo
+0000aca0: 6c5f 706f 7320 3d20 6c65 6e28 706f 6f6c  l_pos = len(pool
+0000acb0: 7329 202d 2031 0a0a 2020 2020 2020 2020  s) - 1..        
+0000acc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000acd0: 706f 6f6c 5f70 6f73 2c20 706f 6f6c 2069  pool_pos, pool i
+0000ace0: 6e20 656e 756d 6572 6174 6528 706f 6f6c  n enumerate(pool
+0000acf0: 735b 3a3a 2d31 5d29 3a0a 2020 2020 2020  s[::-1]):.      
+0000ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad10: 2020 6669 7273 745f 7377 6170 203d 2070    first_swap = p
+0000ad20: 6f6f 6c5f 706f 7320 3d3d 206c 6173 745f  ool_pos == last_
+0000ad30: 706f 6f6c 5f70 6f73 0a20 2020 2020 2020  pool_pos.       
+0000ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad50: 206c 6173 745f 7377 6170 203d 2070 6f6f   last_swap = poo
+0000ad60: 6c5f 706f 7320 3d3d 2030 0a0a 2020 2020  l_pos == 0..    
+0000ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad80: 2020 2020 5f61 6d6f 756e 745f 6f75 7420      _amount_out 
+0000ad90: 3d20 7478 5f61 6d6f 756e 745f 6f75 7420  = tx_amount_out 
+0000ada0: 6966 206c 6173 745f 7377 6170 2065 6c73  if last_swap els
+0000adb0: 6520 5f61 6d6f 756e 745f 696e 0a20 2020  e _amount_in.   
+0000adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000add0: 2020 2020 205f 616d 6f75 6e74 5f69 6e5f       _amount_in_
+0000ade0: 6d61 7820 3d20 7478 5f61 6d6f 756e 745f  max = tx_amount_
+0000adf0: 696e 5f6d 6178 2069 6620 6669 7273 745f  in_max if first_
+0000ae00: 7377 6170 2065 6c73 6520 4e6f 6e65 0a0a  swap else None..
+0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae20: 2020 2020 2020 2020 5f72 6563 6970 6965          _recipie
+0000ae30: 6e74 203d 2028 0a20 2020 2020 2020 2020  nt = (.         
 0000ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae50: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000ae60: 2020 2020 2020 206c 6173 745f 706f 6f6c         last_pool
-0000ae70: 5f70 6f73 203d 206c 656e 2870 6f6f 6c73  _pos = len(pools
-0000ae80: 2920 2d20 310a 0a20 2020 2020 2020 2020  ) - 1..         
-0000ae90: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-0000aea0: 6f6f 6c5f 706f 732c 2070 6f6f 6c20 696e  ool_pos, pool in
-0000aeb0: 2065 6e75 6d65 7261 7465 2870 6f6f 6c73   enumerate(pools
-0000aec0: 5b3a 3a2d 315d 293a 0a20 2020 2020 2020  [::-1]):.       
-0000aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aee0: 2066 6972 7374 5f73 7761 7020 3d20 706f   first_swap = po
-0000aef0: 6f6c 5f70 6f73 203d 3d20 6c61 7374 5f70  ol_pos == last_p
-0000af00: 6f6f 6c5f 706f 730a 2020 2020 2020 2020  ool_pos.        
-0000af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af20: 6c61 7374 5f73 7761 7020 3d20 706f 6f6c  last_swap = pool
-0000af30: 5f70 6f73 203d 3d20 300a 0a20 2020 2020  _pos == 0..     
-0000af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af50: 2020 205f 616d 6f75 6e74 5f6f 7574 203d     _amount_out =
-0000af60: 2074 785f 616d 6f75 6e74 5f6f 7574 2069   tx_amount_out i
-0000af70: 6620 6c61 7374 5f73 7761 7020 656c 7365  f last_swap else
-0000af80: 205f 616d 6f75 6e74 5f69 6e0a 2020 2020   _amount_in.    
-0000af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afa0: 2020 2020 5f61 6d6f 756e 745f 696e 5f6d      _amount_in_m
-0000afb0: 6178 203d 2074 785f 616d 6f75 6e74 5f69  ax = tx_amount_i
-0000afc0: 6e5f 6d61 7820 6966 2066 6972 7374 5f73  n_max if first_s
-0000afd0: 7761 7020 656c 7365 204e 6f6e 650a 0a20  wap else None.. 
-0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aff0: 2020 2020 2020 205f 7265 6369 7069 656e         _recipien
-0000b000: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
-0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b020: 2020 7478 5f72 6563 6970 6965 6e74 2069    tx_recipient i
-0000b030: 6620 6c61 7374 5f73 7761 7020 656c 7365  f last_swap else
-0000b040: 2070 6f6f 6c73 5b3a 3a2d 315d 5b70 6f6f   pools[::-1][poo
-0000b050: 6c5f 706f 7320 2d20 315d 2e61 6464 7265  l_pos - 1].addre
-0000b060: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-0000b070: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b090: 2020 2020 2020 2320 6765 7420 7468 6520        # get the 
-0000b0a0: 696e 7075 7420 746f 6b65 6e20 6279 2070  input token by p
-0000b0b0: 726f 6365 6564 696e 6720 6261 636b 7761  roceeding backwa
-0000b0c0: 7264 7320 6672 6f6d 0a20 2020 2020 2020  rds from.       
-0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0e0: 2023 2074 6865 2032 6e64 2074 6f20 6c61   # the 2nd to la
-0000b0f0: 7374 2070 6f73 6974 696f 6e2c 0a20 2020  st position,.   
-0000b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b110: 2020 2020 2023 2065 2e67 2e20 666f 7220       # e.g. for 
-0000b120: 6120 746f 6b65 6e30 202d 3e20 746f 6b65  a token0 -> toke
-0000b130: 6e31 202d 3e20 746f 6b65 6e32 202d 3e20  n1 -> token2 -> 
-0000b140: 746f 6b65 6e33 0a20 2020 2020 2020 2020  token3.         
-0000b150: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b160: 2073 7761 7020 7072 6f63 6565 6469 6e67   swap proceeding
-0000b170: 2074 6872 6f75 6768 2070 6f6f 6c30 202d   through pool0 -
-0000b180: 3e20 706f 6f6c 3120 2d3e 2070 6f6f 6c32  > pool1 -> pool2
-0000b190: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b1a0: 2020 2020 2020 2020 2020 2320 2d20 7468            # - th
-0000b1b0: 6520 6c61 7374 2073 7761 7020 2870 6f6f  e last swap (poo
-0000b1c0: 6c5f 706f 7320 3d20 3029 2077 696c 6c20  l_pos = 0) will 
-0000b1d0: 6861 7665 2074 6865 2069 6e70 7574 2074  have the input t
-0000b1e0: 6f6b 656e 0a20 2020 2020 2020 2020 2020  oken.           
-0000b1f0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0000b200: 2069 6e20 7468 6520 7365 636f 6e64 2074   in the second t
-0000b210: 6f20 6c61 7374 2070 6f73 6974 696f 6e20  o last position 
-0000b220: 2869 6e64 6578 202d 322c 2074 6f6b 656e  (index -2, token
-0000b230: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-0000b240: 2020 2020 2020 2020 2020 2023 202d 2074             # - t
-0000b250: 6865 206d 6964 646c 6520 7377 6170 2028  he middle swap (
-0000b260: 706f 6f6c 5f70 6f73 203d 2031 2920 7769  pool_pos = 1) wi
-0000b270: 6c6c 2068 6176 6520 696e 7075 7420 746f  ll have input to
-0000b280: 6b65 6e0a 2020 2020 2020 2020 2020 2020  ken.            
-0000b290: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000b2a0: 696e 2074 6865 2074 6869 7264 2074 6f20  in the third to 
-0000b2b0: 6c61 7374 2070 6f73 6974 696f 6e20 2869  last position (i
-0000b2c0: 6e64 6578 202d 332c 2074 6f6b 656e 3129  ndex -3, token1)
-0000b2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b2e0: 2020 2020 2020 2020 2023 202d 2074 6865           # - the
-0000b2f0: 2066 6972 7374 2073 7761 7020 2870 6f6f   first swap (poo
-0000b300: 6c5f 706f 7320 3d20 3229 2077 696c 6c20  l_pos = 2) will 
-0000b310: 6861 7665 2069 6e70 7574 2074 6f6b 656e  have input token
-0000b320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b330: 2020 2020 2020 2020 2023 2020 2069 6e20           #   in 
-0000b340: 7468 6520 666f 7572 2074 6f20 6c61 7374  the four to last
-0000b350: 2070 6f73 6974 696f 6e20 2869 6e64 6578   position (index
-0000b360: 202d 342c 2074 6f6b 656e 3029 0a20 2020   -4, token0).   
-0000b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b380: 2020 2020 205f 746f 6b65 6e5f 696e 203d       _token_in =
-0000b390: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b3b0: 6f6f 6c2e 746f 6b65 6e30 2069 6620 706f  ool.token0 if po
-0000b3c0: 6f6c 2e74 6f6b 656e 3020 3d3d 2074 785f  ol.token0 == tx_
-0000b3d0: 7061 7468 5b2d 3220 2d20 706f 6f6c 5f70  path[-2 - pool_p
-0000b3e0: 6f73 5d20 656c 7365 2070 6f6f 6c2e 746f  os] else pool.to
-0000b3f0: 6b65 6e31 0a20 2020 2020 2020 2020 2020  ken1.           
-0000b400: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0000b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b420: 2020 2020 2020 2020 5f2c 205f 7632 5f73          _, _v2_s
-0000b430: 696d 5f72 6573 756c 7420 3d20 7365 6c66  im_result = self
-0000b440: 2e5f 7369 6d75 6c61 7465 5f76 325f 7377  ._simulate_v2_sw
-0000b450: 6170 5f65 7861 6374 5f6f 7574 280a 2020  ap_exact_out(.  
-0000b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b470: 2020 2020 2020 2020 2020 706f 6f6c 3d70            pool=p
-0000b480: 6f6f 6c2c 0a20 2020 2020 2020 2020 2020  ool,.           
+0000ae50: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
+0000ae60: 6966 206c 6173 745f 7377 6170 2065 6c73  if last_swap els
+0000ae70: 6520 706f 6f6c 735b 3a3a 2d31 5d5b 706f  e pools[::-1][po
+0000ae80: 6f6c 5f70 6f73 202d 2031 5d2e 6164 6472  ol_pos - 1].addr
+0000ae90: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+0000aea0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aec0: 2020 2020 2020 2023 2067 6574 2074 6865         # get the
+0000aed0: 2069 6e70 7574 2074 6f6b 656e 2062 7920   input token by 
+0000aee0: 7072 6f63 6565 6469 6e67 2062 6163 6b77  proceeding backw
+0000aef0: 6172 6473 2066 726f 6d0a 2020 2020 2020  ards from.      
+0000af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af10: 2020 2320 7468 6520 326e 6420 746f 206c    # the 2nd to l
+0000af20: 6173 7420 706f 7369 7469 6f6e 2c0a 2020  ast position,.  
+0000af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af40: 2020 2020 2020 2320 652e 672e 2066 6f72        # e.g. for
+0000af50: 2061 2074 6f6b 656e 3020 2d3e 2074 6f6b   a token0 -> tok
+0000af60: 656e 3120 2d3e 2074 6f6b 656e 3220 2d3e  en1 -> token2 ->
+0000af70: 2074 6f6b 656e 330a 2020 2020 2020 2020   token3.        
+0000af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af90: 2320 7377 6170 2070 726f 6365 6564 696e  # swap proceedin
+0000afa0: 6720 7468 726f 7567 6820 706f 6f6c 3020  g through pool0 
+0000afb0: 2d3e 2070 6f6f 6c31 202d 3e20 706f 6f6c  -> pool1 -> pool
+0000afc0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+0000afd0: 2020 2020 2020 2020 2020 2023 202d 2074             # - t
+0000afe0: 6865 206c 6173 7420 7377 6170 2028 706f  he last swap (po
+0000aff0: 6f6c 5f70 6f73 203d 2030 2920 7769 6c6c  ol_pos = 0) will
+0000b000: 2068 6176 6520 7468 6520 696e 7075 7420   have the input 
+0000b010: 746f 6b65 6e0a 2020 2020 2020 2020 2020  token.          
+0000b020: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000b030: 2020 696e 2074 6865 2073 6563 6f6e 6420    in the second 
+0000b040: 746f 206c 6173 7420 706f 7369 7469 6f6e  to last position
+0000b050: 2028 696e 6465 7820 2d32 2c20 746f 6b65   (index -2, toke
+0000b060: 6e32 290a 2020 2020 2020 2020 2020 2020  n2).            
+0000b070: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
+0000b080: 7468 6520 6d69 6464 6c65 2073 7761 7020  the middle swap 
+0000b090: 2870 6f6f 6c5f 706f 7320 3d20 3129 2077  (pool_pos = 1) w
+0000b0a0: 696c 6c20 6861 7665 2069 6e70 7574 2074  ill have input t
+0000b0b0: 6f6b 656e 0a20 2020 2020 2020 2020 2020  oken.           
+0000b0c0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+0000b0d0: 2069 6e20 7468 6520 7468 6972 6420 746f   in the third to
+0000b0e0: 206c 6173 7420 706f 7369 7469 6f6e 2028   last position (
+0000b0f0: 696e 6465 7820 2d33 2c20 746f 6b65 6e31  index -3, token1
+0000b100: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b110: 2020 2020 2020 2020 2020 2320 2d20 7468            # - th
+0000b120: 6520 6669 7273 7420 7377 6170 2028 706f  e first swap (po
+0000b130: 6f6c 5f70 6f73 203d 2032 2920 7769 6c6c  ol_pos = 2) will
+0000b140: 2068 6176 6520 696e 7075 7420 746f 6b65   have input toke
+0000b150: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0000b160: 2020 2020 2020 2020 2020 2320 2020 696e            #   in
+0000b170: 2074 6865 2066 6f75 7220 746f 206c 6173   the four to las
+0000b180: 7420 706f 7369 7469 6f6e 2028 696e 6465  t position (inde
+0000b190: 7820 2d34 2c20 746f 6b65 6e30 290a 2020  x -4, token0).  
+0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1b0: 2020 2020 2020 5f74 6f6b 656e 5f69 6e20        _token_in 
+0000b1c0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1e0: 706f 6f6c 2e74 6f6b 656e 3020 6966 2070  pool.token0 if p
+0000b1f0: 6f6f 6c2e 746f 6b65 6e30 203d 3d20 7478  ool.token0 == tx
+0000b200: 5f70 6174 685b 2d32 202d 2070 6f6f 6c5f  _path[-2 - pool_
+0000b210: 706f 735d 2065 6c73 6520 706f 6f6c 2e74  pos] else pool.t
+0000b220: 6f6b 656e 310a 2020 2020 2020 2020 2020  oken1.          
+0000b230: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000b240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b250: 2020 2020 2020 2020 205f 2c20 5f76 325f           _, _v2_
+0000b260: 7369 6d5f 7265 7375 6c74 203d 2073 656c  sim_result = sel
+0000b270: 662e 5f73 696d 756c 6174 655f 7632 5f73  f._simulate_v2_s
+0000b280: 7761 705f 6578 6163 745f 6f75 7428 0a20  wap_exact_out(. 
+0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2a0: 2020 2020 2020 2020 2020 2070 6f6f 6c3d             pool=
+0000b2b0: 706f 6f6c 2c0a 2020 2020 2020 2020 2020  pool,.          
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2d0: 2020 7265 6369 7069 656e 743d 5f72 6563    recipient=_rec
+0000b2e0: 6970 6965 6e74 2c0a 2020 2020 2020 2020  ipient,.        
+0000b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b300: 2020 2020 746f 6b65 6e5f 696e 3d5f 746f      token_in=_to
+0000b310: 6b65 6e5f 696e 2c0a 2020 2020 2020 2020  ken_in,.        
+0000b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b330: 2020 2020 616d 6f75 6e74 5f6f 7574 3d5f      amount_out=_
+0000b340: 616d 6f75 6e74 5f6f 7574 2c0a 2020 2020  amount_out,.    
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b360: 2020 2020 2020 2020 616d 6f75 6e74 5f69          amount_i
+0000b370: 6e5f 6d61 783d 5f61 6d6f 756e 745f 696e  n_max=_amount_in
+0000b380: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
+0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3a0: 2020 6669 7273 745f 7377 6170 3d66 6972    first_swap=fir
+0000b3b0: 7374 5f73 7761 702c 0a20 2020 2020 2020  st_swap,.       
+0000b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3d0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0000b3e0: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
+0000b3f0: 756e 745f 696e 203d 206d 6178 280a 2020  unt_in = max(.  
+0000b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b410: 2020 2020 2020 2020 2020 5f76 325f 7369            _v2_si
+0000b420: 6d5f 7265 7375 6c74 2e61 6d6f 756e 7430  m_result.amount0
+0000b430: 5f64 656c 7461 2c0a 2020 2020 2020 2020  _delta,.        
+0000b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b450: 2020 2020 5f76 325f 7369 6d5f 7265 7375      _v2_sim_resu
+0000b460: 6c74 2e61 6d6f 756e 7431 5f64 656c 7461  lt.amount1_delta
+0000b470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b480: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
 0000b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4a0: 2072 6563 6970 6965 6e74 3d5f 7265 6369   recipient=_reci
-0000b4b0: 7069 656e 742c 0a20 2020 2020 2020 2020  pient,.         
-0000b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4d0: 2020 2074 6f6b 656e 5f69 6e3d 5f74 6f6b     token_in=_tok
-0000b4e0: 656e 5f69 6e2c 0a20 2020 2020 2020 2020  en_in,.         
-0000b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b500: 2020 2061 6d6f 756e 745f 6f75 743d 5f61     amount_out=_a
-0000b510: 6d6f 756e 745f 6f75 742c 0a20 2020 2020  mount_out,.     
-0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b530: 2020 2020 2020 2061 6d6f 756e 745f 696e         amount_in
-0000b540: 5f6d 6178 3d5f 616d 6f75 6e74 5f69 6e5f  _max=_amount_in_
-0000b550: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
-0000b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b570: 2066 6972 7374 5f73 7761 703d 6669 7273   first_swap=firs
-0000b580: 745f 7377 6170 2c0a 2020 2020 2020 2020  t_swap,.        
-0000b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000b5b0: 2020 2020 2020 2020 2020 205f 616d 6f75             _amou
-0000b5c0: 6e74 5f69 6e20 3d20 6d61 7828 0a20 2020  nt_in = max(.   
-0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5e0: 2020 2020 2020 2020 205f 7632 5f73 696d           _v2_sim
-0000b5f0: 5f72 6573 756c 742e 616d 6f75 6e74 305f  _result.amount0_
-0000b600: 6465 6c74 612c 0a20 2020 2020 2020 2020  delta,.         
-0000b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b620: 2020 205f 7632 5f73 696d 5f72 6573 756c     _v2_sim_resul
-0000b630: 742e 616d 6f75 6e74 315f 6465 6c74 612c  t.amount1_delta,
-0000b640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b650: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b670: 2020 2020 5f75 6e69 7665 7273 616c 5f72      _universal_r
-0000b680: 6f75 7465 725f 636f 6d6d 616e 645f 6675  outer_command_fu
-0000b690: 7475 7265 5f70 6f6f 6c5f 7374 6174 6573  ture_pool_states
-0000b6a0: 2e61 7070 656e 6428 2870 6f6f 6c2c 205f  .append((pool, _
-0000b6b0: 7632 5f73 696d 5f72 6573 756c 7429 290a  v2_sim_result)).
-0000b6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b6d0: 2063 6173 6520 2256 335f 5357 4150 5f45   case "V3_SWAP_E
-0000b6e0: 5841 4354 5f49 4e22 3a0a 2020 2020 2020  XACT_IN":.      
-0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-0000b700: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000b710: 2020 2020 2020 4465 636f 6465 2061 6e20        Decode an 
-0000b720: 6578 6163 7420 696e 7075 7420 7377 6170  exact input swap
-0000b730: 2074 6872 6f75 6768 2055 6e69 7377 6170   through Uniswap
-0000b740: 2056 3320 6c69 7175 6964 6974 7920 706f   V3 liquidity po
-0000b750: 6f6c 732e 0a0a 2020 2020 2020 2020 2020  ols...          
-0000b760: 2020 2020 2020 2020 2020 5265 7475 726e            Return
-0000b770: 733a 2061 206c 6973 7420 6f66 2074 7570  s: a list of tup
-0000b780: 6c65 7320 7265 7072 6573 656e 7469 6e67  les representing
-0000b790: 2074 6865 2070 6f6f 6c20 6f62 6a65 6374   the pool object
-0000b7a0: 2061 6e64 2074 6865 2066 696e 616c 2073   and the final s
-0000b7b0: 7461 7465 206f 6620 7468 6520 706f 6f6c  tate of the pool
-0000b7c0: 2061 6674 6572 2074 6865 2073 7761 7020   after the swap 
-0000b7d0: 636f 6d70 6c65 7465 732e 0a20 2020 2020  completes..     
-0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000b7f0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
-0000b800: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b820: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-0000b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b840: 2020 2074 785f 7265 6369 7069 656e 742c     tx_recipient,
-0000b850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b860: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-0000b870: 616d 6f75 6e74 5f69 6e2c 0a20 2020 2020  amount_in,.     
-0000b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b890: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
-0000b8a0: 5f6f 7574 5f6d 696e 2c0a 2020 2020 2020  _out_min,.      
-0000b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8c0: 2020 2020 2020 7478 5f70 6174 682c 0a20        tx_path,. 
+0000b4a0: 2020 2020 2073 656c 662e 7369 6d75 6c61       self.simula
+0000b4b0: 7465 645f 706f 6f6c 5f73 7461 7465 732e  ted_pool_states.
+0000b4c0: 6170 7065 6e64 2828 706f 6f6c 2c20 5f76  append((pool, _v
+0000b4d0: 325f 7369 6d5f 7265 7375 6c74 2929 0a0a  2_sim_result))..
+0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4f0: 6361 7365 2022 5633 5f53 5741 505f 4558  case "V3_SWAP_EX
+0000b500: 4143 545f 494e 223a 0a20 2020 2020 2020  ACT_IN":.       
+0000b510: 2020 2020 2020 2020 2020 2020 2022 2222               """
+0000b520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b530: 2020 2020 2044 6563 6f64 6520 616e 2065       Decode an e
+0000b540: 7861 6374 2069 6e70 7574 2073 7761 7020  xact input swap 
+0000b550: 7468 726f 7567 6820 556e 6973 7761 7020  through Uniswap 
+0000b560: 5633 206c 6971 7569 6469 7479 2070 6f6f  V3 liquidity poo
+0000b570: 6c73 2e0a 0a20 2020 2020 2020 2020 2020  ls...           
+0000b580: 2020 2020 2020 2020 2052 6574 7572 6e73           Returns
+0000b590: 3a20 6120 6c69 7374 206f 6620 7475 706c  : a list of tupl
+0000b5a0: 6573 2072 6570 7265 7365 6e74 696e 6720  es representing 
+0000b5b0: 7468 6520 706f 6f6c 206f 626a 6563 7420  the pool object 
+0000b5c0: 616e 6420 7468 6520 6669 6e61 6c20 7374  and the final st
+0000b5d0: 6174 6520 6f66 2074 6865 2070 6f6f 6c20  ate of the pool 
+0000b5e0: 6166 7465 7220 7468 6520 7377 6170 2063  after the swap c
+0000b5f0: 6f6d 706c 6574 6573 2e0a 2020 2020 2020  ompletes..      
+0000b600: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+0000b610: 220a 0a20 2020 2020 2020 2020 2020 2020  "..             
+0000b620: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b640: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+0000b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b660: 2020 7478 5f72 6563 6970 6965 6e74 2c0a    tx_recipient,.
+0000b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b680: 2020 2020 2020 2020 2020 2020 7478 5f61              tx_a
+0000b690: 6d6f 756e 745f 696e 2c0a 2020 2020 2020  mount_in,.      
+0000b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6b0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+0000b6c0: 6f75 745f 6d69 6e2c 0a20 2020 2020 2020  out_min,.       
+0000b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6e0: 2020 2020 2074 785f 7061 7468 2c0a 2020       tx_path,.  
+0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b700: 2020 2020 2020 2020 2020 7478 5f70 6179            tx_pay
+0000b710: 6572 5f69 735f 7573 6572 2c0a 2020 2020  er_is_user,.    
+0000b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b730: 2020 2020 2920 3d20 6574 685f 6162 692e      ) = eth_abi.
+0000b740: 6162 692e 6465 636f 6465 280a 2020 2020  abi.decode(.    
+0000b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b760: 2020 2020 2020 2020 7479 7065 733d 280a          types=(.
+0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b790: 2261 6464 7265 7373 222c 0a20 2020 2020  "address",.     
+0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7b0: 2020 2020 2020 2020 2020 2022 7569 6e74             "uint
+0000b7c0: 3235 3622 2c0a 2020 2020 2020 2020 2020  256",.          
+0000b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b7e0: 2020 2020 2020 2275 696e 7432 3536 222c        "uint256",
+0000b7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b810: 2022 6279 7465 7322 2c0a 2020 2020 2020   "bytes",.      
+0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b830: 2020 2020 2020 2020 2020 2262 6f6f 6c22            "bool"
+0000b840: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b850: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+0000b860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b870: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0000b880: 613d 696e 7075 7473 2c0a 2020 2020 2020  a=inputs,.      
+0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000b8b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000b8c0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
 0000b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8e0: 2020 2020 2020 2020 2020 2074 785f 7061             tx_pa
-0000b8f0: 7965 725f 6973 5f75 7365 722c 0a20 2020  yer_is_user,.   
-0000b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b910: 2020 2020 2029 203d 2065 7468 5f61 6269       ) = eth_abi
-0000b920: 2e61 6269 2e64 6563 6f64 6528 0a20 2020  .abi.decode(.   
-0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b940: 2020 2020 2020 2020 2074 7970 6573 3d28           types=(
-0000b950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b8e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000b8f0: 6f72 2866 2243 6f75 6c64 206e 6f74 2064  or(f"Could not d
+0000b900: 6563 6f64 6520 696e 7075 7420 666f 7220  ecode input for 
+0000b910: 7b63 6f6d 6d61 6e64 7d22 290a 0a20 2020  {command}")..   
+0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b930: 2074 785f 7061 7468 5f64 6563 6f64 6564   tx_path_decoded
+0000b940: 203d 2064 6563 6f64 655f 7633 5f70 6174   = decode_v3_pat
+0000b950: 6828 7478 5f70 6174 6829 0a0a 2020 2020  h(tx_path)..    
 0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 2022 6164 6472 6573 7322 2c0a 2020 2020   "address",.    
-0000b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b990: 2020 2020 2020 2020 2020 2020 2275 696e              "uin
-0000b9a0: 7432 3536 222c 0a20 2020 2020 2020 2020  t256",.         
+0000b970: 2320 6465 636f 6465 2074 6865 2070 6174  # decode the pat
+0000b980: 6820 2d20 746f 6b65 6e49 6e20 6973 2074  h - tokenIn is t
+0000b990: 6865 2066 6972 7374 2070 6f73 6974 696f  he first positio
+0000b9a0: 6e2c 2066 6565 2069 7320 7468 650a 2020  n, fee is the.  
 0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9c0: 2020 2020 2020 2022 7569 6e74 3235 3622         "uint256"
-0000b9d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9f0: 2020 2262 7974 6573 222c 0a20 2020 2020    "bytes",.     
-0000ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba10: 2020 2020 2020 2020 2020 2022 626f 6f6c             "bool
-0000ba20: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000ba30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000ba40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ba50: 2020 2020 2020 2020 2020 2020 2020 6461                da
-0000ba60: 7461 3d69 6e70 7574 732c 0a20 2020 2020  ta=inputs,.     
-0000ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000ba90: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000baa0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-0000bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bac0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000bad0: 726f 7228 6622 436f 756c 6420 6e6f 7420  ror(f"Could not 
-0000bae0: 6465 636f 6465 2069 6e70 7574 2066 6f72  decode input for
-0000baf0: 207b 636f 6d6d 616e 647d 2229 0a0a 2020   {command}")..  
-0000bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb10: 2020 7478 5f70 6174 685f 6465 636f 6465    tx_path_decode
-0000bb20: 6420 3d20 6465 636f 6465 5f76 335f 7061  d = decode_v3_pa
-0000bb30: 7468 2874 785f 7061 7468 290a 0a20 2020  th(tx_path)..   
-0000bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb50: 2023 2064 6563 6f64 6520 7468 6520 7061   # decode the pa
-0000bb60: 7468 202d 2074 6f6b 656e 496e 2069 7320  th - tokenIn is 
-0000bb70: 7468 6520 6669 7273 7420 706f 7369 7469  the first positi
-0000bb80: 6f6e 2c20 6665 6520 6973 2074 6865 0a20  on, fee is the. 
-0000bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bba0: 2020 2023 2073 6563 6f6e 6420 706f 7369     # second posi
-0000bbb0: 7469 6f6e 2c20 746f 6b65 6e4f 7574 2069  tion, tokenOut i
-0000bbc0: 7320 7468 6520 7468 6972 6420 706f 7369  s the third posi
-0000bbd0: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
-0000bbe0: 2020 2020 2020 2020 2020 2320 7061 7468            # path
-0000bbf0: 7320 6361 6e20 6265 2061 6e20 6172 6269  s can be an arbi
-0000bc00: 7472 6172 7920 6c65 6e67 7468 2c20 6275  trary length, bu
-0000bc10: 7420 6164 6472 6573 7320 2620 6665 6520  t address & fee 
-0000bc20: 7661 6c75 6573 0a20 2020 2020 2020 2020  values.         
-0000bc30: 2020 2020 2020 2020 2020 2023 2061 7265             # are
-0000bc40: 2061 6c77 6179 7320 696e 7465 726c 6561   always interlea
-0000bc50: 7665 642e 2065 2e67 2e20 746f 6b65 6e49  ved. e.g. tokenI
-0000bc60: 6e2c 2066 6565 2c20 746f 6b65 6e4f 7574  n, fee, tokenOut
-0000bc70: 2c20 6665 652c 0a20 2020 2020 2020 2020  , fee,.         
-0000bc80: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-0000bc90: 746f 6b65 6e5f 706f 7320 3d20 6c65 6e28  token_pos = len(
-0000bca0: 7478 5f70 6174 685f 6465 636f 6465 6429  tx_path_decoded)
-0000bcb0: 202d 2033 0a0a 2020 2020 2020 2020 2020   - 3..          
-0000bcc0: 2020 2020 2020 2020 2020 666f 7220 746f            for to
-0000bcd0: 6b65 6e5f 706f 7320 696e 2072 616e 6765  ken_pos in range
-0000bce0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000bcf0: 2020 2020 2020 2020 2020 302c 0a20 2020            0,.   
+0000b9c0: 2020 2320 7365 636f 6e64 2070 6f73 6974    # second posit
+0000b9d0: 696f 6e2c 2074 6f6b 656e 4f75 7420 6973  ion, tokenOut is
+0000b9e0: 2074 6865 2074 6869 7264 2070 6f73 6974   the third posit
+0000b9f0: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+0000ba00: 2020 2020 2020 2020 2023 2070 6174 6873           # paths
+0000ba10: 2063 616e 2062 6520 616e 2061 7262 6974   can be an arbit
+0000ba20: 7261 7279 206c 656e 6774 682c 2062 7574  rary length, but
+0000ba30: 2061 6464 7265 7373 2026 2066 6565 2076   address & fee v
+0000ba40: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
+0000ba50: 2020 2020 2020 2020 2020 2320 6172 6520            # are 
+0000ba60: 616c 7761 7973 2069 6e74 6572 6c65 6176  always interleav
+0000ba70: 6564 2e20 652e 672e 2074 6f6b 656e 496e  ed. e.g. tokenIn
+0000ba80: 2c20 6665 652c 2074 6f6b 656e 4f75 742c  , fee, tokenOut,
+0000ba90: 2066 6565 2c0a 2020 2020 2020 2020 2020   fee,.          
+0000baa0: 2020 2020 2020 2020 2020 6c61 7374 5f74            last_t
+0000bab0: 6f6b 656e 5f70 6f73 203d 206c 656e 2874  oken_pos = len(t
+0000bac0: 785f 7061 7468 5f64 6563 6f64 6564 2920  x_path_decoded) 
+0000bad0: 2d20 330a 0a20 2020 2020 2020 2020 2020  - 3..           
+0000bae0: 2020 2020 2020 2020 2066 6f72 2074 6f6b           for tok
+0000baf0: 656e 5f70 6f73 2069 6e20 7261 6e67 6528  en_pos in range(
+0000bb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bb10: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+0000bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb30: 2020 2020 6c65 6e28 7478 5f70 6174 685f      len(tx_path_
+0000bb40: 6465 636f 6465 6429 202d 2032 2c0a 2020  decoded) - 2,.  
+0000bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb60: 2020 2020 2020 322c 0a20 2020 2020 2020        2,.       
+0000bb70: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+0000bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb90: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
+0000bba0: 5f69 6e5f 6164 6472 6573 7320 3d20 7478  _in_address = tx
+0000bbb0: 5f70 6174 685f 6465 636f 6465 645b 746f  _path_decoded[to
+0000bbc0: 6b65 6e5f 706f 735d 0a20 2020 2020 2020  ken_pos].       
+0000bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbe0: 2066 6565 203d 2074 785f 7061 7468 5f64   fee = tx_path_d
+0000bbf0: 6563 6f64 6564 5b74 6f6b 656e 5f70 6f73  ecoded[token_pos
+0000bc00: 202b 2031 5d0a 2020 2020 2020 2020 2020   + 1].          
+0000bc10: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0000bc20: 5f74 6f6b 656e 5f6f 7574 5f61 6464 7265  _token_out_addre
+0000bc30: 7373 203d 2074 785f 7061 7468 5f64 6563  ss = tx_path_dec
+0000bc40: 6f64 6564 5b74 6f6b 656e 5f70 6f73 202b  oded[token_pos +
+0000bc50: 2032 5d0a 0a20 2020 2020 2020 2020 2020   2]..           
+0000bc60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000bc70: 5459 5045 5f43 4845 434b 494e 473a 0a20  TYPE_CHECKING:. 
+0000bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000bca0: 7420 6973 696e 7374 616e 6365 2874 785f  t isinstance(tx_
+0000bcb0: 746f 6b65 6e5f 696e 5f61 6464 7265 7373  token_in_address
+0000bcc0: 2c20 7374 7229 0a20 2020 2020 2020 2020  , str).         
+0000bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bce0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0000bcf0: 616e 6365 2866 6565 2c20 696e 7429 0a20  ance(fee, int). 
 0000bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd10: 2020 2020 206c 656e 2874 785f 7061 7468       len(tx_path
-0000bd20: 5f64 6563 6f64 6564 2920 2d20 322c 0a20  _decoded) - 2,. 
-0000bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd40: 2020 2020 2020 2032 2c0a 2020 2020 2020         2,.      
-0000bd50: 2020 2020 2020 2020 2020 2020 2020 293a                ):
-0000bd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bd70: 2020 2020 2020 2020 2074 785f 746f 6b65           tx_toke
-0000bd80: 6e5f 696e 5f61 6464 7265 7373 203d 2074  n_in_address = t
-0000bd90: 785f 7061 7468 5f64 6563 6f64 6564 5b74  x_path_decoded[t
-0000bda0: 6f6b 656e 5f70 6f73 5d0a 2020 2020 2020  oken_pos].      
-0000bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bdc0: 2020 6665 6520 3d20 7478 5f70 6174 685f    fee = tx_path_
-0000bdd0: 6465 636f 6465 645b 746f 6b65 6e5f 706f  decoded[token_po
-0000bde0: 7320 2b20 315d 0a20 2020 2020 2020 2020  s + 1].         
-0000bdf0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000be00: 785f 746f 6b65 6e5f 6f75 745f 6164 6472  x_token_out_addr
-0000be10: 6573 7320 3d20 7478 5f70 6174 685f 6465  ess = tx_path_de
-0000be20: 636f 6465 645b 746f 6b65 6e5f 706f 7320  coded[token_pos 
-0000be30: 2b20 325d 0a0a 2020 2020 2020 2020 2020  + 2]..          
-0000be40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000be50: 2054 5950 455f 4348 4543 4b49 4e47 3a0a   TYPE_CHECKING:.
-0000be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be70: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000be80: 7274 2069 7369 6e73 7461 6e63 6528 7478  rt isinstance(tx
-0000be90: 5f74 6f6b 656e 5f69 6e5f 6164 6472 6573  _token_in_addres
-0000bea0: 732c 2073 7472 290a 2020 2020 2020 2020  s, str).        
-0000beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bec0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000bed0: 7461 6e63 6528 6665 652c 2069 6e74 290a  tance(fee, int).
+0000bd10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000bd20: 7420 6973 696e 7374 616e 6365 2874 785f  t isinstance(tx_
+0000bd30: 746f 6b65 6e5f 6f75 745f 6164 6472 6573  token_out_addres
+0000bd40: 732c 2073 7472 290a 0a20 2020 2020 2020  s, str)..       
+0000bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd60: 2066 6972 7374 5f73 7761 7020 3d20 746f   first_swap = to
+0000bd70: 6b65 6e5f 706f 7320 3d3d 2030 0a20 2020  ken_pos == 0.   
+0000bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd90: 2020 2020 206c 6173 745f 7377 6170 203d       last_swap =
+0000bda0: 2074 6f6b 656e 5f70 6f73 203d 3d20 6c61   token_pos == la
+0000bdb0: 7374 5f74 6f6b 656e 5f70 6f73 0a0a 2020  st_token_pos..  
+0000bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdd0: 2020 2020 2020 6966 2054 5950 455f 4348        if TYPE_CH
+0000bde0: 4543 4b49 4e47 3a0a 2020 2020 2020 2020  ECKING:.        
+0000bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be00: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+0000be10: 7633 5f70 6f6f 6c5f 6d61 6e61 6765 7220  v3_pool_manager 
+0000be20: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+0000be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be40: 2020 2020 7633 5f70 6f6f 6c20 3d20 7365      v3_pool = se
+0000be50: 6c66 2e76 335f 706f 6f6c 5f6d 616e 6167  lf.v3_pool_manag
+0000be60: 6572 2e67 6574 5f70 6f6f 6c28 0a20 2020  er.get_pool(.   
+0000be70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be80: 2020 2020 2020 2020 2074 6f6b 656e 5f61           token_a
+0000be90: 6464 7265 7373 6573 3d28 0a20 2020 2020  ddresses=(.     
+0000bea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000beb0: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
+0000bec0: 6b65 6e5f 696e 5f61 6464 7265 7373 2c0a  ken_in_address,.
+0000bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bef0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000bf00: 7274 2069 7369 6e73 7461 6e63 6528 7478  rt isinstance(tx
-0000bf10: 5f74 6f6b 656e 5f6f 7574 5f61 6464 7265  _token_out_addre
-0000bf20: 7373 2c20 7374 7229 0a0a 2020 2020 2020  ss, str)..      
+0000bef0: 7478 5f74 6f6b 656e 5f6f 7574 5f61 6464  tx_token_out_add
+0000bf00: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+0000bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf20: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
 0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf40: 2020 6669 7273 745f 7377 6170 203d 2074    first_swap = t
-0000bf50: 6f6b 656e 5f70 6f73 203d 3d20 300a 2020  oken_pos == 0.  
-0000bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf70: 2020 2020 2020 6c61 7374 5f73 7761 7020        last_swap 
-0000bf80: 3d20 746f 6b65 6e5f 706f 7320 3d3d 206c  = token_pos == l
-0000bf90: 6173 745f 746f 6b65 6e5f 706f 730a 0a20  ast_token_pos.. 
+0000bf40: 2070 6f6f 6c5f 6665 653d 6665 652c 0a20   pool_fee=fee,. 
+0000bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf60: 2020 2020 2020 2020 2020 2073 696c 656e             silen
+0000bf70: 743d 7365 6c66 2e73 696c 656e 742c 0a20  t=self.silent,. 
+0000bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf90: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
 0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfb0: 2020 2020 2020 2069 6620 5459 5045 5f43         if TYPE_C
-0000bfc0: 4845 434b 494e 473a 0a20 2020 2020 2020  HECKING:.       
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfe0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-0000bff0: 2e76 335f 706f 6f6c 5f6d 616e 6167 6572  .v3_pool_manager
-0000c000: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c020: 2020 2020 2076 335f 706f 6f6c 203d 2073       v3_pool = s
-0000c030: 656c 662e 7633 5f70 6f6f 6c5f 6d61 6e61  elf.v3_pool_mana
-0000c040: 6765 722e 6765 745f 706f 6f6c 280a 2020  ger.get_pool(.  
-0000c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c060: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0000c070: 6164 6472 6573 7365 733d 280a 2020 2020  addresses=(.    
-0000c080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c090: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
-0000c0a0: 6f6b 656e 5f69 6e5f 6164 6472 6573 732c  oken_in_address,
-0000c0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0d0: 2074 785f 746f 6b65 6e5f 6f75 745f 6164   tx_token_out_ad
-0000c0e0: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-0000c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c100: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-0000c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c120: 2020 706f 6f6c 5f66 6565 3d66 6565 2c0a    pool_fee=fee,.
-0000c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c140: 2020 2020 2020 2020 2020 2020 7369 6c65              sile
-0000c150: 6e74 3d73 656c 662e 7369 6c65 6e74 2c0a  nt=self.silent,.
-0000c160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c170: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c190: 2020 205f 7265 6369 7069 656e 7420 3d20     _recipient = 
-0000c1a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c1b0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-0000c1c0: 5f72 6563 6970 6965 6e74 2069 6620 6c61  _recipient if la
-0000c1d0: 7374 5f73 7761 7020 656c 7365 2055 6e69  st_swap else Uni
-0000c1e0: 7665 7273 616c 526f 7574 6572 5370 6563  versalRouterSpec
-0000c1f0: 6961 6c41 6464 7265 7373 2e52 4f55 5445  ialAddress.ROUTE
-0000c200: 520a 2020 2020 2020 2020 2020 2020 2020  R.              
-0000c210: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c230: 2020 2020 5f74 6f6b 656e 5f69 6e20 3d20      _token_in = 
-0000c240: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c250: 2020 2020 2020 2020 2020 2020 2020 7633                v3
-0000c260: 5f70 6f6f 6c2e 746f 6b65 6e30 0a20 2020  _pool.token0.   
-0000c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c280: 2020 2020 2020 2020 2069 6620 7633 5f70           if v3_p
-0000c290: 6f6f 6c2e 746f 6b65 6e30 203d 3d20 7478  ool.token0 == tx
-0000c2a0: 5f74 6f6b 656e 5f69 6e5f 6164 6472 6573  _token_in_addres
-0000c2b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000c2c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000c2d0: 7365 2076 335f 706f 6f6c 2e74 6f6b 656e  se v3_pool.token
-0000c2e0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0000c2f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c310: 2020 2020 5f61 6d6f 756e 745f 696e 203d      _amount_in =
-0000c320: 2074 785f 616d 6f75 6e74 5f69 6e20 6966   tx_amount_in if
-0000c330: 2066 6972 7374 5f73 7761 7020 656c 7365   first_swap else
-0000c340: 205f 616d 6f75 6e74 5f6f 7574 0a20 2020   _amount_out.   
+0000bfb0: 2020 5f72 6563 6970 6965 6e74 203d 2028    _recipient = (
+0000bfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bfd0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
+0000bfe0: 7265 6369 7069 656e 7420 6966 206c 6173  recipient if las
+0000bff0: 745f 7377 6170 2065 6c73 6520 556e 6976  t_swap else Univ
+0000c000: 6572 7361 6c52 6f75 7465 7253 7065 6369  ersalRouterSpeci
+0000c010: 616c 4164 6472 6573 732e 524f 5554 4552  alAddress.ROUTER
+0000c020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c030: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c050: 2020 205f 746f 6b65 6e5f 696e 203d 2028     _token_in = (
+0000c060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c070: 2020 2020 2020 2020 2020 2020 2076 335f               v3_
+0000c080: 706f 6f6c 2e74 6f6b 656e 300a 2020 2020  pool.token0.    
+0000c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c0a0: 2020 2020 2020 2020 6966 2076 335f 706f          if v3_po
+0000c0b0: 6f6c 2e74 6f6b 656e 3020 3d3d 2074 785f  ol.token0 == tx_
+0000c0c0: 746f 6b65 6e5f 696e 5f61 6464 7265 7373  token_in_address
+0000c0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c0e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000c0f0: 6520 7633 5f70 6f6f 6c2e 746f 6b65 6e31  e v3_pool.token1
+0000c100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c110: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c130: 2020 205f 616d 6f75 6e74 5f69 6e20 3d20     _amount_in = 
+0000c140: 7478 5f61 6d6f 756e 745f 696e 2069 6620  tx_amount_in if 
+0000c150: 6669 7273 745f 7377 6170 2065 6c73 6520  first_swap else 
+0000c160: 5f61 6d6f 756e 745f 6f75 740a 2020 2020  _amount_out.    
+0000c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c180: 2020 2020 5f61 6d6f 756e 745f 6f75 745f      _amount_out_
+0000c190: 6d69 6e20 3d20 7478 5f61 6d6f 756e 745f  min = tx_amount_
+0000c1a0: 6f75 745f 6d69 6e20 6966 206c 6173 745f  out_min if last_
+0000c1b0: 7377 6170 2065 6c73 6520 4e6f 6e65 0a0a  swap else None..
+0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1d0: 2020 2020 2020 2020 7633 5f73 696d 5f72          v3_sim_r
+0000c1e0: 6573 756c 743a 2055 6e69 7377 6170 5633  esult: UniswapV3
+0000c1f0: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
+0000c200: 7375 6c74 0a20 2020 2020 2020 2020 2020  sult.           
+0000c210: 2020 2020 2020 2020 2020 2020 205f 2c20               _, 
+0000c220: 7633 5f73 696d 5f72 6573 756c 7420 3d20  v3_sim_result = 
+0000c230: 7365 6c66 2e5f 7369 6d75 6c61 7465 5f76  self._simulate_v
+0000c240: 335f 7377 6170 5f65 7861 6374 5f69 6e28  3_swap_exact_in(
+0000c250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c260: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
+0000c270: 6c3d 7633 5f70 6f6f 6c2c 0a20 2020 2020  l=v3_pool,.     
+0000c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c290: 2020 2020 2020 2072 6563 6970 6965 6e74         recipient
+0000c2a0: 3d5f 7265 6369 7069 656e 742c 0a20 2020  =_recipient,.   
+0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2c0: 2020 2020 2020 2020 2074 6f6b 656e 5f69           token_i
+0000c2d0: 6e3d 5f74 6f6b 656e 5f69 6e2c 0a20 2020  n=_token_in,.   
+0000c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2f0: 2020 2020 2020 2020 2061 6d6f 756e 745f           amount_
+0000c300: 696e 3d5f 616d 6f75 6e74 5f69 6e2c 0a20  in=_amount_in,. 
+0000c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c320: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
+0000c330: 745f 6f75 745f 6d69 6e3d 5f61 6d6f 756e  t_out_min=_amoun
+0000c340: 745f 6f75 745f 6d69 6e2c 0a20 2020 2020  t_out_min,.     
 0000c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c360: 2020 2020 205f 616d 6f75 6e74 5f6f 7574       _amount_out
-0000c370: 5f6d 696e 203d 2074 785f 616d 6f75 6e74  _min = tx_amount
-0000c380: 5f6f 7574 5f6d 696e 2069 6620 6c61 7374  _out_min if last
-0000c390: 5f73 7761 7020 656c 7365 204e 6f6e 650a  _swap else None.
-0000c3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c3b0: 2020 2020 2020 2020 2076 335f 7369 6d5f           v3_sim_
-0000c3c0: 7265 7375 6c74 3a20 556e 6973 7761 7056  result: UniswapV
-0000c3d0: 3350 6f6f 6c53 696d 756c 6174 696f 6e52  3PoolSimulationR
-0000c3e0: 6573 756c 740a 2020 2020 2020 2020 2020  esult.          
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 5f2c                _,
-0000c400: 2076 335f 7369 6d5f 7265 7375 6c74 203d   v3_sim_result =
-0000c410: 2073 656c 662e 5f73 696d 756c 6174 655f   self._simulate_
-0000c420: 7633 5f73 7761 705f 6578 6163 745f 696e  v3_swap_exact_in
-0000c430: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c440: 2020 2020 2020 2020 2020 2020 2020 706f                po
-0000c450: 6f6c 3d76 335f 706f 6f6c 2c0a 2020 2020  ol=v3_pool,.    
-0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c470: 2020 2020 2020 2020 7265 6369 7069 656e          recipien
-0000c480: 743d 5f72 6563 6970 6965 6e74 2c0a 2020  t=_recipient,.  
-0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4a0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0000c4b0: 696e 3d5f 746f 6b65 6e5f 696e 2c0a 2020  in=_token_in,.  
-0000c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4d0: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
-0000c4e0: 5f69 6e3d 5f61 6d6f 756e 745f 696e 2c0a  _in=_amount_in,.
-0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c500: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-0000c510: 6e74 5f6f 7574 5f6d 696e 3d5f 616d 6f75  nt_out_min=_amou
-0000c520: 6e74 5f6f 7574 5f6d 696e 2c0a 2020 2020  nt_out_min,.    
-0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c540: 2020 2020 2020 2020 6669 7273 745f 7377          first_sw
-0000c550: 6170 3d66 6972 7374 5f73 7761 702c 0a20  ap=first_swap,. 
-0000c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c570: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c590: 2020 5f61 6d6f 756e 745f 6f75 7420 3d20    _amount_out = 
-0000c5a0: 2d6d 696e 280a 2020 2020 2020 2020 2020  -min(.          
-0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5c0: 2020 7633 5f73 696d 5f72 6573 756c 742e    v3_sim_result.
-0000c5d0: 616d 6f75 6e74 305f 6465 6c74 612c 0a20  amount0_delta,. 
-0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5f0: 2020 2020 2020 2020 2020 2076 335f 7369             v3_si
-0000c600: 6d5f 7265 7375 6c74 2e61 6d6f 756e 7431  m_result.amount1
-0000c610: 5f64 656c 7461 2c0a 2020 2020 2020 2020  _delta,.        
-0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c630: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000c640: 2020 2020 2020 2020 2020 205f 756e 6976             _univ
-0000c650: 6572 7361 6c5f 726f 7574 6572 5f63 6f6d  ersal_router_com
-0000c660: 6d61 6e64 5f66 7574 7572 655f 706f 6f6c  mand_future_pool
-0000c670: 5f73 7461 7465 732e 6170 7065 6e64 280a  _states.append(.
+0000c360: 2020 2020 2020 2066 6972 7374 5f73 7761         first_swa
+0000c370: 703d 6669 7273 745f 7377 6170 2c0a 2020  p=first_swap,.  
+0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c390: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3b0: 205f 616d 6f75 6e74 5f6f 7574 203d 202d   _amount_out = -
+0000c3c0: 6d69 6e28 0a20 2020 2020 2020 2020 2020  min(.           
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3e0: 2076 335f 7369 6d5f 7265 7375 6c74 2e61   v3_sim_result.a
+0000c3f0: 6d6f 756e 7430 5f64 656c 7461 2c0a 2020  mount0_delta,.  
+0000c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c410: 2020 2020 2020 2020 2020 7633 5f73 696d            v3_sim
+0000c420: 5f72 6573 756c 742e 616d 6f75 6e74 315f  _result.amount1_
+0000c430: 6465 6c74 612c 0a20 2020 2020 2020 2020  delta,.         
+0000c440: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c450: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c460: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0000c470: 696d 756c 6174 6564 5f70 6f6f 6c5f 7374  imulated_pool_st
+0000c480: 6174 6573 2e61 7070 656e 6428 2876 335f  ates.append((v3_
+0000c490: 706f 6f6c 2c20 7633 5f73 696d 5f72 6573  pool, v3_sim_res
+0000c4a0: 756c 7429 290a 0a20 2020 2020 2020 2020  ult))..         
+0000c4b0: 2020 2020 2020 2063 6173 6520 2256 335f         case "V3_
+0000c4c0: 5357 4150 5f45 5841 4354 5f4f 5554 223a  SWAP_EXACT_OUT":
+0000c4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c4e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000c4f0: 2020 2020 2020 2020 2020 2020 2044 6563               Dec
+0000c500: 6f64 6520 616e 2065 7861 6374 206f 7574  ode an exact out
+0000c510: 7075 7420 7377 6170 2074 6872 6f75 6768  put swap through
+0000c520: 2055 6e69 7377 6170 2056 3320 6c69 7175   Uniswap V3 liqu
+0000c530: 6964 6974 7920 706f 6f6c 732e 0a0a 2020  idity pools...  
+0000c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c550: 2020 5265 7475 726e 733a 2061 206c 6973    Returns: a lis
+0000c560: 7420 6f66 2074 7570 6c65 7320 7265 7072  t of tuples repr
+0000c570: 6573 656e 7469 6e67 2074 6865 2070 6f6f  esenting the poo
+0000c580: 6c20 6f62 6a65 6374 2061 6e64 2074 6865  l object and the
+0000c590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5a0: 2020 2020 2066 696e 616c 2073 7461 7465       final state
+0000c5b0: 206f 6620 7468 6520 706f 6f6c 2061 6674   of the pool aft
+0000c5c0: 6572 2074 6865 2073 7761 7020 636f 6d70  er the swap comp
+0000c5d0: 6c65 7465 732e 0a20 2020 2020 2020 2020  letes..         
+0000c5e0: 2020 2020 2020 2020 2020 2022 2222 0a0a             """..
+0000c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c600: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c620: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0000c630: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000c640: 785f 7265 6369 7069 656e 742c 0a20 2020  x_recipient,.   
+0000c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c660: 2020 2020 2020 2020 2074 785f 616d 6f75           tx_amou
+0000c670: 6e74 5f6f 7574 2c0a 2020 2020 2020 2020  nt_out,.        
 0000c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c690: 2020 2020 2020 2020 2020 2020 2876 335f              (v3_
-0000c6a0: 706f 6f6c 2c20 7633 5f73 696d 5f72 6573  pool, v3_sim_res
-0000c6b0: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-0000c6c0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000c690: 2020 2020 7478 5f61 6d6f 756e 745f 696e      tx_amount_in
+0000c6a0: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
+0000c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6c0: 2020 7478 5f70 6174 682c 0a20 2020 2020    tx_path,.     
 0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6e0: 6361 7365 2022 5633 5f53 5741 505f 4558  case "V3_SWAP_EX
-0000c6f0: 4143 545f 4f55 5422 3a0a 2020 2020 2020  ACT_OUT":.      
-0000c700: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-0000c710: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000c720: 2020 2020 2020 4465 636f 6465 2061 6e20        Decode an 
-0000c730: 6578 6163 7420 6f75 7470 7574 2073 7761  exact output swa
-0000c740: 7020 7468 726f 7567 6820 556e 6973 7761  p through Uniswa
-0000c750: 7020 5633 206c 6971 7569 6469 7479 2070  p V3 liquidity p
-0000c760: 6f6f 6c73 2e0a 0a20 2020 2020 2020 2020  ools...         
-0000c770: 2020 2020 2020 2020 2020 2052 6574 7572             Retur
-0000c780: 6e73 3a20 6120 6c69 7374 206f 6620 7475  ns: a list of tu
-0000c790: 706c 6573 2072 6570 7265 7365 6e74 696e  ples representin
-0000c7a0: 6720 7468 6520 706f 6f6c 206f 626a 6563  g the pool objec
-0000c7b0: 7420 616e 6420 7468 650a 2020 2020 2020  t and the.      
-0000c7c0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c7d0: 6e61 6c20 7374 6174 6520 6f66 2074 6865  nal state of the
-0000c7e0: 2070 6f6f 6c20 6166 7465 7220 7468 6520   pool after the 
-0000c7f0: 7377 6170 2063 6f6d 706c 6574 6573 2e0a  swap completes..
+0000c6e0: 2020 2020 2020 2074 785f 7061 7965 725f         tx_payer_
+0000c6f0: 6973 5f75 7365 722c 0a20 2020 2020 2020  is_user,.       
+0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c710: 2029 203d 2065 7468 5f61 6269 2e61 6269   ) = eth_abi.abi
+0000c720: 2e64 6563 6f64 6528 0a20 2020 2020 2020  .decode(.       
+0000c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c740: 2020 2020 2074 7970 6573 3d28 0a20 2020       types=(.   
+0000c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c760: 2020 2020 2020 2020 2020 2020 2022 6164               "ad
+0000c770: 6472 6573 7322 2c0a 2020 2020 2020 2020  dress",.        
+0000c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c790: 2020 2020 2020 2020 2275 696e 7432 3536          "uint256
+0000c7a0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7c0: 2020 2022 7569 6e74 3235 3622 2c0a 2020     "uint256",.  
+0000c7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7e0: 2020 2020 2020 2020 2020 2020 2020 2262                "b
+0000c7f0: 7974 6573 222c 0a20 2020 2020 2020 2020  ytes",.         
 0000c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c810: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-0000c820: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0000c830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c840: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
-0000c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c860: 2020 2020 2020 2020 7478 5f72 6563 6970          tx_recip
-0000c870: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c890: 2020 7478 5f61 6d6f 756e 745f 6f75 742c    tx_amount_out,
-0000c8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c8b0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-0000c8c0: 616d 6f75 6e74 5f69 6e5f 6d61 782c 0a20  amount_in_max,. 
-0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8e0: 2020 2020 2020 2020 2020 2074 785f 7061             tx_pa
-0000c8f0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0000c900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c910: 7478 5f70 6179 6572 5f69 735f 7573 6572  tx_payer_is_user
-0000c920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c930: 2020 2020 2020 2020 2020 2920 3d20 6574            ) = et
-0000c940: 685f 6162 692e 6162 692e 6465 636f 6465  h_abi.abi.decode
-0000c950: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000c960: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-0000c970: 7065 733d 280a 2020 2020 2020 2020 2020  pes=(.          
-0000c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c990: 2020 2020 2020 2261 6464 7265 7373 222c        "address",
-0000c9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9c0: 2022 7569 6e74 3235 3622 2c0a 2020 2020   "uint256",.    
+0000c810: 2020 2020 2020 2022 626f 6f6c 222c 0a20         "bool",. 
+0000c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c830: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+0000c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c850: 2020 2020 2020 2020 2020 6461 7461 3d69            data=i
+0000c860: 6e70 7574 732c 0a20 2020 2020 2020 2020  nputs,.         
+0000c870: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c890: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0000c8a0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000c8c0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000c8d0: 6622 436f 756c 6420 6e6f 7420 6465 636f  f"Could not deco
+0000c8e0: 6465 2069 6e70 7574 2066 6f72 207b 636f  de input for {co
+0000c8f0: 6d6d 616e 647d 2229 0a0a 2020 2020 2020  mmand}")..      
+0000c900: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0000c910: 5f70 6174 685f 6465 636f 6465 6420 3d20  _path_decoded = 
+0000c920: 6465 636f 6465 5f76 335f 7061 7468 2874  decode_v3_path(t
+0000c930: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
+0000c940: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+0000c950: 6e20 6578 6163 7420 6f75 7470 7574 2070  n exact output p
+0000c960: 6174 6820 6973 2065 6e63 6f64 6564 2069  ath is encoded i
+0000c970: 6e20 5245 5645 5253 4520 6f72 6465 722c  n REVERSE order,
+0000c980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c990: 2020 2020 2023 2074 6f6b 656e 4f75 7420       # tokenOut 
+0000c9a0: 6973 2074 6865 2066 6972 7374 2070 6f73  is the first pos
+0000c9b0: 6974 696f 6e2c 2074 6f6b 656e 496e 2069  ition, tokenIn i
+0000c9c0: 7320 7468 6520 7365 636f 6e64 0a20 2020  s the second.   
 0000c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9e0: 2020 2020 2020 2020 2020 2020 2275 696e              "uin
-0000c9f0: 7432 3536 222c 0a20 2020 2020 2020 2020  t256",.         
-0000ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca10: 2020 2020 2020 2022 6279 7465 7322 2c0a         "bytes",.
-0000ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca40: 2262 6f6f 6c22 2c0a 2020 2020 2020 2020  "bool",.        
-0000ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca60: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca80: 2020 2064 6174 613d 696e 7075 7473 2c0a     data=inputs,.
+0000c9e0: 2023 2070 6f73 6974 696f 6e2e 2065 2e67   # position. e.g
+0000c9f0: 2e20 746f 6b65 6e4f 7574 2c20 6665 652c  . tokenOut, fee,
+0000ca00: 2074 6f6b 656e 496e 0a20 2020 2020 2020   tokenIn.       
+0000ca10: 2020 2020 2020 2020 2020 2020 206c 6173               las
+0000ca20: 745f 746f 6b65 6e5f 706f 7320 3d20 6c65  t_token_pos = le
+0000ca30: 6e28 7478 5f70 6174 685f 6465 636f 6465  n(tx_path_decode
+0000ca40: 6429 202d 2033 0a0a 2020 2020 2020 2020  d) - 3..        
+0000ca50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000ca60: 746f 6b65 6e5f 706f 7320 696e 2072 616e  token_pos in ran
+0000ca70: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
+0000ca80: 2020 2020 2020 2020 2020 2020 302c 0a20              0,. 
 0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000caa0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000cab0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000cac0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cae0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000caf0: 6c75 6545 7272 6f72 2866 2243 6f75 6c64  lueError(f"Could
-0000cb00: 206e 6f74 2064 6563 6f64 6520 696e 7075   not decode inpu
-0000cb10: 7420 666f 7220 7b63 6f6d 6d61 6e64 7d22  t for {command}"
-0000cb20: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000cb30: 2020 2020 2020 2074 785f 7061 7468 5f64         tx_path_d
-0000cb40: 6563 6f64 6564 203d 2064 6563 6f64 655f  ecoded = decode_
-0000cb50: 7633 5f70 6174 6828 7478 5f70 6174 6829  v3_path(tx_path)
-0000cb60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000cb70: 2020 2020 2020 2320 416e 2065 7861 6374        # An exact
-0000cb80: 206f 7574 7075 7420 7061 7468 2069 7320   output path is 
-0000cb90: 656e 636f 6465 6420 696e 2052 4556 4552  encoded in REVER
-0000cba0: 5345 206f 7264 6572 2c0a 2020 2020 2020  SE order,.      
-0000cbb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000cbc0: 746f 6b65 6e4f 7574 2069 7320 7468 6520  tokenOut is the 
-0000cbd0: 6669 7273 7420 706f 7369 7469 6f6e 2c20  first position, 
-0000cbe0: 746f 6b65 6e49 6e20 6973 2074 6865 2073  tokenIn is the s
-0000cbf0: 6563 6f6e 640a 2020 2020 2020 2020 2020  econd.          
-0000cc00: 2020 2020 2020 2020 2020 2320 706f 7369            # posi
-0000cc10: 7469 6f6e 2e20 652e 672e 2074 6f6b 656e  tion. e.g. token
-0000cc20: 4f75 742c 2066 6565 2c20 746f 6b65 6e49  Out, fee, tokenI
-0000cc30: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0000cc40: 2020 2020 2020 6c61 7374 5f74 6f6b 656e        last_token
-0000cc50: 5f70 6f73 203d 206c 656e 2874 785f 7061  _pos = len(tx_pa
-0000cc60: 7468 5f64 6563 6f64 6564 2920 2d20 330a  th_decoded) - 3.
-0000cc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cc80: 2020 2020 2066 6f72 2074 6f6b 656e 5f70       for token_p
-0000cc90: 6f73 2069 6e20 7261 6e67 6528 0a20 2020  os in range(.   
-0000cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccb0: 2020 2020 2030 2c0a 2020 2020 2020 2020       0,.        
+0000caa0: 2020 2020 2020 206c 656e 2874 785f 7061         len(tx_pa
+0000cab0: 7468 5f64 6563 6f64 6564 2920 2d20 322c  th_decoded) - 2,
+0000cac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cad0: 2020 2020 2020 2020 2032 2c0a 2020 2020           2,.    
+0000cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000cb00: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
+0000cb10: 6b65 6e5f 6f75 745f 6164 6472 6573 7320  ken_out_address 
+0000cb20: 3d20 7478 5f70 6174 685f 6465 636f 6465  = tx_path_decode
+0000cb30: 645b 746f 6b65 6e5f 706f 735d 0a20 2020  d[token_pos].   
+0000cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb50: 2020 2020 2066 6565 203d 2074 785f 7061       fee = tx_pa
+0000cb60: 7468 5f64 6563 6f64 6564 5b74 6f6b 656e  th_decoded[token
+0000cb70: 5f70 6f73 202b 2031 5d0a 2020 2020 2020  _pos + 1].      
+0000cb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb90: 2020 7478 5f74 6f6b 656e 5f69 6e5f 6164    tx_token_in_ad
+0000cba0: 6472 6573 7320 3d20 7478 5f70 6174 685f  dress = tx_path_
+0000cbb0: 6465 636f 6465 645b 746f 6b65 6e5f 706f  decoded[token_po
+0000cbc0: 7320 2b20 325d 0a0a 2020 2020 2020 2020  s + 2]..        
+0000cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbe0: 6966 2054 5950 455f 4348 4543 4b49 4e47  if TYPE_CHECKING
+0000cbf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cc00: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000cc10: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0000cc20: 7478 5f74 6f6b 656e 5f69 6e5f 6164 6472  tx_token_in_addr
+0000cc30: 6573 732c 2073 7472 290a 2020 2020 2020  ess, str).      
+0000cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc50: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000cc60: 6e73 7461 6e63 6528 7478 5f74 6f6b 656e  nstance(tx_token
+0000cc70: 5f6f 7574 5f61 6464 7265 7373 2c20 7374  _out_address, st
+0000cc80: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+0000cc90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000cca0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000ccb0: 2866 6565 2c20 696e 7429 0a0a 2020 2020  (fee, int)..    
 0000ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccd0: 6c65 6e28 7478 5f70 6174 685f 6465 636f  len(tx_path_deco
-0000cce0: 6465 6429 202d 2032 2c0a 2020 2020 2020  ded) - 2,.      
-0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd00: 2020 322c 0a20 2020 2020 2020 2020 2020    2,.           
-0000cd10: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-0000cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd30: 2020 2020 7478 5f74 6f6b 656e 5f6f 7574      tx_token_out
-0000cd40: 5f61 6464 7265 7373 203d 2074 785f 7061  _address = tx_pa
-0000cd50: 7468 5f64 6563 6f64 6564 5b74 6f6b 656e  th_decoded[token
-0000cd60: 5f70 6f73 5d0a 2020 2020 2020 2020 2020  _pos].          
-0000cd70: 2020 2020 2020 2020 2020 2020 2020 6665                fe
-0000cd80: 6520 3d20 7478 5f70 6174 685f 6465 636f  e = tx_path_deco
-0000cd90: 6465 645b 746f 6b65 6e5f 706f 7320 2b20  ded[token_pos + 
-0000cda0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0000cdb0: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
-0000cdc0: 6b65 6e5f 696e 5f61 6464 7265 7373 203d  ken_in_address =
-0000cdd0: 2074 785f 7061 7468 5f64 6563 6f64 6564   tx_path_decoded
-0000cde0: 5b74 6f6b 656e 5f70 6f73 202b 2032 5d0a  [token_pos + 2].
-0000cdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ce00: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
-0000ce10: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
-0000ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce30: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000ce40: 696e 7374 616e 6365 2874 785f 746f 6b65  instance(tx_toke
-0000ce50: 6e5f 696e 5f61 6464 7265 7373 2c20 7374  n_in_address, st
-0000ce60: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0000ce70: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000ce80: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0000ce90: 2874 785f 746f 6b65 6e5f 6f75 745f 6164  (tx_token_out_ad
-0000cea0: 6472 6573 732c 2073 7472 290a 2020 2020  dress, str).    
-0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cec0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0000ced0: 7369 6e73 7461 6e63 6528 6665 652c 2069  sinstance(fee, i
-0000cee0: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-0000cef0: 2020 2020 2020 2020 2020 2020 2066 6972               fir
-0000cf00: 7374 5f73 7761 7020 3d20 746f 6b65 6e5f  st_swap = token_
-0000cf10: 706f 7320 3d3d 206c 6173 745f 746f 6b65  pos == last_toke
-0000cf20: 6e5f 706f 730a 2020 2020 2020 2020 2020  n_pos.          
-0000cf30: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0000cf40: 7374 5f73 7761 7020 3d20 746f 6b65 6e5f  st_swap = token_
-0000cf50: 706f 7320 3d3d 2030 0a0a 2020 2020 2020  pos == 0..      
-0000cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf70: 2020 6966 2054 5950 455f 4348 4543 4b49    if TYPE_CHECKI
-0000cf80: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
-0000cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfa0: 6173 7365 7274 2073 656c 662e 7633 5f70  assert self.v3_p
-0000cfb0: 6f6f 6c5f 6d61 6e61 6765 7220 6973 206e  ool_manager is n
-0000cfc0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfe0: 7633 5f70 6f6f 6c20 3d20 7365 6c66 2e76  v3_pool = self.v
-0000cff0: 335f 706f 6f6c 5f6d 616e 6167 6572 2e67  3_pool_manager.g
-0000d000: 6574 5f70 6f6f 6c28 0a20 2020 2020 2020  et_pool(.       
-0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d020: 2020 2020 2074 6f6b 656e 5f61 6464 7265       token_addre
-0000d030: 7373 6573 3d28 0a20 2020 2020 2020 2020  sses=(.         
-0000d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d050: 2020 2020 2020 2074 785f 746f 6b65 6e5f         tx_token_
-0000d060: 696e 5f61 6464 7265 7373 2c0a 2020 2020  in_address,.    
-0000d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d080: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
-0000d090: 6f6b 656e 5f6f 7574 5f61 6464 7265 7373  oken_out_address
-0000d0a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d0b0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-0000d0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d0d0: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
-0000d0e0: 6c5f 6665 653d 6665 652c 0a20 2020 2020  l_fee=fee,.     
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d100: 2020 2020 2020 2073 696c 656e 743d 7365         silent=se
-0000d110: 6c66 2e73 696c 656e 742c 0a20 2020 2020  lf.silent,.     
-0000d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d130: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000d140: 2020 2020 2020 2020 2020 2020 2020 5f72                _r
-0000d150: 6563 6970 6965 6e74 203d 2028 0a20 2020  ecipient = (.   
-0000d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d170: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
-0000d180: 7069 656e 7420 6966 206c 6173 745f 7377  pient if last_sw
-0000d190: 6170 2065 6c73 6520 556e 6976 6572 7361  ap else Universa
-0000d1a0: 6c52 6f75 7465 7253 7065 6369 616c 4164  lRouterSpecialAd
-0000d1b0: 6472 6573 732e 524f 5554 4552 0a20 2020  dress.ROUTER.   
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000d1e0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000d1f0: 746f 6b65 6e5f 696e 203d 2028 0a20 2020  token_in = (.   
-0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d210: 2020 2020 2020 2020 2076 335f 706f 6f6c           v3_pool
-0000d220: 2e74 6f6b 656e 300a 2020 2020 2020 2020  .token0.        
-0000d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d240: 2020 2020 6966 2076 335f 706f 6f6c 2e74      if v3_pool.t
-0000d250: 6f6b 656e 3020 3d3d 2074 785f 746f 6b65  oken0 == tx_toke
-0000d260: 6e5f 696e 5f61 6464 7265 7373 0a20 2020  n_in_address.   
-0000d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d280: 2020 2020 2020 2020 2065 6c73 6520 7633           else v3
-0000d290: 5f70 6f6f 6c2e 746f 6b65 6e31 0a20 2020  _pool.token1.   
-0000d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000d2c0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000d2d0: 616d 6f75 6e74 5f6f 7574 203d 2074 785f  amount_out = tx_
-0000d2e0: 616d 6f75 6e74 5f6f 7574 2069 6620 6c61  amount_out if la
-0000d2f0: 7374 5f73 7761 7020 656c 7365 205f 616d  st_swap else _am
-0000d300: 6f75 6e74 5f69 6e0a 2020 2020 2020 2020  ount_in.        
-0000d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d320: 5f61 6d6f 756e 745f 696e 5f6d 6178 203d  _amount_in_max =
-0000d330: 2074 785f 616d 6f75 6e74 5f69 6e5f 6d61   tx_amount_in_ma
-0000d340: 7820 6966 2066 6972 7374 5f73 7761 7020  x if first_swap 
-0000d350: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+0000ccd0: 2020 2020 6669 7273 745f 7377 6170 203d      first_swap =
+0000cce0: 2074 6f6b 656e 5f70 6f73 203d 3d20 6c61   token_pos == la
+0000ccf0: 7374 5f74 6f6b 656e 5f70 6f73 0a20 2020  st_token_pos.   
+0000cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd10: 2020 2020 206c 6173 745f 7377 6170 203d       last_swap =
+0000cd20: 2074 6f6b 656e 5f70 6f73 203d 3d20 300a   token_pos == 0.
+0000cd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd40: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
+0000cd50: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
+0000cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd70: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+0000cd80: 6c66 2e76 335f 706f 6f6c 5f6d 616e 6167  lf.v3_pool_manag
+0000cd90: 6572 2069 7320 6e6f 7420 4e6f 6e65 0a20  er is not None. 
+0000cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdb0: 2020 2020 2020 2076 335f 706f 6f6c 203d         v3_pool =
+0000cdc0: 2073 656c 662e 7633 5f70 6f6f 6c5f 6d61   self.v3_pool_ma
+0000cdd0: 6e61 6765 722e 6765 745f 706f 6f6c 280a  nager.get_pool(.
+0000cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdf0: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
+0000ce00: 6e5f 6164 6472 6573 7365 733d 280a 2020  n_addresses=(.  
+0000ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce20: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+0000ce30: 5f74 6f6b 656e 5f69 6e5f 6164 6472 6573  _token_in_addres
+0000ce40: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce60: 2020 2074 785f 746f 6b65 6e5f 6f75 745f     tx_token_out_
+0000ce70: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+0000ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce90: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ceb0: 2020 2020 706f 6f6c 5f66 6565 3d66 6565      pool_fee=fee
+0000cec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ced0: 2020 2020 2020 2020 2020 2020 2020 7369                si
+0000cee0: 6c65 6e74 3d73 656c 662e 7369 6c65 6e74  lent=self.silent
+0000cef0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000cf00: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf20: 2020 2020 205f 7265 6369 7069 656e 7420       _recipient 
+0000cf30: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf50: 7478 5f72 6563 6970 6965 6e74 2069 6620  tx_recipient if 
+0000cf60: 6c61 7374 5f73 7761 7020 656c 7365 2055  last_swap else U
+0000cf70: 6e69 7665 7273 616c 526f 7574 6572 5370  niversalRouterSp
+0000cf80: 6563 6961 6c41 6464 7265 7373 2e52 4f55  ecialAddress.ROU
+0000cf90: 5445 520a 2020 2020 2020 2020 2020 2020  TER.            
+0000cfa0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfc0: 2020 2020 2020 5f74 6f6b 656e 5f69 6e20        _token_in 
+0000cfd0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cff0: 7633 5f70 6f6f 6c2e 746f 6b65 6e30 0a20  v3_pool.token0. 
+0000d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d010: 2020 2020 2020 2020 2020 2069 6620 7633             if v3
+0000d020: 5f70 6f6f 6c2e 746f 6b65 6e30 203d 3d20  _pool.token0 == 
+0000d030: 7478 5f74 6f6b 656e 5f69 6e5f 6164 6472  tx_token_in_addr
+0000d040: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+0000d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d060: 656c 7365 2076 335f 706f 6f6c 2e74 6f6b  else v3_pool.tok
+0000d070: 656e 310a 2020 2020 2020 2020 2020 2020  en1.            
+0000d080: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0a0: 2020 2020 2020 5f61 6d6f 756e 745f 6f75        _amount_ou
+0000d0b0: 7420 3d20 7478 5f61 6d6f 756e 745f 6f75  t = tx_amount_ou
+0000d0c0: 7420 6966 206c 6173 745f 7377 6170 2065  t if last_swap e
+0000d0d0: 6c73 6520 5f61 6d6f 756e 745f 696e 0a20  lse _amount_in. 
+0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0f0: 2020 2020 2020 205f 616d 6f75 6e74 5f69         _amount_i
+0000d100: 6e5f 6d61 7820 3d20 7478 5f61 6d6f 756e  n_max = tx_amoun
+0000d110: 745f 696e 5f6d 6178 2069 6620 6669 7273  t_in_max if firs
+0000d120: 745f 7377 6170 2065 6c73 6520 4e6f 6e65  t_swap else None
+0000d130: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d140: 2020 2020 2020 2020 2020 5f2c 2076 335f            _, v3_
+0000d150: 7369 6d5f 7265 7375 6c74 203d 2073 656c  sim_result = sel
+0000d160: 662e 5f73 696d 756c 6174 655f 7633 5f73  f._simulate_v3_s
+0000d170: 7761 705f 6578 6163 745f 6f75 7428 0a20  wap_exact_out(. 
+0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d190: 2020 2020 2020 2020 2020 2070 6f6f 6c3d             pool=
+0000d1a0: 7633 5f70 6f6f 6c2c 0a20 2020 2020 2020  v3_pool,.       
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1c0: 2020 2020 2072 6563 6970 6965 6e74 3d5f       recipient=_
+0000d1d0: 7265 6369 7069 656e 742c 0a20 2020 2020  recipient,.     
+0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1f0: 2020 2020 2020 2074 6f6b 656e 5f69 6e3d         token_in=
+0000d200: 5f74 6f6b 656e 5f69 6e2c 0a20 2020 2020  _token_in,.     
+0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d220: 2020 2020 2020 2061 6d6f 756e 745f 6f75         amount_ou
+0000d230: 743d 5f61 6d6f 756e 745f 6f75 742c 0a20  t=_amount_out,. 
+0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d250: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
+0000d260: 745f 696e 5f6d 6178 3d5f 616d 6f75 6e74  t_in_max=_amount
+0000d270: 5f69 6e5f 6d61 782c 0a20 2020 2020 2020  _in_max,.       
+0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d290: 2020 2020 2066 6972 7374 5f73 7761 703d       first_swap=
+0000d2a0: 6669 7273 745f 7377 6170 2c0a 2020 2020  first_swap,.    
+0000d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2c0: 2020 2020 2020 2020 6c61 7374 5f73 7761          last_swa
+0000d2d0: 703d 6c61 7374 5f73 7761 702c 0a20 2020  p=last_swap,.   
+0000d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d310: 5f61 6d6f 756e 745f 696e 203d 206d 6178  _amount_in = max
+0000d320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000d330: 2020 2020 2020 2020 2020 2020 2020 7633                v3
+0000d340: 5f73 696d 5f72 6573 756c 742e 616d 6f75  _sim_result.amou
+0000d350: 6e74 305f 6465 6c74 612c 0a20 2020 2020  nt0_delta,.     
 0000d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d370: 2020 205f 2c20 7633 5f73 696d 5f72 6573     _, v3_sim_res
-0000d380: 756c 7420 3d20 7365 6c66 2e5f 7369 6d75  ult = self._simu
-0000d390: 6c61 7465 5f76 335f 7377 6170 5f65 7861  late_v3_swap_exa
-0000d3a0: 6374 5f6f 7574 280a 2020 2020 2020 2020  ct_out(.        
+0000d370: 2020 2020 2020 2076 335f 7369 6d5f 7265         v3_sim_re
+0000d380: 7375 6c74 2e61 6d6f 756e 7431 5f64 656c  sult.amount1_del
+0000d390: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+0000d3a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
 0000d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3c0: 2020 2020 706f 6f6c 3d76 335f 706f 6f6c      pool=v3_pool
-0000d3d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d3e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000d3f0: 6369 7069 656e 743d 5f72 6563 6970 6965  cipient=_recipie
-0000d400: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0000d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d420: 746f 6b65 6e5f 696e 3d5f 746f 6b65 6e5f  token_in=_token_
-0000d430: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-0000d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d450: 616d 6f75 6e74 5f6f 7574 3d5f 616d 6f75  amount_out=_amou
-0000d460: 6e74 5f6f 7574 2c0a 2020 2020 2020 2020  nt_out,.        
-0000d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d480: 2020 2020 616d 6f75 6e74 5f69 6e5f 6d61      amount_in_ma
-0000d490: 783d 5f61 6d6f 756e 745f 696e 5f6d 6178  x=_amount_in_max
-0000d4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d4b0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000d4c0: 7273 745f 7377 6170 3d66 6972 7374 5f73  rst_swap=first_s
-0000d4d0: 7761 702c 0a20 2020 2020 2020 2020 2020  wap,.           
-0000d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4f0: 206c 6173 745f 7377 6170 3d6c 6173 745f   last_swap=last_
-0000d500: 7377 6170 2c0a 2020 2020 2020 2020 2020  swap,.          
-0000d510: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000d520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d530: 2020 2020 2020 2020 205f 616d 6f75 6e74           _amount
-0000d540: 5f69 6e20 3d20 6d61 7828 0a20 2020 2020  _in = max(.     
+0000d3c0: 2020 2020 2020 2023 2063 6865 636b 2074         # check t
+0000d3d0: 6861 7420 7468 6520 6f75 7470 7574 206f  hat the output o
+0000d3e0: 6620 6561 6368 2069 6e74 6572 6d65 6469  f each intermedi
+0000d3f0: 6174 6520 7377 6170 206d 6565 7473 0a20  ate swap meets. 
+0000d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d410: 2020 2020 2020 2023 2074 6865 2069 6e70         # the inp
+0000d420: 7574 2066 6f72 2074 6865 206e 6578 7420  ut for the next 
+0000d430: 7377 6170 0a20 2020 2020 2020 2020 2020  swap.           
+0000d440: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000d450: 6e6f 7420 6c61 7374 5f73 7761 703a 0a20  not last_swap:. 
+0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d470: 2020 2020 2020 2020 2020 2023 2070 6f6f             # poo
+0000d480: 6c20 7374 6174 6573 2061 7265 2061 7070  l states are app
+0000d490: 656e 6465 6420 746f 2060 6675 7475 7265  ended to `future
+0000d4a0: 5f70 6f6f 6c5f 7374 6174 6573 600a 2020  _pool_states`.  
+0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4c0: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
+0000d4d0: 6865 2070 7265 7669 6f75 7320 7377 6170  he previous swap
+0000d4e0: 2077 696c 6c20 6265 2069 6e20 7468 6520   will be in the 
+0000d4f0: 6c61 7374 2070 6f73 6974 696f 6e0a 2020  last position.  
+0000d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d510: 2020 2020 2020 2020 2020 5f2c 205f 6c61            _, _la
+0000d520: 7374 5f73 696d 5f72 6573 756c 7420 3d20  st_sim_result = 
+0000d530: 7365 6c66 2e73 696d 756c 6174 6564 5f70  self.simulated_p
+0000d540: 6f6f 6c5f 7374 6174 6573 5b2d 315d 0a0a  ool_states[-1]..
 0000d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d560: 2020 2020 2020 2076 335f 7369 6d5f 7265         v3_sim_re
-0000d570: 7375 6c74 2e61 6d6f 756e 7430 5f64 656c  sult.amount0_del
-0000d580: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-0000d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5a0: 7633 5f73 696d 5f72 6573 756c 742e 616d  v3_sim_result.am
-0000d5b0: 6f75 6e74 315f 6465 6c74 612c 0a20 2020  ount1_delta,.   
+0000d560: 2020 2020 2020 2020 2020 2020 6966 2054              if T
+0000d570: 5950 455f 4348 4543 4b49 4e47 3a0a 2020  YPE_CHECKING:.  
+0000d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d590: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000d5a0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0000d5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5f0: 2320 6368 6563 6b20 7468 6174 2074 6865  # check that the
-0000d600: 206f 7574 7075 7420 6f66 2065 6163 6820   output of each 
-0000d610: 696e 7465 726d 6564 6961 7465 2073 7761  intermediate swa
-0000d620: 7020 6d65 6574 730a 2020 2020 2020 2020  p meets.        
-0000d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d640: 2320 7468 6520 696e 7075 7420 666f 7220  # the input for 
-0000d650: 7468 6520 6e65 7874 2073 7761 700a 2020  the next swap.  
-0000d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d670: 2020 2020 2020 6966 206e 6f74 206c 6173        if not las
-0000d680: 745f 7377 6170 3a0a 2020 2020 2020 2020  t_swap:.        
-0000d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6a0: 2020 2020 2320 706f 6f6c 2073 7461 7465      # pool state
-0000d6b0: 7320 6172 6520 6170 7065 6e64 6564 2074  s are appended t
-0000d6c0: 6f20 6066 7574 7572 655f 706f 6f6c 5f73  o `future_pool_s
-0000d6d0: 7461 7465 7360 0a20 2020 2020 2020 2020  tates`.         
-0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6f0: 2020 2023 2073 6f20 7468 6520 7072 6576     # so the prev
-0000d700: 696f 7573 2073 7761 7020 7769 6c6c 2062  ious swap will b
-0000d710: 6520 696e 2074 6865 206c 6173 7420 706f  e in the last po
-0000d720: 7369 7469 6f6e 0a20 2020 2020 2020 2020  sition.         
-0000d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d740: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d760: 2020 2020 205f 2c0a 2020 2020 2020 2020       _,.        
-0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d780: 2020 2020 2020 2020 5f6c 6173 745f 7369          _last_si
-0000d790: 6d5f 7265 7375 6c74 2c0a 2020 2020 2020  m_result,.      
-0000d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7b0: 2020 2020 2020 2920 3d20 5f75 6e69 7665        ) = _unive
-0000d7c0: 7273 616c 5f72 6f75 7465 725f 636f 6d6d  rsal_router_comm
-0000d7d0: 616e 645f 6675 7475 7265 5f70 6f6f 6c5f  and_future_pool_
-0000d7e0: 7374 6174 6573 5b2d 315d 0a0a 2020 2020  states[-1]..    
-0000d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d800: 2020 2020 2020 2020 6966 2054 5950 455f          if TYPE_
-0000d810: 4348 4543 4b49 4e47 3a0a 2020 2020 2020  CHECKING:.      
-0000d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d830: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000d840: 2069 7369 6e73 7461 6e63 6528 0a20 2020   isinstance(.   
+0000d5d0: 2020 2020 205f 6c61 7374 5f73 696d 5f72       _last_sim_r
+0000d5e0: 6573 756c 742c 0a20 2020 2020 2020 2020  esult,.         
+0000d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d600: 2020 2020 2020 2020 2020 2028 556e 6973             (Unis
+0000d610: 7761 7056 3250 6f6f 6c53 696d 756c 6174  wapV2PoolSimulat
+0000d620: 696f 6e52 6573 756c 742c 2055 6e69 7377  ionResult, Unisw
+0000d630: 6170 5632 506f 6f6c 5369 6d75 6c61 7469  apV2PoolSimulati
+0000d640: 6f6e 5265 7375 6c74 292c 0a20 2020 2020  onResult),.     
+0000d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d660: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d680: 2020 2020 2020 2020 2020 5f6c 6173 745f            _last_
+0000d690: 616d 6f75 6e74 5f69 6e20 3d20 6d61 7828  amount_in = max(
+0000d6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6c0: 205f 6c61 7374 5f73 696d 5f72 6573 756c   _last_sim_resul
+0000d6d0: 742e 616d 6f75 6e74 315f 6465 6c74 612c  t.amount1_delta,
+0000d6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d700: 205f 6c61 7374 5f73 696d 5f72 6573 756c   _last_sim_resul
+0000d710: 742e 616d 6f75 6e74 305f 6465 6c74 612c  t.amount0_delta,
+0000d720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d730: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0000d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d750: 2020 2020 2020 2020 2020 2020 6966 205f              if _
+0000d760: 616d 6f75 6e74 5f6f 7574 2021 3d20 5f6c  amount_out != _l
+0000d770: 6173 745f 616d 6f75 6e74 5f69 6e3a 0a20  ast_amount_in:. 
+0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d790: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000d7a0: 6169 7365 2054 7261 6e73 6163 7469 6f6e  aise Transaction
+0000d7b0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7d0: 2020 2020 2020 2020 2020 2066 2249 6e73             f"Ins
+0000d7e0: 7566 6669 6369 656e 7420 7377 6170 2061  ufficient swap a
+0000d7f0: 6d6f 756e 7420 7468 726f 7567 6820 7265  mount through re
+0000d800: 7175 6573 7465 6420 706f 6f6c 207b 7633  quested pool {v3
+0000d810: 5f70 6f6f 6c7d 2e20 4e65 6564 6564 207b  _pool}. Needed {
+0000d820: 5f6c 6173 745f 616d 6f75 6e74 5f69 6e7d  _last_amount_in}
+0000d830: 2c20 7265 6365 6976 6564 207b 5f61 6d6f  , received {_amo
+0000d840: 756e 745f 6f75 747d 220a 2020 2020 2020  unt_out}".      
 0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d870: 205f 6c61 7374 5f73 696d 5f72 6573 756c   _last_sim_resul
-0000d880: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0000d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8a0: 2020 2020 2020 2028 556e 6973 7761 7056         (UniswapV
-0000d8b0: 3250 6f6f 6c53 696d 756c 6174 696f 6e52  2PoolSimulationR
-0000d8c0: 6573 756c 742c 2055 6e69 7377 6170 5632  esult, UniswapV2
-0000d8d0: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
-0000d8e0: 7375 6c74 292c 0a20 2020 2020 2020 2020  sult),.         
-0000d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d900: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d920: 2020 2020 2020 5f6c 6173 745f 616d 6f75        _last_amou
-0000d930: 6e74 5f69 6e20 3d20 6d61 7828 0a20 2020  nt_in = max(.   
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 2020 2020 2020 2020 2020 2020 205f 6c61               _la
-0000d960: 7374 5f73 696d 5f72 6573 756c 742e 616d  st_sim_result.am
-0000d970: 6f75 6e74 315f 6465 6c74 612c 0a20 2020  ount1_delta,.   
-0000d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d990: 2020 2020 2020 2020 2020 2020 205f 6c61               _la
-0000d9a0: 7374 5f73 696d 5f72 6573 756c 742e 616d  st_sim_result.am
-0000d9b0: 6f75 6e74 305f 6465 6c74 612c 0a20 2020  ount0_delta,.   
-0000d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9f0: 2020 2020 2020 2020 6966 205f 616d 6f75          if _amou
-0000da00: 6e74 5f6f 7574 2021 3d20 5f6c 6173 745f  nt_out != _last_
-0000da10: 616d 6f75 6e74 5f69 6e3a 0a20 2020 2020  amount_in:.     
-0000da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000da40: 2054 7261 6e73 6163 7469 6f6e 4572 726f   TransactionErro
-0000da50: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da70: 2020 2020 2020 2066 2249 6e73 7566 6669         f"Insuffi
-0000da80: 6369 656e 7420 7377 6170 2061 6d6f 756e  cient swap amoun
-0000da90: 7420 7468 726f 7567 6820 7265 7175 6573  t through reques
-0000daa0: 7465 6420 706f 6f6c 207b 7633 5f70 6f6f  ted pool {v3_poo
-0000dab0: 6c7d 2e20 4e65 6564 6564 207b 5f6c 6173  l}. Needed {_las
-0000dac0: 745f 616d 6f75 6e74 5f69 6e7d 2c20 7265  t_amount_in}, re
-0000dad0: 6365 6976 6564 207b 5f61 6d6f 756e 745f  ceived {_amount_
-0000dae0: 6f75 747d 220a 2020 2020 2020 2020 2020  out}".          
-0000daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db00: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db20: 205f 756e 6976 6572 7361 6c5f 726f 7574   _universal_rout
-0000db30: 6572 5f63 6f6d 6d61 6e64 5f66 7574 7572  er_command_futur
-0000db40: 655f 706f 6f6c 5f73 7461 7465 732e 6170  e_pool_states.ap
-0000db50: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-0000db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db70: 2020 2876 335f 706f 6f6c 2c20 7633 5f73    (v3_pool, v3_s
-0000db80: 696d 5f72 6573 756c 7429 0a20 2020 2020  im_result).     
-0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dba0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000dbb0: 2020 2020 2020 6361 7365 204e 6f6e 653a        case None:
-0000dbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dbd0: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
-0000dbe0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0000dbf0: 5f3a 0a20 2020 2020 2020 2020 2020 2020  _:.             
-0000dc00: 2020 2020 2020 2069 6620 636f 6d6d 616e         if comman
-0000dc10: 6420 696e 2055 4e49 4d50 4c45 4d45 4e54  d in UNIMPLEMENT
-0000dc20: 4544 5f55 4e49 5645 5241 4c5f 524f 5554  ED_UNIVERAL_ROUT
-0000dc30: 4552 5f43 4f4d 4d41 4e44 533a 0a20 2020  ER_COMMANDS:.   
-0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc50: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-0000dc60: 6728 6622 554e 494d 504c 454d 454e 5445  g(f"UNIMPLEMENTE
-0000dc70: 4420 434f 4d4d 414e 443a 207b 636f 6d6d  D COMMAND: {comm
-0000dc80: 616e 647d 2229 0a20 2020 2020 2020 2020  and}").         
-0000dc90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000dca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dcb0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0000dcc0: 616c 7565 4572 726f 7228 6622 496e 7661  alueError(f"Inva
-0000dcd0: 6c69 6420 636f 6d6d 616e 6420 7b63 6f6d  lid command {com
-0000dce0: 6d61 6e64 7d22 290a 0a20 2020 2020 2020  mand}")..       
-0000dcf0: 2020 2020 2072 6574 7572 6e20 5f75 6e69       return _uni
-0000dd00: 7665 7273 616c 5f72 6f75 7465 725f 636f  versal_router_co
-0000dd10: 6d6d 616e 645f 6675 7475 7265 5f70 6f6f  mmand_future_poo
-0000dd20: 6c5f 7374 6174 6573 0a0a 2020 2020 2020  l_states..      
-0000dd30: 2020 6465 6620 5f70 726f 6365 7373 5f76    def _process_v
-0000dd40: 335f 6d75 6c74 6963 616c 6c28 0a20 2020  3_multicall(.   
-0000dd50: 2020 2020 2020 2020 2070 6172 616d 733a           params:
-0000dd60: 2044 6963 745b 7374 722c 2041 6e79 5d2c   Dict[str, Any],
-0000dd70: 0a20 2020 2020 2020 2029 202d 3e20 4c69  .        ) -> Li
-0000dd80: 7374 5b0a 2020 2020 2020 2020 2020 2020  st[.            
-0000dd90: 5475 706c 655b 4c69 7175 6964 6974 7950  Tuple[LiquidityP
-0000dda0: 6f6f 6c2c 2055 6e69 7377 6170 5632 506f  ool, UniswapV2Po
-0000ddb0: 6f6c 5369 6d75 6c61 7469 6f6e 5265 7375  olSimulationResu
-0000ddc0: 6c74 5d0a 2020 2020 2020 2020 2020 2020  lt].            
-0000ddd0: 7c20 5475 706c 655b 5633 4c69 7175 6964  | Tuple[V3Liquid
-0000dde0: 6974 7950 6f6f 6c2c 2055 6e69 7377 6170  ityPool, Uniswap
-0000ddf0: 5633 506f 6f6c 5369 6d75 6c61 7469 6f6e  V3PoolSimulation
-0000de00: 5265 7375 6c74 5d0a 2020 2020 2020 2020  Result].        
-0000de10: 5d3a 0a20 2020 2020 2020 2020 2020 205f  ]:.            _
-0000de20: 7633 5f6d 756c 7469 6361 6c6c 5f66 7574  v3_multicall_fut
-0000de30: 7572 655f 706f 6f6c 5f73 7461 7465 733a  ure_pool_states:
-0000de40: 204c 6973 745b 0a20 2020 2020 2020 2020   List[.         
-0000de50: 2020 2020 2020 2054 7570 6c65 5b4c 6971         Tuple[Liq
-0000de60: 7569 6469 7479 506f 6f6c 2c20 556e 6973  uidityPool, Unis
-0000de70: 7761 7056 3250 6f6f 6c53 696d 756c 6174  wapV2PoolSimulat
-0000de80: 696f 6e52 6573 756c 745d 0a20 2020 2020  ionResult].     
-0000de90: 2020 2020 2020 2020 2020 207c 2054 7570             | Tup
-0000dea0: 6c65 5b56 334c 6971 7569 6469 7479 506f  le[V3LiquidityPo
-0000deb0: 6f6c 2c20 556e 6973 7761 7056 3350 6f6f  ol, UniswapV3Poo
-0000dec0: 6c53 696d 756c 6174 696f 6e52 6573 756c  lSimulationResul
-0000ded0: 745d 0a20 2020 2020 2020 2020 2020 205d  t].            ]
-0000dee0: 203d 205b 5d0a 0a20 2020 2020 2020 2020   = []..         
-0000def0: 2020 2066 6f72 2070 6179 6c6f 6164 2069     for payload i
-0000df00: 6e20 7061 7261 6d73 5b22 6461 7461 225d  n params["data"]
-0000df10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000df20: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000df30: 2020 2020 2020 2020 2020 2023 2064 6563             # dec
-0000df40: 6f64 6520 7769 7468 2052 6f75 7465 7220  ode with Router 
-0000df50: 4142 490a 2020 2020 2020 2020 2020 2020  ABI.            
-0000df60: 2020 2020 2020 2020 7061 796c 6f61 645f          payload_
-0000df70: 6675 6e63 2c20 7061 796c 6f61 645f 6172  func, payload_ar
-0000df80: 6773 203d 2028 0a20 2020 2020 2020 2020  gs = (.         
-0000df90: 2020 2020 2020 2020 2020 2020 2020 2057                 W
-0000dfa0: 6562 3328 290a 2020 2020 2020 2020 2020  eb3().          
-0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
-0000dfc0: 7468 2e63 6f6e 7472 6163 7428 6162 693d  th.contract(abi=
-0000dfd0: 554e 4953 5741 505f 5633 5f52 4f55 5445  UNISWAP_V3_ROUTE
-0000dfe0: 525f 4142 4929 0a20 2020 2020 2020 2020  R_ABI).         
-0000dff0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-0000e000: 6465 636f 6465 5f66 756e 6374 696f 6e5f  decode_function_
-0000e010: 696e 7075 7428 7061 796c 6f61 6429 0a20  input(payload). 
-0000e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e030: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000e040: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000e050: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-0000e060: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-0000e070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e080: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000e090: 2020 2020 2020 2020 2020 2320 6465 636f            # deco
-0000e0a0: 6465 2077 6974 6820 526f 7574 6572 3220  de with Router2 
-0000e0b0: 4142 490a 2020 2020 2020 2020 2020 2020  ABI.            
-0000e0c0: 2020 2020 2020 2020 7061 796c 6f61 645f          payload_
-0000e0d0: 6675 6e63 2c20 7061 796c 6f61 645f 6172  func, payload_ar
-0000e0e0: 6773 203d 2028 0a20 2020 2020 2020 2020  gs = (.         
-0000e0f0: 2020 2020 2020 2020 2020 2020 2020 2057                 W
-0000e100: 6562 3328 290a 2020 2020 2020 2020 2020  eb3().          
-0000e110: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
-0000e120: 7468 2e63 6f6e 7472 6163 7428 6162 693d  th.contract(abi=
-0000e130: 554e 4953 5741 505f 5633 5f52 4f55 5445  UNISWAP_V3_ROUTE
-0000e140: 5232 5f41 4249 290a 2020 2020 2020 2020  R2_ABI).        
-0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e160: 2e64 6563 6f64 655f 6675 6e63 7469 6f6e  .decode_function
-0000e170: 5f69 6e70 7574 2870 6179 6c6f 6164 290a  _input(payload).
-0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e190: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000e1a0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000e1b0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000e1c0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000e1d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000e1e0: 2020 2320 7370 6563 6961 6c20 6361 7365    # special case
-0000e1f0: 2074 6f20 6861 6e64 6c65 2061 206d 756c   to handle a mul
-0000e200: 7469 6361 6c6c 2065 6e63 6f64 6564 2077  ticall encoded w
-0000e210: 6974 6869 6e0a 2020 2020 2020 2020 2020  ithin.          
-0000e220: 2020 2020 2020 2320 616e 6f74 6865 7220        # another 
-0000e230: 6d75 6c74 6963 616c 6c0a 2020 2020 2020  multicall.      
-0000e240: 2020 2020 2020 2020 2020 6966 2070 6179            if pay
-0000e250: 6c6f 6164 5f66 756e 632e 666e 5f6e 616d  load_func.fn_nam
-0000e260: 6520 3d3d 2022 6d75 6c74 6963 616c 6c22  e == "multicall"
-0000e270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e280: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0000e290: 7567 2822 556e 7772 6170 7069 6e67 206e  ug("Unwrapping n
-0000e2a0: 6573 7465 6420 6d75 6c74 6963 616c 6c22  ested multicall"
-0000e2b0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000e2c0: 2020 2020 2020 2066 6f72 2070 6179 6c6f         for paylo
-0000e2d0: 6164 2069 6e20 7061 796c 6f61 645f 6172  ad in payload_ar
-0000e2e0: 6773 5b22 6461 7461 225d 3a0a 2020 2020  gs["data"]:.    
-0000e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e300: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000d860: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d880: 2020 2020 2073 656c 662e 7369 6d75 6c61       self.simula
+0000d890: 7465 645f 706f 6f6c 5f73 7461 7465 732e  ted_pool_states.
+0000d8a0: 6170 7065 6e64 2828 7633 5f70 6f6f 6c2c  append((v3_pool,
+0000d8b0: 2076 335f 7369 6d5f 7265 7375 6c74 2929   v3_sim_result))
+0000d8c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d8d0: 2020 6361 7365 205f 3a0a 2020 2020 2020    case _:.      
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000d8f0: 2063 6f6d 6d61 6e64 2069 6e20 554e 494d   command in UNIM
+0000d900: 504c 454d 454e 5445 445f 554e 4956 4552  PLEMENTED_UNIVER
+0000d910: 414c 5f52 4f55 5445 525f 434f 4d4d 414e  AL_ROUTER_COMMAN
+0000d920: 4453 3a0a 2020 2020 2020 2020 2020 2020  DS:.            
+0000d930: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000d940: 6572 2e64 6562 7567 2866 2255 4e49 4d50  er.debug(f"UNIMP
+0000d950: 4c45 4d45 4e54 4544 2043 4f4d 4d41 4e44  LEMENTED COMMAND
+0000d960: 3a20 7b63 6f6d 6d61 6e64 7d22 290a 2020  : {command}").  
+0000d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d980: 2020 656c 7365 3a20 2023 2070 7261 676d    else:  # pragm
+0000d990: 613a 206e 6f20 636f 7665 720a 2020 2020  a: no cover.    
+0000d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9b0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0000d9c0: 7272 6f72 2866 2249 6e76 616c 6964 2063  rror(f"Invalid c
+0000d9d0: 6f6d 6d61 6e64 207b 636f 6d6d 616e 647d  ommand {command}
+0000d9e0: 2229 0a0a 2020 2020 2020 2020 6465 6620  ")..        def 
+0000d9f0: 5f70 726f 6365 7373 5f76 335f 6d75 6c74  _process_v3_mult
+0000da00: 6963 616c 6c28 0a20 2020 2020 2020 2020  icall(.         
+0000da10: 2020 2070 6172 616d 733a 2044 6963 745b     params: Dict[
+0000da20: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
+0000da30: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+0000da40: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0000da50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000da60: 656c 662e 5f72 6169 7365 5f69 665f 626c  elf._raise_if_bl
+0000da70: 6f63 6b5f 6861 7368 5f6d 6973 6d61 7463  ock_hash_mismatc
+0000da80: 6828 7061 7261 6d73 5b22 7072 6576 696f  h(params["previo
+0000da90: 7573 426c 6f63 6b68 6173 6822 5d29 0a20  usBlockhash"]). 
+0000daa0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0000dab0: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+0000dac0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000dad0: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0000dae0: 7220 7061 796c 6f61 6420 696e 2070 6172  r payload in par
+0000daf0: 616d 735b 2264 6174 6122 5d3a 0a20 2020  ams["data"]:.   
+0000db00: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000db10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000db20: 2020 2020 2020 2320 6465 636f 6465 2077        # decode w
+0000db30: 6974 6820 526f 7574 6572 2041 4249 0a20  ith Router ABI. 
+0000db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db50: 2020 2070 6179 6c6f 6164 5f66 756e 632c     payload_func,
+0000db60: 2070 6179 6c6f 6164 5f61 7267 7320 3d20   payload_args = 
+0000db70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000db80: 2020 2020 2020 2020 2020 5765 6233 2829            Web3()
+0000db90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dba0: 2020 2020 2020 2020 202e 6574 682e 636f           .eth.co
+0000dbb0: 6e74 7261 6374 2861 6269 3d55 4e49 5357  ntract(abi=UNISW
+0000dbc0: 4150 5f56 335f 524f 5554 4552 5f41 4249  AP_V3_ROUTER_ABI
+0000dbd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000dbe0: 2020 2020 2020 2020 2020 2e64 6563 6f64            .decod
+0000dbf0: 655f 6675 6e63 7469 6f6e 5f69 6e70 7574  e_function_input
+0000dc00: 2870 6179 6c6f 6164 290a 2020 2020 2020  (payload).      
+0000dc10: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc30: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0000dc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000dc50: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+0000dc60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000dc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc80: 2020 2020 2023 2064 6563 6f64 6520 7769       # decode wi
+0000dc90: 7468 2052 6f75 7465 7232 2041 4249 0a20  th Router2 ABI. 
+0000dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dcb0: 2020 2070 6179 6c6f 6164 5f66 756e 632c     payload_func,
+0000dcc0: 2070 6179 6c6f 6164 5f61 7267 7320 3d20   payload_args = 
+0000dcd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000dce0: 2020 2020 2020 2020 2020 5765 6233 2829            Web3()
+0000dcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd00: 2020 2020 2020 2020 202e 6574 682e 636f           .eth.co
+0000dd10: 6e74 7261 6374 2861 6269 3d55 4e49 5357  ntract(abi=UNISW
+0000dd20: 4150 5f56 335f 524f 5554 4552 325f 4142  AP_V3_ROUTER2_AB
+0000dd30: 4929 0a20 2020 2020 2020 2020 2020 2020  I).             
+0000dd40: 2020 2020 2020 2020 2020 202e 6465 636f             .deco
+0000dd50: 6465 5f66 756e 6374 696f 6e5f 696e 7075  de_function_inpu
+0000dd60: 7428 7061 796c 6f61 6429 0a20 2020 2020  t(payload).     
+0000dd70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000dd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd90: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000dda0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0000ddb0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000ddc0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0000ddd0: 7065 6369 616c 2063 6173 6520 746f 2068  pecial case to h
+0000dde0: 616e 646c 6520 6120 6d75 6c74 6963 616c  andle a multical
+0000ddf0: 6c20 656e 636f 6465 6420 7769 7468 696e  l encoded within
+0000de00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000de10: 2023 2061 6e6f 7468 6572 206d 756c 7469   # another multi
+0000de20: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
+0000de30: 2020 2020 2069 6620 7061 796c 6f61 645f       if payload_
+0000de40: 6675 6e63 2e66 6e5f 6e61 6d65 203d 3d20  func.fn_name == 
+0000de50: 226d 756c 7469 6361 6c6c 223a 0a20 2020  "multicall":.   
+0000de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de70: 206c 6f67 6765 722e 6465 6275 6728 2255   logger.debug("U
+0000de80: 6e77 7261 7070 696e 6720 6e65 7374 6564  nwrapping nested
+0000de90: 206d 756c 7469 6361 6c6c 2229 0a0a 2020   multicall")..  
+0000dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000deb0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000dec0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000ded0: 656c 662e 5f72 6169 7365 5f69 665f 626c  elf._raise_if_bl
+0000dee0: 6f63 6b5f 6861 7368 5f6d 6973 6d61 7463  ock_hash_mismatc
+0000def0: 6828 7061 7261 6d73 5b22 7072 6576 696f  h(params["previo
+0000df00: 7573 426c 6f63 6b68 6173 6822 5d29 0a20  usBlockhash"]). 
+0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df20: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+0000df30: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000df40: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000df50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000df60: 2020 2020 2020 666f 7220 7061 796c 6f61        for payloa
+0000df70: 6420 696e 2070 6179 6c6f 6164 5f61 7267  d in payload_arg
+0000df80: 735b 2264 6174 6122 5d3a 0a20 2020 2020  s["data"]:.     
+0000df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfa0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfc0: 2020 2020 5f66 756e 632c 205f 7061 7261      _func, _para
+0000dfd0: 6d73 203d 2028 0a20 2020 2020 2020 2020  ms = (.         
+0000dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dff0: 2020 2020 2020 2057 6562 3328 290a 2020         Web3().  
+0000e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e010: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
+0000e020: 7468 2e63 6f6e 7472 6163 7428 6162 693d  th.contract(abi=
+0000e030: 554e 4953 5741 505f 5633 5f52 4f55 5445  UNISWAP_V3_ROUTE
+0000e040: 525f 4142 4929 0a20 2020 2020 2020 2020  R_ABI).         
+0000e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e060: 2020 2020 2020 202e 6465 636f 6465 5f66         .decode_f
+0000e070: 756e 6374 696f 6e5f 696e 7075 7428 7061  unction_input(pa
+0000e080: 796c 6f61 6429 0a20 2020 2020 2020 2020  yload).         
+0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0a0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000e0b0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000e0c0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+0000e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0e0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0000e0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e100: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e120: 2020 2020 2020 2020 2020 5f66 756e 632c            _func,
+0000e130: 205f 7061 7261 6d73 203d 2028 0a20 2020   _params = (.   
+0000e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e150: 2020 2020 2020 2020 2020 2020 2057 6562               Web
+0000e160: 3328 290a 2020 2020 2020 2020 2020 2020  3().            
+0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e180: 2020 2020 2e65 7468 2e63 6f6e 7472 6163      .eth.contrac
+0000e190: 7428 6162 693d 554e 4953 5741 505f 5633  t(abi=UNISWAP_V3
+0000e1a0: 5f52 4f55 5445 5232 5f41 4249 290a 2020  _ROUTER2_ABI).  
+0000e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1c0: 2020 2020 2020 2020 2020 2020 2020 2e64                .d
+0000e1d0: 6563 6f64 655f 6675 6e63 7469 6f6e 5f69  ecode_function_i
+0000e1e0: 6e70 7574 2870 6179 6c6f 6164 290a 2020  nput(payload).  
+0000e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e200: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e220: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000e230: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0000e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e250: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+0000e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e270: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e290: 2073 656c 662e 5f73 696d 756c 6174 6528   self._simulate(
+0000e2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2c0: 2066 756e 635f 6e61 6d65 3d5f 6675 6e63   func_name=_func
+0000e2d0: 2e66 6e5f 6e61 6d65 2c0a 2020 2020 2020  .fn_name,.      
+0000e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2f0: 2020 2020 2020 2020 2020 6675 6e63 5f70            func_p
+0000e300: 6172 616d 733d 5f70 6172 616d 732c 0a20  arams=_params,. 
 0000e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e320: 2020 2020 205f 6675 6e63 2c20 5f70 6172       _func, _par
-0000e330: 616d 7320 3d20 280a 2020 2020 2020 2020  ams = (.        
-0000e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e350: 2020 2020 2020 2020 5765 6233 2829 0a20          Web3(). 
+0000e320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e340: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0000e350: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
 0000e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e370: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-0000e380: 6574 682e 636f 6e74 7261 6374 2861 6269  eth.contract(abi
-0000e390: 3d55 4e49 5357 4150 5f56 335f 524f 5554  =UNISWAP_V3_ROUT
-0000e3a0: 4552 5f41 4249 290a 2020 2020 2020 2020  ER_ABI).        
-0000e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3c0: 2020 2020 2020 2020 2e64 6563 6f64 655f          .decode_
-0000e3d0: 6675 6e63 7469 6f6e 5f69 6e70 7574 2870  function_input(p
-0000e3e0: 6179 6c6f 6164 290a 2020 2020 2020 2020  ayload).        
+0000e370: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000e380: 6c75 6545 7272 6f72 2866 2243 6f75 6c64  lueError(f"Could
+0000e390: 206e 6f74 2064 6563 6f64 6520 6e65 7374   not decode nest
+0000e3a0: 6564 206d 756c 7469 6361 6c6c 3a20 7b65  ed multicall: {e
+0000e3b0: 7d22 2920 6672 6f6d 2065 0a20 2020 2020  }") from e.     
+0000e3c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000e3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e3e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
 0000e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e400: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0000e410: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000e420: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-0000e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e440: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000e450: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000e460: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e480: 2020 2020 2020 2020 2020 205f 6675 6e63             _func
-0000e490: 2c20 5f70 6172 616d 7320 3d20 280a 2020  , _params = (.  
+0000e400: 2020 7365 6c66 2e5f 7369 6d75 6c61 7465    self._simulate
+0000e410: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e420: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+0000e430: 6e63 5f6e 616d 653d 7061 796c 6f61 645f  nc_name=payload_
+0000e440: 6675 6e63 2e66 6e5f 6e61 6d65 2c0a 2020  func.fn_name,.  
+0000e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e460: 2020 2020 2020 2020 2020 6675 6e63 5f70            func_p
+0000e470: 6172 616d 733d 7061 796c 6f61 645f 6172  arams=payload_ar
+0000e480: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0000e490: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
 0000e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4b0: 2020 2020 2020 2020 2020 2020 2020 5765                We
-0000e4c0: 6233 2829 0a20 2020 2020 2020 2020 2020  b3().           
+0000e4b0: 2020 6578 6365 7074 2054 7261 6e73 6163    except Transac
+0000e4c0: 7469 6f6e 4572 726f 723a 0a20 2020 2020  tionError:.     
 0000e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4e0: 2020 2020 202e 6574 682e 636f 6e74 7261       .eth.contra
-0000e4f0: 6374 2861 6269 3d55 4e49 5357 4150 5f56  ct(abi=UNISWAP_V
-0000e500: 335f 524f 5554 4552 325f 4142 4929 0a20  3_ROUTER2_ABI). 
-0000e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e520: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-0000e530: 6465 636f 6465 5f66 756e 6374 696f 6e5f  decode_function_
-0000e540: 696e 7075 7428 7061 796c 6f61 6429 0a20  input(payload). 
-0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e560: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000e4e0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
+0000e4f0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000e500: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000e510: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000e520: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+0000e530: 7274 2074 7261 6365 6261 636b 0a0a 2020  rt traceback..  
+0000e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e550: 2020 2020 2020 7472 6163 6562 6163 6b2e        traceback.
+0000e560: 7072 696e 745f 6578 6328 290a 2020 2020  print_exc().    
 0000e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e580: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000e590: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-0000e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5b0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
-0000e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5f0: 2020 5f76 335f 6d75 6c74 6963 616c 6c5f    _v3_multicall_
-0000e600: 6675 7475 7265 5f70 6f6f 6c5f 7374 6174  future_pool_stat
-0000e610: 6573 2e65 7874 656e 6428 0a20 2020 2020  es.extend(.     
-0000e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e630: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000e640: 5f73 696d 756c 6174 6528 0a20 2020 2020  _simulate(.     
-0000e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e660: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000e670: 756e 635f 6e61 6d65 3d5f 6675 6e63 2e66  unc_name=_func.f
-0000e680: 6e5f 6e61 6d65 2c0a 2020 2020 2020 2020  n_name,.        
-0000e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6a0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-0000e6b0: 5f70 6172 616d 733d 5f70 6172 616d 732c  _params=_params,
-0000e6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000e6f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000e700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e710: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000e720: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-0000e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e740: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000e750: 6520 5661 6c75 6545 7272 6f72 2866 2243  e ValueError(f"C
-0000e760: 6f75 6c64 206e 6f74 2064 6563 6f64 6520  ould not decode 
-0000e770: 6e65 7374 6564 206d 756c 7469 6361 6c6c  nested multicall
-0000e780: 3a20 7b65 7d22 2920 6672 6f6d 2065 0a20  : {e}") from e. 
-0000e790: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000e7a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000e7b0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7d0: 2020 2020 2020 5f76 335f 6d75 6c74 6963        _v3_multic
-0000e7e0: 616c 6c5f 6675 7475 7265 5f70 6f6f 6c5f  all_future_pool_
-0000e7f0: 7374 6174 6573 2e65 7874 656e 6428 0a20  states.extend(. 
-0000e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e810: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000e820: 5f73 696d 756c 6174 6528 0a20 2020 2020  _simulate(.     
-0000e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e840: 2020 2020 2020 2020 2020 2066 756e 635f             func_
-0000e850: 6e61 6d65 3d70 6179 6c6f 6164 5f66 756e  name=payload_fun
-0000e860: 632e 666e 5f6e 616d 652c 0a20 2020 2020  c.fn_name,.     
-0000e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e880: 2020 2020 2020 2020 2020 2066 756e 635f             func_
-0000e890: 7061 7261 6d73 3d70 6179 6c6f 6164 5f61  params=payload_a
-0000e8a0: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
-0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8c0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000e8d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8f0: 2065 7863 6570 7420 5472 616e 7361 6374   except Transact
-0000e900: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
-0000e910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e920: 2020 7261 6973 650a 2020 2020 2020 2020    raise.        
-0000e930: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000e940: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-0000e950: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e960: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
-0000e970: 7420 7472 6163 6562 6163 6b0a 0a20 2020  t traceback..   
-0000e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e990: 2020 2020 2074 7261 6365 6261 636b 2e70       traceback.p
-0000e9a0: 7269 6e74 5f65 7863 2829 0a20 2020 2020  rint_exc().     
-0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9c0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000e9d0: 726f 7228 6622 436f 756c 6420 6e6f 7420  ror(f"Could not 
-0000e9e0: 6465 636f 6465 206d 756c 7469 6361 6c6c  decode multicall
-0000e9f0: 3a20 7b65 7d22 290a 0a20 2020 2020 2020  : {e}")..       
-0000ea00: 2020 2020 2072 6574 7572 6e20 5f76 335f       return _v3_
-0000ea10: 6d75 6c74 6963 616c 6c5f 6675 7475 7265  multicall_future
-0000ea20: 5f70 6f6f 6c5f 7374 6174 6573 0a0a 2020  _pool_states..  
-0000ea30: 2020 2020 2020 6465 6620 5f70 726f 6365        def _proce
-0000ea40: 7373 5f75 6e69 7377 6170 5f76 325f 7472  ss_uniswap_v2_tr
-0000ea50: 616e 7361 6374 696f 6e28 2920 2d3e 2028  ansaction() -> (
-0000ea60: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
-0000ea70: 745b 0a20 2020 2020 2020 2020 2020 2020  t[.             
-0000ea80: 2020 2054 7570 6c65 5b0a 2020 2020 2020     Tuple[.      
-0000ea90: 2020 2020 2020 2020 2020 2020 2020 4c69                Li
-0000eaa0: 7175 6964 6974 7950 6f6f 6c2c 0a20 2020  quidityPool,.   
+0000e580: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0000e590: 7272 6f72 2866 2243 6f75 6c64 206e 6f74  rror(f"Could not
+0000e5a0: 2064 6563 6f64 6520 6d75 6c74 6963 616c   decode multical
+0000e5b0: 6c3a 207b 657d 2229 0a0a 2020 2020 2020  l: {e}")..      
+0000e5c0: 2020 6465 6620 5f70 726f 6365 7373 5f75    def _process_u
+0000e5d0: 6e69 7377 6170 5f76 325f 7472 616e 7361  niswap_v2_transa
+0000e5e0: 6374 696f 6e28 2920 2d3e 204e 6f6e 653a  ction() -> None:
+0000e5f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000e600: 5459 5045 5f43 4845 434b 494e 473a 0a20  TYPE_CHECKING:. 
+0000e610: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000e620: 616d 6f75 6e74 5f69 6e3a 2069 6e74 203d  amount_in: int =
+0000e630: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0000e640: 2020 205f 616d 6f75 6e74 5f6f 7574 3a20     _amount_out: 
+0000e650: 696e 7420 3d20 300a 2020 2020 2020 2020  int = 0.        
+0000e660: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0000e670: 656c 662e 7632 5f70 6f6f 6c5f 6d61 6e61  elf.v2_pool_mana
+0000e680: 6765 7220 6973 206e 6f74 204e 6f6e 650a  ger is not None.
+0000e690: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0000e6a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e6b0: 2020 6d61 7463 6820 6675 6e63 5f6e 616d    match func_nam
+0000e6c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e6d0: 2020 2020 2020 2063 6173 6520 280a 2020         case (.  
+0000e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6f0: 2020 2020 2020 2273 7761 7045 7861 6374        "swapExact
+0000e700: 546f 6b65 6e73 466f 7245 5448 220a 2020  TokensForETH".  
+0000e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e720: 2020 2020 2020 7c20 2273 7761 7045 7861        | "swapExa
+0000e730: 6374 546f 6b65 6e73 466f 7245 5448 5375  ctTokensForETHSu
+0000e740: 7070 6f72 7469 6e67 4665 654f 6e54 7261  pportingFeeOnTra
+0000e750: 6e73 6665 7254 6f6b 656e 7322 0a20 2020  nsferTokens".   
+0000e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e770: 2020 2020 207c 2022 7377 6170 4578 6163       | "swapExac
+0000e780: 7445 5448 466f 7254 6f6b 656e 7322 0a20  tETHForTokens". 
+0000e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7a0: 2020 2020 2020 207c 2022 7377 6170 4578         | "swapEx
+0000e7b0: 6163 7445 5448 466f 7254 6f6b 656e 7353  actETHForTokensS
+0000e7c0: 7570 706f 7274 696e 6746 6565 4f6e 5472  upportingFeeOnTr
+0000e7d0: 616e 7366 6572 546f 6b65 6e73 220a 2020  ansferTokens".  
+0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7f0: 2020 2020 2020 7c20 2273 7761 7045 7861        | "swapExa
+0000e800: 6374 546f 6b65 6e73 466f 7254 6f6b 656e  ctTokensForToken
+0000e810: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
+0000e820: 2020 2020 2020 2020 2020 207c 2022 7377             | "sw
+0000e830: 6170 4578 6163 7454 6f6b 656e 7346 6f72  apExactTokensFor
+0000e840: 546f 6b65 6e73 5375 7070 6f72 7469 6e67  TokensSupporting
+0000e850: 4665 654f 6e54 7261 6e73 6665 7254 6f6b  FeeOnTransferTok
+0000e860: 656e 7322 0a20 2020 2020 2020 2020 2020  ens".           
+0000e870: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+0000e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e890: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0000e8a0: 2866 227b 6675 6e63 5f6e 616d 657d 3a20  (f"{func_name}: 
+0000e8b0: 7b73 656c 662e 6861 7368 2e68 6578 2829  {self.hash.hex()
+0000e8c0: 3d7d 2229 0a0a 2020 2020 2020 2020 2020  =}")..          
+0000e8d0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0000e8e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000e900: 785f 616d 6f75 6e74 5f69 6e20 3d20 6675  x_amount_in = fu
+0000e910: 6e63 5f70 6172 616d 735b 2261 6d6f 756e  nc_params["amoun
+0000e920: 7449 6e22 5d0a 2020 2020 2020 2020 2020  tIn"].          
+0000e930: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000e940: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+0000e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e960: 2020 2020 2020 2020 2020 2074 785f 616d             tx_am
+0000e970: 6f75 6e74 5f69 6e20 3d20 7365 6c66 2e76  ount_in = self.v
+0000e980: 616c 7565 2020 2320 2773 7761 7045 7861  alue  # 'swapExa
+0000e990: 6374 4554 4846 6f72 546f 6b65 6e73 270a  ctETHForTokens'.
+0000e9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e9b0: 2020 2020 2020 2020 2074 785f 616d 6f75           tx_amou
+0000e9c0: 6e74 5f6f 7574 5f6d 696e 203d 2066 756e  nt_out_min = fun
+0000e9d0: 635f 7061 7261 6d73 5b22 616d 6f75 6e74  c_params["amount
+0000e9e0: 4f75 744d 696e 225d 0a20 2020 2020 2020  OutMin"].       
+0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea00: 2074 785f 7061 7468 203d 2066 756e 635f   tx_path = func_
+0000ea10: 7061 7261 6d73 5b22 7061 7468 225d 0a0a  params["path"]..
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea30: 2020 2020 2020 2020 7478 5f72 6563 6970          tx_recip
+0000ea40: 6965 6e74 203d 2066 756e 635f 7061 7261  ient = func_para
+0000ea50: 6d73 5b22 746f 225d 0a20 2020 2020 2020  ms["to"].       
+0000ea60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea70: 2069 6620 7478 5f72 6563 6970 6965 6e74   if tx_recipient
+0000ea80: 203d 3d20 556e 6976 6572 7361 6c52 6f75   == UniversalRou
+0000ea90: 7465 7253 7065 6369 616c 4164 6472 6573  terSpecialAddres
+0000eaa0: 732e 524f 5554 4552 3a0a 2020 2020 2020  s.ROUTER:.      
 0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eac0: 2055 6e69 7377 6170 5632 506f 6f6c 5369   UniswapV2PoolSi
-0000ead0: 6d75 6c61 7469 6f6e 5265 7375 6c74 2c0a  mulationResult,.
-0000eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eaf0: 5d0a 2020 2020 2020 2020 2020 2020 5d0a  ].            ].
-0000eb00: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-0000eb10: 2020 2020 2020 205f 7632 5f72 6f75 7465         _v2_route
-0000eb20: 725f 6675 7475 7265 5f70 6f6f 6c5f 7374  r_future_pool_st
-0000eb30: 6174 6573 3a20 4c69 7374 5b0a 2020 2020  ates: List[.    
-0000eb40: 2020 2020 2020 2020 2020 2020 5475 706c              Tupl
-0000eb50: 655b 0a20 2020 2020 2020 2020 2020 2020  e[.             
-0000eb60: 2020 2020 2020 204c 6971 7569 6469 7479         Liquidity
-0000eb70: 506f 6f6c 2c0a 2020 2020 2020 2020 2020  Pool,.          
-0000eb80: 2020 2020 2020 2020 2020 556e 6973 7761            Uniswa
-0000eb90: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
-0000eba0: 6e52 6573 756c 742c 0a20 2020 2020 2020  nResult,.       
-0000ebb0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-0000ebc0: 2020 2020 2020 205d 203d 205b 5d0a 0a20         ] = [].. 
-0000ebd0: 2020 2020 2020 2020 2020 2069 6620 5459             if TY
-0000ebe0: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
-0000ebf0: 2020 2020 2020 2020 2020 2020 205f 616d               _am
-0000ec00: 6f75 6e74 5f69 6e3a 2069 6e74 203d 2030  ount_in: int = 0
-0000ec10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ec20: 205f 616d 6f75 6e74 5f6f 7574 3a20 696e   _amount_out: in
-0000ec30: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
-0000ec40: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0000ec50: 662e 7632 5f70 6f6f 6c5f 6d61 6e61 6765  f.v2_pool_manage
-0000ec60: 7220 6973 206e 6f74 204e 6f6e 650a 0a20  r is not None.. 
-0000ec70: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec90: 6d61 7463 6820 6675 6e63 5f6e 616d 653a  match func_name:
-0000eca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ecb0: 2020 2020 2063 6173 6520 280a 2020 2020       case (.    
+0000eac0: 2020 2020 2020 7478 5f72 6563 6970 6965        tx_recipie
+0000ead0: 6e74 203d 2073 656c 662e 726f 7574 6572  nt = self.router
+0000eae0: 5f61 6464 7265 7373 0a0a 2020 2020 2020  _address..      
+0000eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb00: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb20: 2020 2074 785f 6465 6164 6c69 6e65 203d     tx_deadline =
+0000eb30: 2066 756e 635f 7061 7261 6d73 5b22 6465   func_params["de
+0000eb40: 6164 6c69 6e65 225d 0a20 2020 2020 2020  adline"].       
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+0000eb70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0000eb90: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+0000eba0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000ebb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ebc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000ebd0: 662e 5f72 6169 7365 5f69 665f 7061 7374  f._raise_if_past
+0000ebe0: 5f64 6561 646c 696e 6528 7478 5f64 6561  _deadline(tx_dea
+0000ebf0: 646c 696e 6529 0a0a 2020 2020 2020 2020  dline)..        
+0000ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec10: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec30: 2070 6f6f 6c73 203d 2067 6574 5f76 325f   pools = get_v2_
+0000ec40: 706f 6f6c 735f 6672 6f6d 5f74 6f6b 656e  pools_from_token
+0000ec50: 5f70 6174 6828 7478 5f70 6174 682c 2073  _path(tx_path, s
+0000ec60: 656c 662e 7632 5f70 6f6f 6c5f 6d61 6e61  elf.v2_pool_mana
+0000ec70: 6765 7229 0a20 2020 2020 2020 2020 2020  ger).           
+0000ec80: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000ec90: 6570 7420 284c 6971 7569 6469 7479 506f  ept (LiquidityPo
+0000eca0: 6f6c 4572 726f 722c 204d 616e 6167 6572  olError, Manager
+0000ecb0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
 0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecd0: 2020 2020 2273 7761 7045 7861 6374 546f      "swapExactTo
-0000ece0: 6b65 6e73 466f 7245 5448 220a 2020 2020  kensForETH".    
+0000ecd0: 2020 2020 7261 6973 6520 5472 616e 7361      raise Transa
+0000ece0: 6374 696f 6e45 7272 6f72 280a 2020 2020  ctionError(.    
 0000ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed00: 2020 2020 7c20 2273 7761 7045 7861 6374      | "swapExact
-0000ed10: 546f 6b65 6e73 466f 7245 5448 5375 7070  TokensForETHSupp
-0000ed20: 6f72 7469 6e67 4665 654f 6e54 7261 6e73  ortingFeeOnTrans
-0000ed30: 6665 7254 6f6b 656e 7322 0a20 2020 2020  ferTokens".     
-0000ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed50: 2020 207c 2022 7377 6170 4578 6163 7445     | "swapExactE
-0000ed60: 5448 466f 7254 6f6b 656e 7322 0a20 2020  THForTokens".   
+0000ed00: 2020 2020 2020 2020 2020 2020 6622 4c69              f"Li
+0000ed10: 7175 6964 6974 7950 6f6f 6c20 636f 756c  quidityPool coul
+0000ed20: 6420 6e6f 7420 6265 2062 7569 6c74 2066  d not be built f
+0000ed30: 6f72 2061 6c6c 2073 7465 7073 2069 6e20  or all steps in 
+0000ed40: 7061 7468 207b 7478 5f70 6174 687d 220a  path {tx_path}".
+0000ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed60: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
 0000ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed80: 2020 2020 207c 2022 7377 6170 4578 6163       | "swapExac
-0000ed90: 7445 5448 466f 7254 6f6b 656e 7353 7570  tETHForTokensSup
-0000eda0: 706f 7274 696e 6746 6565 4f6e 5472 616e  portingFeeOnTran
-0000edb0: 7366 6572 546f 6b65 6e73 220a 2020 2020  sferTokens".    
-0000edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edd0: 2020 2020 7c20 2273 7761 7045 7861 6374      | "swapExact
-0000ede0: 546f 6b65 6e73 466f 7254 6f6b 656e 7322  TokensForTokens"
-0000edf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ee00: 2020 2020 2020 2020 207c 2022 7377 6170           | "swap
-0000ee10: 4578 6163 7454 6f6b 656e 7346 6f72 546f  ExactTokensForTo
-0000ee20: 6b65 6e73 5375 7070 6f72 7469 6e67 4665  kensSupportingFe
-0000ee30: 654f 6e54 7261 6e73 6665 7254 6f6b 656e  eOnTransferToken
-0000ee40: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
-0000ee50: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee70: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-0000ee80: 227b 6675 6e63 5f6e 616d 657d 3a20 7b73  "{func_name}: {s
-0000ee90: 656c 662e 6861 7368 2e68 6578 2829 3d7d  elf.hash.hex()=}
-0000eea0: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-0000eeb0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000eec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eed0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-0000eee0: 616d 6f75 6e74 5f69 6e20 3d20 6675 6e63  amount_in = func
-0000eef0: 5f70 6172 616d 735b 2261 6d6f 756e 7449  _params["amountI
-0000ef00: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
-0000ef10: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000ef20: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-0000ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef40: 2020 2020 2020 2020 2074 785f 616d 6f75           tx_amou
-0000ef50: 6e74 5f69 6e20 3d20 7365 6c66 2e76 616c  nt_in = self.val
-0000ef60: 7565 2020 2320 2773 7761 7045 7861 6374  ue  # 'swapExact
-0000ef70: 4554 4846 6f72 546f 6b65 6e73 270a 0a20  ETHForTokens'.. 
-0000ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef90: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
-0000efa0: 5f6f 7574 5f6d 696e 203d 2066 756e 635f  _out_min = func_
-0000efb0: 7061 7261 6d73 5b22 616d 6f75 6e74 4f75  params["amountOu
-0000efc0: 744d 696e 225d 0a20 2020 2020 2020 2020  tMin"].         
-0000efd0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000efe0: 785f 7061 7468 203d 2066 756e 635f 7061  x_path = func_pa
-0000eff0: 7261 6d73 5b22 7061 7468 225d 0a0a 2020  rams["path"]..  
-0000f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f010: 2020 2020 2020 7478 5f72 6563 6970 6965        tx_recipie
-0000f020: 6e74 203d 2066 756e 635f 7061 7261 6d73  nt = func_params
-0000f030: 5b22 746f 225d 0a20 2020 2020 2020 2020  ["to"].         
-0000f040: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000f050: 6620 7478 5f72 6563 6970 6965 6e74 203d  f tx_recipient =
-0000f060: 3d20 556e 6976 6572 7361 6c52 6f75 7465  = UniversalRoute
-0000f070: 7253 7065 6369 616c 4164 6472 6573 732e  rSpecialAddress.
-0000f080: 524f 5554 4552 3a0a 2020 2020 2020 2020  ROUTER:.        
-0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0a0: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
-0000f0b0: 203d 2073 656c 662e 726f 7574 6572 5f61   = self.router_a
-0000f0c0: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
-0000f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000ed80: 2020 2020 2020 206c 6173 745f 706f 6f6c         last_pool
+0000ed90: 5f70 6f73 203d 206c 656e 2874 785f 7061  _pos = len(tx_pa
+0000eda0: 7468 2920 2d20 320a 0a20 2020 2020 2020  th) - 2..       
+0000edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edc0: 2066 6f72 2070 6f6f 6c5f 706f 732c 2070   for pool_pos, p
+0000edd0: 6f6f 6c20 696e 2065 6e75 6d65 7261 7465  ool in enumerate
+0000ede0: 2870 6f6f 6c73 293a 0a20 2020 2020 2020  (pools):.       
+0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee00: 2020 2020 2066 6972 7374 5f73 7761 7020       first_swap 
+0000ee10: 3d20 706f 6f6c 5f70 6f73 203d 3d20 300a  = pool_pos == 0.
+0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee30: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+0000ee40: 5f73 7761 7020 3d20 706f 6f6c 5f70 6f73  _swap = pool_pos
+0000ee50: 203d 3d20 6c61 7374 5f70 6f6f 6c5f 706f   == last_pool_po
+0000ee60: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0000ee70: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000ee80: 746f 6b65 6e5f 696e 203d 2028 0a20 2020  token_in = (.   
+0000ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eea0: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
+0000eeb0: 6c2e 746f 6b65 6e30 2069 6620 7478 5f70  l.token0 if tx_p
+0000eec0: 6174 685b 706f 6f6c 5f70 6f73 5d20 3d3d  ath[pool_pos] ==
+0000eed0: 2070 6f6f 6c2e 746f 6b65 6e30 2065 6c73   pool.token0 els
+0000eee0: 6520 706f 6f6c 2e74 6f6b 656e 310a 2020  e pool.token1.  
+0000eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef00: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef20: 2020 2020 2020 2020 205f 616d 6f75 6e74           _amount
+0000ef30: 5f69 6e20 3d20 7478 5f61 6d6f 756e 745f  _in = tx_amount_
+0000ef40: 696e 2069 6620 6669 7273 745f 7377 6170  in if first_swap
+0000ef50: 2065 6c73 6520 5f61 6d6f 756e 745f 6f75   else _amount_ou
+0000ef60: 740a 0a20 2020 2020 2020 2020 2020 2020  t..             
+0000ef70: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000ef80: 7265 6369 7069 656e 7420 3d20 7478 5f72  recipient = tx_r
+0000ef90: 6563 6970 6965 6e74 2069 6620 6c61 7374  ecipient if last
+0000efa0: 5f73 7761 7020 656c 7365 2070 6f6f 6c73  _swap else pools
+0000efb0: 5b70 6f6f 6c5f 706f 7320 2b20 315d 2e61  [pool_pos + 1].a
+0000efc0: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
+0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efe0: 2020 2020 5f2c 2073 696d 5f72 6573 756c      _, sim_resul
+0000eff0: 7420 3d20 7365 6c66 2e5f 7369 6d75 6c61  t = self._simula
+0000f000: 7465 5f76 325f 7377 6170 5f65 7861 6374  te_v2_swap_exact
+0000f010: 5f69 6e28 0a20 2020 2020 2020 2020 2020  _in(.           
+0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f030: 2020 2020 2070 6f6f 6c3d 706f 6f6c 2c0a       pool=pool,.
+0000f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f060: 7265 6369 7069 656e 743d 5f72 6563 6970  recipient=_recip
+0000f070: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
+0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f090: 2020 2020 2020 746f 6b65 6e5f 696e 3d5f        token_in=_
+0000f0a0: 746f 6b65 6e5f 696e 2c0a 2020 2020 2020  token_in,.      
+0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0c0: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+0000f0d0: 5f69 6e3d 5f61 6d6f 756e 745f 696e 2c0a  _in=_amount_in,.
+0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f100: 2074 785f 6465 6164 6c69 6e65 203d 2066   tx_deadline = f
-0000f110: 756e 635f 7061 7261 6d73 5b22 6465 6164  unc_params["dead
-0000f120: 6c69 6e65 225d 0a20 2020 2020 2020 2020  line"].         
-0000f130: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f140: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-0000f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f160: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000f170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f180: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000f1b0: 5f72 6169 7365 5f69 665f 6578 7069 7265  _raise_if_expire
-0000f1c0: 6428 7478 5f64 6561 646c 696e 6529 0a0a  d(tx_deadline)..
+0000f100: 616d 6f75 6e74 5f6f 7574 5f6d 696e 3d74  amount_out_min=t
+0000f110: 785f 616d 6f75 6e74 5f6f 7574 5f6d 696e  x_amount_out_min
+0000f120: 2069 6620 6c61 7374 5f73 7761 7020 656c   if last_swap el
+0000f130: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+0000f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f150: 2020 2020 2020 2020 2066 6972 7374 5f73           first_s
+0000f160: 7761 703d 6669 7273 745f 7377 6170 2c0a  wap=first_swap,.
+0000f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f190: 6c61 7374 5f73 7761 703d 6c61 7374 5f73  last_swap=last_s
+0000f1a0: 7761 702c 0a20 2020 2020 2020 2020 2020  wap,.           
+0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f1c0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
 0000f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f200: 2020 2020 2020 2020 2070 6f6f 6c73 203d           pools =
-0000f210: 2067 6574 5f76 325f 706f 6f6c 735f 6672   get_v2_pools_fr
-0000f220: 6f6d 5f74 6f6b 656e 5f70 6174 6828 7478  om_token_path(tx
-0000f230: 5f70 6174 682c 2073 656c 662e 7632 5f70  _path, self.v2_p
-0000f240: 6f6f 6c5f 6d61 6e61 6765 7229 0a20 2020  ool_manager).   
-0000f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f260: 2020 2020 2065 7863 6570 7420 284c 6971       except (Liq
-0000f270: 7569 6469 7479 506f 6f6c 4572 726f 722c  uidityPoolError,
-0000f280: 204d 616e 6167 6572 4572 726f 7229 3a0a   ManagerError):.
-0000f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000f2b0: 6520 5472 616e 7361 6374 696f 6e45 7272  e TransactionErr
-0000f2c0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2e0: 2020 2020 6622 4c69 7175 6964 6974 7950      f"LiquidityP
-0000f2f0: 6f6f 6c20 636f 756c 6420 6e6f 7420 6265  ool could not be
-0000f300: 2062 7569 6c74 2066 6f72 2061 6c6c 2073   built for all s
-0000f310: 7465 7073 2069 6e20 7061 7468 207b 7478  teps in path {tx
-0000f320: 5f70 6174 687d 220a 2020 2020 2020 2020  _path}".        
+0000f1e0: 5f61 6d6f 756e 745f 6f75 7420 3d20 2d6d  _amount_out = -m
+0000f1f0: 696e 2873 696d 5f72 6573 756c 742e 616d  in(sim_result.am
+0000f200: 6f75 6e74 305f 6465 6c74 612c 2073 696d  ount0_delta, sim
+0000f210: 5f72 6573 756c 742e 616d 6f75 6e74 315f  _result.amount1_
+0000f220: 6465 6c74 6129 0a0a 2020 2020 2020 2020  delta)..        
+0000f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f240: 2020 2020 7365 6c66 2e73 696d 756c 6174      self.simulat
+0000f250: 6564 5f70 6f6f 6c5f 7374 6174 6573 2e61  ed_pool_states.a
+0000f260: 7070 656e 6428 2870 6f6f 6c2c 2073 696d  ppend((pool, sim
+0000f270: 5f72 6573 756c 7429 290a 0a20 2020 2020  _result))..     
+0000f280: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000f290: 6173 6520 280a 2020 2020 2020 2020 2020  ase (.          
+0000f2a0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0000f2b0: 7761 7054 6f6b 656e 7346 6f72 4578 6163  wapTokensForExac
+0000f2c0: 7445 5448 220a 2020 2020 2020 2020 2020  tETH".          
+0000f2d0: 2020 2020 2020 2020 2020 2020 2020 7c20                | 
+0000f2e0: 2273 7761 7054 6f6b 656e 7346 6f72 4578  "swapTokensForEx
+0000f2f0: 6163 7454 6f6b 656e 7322 0a20 2020 2020  actTokens".     
+0000f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f310: 2020 207c 2022 7377 6170 4554 4846 6f72     | "swapETHFor
+0000f320: 4578 6163 7454 6f6b 656e 7322 0a20 2020  ExactTokens".   
 0000f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f340: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000f350: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000f360: 6173 745f 706f 6f6c 5f70 6f73 203d 206c  ast_pool_pos = l
-0000f370: 656e 2874 785f 7061 7468 2920 2d20 320a  en(tx_path) - 2.
-0000f380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f390: 2020 2020 2020 2020 2066 6f72 2070 6f6f           for poo
-0000f3a0: 6c5f 706f 732c 2070 6f6f 6c20 696e 2065  l_pos, pool in e
-0000f3b0: 6e75 6d65 7261 7465 2870 6f6f 6c73 293a  numerate(pools):
-0000f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f3d0: 2020 2020 2020 2020 2020 2020 2066 6972               fir
-0000f3e0: 7374 5f73 7761 7020 3d20 706f 6f6c 5f70  st_swap = pool_p
-0000f3f0: 6f73 203d 3d20 300a 2020 2020 2020 2020  os == 0.        
-0000f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f410: 2020 2020 6c61 7374 5f73 7761 7020 3d20      last_swap = 
-0000f420: 706f 6f6c 5f70 6f73 203d 3d20 6c61 7374  pool_pos == last
-0000f430: 5f70 6f6f 6c5f 706f 730a 0a20 2020 2020  _pool_pos..     
-0000f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f450: 2020 2020 2020 205f 746f 6b65 6e5f 696e         _token_in
-0000f460: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2020 2020 2070 6f6f 6c2e 746f 6b65 6e30       pool.token0
-0000f490: 2069 6620 7478 5f70 6174 685b 706f 6f6c   if tx_path[pool
-0000f4a0: 5f70 6f73 5d20 3d3d 2070 6f6f 6c2e 746f  _pos] == pool.to
-0000f4b0: 6b65 6e30 2065 6c73 6520 706f 6f6c 2e74  ken0 else pool.t
-0000f4c0: 6f6b 656e 310a 2020 2020 2020 2020 2020  oken1.          
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4e0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000f340: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0000f350: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000f360: 6572 2e64 6562 7567 2866 227b 6675 6e63  er.debug(f"{func
+0000f370: 5f6e 616d 657d 3a20 7b73 656c 662e 6861  _name}: {self.ha
+0000f380: 7368 2e68 6578 2829 3d7d 2229 0a0a 2020  sh.hex()=}")..  
+0000f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3a0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+0000f3b0: 6f75 7420 3d20 6675 6e63 5f70 6172 616d  out = func_param
+0000f3c0: 735b 2261 6d6f 756e 744f 7574 225d 0a20  s["amountOut"]. 
+0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f400: 2020 2020 2020 2020 7478 5f61 6d6f 756e          tx_amoun
+0000f410: 745f 696e 5f6d 6178 203d 2066 756e 635f  t_in_max = func_
+0000f420: 7061 7261 6d73 5b22 616d 6f75 6e74 496e  params["amountIn
+0000f430: 4d61 7822 5d0a 2020 2020 2020 2020 2020  Max"].          
+0000f440: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0000f450: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f470: 2020 2020 2020 2020 2020 2074 785f 616d             tx_am
+0000f480: 6f75 6e74 5f69 6e5f 6d61 7820 3d20 7365  ount_in_max = se
+0000f490: 6c66 2e76 616c 7565 2020 2320 2773 7761  lf.value  # 'swa
+0000f4a0: 7045 5448 466f 7245 7861 6374 546f 6b65  pETHForExactToke
+0000f4b0: 6e73 270a 2020 2020 2020 2020 2020 2020  ns'.            
+0000f4c0: 2020 2020 2020 2020 2020 2020 7478 5f70              tx_p
+0000f4d0: 6174 6820 3d20 6675 6e63 5f70 6172 616d  ath = func_param
+0000f4e0: 735b 2270 6174 6822 5d0a 0a20 2020 2020  s["path"]..     
 0000f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f500: 205f 616d 6f75 6e74 5f69 6e20 3d20 7478   _amount_in = tx
-0000f510: 5f61 6d6f 756e 745f 696e 2069 6620 6669  _amount_in if fi
-0000f520: 7273 745f 7377 6170 2065 6c73 6520 5f61  rst_swap else _a
-0000f530: 6d6f 756e 745f 6f75 740a 0a20 2020 2020  mount_out..     
-0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f550: 2020 2020 2020 205f 7265 6369 7069 656e         _recipien
-0000f560: 7420 3d20 7478 5f72 6563 6970 6965 6e74  t = tx_recipient
-0000f570: 2069 6620 6c61 7374 5f73 7761 7020 656c   if last_swap el
-0000f580: 7365 2070 6f6f 6c73 5b70 6f6f 6c5f 706f  se pools[pool_po
-0000f590: 7320 2b20 315d 2e61 6464 7265 7373 0a0a  s + 1].address..
-0000f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5b0: 2020 2020 2020 2020 2020 2020 5f2c 2073              _, s
-0000f5c0: 696d 5f72 6573 756c 7420 3d20 7365 6c66  im_result = self
-0000f5d0: 2e5f 7369 6d75 6c61 7465 5f76 325f 7377  ._simulate_v2_sw
-0000f5e0: 6170 5f65 7861 6374 5f69 6e28 0a20 2020  ap_exact_in(.   
-0000f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f600: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
-0000f610: 6c3d 706f 6f6c 2c0a 2020 2020 2020 2020  l=pool,.        
-0000f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f630: 2020 2020 2020 2020 7265 6369 7069 656e          recipien
-0000f640: 743d 5f72 6563 6970 6965 6e74 2c0a 2020  t=_recipient,.  
-0000f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f660: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0000f670: 6b65 6e5f 696e 3d5f 746f 6b65 6e5f 696e  ken_in=_token_in
-0000f680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6a0: 2020 616d 6f75 6e74 5f69 6e3d 5f61 6d6f    amount_in=_amo
-0000f6b0: 756e 745f 696e 2c0a 2020 2020 2020 2020  unt_in,.        
+0000f500: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
+0000f510: 3d20 6675 6e63 5f70 6172 616d 735b 2274  = func_params["t
+0000f520: 6f22 5d0a 2020 2020 2020 2020 2020 2020  o"].            
+0000f530: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0000f540: 785f 7265 6369 7069 656e 7420 3d3d 2055  x_recipient == U
+0000f550: 6e69 7665 7273 616c 526f 7574 6572 5370  niversalRouterSp
+0000f560: 6563 6961 6c41 6464 7265 7373 2e52 4f55  ecialAddress.ROU
+0000f570: 5445 523a 0a20 2020 2020 2020 2020 2020  TER:.           
+0000f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f590: 2074 785f 7265 6369 7069 656e 7420 3d20   tx_recipient = 
+0000f5a0: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
+0000f5b0: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+0000f5c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000f5d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f5e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000f5f0: 6c66 2e72 6563 6970 6965 6e74 732e 6164  lf.recipients.ad
+0000f600: 6428 7478 5f72 6563 6970 6965 6e74 290a  d(tx_recipient).
+0000f610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f620: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f640: 2020 2020 2020 2020 2020 7478 5f64 6561            tx_dea
+0000f650: 646c 696e 6520 3d20 6675 6e63 5f70 6172  dline = func_par
+0000f660: 616d 735b 2264 6561 646c 696e 6522 5d0a  ams["deadline"].
+0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f680: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+0000f690: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+0000f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6b0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
 0000f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6d0: 2020 2020 2020 2020 616d 6f75 6e74 5f6f          amount_o
-0000f6e0: 7574 5f6d 696e 3d74 785f 616d 6f75 6e74  ut_min=tx_amount
-0000f6f0: 5f6f 7574 5f6d 696e 2069 6620 6c61 7374  _out_min if last
-0000f700: 5f73 7761 7020 656c 7365 204e 6f6e 652c  _swap else None,
-0000f710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f6d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6f0: 2020 2020 7365 6c66 2e5f 7261 6973 655f      self._raise_
+0000f700: 6966 5f70 6173 745f 6465 6164 6c69 6e65  if_past_deadline
+0000f710: 2874 785f 6465 6164 6c69 6e65 290a 0a20  (tx_deadline).. 
 0000f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f730: 2066 6972 7374 5f73 7761 703d 6669 7273   first_swap=firs
-0000f740: 745f 7377 6170 2c0a 2020 2020 2020 2020  t_swap,.        
-0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f760: 2020 2020 2020 2020 6c61 7374 5f73 7761          last_swa
-0000f770: 703d 6c61 7374 5f73 7761 702c 0a20 2020  p=last_swap,.   
-0000f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f790: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000f730: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f750: 2020 2020 2020 2020 706f 6f6c 7320 3d20          pools = 
+0000f760: 6765 745f 7632 5f70 6f6f 6c73 5f66 726f  get_v2_pools_fro
+0000f770: 6d5f 746f 6b65 6e5f 7061 7468 2874 785f  m_token_path(tx_
+0000f780: 7061 7468 2c20 7365 6c66 2e76 325f 706f  path, self.v2_po
+0000f790: 6f6c 5f6d 616e 6167 6572 290a 2020 2020  ol_manager).    
 0000f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7b0: 2020 2020 2020 2020 5f61 6d6f 756e 745f          _amount_
-0000f7c0: 6f75 7420 3d20 2d6d 696e 2873 696d 5f72  out = -min(sim_r
-0000f7d0: 6573 756c 742e 616d 6f75 6e74 305f 6465  esult.amount0_de
-0000f7e0: 6c74 612c 2073 696d 5f72 6573 756c 742e  lta, sim_result.
-0000f7f0: 616d 6f75 6e74 315f 6465 6c74 6129 0a0a  amount1_delta)..
-0000f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f810: 2020 2020 2020 2020 2020 2020 5f76 325f              _v2_
-0000f820: 726f 7574 6572 5f66 7574 7572 655f 706f  router_future_po
-0000f830: 6f6c 5f73 7461 7465 732e 6170 7065 6e64  ol_states.append
-0000f840: 2828 706f 6f6c 2c20 7369 6d5f 7265 7375  ((pool, sim_resu
-0000f850: 6c74 2929 0a0a 2020 2020 2020 2020 2020  lt))..          
-0000f860: 2020 2020 2020 2020 2020 6361 7365 2028            case (
-0000f870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f880: 2020 2020 2020 2020 2022 7377 6170 546f           "swapTo
-0000f890: 6b65 6e73 466f 7245 7861 6374 4554 4822  kensForExactETH"
-0000f8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f8b0: 2020 2020 2020 2020 207c 2022 7377 6170           | "swap
-0000f8c0: 546f 6b65 6e73 466f 7245 7861 6374 546f  TokensForExactTo
-0000f8d0: 6b65 6e73 220a 2020 2020 2020 2020 2020  kens".          
-0000f8e0: 2020 2020 2020 2020 2020 2020 2020 7c20                | 
-0000f8f0: 2273 7761 7045 5448 466f 7245 7861 6374  "swapETHForExact
-0000f900: 546f 6b65 6e73 220a 2020 2020 2020 2020  Tokens".        
-0000f910: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+0000f7b0: 2020 2020 6578 6365 7074 2028 4c69 7175      except (Liqu
+0000f7c0: 6964 6974 7950 6f6f 6c45 7272 6f72 2c20  idityPoolError, 
+0000f7d0: 4d61 6e61 6765 7245 7272 6f72 293a 0a20  ManagerError):. 
+0000f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000f800: 2054 7261 6e73 6163 7469 6f6e 4572 726f   TransactionErro
+0000f810: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000f820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f830: 2020 2066 224c 6971 7569 6469 7479 506f     f"LiquidityPo
+0000f840: 6f6c 2063 6f75 6c64 206e 6f74 2062 6520  ol could not be 
+0000f850: 6275 696c 7420 666f 7220 616c 6c20 7374  built for all st
+0000f860: 6570 7320 696e 2070 6174 6820 7b74 785f  eps in path {tx_
+0000f870: 7061 7468 7d22 0a20 2020 2020 2020 2020  path}".         
+0000f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f890: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0000f8a0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0000f8b0: 7374 5f70 6f6f 6c5f 706f 7320 3d20 6c65  st_pool_pos = le
+0000f8c0: 6e28 706f 6f6c 7329 202d 2031 0a0a 2020  n(pools) - 1..  
+0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f8e0: 2020 2020 2020 666f 7220 706f 6f6c 5f70        for pool_p
+0000f8f0: 6f73 2c20 706f 6f6c 2069 6e20 656e 756d  os, pool in enum
+0000f900: 6572 6174 6528 706f 6f6c 735b 3a3a 2d31  erate(pools[::-1
+0000f910: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
 0000f920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f930: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-0000f940: 6275 6728 6622 7b66 756e 635f 6e61 6d65  bug(f"{func_name
-0000f950: 7d3a 207b 7365 6c66 2e68 6173 682e 6865  }: {self.hash.he
-0000f960: 7828 293d 7d22 290a 0a20 2020 2020 2020  x()=}")..       
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 2074 785f 616d 6f75 6e74 5f6f 7574 203d   tx_amount_out =
-0000f990: 2066 756e 635f 7061 7261 6d73 5b22 616d   func_params["am
-0000f9a0: 6f75 6e74 4f75 7422 5d0a 2020 2020 2020  ountOut"].      
-0000f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9e0: 2020 2074 785f 616d 6f75 6e74 5f69 6e5f     tx_amount_in_
-0000f9f0: 6d61 7820 3d20 6675 6e63 5f70 6172 616d  max = func_param
-0000fa00: 735b 2261 6d6f 756e 7449 6e4d 6178 225d  s["amountInMax"]
-0000fa10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fa20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000fa30: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
+0000f930: 6669 7273 745f 7377 6170 203d 2070 6f6f  first_swap = poo
+0000f940: 6c5f 706f 7320 3d3d 206c 6173 745f 706f  l_pos == last_po
+0000f950: 6f6c 5f70 6f73 0a20 2020 2020 2020 2020  ol_pos.         
+0000f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f970: 2020 206c 6173 745f 7377 6170 203d 2070     last_swap = p
+0000f980: 6f6f 6c5f 706f 7320 3d3d 2030 0a0a 2020  ool_pos == 0..  
+0000f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9a0: 2020 2020 2020 2020 2020 5f61 6d6f 756e            _amoun
+0000f9b0: 745f 6f75 7420 3d20 7478 5f61 6d6f 756e  t_out = tx_amoun
+0000f9c0: 745f 6f75 7420 6966 206c 6173 745f 7377  t_out if last_sw
+0000f9d0: 6170 2065 6c73 6520 5f61 6d6f 756e 745f  ap else _amount_
+0000f9e0: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
+0000f9f0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000fa00: 616d 6f75 6e74 5f69 6e5f 6d61 7820 3d20  amount_in_max = 
+0000fa10: 7478 5f61 6d6f 756e 745f 696e 5f6d 6178  tx_amount_in_max
+0000fa20: 2069 6620 6669 7273 745f 7377 6170 2065   if first_swap e
+0000fa30: 6c73 6520 4e6f 6e65 0a0a 2020 2020 2020  lse None..      
 0000fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa50: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
-0000fa60: 696e 5f6d 6178 203d 2073 656c 662e 7661  in_max = self.va
-0000fa70: 6c75 6520 2023 2027 7377 6170 4554 4846  lue  # 'swapETHF
-0000fa80: 6f72 4578 6163 7454 6f6b 656e 7327 0a20  orExactTokens'. 
-0000fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000faa0: 2020 2020 2020 2074 785f 7061 7468 203d         tx_path =
-0000fab0: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-0000fac0: 7468 225d 0a0a 2020 2020 2020 2020 2020  th"]..          
-0000fad0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-0000fae0: 5f72 6563 6970 6965 6e74 203d 2066 756e  _recipient = fun
-0000faf0: 635f 7061 7261 6d73 5b22 746f 225d 0a20  c_params["to"]. 
-0000fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb10: 2020 2020 2020 2069 6620 7478 5f72 6563         if tx_rec
-0000fb20: 6970 6965 6e74 203d 3d20 556e 6976 6572  ipient == Univer
-0000fb30: 7361 6c52 6f75 7465 7253 7065 6369 616c  salRouterSpecial
-0000fb40: 4164 6472 6573 732e 524f 5554 4552 3a0a  Address.ROUTER:.
-0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb60: 2020 2020 2020 2020 2020 2020 7478 5f72              tx_r
-0000fb70: 6563 6970 6965 6e74 203d 2073 656c 662e  ecipient = self.
-0000fb80: 726f 7574 6572 5f61 6464 7265 7373 0a20  router_address. 
-0000fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fba0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000fbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbc0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0000fbd0: 6369 7069 656e 7473 2e61 6464 2874 785f  cipients.add(tx_
-0000fbe0: 7265 6369 7069 656e 7429 0a0a 2020 2020  recipient)..    
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000fa50: 2020 2020 2020 5f72 6563 6970 6965 6e74        _recipient
+0000fa60: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa80: 2020 2020 2074 785f 7265 6369 7069 656e       tx_recipien
+0000fa90: 7420 6966 206c 6173 745f 7377 6170 2065  t if last_swap e
+0000faa0: 6c73 6520 706f 6f6c 735b 3a3a 2d31 5d5b  lse pools[::-1][
+0000fab0: 706f 6f6c 5f70 6f73 202d 2031 5d2e 6164  pool_pos - 1].ad
+0000fac0: 6472 6573 730a 2020 2020 2020 2020 2020  dress.          
+0000fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fae0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb00: 2023 2067 6574 2074 6865 2069 6e70 7574   # get the input
+0000fb10: 2074 6f6b 656e 2062 7920 7072 6f63 6565   token by procee
+0000fb20: 6469 6e67 2062 6163 6b77 6172 6473 2066  ding backwards f
+0000fb30: 726f 6d0a 2020 2020 2020 2020 2020 2020  rom.            
+0000fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb50: 2320 7468 6520 326e 6420 746f 206c 6173  # the 2nd to las
+0000fb60: 7420 706f 7369 7469 6f6e 2c0a 2020 2020  t position,.    
+0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb80: 2020 2020 2020 2020 2320 652e 672e 2066          # e.g. f
+0000fb90: 6f72 2061 2074 6f6b 656e 3020 2d3e 2074  or a token0 -> t
+0000fba0: 6f6b 656e 3120 2d3e 2074 6f6b 656e 3220  oken1 -> token2 
+0000fbb0: 2d3e 2074 6f6b 656e 330a 2020 2020 2020  -> token3.      
+0000fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbd0: 2020 2020 2020 2320 7377 6170 2070 726f        # swap pro
+0000fbe0: 6365 6564 696e 6720 7468 726f 7567 6820  ceeding through 
+0000fbf0: 706f 6f6c 3020 2d3e 2070 6f6f 6c31 202d  pool0 -> pool1 -
+0000fc00: 3e20 706f 6f6c 322c 0a20 2020 2020 2020  > pool2,.       
 0000fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc20: 2020 2020 2074 785f 6465 6164 6c69 6e65       tx_deadline
-0000fc30: 203d 2066 756e 635f 7061 7261 6d73 5b22   = func_params["
-0000fc40: 6465 6164 6c69 6e65 225d 0a20 2020 2020  deadline"].     
-0000fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc60: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-0000fc70: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc90: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-0000fca0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000fcb0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000fcc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000fcd0: 656c 662e 5f72 6169 7365 5f69 665f 6578  elf._raise_if_ex
-0000fce0: 7069 7265 6428 7478 5f64 6561 646c 696e  pired(tx_deadlin
-0000fcf0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-0000fd00: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000fd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fd20: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
-0000fd30: 6c73 203d 2067 6574 5f76 325f 706f 6f6c  ls = get_v2_pool
-0000fd40: 735f 6672 6f6d 5f74 6f6b 656e 5f70 6174  s_from_token_pat
-0000fd50: 6828 7478 5f70 6174 682c 2073 656c 662e  h(tx_path, self.
-0000fd60: 7632 5f70 6f6f 6c5f 6d61 6e61 6765 7229  v2_pool_manager)
-0000fd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fd80: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000fd90: 284c 6971 7569 6469 7479 506f 6f6c 4572  (LiquidityPoolEr
-0000fda0: 726f 722c 204d 616e 6167 6572 4572 726f  ror, ManagerErro
-0000fdb0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000fdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fdd0: 7261 6973 6520 5472 616e 7361 6374 696f  raise Transactio
-0000fde0: 6e45 7272 6f72 280a 2020 2020 2020 2020  nError(.        
-0000fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe00: 2020 2020 2020 2020 6622 4c69 7175 6964          f"Liquid
-0000fe10: 6974 7950 6f6f 6c20 636f 756c 6420 6e6f  ityPool could no
-0000fe20: 7420 6265 2062 7569 6c74 2066 6f72 2061  t be built for a
-0000fe30: 6c6c 2073 7465 7073 2069 6e20 7061 7468  ll steps in path
-0000fe40: 207b 7478 5f70 6174 687d 220a 2020 2020   {tx_path}".    
-0000fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0000fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe80: 2020 206c 6173 745f 706f 6f6c 5f70 6f73     last_pool_pos
-0000fe90: 203d 206c 656e 2870 6f6f 6c73 2920 2d20   = len(pools) - 
-0000fea0: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
-0000feb0: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-0000fec0: 6f6f 6c5f 706f 732c 2070 6f6f 6c20 696e  ool_pos, pool in
-0000fed0: 2065 6e75 6d65 7261 7465 2870 6f6f 6c73   enumerate(pools
-0000fee0: 5b3a 3a2d 315d 293a 0a20 2020 2020 2020  [::-1]):.       
+0000fc20: 2020 2020 2023 202d 2074 6865 206c 6173       # - the las
+0000fc30: 7420 7377 6170 2028 706f 6f6c 5f70 6f73  t swap (pool_pos
+0000fc40: 203d 2030 2920 7769 6c6c 2068 6176 6520   = 0) will have 
+0000fc50: 7468 6520 696e 7075 7420 746f 6b65 6e0a  the input token.
+0000fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc70: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000fc80: 696e 2074 6865 2073 6563 6f6e 6420 746f  in the second to
+0000fc90: 206c 6173 7420 706f 7369 7469 6f6e 2028   last position (
+0000fca0: 696e 6465 7820 2d32 2c20 746f 6b65 6e32  index -2, token2
+0000fcb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000fcc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000fcd0: 2d20 7468 6520 6d69 6464 6c65 2073 7761  - the middle swa
+0000fce0: 7020 2870 6f6f 6c5f 706f 7320 3d20 3129  p (pool_pos = 1)
+0000fcf0: 2077 696c 6c20 6861 7665 2069 6e70 7574   will have input
+0000fd00: 2074 6f6b 656e 0a20 2020 2020 2020 2020   token.         
+0000fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd20: 2020 2023 2020 2069 6e20 7468 6520 7468     #   in the th
+0000fd30: 6972 6420 746f 206c 6173 7420 706f 7369  ird to last posi
+0000fd40: 7469 6f6e 2028 696e 6465 7820 2d33 2c20  tion (index -3, 
+0000fd50: 746f 6b65 6e31 290a 2020 2020 2020 2020  token1).        
+0000fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd70: 2020 2020 2320 2d20 7468 6520 6669 7273      # - the firs
+0000fd80: 7420 7377 6170 2028 706f 6f6c 5f70 6f73  t swap (pool_pos
+0000fd90: 203d 2032 2920 7769 6c6c 2068 6176 6520   = 2) will have 
+0000fda0: 696e 7075 7420 746f 6b65 6e0a 2020 2020  input token.    
+0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdc0: 2020 2020 2020 2020 2320 2020 696e 2074          #   in t
+0000fdd0: 6865 2066 6f75 7220 746f 206c 6173 7420  he four to last 
+0000fde0: 706f 7369 7469 6f6e 2028 696e 6465 7820  position (index 
+0000fdf0: 2d34 2c20 746f 6b65 6e30 290a 2020 2020  -4, token0).    
+0000fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe10: 2020 2020 2020 2020 5f74 6f6b 656e 5f69          _token_i
+0000fe20: 6e20 3d20 280a 2020 2020 2020 2020 2020  n = (.          
+0000fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe40: 2020 2020 2020 706f 6f6c 2e74 6f6b 656e        pool.token
+0000fe50: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe70: 2020 6966 2070 6f6f 6c2e 746f 6b65 6e30    if pool.token0
+0000fe80: 203d 3d20 7478 5f70 6174 685b 2d32 202d   == tx_path[-2 -
+0000fe90: 2070 6f6f 6c5f 706f 735d 0a20 2020 2020   pool_pos].     
+0000fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000feb0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+0000fec0: 706f 6f6c 2e74 6f6b 656e 310a 2020 2020  pool.token1.    
+0000fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fee0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
 0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 2020 2066 6972 7374 5f73 7761 7020       first_swap 
-0000ff10: 3d20 706f 6f6c 5f70 6f73 203d 3d20 6c61  = pool_pos == la
-0000ff20: 7374 5f70 6f6f 6c5f 706f 730a 2020 2020  st_pool_pos.    
-0000ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff40: 2020 2020 2020 2020 6c61 7374 5f73 7761          last_swa
-0000ff50: 7020 3d20 706f 6f6c 5f70 6f73 203d 3d20  p = pool_pos == 
-0000ff60: 300a 0a20 2020 2020 2020 2020 2020 2020  0..             
-0000ff70: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-0000ff80: 616d 6f75 6e74 5f6f 7574 203d 2074 785f  amount_out = tx_
-0000ff90: 616d 6f75 6e74 5f6f 7574 2069 6620 6c61  amount_out if la
-0000ffa0: 7374 5f73 7761 7020 656c 7365 205f 616d  st_swap else _am
-0000ffb0: 6f75 6e74 5f69 6e0a 2020 2020 2020 2020  ount_in.        
-0000ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffd0: 2020 2020 5f61 6d6f 756e 745f 696e 5f6d      _amount_in_m
-0000ffe0: 6178 203d 2074 785f 616d 6f75 6e74 5f69  ax = tx_amount_i
-0000fff0: 6e5f 6d61 7820 6966 2066 6972 7374 5f73  n_max if first_s
-00010000: 7761 7020 656c 7365 204e 6f6e 650a 0a20  wap else None.. 
+0000ff00: 2020 2020 2020 205f 2c20 5f73 696d 5f72         _, _sim_r
+0000ff10: 6573 756c 7420 3d20 7365 6c66 2e5f 7369  esult = self._si
+0000ff20: 6d75 6c61 7465 5f76 325f 7377 6170 5f65  mulate_v2_swap_e
+0000ff30: 7861 6374 5f6f 7574 280a 2020 2020 2020  xact_out(.      
+0000ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff50: 2020 2020 2020 2020 2020 706f 6f6c 3d70            pool=p
+0000ff60: 6f6f 6c2c 0a20 2020 2020 2020 2020 2020  ool,.           
+0000ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff80: 2020 2020 2072 6563 6970 6965 6e74 3d5f       recipient=_
+0000ff90: 7265 6369 7069 656e 742c 0a20 2020 2020  recipient,.     
+0000ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffb0: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0000ffc0: 5f69 6e3d 5f74 6f6b 656e 5f69 6e2c 0a20  _in=_token_in,. 
+0000ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffe0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000fff0: 6d6f 756e 745f 6f75 743d 5f61 6d6f 756e  mount_out=_amoun
+00010000: 745f 6f75 742c 0a20 2020 2020 2020 2020  t_out,.         
 00010010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010020: 2020 2020 2020 2020 2020 205f 7265 6369             _reci
-00010030: 7069 656e 7420 3d20 280a 2020 2020 2020  pient = (.      
-00010040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010050: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
-00010060: 6970 6965 6e74 2069 6620 6c61 7374 5f73  ipient if last_s
-00010070: 7761 7020 656c 7365 2070 6f6f 6c73 5b3a  wap else pools[:
-00010080: 3a2d 315d 5b70 6f6f 6c5f 706f 7320 2d20  :-1][pool_pos - 
-00010090: 315d 2e61 6464 7265 7373 0a20 2020 2020  1].address.     
+00010020: 2020 2020 2020 2061 6d6f 756e 745f 696e         amount_in
+00010030: 5f6d 6178 3d5f 616d 6f75 6e74 5f69 6e5f  _max=_amount_in_
+00010040: 6d61 782c 0a20 2020 2020 2020 2020 2020  max,.           
+00010050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010060: 2020 2020 2066 6972 7374 5f73 7761 703d       first_swap=
+00010070: 6669 7273 745f 7377 6170 2c0a 2020 2020  first_swap,.    
+00010080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010090: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
 000100a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000100c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100d0: 2020 2020 2020 2320 6765 7420 7468 6520        # get the 
-000100e0: 696e 7075 7420 746f 6b65 6e20 6279 2070  input token by p
-000100f0: 726f 6365 6564 696e 6720 6261 636b 7761  roceeding backwa
-00010100: 7264 7320 6672 6f6d 0a20 2020 2020 2020  rds from.       
+000100b0: 2020 2020 2020 205f 616d 6f75 6e74 5f69         _amount_i
+000100c0: 6e20 3d20 6d61 7828 0a20 2020 2020 2020  n = max(.       
+000100d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100e0: 2020 2020 2020 2020 205f 7369 6d5f 7265           _sim_re
+000100f0: 7375 6c74 2e61 6d6f 756e 7430 5f64 656c  sult.amount0_del
+00010100: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
 00010110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010120: 2020 2020 2023 2074 6865 2032 6e64 2074       # the 2nd t
-00010130: 6f20 6c61 7374 2070 6f73 6974 696f 6e2c  o last position,
-00010140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010150: 2020 2020 2020 2020 2020 2020 2023 2065               # e
-00010160: 2e67 2e20 666f 7220 6120 746f 6b65 6e30  .g. for a token0
-00010170: 202d 3e20 746f 6b65 6e31 202d 3e20 746f   -> token1 -> to
-00010180: 6b65 6e32 202d 3e20 746f 6b65 6e33 0a20  ken2 -> token3. 
+00010120: 2020 2020 5f73 696d 5f72 6573 756c 742e      _sim_result.
+00010130: 616d 6f75 6e74 315f 6465 6c74 612c 0a20  amount1_delta,. 
+00010140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010150: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00010160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010170: 2020 2020 2020 2020 2020 6966 2066 6972            if fir
+00010180: 7374 5f73 7761 703a 0a20 2020 2020 2020  st_swap:.       
 00010190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101a0: 2020 2020 2020 2020 2020 2023 2073 7761             # swa
-000101b0: 7020 7072 6f63 6565 6469 6e67 2074 6872  p proceeding thr
-000101c0: 6f75 6768 2070 6f6f 6c30 202d 3e20 706f  ough pool0 -> po
-000101d0: 6f6c 3120 2d3e 2070 6f6f 6c32 2c0a 2020  ol1 -> pool2,.  
-000101e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101f0: 2020 2020 2020 2020 2020 2320 2d20 7468            # - th
-00010200: 6520 6c61 7374 2073 7761 7020 2870 6f6f  e last swap (poo
-00010210: 6c5f 706f 7320 3d20 3029 2077 696c 6c20  l_pos = 0) will 
-00010220: 6861 7665 2074 6865 2069 6e70 7574 2074  have the input t
-00010230: 6f6b 656e 0a20 2020 2020 2020 2020 2020  oken.           
+000101a0: 2020 2020 2020 2020 2073 656c 662e 6c65           self.le
+000101b0: 6467 6572 2e61 646a 7573 7428 0a20 2020  dger.adjust(.   
+000101c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000101e0: 2073 656c 662e 7365 6e64 6572 2c0a 2020   self.sender,.  
+000101f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010210: 2020 5752 4150 5045 445f 4e41 5449 5645    WRAPPED_NATIVE
+00010220: 5f54 4f4b 454e 535b 7365 6c66 2e63 6861  _TOKENS[self.cha
+00010230: 696e 5f69 645d 2c0a 2020 2020 2020 2020  in_id],.        
 00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010250: 2023 2020 2069 6e20 7468 6520 7365 636f   #   in the seco
-00010260: 6e64 2074 6f20 6c61 7374 2070 6f73 6974  nd to last posit
-00010270: 696f 6e20 2869 6e64 6578 202d 322c 2074  ion (index -2, t
-00010280: 6f6b 656e 3229 0a20 2020 2020 2020 2020  oken2).         
+00010250: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
+00010260: 756e 745f 696e 2c0a 2020 2020 2020 2020  unt_in,.        
+00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010280: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
 00010290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102a0: 2020 2023 202d 2074 6865 206d 6964 646c     # - the middl
-000102b0: 6520 7377 6170 2028 706f 6f6c 5f70 6f73  e swap (pool_pos
-000102c0: 203d 2031 2920 7769 6c6c 2068 6176 6520   = 1) will have 
-000102d0: 696e 7075 7420 746f 6b65 6e0a 2020 2020  input token.    
+000102a0: 2020 2020 2020 2073 656c 662e 7369 6d75         self.simu
+000102b0: 6c61 7465 645f 706f 6f6c 5f73 7461 7465  lated_pool_state
+000102c0: 732e 6170 7065 6e64 2828 706f 6f6c 2c20  s.append((pool, 
+000102d0: 5f73 696d 5f72 6573 756c 7429 290a 0a20  _sim_result)).. 
 000102e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102f0: 2020 2020 2020 2020 2320 2020 696e 2074          #   in t
-00010300: 6865 2074 6869 7264 2074 6f20 6c61 7374  he third to last
-00010310: 2070 6f73 6974 696f 6e20 2869 6e64 6578   position (index
-00010320: 202d 332c 2074 6f6b 656e 3129 0a20 2020   -3, token1).   
-00010330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010340: 2020 2020 2020 2020 2023 202d 2074 6865           # - the
-00010350: 2066 6972 7374 2073 7761 7020 2870 6f6f   first swap (poo
-00010360: 6c5f 706f 7320 3d20 3229 2077 696c 6c20  l_pos = 2) will 
-00010370: 6861 7665 2069 6e70 7574 2074 6f6b 656e  have input token
-00010380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010390: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-000103a0: 2069 6e20 7468 6520 666f 7572 2074 6f20   in the four to 
-000103b0: 6c61 7374 2070 6f73 6974 696f 6e20 2869  last position (i
-000103c0: 6e64 6578 202d 342c 2074 6f6b 656e 3029  ndex -4, token0)
-000103d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000103e0: 2020 2020 2020 2020 2020 2020 205f 746f               _to
-000103f0: 6b65 6e5f 696e 203d 2028 0a20 2020 2020  ken_in = (.     
-00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2020 2020 2020 2020 2020 2070 6f6f 6c2e             pool.
-00010420: 746f 6b65 6e30 0a20 2020 2020 2020 2020  token0.         
-00010430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010440: 2020 2020 2020 2069 6620 706f 6f6c 2e74         if pool.t
-00010450: 6f6b 656e 3020 3d3d 2074 785f 7061 7468  oken0 == tx_path
-00010460: 5b2d 3220 2d20 706f 6f6c 5f70 6f73 5d0a  [-2 - pool_pos].
-00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010490: 656c 7365 2070 6f6f 6c2e 746f 6b65 6e31  else pool.token1
-000104a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000104b0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104d0: 2020 2020 2020 2020 2020 2020 5f2c 205f              _, _
-000104e0: 7369 6d5f 7265 7375 6c74 203d 2073 656c  sim_result = sel
-000104f0: 662e 5f73 696d 756c 6174 655f 7632 5f73  f._simulate_v2_s
-00010500: 7761 705f 6578 6163 745f 6f75 7428 0a20  wap_exact_out(. 
-00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010520: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00010530: 6f6f 6c3d 706f 6f6c 2c0a 2020 2020 2020  ool=pool,.      
+000102f0: 2020 2063 6173 6520 2261 6464 4c69 7175     case "addLiqu
+00010300: 6964 6974 7922 207c 2022 6164 644c 6971  idity" | "addLiq
+00010310: 7569 6469 7479 4554 4822 3a0a 2020 2020  uidityETH":.    
+00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010330: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00010340: 2866 227b 6675 6e63 5f6e 616d 657d 3a20  (f"{func_name}: 
+00010350: 7b73 656c 662e 6861 7368 2e68 6578 2829  {self.hash.hex()
+00010360: 3d7d 2229 0a0a 2020 2020 2020 2020 2020  =}")..          
+00010370: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010380: 2066 756e 635f 6e61 6d65 203d 3d20 2261   func_name == "a
+00010390: 6464 4c69 7175 6964 6974 7922 3a0a 2020  ddLiquidity":.  
+000103a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103b0: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
+000103c0: 656e 5f61 203d 2074 6f5f 6368 6563 6b73  en_a = to_checks
+000103d0: 756d 5f61 6464 7265 7373 2866 756e 635f  um_address(func_
+000103e0: 7061 7261 6d73 5b22 746f 6b65 6e41 225d  params["tokenA"]
+000103f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010400: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00010410: 5f74 6f6b 656e 5f62 203d 2074 6f5f 6368  _token_b = to_ch
+00010420: 6563 6b73 756d 5f61 6464 7265 7373 2866  ecksum_address(f
+00010430: 756e 635f 7061 7261 6d73 5b22 746f 6b65  unc_params["toke
+00010440: 6e42 225d 290a 2020 2020 2020 2020 2020  nB"]).          
+00010450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010460: 2020 7478 5f74 6f6b 656e 5f61 6d6f 756e    tx_token_amoun
+00010470: 745f 6120 3d20 6675 6e63 5f70 6172 616d  t_a = func_param
+00010480: 735b 2261 6d6f 756e 7441 4465 7369 7265  s["amountADesire
+00010490: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+000104a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104b0: 7478 5f74 6f6b 656e 5f61 6d6f 756e 745f  tx_token_amount_
+000104c0: 6220 3d20 6675 6e63 5f70 6172 616d 735b  b = func_params[
+000104d0: 2261 6d6f 756e 7442 4465 7369 7265 6422  "amountBDesired"
+000104e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000104f0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00010500: 5f74 6f6b 656e 5f61 6d6f 756e 745f 615f  _token_amount_a_
+00010510: 6d69 6e20 3d20 6675 6e63 5f70 6172 616d  min = func_param
+00010520: 735b 2261 6d6f 756e 7441 4d69 6e22 5d20  s["amountAMin"] 
+00010530: 2023 206e 6f71 613a 2046 3834 310a 2020   # noqa: F841.  
 00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010550: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00010560: 656e 743d 5f72 6563 6970 6965 6e74 2c0a  ent=_recipient,.
-00010570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 746f 6b65 6e5f 696e 3d5f 746f 6b65 6e5f  token_in=_token_
-000105a0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-000105b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105c0: 2020 2020 616d 6f75 6e74 5f6f 7574 3d5f      amount_out=_
-000105d0: 616d 6f75 6e74 5f6f 7574 2c0a 2020 2020  amount_out,.    
+00010550: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
+00010560: 656e 5f61 6d6f 756e 745f 625f 6d69 6e20  en_amount_b_min 
+00010570: 3d20 6675 6e63 5f70 6172 616d 735b 2261  = func_params["a
+00010580: 6d6f 756e 7442 4d69 6e22 5d20 2023 206e  mountBMin"]  # n
+00010590: 6f71 613a 2046 3834 310a 2020 2020 2020  oqa: F841.      
+000105a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105b0: 2020 2020 2020 746f 6b65 6e30 5f61 6464        token0_add
+000105c0: 7265 7373 2c20 746f 6b65 6e31 5f61 6464  ress, token1_add
+000105d0: 7265 7373 203d 2028 0a20 2020 2020 2020  ress = (.       
 000105e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105f0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-00010600: 6e74 5f69 6e5f 6d61 783d 5f61 6d6f 756e  nt_in_max=_amoun
-00010610: 745f 696e 5f6d 6178 2c0a 2020 2020 2020  t_in_max,.      
+000105f0: 2020 2020 2020 2020 2028 7478 5f74 6f6b           (tx_tok
+00010600: 656e 5f61 2c20 7478 5f74 6f6b 656e 5f62  en_a, tx_token_b
+00010610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00010620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010630: 2020 2020 2020 2020 2020 6669 7273 745f            first_
-00010640: 7377 6170 3d66 6972 7374 5f73 7761 702c  swap=first_swap,
-00010650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010660: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00010670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010680: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
-00010690: 756e 745f 696e 203d 206d 6178 280a 2020  unt_in = max(.  
-000106a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106b0: 2020 2020 2020 2020 2020 2020 2020 5f73                _s
-000106c0: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
-000106d0: 305f 6465 6c74 612c 0a20 2020 2020 2020  0_delta,.       
-000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106f0: 2020 2020 2020 2020 205f 7369 6d5f 7265           _sim_re
-00010700: 7375 6c74 2e61 6d6f 756e 7431 5f64 656c  sult.amount1_del
-00010710: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010730: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00010740: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00010750: 6620 6669 7273 745f 7377 6170 3a0a 2020  f first_swap:.  
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010780: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
-00010790: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107b0: 2020 2020 2020 7365 6c66 2e73 656e 6465        self.sende
-000107c0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107e0: 2020 2020 2020 2057 5241 5050 4544 5f4e         WRAPPED_N
-000107f0: 4154 4956 455f 544f 4b45 4e53 5b73 656c  ATIVE_TOKENS[sel
-00010800: 662e 6368 6169 6e5f 6964 5d2c 0a20 2020  f.chain_id],.   
+00010630: 2020 6966 2074 785f 746f 6b65 6e5f 6120    if tx_token_a 
+00010640: 3c20 7478 5f74 6f6b 656e 5f62 0a20 2020  < tx_token_b.   
+00010650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010660: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00010670: 6520 2874 785f 746f 6b65 6e5f 622c 2074  e (tx_token_b, t
+00010680: 785f 746f 6b65 6e5f 6129 0a20 2020 2020  x_token_a).     
+00010690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000106b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106c0: 2020 2020 2074 6f6b 656e 305f 616d 6f75       token0_amou
+000106d0: 6e74 2c20 746f 6b65 6e31 5f61 6d6f 756e  nt, token1_amoun
+000106e0: 7420 3d20 280a 2020 2020 2020 2020 2020  t = (.          
+000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010700: 2020 2020 2020 2874 785f 746f 6b65 6e5f        (tx_token_
+00010710: 616d 6f75 6e74 5f61 2c20 7478 5f74 6f6b  amount_a, tx_tok
+00010720: 656e 5f61 6d6f 756e 745f 6229 0a20 2020  en_amount_b).   
+00010730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010740: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00010750: 7478 5f74 6f6b 656e 5f61 203c 2074 785f  tx_token_a < tx_
+00010760: 746f 6b65 6e5f 620a 2020 2020 2020 2020  token_b.        
+00010770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010780: 2020 2020 2020 2020 656c 7365 2028 7478          else (tx
+00010790: 5f74 6f6b 656e 5f61 6d6f 756e 745f 622c  _token_amount_b,
+000107a0: 2074 785f 746f 6b65 6e5f 616d 6f75 6e74   tx_token_amount
+000107b0: 5f61 290a 2020 2020 2020 2020 2020 2020  _a).            
+000107c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000107e0: 2020 2020 2020 2020 2020 656c 6966 2066            elif f
+000107f0: 756e 635f 6e61 6d65 203d 3d20 2261 6464  unc_name == "add
+00010800: 4c69 7175 6964 6974 7945 5448 223a 0a20  LiquidityETH":. 
 00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010830: 205f 616d 6f75 6e74 5f69 6e2c 0a20 2020   _amount_in,.   
-00010840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010850: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00010820: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
+00010830: 6b65 6e20 3d20 746f 5f63 6865 636b 7375  ken = to_checksu
+00010840: 6d5f 6164 6472 6573 7328 6675 6e63 5f70  m_address(func_p
+00010850: 6172 616d 735b 2274 6f6b 656e 225d 290a  arams["token"]).
 00010860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010870: 2020 2020 2020 2020 2020 2020 5f76 325f              _v2_
-00010880: 726f 7574 6572 5f66 7574 7572 655f 706f  router_future_po
-00010890: 6f6c 5f73 7461 7465 732e 6170 7065 6e64  ol_states.append
-000108a0: 2828 706f 6f6c 2c20 5f73 696d 5f72 6573  ((pool, _sim_res
-000108b0: 756c 7429 290a 0a20 2020 2020 2020 2020  ult))..         
-000108c0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-000108d0: 2261 6464 4c69 7175 6964 6974 7922 207c  "addLiquidity" |
-000108e0: 2022 6164 644c 6971 7569 6469 7479 4554   "addLiquidityET
-000108f0: 4822 3a0a 2020 2020 2020 2020 2020 2020  H":.            
-00010900: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00010910: 6572 2e64 6562 7567 2866 227b 6675 6e63  er.debug(f"{func
-00010920: 5f6e 616d 657d 3a20 7b73 656c 662e 6861  _name}: {self.ha
-00010930: 7368 2e68 6578 2829 3d7d 2229 0a0a 2020  sh.hex()=}")..  
-00010940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010950: 2020 2020 2020 6966 2066 756e 635f 6e61        if func_na
-00010960: 6d65 203d 3d20 2261 6464 4c69 7175 6964  me == "addLiquid
-00010970: 6974 7922 3a0a 2020 2020 2020 2020 2020  ity":.          
-00010980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010990: 2020 7478 5f74 6f6b 656e 5f61 203d 2074    tx_token_a = t
-000109a0: 6f5f 6368 6563 6b73 756d 5f61 6464 7265  o_checksum_addre
-000109b0: 7373 2866 756e 635f 7061 7261 6d73 5b22  ss(func_params["
-000109c0: 746f 6b65 6e41 225d 290a 2020 2020 2020  tokenA"]).      
-000109d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109e0: 2020 2020 2020 7478 5f74 6f6b 656e 5f62        tx_token_b
-000109f0: 203d 2074 6f5f 6368 6563 6b73 756d 5f61   = to_checksum_a
-00010a00: 6464 7265 7373 2866 756e 635f 7061 7261  ddress(func_para
-00010a10: 6d73 5b22 746f 6b65 6e42 225d 290a 2020  ms["tokenB"]).  
-00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a30: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
-00010a40: 656e 5f61 6d6f 756e 745f 6120 3d20 6675  en_amount_a = fu
-00010a50: 6e63 5f70 6172 616d 735b 2261 6d6f 756e  nc_params["amoun
-00010a60: 7441 4465 7369 7265 6422 5d0a 2020 2020  tADesired"].    
-00010a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a80: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
-00010a90: 5f61 6d6f 756e 745f 6220 3d20 6675 6e63  _amount_b = func
-00010aa0: 5f70 6172 616d 735b 2261 6d6f 756e 7442  _params["amountB
-00010ab0: 4465 7369 7265 6422 5d0a 2020 2020 2020  Desired"].      
+00010870: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
+00010880: 6f6b 656e 5f61 6d6f 756e 7420 3d20 6675  oken_amount = fu
+00010890: 6e63 5f70 6172 616d 735b 2261 6d6f 756e  nc_params["amoun
+000108a0: 7454 6f6b 656e 4465 7369 7265 6422 5d0a  tTokenDesired"].
+000108b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108c0: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
+000108d0: 6f6b 656e 5f61 6d6f 756e 745f 6d69 6e20  oken_amount_min 
+000108e0: 3d20 6675 6e63 5f70 6172 616d 735b 2261  = func_params["a
+000108f0: 6d6f 756e 7454 6f6b 656e 4d69 6e22 5d20  mountTokenMin"] 
+00010900: 2023 206e 6f71 613a 2046 3834 310a 2020   # noqa: F841.  
+00010910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010920: 2020 2020 2020 2020 2020 7478 5f65 7468            tx_eth
+00010930: 5f6d 696e 203d 2066 756e 635f 7061 7261  _min = func_para
+00010940: 6d73 5b22 616d 6f75 6e74 4554 484d 696e  ms["amountETHMin
+00010950: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00010960: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00010970: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
+00010980: 6472 6573 7320 3d20 5752 4150 5045 445f  dress = WRAPPED_
+00010990: 4e41 5449 5645 5f54 4f4b 454e 535b 7365  NATIVE_TOKENS[se
+000109a0: 6c66 2e63 6861 696e 5f69 645d 0a20 2020  lf.chain_id].   
+000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109c0: 2020 2020 2020 2020 2074 6f6b 656e 305f           token0_
+000109d0: 6164 6472 6573 732c 2074 6f6b 656e 315f  address, token1_
+000109e0: 6164 6472 6573 7320 3d20 280a 2020 2020  address = (.    
+000109f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a00: 2020 2020 2020 2020 2020 2020 285f 7772              (_wr
+00010a10: 6170 7065 645f 746f 6b65 6e5f 6164 6472  apped_token_addr
+00010a20: 6573 732c 2074 785f 746f 6b65 6e29 0a20  ess, tx_token). 
+00010a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010a50: 6620 5f77 7261 7070 6564 5f74 6f6b 656e  f _wrapped_token
+00010a60: 5f61 6464 7265 7373 203c 2074 785f 746f  _address < tx_to
+00010a70: 6b65 6e0a 2020 2020 2020 2020 2020 2020  ken.            
+00010a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a90: 2020 2020 656c 7365 2028 7478 5f74 6f6b      else (tx_tok
+00010aa0: 656e 2c20 5f77 7261 7070 6564 5f74 6f6b  en, _wrapped_tok
+00010ab0: 656e 5f61 6464 7265 7373 290a 2020 2020  en_address).    
 00010ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ad0: 2020 2020 2020 2320 666d 743a 206f 6666        # fmt: off
-00010ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010af0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00010b00: 746f 6b65 6e5f 616d 6f75 6e74 5f61 5f6d  token_amount_a_m
-00010b10: 696e 203d 2066 756e 635f 7061 7261 6d73  in = func_params
-00010b20: 5b22 616d 6f75 6e74 414d 696e 225d 2020  ["amountAMin"]  
-00010b30: 2320 6e6f 7161 3a20 4638 3431 0a20 2020  # noqa: F841.   
-00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b50: 2020 2020 2020 2020 2074 785f 746f 6b65           tx_toke
-00010b60: 6e5f 616d 6f75 6e74 5f62 5f6d 696e 203d  n_amount_b_min =
-00010b70: 2066 756e 635f 7061 7261 6d73 5b22 616d   func_params["am
-00010b80: 6f75 6e74 424d 696e 225d 2020 2320 6e6f  ountBMin"]  # no
-00010b90: 7161 3a20 4638 3431 0a20 2020 2020 2020  qa: F841.       
+00010ad0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00010ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010af0: 2020 2020 2020 746f 6b65 6e30 5f61 6d6f        token0_amo
+00010b00: 756e 742c 2074 6f6b 656e 315f 616d 6f75  unt, token1_amou
+00010b10: 6e74 203d 2028 0a20 2020 2020 2020 2020  nt = (.         
+00010b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b30: 2020 2020 2020 2028 7478 5f65 7468 5f6d         (tx_eth_m
+00010b40: 696e 2c20 7478 5f74 6f6b 656e 5f61 6d6f  in, tx_token_amo
+00010b50: 756e 7429 0a20 2020 2020 2020 2020 2020  unt).           
+00010b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b70: 2020 2020 2069 6620 5f77 7261 7070 6564       if _wrapped
+00010b80: 5f74 6f6b 656e 5f61 6464 7265 7373 203c  _token_address <
+00010b90: 2074 785f 746f 6b65 6e0a 2020 2020 2020   tx_token.      
 00010ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bb0: 2020 2020 2023 2066 6d74 3a20 6f6e 0a20       # fmt: on. 
-00010bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bd0: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-00010be0: 305f 6164 6472 6573 732c 2074 6f6b 656e  0_address, token
-00010bf0: 315f 6164 6472 6573 7320 3d20 280a 2020  1_address = (.  
+00010bb0: 2020 2020 2020 2020 2020 656c 7365 2028            else (
+00010bc0: 7478 5f74 6f6b 656e 5f61 6d6f 756e 742c  tx_token_amount,
+00010bd0: 2074 785f 6574 685f 6d69 6e29 0a20 2020   tx_eth_min).   
+00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bf0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
 00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c10: 2020 2020 2020 2020 2020 2020 2020 2874                (t
-00010c20: 785f 746f 6b65 6e5f 612c 2074 785f 746f  x_token_a, tx_to
-00010c30: 6b65 6e5f 6229 0a20 2020 2020 2020 2020  ken_b).         
+00010c10: 2020 2020 7478 5f74 6f20 3d20 6675 6e63      tx_to = func
+00010c20: 5f70 6172 616d 735b 2274 6f22 5d20 2023  _params["to"]  #
+00010c30: 206e 6f71 613a 2046 3834 310a 2020 2020   noqa: F841.    
 00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 2020 2020 2020 2069 6620 7478 5f74 6f6b         if tx_tok
-00010c60: 656e 5f61 203c 2074 785f 746f 6b65 6e5f  en_a < tx_token_
-00010c70: 620a 2020 2020 2020 2020 2020 2020 2020  b.              
+00010c50: 2020 2020 7478 5f64 6561 646c 696e 6520      tx_deadline 
+00010c60: 3d20 6675 6e63 5f70 6172 616d 735b 2264  = func_params["d
+00010c70: 6561 646c 696e 6522 5d0a 2020 2020 2020  eadline"].      
 00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c90: 2020 656c 7365 2028 7478 5f74 6f6b 656e    else (tx_token
-00010ca0: 5f62 2c20 7478 5f74 6f6b 656e 5f61 290a  _b, tx_token_a).
-00010cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00010cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ce0: 2020 2020 2020 2020 2020 746f 6b65 6e30            token0
-00010cf0: 5f61 6d6f 756e 742c 2074 6f6b 656e 315f  _amount, token1_
-00010d00: 616d 6f75 6e74 203d 2028 0a20 2020 2020  amount = (.     
-00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d20: 2020 2020 2020 2020 2020 2028 7478 5f74             (tx_t
-00010d30: 6f6b 656e 5f61 6d6f 756e 745f 612c 2074  oken_amount_a, t
-00010d40: 785f 746f 6b65 6e5f 616d 6f75 6e74 5f62  x_token_amount_b
-00010d50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d70: 2020 6966 2074 785f 746f 6b65 6e5f 6120    if tx_token_a 
-00010d80: 3c20 7478 5f74 6f6b 656e 5f62 0a20 2020  < tx_token_b.   
-00010d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010da0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00010db0: 6520 2874 785f 746f 6b65 6e5f 616d 6f75  e (tx_token_amou
-00010dc0: 6e74 5f62 2c20 7478 5f74 6f6b 656e 5f61  nt_b, tx_token_a
-00010dd0: 6d6f 756e 745f 6129 0a20 2020 2020 2020  mount_a).       
-00010de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010df0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00010e00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00010e10: 6c69 6620 6675 6e63 5f6e 616d 6520 3d3d  lif func_name ==
-00010e20: 2022 6164 644c 6971 7569 6469 7479 4554   "addLiquidityET
-00010e30: 4822 3a0a 2020 2020 2020 2020 2020 2020  H":.            
-00010e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e50: 7478 5f74 6f6b 656e 203d 2074 6f5f 6368  tx_token = to_ch
-00010e60: 6563 6b73 756d 5f61 6464 7265 7373 2866  ecksum_address(f
-00010e70: 756e 635f 7061 7261 6d73 5b22 746f 6b65  unc_params["toke
-00010e80: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
-00010e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ea0: 2074 785f 746f 6b65 6e5f 616d 6f75 6e74   tx_token_amount
-00010eb0: 203d 2066 756e 635f 7061 7261 6d73 5b22   = func_params["
-00010ec0: 616d 6f75 6e74 546f 6b65 6e44 6573 6972  amountTokenDesir
-00010ed0: 6564 225d 0a20 2020 2020 2020 2020 2020  ed"].           
+00010c90: 2020 7365 6c66 2e5f 7261 6973 655f 6966    self._raise_if
+00010ca0: 5f70 6173 745f 6465 6164 6c69 6e65 2874  _past_deadline(t
+00010cb0: 785f 6465 6164 6c69 6e65 290a 0a20 2020  x_deadline)..   
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cd0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00010ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cf0: 2020 2020 2020 5f70 6f6f 6c20 3d20 7365        _pool = se
+00010d00: 6c66 2e76 325f 706f 6f6c 5f6d 616e 6167  lf.v2_pool_manag
+00010d10: 6572 2e67 6574 5f70 6f6f 6c28 0a20 2020  er.get_pool(.   
+00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d30: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+00010d40: 656e 5f61 6464 7265 7373 6573 3d28 746f  en_addresses=(to
+00010d50: 6b65 6e30 5f61 6464 7265 7373 2c20 746f  ken0_address, to
+00010d60: 6b65 6e31 5f61 6464 7265 7373 292c 0a20  ken1_address),. 
+00010d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010d90: 696c 656e 743d 7365 6c66 2e73 696c 656e  ilent=self.silen
+00010da0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00010db0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00010dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010dd0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00010de0: 4d61 6e61 6765 7245 7272 6f72 3a0a 2020  ManagerError:.  
+00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e00: 2020 2020 2020 2020 2020 5f70 6f6f 6c20            _pool 
+00010e10: 3d20 4c69 7175 6964 6974 7950 6f6f 6c28  = LiquidityPool(
+00010e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e40: 2061 6464 7265 7373 3d67 656e 6572 6174   address=generat
+00010e50: 655f 7632 5f70 6f6f 6c5f 6164 6472 6573  e_v2_pool_addres
+00010e60: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00010e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e80: 2020 2020 2020 2074 6f6b 656e 5f61 6464         token_add
+00010e90: 7265 7373 6573 3d28 0a20 2020 2020 2020  resses=(.       
+00010ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ec0: 2074 6f6b 656e 305f 6164 6472 6573 732c   token0_address,
+00010ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00010ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ef0: 2023 2066 6d74 3a20 6f66 660a 2020 2020   # fmt: off.    
-00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f10: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
-00010f20: 5f61 6d6f 756e 745f 6d69 6e20 3d20 6675  _amount_min = fu
-00010f30: 6e63 5f70 6172 616d 735b 2261 6d6f 756e  nc_params["amoun
-00010f40: 7454 6f6b 656e 4d69 6e22 5d20 2023 206e  tTokenMin"]  # n
-00010f50: 6f71 613a 2046 3834 310a 2020 2020 2020  oqa: F841.      
-00010f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f70: 2020 2020 2020 2320 666d 743a 206f 6e0a        # fmt: on.
-00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f90: 2020 2020 2020 2020 2020 2020 7478 5f65              tx_e
-00010fa0: 7468 5f6d 696e 203d 2066 756e 635f 7061  th_min = func_pa
-00010fb0: 7261 6d73 5b22 616d 6f75 6e74 4554 484d  rams["amountETHM
-00010fc0: 696e 225d 0a20 2020 2020 2020 2020 2020  in"].           
-00010fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fe0: 205f 7772 6170 7065 645f 746f 6b65 6e5f   _wrapped_token_
-00010ff0: 6164 6472 6573 7320 3d20 5752 4150 5045  address = WRAPPE
-00011000: 445f 4e41 5449 5645 5f54 4f4b 454e 535b  D_NATIVE_TOKENS[
-00011010: 7365 6c66 2e63 6861 696e 5f69 645d 0a20  self.chain_id]. 
-00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
-00011040: 305f 6164 6472 6573 732c 2074 6f6b 656e  0_address, token
-00011050: 315f 6164 6472 6573 7320 3d20 280a 2020  1_address = (.  
-00011060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011070: 2020 2020 2020 2020 2020 2020 2020 285f                (_
-00011080: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
-00011090: 6472 6573 732c 2074 785f 746f 6b65 6e29  dress, tx_token)
-000110a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000110b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110c0: 2069 6620 5f77 7261 7070 6564 5f74 6f6b   if _wrapped_tok
-000110d0: 656e 5f61 6464 7265 7373 203c 2074 785f  en_address < tx_
-000110e0: 746f 6b65 6e0a 2020 2020 2020 2020 2020  token.          
+00010ef0: 2020 2020 2020 2020 2074 6f6b 656e 315f           token1_
+00010f00: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+00010f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f20: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00010f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f50: 2020 2020 6661 6374 6f72 795f 6164 6472      factory_addr
+00010f60: 6573 733d 7365 6c66 2e76 325f 706f 6f6c  ess=self.v2_pool
+00010f70: 5f6d 616e 6167 6572 2e5f 6661 6374 6f72  _manager._factor
+00010f80: 795f 6164 6472 6573 732c 0a20 2020 2020  y_address,.     
+00010f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010fb0: 6e69 745f 6861 7368 3d73 656c 662e 7632  nit_hash=self.v2
+00010fc0: 5f70 6f6f 6c5f 6d61 6e61 6765 722e 5f66  _pool_manager._f
+00010fd0: 6163 746f 7279 5f69 6e69 745f 6861 7368  actory_init_hash
+00010fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011000: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00011010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011020: 2020 2020 2074 6f6b 656e 733d 5b0a 2020       tokens=[.  
+00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011050: 2020 7365 6c66 2e76 325f 706f 6f6c 5f6d    self.v2_pool_m
+00011060: 616e 6167 6572 2e5f 746f 6b65 6e5f 6d61  anager._token_ma
+00011070: 6e61 6765 722e 6765 745f 6572 6332 3074  nager.get_erc20t
+00011080: 6f6b 656e 280a 2020 2020 2020 2020 2020  oken(.          
+00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110a0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000110b0: 6b65 6e30 5f61 6464 7265 7373 0a20 2020  ken0_address.   
+000110c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110e0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
 000110f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011100: 2020 2020 2020 656c 7365 2028 7478 5f74        else (tx_t
-00011110: 6f6b 656e 2c20 5f77 7261 7070 6564 5f74  oken, _wrapped_t
-00011120: 6f6b 656e 5f61 6464 7265 7373 290a 2020  oken_address).  
-00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011140: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00011100: 2020 2020 2020 2020 7365 6c66 2e76 325f          self.v2_
+00011110: 706f 6f6c 5f6d 616e 6167 6572 2e5f 746f  pool_manager._to
+00011120: 6b65 6e5f 6d61 6e61 6765 722e 6765 745f  ken_manager.get_
+00011130: 6572 6332 3074 6f6b 656e 280a 2020 2020  erc20token(.    
+00011140: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011160: 2020 2020 2020 2020 746f 6b65 6e30 5f61          token0_a
-00011170: 6d6f 756e 742c 2074 6f6b 656e 315f 616d  mount, token1_am
-00011180: 6f75 6e74 203d 2028 0a20 2020 2020 2020  ount = (.       
-00011190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111a0: 2020 2020 2020 2020 2028 7478 5f65 7468           (tx_eth
-000111b0: 5f6d 696e 2c20 7478 5f74 6f6b 656e 5f61  _min, tx_token_a
-000111c0: 6d6f 756e 7429 0a20 2020 2020 2020 2020  mount).         
-000111d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111e0: 2020 2020 2020 2069 6620 5f77 7261 7070         if _wrapp
-000111f0: 6564 5f74 6f6b 656e 5f61 6464 7265 7373  ed_token_address
-00011200: 203c 2074 785f 746f 6b65 6e0a 2020 2020   < tx_token.    
-00011210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011220: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00011230: 2028 7478 5f74 6f6b 656e 5f61 6d6f 756e   (tx_token_amoun
-00011240: 742c 2074 785f 6574 685f 6d69 6e29 0a20  t, tx_eth_min). 
-00011250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011260: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00011160: 2020 2020 746f 6b65 6e31 5f61 6464 7265      token1_addre
+00011170: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011190: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111b0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111d0: 2020 2020 2020 2020 2020 2020 2066 6163               fac
+000111e0: 746f 7279 5f61 6464 7265 7373 3d73 656c  tory_address=sel
+000111f0: 662e 7632 5f70 6f6f 6c5f 6d61 6e61 6765  f.v2_pool_manage
+00011200: 722e 5f66 6163 746f 7279 5f61 6464 7265  r._factory_addre
+00011210: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00011220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011230: 2020 2020 6661 6374 6f72 795f 696e 6974      factory_init
+00011240: 5f68 6173 683d 7365 6c66 2e76 325f 706f  _hash=self.v2_po
+00011250: 6f6c 5f6d 616e 6167 6572 2e5f 6661 6374  ol_manager._fact
+00011260: 6f72 795f 696e 6974 5f68 6173 682c 0a20  ory_init_hash,. 
 00011270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011280: 2020 2020 2020 7478 5f74 6f20 3d20 6675        tx_to = fu
-00011290: 6e63 5f70 6172 616d 735b 2274 6f22 5d20  nc_params["to"] 
-000112a0: 2023 206e 6f71 613a 2046 3834 310a 2020   # noqa: F841.  
-000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112c0: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
-000112d0: 6520 3d20 6675 6e63 5f70 6172 616d 735b  e = func_params[
-000112e0: 2264 6561 646c 696e 6522 5d0a 2020 2020  "deadline"].    
+00011280: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011290: 6d70 7479 3d54 7275 652c 0a20 2020 2020  mpty=True,.     
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 2020 2020 2020 2020 2020 2073 696c 656e             silen
+000112c0: 743d 7365 6c66 2e73 696c 656e 742c 0a20  t=self.silent,. 
+000112d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112e0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
 000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011300: 2020 2020 7365 6c66 2e5f 7261 6973 655f      self._raise_
-00011310: 6966 5f65 7870 6972 6564 2874 785f 6465  if_expired(tx_de
-00011320: 6164 6c69 6e65 290a 0a20 2020 2020 2020  adline)..       
-00011330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011340: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00011350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011360: 2020 5f70 6f6f 6c20 3d20 7365 6c66 2e76    _pool = self.v
-00011370: 325f 706f 6f6c 5f6d 616e 6167 6572 2e67  2_pool_manager.g
-00011380: 6574 5f70 6f6f 6c28 0a20 2020 2020 2020  et_pool(.       
-00011390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113a0: 2020 2020 2020 2020 2074 6f6b 656e 5f61           token_a
-000113b0: 6464 7265 7373 6573 3d28 746f 6b65 6e30  ddresses=(token0
-000113c0: 5f61 6464 7265 7373 2c20 746f 6b65 6e31  _address, token1
-000113d0: 5f61 6464 7265 7373 292c 0a20 2020 2020  _address),.     
+00011300: 2020 2020 2020 5f73 696d 5f72 6573 756c        _sim_resul
+00011310: 7420 3d20 7365 6c66 2e5f 7369 6d75 6c61  t = self._simula
+00011320: 7465 5f76 325f 6164 645f 6c69 7175 6964  te_v2_add_liquid
+00011330: 6974 7928 0a20 2020 2020 2020 2020 2020  ity(.           
+00011340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011350: 2070 6f6f 6c3d 5f70 6f6f 6c2c 0a20 2020   pool=_pool,.   
+00011360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011370: 2020 2020 2020 2020 2061 6464 6564 5f72           added_r
+00011380: 6573 6572 7665 735f 746f 6b65 6e30 3d74  eserves_token0=t
+00011390: 6f6b 656e 305f 616d 6f75 6e74 2c0a 2020  oken0_amount,.  
+000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113b0: 2020 2020 2020 2020 2020 6164 6465 645f            added_
+000113c0: 7265 7365 7276 6573 5f74 6f6b 656e 313d  reserves_token1=
+000113d0: 746f 6b65 6e31 5f61 6d6f 756e 742c 0a20  token1_amount,. 
 000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113f0: 2020 2020 2020 2020 2020 2073 696c 656e             silen
-00011400: 743d 7365 6c66 2e73 696c 656e 742c 0a20  t=self.silent,. 
-00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011420: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00011430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011440: 2020 2020 2065 7863 6570 7420 4d61 6e61       except Mana
-00011450: 6765 7245 7272 6f72 3a0a 2020 2020 2020  gerError:.      
+000113f0: 2020 2020 2020 2020 2020 206f 7665 7272             overr
+00011400: 6964 655f 7374 6174 653d 556e 6973 7761  ide_state=Uniswa
+00011410: 7056 3250 6f6f 6c53 7461 7465 280a 2020  pV2PoolState(.  
+00011420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011430: 2020 2020 2020 2020 2020 2020 2020 706f                po
+00011440: 6f6c 3d5f 706f 6f6c 2e61 6464 7265 7373  ol=_pool.address
+00011450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011470: 2020 2020 2020 5f70 6f6f 6c20 3d20 4c69        _pool = Li
-00011480: 7175 6964 6974 7950 6f6f 6c28 0a20 2020  quidityPool(.   
+00011470: 2020 7265 7365 7276 6573 5f74 6f6b 656e    reserves_token
+00011480: 303d 302c 0a20 2020 2020 2020 2020 2020  0=0,.           
 00011490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114a0: 2020 2020 2020 2020 2020 2020 2061 6464               add
-000114b0: 7265 7373 3d67 656e 6572 6174 655f 7632  ress=generate_v2
-000114c0: 5f70 6f6f 6c5f 6164 6472 6573 7328 0a20  _pool_address(. 
-000114d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114f0: 2020 2074 6f6b 656e 5f61 6464 7265 7373     token_address
-00011500: 6573 3d28 0a20 2020 2020 2020 2020 2020  es=(.           
-00011510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011520: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-00011530: 656e 305f 6164 6472 6573 732c 0a20 2020  en0_address,.   
-00011540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011560: 2020 2020 2074 6f6b 656e 315f 6164 6472       token1_addr
-00011570: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011590: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-000115a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115c0: 6661 6374 6f72 795f 6164 6472 6573 733d  factory_address=
-000115d0: 7365 6c66 2e76 325f 706f 6f6c 5f6d 616e  self.v2_pool_man
-000115e0: 6167 6572 2e5f 6661 6374 6f72 795f 6164  ager._factory_ad
-000115f0: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-00011600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011610: 2020 2020 2020 2020 2020 2069 6e69 745f             init_
-00011620: 6861 7368 3d73 656c 662e 7632 5f70 6f6f  hash=self.v2_poo
-00011630: 6c5f 6d61 6e61 6765 722e 5f66 6163 746f  l_manager._facto
-00011640: 7279 5f69 6e69 745f 6861 7368 2c0a 2020  ry_init_hash,.  
-00011650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011660: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00011670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011690: 2074 6f6b 656e 733d 5b0a 2020 2020 2020   tokens=[.      
-000116a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000116c0: 6c66 2e76 325f 706f 6f6c 5f6d 616e 6167  lf.v2_pool_manag
-000116d0: 6572 2e5f 746f 6b65 6e5f 6d61 6e61 6765  er._token_manage
-000116e0: 722e 6765 745f 6572 6332 3074 6f6b 656e  r.get_erc20token
-000116f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00011700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011710: 2020 2020 2020 2020 2020 746f 6b65 6e30            token0
-00011720: 5f61 6464 7265 7373 0a20 2020 2020 2020  _address.       
-00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011740: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00011750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011770: 2020 2020 7365 6c66 2e76 325f 706f 6f6c      self.v2_pool
-00011780: 5f6d 616e 6167 6572 2e5f 746f 6b65 6e5f  _manager._token_
-00011790: 6d61 6e61 6765 722e 6765 745f 6572 6332  manager.get_erc2
-000117a0: 3074 6f6b 656e 280a 2020 2020 2020 2020  0token(.        
-000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117d0: 746f 6b65 6e31 5f61 6464 7265 7373 0a20  token1_address. 
-000117e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011800: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00011810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011820: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00011830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011840: 2020 2020 2020 2020 2066 6163 746f 7279           factory
-00011850: 5f61 6464 7265 7373 3d73 656c 662e 7632  _address=self.v2
-00011860: 5f70 6f6f 6c5f 6d61 6e61 6765 722e 5f66  _pool_manager._f
-00011870: 6163 746f 7279 5f61 6464 7265 7373 2c0a  actory_address,.
-00011880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118a0: 6661 6374 6f72 795f 696e 6974 5f68 6173  factory_init_has
-000118b0: 683d 7365 6c66 2e76 325f 706f 6f6c 5f6d  h=self.v2_pool_m
-000118c0: 616e 6167 6572 2e5f 6661 6374 6f72 795f  anager._factory_
-000118d0: 696e 6974 5f68 6173 682c 0a20 2020 2020  init_hash,.     
-000118e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118f0: 2020 2020 2020 2020 2020 2065 6d70 7479             empty
-00011900: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00011910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011920: 2020 2020 2020 2073 696c 656e 743d 7365         silent=se
-00011930: 6c66 2e73 696c 656e 742c 0a20 2020 2020  lf.silent,.     
-00011940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011950: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00011960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011970: 2020 5f73 696d 5f72 6573 756c 7420 3d20    _sim_result = 
-00011980: 7365 6c66 2e5f 7369 6d75 6c61 7465 5f76  self._simulate_v
-00011990: 325f 6164 645f 6c69 7175 6964 6974 7928  2_add_liquidity(
-000119a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000119b0: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
-000119c0: 6c3d 5f70 6f6f 6c2c 0a20 2020 2020 2020  l=_pool,.       
-000119d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119e0: 2020 2020 2061 6464 6564 5f72 6573 6572       added_reser
-000119f0: 7665 735f 746f 6b65 6e30 3d74 6f6b 656e  ves_token0=token
-00011a00: 305f 616d 6f75 6e74 2c0a 2020 2020 2020  0_amount,.      
-00011a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a20: 2020 2020 2020 6164 6465 645f 7265 7365        added_rese
-00011a30: 7276 6573 5f74 6f6b 656e 313d 746f 6b65  rves_token1=toke
-00011a40: 6e31 5f61 6d6f 756e 742c 0a20 2020 2020  n1_amount,.     
-00011a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a60: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00011a70: 2020 2020 2020 2020 2020 2020 2020 5f76                _v
-00011a80: 325f 726f 7574 6572 5f66 7574 7572 655f  2_router_future_
-00011a90: 706f 6f6c 5f73 7461 7465 732e 6170 7065  pool_states.appe
-00011aa0: 6e64 2828 5f70 6f6f 6c2c 205f 7369 6d5f  nd((_pool, _sim_
-00011ab0: 7265 7375 6c74 2929 0a0a 2020 2020 2020  result))..      
-00011ac0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00011ad0: 7365 205f 3a0a 2020 2020 2020 2020 2020  se _:.          
-00011ae0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00011af0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00011b00: 2255 6e6b 6e6f 776e 2066 756e 6374 696f  "Unknown functio
-00011b10: 6e3a 207b 6675 6e63 5f6e 616d 657d 2122  n: {func_name}!"
-00011b20: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-00011b30: 7863 6570 7420 5472 616e 7361 6374 696f  xcept Transactio
-00011b40: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
-00011b50: 2020 2020 2020 2020 2320 4361 7463 6820          # Catch 
-00011b60: 7370 6563 6966 6963 2073 7562 636c 6173  specific subclas
-00011b70: 7320 6578 6365 7074 696f 6e20 746f 2070  s exception to p
-00011b80: 7265 7665 6e74 206e 6573 7465 640a 2020  revent nested.  
-00011b90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011ba0: 6d75 6c74 6963 616c 6c73 2066 726f 6d20  multicalls from 
-00011bb0: 6265 696e 6720 7265 6375 7273 6976 656c  being recursivel
-00011bc0: 7920 7265 2d61 6e6e 6f74 6174 6564 0a20  y re-annotated. 
-00011bd0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00011be0: 2065 2e67 2e20 2753 696d 756c 6174 696f   e.g. 'Simulatio
-00011bf0: 6e20 6661 696c 6564 3a20 5369 6d75 6c61  n failed: Simula
-00011c00: 7469 6f6e 2066 6169 6c65 643a 207b 6572  tion failed: {er
-00011c10: 726f 727d 270a 2020 2020 2020 2020 2020  ror}'.          
-00011c20: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
-00011c30: 2020 2020 2020 2020 6578 6365 7074 2044          except D
-00011c40: 6567 656e 626f 7445 7272 6f72 2061 7320  egenbotError as 
-00011c50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00011c60: 2020 2072 6169 7365 2054 7261 6e73 6163     raise Transac
-00011c70: 7469 6f6e 4572 726f 7228 6622 5369 6d75  tionError(f"Simu
-00011c80: 6c61 7469 6f6e 2066 6169 6c65 643a 207b  lation failed: {
-00011c90: 657d 2229 2066 726f 6d20 650a 2020 2020  e}") from e.    
-00011ca0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00011cb0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00011cc0: 7475 726e 205f 7632 5f72 6f75 7465 725f  turn _v2_router_
-00011cd0: 6675 7475 7265 5f70 6f6f 6c5f 7374 6174  future_pool_stat
-00011ce0: 6573 0a0a 2020 2020 2020 2020 6465 6620  es..        def 
-00011cf0: 5f70 726f 6365 7373 5f75 6e69 7377 6170  _process_uniswap
-00011d00: 5f76 335f 7472 616e 7361 6374 696f 6e28  _v3_transaction(
-00011d10: 2920 2d3e 2028 0a20 2020 2020 2020 2020  ) -> (.         
-00011d20: 2020 204c 6973 745b 0a20 2020 2020 2020     List[.       
-00011d30: 2020 2020 2020 2020 2054 7570 6c65 5b4c           Tuple[L
-00011d40: 6971 7569 6469 7479 506f 6f6c 2c20 556e  iquidityPool, Un
-00011d50: 6973 7761 7056 3250 6f6f 6c53 696d 756c  iswapV2PoolSimul
-00011d60: 6174 696f 6e52 6573 756c 745d 0a20 2020  ationResult].   
-00011d70: 2020 2020 2020 2020 2020 2020 207c 2054               | T
-00011d80: 7570 6c65 5b56 334c 6971 7569 6469 7479  uple[V3Liquidity
-00011d90: 506f 6f6c 2c20 556e 6973 7761 7056 3350  Pool, UniswapV3P
-00011da0: 6f6f 6c53 696d 756c 6174 696f 6e52 6573  oolSimulationRes
-00011db0: 756c 745d 0a20 2020 2020 2020 2020 2020  ult].           
-00011dc0: 205d 0a20 2020 2020 2020 2029 3a0a 2020   ].        ):.  
-00011dd0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00011de0: 2e64 6562 7567 2866 227b 6675 6e63 5f6e  .debug(f"{func_n
-00011df0: 616d 657d 3a20 7b73 656c 662e 6861 7368  ame}: {self.hash
-00011e00: 2e68 6578 2829 3d7d 2229 0a0a 2020 2020  .hex()=}")..    
-00011e10: 2020 2020 2020 2020 5f76 335f 726f 7574          _v3_rout
-00011e20: 6572 5f66 7574 7572 655f 706f 6f6c 5f73  er_future_pool_s
-00011e30: 7461 7465 733a 204c 6973 745b 0a20 2020  tates: List[.   
-00011e40: 2020 2020 2020 2020 2020 2020 2054 7570               Tup
-00011e50: 6c65 5b4c 6971 7569 6469 7479 506f 6f6c  le[LiquidityPool
-00011e60: 2c20 556e 6973 7761 7056 3250 6f6f 6c53  , UniswapV2PoolS
-00011e70: 696d 756c 6174 696f 6e52 6573 756c 745d  imulationResult]
-00011e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011e90: 207c 2054 7570 6c65 5b56 334c 6971 7569   | Tuple[V3Liqui
-00011ea0: 6469 7479 506f 6f6c 2c20 556e 6973 7761  dityPool, Uniswa
-00011eb0: 7056 3350 6f6f 6c53 696d 756c 6174 696f  pV3PoolSimulatio
-00011ec0: 6e52 6573 756c 745d 0a20 2020 2020 2020  nResult].       
-00011ed0: 2020 2020 205d 203d 205b 5d0a 0a20 2020       ] = []..   
-00011ee0: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
-00011ef0: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
-00011f00: 2020 2020 2020 2020 2020 2076 335f 7369             v3_si
-00011f10: 6d5f 7265 7375 6c74 3a20 556e 6973 7761  m_result: Uniswa
-00011f20: 7056 3350 6f6f 6c53 696d 756c 6174 696f  pV3PoolSimulatio
-00011f30: 6e52 6573 756c 740a 2020 2020 2020 2020  nResult.        
-00011f40: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-00011f50: 656c 662e 7633 5f70 6f6f 6c5f 6d61 6e61  elf.v3_pool_mana
-00011f60: 6765 7220 6973 206e 6f74 204e 6f6e 650a  ger is not None.
-00011f70: 0a20 2020 2020 2020 2020 2020 2073 696c  .            sil
-00011f80: 656e 7420 3d20 7365 6c66 2e73 696c 656e  ent = self.silen
-00011f90: 740a 0a20 2020 2020 2020 2020 2020 2074  t..            t
-00011fa0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00011fb0: 2020 2020 6d61 7463 6820 6675 6e63 5f6e      match func_n
-00011fc0: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
-00011fd0: 2020 2020 2020 2020 2063 6173 6520 226d           case "m
-00011fe0: 756c 7469 6361 6c6c 223a 0a20 2020 2020  ulticall":.     
-00011ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012000: 2020 205f 7633 5f72 6f75 7465 725f 6675     _v3_router_fu
-00012010: 7475 7265 5f70 6f6f 6c5f 7374 6174 6573  ture_pool_states
-00012020: 2e65 7874 656e 6428 0a20 2020 2020 2020  .extend(.       
-00012030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012040: 2020 2020 205f 7072 6f63 6573 735f 7633       _process_v3
-00012050: 5f6d 756c 7469 6361 6c6c 2870 6172 616d  _multicall(param
-00012060: 733d 6675 6e63 5f70 6172 616d 7329 0a20  s=func_params). 
-00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012080: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00012090: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000120a0: 7365 2022 6578 6163 7449 6e70 7574 5369  se "exactInputSi
-000120b0: 6e67 6c65 223a 0a20 2020 2020 2020 2020  ngle":.         
-000120c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000120d0: 2045 7874 7261 6374 2070 6172 616d 6574   Extract paramet
-000120e0: 6572 7320 6672 6f6d 2074 6865 2064 6963  ers from the dic
-000120f0: 7420 7265 7375 6c74 7320 6f66 2077 6562  t results of web
-00012100: 3370 7920 7636 0a20 2020 2020 2020 2020  3py v6.         
-00012110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012120: 6620 6973 696e 7374 616e 6365 2866 756e  f isinstance(fun
-00012130: 635f 7061 7261 6d73 5b22 7061 7261 6d73  c_params["params
-00012140: 225d 2c20 6469 6374 293a 0a20 2020 2020  "], dict):.     
-00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012160: 2020 2020 2020 2074 785f 746f 6b65 6e5f         tx_token_
-00012170: 696e 5f61 6464 7265 7373 203d 2066 756e  in_address = fun
-00012180: 635f 7061 7261 6d73 5b22 7061 7261 6d73  c_params["params
-00012190: 225d 5b22 746f 6b65 6e49 6e22 5d0a 2020  "]["tokenIn"].  
+000114a0: 2020 2020 2072 6573 6572 7665 735f 746f       reserves_to
+000114b0: 6b65 6e31 3d30 2c0a 2020 2020 2020 2020  ken1=0,.        
+000114c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114d0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+000114e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000114f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00011500: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00011510: 696d 756c 6174 6564 5f70 6f6f 6c5f 7374  imulated_pool_st
+00011520: 6174 6573 2e61 7070 656e 6428 285f 706f  ates.append((_po
+00011530: 6f6c 2c20 5f73 696d 5f72 6573 756c 7429  ol, _sim_result)
+00011540: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00011550: 2020 2020 2020 2063 6173 6520 5f3a 0a20         case _:. 
+00011560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011570: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00011580: 7565 4572 726f 7228 6622 556e 6b6e 6f77  ueError(f"Unknow
+00011590: 6e20 6675 6e63 7469 6f6e 3a20 7b66 756e  n function: {fun
+000115a0: 635f 6e61 6d65 7d21 2229 0a0a 2020 2020  c_name}!")..    
+000115b0: 2020 2020 2020 2020 6578 6365 7074 2054          except T
+000115c0: 7261 6e73 6163 7469 6f6e 4572 726f 723a  ransactionError:
+000115d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000115e0: 2023 2043 6174 6368 2073 7065 6369 6669   # Catch specifi
+000115f0: 6320 7375 6263 6c61 7373 2065 7863 6570  c subclass excep
+00011600: 7469 6f6e 2074 6f20 7072 6576 656e 7420  tion to prevent 
+00011610: 6e65 7374 6564 0a20 2020 2020 2020 2020  nested.         
+00011620: 2020 2020 2020 2023 206d 756c 7469 6361         # multica
+00011630: 6c6c 7320 6672 6f6d 2062 6569 6e67 2072  lls from being r
+00011640: 6563 7572 7369 7665 6c79 2072 652d 616e  ecursively re-an
+00011650: 6e6f 7461 7465 640a 2020 2020 2020 2020  notated.        
+00011660: 2020 2020 2020 2020 2320 652e 672e 2027          # e.g. '
+00011670: 5369 6d75 6c61 7469 6f6e 2066 6169 6c65  Simulation faile
+00011680: 643a 2053 696d 756c 6174 696f 6e20 6661  d: Simulation fa
+00011690: 696c 6564 3a20 7b65 7272 6f72 7d27 0a20  iled: {error}'. 
+000116a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000116b0: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
+000116c0: 2065 7863 6570 7420 4465 6765 6e62 6f74   except Degenbot
+000116d0: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+000116e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000116f0: 6520 5472 616e 7361 6374 696f 6e45 7272  e TransactionErr
+00011700: 6f72 2866 2253 696d 756c 6174 696f 6e20  or(f"Simulation 
+00011710: 6661 696c 6564 3a20 7b65 7d22 2920 6672  failed: {e}") fr
+00011720: 6f6d 2065 0a0a 2020 2020 2020 2020 6465  om e..        de
+00011730: 6620 5f70 726f 6365 7373 5f75 6e69 7377  f _process_unisw
+00011740: 6170 5f76 335f 7472 616e 7361 6374 696f  ap_v3_transactio
+00011750: 6e28 2920 2d3e 204e 6f6e 653a 0a20 2020  n() -> None:.   
+00011760: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00011770: 6465 6275 6728 6622 7b66 756e 635f 6e61  debug(f"{func_na
+00011780: 6d65 7d3a 207b 7365 6c66 2e68 6173 682e  me}: {self.hash.
+00011790: 6865 7828 293d 7d22 290a 0a20 2020 2020  hex()=}")..     
+000117a0: 2020 2020 2020 2069 6620 5459 5045 5f43         if TYPE_C
+000117b0: 4845 434b 494e 473a 0a20 2020 2020 2020  HECKING:.       
+000117c0: 2020 2020 2020 2020 2076 335f 7369 6d5f           v3_sim_
+000117d0: 7265 7375 6c74 3a20 556e 6973 7761 7056  result: UniswapV
+000117e0: 3350 6f6f 6c53 696d 756c 6174 696f 6e52  3PoolSimulationR
+000117f0: 6573 756c 740a 2020 2020 2020 2020 2020  esult.          
+00011800: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00011810: 662e 7633 5f70 6f6f 6c5f 6d61 6e61 6765  f.v3_pool_manage
+00011820: 7220 6973 206e 6f74 204e 6f6e 650a 0a20  r is not None.. 
+00011830: 2020 2020 2020 2020 2020 2073 696c 656e             silen
+00011840: 7420 3d20 7365 6c66 2e73 696c 656e 740a  t = self.silent.
+00011850: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00011860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011870: 2020 6d61 7463 6820 6675 6e63 5f6e 616d    match func_nam
+00011880: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00011890: 2020 2020 2020 2063 6173 6520 226d 756c         case "mul
+000118a0: 7469 6361 6c6c 223a 0a20 2020 2020 2020  ticall":.       
+000118b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118c0: 205f 7072 6f63 6573 735f 7633 5f6d 756c   _process_v3_mul
+000118d0: 7469 6361 6c6c 2870 6172 616d 733d 6675  ticall(params=fu
+000118e0: 6e63 5f70 6172 616d 7329 0a0a 2020 2020  nc_params)..    
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011900: 6361 7365 2022 6578 6163 7449 6e70 7574  case "exactInput
+00011910: 5369 6e67 6c65 223a 0a20 2020 2020 2020  Single":.       
+00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011930: 2023 2045 7874 7261 6374 2070 6172 616d   # Extract param
+00011940: 6574 6572 7320 6672 6f6d 2074 6865 2064  eters from the d
+00011950: 6963 7420 7265 7375 6c74 7320 6f66 2077  ict results of w
+00011960: 6562 3370 7920 7636 0a20 2020 2020 2020  eb3py v6.       
+00011970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011980: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
+00011990: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+000119a0: 6d73 225d 2c20 6469 6374 293a 0a20 2020  ms"], dict):.   
+000119b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119c0: 2020 2020 2020 2020 2074 785f 746f 6b65           tx_toke
+000119d0: 6e5f 696e 5f61 6464 7265 7373 203d 2066  n_in_address = f
+000119e0: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+000119f0: 6d73 225d 5b22 746f 6b65 6e49 6e22 5d0a  ms"]["tokenIn"].
+00011a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a10: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
+00011a20: 6f6b 656e 5f6f 7574 5f61 6464 7265 7373  oken_out_address
+00011a30: 203d 2066 756e 635f 7061 7261 6d73 5b22   = func_params["
+00011a40: 7061 7261 6d73 225d 5b22 746f 6b65 6e4f  params"]["tokenO
+00011a50: 7574 225d 0a20 2020 2020 2020 2020 2020  ut"].           
+00011a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a70: 2074 785f 6665 6520 3d20 6675 6e63 5f70   tx_fee = func_p
+00011a80: 6172 616d 735b 2270 6172 616d 7322 5d5b  arams["params"][
+00011a90: 2266 6565 225d 0a20 2020 2020 2020 2020  "fee"].         
+00011aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ab0: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
+00011ac0: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
+00011ad0: 6172 616d 7322 5d5b 2272 6563 6970 6965  arams"]["recipie
+00011ae0: 6e74 225d 0a20 2020 2020 2020 2020 2020  nt"].           
+00011af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b00: 2074 785f 616d 6f75 6e74 5f69 6e20 3d20   tx_amount_in = 
+00011b10: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
+00011b20: 616d 7322 5d5b 2261 6d6f 756e 7449 6e22  ams"]["amountIn"
+00011b30: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00011b40: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00011b50: 5f61 6d6f 756e 745f 6f75 745f 6d69 6e20  _amount_out_min 
+00011b60: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
+00011b70: 6172 616d 7322 5d5b 2261 6d6f 756e 744f  arams"]["amountO
+00011b80: 7574 4d69 6e69 6d75 6d22 5d0a 2020 2020  utMinimum"].    
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ba0: 2020 2020 2020 2020 7478 5f64 6561 646c          tx_deadl
+00011bb0: 696e 6520 3d20 6675 6e63 5f70 6172 616d  ine = func_param
+00011bc0: 735b 2270 6172 616d 7322 5d2e 6765 7428  s["params"].get(
+00011bd0: 2264 6561 646c 696e 6522 290a 2020 2020  "deadline").    
+00011be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bf0: 2020 2020 2020 2020 7478 5f73 7172 745f          tx_sqrt_
+00011c00: 7072 6963 655f 6c69 6d69 745f 7839 3620  price_limit_x96 
+00011c10: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
+00011c20: 6172 616d 7322 5d5b 2273 7172 7450 7269  arams"]["sqrtPri
+00011c30: 6365 4c69 6d69 7458 3936 225d 0a20 2020  ceLimitX96"].   
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c50: 2020 2020 2023 2045 7874 7261 6374 2070       # Extract p
+00011c60: 6172 616d 6574 6572 7320 6672 6f6d 2074  arameters from t
+00011c70: 6865 2074 7570 6c65 2072 6573 756c 7473  he tuple results
+00011c80: 206f 6620 7765 6233 7079 2076 350a 2020   of web3py v5.  
+00011c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ca0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00011cb0: 7461 6e63 6528 6675 6e63 5f70 6172 616d  tance(func_param
+00011cc0: 735b 2270 6172 616d 7322 5d2c 2074 7570  s["params"], tup
+00011cd0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+00011ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cf0: 2023 2044 6563 6f64 6520 7769 7468 2049   # Decode with I
+00011d00: 5377 6170 526f 7574 6572 2041 4249 0a20  SwapRouter ABI. 
+00011d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d20: 2020 2020 2020 2020 2020 2023 2072 6566             # ref
+00011d30: 3a20 6874 7470 733a 2f2f 6769 7468 7562  : https://github
+00011d40: 2e63 6f6d 2f55 6e69 7377 6170 2f76 332d  .com/Uniswap/v3-
+00011d50: 7065 7269 7068 6572 792f 626c 6f62 2f6d  periphery/blob/m
+00011d60: 6169 6e2f 636f 6e74 7261 6374 732f 696e  ain/contracts/in
+00011d70: 7465 7266 6163 6573 2f49 5377 6170 526f  terfaces/ISwapRo
+00011d80: 7574 6572 2e73 6f6c 0a20 2020 2020 2020  uter.sol.       
+00011d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011da0: 2020 2020 2069 6620 6c65 6e28 6675 6e63       if len(func
+00011db0: 5f70 6172 616d 735b 2270 6172 616d 7322  _params["params"
+00011dc0: 5d29 203d 3d20 383a 0a20 2020 2020 2020  ]) == 8:.       
+00011dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011de0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00011e10: 785f 746f 6b65 6e5f 696e 5f61 6464 7265  x_token_in_addre
+00011e20: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00011e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e40: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
+00011e50: 5f6f 7574 5f61 6464 7265 7373 2c0a 2020  _out_address,.  
+00011e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e80: 2020 7478 5f66 6565 2c0a 2020 2020 2020    tx_fee,.      
+00011e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ea0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00011eb0: 5f72 6563 6970 6965 6e74 2c0a 2020 2020  _recipient,.    
+00011ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ee0: 7478 5f64 6561 646c 696e 652c 0a20 2020  tx_deadline,.   
+00011ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f10: 2074 785f 616d 6f75 6e74 5f69 6e2c 0a20   tx_amount_in,. 
+00011f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f40: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
+00011f50: 5f6d 696e 2c0a 2020 2020 2020 2020 2020  _min,.          
+00011f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f70: 2020 2020 2020 2020 2020 7478 5f73 7172            tx_sqr
+00011f80: 745f 7072 6963 655f 6c69 6d69 745f 7839  t_price_limit_x9
+00011f90: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fb0: 2020 2029 203d 2066 756e 635f 7061 7261     ) = func_para
+00011fc0: 6d73 5b22 7061 7261 6d73 225d 0a0a 2020  ms["params"]..  
+00011fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fe0: 2020 2020 2020 2020 2020 2320 4465 636f            # Deco
+00011ff0: 6465 2077 6974 6820 4956 3353 7761 7052  de with IV3SwapR
+00012000: 6f75 7465 7220 4142 4920 2861 6b61 2052  outer ABI (aka R
+00012010: 6f75 7465 7232 290a 2020 2020 2020 2020  outer2).        
+00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012030: 2020 2020 2320 7265 663a 2068 7474 7073      # ref: https
+00012040: 3a2f 2f67 6974 6875 622e 636f 6d2f 556e  ://github.com/Un
+00012050: 6973 7761 702f 7377 6170 2d72 6f75 7465  iswap/swap-route
+00012060: 722d 636f 6e74 7261 6374 732f 626c 6f62  r-contracts/blob
+00012070: 2f6d 6169 6e2f 636f 6e74 7261 6374 732f  /main/contracts/
+00012080: 696e 7465 7266 6163 6573 2f49 5633 5377  interfaces/IV3Sw
+00012090: 6170 526f 7574 6572 2e73 6f6c 0a20 2020  apRouter.sol.   
+000120a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120b0: 2020 2020 2020 2020 2065 6c69 6620 6c65           elif le
+000120c0: 6e28 6675 6e63 5f70 6172 616d 735b 2270  n(func_params["p
+000120d0: 6172 616d 7322 5d29 203d 3d20 373a 0a20  arams"]) == 7:. 
+000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00012100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012120: 2020 2020 2074 785f 746f 6b65 6e5f 696e       tx_token_in
+00012130: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
+00012140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012150: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00012160: 5f74 6f6b 656e 5f6f 7574 5f61 6464 7265  _token_out_addre
+00012170: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012190: 2020 2020 2020 2020 7478 5f66 6565 2c0a          tx_fee,.
 000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121b0: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
-000121c0: 656e 5f6f 7574 5f61 6464 7265 7373 203d  en_out_address =
-000121d0: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-000121e0: 7261 6d73 225d 5b22 746f 6b65 6e4f 7574  rams"]["tokenOut
-000121f0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-00012200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00012210: 785f 6665 6520 3d20 6675 6e63 5f70 6172  x_fee = func_par
-00012220: 616d 735b 2270 6172 616d 7322 5d5b 2266  ams["params"]["f
-00012230: 6565 225d 0a20 2020 2020 2020 2020 2020  ee"].           
+000121b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121c0: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
+000121d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000121e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121f0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+00012200: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00012210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012220: 2020 2020 2020 2020 7478 5f61 6d6f 756e          tx_amoun
+00012230: 745f 6f75 745f 6d69 6e2c 0a20 2020 2020  t_out_min,.     
 00012240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012250: 2074 785f 7265 6369 7069 656e 7420 3d20   tx_recipient = 
-00012260: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-00012270: 616d 7322 5d5b 2272 6563 6970 6965 6e74  ams"]["recipient
-00012280: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-00012290: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000122a0: 785f 616d 6f75 6e74 5f69 6e20 3d20 6675  x_amount_in = fu
-000122b0: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
-000122c0: 7322 5d5b 2261 6d6f 756e 7449 6e22 5d0a  s"]["amountIn"].
-000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122e0: 2020 2020 2020 2020 2020 2020 7478 5f61              tx_a
-000122f0: 6d6f 756e 745f 6f75 745f 6d69 6e20 3d20  mount_out_min = 
-00012300: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-00012310: 616d 7322 5d5b 2261 6d6f 756e 744f 7574  ams"]["amountOut
-00012320: 4d69 6e69 6d75 6d22 5d0a 2020 2020 2020  Minimum"].      
-00012330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012340: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
-00012350: 6520 3d20 6675 6e63 5f70 6172 616d 735b  e = func_params[
-00012360: 2270 6172 616d 7322 5d2e 6765 7428 2264  "params"].get("d
-00012370: 6561 646c 696e 6522 290a 2020 2020 2020  eadline").      
-00012380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012390: 2020 2020 2020 7478 5f73 7172 745f 7072        tx_sqrt_pr
-000123a0: 6963 655f 6c69 6d69 745f 7839 3620 3d20  ice_limit_x96 = 
-000123b0: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-000123c0: 616d 7322 5d5b 2273 7172 7450 7269 6365  ams"]["sqrtPrice
-000123d0: 4c69 6d69 7458 3936 225d 0a20 2020 2020  LimitX96"].     
+00012250: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00012260: 785f 7371 7274 5f70 7269 6365 5f6c 696d  x_sqrt_price_lim
+00012270: 6974 5f78 3936 2c0a 2020 2020 2020 2020  it_x96,.        
+00012280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012290: 2020 2020 2020 2020 2920 3d20 6675 6e63          ) = func
+000122a0: 5f70 6172 616d 735b 2270 6172 616d 7322  _params["params"
+000122b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000122c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122d0: 2020 7478 5f64 6561 646c 696e 6520 3d20    tx_deadline = 
+000122e0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012300: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00012310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012320: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00012330: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00012340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012350: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+00012360: 6f75 6c64 206e 6f74 2065 7874 7261 6374  ould not extract
+00012370: 2070 6172 616d 6574 6572 7320 666f 7220   parameters for 
+00012380: 6675 6e63 7469 6f6e 207b 6675 6e63 5f6e  function {func_n
+00012390: 616d 657d 2077 6974 6820 7061 7261 6d65  ame} with parame
+000123a0: 7465 7273 207b 6675 6e63 5f70 6172 616d  ters {func_param
+000123b0: 735b 2770 6172 616d 7327 5d7d 220a 2020  s['params']}".  
+000123c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123f0: 2020 2023 2045 7874 7261 6374 2070 6172     # Extract par
-00012400: 616d 6574 6572 7320 6672 6f6d 2074 6865  ameters from the
-00012410: 2074 7570 6c65 2072 6573 756c 7473 206f   tuple results o
-00012420: 6620 7765 6233 7079 2076 350a 2020 2020  f web3py v5.    
+000123f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012410: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012420: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
 00012430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012440: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00012450: 6e63 6528 6675 6e63 5f70 6172 616d 735b  nce(func_params[
-00012460: 2270 6172 616d 7322 5d2c 2074 7570 6c65  "params"], tuple
-00012470: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012480: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012490: 2044 6563 6f64 6520 7769 7468 2049 5377   Decode with ISw
-000124a0: 6170 526f 7574 6572 2041 4249 0a20 2020  apRouter ABI.   
-000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124c0: 2020 2020 2020 2020 2023 2072 6566 3a20           # ref: 
-000124d0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-000124e0: 6f6d 2f55 6e69 7377 6170 2f76 332d 7065  om/Uniswap/v3-pe
-000124f0: 7269 7068 6572 792f 626c 6f62 2f6d 6169  riphery/blob/mai
-00012500: 6e2f 636f 6e74 7261 6374 732f 696e 7465  n/contracts/inte
-00012510: 7266 6163 6573 2f49 5377 6170 526f 7574  rfaces/ISwapRout
-00012520: 6572 2e73 6f6c 0a20 2020 2020 2020 2020  er.sol.         
-00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012540: 2020 2069 6620 6c65 6e28 6675 6e63 5f70     if len(func_p
-00012550: 6172 616d 735b 2270 6172 616d 7322 5d29  arams["params"])
-00012560: 203d 3d20 383a 0a20 2020 2020 2020 2020   == 8:.         
+00012440: 2020 2020 2020 2020 2020 2020 6627 436f              f'Co
+00012450: 756c 6420 6e6f 7420 6964 656e 7469 6679  uld not identify
+00012460: 2074 7970 6520 666f 7220 6675 6e63 7469   type for functi
+00012470: 6f6e 2070 6172 616d 732e 2045 7870 6563  on params. Expec
+00012480: 7465 6420 7475 706c 6520 6f72 2064 6963  ted tuple or dic
+00012490: 742c 2067 6f74 207b 7479 7065 2866 756e  t, got {type(fun
+000124a0: 635f 7061 7261 6d73 5b22 7061 7261 6d73  c_params["params
+000124b0: 225d 297d 270a 2020 2020 2020 2020 2020  "])}'.          
+000124c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124d0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000124e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000124f0: 7478 5f64 6561 646c 696e 653a 0a20 2020  tx_deadline:.   
+00012500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012510: 2020 2020 2020 2020 2073 656c 662e 5f72           self._r
+00012520: 6169 7365 5f69 665f 7061 7374 5f64 6561  aise_if_past_dea
+00012530: 646c 696e 6528 7478 5f64 6561 646c 696e  dline(tx_deadlin
+00012540: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00012550: 2020 2020 2020 2020 2020 2020 6966 2054              if T
+00012560: 5950 455f 4348 4543 4b49 4e47 3a0a 2020  YPE_CHECKING:.  
 00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012580: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00012590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125a0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-000125b0: 746f 6b65 6e5f 696e 5f61 6464 7265 7373  token_in_address
-000125c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000125d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125e0: 2020 2020 2020 7478 5f74 6f6b 656e 5f6f        tx_token_o
-000125f0: 7574 5f61 6464 7265 7373 2c0a 2020 2020  ut_address,.    
-00012600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012620: 7478 5f66 6565 2c0a 2020 2020 2020 2020  tx_fee,.        
-00012630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012640: 2020 2020 2020 2020 2020 2020 7478 5f72              tx_r
-00012650: 6563 6970 6965 6e74 2c0a 2020 2020 2020  ecipient,.      
-00012660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012670: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00012680: 5f64 6561 646c 696e 652c 0a20 2020 2020  _deadline,.     
-00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000126b0: 785f 616d 6f75 6e74 5f69 6e2c 0a20 2020  x_amount_in,.   
-000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012580: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00012590: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
+000125a0: 2e76 335f 706f 6f6c 5f6d 616e 6167 6572  .v3_pool_manager
+000125b0: 2c20 556e 6973 7761 7056 334c 6971 7569  , UniswapV3Liqui
+000125c0: 6469 7479 506f 6f6c 4d61 6e61 6765 7229  dityPoolManager)
+000125d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125e0: 2020 2020 2020 2020 2076 335f 706f 6f6c           v3_pool
+000125f0: 203d 2073 656c 662e 7633 5f70 6f6f 6c5f   = self.v3_pool_
+00012600: 6d61 6e61 6765 722e 6765 745f 706f 6f6c  manager.get_pool
+00012610: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012620: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00012630: 6b65 6e5f 6164 6472 6573 7365 733d 280a  ken_addresses=(.
+00012640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012660: 7478 5f74 6f6b 656e 5f69 6e5f 6164 6472  tx_token_in_addr
+00012670: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+00012680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012690: 2020 2020 2074 785f 746f 6b65 6e5f 6f75       tx_token_ou
+000126a0: 745f 6164 6472 6573 732c 0a20 2020 2020  t_address,.     
+000126b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126c0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
 000126d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126e0: 2074 785f 616d 6f75 6e74 5f6f 7574 5f6d   tx_amount_out_m
-000126f0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+000126e0: 2020 2020 2020 706f 6f6c 5f66 6565 3d74        pool_fee=t
+000126f0: 785f 6665 652c 0a20 2020 2020 2020 2020  x_fee,.         
 00012700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012710: 2020 2020 2020 2020 7478 5f73 7172 745f          tx_sqrt_
-00012720: 7072 6963 655f 6c69 6d69 745f 7839 362c  price_limit_x96,
-00012730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012750: 2029 203d 2066 756e 635f 7061 7261 6d73   ) = func_params
-00012760: 5b22 7061 7261 6d73 225d 0a0a 2020 2020  ["params"]..    
-00012770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012780: 2020 2020 2020 2020 2320 4465 636f 6465          # Decode
-00012790: 2077 6974 6820 4956 3353 7761 7052 6f75   with IV3SwapRou
-000127a0: 7465 7220 4142 4920 2861 6b61 2052 6f75  ter ABI (aka Rou
-000127b0: 7465 7232 290a 2020 2020 2020 2020 2020  ter2).          
+00012710: 2020 2073 696c 656e 743d 7365 6c66 2e73     silent=self.s
+00012720: 696c 656e 742c 0a20 2020 2020 2020 2020  ilent,.         
+00012730: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00012740: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012750: 2020 2020 2020 2020 2020 5f2c 2076 335f            _, v3_
+00012760: 7369 6d5f 7265 7375 6c74 203d 2073 656c  sim_result = sel
+00012770: 662e 5f73 696d 756c 6174 655f 7633 5f73  f._simulate_v3_s
+00012780: 7761 705f 6578 6163 745f 696e 280a 2020  wap_exact_in(.  
+00012790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127a0: 2020 2020 2020 2020 2020 706f 6f6c 3d76            pool=v
+000127b0: 335f 706f 6f6c 2c0a 2020 2020 2020 2020  3_pool,.        
 000127c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127d0: 2020 2320 7265 663a 2068 7474 7073 3a2f    # ref: https:/
-000127e0: 2f67 6974 6875 622e 636f 6d2f 556e 6973  /github.com/Unis
-000127f0: 7761 702f 7377 6170 2d72 6f75 7465 722d  wap/swap-router-
-00012800: 636f 6e74 7261 6374 732f 626c 6f62 2f6d  contracts/blob/m
-00012810: 6169 6e2f 636f 6e74 7261 6374 732f 696e  ain/contracts/in
-00012820: 7465 7266 6163 6573 2f49 5633 5377 6170  terfaces/IV3Swap
-00012830: 526f 7574 6572 2e73 6f6c 0a20 2020 2020  Router.sol.     
-00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012850: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
-00012860: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-00012870: 616d 7322 5d29 203d 3d20 373a 0a20 2020  ams"]) == 7:.   
-00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012890: 2020 2020 2020 2020 2020 2020 2028 0a20               (. 
-000128a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128c0: 2020 2074 785f 746f 6b65 6e5f 696e 5f61     tx_token_in_a
-000128d0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+000127d0: 2020 2020 7265 6369 7069 656e 743d 7478      recipient=tx
+000127e0: 5f72 6563 6970 6965 6e74 2c0a 2020 2020  _recipient,.    
+000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012800: 2020 2020 2020 2020 746f 6b65 6e5f 696e          token_in
+00012810: 3d28 0a20 2020 2020 2020 2020 2020 2020  =(.             
+00012820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012830: 2020 2076 335f 706f 6f6c 2e74 6f6b 656e     v3_pool.token
+00012840: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+00012850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012860: 2020 6966 2076 335f 706f 6f6c 2e74 6f6b    if v3_pool.tok
+00012870: 656e 3020 3d3d 2074 785f 746f 6b65 6e5f  en0 == tx_token_
+00012880: 696e 5f61 6464 7265 7373 0a20 2020 2020  in_address.     
+00012890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128a0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+000128b0: 7633 5f70 6f6f 6c2e 746f 6b65 6e31 0a20  v3_pool.token1. 
+000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128d0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
 000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128f0: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
-00012900: 6f6b 656e 5f6f 7574 5f61 6464 7265 7373  oken_out_address
+000128f0: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+00012900: 5f69 6e3d 7478 5f61 6d6f 756e 745f 696e  _in=tx_amount_in
 00012910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012930: 2020 2020 2020 7478 5f66 6565 2c0a 2020        tx_fee,.  
-00012940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012920: 2020 2020 2020 2020 2020 2020 2020 616d                am
+00012930: 6f75 6e74 5f6f 7574 5f6d 696e 3d74 785f  ount_out_min=tx_
+00012940: 616d 6f75 6e74 5f6f 7574 5f6d 696e 2c0a  amount_out_min,.
 00012950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012960: 2020 7478 5f72 6563 6970 6965 6e74 2c0a    tx_recipient,.
-00012970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012960: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+00012970: 745f 7377 6170 3d54 7275 652c 0a20 2020  t_swap=True,.   
 00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012990: 2020 2020 7478 5f61 6d6f 756e 745f 696e      tx_amount_in
-000129a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000129b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129c0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
-000129d0: 6f75 745f 6d69 6e2c 0a20 2020 2020 2020  out_min,.       
-000129e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129f0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00012a00: 7371 7274 5f70 7269 6365 5f6c 696d 6974  sqrt_price_limit
-00012a10: 5f78 3936 2c0a 2020 2020 2020 2020 2020  _x96,.          
+00012990: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000129a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129b0: 7365 6c66 2e73 696d 756c 6174 6564 5f70  self.simulated_p
+000129c0: 6f6f 6c5f 7374 6174 6573 2e61 7070 656e  ool_states.appen
+000129d0: 6428 2876 335f 706f 6f6c 2c20 7633 5f73  d((v3_pool, v3_s
+000129e0: 696d 5f72 6573 756c 7429 290a 0a20 2020  im_result))..   
+000129f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a00: 2020 2020 2074 6f6b 656e 5f6f 7574 5f71       token_out_q
+00012a10: 7561 6e74 6974 7920 3d20 2d6d 696e 280a  uantity = -min(.
 00012a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a30: 2020 2020 2020 2920 3d20 6675 6e63 5f70        ) = func_p
-00012a40: 6172 616d 735b 2270 6172 616d 7322 5d0a  arams["params"].
-00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a30: 2020 2020 2020 2020 2020 2020 7633 5f73              v3_s
+00012a40: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
+00012a50: 315f 6465 6c74 612c 0a20 2020 2020 2020  1_delta,.       
 00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a70: 7478 5f64 6561 646c 696e 6520 3d20 4e6f  tx_deadline = No
-00012a80: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00012a90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012aa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00012a70: 2020 2020 2076 335f 7369 6d5f 7265 7375       v3_sim_resu
+00012a80: 6c74 2e61 6d6f 756e 7430 5f64 656c 7461  lt.amount0_delta
+00012a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012aa0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
 00012ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ac0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00012ad0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00012ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012af0: 2020 2020 2020 2020 2020 2066 2243 6f75             f"Cou
-00012b00: 6c64 206e 6f74 2065 7874 7261 6374 2070  ld not extract p
-00012b10: 6172 616d 6574 6572 7320 666f 7220 6675  arameters for fu
-00012b20: 6e63 7469 6f6e 207b 6675 6e63 5f6e 616d  nction {func_nam
-00012b30: 657d 2077 6974 6820 7061 7261 6d65 7465  e} with paramete
-00012b40: 7273 207b 6675 6e63 5f70 6172 616d 735b  rs {func_params[
-00012b50: 2770 6172 616d 7327 5d7d 220a 2020 2020  'params']}".    
-00012b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00012b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bb0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00012bc0: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00012bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012be0: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
-00012bf0: 6420 6e6f 7420 6964 656e 7469 6679 2074  d not identify t
-00012c00: 7970 6520 666f 7220 6675 6e63 7469 6f6e  ype for function
-00012c10: 2070 6172 616d 732e 2045 7870 6563 7465   params. Expecte
-00012c20: 6420 7475 706c 6520 6f72 2064 6963 742c  d tuple or dict,
-00012c30: 2067 6f74 207b 7479 7065 2866 756e 635f   got {type(func_
-00012c40: 7061 7261 6d73 5b22 7061 7261 6d73 225d  params["params"]
-00012c50: 297d 270a 2020 2020 2020 2020 2020 2020  )}'.            
-00012c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c70: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00012c80: 2020 2020 2020 2020 2020 2069 6620 7478             if tx
-00012c90: 5f64 6561 646c 696e 653a 0a20 2020 2020  _deadline:.     
+00012ac0: 2063 6173 6520 2265 7861 6374 496e 7075   case "exactInpu
+00012ad0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+00012ae0: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
+00012af0: 7472 6163 7420 7061 7261 6d65 7465 7273  tract parameters
+00012b00: 2066 726f 6d20 7468 6520 6469 6374 2072   from the dict r
+00012b10: 6573 756c 7473 206f 6620 7765 6233 7079  esults of web3py
+00012b20: 2076 360a 2020 2020 2020 2020 2020 2020   v6.            
+00012b30: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00012b40: 7369 6e73 7461 6e63 6528 6675 6e63 5f70  sinstance(func_p
+00012b50: 6172 616d 735b 2270 6172 616d 7322 5d2c  arams["params"],
+00012b60: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00012b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b80: 2020 2020 7478 5f70 6174 6820 3d20 6675      tx_path = fu
+00012b90: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
+00012ba0: 7322 5d5b 2270 6174 6822 5d0a 2020 2020  s"]["path"].    
+00012bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012bc0: 2020 2020 2020 2020 7478 5f72 6563 6970          tx_recip
+00012bd0: 6965 6e74 203d 2066 756e 635f 7061 7261  ient = func_para
+00012be0: 6d73 5b22 7061 7261 6d73 225d 5b22 7265  ms["params"]["re
+00012bf0: 6369 7069 656e 7422 5d0a 2020 2020 2020  cipient"].      
+00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c10: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
+00012c20: 6520 3d20 6675 6e63 5f70 6172 616d 735b  e = func_params[
+00012c30: 2270 6172 616d 7322 5d2e 6765 7428 2264  "params"].get("d
+00012c40: 6561 646c 696e 6522 290a 2020 2020 2020  eadline").      
+00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c60: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+00012c70: 696e 203d 2066 756e 635f 7061 7261 6d73  in = func_params
+00012c80: 5b22 7061 7261 6d73 225d 5b22 616d 6f75  ["params"]["amou
+00012c90: 6e74 496e 225d 0a20 2020 2020 2020 2020  ntIn"].         
 00012ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cb0: 2020 2020 2020 2073 656c 662e 5f72 6169         self._rai
-00012cc0: 7365 5f69 665f 6578 7069 7265 6428 7478  se_if_expired(tx
-00012cd0: 5f64 6561 646c 696e 6529 0a0a 2020 2020  _deadline)..    
-00012ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cf0: 2020 2020 6966 2054 5950 455f 4348 4543      if TYPE_CHEC
-00012d00: 4b49 4e47 3a0a 2020 2020 2020 2020 2020  KING:.          
-00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00012d30: 6e63 6528 7365 6c66 2e76 335f 706f 6f6c  nce(self.v3_pool
-00012d40: 5f6d 616e 6167 6572 2c20 556e 6973 7761  _manager, Uniswa
-00012d50: 7056 334c 6971 7569 6469 7479 506f 6f6c  pV3LiquidityPool
-00012d60: 4d61 6e61 6765 7229 0a20 2020 2020 2020  Manager).       
-00012d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d80: 2076 335f 706f 6f6c 203d 2073 656c 662e   v3_pool = self.
-00012d90: 7633 5f70 6f6f 6c5f 6d61 6e61 6765 722e  v3_pool_manager.
-00012da0: 6765 745f 706f 6f6c 280a 2020 2020 2020  get_pool(.      
-00012db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012dc0: 2020 2020 2020 746f 6b65 6e5f 6164 6472        token_addr
-00012dd0: 6573 7365 733d 280a 2020 2020 2020 2020  esses=(.        
-00012de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012df0: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
-00012e00: 5f69 6e5f 6164 6472 6573 732c 0a20 2020  _in_address,.   
-00012e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e20: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00012e30: 746f 6b65 6e5f 6f75 745f 6164 6472 6573  token_out_addres
-00012e40: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00012e50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00012e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012e70: 2020 2020 2020 2020 2020 2020 2020 706f                po
-00012e80: 6f6c 5f66 6565 3d74 785f 6665 652c 0a20  ol_fee=tx_fee,. 
+00012cb0: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
+00012cc0: 5f6d 696e 696d 756d 203d 2066 756e 635f  _minimum = func_
+00012cd0: 7061 7261 6d73 5b22 7061 7261 6d73 225d  params["params"]
+00012ce0: 5b22 616d 6f75 6e74 4f75 744d 696e 696d  ["amountOutMinim
+00012cf0: 756d 225d 0a20 2020 2020 2020 2020 2020  um"].           
+00012d00: 2020 2020 2020 2020 2020 2020 2023 2045               # E
+00012d10: 7874 7261 6374 2070 6172 616d 6574 6572  xtract parameter
+00012d20: 7320 6672 6f6d 2074 6865 2074 7570 6c65  s from the tuple
+00012d30: 2072 6573 756c 7473 206f 6620 7765 6233   results of web3
+00012d40: 7079 2076 350a 2020 2020 2020 2020 2020  py v5.          
+00012d50: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00012d60: 6966 2069 7369 6e73 7461 6e63 6528 6675  if isinstance(fu
+00012d70: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
+00012d80: 7322 5d2c 2074 7570 6c65 293a 0a20 2020  s"], tuple):.   
+00012d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012da0: 2020 2020 2020 2020 2023 2044 6563 6f64           # Decod
+00012db0: 6520 7769 7468 2049 5377 6170 526f 7574  e with ISwapRout
+00012dc0: 6572 2041 4249 0a20 2020 2020 2020 2020  er ABI.         
+00012dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012de0: 2020 2023 2072 6566 3a20 6874 7470 733a     # ref: https:
+00012df0: 2f2f 6769 7468 7562 2e63 6f6d 2f55 6e69  //github.com/Uni
+00012e00: 7377 6170 2f76 332d 7065 7269 7068 6572  swap/v3-peripher
+00012e10: 792f 626c 6f62 2f6d 6169 6e2f 636f 6e74  y/blob/main/cont
+00012e20: 7261 6374 732f 696e 7465 7266 6163 6573  racts/interfaces
+00012e30: 2f49 5377 6170 526f 7574 6572 2e73 6f6c  /ISwapRouter.sol
+00012e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012e50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012e60: 6c65 6e28 6675 6e63 5f70 6172 616d 735b  len(func_params[
+00012e70: 2270 6172 616d 7322 5d29 203d 3d20 353a  "params"]) == 5:
+00012e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ea0: 2020 2020 2020 2020 2020 2073 696c 656e             silen
-00012eb0: 743d 7365 6c66 2e73 696c 656e 742c 0a20  t=self.silent,. 
-00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ed0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00012ea0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ec0: 2020 2020 2020 2074 785f 7061 7468 2c0a         tx_path,.
+00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ef0: 2020 5f2c 2076 335f 7369 6d5f 7265 7375    _, v3_sim_resu
-00012f00: 6c74 203d 2073 656c 662e 5f73 696d 756c  lt = self._simul
-00012f10: 6174 655f 7633 5f73 7761 705f 6578 6163  ate_v3_swap_exac
-00012f20: 745f 696e 280a 2020 2020 2020 2020 2020  t_in(.          
-00012f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f40: 2020 706f 6f6c 3d76 335f 706f 6f6c 2c0a    pool=v3_pool,.
-00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f60: 2020 2020 2020 2020 2020 2020 7265 6369              reci
-00012f70: 7069 656e 743d 7478 5f72 6563 6970 6965  pient=tx_recipie
-00012f80: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00012f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fa0: 746f 6b65 6e5f 696e 3d28 0a20 2020 2020  token_in=(.     
+00012ef0: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
+00012f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f20: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
+00012f30: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f50: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
+00012f60: 5f69 6e2c 0a20 2020 2020 2020 2020 2020  _in,.           
+00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f80: 2020 2020 2020 2020 2074 785f 616d 6f75           tx_amou
+00012f90: 6e74 5f6f 7574 5f6d 696e 696d 756d 2c0a  nt_out_minimum,.
+00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fc0: 2020 2020 2020 2020 2020 2076 335f 706f             v3_po
-00012fd0: 6f6c 2e74 6f6b 656e 300a 2020 2020 2020  ol.token0.      
+00012fc0: 2920 3d20 6675 6e63 5f70 6172 616d 735b  ) = func_params[
+00012fd0: 2270 6172 616d 7322 5d0a 0a20 2020 2020  "params"]..     
 00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ff0: 2020 2020 2020 2020 2020 6966 2076 335f            if v3_
-00013000: 706f 6f6c 2e74 6f6b 656e 3020 3d3d 2074  pool.token0 == t
-00013010: 785f 746f 6b65 6e5f 696e 5f61 6464 7265  x_token_in_addre
-00013020: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00012ff0: 2020 2020 2020 2023 2044 6563 6f64 6520         # Decode 
+00013000: 7769 7468 2049 5633 5377 6170 526f 7574  with IV3SwapRout
+00013010: 6572 2041 4249 2028 616b 6120 526f 7574  er ABI (aka Rout
+00013020: 6572 3229 0a20 2020 2020 2020 2020 2020  er2).           
 00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013040: 2020 2065 6c73 6520 7633 5f70 6f6f 6c2e     else v3_pool.
-00013050: 746f 6b65 6e31 0a20 2020 2020 2020 2020  token1.         
-00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013070: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013090: 2020 616d 6f75 6e74 5f69 6e3d 7478 5f61    amount_in=tx_a
-000130a0: 6d6f 756e 745f 696e 2c0a 2020 2020 2020  mount_in,.      
+00013040: 2023 2072 6566 3a20 6874 7470 733a 2f2f   # ref: https://
+00013050: 6769 7468 7562 2e63 6f6d 2f55 6e69 7377  github.com/Unisw
+00013060: 6170 2f73 7761 702d 726f 7574 6572 2d63  ap/swap-router-c
+00013070: 6f6e 7472 6163 7473 2f62 6c6f 622f 6d61  ontracts/blob/ma
+00013080: 696e 2f63 6f6e 7472 6163 7473 2f69 6e74  in/contracts/int
+00013090: 6572 6661 6365 732f 4956 3353 7761 7052  erfaces/IV3SwapR
+000130a0: 6f75 7465 722e 736f 6c0a 2020 2020 2020  outer.sol.      
 000130b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130c0: 2020 2020 2020 616d 6f75 6e74 5f6f 7574        amount_out
-000130d0: 5f6d 696e 3d74 785f 616d 6f75 6e74 5f6f  _min=tx_amount_o
-000130e0: 7574 5f6d 696e 2c0a 2020 2020 2020 2020  ut_min,.        
+000130c0: 2020 2020 2020 656c 6966 206c 656e 2866        elif len(f
+000130d0: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+000130e0: 6d73 225d 2920 3d3d 2034 3a0a 2020 2020  ms"]) == 4:.    
 000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013100: 2020 2020 6669 7273 745f 7377 6170 3d54      first_swap=T
-00013110: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00013120: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00013130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013140: 2020 2020 2020 2020 5f76 335f 726f 7574          _v3_rout
-00013150: 6572 5f66 7574 7572 655f 706f 6f6c 5f73  er_future_pool_s
-00013160: 7461 7465 732e 6170 7065 6e64 2828 7633  tates.append((v3
-00013170: 5f70 6f6f 6c2c 2076 335f 7369 6d5f 7265  _pool, v3_sim_re
-00013180: 7375 6c74 2929 0a0a 2020 2020 2020 2020  sult))..        
-00013190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131a0: 746f 6b65 6e5f 6f75 745f 7175 616e 7469  token_out_quanti
-000131b0: 7479 203d 202d 6d69 6e28 0a20 2020 2020  ty = -min(.     
-000131c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131d0: 2020 2020 2020 2076 335f 7369 6d5f 7265         v3_sim_re
-000131e0: 7375 6c74 2e61 6d6f 756e 7431 5f64 656c  sult.amount1_del
-000131f0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00013200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013210: 7633 5f73 696d 5f72 6573 756c 742e 616d  v3_sim_result.am
-00013220: 6f75 6e74 305f 6465 6c74 612c 0a20 2020  ount0_delta,.   
-00013230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013240: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00013250: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00013260: 2022 6578 6163 7449 6e70 7574 223a 0a20   "exactInput":. 
+00013100: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
+00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013130: 2020 7478 5f70 6174 682c 0a20 2020 2020    tx_path,.     
+00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013150: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00013160: 785f 7265 6369 7069 656e 742c 0a20 2020  x_recipient,.   
+00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013190: 2074 785f 616d 6f75 6e74 5f69 6e2c 0a20   tx_amount_in,. 
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131c0: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
+000131d0: 5f6d 696e 696d 756d 2c0a 2020 2020 2020  _minimum,.      
+000131e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131f0: 2020 2020 2020 2020 2020 2920 3d20 6675            ) = fu
+00013200: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
+00013210: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
+00013220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013230: 2020 2020 7478 5f64 6561 646c 696e 6520      tx_deadline 
+00013240: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013260: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
 00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013280: 2020 2020 2020 2023 2045 7874 7261 6374         # Extract
-00013290: 2070 6172 616d 6574 6572 7320 6672 6f6d   parameters from
-000132a0: 2074 6865 2064 6963 7420 7265 7375 6c74   the dict result
-000132b0: 7320 6f66 2077 6562 3370 7920 7636 0a20  s of web3py v6. 
-000132c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000132e0: 616e 6365 2866 756e 635f 7061 7261 6d73  ance(func_params
-000132f0: 5b22 7061 7261 6d73 225d 2c20 6469 6374  ["params"], dict
-00013300: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013310: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00013320: 785f 7061 7468 203d 2066 756e 635f 7061  x_path = func_pa
-00013330: 7261 6d73 5b22 7061 7261 6d73 225d 5b22  rams["params"]["
-00013340: 7061 7468 225d 0a20 2020 2020 2020 2020  path"].         
-00013350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013360: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
-00013370: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
-00013380: 6172 616d 7322 5d5b 2272 6563 6970 6965  arams"]["recipie
-00013390: 6e74 225d 0a20 2020 2020 2020 2020 2020  nt"].           
-000133a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133b0: 2074 785f 6465 6164 6c69 6e65 203d 2066   tx_deadline = f
-000133c0: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
-000133d0: 6d73 225d 2e67 6574 2822 6465 6164 6c69  ms"].get("deadli
-000133e0: 6e65 2229 0a20 2020 2020 2020 2020 2020  ne").           
-000133f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013400: 2074 785f 616d 6f75 6e74 5f69 6e20 3d20   tx_amount_in = 
-00013410: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-00013420: 616d 7322 5d5b 2261 6d6f 756e 7449 6e22  ams"]["amountIn"
-00013430: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00013440: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00013450: 5f61 6d6f 756e 745f 6f75 745f 6d69 6e69  _amount_out_mini
-00013460: 6d75 6d20 3d20 6675 6e63 5f70 6172 616d  mum = func_param
-00013470: 735b 2270 6172 616d 7322 5d5b 2261 6d6f  s["params"]["amo
-00013480: 756e 744f 7574 4d69 6e69 6d75 6d22 5d0a  untOutMinimum"].
-00013490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134a0: 2020 2020 2020 2020 2320 4578 7472 6163          # Extrac
-000134b0: 7420 7061 7261 6d65 7465 7273 2066 726f  t parameters fro
-000134c0: 6d20 7468 6520 7475 706c 6520 7265 7375  m the tuple resu
-000134d0: 6c74 7320 6f66 2077 6562 3370 7920 7635  lts of web3py v5
-000134e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000134f0: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00013500: 696e 7374 616e 6365 2866 756e 635f 7061  instance(func_pa
-00013510: 7261 6d73 5b22 7061 7261 6d73 225d 2c20  rams["params"], 
-00013520: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
-00013530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013540: 2020 2020 2320 4465 636f 6465 2077 6974      # Decode wit
-00013550: 6820 4953 7761 7052 6f75 7465 7220 4142  h ISwapRouter AB
-00013560: 490a 2020 2020 2020 2020 2020 2020 2020  I.              
-00013570: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00013580: 7265 663a 2068 7474 7073 3a2f 2f67 6974  ref: https://git
-00013590: 6875 622e 636f 6d2f 556e 6973 7761 702f  hub.com/Uniswap/
-000135a0: 7633 2d70 6572 6970 6865 7279 2f62 6c6f  v3-periphery/blo
-000135b0: 622f 6d61 696e 2f63 6f6e 7472 6163 7473  b/main/contracts
-000135c0: 2f69 6e74 6572 6661 6365 732f 4953 7761  /interfaces/ISwa
-000135d0: 7052 6f75 7465 722e 736f 6c0a 2020 2020  pRouter.sol.    
-000135e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135f0: 2020 2020 2020 2020 6966 206c 656e 2866          if len(f
-00013600: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
-00013610: 6d73 225d 2920 3d3d 2035 3a0a 2020 2020  ms"]) == 5:.    
-00013620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013630: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
-00013640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013280: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00013290: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+000132a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000132c0: 2243 6f75 6c64 206e 6f74 2065 7874 7261  "Could not extra
+000132d0: 6374 2070 6172 616d 6574 6572 7320 666f  ct parameters fo
+000132e0: 7220 6675 6e63 7469 6f6e 207b 6675 6e63  r function {func
+000132f0: 5f6e 616d 657d 2077 6974 6820 7061 7261  _name} with para
+00013300: 6d65 7465 7273 207b 6675 6e63 5f70 6172  meters {func_par
+00013310: 616d 735b 2770 6172 616d 7327 5d7d 220a  ams['params']}".
+00013320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013340: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013350: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00013360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013370: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013380: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00013390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000133a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000133b0: 436f 756c 6420 6e6f 7420 6964 656e 7469  Could not identi
+000133c0: 6679 2074 7970 6520 666f 7220 6675 6e63  fy type for func
+000133d0: 7469 6f6e 2070 6172 616d 732e 2045 7870  tion params. Exp
+000133e0: 6563 7465 6420 7475 706c 6520 6f72 2064  ected tuple or d
+000133f0: 6963 742c 2067 6f74 207b 7479 7065 2866  ict, got {type(f
+00013400: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+00013410: 6d73 225d 297d 270a 2020 2020 2020 2020  ms"])}'.        
+00013420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013430: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00013440: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00013450: 6620 7478 5f64 6561 646c 696e 653a 0a20  f tx_deadline:. 
+00013460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013470: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00013480: 5f72 6169 7365 5f69 665f 7061 7374 5f64  _raise_if_past_d
+00013490: 6561 646c 696e 6528 7478 5f64 6561 646c  eadline(tx_deadl
+000134a0: 696e 6529 0a0a 2020 2020 2020 2020 2020  ine)..          
+000134b0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+000134c0: 5f70 6174 685f 6465 636f 6465 6420 3d20  _path_decoded = 
+000134d0: 6465 636f 6465 5f76 335f 7061 7468 2874  decode_v3_path(t
+000134e0: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
+000134f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013500: 2069 6620 6e6f 7420 7369 6c65 6e74 3a0a   if not silent:.
+00013510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013520: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013530: 6572 2e69 6e66 6f28 6622 20e2 80a2 2070  er.info(f" ... p
+00013540: 6174 6820 3d20 7b74 785f 7061 7468 5f64  ath = {tx_path_d
+00013550: 6563 6f64 6564 7d22 290a 2020 2020 2020  ecoded}").      
+00013560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013570: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00013580: 6f28 6622 20e2 80a2 2072 6563 6970 6965  o(f" ... recipie
+00013590: 6e74 203d 207b 7478 5f72 6563 6970 6965  nt = {tx_recipie
+000135a0: 6e74 7d22 290a 2020 2020 2020 2020 2020  nt}").          
+000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000135d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135e0: 2020 2020 2020 2074 785f 6465 6164 6c69         tx_deadli
+000135f0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00013600: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00013610: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+00013620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013640: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
 00013650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013660: 2020 7478 5f70 6174 682c 0a20 2020 2020    tx_path,.     
+00013660: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013680: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00013690: 785f 7265 6369 7069 656e 742c 0a20 2020  x_recipient,.   
-000136a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136c0: 2074 785f 6465 6164 6c69 6e65 2c0a 2020   tx_deadline,.  
-000136d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136f0: 2020 7478 5f61 6d6f 756e 745f 696e 2c0a    tx_amount_in,.
-00013700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013720: 2020 2020 7478 5f61 6d6f 756e 745f 6f75      tx_amount_ou
-00013730: 745f 6d69 6e69 6d75 6d2c 0a20 2020 2020  t_minimum,.     
-00013740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013750: 2020 2020 2020 2020 2020 2029 203d 2066             ) = f
-00013760: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
-00013770: 6d73 225d 0a0a 2020 2020 2020 2020 2020  ms"]..          
-00013780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013790: 2020 2320 4465 636f 6465 2077 6974 6820    # Decode with 
-000137a0: 4956 3353 7761 7052 6f75 7465 7220 4142  IV3SwapRouter AB
-000137b0: 4920 2861 6b61 2052 6f75 7465 7232 290a  I (aka Router2).
-000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137d0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-000137e0: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
-000137f0: 622e 636f 6d2f 556e 6973 7761 702f 7377  b.com/Uniswap/sw
-00013800: 6170 2d72 6f75 7465 722d 636f 6e74 7261  ap-router-contra
-00013810: 6374 732f 626c 6f62 2f6d 6169 6e2f 636f  cts/blob/main/co
-00013820: 6e74 7261 6374 732f 696e 7465 7266 6163  ntracts/interfac
-00013830: 6573 2f49 5633 5377 6170 526f 7574 6572  es/IV3SwapRouter
-00013840: 2e73 6f6c 0a20 2020 2020 2020 2020 2020  .sol.           
-00013850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013860: 2065 6c69 6620 6c65 6e28 6675 6e63 5f70   elif len(func_p
-00013870: 6172 616d 735b 2270 6172 616d 7322 5d29  arams["params"])
-00013880: 203d 3d20 343a 0a20 2020 2020 2020 2020   == 4:.         
-00013890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138a0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
+00013680: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00013690: 6e66 6f28 6622 20e2 80a2 2064 6561 646c  nfo(f" ... deadl
+000136a0: 696e 6520 3d20 7b74 785f 6465 6164 6c69  ine = {tx_deadli
+000136b0: 6e65 7d22 290a 2020 2020 2020 2020 2020  ne}").          
+000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136d0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+000136e0: 20e2 80a2 2061 6d6f 756e 7449 6e20 3d20   ... amountIn = 
+000136f0: 7b74 785f 616d 6f75 6e74 5f69 6e7d 2229  {tx_amount_in}")
+00013700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013710: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00013720: 6765 722e 696e 666f 2866 2220 e280 a220  ger.info(f" ... 
+00013730: 616d 6f75 6e74 4f75 744d 696e 696d 756d  amountOutMinimum
+00013740: 203d 207b 7478 5f61 6d6f 756e 745f 6f75   = {tx_amount_ou
+00013750: 745f 6d69 6e69 6d75 6d7d 2229 0a0a 2020  t_minimum}")..  
+00013760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013770: 2020 2020 2020 6c61 7374 5f74 6f6b 656e        last_token
+00013780: 5f70 6f73 203d 206c 656e 2874 785f 7061  _pos = len(tx_pa
+00013790: 7468 5f64 6563 6f64 6564 2920 2d20 330a  th_decoded) - 3.
+000137a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000137b0: 2020 2020 2020 2020 2066 6f72 2074 6f6b           for tok
+000137c0: 656e 5f70 6f73 2069 6e20 7261 6e67 6528  en_pos in range(
+000137d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000137e0: 2020 2020 2020 2020 2020 2020 2030 2c0a               0,.
+000137f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013800: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+00013810: 7478 5f70 6174 685f 6465 636f 6465 6429  tx_path_decoded)
+00013820: 202d 2032 2c0a 2020 2020 2020 2020 2020   - 2,.          
+00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013840: 2020 322c 0a20 2020 2020 2020 2020 2020    2,.           
+00013850: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00013860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013870: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
+00013880: 6f6b 656e 5f69 6e5f 6164 6472 6573 7320  oken_in_address 
+00013890: 3d20 7478 5f70 6174 685f 6465 636f 6465  = tx_path_decode
+000138a0: 645b 746f 6b65 6e5f 706f 735d 0a20 2020  d[token_pos].   
 000138b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138c0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-000138d0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138f0: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
-00013900: 6970 6965 6e74 2c0a 2020 2020 2020 2020  ipient,.        
-00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013920: 2020 2020 2020 2020 2020 2020 7478 5f61              tx_a
-00013930: 6d6f 756e 745f 696e 2c0a 2020 2020 2020  mount_in,.      
-00013940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013950: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00013960: 5f61 6d6f 756e 745f 6f75 745f 6d69 6e69  _amount_out_mini
-00013970: 6d75 6d2c 0a20 2020 2020 2020 2020 2020  mum,.           
+000138c0: 2020 2020 2020 2020 2074 785f 6665 6520           tx_fee 
+000138d0: 3d20 7478 5f70 6174 685f 6465 636f 6465  = tx_path_decode
+000138e0: 645b 746f 6b65 6e5f 706f 7320 2b20 315d  d[token_pos + 1]
+000138f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013900: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
+00013910: 746f 6b65 6e5f 6f75 745f 6164 6472 6573  token_out_addres
+00013920: 7320 3d20 7478 5f70 6174 685f 6465 636f  s = tx_path_deco
+00013930: 6465 645b 746f 6b65 6e5f 706f 7320 2b20  ded[token_pos + 
+00013940: 325d 0a0a 2020 2020 2020 2020 2020 2020  2]..            
+00013950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013960: 6966 2054 5950 455f 4348 4543 4b49 4e47  if TYPE_CHECKING
+00013970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013990: 2020 2020 2029 203d 2066 756e 635f 7061       ) = func_pa
-000139a0: 7261 6d73 5b22 7061 7261 6d73 225d 0a20  rams["params"]. 
-000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000139d0: 785f 6465 6164 6c69 6e65 203d 204e 6f6e  x_deadline = Non
-000139e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000139f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00013a00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a20: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00013a30: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00013a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a50: 2020 2020 2020 2020 2020 6622 436f 756c            f"Coul
-00013a60: 6420 6e6f 7420 6578 7472 6163 7420 7061  d not extract pa
-00013a70: 7261 6d65 7465 7273 2066 6f72 2066 756e  rameters for fun
-00013a80: 6374 696f 6e20 7b66 756e 635f 6e61 6d65  ction {func_name
-00013a90: 7d20 7769 7468 2070 6172 616d 6574 6572  } with parameter
-00013aa0: 7320 7b66 756e 635f 7061 7261 6d73 5b27  s {func_params['
-00013ab0: 7061 7261 6d73 275d 7d22 0a20 2020 2020  params']}".     
-00013ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ad0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00013ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013af0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00013990: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000139a0: 6e63 6528 7478 5f74 6f6b 656e 5f69 6e5f  nce(tx_token_in_
+000139b0: 6164 6472 6573 732c 2073 7472 290a 2020  address, str).  
+000139c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139d0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000139e0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+000139f0: 7478 5f66 6565 2c20 696e 7429 0a20 2020  tx_fee, int).   
+00013a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a10: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00013a20: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
+00013a30: 785f 746f 6b65 6e5f 6f75 745f 6164 6472  x_token_out_addr
+00013a40: 6573 732c 2073 7472 290a 0a20 2020 2020  ess, str)..     
+00013a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a60: 2020 2020 2020 2066 6972 7374 5f73 7761         first_swa
+00013a70: 7020 3d20 746f 6b65 6e5f 706f 7320 3d3d  p = token_pos ==
+00013a80: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00013a90: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00013aa0: 6173 745f 7377 6170 203d 2074 6f6b 656e  ast_swap = token
+00013ab0: 5f70 6f73 203d 3d20 6c61 7374 5f74 6f6b  _pos == last_tok
+00013ac0: 656e 5f70 6f73 0a0a 2020 2020 2020 2020  en_pos..        
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ae0: 2020 2020 6966 2054 5950 455f 4348 4543      if TYPE_CHEC
+00013af0: 4b49 4e47 3a0a 2020 2020 2020 2020 2020  KING:.          
 00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00013b20: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00013b10: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00013b20: 6e73 7461 6e63 6528 0a20 2020 2020 2020  nstance(.       
 00013b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b40: 2020 2020 2020 2020 2066 2743 6f75 6c64           f'Could
-00013b50: 206e 6f74 2069 6465 6e74 6966 7920 7479   not identify ty
-00013b60: 7065 2066 6f72 2066 756e 6374 696f 6e20  pe for function 
-00013b70: 7061 7261 6d73 2e20 4578 7065 6374 6564  params. Expected
-00013b80: 2074 7570 6c65 206f 7220 6469 6374 2c20   tuple or dict, 
-00013b90: 676f 7420 7b74 7970 6528 6675 6e63 5f70  got {type(func_p
-00013ba0: 6172 616d 735b 2270 6172 616d 7322 5d29  arams["params"])
-00013bb0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00013bc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00013bd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013be0: 2020 2020 2020 2020 2020 6966 2074 785f            if tx_
-00013bf0: 6465 6164 6c69 6e65 3a0a 2020 2020 2020  deadline:.      
-00013c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c10: 2020 2020 2020 7365 6c66 2e5f 7261 6973        self._rais
-00013c20: 655f 6966 5f65 7870 6972 6564 2874 785f  e_if_expired(tx_
-00013c30: 6465 6164 6c69 6e65 290a 0a20 2020 2020  deadline)..     
-00013c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c50: 2020 2074 785f 7061 7468 5f64 6563 6f64     tx_path_decod
-00013c60: 6564 203d 2064 6563 6f64 655f 7633 5f70  ed = decode_v3_p
-00013c70: 6174 6828 7478 5f70 6174 6829 0a0a 2020  ath(tx_path)..  
-00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c90: 2020 2020 2020 6966 206e 6f74 2073 696c        if not sil
-00013ca0: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+00013b40: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00013b50: 662e 7633 5f70 6f6f 6c5f 6d61 6e61 6765  f.v3_pool_manage
+00013b60: 722c 2055 6e69 7377 6170 5633 4c69 7175  r, UniswapV3Liqu
+00013b70: 6964 6974 7950 6f6f 6c4d 616e 6167 6572  idityPoolManager
+00013b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ba0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00013bb0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00013bc0: 335f 706f 6f6c 203d 2073 656c 662e 7633  3_pool = self.v3
+00013bd0: 5f70 6f6f 6c5f 6d61 6e61 6765 722e 6765  _pool_manager.ge
+00013be0: 745f 706f 6f6c 280a 2020 2020 2020 2020  t_pool(.        
+00013bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c00: 2020 2020 2020 2020 746f 6b65 6e5f 6164          token_ad
+00013c10: 6472 6573 7365 733d 280a 2020 2020 2020  dresses=(.      
+00013c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c30: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00013c40: 5f74 6f6b 656e 5f69 6e5f 6164 6472 6573  _token_in_addres
+00013c50: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00013c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c70: 2020 2020 2020 2074 785f 746f 6b65 6e5f         tx_token_
+00013c80: 6f75 745f 6164 6472 6573 732c 0a20 2020  out_address,.   
+00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ca0: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
 00013cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cc0: 206c 6f67 6765 722e 696e 666f 2866 2220   logger.info(f" 
-00013cd0: e280 a220 7061 7468 203d 207b 7478 5f70  ... path = {tx_p
-00013ce0: 6174 685f 6465 636f 6465 647d 2229 0a20  ath_decoded}"). 
+00013cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cd0: 706f 6f6c 5f66 6565 3d74 785f 6665 652c  pool_fee=tx_fee,
+00013ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00013cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d00: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00013d10: 722e 696e 666f 2866 2220 e280 a220 7265  r.info(f" ... re
-00013d20: 6369 7069 656e 7420 3d20 7b74 785f 7265  cipient = {tx_re
-00013d30: 6369 7069 656e 747d 2229 0a20 2020 2020  cipient}").     
+00013d00: 2073 696c 656e 743d 7365 6c66 2e73 696c   silent=self.sil
+00013d10: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d30: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
 00013d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00013d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d70: 2020 2020 2020 2020 2020 2020 7478 5f64              tx_d
-00013d80: 6561 646c 696e 650a 2020 2020 2020 2020  eadline.        
+00013d50: 5f2c 2076 335f 7369 6d5f 7265 7375 6c74  _, v3_sim_result
+00013d60: 203d 2073 656c 662e 5f73 696d 756c 6174   = self._simulat
+00013d70: 655f 7633 5f73 7761 705f 6578 6163 745f  e_v3_swap_exact_
+00013d80: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
 00013d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013da0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00013db0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00013da0: 2020 2020 706f 6f6c 3d76 335f 706f 6f6c      pool=v3_pool
+00013db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00013dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013dd0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00013de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013df0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e10: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00013e20: 6765 722e 696e 666f 2866 2220 e280 a220  ger.info(f" ... 
-00013e30: 6465 6164 6c69 6e65 203d 207b 7478 5f64  deadline = {tx_d
-00013e40: 6561 646c 696e 657d 2229 0a20 2020 2020  eadline}").     
-00013e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e60: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00013e70: 666f 2866 2220 e280 a220 616d 6f75 6e74  fo(f" ... amount
-00013e80: 496e 203d 207b 7478 5f61 6d6f 756e 745f  In = {tx_amount_
-00013e90: 696e 7d22 290a 2020 2020 2020 2020 2020  in}").          
+00013dd0: 2020 7265 6369 7069 656e 743d 7478 5f72    recipient=tx_r
+00013de0: 6563 6970 6965 6e74 0a20 2020 2020 2020  ecipient.       
+00013df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e00: 2020 2020 2020 2020 2069 6620 6c61 7374           if last
+00013e10: 5f73 7761 700a 2020 2020 2020 2020 2020  _swap.          
+00013e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e30: 2020 2020 2020 656c 7365 2055 6e69 7665        else Unive
+00013e40: 7273 616c 526f 7574 6572 5370 6563 6961  rsalRouterSpecia
+00013e50: 6c41 6464 7265 7373 2e52 4f55 5445 522c  lAddress.ROUTER,
+00013e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e80: 2074 6f6b 656e 5f69 6e3d 7633 5f70 6f6f   token_in=v3_poo
+00013e90: 6c2e 746f 6b65 6e30 0a20 2020 2020 2020  l.token0.       
 00013ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013eb0: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
-00013ec0: 20e2 80a2 2061 6d6f 756e 744f 7574 4d69   ... amountOutMi
-00013ed0: 6e69 6d75 6d20 3d20 7b74 785f 616d 6f75  nimum = {tx_amou
-00013ee0: 6e74 5f6f 7574 5f6d 696e 696d 756d 7d22  nt_out_minimum}"
-00013ef0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00013f00: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-00013f10: 746f 6b65 6e5f 706f 7320 3d20 6c65 6e28  token_pos = len(
-00013f20: 7478 5f70 6174 685f 6465 636f 6465 6429  tx_path_decoded)
-00013f30: 202d 2033 0a0a 2020 2020 2020 2020 2020   - 3..          
-00013f40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00013f50: 7220 746f 6b65 6e5f 706f 7320 696e 2072  r token_pos in r
-00013f60: 616e 6765 280a 2020 2020 2020 2020 2020  ange(.          
-00013f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f80: 2020 302c 0a20 2020 2020 2020 2020 2020    0,.           
-00013f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fa0: 206c 656e 2874 785f 7061 7468 5f64 6563   len(tx_path_dec
-00013fb0: 6f64 6564 2920 2d20 322c 0a20 2020 2020  oded) - 2,.     
-00013fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fd0: 2020 2020 2020 2032 2c0a 2020 2020 2020         2,.      
-00013fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ff0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00014000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014010: 2074 785f 746f 6b65 6e5f 696e 5f61 6464   tx_token_in_add
-00014020: 7265 7373 203d 2074 785f 7061 7468 5f64  ress = tx_path_d
-00014030: 6563 6f64 6564 5b74 6f6b 656e 5f70 6f73  ecoded[token_pos
-00014040: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00014050: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00014060: 5f66 6565 203d 2074 785f 7061 7468 5f64  _fee = tx_path_d
-00014070: 6563 6f64 6564 5b74 6f6b 656e 5f70 6f73  ecoded[token_pos
-00014080: 202b 2031 5d0a 2020 2020 2020 2020 2020   + 1].          
-00014090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140a0: 2020 7478 5f74 6f6b 656e 5f6f 7574 5f61    tx_token_out_a
-000140b0: 6464 7265 7373 203d 2074 785f 7061 7468  ddress = tx_path
-000140c0: 5f64 6563 6f64 6564 5b74 6f6b 656e 5f70  _decoded[token_p
-000140d0: 6f73 202b 2032 5d0a 0a20 2020 2020 2020  os + 2]..       
-000140e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140f0: 2020 2020 2069 6620 5459 5045 5f43 4845       if TYPE_CHE
-00014100: 434b 494e 473a 0a20 2020 2020 2020 2020  CKING:.         
+00013eb0: 2020 2020 2020 2020 2069 6620 7633 5f70           if v3_p
+00013ec0: 6f6f 6c2e 746f 6b65 6e30 203d 3d20 7478  ool.token0 == tx
+00013ed0: 5f74 6f6b 656e 5f69 6e5f 6164 6472 6573  _token_in_addres
+00013ee0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00013ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f00: 2020 656c 7365 2076 335f 706f 6f6c 2e74    else v3_pool.t
+00013f10: 6f6b 656e 312c 0a20 2020 2020 2020 2020  oken1,.         
+00013f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f30: 2020 2020 2020 2061 6d6f 756e 745f 696e         amount_in
+00013f40: 3d74 785f 616d 6f75 6e74 5f69 6e20 6966  =tx_amount_in if
+00013f50: 2074 6f6b 656e 5f70 6f73 203d 3d20 3020   token_pos == 0 
+00013f60: 656c 7365 2074 6f6b 656e 5f6f 7574 5f71  else token_out_q
+00013f70: 7561 6e74 6974 792c 0a20 2020 2020 2020  uantity,.       
+00013f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f90: 2020 2020 2020 2020 2023 206f 6e6c 7920           # only 
+00013fa0: 6170 706c 7920 6d69 6e69 6d75 6d20 6f75  apply minimum ou
+00013fb0: 7470 7574 2074 6f20 7468 6520 6c61 7374  tput to the last
+00013fc0: 2073 7761 700a 2020 2020 2020 2020 2020   swap.          
+00013fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fe0: 2020 2020 2020 616d 6f75 6e74 5f6f 7574        amount_out
+00013ff0: 5f6d 696e 3d74 785f 616d 6f75 6e74 5f6f  _min=tx_amount_o
+00014000: 7574 5f6d 696e 696d 756d 2069 6620 6c61  ut_minimum if la
+00014010: 7374 5f73 7761 7020 656c 7365 204e 6f6e  st_swap else Non
+00014020: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014040: 2020 2066 6972 7374 5f73 7761 703d 6669     first_swap=fi
+00014050: 7273 745f 7377 6170 2c0a 2020 2020 2020  rst_swap,.      
+00014060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014070: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00014080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014090: 2020 2020 2073 656c 662e 7369 6d75 6c61       self.simula
+000140a0: 7465 645f 706f 6f6c 5f73 7461 7465 732e  ted_pool_states.
+000140b0: 6170 7065 6e64 2828 7633 5f70 6f6f 6c2c  append((v3_pool,
+000140c0: 2076 335f 7369 6d5f 7265 7375 6c74 2929   v3_sim_result))
+000140d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000140e0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000140f0: 6b65 6e5f 6f75 745f 7175 616e 7469 7479  ken_out_quantity
+00014100: 203d 202d 6d69 6e28 0a20 2020 2020 2020   = -min(.       
 00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014120: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00014130: 696e 7374 616e 6365 2874 785f 746f 6b65  instance(tx_toke
-00014140: 6e5f 696e 5f61 6464 7265 7373 2c20 7374  n_in_address, st
-00014150: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00014160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014170: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00014180: 616e 6365 2874 785f 6665 652c 2069 6e74  ance(tx_fee, int
-00014190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000141a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141b0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000141c0: 6e63 6528 7478 5f74 6f6b 656e 5f6f 7574  nce(tx_token_out
-000141d0: 5f61 6464 7265 7373 2c20 7374 7229 0a0a  _address, str)..
-000141e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141f0: 2020 2020 2020 2020 2020 2020 6669 7273              firs
-00014200: 745f 7377 6170 203d 2074 6f6b 656e 5f70  t_swap = token_p
-00014210: 6f73 203d 3d20 300a 2020 2020 2020 2020  os == 0.        
+00014120: 2020 2020 2020 2020 2076 335f 7369 6d5f           v3_sim_
+00014130: 7265 7375 6c74 2e61 6d6f 756e 7430 5f64  result.amount0_d
+00014140: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
+00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014160: 2020 2020 2020 7633 5f73 696d 5f72 6573        v3_sim_res
+00014170: 756c 742e 616d 6f75 6e74 315f 6465 6c74  ult.amount1_delt
+00014180: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+00014190: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000141a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000141b0: 2020 2020 2020 6361 7365 2022 6578 6163        case "exac
+000141c0: 744f 7574 7075 7453 696e 676c 6522 3a0a  tOutputSingle":.
+000141d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000141e0: 2020 2020 2020 2020 2320 4578 7472 6163          # Extrac
+000141f0: 7420 7061 7261 6d65 7465 7273 2066 726f  t parameters fro
+00014200: 6d20 7468 6520 6469 6374 2072 6573 756c  m the dict resul
+00014210: 7473 206f 6620 7765 6233 7079 2076 360a  ts of web3py v6.
 00014220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014230: 2020 2020 6c61 7374 5f73 7761 7020 3d20      last_swap = 
-00014240: 746f 6b65 6e5f 706f 7320 3d3d 206c 6173  token_pos == las
-00014250: 745f 746f 6b65 6e5f 706f 730a 0a20 2020  t_token_pos..   
-00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014270: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
-00014280: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
-00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142a0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000142b0: 7420 6973 696e 7374 616e 6365 280a 2020  t isinstance(.  
+00014230: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00014240: 7461 6e63 6528 6675 6e63 5f70 6172 616d  tance(func_param
+00014250: 735b 2270 6172 616d 7322 5d2c 2064 6963  s["params"], dic
+00014260: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00014270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014280: 7478 5f74 6f6b 656e 5f69 6e5f 6164 6472  tx_token_in_addr
+00014290: 6573 7320 3d20 6675 6e63 5f70 6172 616d  ess = func_param
+000142a0: 735b 2270 6172 616d 7322 5d5b 2274 6f6b  s["params"]["tok
+000142b0: 656e 496e 225d 0a20 2020 2020 2020 2020  enIn"].         
 000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142e0: 2020 7365 6c66 2e76 335f 706f 6f6c 5f6d    self.v3_pool_m
-000142f0: 616e 6167 6572 2c20 556e 6973 7761 7056  anager, UniswapV
-00014300: 334c 6971 7569 6469 7479 506f 6f6c 4d61  3LiquidityPoolMa
-00014310: 6e61 6765 720a 2020 2020 2020 2020 2020  nager.          
-00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014330: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014350: 2020 2020 7633 5f70 6f6f 6c20 3d20 7365      v3_pool = se
-00014360: 6c66 2e76 335f 706f 6f6c 5f6d 616e 6167  lf.v3_pool_manag
-00014370: 6572 2e67 6574 5f70 6f6f 6c28 0a20 2020  er.get_pool(.   
-00014380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014390: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-000143a0: 656e 5f61 6464 7265 7373 6573 3d28 0a20  en_addresses=(. 
-000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143d0: 2020 2074 785f 746f 6b65 6e5f 696e 5f61     tx_token_in_a
-000143e0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+000142d0: 2020 2074 785f 746f 6b65 6e5f 6f75 745f     tx_token_out_
+000142e0: 6164 6472 6573 7320 3d20 6675 6e63 5f70  address = func_p
+000142f0: 6172 616d 735b 2270 6172 616d 7322 5d5b  arams["params"][
+00014300: 2274 6f6b 656e 4f75 7422 5d0a 2020 2020  "tokenOut"].    
+00014310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014320: 2020 2020 2020 2020 7478 5f66 6565 203d          tx_fee =
+00014330: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
+00014340: 7261 6d73 225d 5b22 6665 6522 5d0a 2020  rams"]["fee"].  
+00014350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014360: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
+00014370: 6970 6965 6e74 203d 2066 756e 635f 7061  ipient = func_pa
+00014380: 7261 6d73 5b22 7061 7261 6d73 225d 5b22  rams["params"]["
+00014390: 7265 6369 7069 656e 7422 5d0a 2020 2020  recipient"].    
+000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143b0: 2020 2020 2020 2020 7478 5f64 6561 646c          tx_deadl
+000143c0: 696e 6520 3d20 6675 6e63 5f70 6172 616d  ine = func_param
+000143d0: 735b 2270 6172 616d 7322 5d2e 6765 7428  s["params"].get(
+000143e0: 2264 6561 646c 696e 6522 290a 2020 2020  "deadline").    
 000143f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014400: 2020 2020 2020 2020 2020 2020 7478 5f74              tx_t
-00014410: 6f6b 656e 5f6f 7574 5f61 6464 7265 7373  oken_out_address
-00014420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014440: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014460: 2020 2020 2070 6f6f 6c5f 6665 653d 7478       pool_fee=tx
-00014470: 5f66 6565 2c0a 2020 2020 2020 2020 2020  _fee,.          
-00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014490: 2020 2020 2020 7369 6c65 6e74 3d73 656c        silent=sel
-000144a0: 662e 7369 6c65 6e74 2c0a 2020 2020 2020  f.silent,.      
-000144b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144c0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000144d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144e0: 2020 2020 205f 2c20 7633 5f73 696d 5f72       _, v3_sim_r
-000144f0: 6573 756c 7420 3d20 7365 6c66 2e5f 7369  esult = self._si
-00014500: 6d75 6c61 7465 5f76 335f 7377 6170 5f65  mulate_v3_swap_e
-00014510: 7861 6374 5f69 6e28 0a20 2020 2020 2020  xact_in(.       
-00014520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014530: 2020 2020 2020 2020 2070 6f6f 6c3d 7633           pool=v3
-00014540: 5f70 6f6f 6c2c 0a20 2020 2020 2020 2020  _pool,.         
-00014550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014560: 2020 2020 2020 2072 6563 6970 6965 6e74         recipient
-00014570: 3d74 785f 7265 6369 7069 656e 740a 2020  =tx_recipient.  
-00014580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014590: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000145a0: 206c 6173 745f 7377 6170 0a20 2020 2020   last_swap.     
-000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145c0: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
-000145d0: 556e 6976 6572 7361 6c52 6f75 7465 7253  UniversalRouterS
-000145e0: 7065 6369 616c 4164 6472 6573 732e 524f  pecialAddress.RO
-000145f0: 5554 4552 2c0a 2020 2020 2020 2020 2020  UTER,.          
-00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014610: 2020 2020 2020 746f 6b65 6e5f 696e 3d76        token_in=v
-00014620: 335f 706f 6f6c 2e74 6f6b 656e 300a 2020  3_pool.token0.  
-00014630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014640: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014650: 2076 335f 706f 6f6c 2e74 6f6b 656e 3020   v3_pool.token0 
-00014660: 3d3d 2074 785f 746f 6b65 6e5f 696e 5f61  == tx_token_in_a
-00014670: 6464 7265 7373 0a20 2020 2020 2020 2020  ddress.         
+00014400: 2020 2020 2020 2020 7478 5f61 6d6f 756e          tx_amoun
+00014410: 745f 6f75 7420 3d20 6675 6e63 5f70 6172  t_out = func_par
+00014420: 616d 735b 2270 6172 616d 7322 5d5b 2261  ams["params"]["a
+00014430: 6d6f 756e 744f 7574 225d 0a20 2020 2020  mountOut"].     
+00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014450: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
+00014460: 5f69 6e5f 6d61 7820 3d20 6675 6e63 5f70  _in_max = func_p
+00014470: 6172 616d 735b 2270 6172 616d 7322 5d5b  arams["params"][
+00014480: 2261 6d6f 756e 7449 6e4d 6178 696d 756d  "amountInMaximum
+00014490: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+000144a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000144b0: 785f 7371 7274 5f70 7269 6365 5f6c 696d  x_sqrt_price_lim
+000144c0: 6974 5f78 3936 203d 2066 756e 635f 7061  it_x96 = func_pa
+000144d0: 7261 6d73 5b22 7061 7261 6d73 225d 5b22  rams["params"]["
+000144e0: 7371 7274 5072 6963 654c 696d 6974 5839  sqrtPriceLimitX9
+000144f0: 3622 5d0a 2020 2020 2020 2020 2020 2020  6"].            
+00014500: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
+00014510: 7472 6163 7420 7061 7261 6d65 7465 7273  tract parameters
+00014520: 2066 726f 6d20 7468 6520 7475 706c 6520   from the tuple 
+00014530: 7265 7375 6c74 7320 6f66 2077 6562 3370  results of web3p
+00014540: 7920 7635 0a20 2020 2020 2020 2020 2020  y v5.           
+00014550: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00014560: 6620 6973 696e 7374 616e 6365 2866 756e  f isinstance(fun
+00014570: 635f 7061 7261 6d73 5b22 7061 7261 6d73  c_params["params
+00014580: 225d 2c20 7475 706c 6529 3a0a 2020 2020  "], tuple):.    
+00014590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145a0: 2020 2020 2020 2020 2320 4465 636f 6465          # Decode
+000145b0: 2077 6974 6820 4953 7761 7052 6f75 7465   with ISwapRoute
+000145c0: 7220 4142 490a 2020 2020 2020 2020 2020  r ABI.          
+000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145e0: 2020 2320 6874 7470 733a 2f2f 6769 7468    # https://gith
+000145f0: 7562 2e63 6f6d 2f55 6e69 7377 6170 2f76  ub.com/Uniswap/v
+00014600: 332d 7065 7269 7068 6572 792f 626c 6f62  3-periphery/blob
+00014610: 2f6d 6169 6e2f 636f 6e74 7261 6374 732f  /main/contracts/
+00014620: 696e 7465 7266 6163 6573 2f49 5377 6170  interfaces/ISwap
+00014630: 526f 7574 6572 2e73 6f6c 0a20 2020 2020  Router.sol.     
+00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014650: 2020 2020 2020 2069 6620 6c65 6e28 6675         if len(fu
+00014660: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
+00014670: 7322 5d29 203d 3d20 383a 0a20 2020 2020  s"]) == 8:.     
 00014680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014690: 2020 2020 2020 2065 6c73 6520 7633 5f70         else v3_p
-000146a0: 6f6f 6c2e 746f 6b65 6e31 2c0a 2020 2020  ool.token1,.    
+00014690: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+000146a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000146b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146c0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-000146d0: 6e74 5f69 6e3d 7478 5f61 6d6f 756e 745f  nt_in=tx_amount_
-000146e0: 696e 2069 6620 746f 6b65 6e5f 706f 7320  in if token_pos 
-000146f0: 3d3d 2030 2065 6c73 6520 746f 6b65 6e5f  == 0 else token_
-00014700: 6f75 745f 7175 616e 7469 7479 2c0a 2020  out_quantity,.  
+000146c0: 2074 785f 746f 6b65 6e5f 696e 5f61 6464   tx_token_in_add
+000146d0: 7265 7373 2c0a 2020 2020 2020 2020 2020  ress,.          
+000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146f0: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
+00014700: 656e 5f6f 7574 5f61 6464 7265 7373 2c0a  en_out_address,.
 00014710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014720: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00014730: 6f6e 6c79 2061 7070 6c79 206d 696e 696d  only apply minim
-00014740: 756d 206f 7574 7075 7420 746f 2074 6865  um output to the
-00014750: 206c 6173 7420 7377 6170 0a20 2020 2020   last swap.     
-00014760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014770: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
-00014780: 745f 6f75 745f 6d69 6e3d 7478 5f61 6d6f  t_out_min=tx_amo
-00014790: 756e 745f 6f75 745f 6d69 6e69 6d75 6d20  unt_out_minimum 
-000147a0: 6966 206c 6173 745f 7377 6170 2065 6c73  if last_swap els
-000147b0: 6520 4e6f 6e65 2c0a 2020 2020 2020 2020  e None,.        
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2020 2020 2020 2020 6669 7273 745f 7377          first_sw
-000147e0: 6170 3d66 6972 7374 5f73 7761 702c 0a20  ap=first_swap,. 
-000147f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014800: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014730: 2020 2020 7478 5f66 6565 2c0a 2020 2020      tx_fee,.    
+00014740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014760: 7478 5f72 6563 6970 6965 6e74 2c0a 2020  tx_recipient,.  
+00014770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014790: 2020 7478 5f64 6561 646c 696e 652c 0a20    tx_deadline,. 
+000147a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147c0: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
+000147d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000147e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147f0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+00014800: 696e 5f6d 6178 2c0a 2020 2020 2020 2020  in_max,.        
 00014810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014820: 2020 2020 2020 2020 2020 5f76 335f 726f            _v3_ro
-00014830: 7574 6572 5f66 7574 7572 655f 706f 6f6c  uter_future_pool
-00014840: 5f73 7461 7465 732e 6170 7065 6e64 2828  _states.append((
-00014850: 7633 5f70 6f6f 6c2c 2076 335f 7369 6d5f  v3_pool, v3_sim_
-00014860: 7265 7375 6c74 2929 0a0a 2020 2020 2020  result))..      
-00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014880: 2020 2020 2020 746f 6b65 6e5f 6f75 745f        token_out_
-00014890: 7175 616e 7469 7479 203d 202d 6d69 6e28  quantity = -min(
-000148a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148c0: 2076 335f 7369 6d5f 7265 7375 6c74 2e61   v3_sim_result.a
-000148d0: 6d6f 756e 7430 5f64 656c 7461 2c0a 2020  mount0_delta,.  
-000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148f0: 2020 2020 2020 2020 2020 2020 2020 7633                v3
-00014900: 5f73 696d 5f72 6573 756c 742e 616d 6f75  _sim_result.amou
-00014910: 6e74 315f 6465 6c74 612c 0a20 2020 2020  nt1_delta,.     
-00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014930: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00014940: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00014950: 7365 2022 6578 6163 744f 7574 7075 7453  se "exactOutputS
-00014960: 696e 676c 6522 3a0a 2020 2020 2020 2020  ingle":.        
-00014970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014980: 2320 4578 7472 6163 7420 7061 7261 6d65  # Extract parame
-00014990: 7465 7273 2066 726f 6d20 7468 6520 6469  ters from the di
-000149a0: 6374 2072 6573 756c 7473 206f 6620 7765  ct results of we
-000149b0: 6233 7079 2076 360a 2020 2020 2020 2020  b3py v6.        
+00014820: 2020 2020 2020 2020 2020 2020 7478 5f73              tx_s
+00014830: 7172 745f 7072 6963 655f 6c69 6d69 745f  qrt_price_limit_
+00014840: 7839 362c 0a20 2020 2020 2020 2020 2020  x96,.           
+00014850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014860: 2020 2020 2029 203d 2066 756e 635f 7061       ) = func_pa
+00014870: 7261 6d73 5b22 7061 7261 6d73 225d 0a0a  rams["params"]..
+00014880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014890: 2020 2020 2020 2020 2020 2020 2320 4465              # De
+000148a0: 636f 6465 2077 6974 6820 4956 3353 7761  code with IV3Swa
+000148b0: 7052 6f75 7465 7220 4142 4920 2861 6b61  pRouter ABI (aka
+000148c0: 2052 6f75 7465 7232 290a 2020 2020 2020   Router2).      
+000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148e0: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
+000148f0: 6769 7468 7562 2e63 6f6d 2f55 6e69 7377  github.com/Unisw
+00014900: 6170 2f73 7761 702d 726f 7574 6572 2d63  ap/swap-router-c
+00014910: 6f6e 7472 6163 7473 2f62 6c6f 622f 6d61  ontracts/blob/ma
+00014920: 696e 2f63 6f6e 7472 6163 7473 2f69 6e74  in/contracts/int
+00014930: 6572 6661 6365 732f 4956 3353 7761 7052  erfaces/IV3SwapR
+00014940: 6f75 7465 722e 736f 6c0a 2020 2020 2020  outer.sol.      
+00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014960: 2020 2020 2020 656c 6966 206c 656e 2866        elif len(f
+00014970: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+00014980: 6d73 225d 2920 3d3d 2037 3a0a 2020 2020  ms"]) == 7:.    
+00014990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149a0: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
+000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 6966 2069 7369 6e73 7461 6e63 6528 6675  if isinstance(fu
-000149e0: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
-000149f0: 7322 5d2c 2064 6963 7429 3a0a 2020 2020  s"], dict):.    
-00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a10: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
-00014a20: 5f69 6e5f 6164 6472 6573 7320 3d20 6675  _in_address = fu
-00014a30: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
-00014a40: 7322 5d5b 2274 6f6b 656e 496e 225d 0a20  s"]["tokenIn"]. 
+000149d0: 2020 7478 5f74 6f6b 656e 5f69 6e5f 6164    tx_token_in_ad
+000149e0: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
+000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a00: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
+00014a10: 6b65 6e5f 6f75 745f 6164 6472 6573 732c  ken_out_address,
+00014a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a40: 2020 2020 2074 785f 6665 652c 0a20 2020       tx_fee,.   
 00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a60: 2020 2020 2020 2020 2020 2074 785f 746f             tx_to
-00014a70: 6b65 6e5f 6f75 745f 6164 6472 6573 7320  ken_out_address 
-00014a80: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
-00014a90: 6172 616d 7322 5d5b 2274 6f6b 656e 4f75  arams"]["tokenOu
-00014aa0: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-00014ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ac0: 7478 5f66 6565 203d 2066 756e 635f 7061  tx_fee = func_pa
-00014ad0: 7261 6d73 5b22 7061 7261 6d73 225d 5b22  rams["params"]["
-00014ae0: 6665 6522 5d0a 2020 2020 2020 2020 2020  fee"].          
+00014a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a70: 2074 785f 7265 6369 7069 656e 742c 0a20   tx_recipient,. 
+00014a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014aa0: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
+00014ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ad0: 2020 2020 2020 7478 5f61 6d6f 756e 745f        tx_amount_
+00014ae0: 696e 5f6d 6178 2c0a 2020 2020 2020 2020  in_max,.        
 00014af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b00: 2020 7478 5f72 6563 6970 6965 6e74 203d    tx_recipient =
-00014b10: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-00014b20: 7261 6d73 225d 5b22 7265 6369 7069 656e  rams"]["recipien
-00014b30: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-00014b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b50: 7478 5f64 6561 646c 696e 6520 3d20 6675  tx_deadline = fu
-00014b60: 6e63 5f70 6172 616d 735b 2270 6172 616d  nc_params["param
-00014b70: 7322 5d2e 6765 7428 2264 6561 646c 696e  s"].get("deadlin
-00014b80: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-00014b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ba0: 7478 5f61 6d6f 756e 745f 6f75 7420 3d20  tx_amount_out = 
-00014bb0: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
-00014bc0: 616d 7322 5d5b 2261 6d6f 756e 744f 7574  ams"]["amountOut
-00014bd0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-00014be0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00014bf0: 785f 616d 6f75 6e74 5f69 6e5f 6d61 7820  x_amount_in_max 
-00014c00: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
-00014c10: 6172 616d 7322 5d5b 2261 6d6f 756e 7449  arams"]["amountI
-00014c20: 6e4d 6178 696d 756d 225d 0a20 2020 2020  nMaximum"].     
-00014c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c40: 2020 2020 2020 2074 785f 7371 7274 5f70         tx_sqrt_p
-00014c50: 7269 6365 5f6c 696d 6974 5f78 3936 203d  rice_limit_x96 =
-00014c60: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-00014c70: 7261 6d73 225d 5b22 7371 7274 5072 6963  rams"]["sqrtPric
-00014c80: 654c 696d 6974 5839 3622 5d0a 2020 2020  eLimitX96"].    
+00014b00: 2020 2020 2020 2020 2020 2020 7478 5f73              tx_s
+00014b10: 7172 745f 7072 6963 655f 6c69 6d69 745f  qrt_price_limit_
+00014b20: 7839 362c 0a20 2020 2020 2020 2020 2020  x96,.           
+00014b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b40: 2020 2020 2029 203d 2066 756e 635f 7061       ) = func_pa
+00014b50: 7261 6d73 5b22 7061 7261 6d73 225d 0a20  rams["params"]. 
+00014b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00014b80: 785f 6465 6164 6c69 6e65 203d 204e 6f6e  x_deadline = Non
+00014b90: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00014ba0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00014bb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014bd0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00014be0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00014bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c00: 2020 2020 2020 2020 2020 6622 436f 756c            f"Coul
+00014c10: 6420 6e6f 7420 6578 7472 6163 7420 7061  d not extract pa
+00014c20: 7261 6d65 7465 7273 2066 6f72 2066 756e  rameters for fun
+00014c30: 6374 696f 6e20 7b66 756e 635f 6e61 6d65  ction {func_name
+00014c40: 7d20 7769 7468 2070 6172 616d 6574 6572  } with parameter
+00014c50: 7320 7b66 756e 635f 7061 7261 6d73 5b27  s {func_params['
+00014c60: 7061 7261 6d73 275d 7d22 0a20 2020 2020  params']}".     
+00014c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
 00014c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ca0: 2020 2020 2320 4578 7472 6163 7420 7061      # Extract pa
-00014cb0: 7261 6d65 7465 7273 2066 726f 6d20 7468  rameters from th
-00014cc0: 6520 7475 706c 6520 7265 7375 6c74 7320  e tuple results 
-00014cd0: 6f66 2077 6562 3370 7920 7635 0a20 2020  of web3py v5.   
+00014ca0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014cc0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00014cd0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
 00014ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014cf0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00014d00: 616e 6365 2866 756e 635f 7061 7261 6d73  ance(func_params
-00014d10: 5b22 7061 7261 6d73 225d 2c20 7475 706c  ["params"], tupl
-00014d20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00014d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d40: 2320 4465 636f 6465 2077 6974 6820 4953  # Decode with IS
-00014d50: 7761 7052 6f75 7465 7220 4142 490a 2020  wapRouter ABI.  
-00014d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d70: 2020 2020 2020 2020 2020 2320 6874 7470            # http
-00014d80: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f55  s://github.com/U
-00014d90: 6e69 7377 6170 2f76 332d 7065 7269 7068  niswap/v3-periph
-00014da0: 6572 792f 626c 6f62 2f6d 6169 6e2f 636f  ery/blob/main/co
-00014db0: 6e74 7261 6374 732f 696e 7465 7266 6163  ntracts/interfac
-00014dc0: 6573 2f49 5377 6170 526f 7574 6572 2e73  es/ISwapRouter.s
-00014dd0: 6f6c 0a20 2020 2020 2020 2020 2020 2020  ol.             
-00014de0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014df0: 6620 6c65 6e28 6675 6e63 5f70 6172 616d  f len(func_param
-00014e00: 735b 2270 6172 616d 7322 5d29 203d 3d20  s["params"]) == 
-00014e10: 383a 0a20 2020 2020 2020 2020 2020 2020  8:.             
+00014cf0: 2020 2020 2020 2020 2066 2743 6f75 6c64           f'Could
+00014d00: 206e 6f74 2069 6465 6e74 6966 7920 7479   not identify ty
+00014d10: 7065 2066 6f72 2066 756e 6374 696f 6e20  pe for function 
+00014d20: 7061 7261 6d73 2e20 4578 7065 6374 6564  params. Expected
+00014d30: 2074 7570 6c65 206f 7220 6469 6374 2c20   tuple or dict, 
+00014d40: 676f 7420 7b74 7970 6528 6675 6e63 5f70  got {type(func_p
+00014d50: 6172 616d 735b 2270 6172 616d 7322 5d29  arams["params"])
+00014d60: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00014d70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00014d80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00014d90: 2020 2020 2020 2020 2020 6966 2074 785f            if tx_
+00014da0: 6465 6164 6c69 6e65 3a0a 2020 2020 2020  deadline:.      
+00014db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014dc0: 2020 2020 2020 7365 6c66 2e5f 7261 6973        self._rais
+00014dd0: 655f 6966 5f70 6173 745f 6465 6164 6c69  e_if_past_deadli
+00014de0: 6e65 2874 785f 6465 6164 6c69 6e65 290a  ne(tx_deadline).
+00014df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e00: 2020 2020 2020 2020 2069 6620 5459 5045           if TYPE
+00014e10: 5f43 4845 434b 494e 473a 0a20 2020 2020  _CHECKING:.     
 00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e30: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
-00014e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e50: 2020 2020 2020 2020 2074 785f 746f 6b65           tx_toke
-00014e60: 6e5f 696e 5f61 6464 7265 7373 2c0a 2020  n_in_address,.  
-00014e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e30: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00014e40: 696e 7374 616e 6365 2873 656c 662e 7633  instance(self.v3
+00014e50: 5f70 6f6f 6c5f 6d61 6e61 6765 722c 2055  _pool_manager, U
+00014e60: 6e69 7377 6170 5633 4c69 7175 6964 6974  niswapV3Liquidit
+00014e70: 7950 6f6f 6c4d 616e 6167 6572 290a 2020  yPoolManager).  
 00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e90: 2020 7478 5f74 6f6b 656e 5f6f 7574 5f61    tx_token_out_a
-00014ea0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ec0: 2020 2020 2020 2020 2020 2020 7478 5f66              tx_f
-00014ed0: 6565 2c0a 2020 2020 2020 2020 2020 2020  ee,.            
-00014ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ef0: 2020 2020 2020 2020 7478 5f72 6563 6970          tx_recip
-00014f00: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f20: 2020 2020 2020 2020 2020 7478 5f64 6561            tx_dea
-00014f30: 646c 696e 652c 0a20 2020 2020 2020 2020  dline,.         
-00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f50: 2020 2020 2020 2020 2020 2074 785f 616d             tx_am
-00014f60: 6f75 6e74 5f6f 7574 2c0a 2020 2020 2020  ount_out,.      
-00014f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f80: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00014f90: 5f61 6d6f 756e 745f 696e 5f6d 6178 2c0a  _amount_in_max,.
-00014fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e90: 2020 2020 2020 7633 5f70 6f6f 6c20 3d20        v3_pool = 
+00014ea0: 7365 6c66 2e76 335f 706f 6f6c 5f6d 616e  self.v3_pool_man
+00014eb0: 6167 6572 2e67 6574 5f70 6f6f 6c28 0a20  ager.get_pool(. 
+00014ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ed0: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+00014ee0: 5f61 6464 7265 7373 6573 3d28 0a20 2020  _addresses=(.   
+00014ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f00: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
+00014f10: 746f 6b65 6e5f 696e 5f61 6464 7265 7373  token_in_address
+00014f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f40: 2020 7478 5f74 6f6b 656e 5f6f 7574 5f61    tx_token_out_a
+00014f50: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+00014f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f70: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00014f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f90: 2020 2070 6f6f 6c5f 6665 653d 7478 5f66     pool_fee=tx_f
+00014fa0: 6565 2c0a 2020 2020 2020 2020 2020 2020  ee,.            
 00014fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014fc0: 2020 2020 7478 5f73 7172 745f 7072 6963      tx_sqrt_pric
-00014fd0: 655f 6c69 6d69 745f 7839 362c 0a20 2020  e_limit_x96,.   
-00014fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ff0: 2020 2020 2020 2020 2020 2020 2029 203d               ) =
-00015000: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-00015010: 7261 6d73 225d 0a0a 2020 2020 2020 2020  rams"]..        
-00015020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015030: 2020 2020 2320 4465 636f 6465 2077 6974      # Decode wit
-00015040: 6820 4956 3353 7761 7052 6f75 7465 7220  h IV3SwapRouter 
-00015050: 4142 4920 2861 6b61 2052 6f75 7465 7232  ABI (aka Router2
-00015060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015070: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015080: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-00015090: 6f6d 2f55 6e69 7377 6170 2f73 7761 702d  om/Uniswap/swap-
-000150a0: 726f 7574 6572 2d63 6f6e 7472 6163 7473  router-contracts
-000150b0: 2f62 6c6f 622f 6d61 696e 2f63 6f6e 7472  /blob/main/contr
-000150c0: 6163 7473 2f69 6e74 6572 6661 6365 732f  acts/interfaces/
-000150d0: 4956 3353 7761 7052 6f75 7465 722e 736f  IV3SwapRouter.so
-000150e0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-000150f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00015100: 6966 206c 656e 2866 756e 635f 7061 7261  if len(func_para
-00015110: 6d73 5b22 7061 7261 6d73 225d 2920 3d3d  ms["params"]) ==
-00015120: 2037 3a0a 2020 2020 2020 2020 2020 2020   7:.            
-00015130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015140: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+00014fc0: 7369 6c65 6e74 3d73 656c 662e 7369 6c65  silent=self.sile
+00014fd0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00014fe0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00014ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015000: 2020 2020 2020 205f 2c20 7633 5f73 696d         _, v3_sim
+00015010: 5f72 6573 756c 7420 3d20 7365 6c66 2e5f  _result = self._
+00015020: 7369 6d75 6c61 7465 5f76 335f 7377 6170  simulate_v3_swap
+00015030: 5f65 7861 6374 5f6f 7574 280a 2020 2020  _exact_out(.    
+00015040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015050: 2020 2020 2020 2020 706f 6f6c 3d76 335f          pool=v3_
+00015060: 706f 6f6c 2c0a 2020 2020 2020 2020 2020  pool,.          
+00015070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015080: 2020 7265 6369 7069 656e 743d 7478 5f72    recipient=tx_r
+00015090: 6563 6970 6965 6e74 2c0a 2020 2020 2020  ecipient,.      
+000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150b0: 2020 2020 2020 746f 6b65 6e5f 696e 3d76        token_in=v
+000150c0: 335f 706f 6f6c 2e74 6f6b 656e 300a 2020  3_pool.token0.  
+000150d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150e0: 2020 2020 2020 2020 2020 6966 2076 335f            if v3_
+000150f0: 706f 6f6c 2e74 6f6b 656e 3020 3d3d 2074  pool.token0 == t
+00015100: 785f 746f 6b65 6e5f 696e 5f61 6464 7265  x_token_in_addre
+00015110: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00015120: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00015130: 6c73 6520 7633 5f70 6f6f 6c2e 746f 6b65  lse v3_pool.toke
+00015140: 6e31 2c0a 2020 2020 2020 2020 2020 2020  n1,.            
 00015150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015160: 2020 2020 2020 2020 2020 7478 5f74 6f6b            tx_tok
-00015170: 656e 5f69 6e5f 6164 6472 6573 732c 0a20  en_in_address,. 
+00015160: 616d 6f75 6e74 5f6f 7574 3d74 785f 616d  amount_out=tx_am
+00015170: 6f75 6e74 5f6f 7574 2c0a 2020 2020 2020  ount_out,.      
 00015180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151a0: 2020 2074 785f 746f 6b65 6e5f 6f75 745f     tx_token_out_
-000151b0: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
+00015190: 2020 2020 2020 616d 6f75 6e74 5f69 6e5f        amount_in_
+000151a0: 6d61 783d 7478 5f61 6d6f 756e 745f 696e  max=tx_amount_in
+000151b0: 5f6d 6178 2c0a 2020 2020 2020 2020 2020  _max,.          
 000151c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151d0: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-000151e0: 6665 652c 0a20 2020 2020 2020 2020 2020  fee,.           
-000151f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015200: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
-00015210: 7069 656e 742c 0a20 2020 2020 2020 2020  pient,.         
-00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015230: 2020 2020 2020 2020 2020 2074 785f 616d             tx_am
-00015240: 6f75 6e74 5f6f 7574 2c0a 2020 2020 2020  ount_out,.      
-00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015260: 2020 2020 2020 2020 2020 2020 2020 7478                tx
-00015270: 5f61 6d6f 756e 745f 696e 5f6d 6178 2c0a  _amount_in_max,.
+000151d0: 2020 6669 7273 745f 7377 6170 3d54 7275    first_swap=Tru
+000151e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000151f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00015200: 6173 745f 7377 6170 3d54 7275 652c 0a20  ast_swap=True,. 
+00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015220: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00015230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015240: 2020 7365 6c66 2e73 696d 756c 6174 6564    self.simulated
+00015250: 5f70 6f6f 6c5f 7374 6174 6573 2e61 7070  _pool_states.app
+00015260: 656e 6428 2876 335f 706f 6f6c 2c20 7633  end((v3_pool, v3
+00015270: 5f73 696d 5f72 6573 756c 7429 290a 0a20  _sim_result)).. 
 00015280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152a0: 2020 2020 7478 5f73 7172 745f 7072 6963      tx_sqrt_pric
-000152b0: 655f 6c69 6d69 745f 7839 362c 0a20 2020  e_limit_x96,.   
-000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152d0: 2020 2020 2020 2020 2020 2020 2029 203d               ) =
-000152e0: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
-000152f0: 7261 6d73 225d 0a20 2020 2020 2020 2020  rams"].         
-00015300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015310: 2020 2020 2020 2074 785f 6465 6164 6c69         tx_deadli
-00015320: 6e65 203d 204e 6f6e 650a 2020 2020 2020  ne = None.      
-00015330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015340: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015360: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00015370: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00015290: 2020 2020 2020 2061 6d6f 756e 745f 6465         amount_de
+000152a0: 706f 7369 7465 6420 3d20 6d61 7828 0a20  posited = max(. 
+000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152c0: 2020 2020 2020 2020 2020 2076 335f 7369             v3_si
+000152d0: 6d5f 7265 7375 6c74 2e61 6d6f 756e 7430  m_result.amount0
+000152e0: 5f64 656c 7461 2c0a 2020 2020 2020 2020  _delta,.        
+000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015300: 2020 2020 7633 5f73 696d 5f72 6573 756c      v3_sim_resul
+00015310: 742e 616d 6f75 6e74 315f 6465 6c74 612c  t.amount1_delta,
+00015320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015330: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00015340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015350: 2020 2020 6966 2061 6d6f 756e 745f 6465      if amount_de
+00015360: 706f 7369 7465 6420 3e20 7478 5f61 6d6f  posited > tx_amo
+00015370: 756e 745f 696e 5f6d 6178 3a0a 2020 2020  unt_in_max:.    
 00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000153a0: 2020 6622 436f 756c 6420 6e6f 7420 6578    f"Could not ex
-000153b0: 7472 6163 7420 7061 7261 6d65 7465 7273  tract parameters
-000153c0: 2066 6f72 2066 756e 6374 696f 6e20 7b66   for function {f
-000153d0: 756e 635f 6e61 6d65 7d20 7769 7468 2070  unc_name} with p
-000153e0: 6172 616d 6574 6572 7320 7b66 756e 635f  arameters {func_
-000153f0: 7061 7261 6d73 5b27 7061 7261 6d73 275d  params['params']
-00015400: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00015410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015420: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00015430: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00015440: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015450: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00015460: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00015470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015490: 2066 2743 6f75 6c64 206e 6f74 2069 6465   f'Could not ide
-000154a0: 6e74 6966 7920 7479 7065 2066 6f72 2066  ntify type for f
-000154b0: 756e 6374 696f 6e20 7061 7261 6d73 2e20  unction params. 
-000154c0: 4578 7065 6374 6564 2074 7570 6c65 206f  Expected tuple o
-000154d0: 7220 6469 6374 2c20 676f 7420 7b74 7970  r dict, got {typ
-000154e0: 6528 6675 6e63 5f70 6172 616d 735b 2270  e(func_params["p
-000154f0: 6172 616d 7322 5d29 7d27 0a20 2020 2020  arams"])}'.     
-00015500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015510: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015530: 2020 6966 2074 785f 6465 6164 6c69 6e65    if tx_deadline
-00015540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015550: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00015560: 6c66 2e5f 7261 6973 655f 6966 5f65 7870  lf._raise_if_exp
-00015570: 6972 6564 2874 785f 6465 6164 6c69 6e65  ired(tx_deadline
-00015580: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00015590: 2020 2020 2020 2020 2020 2069 6620 5459             if TY
-000155a0: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
-000155b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000155d0: 6973 696e 7374 616e 6365 2873 656c 662e  isinstance(self.
-000155e0: 7633 5f70 6f6f 6c5f 6d61 6e61 6765 722c  v3_pool_manager,
-000155f0: 2055 6e69 7377 6170 5633 4c69 7175 6964   UniswapV3Liquid
-00015600: 6974 7950 6f6f 6c4d 616e 6167 6572 290a  ityPoolManager).
-00015610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015620: 2020 2020 2020 2020 7633 5f70 6f6f 6c20          v3_pool 
-00015630: 3d20 7365 6c66 2e76 335f 706f 6f6c 5f6d  = self.v3_pool_m
-00015640: 616e 6167 6572 2e67 6574 5f70 6f6f 6c28  anager.get_pool(
-00015650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015660: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-00015670: 656e 5f61 6464 7265 7373 6573 3d28 0a20  en_addresses=(. 
-00015680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015690: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000156a0: 785f 746f 6b65 6e5f 696e 5f61 6464 7265  x_token_in_addre
-000156b0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156d0: 2020 2020 7478 5f74 6f6b 656e 5f6f 7574      tx_token_out
-000156e0: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
-000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015700: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-00015710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015720: 2020 2020 2070 6f6f 6c5f 6665 653d 7478       pool_fee=tx
-00015730: 5f66 6565 2c0a 2020 2020 2020 2020 2020  _fee,.          
-00015740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015750: 2020 7369 6c65 6e74 3d73 656c 662e 7369    silent=self.si
-00015760: 6c65 6e74 2c0a 2020 2020 2020 2020 2020  lent,.          
-00015770: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015790: 2020 2020 2020 2020 205f 2c20 7633 5f73           _, v3_s
-000157a0: 696d 5f72 6573 756c 7420 3d20 7365 6c66  im_result = self
-000157b0: 2e5f 7369 6d75 6c61 7465 5f76 335f 7377  ._simulate_v3_sw
-000157c0: 6170 5f65 7861 6374 5f6f 7574 280a 2020  ap_exact_out(.  
-000157d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157e0: 2020 2020 2020 2020 2020 706f 6f6c 3d76            pool=v
-000157f0: 335f 706f 6f6c 2c0a 2020 2020 2020 2020  3_pool,.        
-00015800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015810: 2020 2020 7265 6369 7069 656e 743d 7478      recipient=tx
-00015820: 5f72 6563 6970 6965 6e74 2c0a 2020 2020  _recipient,.    
-00015830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015840: 2020 2020 2020 2020 746f 6b65 6e5f 696e          token_in
-00015850: 3d76 335f 706f 6f6c 2e74 6f6b 656e 300a  =v3_pool.token0.
+00015390: 2020 2020 2020 2020 7261 6973 6520 5472          raise Tr
+000153a0: 616e 7361 6374 696f 6e45 7272 6f72 280a  ansactionError(.
+000153b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153d0: 6622 4d61 7869 6d75 6d20 696e 7075 7420  f"Maximum input 
+000153e0: 6578 6365 6564 6564 2e20 5370 6563 6966  exceeded. Specif
+000153f0: 6965 6420 7b74 785f 616d 6f75 6e74 5f69  ied {tx_amount_i
+00015400: 6e5f 6d61 787d 2c20 7b61 6d6f 756e 745f  n_max}, {amount_
+00015410: 6465 706f 7369 7465 647d 2072 6571 7569  deposited} requi
+00015420: 7265 642e 220a 2020 2020 2020 2020 2020  red.".          
+00015430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015440: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00015450: 2020 2020 2020 2020 2063 6173 6520 2265           case "e
+00015460: 7861 6374 4f75 7470 7574 223a 0a20 2020  xactOutput":.   
+00015470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015480: 2020 2020 2023 2045 7874 7261 6374 2070       # Extract p
+00015490: 6172 616d 6574 6572 7320 6672 6f6d 2074  arameters from t
+000154a0: 6865 2064 6963 7420 7265 7375 6c74 7320  he dict results 
+000154b0: 6f66 2077 6562 3370 7920 7636 0a20 2020  of web3py v6.   
+000154c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000154d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000154e0: 6365 2866 756e 635f 7061 7261 6d73 5b22  ce(func_params["
+000154f0: 7061 7261 6d73 225d 2c20 6469 6374 293a  params"], dict):
+00015500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015510: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
+00015520: 7061 7468 203d 2066 756e 635f 7061 7261  path = func_para
+00015530: 6d73 5b22 7061 7261 6d73 225d 5b22 7061  ms["params"]["pa
+00015540: 7468 225d 0a20 2020 2020 2020 2020 2020  th"].           
+00015550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015560: 2074 785f 7265 6369 7069 656e 7420 3d20   tx_recipient = 
+00015570: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
+00015580: 616d 7322 5d5b 2272 6563 6970 6965 6e74  ams"]["recipient
+00015590: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+000155a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000155b0: 785f 6465 6164 6c69 6e65 203d 2066 756e  x_deadline = fun
+000155c0: 635f 7061 7261 6d73 5b22 7061 7261 6d73  c_params["params
+000155d0: 225d 2e67 6574 2822 6465 6164 6c69 6e65  "].get("deadline
+000155e0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+000155f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00015600: 785f 616d 6f75 6e74 5f6f 7574 203d 2066  x_amount_out = f
+00015610: 756e 635f 7061 7261 6d73 5b22 7061 7261  unc_params["para
+00015620: 6d73 225d 5b22 616d 6f75 6e74 4f75 7422  ms"]["amountOut"
+00015630: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00015640: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00015650: 5f61 6d6f 756e 745f 696e 5f6d 6178 203d  _amount_in_max =
+00015660: 2066 756e 635f 7061 7261 6d73 5b22 7061   func_params["pa
+00015670: 7261 6d73 225d 5b22 616d 6f75 6e74 496e  rams"]["amountIn
+00015680: 4d61 7869 6d75 6d22 5d0a 2020 2020 2020  Maximum"].      
+00015690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156a0: 2020 2320 4578 7472 6163 7420 7061 7261    # Extract para
+000156b0: 6d65 7465 7273 2066 726f 6d20 7468 6520  meters from the 
+000156c0: 7475 706c 6520 7265 7375 6c74 7320 6f66  tuple results of
+000156d0: 2077 6562 3370 7920 7635 0a20 2020 2020   web3py v5.     
+000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156f0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00015700: 6365 2866 756e 635f 7061 7261 6d73 5b22  ce(func_params["
+00015710: 7061 7261 6d73 225d 2c20 7475 706c 6529  params"], tuple)
+00015720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015730: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015740: 4465 636f 6465 2077 6974 6820 4953 7761  Decode with ISwa
+00015750: 7052 6f75 7465 7220 4142 490a 2020 2020  pRouter ABI.    
+00015760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015770: 2020 2020 2020 2020 2320 6874 7470 733a          # https:
+00015780: 2f2f 6769 7468 7562 2e63 6f6d 2f55 6e69  //github.com/Uni
+00015790: 7377 6170 2f76 332d 7065 7269 7068 6572  swap/v3-peripher
+000157a0: 792f 626c 6f62 2f6d 6169 6e2f 636f 6e74  y/blob/main/cont
+000157b0: 7261 6374 732f 696e 7465 7266 6163 6573  racts/interfaces
+000157c0: 2f49 5377 6170 526f 7574 6572 2e73 6f6c  /ISwapRouter.sol
+000157d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000157e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000157f0: 6c65 6e28 6675 6e63 5f70 6172 616d 735b  len(func_params[
+00015800: 2270 6172 616d 7322 5d29 203d 3d20 353a  "params"]) == 5:
+00015810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015830: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015850: 2020 2020 2020 2074 785f 7061 7468 2c0a         tx_path,.
 00015860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015870: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-00015880: 335f 706f 6f6c 2e74 6f6b 656e 3020 3d3d  3_pool.token0 ==
-00015890: 2074 785f 746f 6b65 6e5f 696e 5f61 6464   tx_token_in_add
-000158a0: 7265 7373 0a20 2020 2020 2020 2020 2020  ress.           
-000158b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158c0: 2065 6c73 6520 7633 5f70 6f6f 6c2e 746f   else v3_pool.to
-000158d0: 6b65 6e31 2c0a 2020 2020 2020 2020 2020  ken1,.          
-000158e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158f0: 2020 616d 6f75 6e74 5f6f 7574 3d74 785f    amount_out=tx_
-00015900: 616d 6f75 6e74 5f6f 7574 2c0a 2020 2020  amount_out,.    
-00015910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015920: 2020 2020 2020 2020 616d 6f75 6e74 5f69          amount_i
-00015930: 6e5f 6d61 783d 7478 5f61 6d6f 756e 745f  n_max=tx_amount_
-00015940: 696e 5f6d 6178 2c0a 2020 2020 2020 2020  in_max,.        
-00015950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015960: 2020 2020 6669 7273 745f 7377 6170 3d54      first_swap=T
-00015970: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00015980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015990: 206c 6173 745f 7377 6170 3d54 7275 652c   last_swap=True,
-000159a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000159b0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000159c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159d0: 2020 2020 5f76 335f 726f 7574 6572 5f66      _v3_router_f
-000159e0: 7574 7572 655f 706f 6f6c 5f73 7461 7465  uture_pool_state
-000159f0: 732e 6170 7065 6e64 2828 7633 5f70 6f6f  s.append((v3_poo
-00015a00: 6c2c 2076 335f 7369 6d5f 7265 7375 6c74  l, v3_sim_result
-00015a10: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00015a20: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-00015a30: 6e74 5f64 6570 6f73 6974 6564 203d 206d  nt_deposited = m
-00015a40: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
-00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a60: 7633 5f73 696d 5f72 6573 756c 742e 616d  v3_sim_result.am
-00015a70: 6f75 6e74 305f 6465 6c74 612c 0a20 2020  ount0_delta,.   
+00015870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015880: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
+00015890: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158b0: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
+000158c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000158d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158e0: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
+000158f0: 5f6f 7574 2c0a 2020 2020 2020 2020 2020  _out,.          
+00015900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015910: 2020 2020 2020 2020 2020 7478 5f61 6d6f            tx_amo
+00015920: 756e 745f 696e 5f6d 6178 2c0a 2020 2020  unt_in_max,.    
+00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015940: 2020 2020 2020 2020 2020 2020 2920 3d20              ) = 
+00015950: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
+00015960: 616d 7322 5d0a 2020 2020 2020 2020 2020  ams"].          
+00015970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015980: 2020 2320 4465 636f 6465 2077 6974 6820    # Decode with 
+00015990: 4956 3353 7761 7052 6f75 7465 7220 4142  IV3SwapRouter AB
+000159a0: 4920 2861 6b61 2052 6f75 7465 7232 290a  I (aka Router2).
+000159b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159c0: 2020 2020 2020 2020 2020 2020 2320 6874              # ht
+000159d0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+000159e0: 2f55 6e69 7377 6170 2f73 7761 702d 726f  /Uniswap/swap-ro
+000159f0: 7574 6572 2d63 6f6e 7472 6163 7473 2f62  uter-contracts/b
+00015a00: 6c6f 622f 6d61 696e 2f63 6f6e 7472 6163  lob/main/contrac
+00015a10: 7473 2f69 6e74 6572 6661 6365 732f 4956  ts/interfaces/IV
+00015a20: 3353 7761 7052 6f75 7465 722e 736f 6c0a  3SwapRouter.sol.
+00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a40: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00015a50: 206c 656e 2866 756e 635f 7061 7261 6d73   len(func_params
+00015a60: 5b22 7061 7261 6d73 225d 2920 3d3d 2034  ["params"]) == 4
+00015a70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 00015a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a90: 2020 2020 2020 2020 2076 335f 7369 6d5f           v3_sim_
-00015aa0: 7265 7375 6c74 2e61 6d6f 756e 7431 5f64  result.amount1_d
-00015ab0: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
-00015ac0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ae0: 2020 2020 2020 2020 2069 6620 616d 6f75           if amou
-00015af0: 6e74 5f64 6570 6f73 6974 6564 203e 2074  nt_deposited > t
-00015b00: 785f 616d 6f75 6e74 5f69 6e5f 6d61 783a  x_amount_in_max:
-00015b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b20: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00015b30: 7365 2054 7261 6e73 6163 7469 6f6e 4572  se TransactionEr
-00015b40: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00015b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b60: 2020 2020 2066 224d 6178 696d 756d 2069       f"Maximum i
-00015b70: 6e70 7574 2065 7863 6565 6465 642e 2053  nput exceeded. S
-00015b80: 7065 6369 6669 6564 207b 7478 5f61 6d6f  pecified {tx_amo
-00015b90: 756e 745f 696e 5f6d 6178 7d2c 207b 616d  unt_in_max}, {am
-00015ba0: 6f75 6e74 5f64 6570 6f73 6974 6564 7d20  ount_deposited} 
-00015bb0: 7265 7175 6972 6564 2e22 0a20 2020 2020  required.".     
-00015bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015bd0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00015be0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00015bf0: 7365 2022 6578 6163 744f 7574 7075 7422  se "exactOutput"
-00015c00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015c10: 2020 2020 2020 2020 2020 2320 4578 7472            # Extr
-00015c20: 6163 7420 7061 7261 6d65 7465 7273 2066  act parameters f
-00015c30: 726f 6d20 7468 6520 6469 6374 2072 6573  rom the dict res
-00015c40: 756c 7473 206f 6620 7765 6233 7079 2076  ults of web3py v
-00015c50: 360a 2020 2020 2020 2020 2020 2020 2020  6.              
-00015c60: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00015c70: 6e73 7461 6e63 6528 6675 6e63 5f70 6172  nstance(func_par
-00015c80: 616d 735b 2270 6172 616d 7322 5d2c 2064  ams["params"], d
-00015c90: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00015ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cb0: 2020 7478 5f70 6174 6820 3d20 6675 6e63    tx_path = func
-00015cc0: 5f70 6172 616d 735b 2270 6172 616d 7322  _params["params"
-00015cd0: 5d5b 2270 6174 6822 5d0a 2020 2020 2020  ]["path"].      
-00015ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cf0: 2020 2020 2020 7478 5f72 6563 6970 6965        tx_recipie
-00015d00: 6e74 203d 2066 756e 635f 7061 7261 6d73  nt = func_params
-00015d10: 5b22 7061 7261 6d73 225d 5b22 7265 6369  ["params"]["reci
-00015d20: 7069 656e 7422 5d0a 2020 2020 2020 2020  pient"].        
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2020 2020 7478 5f64 6561 646c 696e 6520      tx_deadline 
-00015d50: 3d20 6675 6e63 5f70 6172 616d 735b 2270  = func_params["p
-00015d60: 6172 616d 7322 5d2e 6765 7428 2264 6561  arams"].get("dea
-00015d70: 646c 696e 6522 290a 2020 2020 2020 2020  dline").        
-00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d90: 2020 2020 7478 5f61 6d6f 756e 745f 6f75      tx_amount_ou
-00015da0: 7420 3d20 6675 6e63 5f70 6172 616d 735b  t = func_params[
-00015db0: 2270 6172 616d 7322 5d5b 2261 6d6f 756e  "params"]["amoun
-00015dc0: 744f 7574 225d 0a20 2020 2020 2020 2020  tOut"].         
-00015dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015de0: 2020 2074 785f 616d 6f75 6e74 5f69 6e5f     tx_amount_in_
-00015df0: 6d61 7820 3d20 6675 6e63 5f70 6172 616d  max = func_param
-00015e00: 735b 2270 6172 616d 7322 5d5b 2261 6d6f  s["params"]["amo
-00015e10: 756e 7449 6e4d 6178 696d 756d 225d 0a20  untInMaximum"]. 
-00015e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e30: 2020 2020 2020 2023 2045 7874 7261 6374         # Extract
-00015e40: 2070 6172 616d 6574 6572 7320 6672 6f6d   parameters from
-00015e50: 2074 6865 2074 7570 6c65 2072 6573 756c   the tuple resul
-00015e60: 7473 206f 6620 7765 6233 7079 2076 350a  ts of web3py v5.
+00015a90: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
+00015aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ab0: 2020 2020 2020 2020 7478 5f70 6174 682c          tx_path,
+00015ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ae0: 2020 2020 2074 785f 7265 6369 7069 656e       tx_recipien
+00015af0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00015b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b10: 2020 2020 2020 2074 785f 616d 6f75 6e74         tx_amount
+00015b20: 5f6f 7574 2c0a 2020 2020 2020 2020 2020  _out,.          
+00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b40: 2020 2020 2020 2020 2020 7478 5f61 6d6f            tx_amo
+00015b50: 756e 745f 696e 5f6d 6178 2c0a 2020 2020  unt_in_max,.    
+00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b70: 2020 2020 2020 2020 2020 2020 2920 3d20              ) = 
+00015b80: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
+00015b90: 616d 7322 5d0a 2020 2020 2020 2020 2020  ams"].          
+00015ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015bb0: 2020 2020 2020 7478 5f64 6561 646c 696e        tx_deadlin
+00015bc0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+00015bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015be0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00015bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00015c10: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c40: 2066 2243 6f75 6c64 206e 6f74 2065 7874   f"Could not ext
+00015c50: 7261 6374 2070 6172 616d 6574 6572 7320  ract parameters 
+00015c60: 666f 7220 6675 6e63 7469 6f6e 207b 6675  for function {fu
+00015c70: 6e63 5f6e 616d 657d 2077 6974 6820 7061  nc_name} with pa
+00015c80: 7261 6d65 7465 7273 207b 6675 6e63 5f70  rameters {func_p
+00015c90: 6172 616d 735b 2770 6172 616d 7327 5d7d  arams['params']}
+00015ca0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00015cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cc0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00015cd0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00015ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015cf0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00015d00: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00015d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d30: 6627 436f 756c 6420 6e6f 7420 6964 656e  f'Could not iden
+00015d40: 7469 6679 2074 7970 6520 666f 7220 6675  tify type for fu
+00015d50: 6e63 7469 6f6e 2070 6172 616d 732e 2045  nction params. E
+00015d60: 7870 6563 7465 6420 7475 706c 6520 6f72  xpected tuple or
+00015d70: 2064 6963 742c 2067 6f74 207b 7479 7065   dict, got {type
+00015d80: 2866 756e 635f 7061 7261 6d73 5b22 7061  (func_params["pa
+00015d90: 7261 6d73 225d 297d 270a 2020 2020 2020  rams"])}'.      
+00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015db0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dd0: 2069 6620 7478 5f64 6561 646c 696e 653a   if tx_deadline:
+00015de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015df0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00015e00: 662e 5f72 6169 7365 5f69 665f 7061 7374  f._raise_if_past
+00015e10: 5f64 6561 646c 696e 6528 7478 5f64 6561  _deadline(tx_dea
+00015e20: 646c 696e 6529 0a0a 2020 2020 2020 2020  dline)..        
+00015e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e40: 7478 5f70 6174 685f 6465 636f 6465 6420  tx_path_decoded 
+00015e50: 3d20 6465 636f 6465 5f76 335f 7061 7468  = decode_v3_path
+00015e60: 2874 785f 7061 7468 290a 0a20 2020 2020  (tx_path)..     
 00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e80: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00015e90: 6e73 7461 6e63 6528 6675 6e63 5f70 6172  nstance(func_par
-00015ea0: 616d 735b 2270 6172 616d 7322 5d2c 2074  ams["params"], t
-00015eb0: 7570 6c65 293a 0a20 2020 2020 2020 2020  uple):.         
-00015ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ed0: 2020 2023 2044 6563 6f64 6520 7769 7468     # Decode with
-00015ee0: 2049 5377 6170 526f 7574 6572 2041 4249   ISwapRouter ABI
-00015ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f00: 2020 2020 2020 2020 2020 2020 2023 2068               # h
-00015f10: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-00015f20: 6d2f 556e 6973 7761 702f 7633 2d70 6572  m/Uniswap/v3-per
-00015f30: 6970 6865 7279 2f62 6c6f 622f 6d61 696e  iphery/blob/main
-00015f40: 2f63 6f6e 7472 6163 7473 2f69 6e74 6572  /contracts/inter
-00015f50: 6661 6365 732f 4953 7761 7052 6f75 7465  faces/ISwapRoute
-00015f60: 722e 736f 6c0a 2020 2020 2020 2020 2020  r.sol.          
-00015f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f80: 2020 6966 206c 656e 2866 756e 635f 7061    if len(func_pa
-00015f90: 7261 6d73 5b22 7061 7261 6d73 225d 2920  rams["params"]) 
-00015fa0: 3d3d 2035 3a0a 2020 2020 2020 2020 2020  == 5:.          
+00015e80: 2020 2069 6620 6e6f 7420 7369 6c65 6e74     if not silent
+00015e90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015ea0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00015eb0: 6767 6572 2e69 6e66 6f28 6622 20e2 80a2  gger.info(f" ...
+00015ec0: 2070 6174 6820 3d20 7b74 785f 7061 7468   path = {tx_path
+00015ed0: 5f64 6563 6f64 6564 7d22 290a 2020 2020  _decoded}").    
+00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ef0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00015f00: 6e66 6f28 6622 20e2 80a2 2072 6563 6970  nfo(f" ... recip
+00015f10: 6965 6e74 203d 207b 7478 5f72 6563 6970  ient = {tx_recip
+00015f20: 6965 6e74 7d22 290a 2020 2020 2020 2020  ient}").        
+00015f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f60: 2020 2020 2020 2020 2074 785f 6465 6164           tx_dead
+00015f70: 6c69 6e65 0a20 2020 2020 2020 2020 2020  line.           
+00015f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f90: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00015fa0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
 00015fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fc0: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+00015fc0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
 00015fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fe0: 2020 2020 2020 2020 2020 2020 7478 5f70              tx_p
-00015ff0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00016000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016010: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
-00016020: 7069 656e 742c 0a20 2020 2020 2020 2020  pient,.         
-00016030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016040: 2020 2020 2020 2020 2020 2074 785f 6465             tx_de
-00016050: 6164 6c69 6e65 2c0a 2020 2020 2020 2020  adline,.        
-00016060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016070: 2020 2020 2020 2020 2020 2020 7478 5f61              tx_a
-00016080: 6d6f 756e 745f 6f75 742c 0a20 2020 2020  mount_out,.     
+00015fe0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016000: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00016010: 2e69 6e66 6f28 6622 20e2 80a2 2064 6561  .info(f" ... dea
+00016020: 646c 696e 6520 3d20 7b74 785f 6465 6164  dline = {tx_dead
+00016030: 6c69 6e65 7d22 290a 2020 2020 2020 2020  line}").        
+00016040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016050: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00016060: 6622 20e2 80a2 2061 6d6f 756e 744f 7574  f" ... amountOut
+00016070: 203d 207b 7478 5f61 6d6f 756e 745f 6f75   = {tx_amount_ou
+00016080: 747d 2229 0a20 2020 2020 2020 2020 2020  t}").           
 00016090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000160b0: 785f 616d 6f75 6e74 5f69 6e5f 6d61 782c  x_amount_in_max,
-000160c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160e0: 2029 203d 2066 756e 635f 7061 7261 6d73   ) = func_params
-000160f0: 5b22 7061 7261 6d73 225d 0a20 2020 2020  ["params"].     
-00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016110: 2020 2020 2020 2023 2044 6563 6f64 6520         # Decode 
-00016120: 7769 7468 2049 5633 5377 6170 526f 7574  with IV3SwapRout
-00016130: 6572 2041 4249 2028 616b 6120 526f 7574  er ABI (aka Rout
-00016140: 6572 3229 0a20 2020 2020 2020 2020 2020  er2).           
-00016150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016160: 2023 2068 7474 7073 3a2f 2f67 6974 6875   # https://githu
-00016170: 622e 636f 6d2f 556e 6973 7761 702f 7377  b.com/Uniswap/sw
-00016180: 6170 2d72 6f75 7465 722d 636f 6e74 7261  ap-router-contra
-00016190: 6374 732f 626c 6f62 2f6d 6169 6e2f 636f  cts/blob/main/co
-000161a0: 6e74 7261 6374 732f 696e 7465 7266 6163  ntracts/interfac
-000161b0: 6573 2f49 5633 5377 6170 526f 7574 6572  es/IV3SwapRouter
-000161c0: 2e73 6f6c 0a20 2020 2020 2020 2020 2020  .sol.           
-000161d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161e0: 2065 6c69 6620 6c65 6e28 6675 6e63 5f70   elif len(func_p
-000161f0: 6172 616d 735b 2270 6172 616d 7322 5d29  arams["params"])
-00016200: 203d 3d20 343a 0a20 2020 2020 2020 2020   == 4:.         
-00016210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016220: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00016230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016240: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00016250: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00016260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016270: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
-00016280: 6970 6965 6e74 2c0a 2020 2020 2020 2020  ipient,.        
-00016290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162a0: 2020 2020 2020 2020 2020 2020 7478 5f61              tx_a
-000162b0: 6d6f 756e 745f 6f75 742c 0a20 2020 2020  mount_out,.     
-000162c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000162e0: 785f 616d 6f75 6e74 5f69 6e5f 6d61 782c  x_amount_in_max,
-000162f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016310: 2029 203d 2066 756e 635f 7061 7261 6d73   ) = func_params
-00016320: 5b22 7061 7261 6d73 225d 0a20 2020 2020  ["params"].     
+000160a0: 206c 6f67 6765 722e 696e 666f 2866 2220   logger.info(f" 
+000160b0: e280 a220 616d 6f75 6e74 496e 4d61 7869  ... amountInMaxi
+000160c0: 6d75 6d20 3d20 7b74 785f 616d 6f75 6e74  mum = {tx_amount
+000160d0: 5f69 6e5f 6d61 787d 2229 0a0a 2020 2020  _in_max}")..    
+000160e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160f0: 2020 2020 2320 616e 2065 7861 6374 206f      # an exact o
+00016100: 7574 7075 7420 7061 7468 2069 7320 656e  utput path is en
+00016110: 636f 6465 6420 696e 2052 4556 4552 5345  coded in REVERSE
+00016120: 206f 7264 6572 2c0a 2020 2020 2020 2020   order,.        
+00016130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016140: 2320 746f 6b65 6e4f 7574 2069 7320 7468  # tokenOut is th
+00016150: 6520 6669 7273 7420 706f 7369 7469 6f6e  e first position
+00016160: 2c20 746f 6b65 6e49 6e20 6973 2074 6865  , tokenIn is the
+00016170: 2073 6563 6f6e 640a 2020 2020 2020 2020   second.        
+00016180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016190: 2320 706f 7369 7469 6f6e 2e20 652e 672e  # position. e.g.
+000161a0: 2074 6f6b 656e 4f75 742c 2066 6565 2c20   tokenOut, fee, 
+000161b0: 746f 6b65 6e49 6e0a 2020 2020 2020 2020  tokenIn.        
+000161c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161d0: 6c61 7374 5f74 6f6b 656e 5f70 6f73 203d  last_token_pos =
+000161e0: 206c 656e 2874 785f 7061 7468 5f64 6563   len(tx_path_dec
+000161f0: 6f64 6564 2920 2d20 330a 0a20 2020 2020  oded) - 3..     
+00016200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016210: 2020 205f 616d 6f75 6e74 5f69 6e20 3d20     _amount_in = 
+00016220: 300a 0a20 2020 2020 2020 2020 2020 2020  0..             
+00016230: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+00016240: 6f6b 656e 5f70 6f73 2069 6e20 7261 6e67  oken_pos in rang
+00016250: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00016260: 2020 2020 2020 2020 2020 2020 2020 2030                 0
+00016270: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016280: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+00016290: 6e28 7478 5f70 6174 685f 6465 636f 6465  n(tx_path_decode
+000162a0: 6429 202d 2032 2c0a 2020 2020 2020 2020  d) - 2,.        
+000162b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162c0: 2020 2020 322c 0a20 2020 2020 2020 2020      2,.         
+000162d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000162e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000162f0: 2020 2020 2020 2020 2020 2020 2020 7478                tx
+00016300: 5f74 6f6b 656e 5f6f 7574 5f61 6464 7265  _token_out_addre
+00016310: 7373 203d 2074 785f 7061 7468 5f64 6563  ss = tx_path_dec
+00016320: 6f64 6564 5b74 6f6b 656e 5f70 6f73 5d0a  oded[token_pos].
 00016330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016340: 2020 2020 2020 2020 2020 2074 785f 6465             tx_de
-00016350: 6164 6c69 6e65 203d 204e 6f6e 650a 2020  adline = None.  
-00016360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016370: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016340: 2020 2020 2020 2020 2020 2020 7478 5f66              tx_f
+00016350: 6565 203d 2074 785f 7061 7468 5f64 6563  ee = tx_path_dec
+00016360: 6f64 6564 5b74 6f6b 656e 5f70 6f73 202b  oded[token_pos +
+00016370: 2031 5d0a 2020 2020 2020 2020 2020 2020   1].            
 00016380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000163b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000163c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163d0: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
-000163e0: 7420 6578 7472 6163 7420 7061 7261 6d65  t extract parame
-000163f0: 7465 7273 2066 6f72 2066 756e 6374 696f  ters for functio
-00016400: 6e20 7b66 756e 635f 6e61 6d65 7d20 7769  n {func_name} wi
-00016410: 7468 2070 6172 616d 6574 6572 7320 7b66  th parameters {f
-00016420: 756e 635f 7061 7261 6d73 5b27 7061 7261  unc_params['para
-00016430: 6d73 275d 7d22 0a20 2020 2020 2020 2020  ms']}".         
-00016440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016450: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016470: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00016390: 7478 5f74 6f6b 656e 5f69 6e5f 6164 6472  tx_token_in_addr
+000163a0: 6573 7320 3d20 7478 5f70 6174 685f 6465  ess = tx_path_de
+000163b0: 636f 6465 645b 746f 6b65 6e5f 706f 7320  coded[token_pos 
+000163c0: 2b20 325d 0a0a 2020 2020 2020 2020 2020  + 2]..          
+000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163e0: 2020 6669 7273 745f 7377 6170 203d 2074    first_swap = t
+000163f0: 6f6b 656e 5f70 6f73 203d 3d20 6c61 7374  oken_pos == last
+00016400: 5f74 6f6b 656e 5f70 6f73 0a20 2020 2020  _token_pos.     
+00016410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016420: 2020 2020 2020 206c 6173 745f 7377 6170         last_swap
+00016430: 203d 2074 6f6b 656e 5f70 6f73 203d 3d20   = token_pos == 
+00016440: 300a 0a20 2020 2020 2020 2020 2020 2020  0..             
+00016450: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016460: 6620 5459 5045 5f43 4845 434b 494e 473a  f TYPE_CHECKING:
+00016470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00016480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016490: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000164a0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00016490: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+000164a0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
 000164b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164c0: 2020 2020 2066 2743 6f75 6c64 206e 6f74       f'Could not
-000164d0: 2069 6465 6e74 6966 7920 7479 7065 2066   identify type f
-000164e0: 6f72 2066 756e 6374 696f 6e20 7061 7261  or function para
-000164f0: 6d73 2e20 4578 7065 6374 6564 2074 7570  ms. Expected tup
-00016500: 6c65 206f 7220 6469 6374 2c20 676f 7420  le or dict, got 
-00016510: 7b74 7970 6528 6675 6e63 5f70 6172 616d  {type(func_param
-00016520: 735b 2270 6172 616d 7322 5d29 7d27 0a20  s["params"])}'. 
-00016530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016540: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00016550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016560: 2020 2020 2020 6966 2074 785f 6465 6164        if tx_dead
-00016570: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
-00016580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016590: 2020 7365 6c66 2e5f 7261 6973 655f 6966    self._raise_if
-000165a0: 5f65 7870 6972 6564 2874 785f 6465 6164  _expired(tx_dead
-000165b0: 6c69 6e65 290a 0a20 2020 2020 2020 2020  line)..         
-000165c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000165d0: 785f 7061 7468 5f64 6563 6f64 6564 203d  x_path_decoded =
-000165e0: 2064 6563 6f64 655f 7633 5f70 6174 6828   decode_v3_path(
-000165f0: 7478 5f70 6174 6829 0a0a 2020 2020 2020  tx_path)..      
-00016600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016610: 2020 6966 206e 6f74 2073 696c 656e 743a    if not silent:
-00016620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016630: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00016640: 6765 722e 696e 666f 2866 2220 e280 a220  ger.info(f" ... 
-00016650: 7061 7468 203d 207b 7478 5f70 6174 685f  path = {tx_path_
-00016660: 6465 636f 6465 647d 2229 0a20 2020 2020  decoded}").     
-00016670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016680: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00016690: 666f 2866 2220 e280 a220 7265 6369 7069  fo(f" ... recipi
-000166a0: 656e 7420 3d20 7b74 785f 7265 6369 7069  ent = {tx_recipi
-000166b0: 656e 747d 2229 0a20 2020 2020 2020 2020  ent}").         
-000166c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000164c0: 2020 2020 2020 2020 7365 6c66 2e76 335f          self.v3_
+000164d0: 706f 6f6c 5f6d 616e 6167 6572 2c20 556e  pool_manager, Un
+000164e0: 6973 7761 7056 334c 6971 7569 6469 7479  iswapV3Liquidity
+000164f0: 506f 6f6c 4d61 6e61 6765 720a 2020 2020  PoolManager.    
+00016500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016510: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00016520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016530: 2020 2020 2020 2020 2020 7633 5f70 6f6f            v3_poo
+00016540: 6c20 3d20 7365 6c66 2e76 335f 706f 6f6c  l = self.v3_pool
+00016550: 5f6d 616e 6167 6572 2e67 6574 5f70 6f6f  _manager.get_poo
+00016560: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016580: 2020 2074 6f6b 656e 5f61 6464 7265 7373     token_address
+00016590: 6573 3d28 0a20 2020 2020 2020 2020 2020  es=(.           
+000165a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165b0: 2020 2020 2020 2020 2074 785f 746f 6b65           tx_toke
+000165c0: 6e5f 696e 5f61 6464 7265 7373 2c0a 2020  n_in_address,.  
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165f0: 2020 7478 5f74 6f6b 656e 5f6f 7574 5f61    tx_token_out_a
+00016600: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+00016610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016620: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00016630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016640: 2020 2020 2020 2020 2020 2070 6f6f 6c5f             pool_
+00016650: 6665 653d 7478 5f66 6565 2c0a 2020 2020  fee=tx_fee,.    
+00016660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016670: 2020 2020 2020 2020 2020 2020 7369 6c65              sile
+00016680: 6e74 3d73 656c 662e 7369 6c65 6e74 2c0a  nt=self.silent,.
+00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166c0: 2020 2020 2020 2020 2020 205f 7265 6369             _reci
+000166d0: 7069 656e 7420 3d20 280a 2020 2020 2020  pient = (.      
 000166e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166f0: 2020 2020 2020 2020 7478 5f64 6561 646c          tx_deadl
-00016700: 696e 650a 2020 2020 2020 2020 2020 2020  ine.            
-00016710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016720: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00016730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000166f0: 2020 2020 2020 2020 2020 7478 5f72 6563            tx_rec
+00016700: 6970 6965 6e74 2069 6620 6c61 7374 5f73  ipient if last_s
+00016710: 7761 7020 656c 7365 2055 6e69 7665 7273  wap else Univers
+00016720: 616c 526f 7574 6572 5370 6563 6961 6c41  alRouterSpecialA
+00016730: 6464 7265 7373 2e52 4f55 5445 520a 2020  ddress.ROUTER.  
 00016740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016750: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+00016750: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
 00016760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016770: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016790: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000167a0: 696e 666f 2866 2220 e280 a220 6465 6164  info(f" ... dead
-000167b0: 6c69 6e65 203d 207b 7478 5f64 6561 646c  line = {tx_deadl
-000167c0: 696e 657d 2229 0a20 2020 2020 2020 2020  ine}").         
-000167d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167e0: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-000167f0: 2220 e280 a220 616d 6f75 6e74 4f75 7420  " ... amountOut 
-00016800: 3d20 7b74 785f 616d 6f75 6e74 5f6f 7574  = {tx_amount_out
-00016810: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016830: 6c6f 6767 6572 2e69 6e66 6f28 6622 20e2  logger.info(f" .
-00016840: 80a2 2061 6d6f 756e 7449 6e4d 6178 696d  .. amountInMaxim
-00016850: 756d 203d 207b 7478 5f61 6d6f 756e 745f  um = {tx_amount_
-00016860: 696e 5f6d 6178 7d22 290a 0a20 2020 2020  in_max}")..     
-00016870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016880: 2020 2023 2061 6e20 6578 6163 7420 6f75     # an exact ou
-00016890: 7470 7574 2070 6174 6820 6973 2065 6e63  tput path is enc
-000168a0: 6f64 6564 2069 6e20 5245 5645 5253 4520  oded in REVERSE 
-000168b0: 6f72 6465 722c 0a20 2020 2020 2020 2020  order,.         
-000168c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000168d0: 2074 6f6b 656e 4f75 7420 6973 2074 6865   tokenOut is the
-000168e0: 2066 6972 7374 2070 6f73 6974 696f 6e2c   first position,
-000168f0: 2074 6f6b 656e 496e 2069 7320 7468 6520   tokenIn is the 
-00016900: 7365 636f 6e64 0a20 2020 2020 2020 2020  second.         
-00016910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00016920: 2070 6f73 6974 696f 6e2e 2065 2e67 2e20   position. e.g. 
-00016930: 746f 6b65 6e4f 7574 2c20 6665 652c 2074  tokenOut, fee, t
-00016940: 6f6b 656e 496e 0a20 2020 2020 2020 2020  okenIn.         
-00016950: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00016960: 6173 745f 746f 6b65 6e5f 706f 7320 3d20  ast_token_pos = 
-00016970: 6c65 6e28 7478 5f70 6174 685f 6465 636f  len(tx_path_deco
-00016980: 6465 6429 202d 2033 0a0a 2020 2020 2020  ded) - 3..      
-00016990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169a0: 2020 5f61 6d6f 756e 745f 696e 203d 2030    _amount_in = 0
-000169b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000169c0: 2020 2020 2020 2020 2020 666f 7220 746f            for to
-000169d0: 6b65 6e5f 706f 7320 696e 2072 616e 6765  ken_pos in range
-000169e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000169f0: 2020 2020 2020 2020 2020 2020 2020 302c                0,
-00016a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016a10: 2020 2020 2020 2020 2020 2020 206c 656e               len
-00016a20: 2874 785f 7061 7468 5f64 6563 6f64 6564  (tx_path_decoded
-00016a30: 2920 2d20 322c 0a20 2020 2020 2020 2020  ) - 2,.         
-00016a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a50: 2020 2032 2c0a 2020 2020 2020 2020 2020     2,.          
-00016a60: 2020 2020 2020 2020 2020 2020 2020 293a                ):
-00016a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016a80: 2020 2020 2020 2020 2020 2020 2074 785f               tx_
-00016a90: 746f 6b65 6e5f 6f75 745f 6164 6472 6573  token_out_addres
-00016aa0: 7320 3d20 7478 5f70 6174 685f 6465 636f  s = tx_path_deco
-00016ab0: 6465 645b 746f 6b65 6e5f 706f 735d 0a20  ded[token_pos]. 
-00016ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ad0: 2020 2020 2020 2020 2020 2074 785f 6665             tx_fe
-00016ae0: 6520 3d20 7478 5f70 6174 685f 6465 636f  e = tx_path_deco
-00016af0: 6465 645b 746f 6b65 6e5f 706f 7320 2b20  ded[token_pos + 
-00016b00: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00016b10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00016b20: 785f 746f 6b65 6e5f 696e 5f61 6464 7265  x_token_in_addre
-00016b30: 7373 203d 2074 785f 7061 7468 5f64 6563  ss = tx_path_dec
-00016b40: 6f64 6564 5b74 6f6b 656e 5f70 6f73 202b  oded[token_pos +
-00016b50: 2032 5d0a 0a20 2020 2020 2020 2020 2020   2]..           
+00016770: 2020 2020 2020 2020 5f74 6f6b 656e 5f69          _token_i
+00016780: 6e20 3d20 280a 2020 2020 2020 2020 2020  n = (.          
+00016790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167a0: 2020 2020 2020 7633 5f70 6f6f 6c2e 746f        v3_pool.to
+000167b0: 6b65 6e30 0a20 2020 2020 2020 2020 2020  ken0.           
+000167c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167d0: 2020 2020 2069 6620 7633 5f70 6f6f 6c2e       if v3_pool.
+000167e0: 746f 6b65 6e30 203d 3d20 7478 5f74 6f6b  token0 == tx_tok
+000167f0: 656e 5f69 6e5f 6164 6472 6573 730a 2020  en_in_address.  
+00016800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016810: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00016820: 7365 2076 335f 706f 6f6c 2e74 6f6b 656e  se v3_pool.token
+00016830: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00016840: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016860: 2020 2020 2020 2020 2020 2020 5f61 6d6f              _amo
+00016870: 756e 745f 6f75 7420 3d20 7478 5f61 6d6f  unt_out = tx_amo
+00016880: 756e 745f 6f75 7420 6966 206c 6173 745f  unt_out if last_
+00016890: 7377 6170 2065 6c73 6520 5f61 6d6f 756e  swap else _amoun
+000168a0: 745f 696e 0a20 2020 2020 2020 2020 2020  t_in.           
+000168b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168c0: 205f 616d 6f75 6e74 5f69 6e5f 6d61 7820   _amount_in_max 
+000168d0: 3d20 7478 5f61 6d6f 756e 745f 696e 5f6d  = tx_amount_in_m
+000168e0: 6178 2069 6620 6669 7273 745f 7377 6170  ax if first_swap
+000168f0: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+00016900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016910: 2020 2020 2020 2020 5f2c 2076 335f 7369          _, v3_si
+00016920: 6d5f 7265 7375 6c74 203d 2073 656c 662e  m_result = self.
+00016930: 5f73 696d 756c 6174 655f 7633 5f73 7761  _simulate_v3_swa
+00016940: 705f 6578 6163 745f 6f75 7428 0a20 2020  p_exact_out(.   
+00016950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016960: 2020 2020 2020 2020 2020 2020 2070 6f6f               poo
+00016970: 6c3d 7633 5f70 6f6f 6c2c 0a20 2020 2020  l=v3_pool,.     
+00016980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016990: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+000169a0: 6965 6e74 3d5f 7265 6369 7069 656e 742c  ient=_recipient,
+000169b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000169c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169d0: 2074 6f6b 656e 5f69 6e3d 5f74 6f6b 656e   token_in=_token
+000169e0: 5f69 6e2c 0a20 2020 2020 2020 2020 2020  _in,.           
+000169f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a00: 2020 2020 2061 6d6f 756e 745f 6f75 743d       amount_out=
+00016a10: 5f61 6d6f 756e 745f 6f75 742c 0a20 2020  _amount_out,.   
+00016a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a30: 2020 2020 2020 2020 2020 2020 2061 6d6f               amo
+00016a40: 756e 745f 696e 5f6d 6178 3d5f 616d 6f75  unt_in_max=_amou
+00016a50: 6e74 5f69 6e5f 6d61 782c 0a20 2020 2020  nt_in_max,.     
+00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a70: 2020 2020 2020 2020 2020 2066 6972 7374             first
+00016a80: 5f73 7761 703d 6669 7273 745f 7377 6170  _swap=first_swap
+00016a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ab0: 2020 6c61 7374 5f73 7761 703d 6c61 7374    last_swap=last
+00016ac0: 5f73 7761 702c 0a20 2020 2020 2020 2020  _swap,.         
+00016ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ae0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00016af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b00: 2020 5f61 6d6f 756e 745f 696e 203d 206d    _amount_in = m
+00016b10: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
+00016b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b30: 2020 2020 7633 5f73 696d 5f72 6573 756c      v3_sim_resul
+00016b40: 742e 616d 6f75 6e74 305f 6465 6c74 612c  t.amount0_delta,
+00016b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00016b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b70: 2066 6972 7374 5f73 7761 7020 3d20 746f   first_swap = to
-00016b80: 6b65 6e5f 706f 7320 3d3d 206c 6173 745f  ken_pos == last_
-00016b90: 746f 6b65 6e5f 706f 730a 2020 2020 2020  token_pos.      
-00016ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bb0: 2020 2020 2020 6c61 7374 5f73 7761 7020        last_swap 
-00016bc0: 3d20 746f 6b65 6e5f 706f 7320 3d3d 2030  = token_pos == 0
-00016bd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016be0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00016bf0: 2054 5950 455f 4348 4543 4b49 4e47 3a0a   TYPE_CHECKING:.
-00016c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c20: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00016c30: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00016c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c50: 2020 2020 2020 2073 656c 662e 7633 5f70         self.v3_p
-00016c60: 6f6f 6c5f 6d61 6e61 6765 722c 2055 6e69  ool_manager, Uni
-00016c70: 7377 6170 5633 4c69 7175 6964 6974 7950  swapV3LiquidityP
-00016c80: 6f6f 6c4d 616e 6167 6572 0a20 2020 2020  oolManager.     
-00016c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ca0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00016cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cc0: 2020 2020 2020 2020 2076 335f 706f 6f6c           v3_pool
-00016cd0: 203d 2073 656c 662e 7633 5f70 6f6f 6c5f   = self.v3_pool_
-00016ce0: 6d61 6e61 6765 722e 6765 745f 706f 6f6c  manager.get_pool
-00016cf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d10: 2020 746f 6b65 6e5f 6164 6472 6573 7365    token_addresse
-00016d20: 733d 280a 2020 2020 2020 2020 2020 2020  s=(.            
-00016d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d40: 2020 2020 2020 2020 7478 5f74 6f6b 656e          tx_token
-00016d50: 5f69 6e5f 6164 6472 6573 732c 0a20 2020  _in_address,.   
-00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d80: 2074 785f 746f 6b65 6e5f 6f75 745f 6164   tx_token_out_ad
-00016d90: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-00016da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016db0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00016dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016dd0: 2020 2020 2020 2020 2020 706f 6f6c 5f66            pool_f
-00016de0: 6565 3d74 785f 6665 652c 0a20 2020 2020  ee=tx_fee,.     
-00016df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e00: 2020 2020 2020 2020 2020 2073 696c 656e             silen
-00016e10: 743d 7365 6c66 2e73 696c 656e 742c 0a20  t=self.silent,. 
-00016e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00016e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e50: 2020 2020 2020 2020 2020 5f72 6563 6970            _recip
-00016e60: 6965 6e74 203d 2028 0a20 2020 2020 2020  ient = (.       
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e80: 2020 2020 2020 2020 2074 785f 7265 6369           tx_reci
-00016e90: 7069 656e 7420 6966 206c 6173 745f 7377  pient if last_sw
-00016ea0: 6170 2065 6c73 6520 556e 6976 6572 7361  ap else Universa
-00016eb0: 6c52 6f75 7465 7253 7065 6369 616c 4164  lRouterSpecialAd
-00016ec0: 6472 6573 732e 524f 5554 4552 0a20 2020  dress.ROUTER.   
+00016b70: 2076 335f 7369 6d5f 7265 7375 6c74 2e61   v3_sim_result.a
+00016b80: 6d6f 756e 7431 5f64 656c 7461 2c0a 2020  mount1_delta,.  
+00016b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ba0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00016bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016bc0: 2020 2020 2020 2020 205f 616d 6f75 6e74           _amount
+00016bd0: 5f6f 7574 203d 202d 6d69 6e28 0a20 2020  _out = -min(.   
+00016be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016bf0: 2020 2020 2020 2020 2020 2020 2076 335f               v3_
+00016c00: 7369 6d5f 7265 7375 6c74 2e61 6d6f 756e  sim_result.amoun
+00016c10: 7430 5f64 656c 7461 2c0a 2020 2020 2020  t0_delta,.      
+00016c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c30: 2020 2020 2020 2020 2020 7633 5f73 696d            v3_sim
+00016c40: 5f72 6573 756c 742e 616d 6f75 6e74 315f  _result.amount1_
+00016c50: 6465 6c74 612c 0a20 2020 2020 2020 2020  delta,.         
+00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c70: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00016c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c90: 2020 2320 6368 6563 6b20 7468 6174 2074    # check that t
+00016ca0: 6865 206f 7574 7075 7420 6f66 2065 6163  he output of eac
+00016cb0: 6820 696e 7465 726d 6564 6961 7465 2073  h intermediate s
+00016cc0: 7761 7020 6d65 6574 730a 2020 2020 2020  wap meets.      
+00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ce0: 2020 2020 2020 2320 7468 6520 696e 7075        # the inpu
+00016cf0: 7420 666f 7220 7468 6520 6e65 7874 2073  t for the next s
+00016d00: 7761 700a 2020 2020 2020 2020 2020 2020  wap.            
+00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d20: 6966 206e 6f74 206c 6173 745f 7377 6170  if not last_swap
+00016d30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d50: 2020 2320 706f 6f6c 2073 7461 7465 7320    # pool states 
+00016d60: 6172 6520 6170 7065 6e64 6564 2074 6f20  are appended to 
+00016d70: 6066 7574 7572 655f 706f 6f6c 5f73 7461  `future_pool_sta
+00016d80: 7465 7360 0a20 2020 2020 2020 2020 2020  tes`.           
+00016d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016da0: 2020 2020 2023 2073 6f20 7468 6520 7072       # so the pr
+00016db0: 6576 696f 7573 2073 7761 7020 7769 6c6c  evious swap will
+00016dc0: 2062 6520 696e 2074 6865 206c 6173 7420   be in the last 
+00016dd0: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
+00016de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016df0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+00016e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e10: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00016e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e40: 2020 2020 2020 5f6c 6173 745f 7369 6d5f        _last_sim_
+00016e50: 7265 7375 6c74 2c0a 2020 2020 2020 2020  result,.        
+00016e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e70: 2020 2020 2020 2020 2920 3d20 7365 6c66          ) = self
+00016e80: 2e73 696d 756c 6174 6564 5f70 6f6f 6c5f  .simulated_pool_
+00016e90: 7374 6174 6573 5b2d 315d 0a0a 2020 2020  states[-1]..    
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016eb0: 2020 2020 2020 2020 2020 2020 6966 2054              if T
+00016ec0: 5950 455f 4348 4543 4b49 4e47 3a0a 2020  YPE_CHECKING:.  
 00016ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ee0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00016ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f00: 2020 2020 2020 205f 746f 6b65 6e5f 696e         _token_in
-00016f10: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00016f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f30: 2020 2020 2076 335f 706f 6f6c 2e74 6f6b       v3_pool.tok
-00016f40: 656e 300a 2020 2020 2020 2020 2020 2020  en0.            
+00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ef0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00016f00: 6e63 6528 0a20 2020 2020 2020 2020 2020  nce(.           
+00016f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f20: 2020 2020 2020 2020 2020 2020 205f 6c61               _la
+00016f30: 7374 5f73 696d 5f72 6573 756c 742c 0a20  st_sim_result,. 
+00016f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00016f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f60: 2020 2020 6966 2076 335f 706f 6f6c 2e74      if v3_pool.t
-00016f70: 6f6b 656e 3020 3d3d 2074 785f 746f 6b65  oken0 == tx_toke
-00016f80: 6e5f 696e 5f61 6464 7265 7373 0a20 2020  n_in_address.   
-00016f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fa0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00016fb0: 6520 7633 5f70 6f6f 6c2e 746f 6b65 6e31  e v3_pool.token1
-00016fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016fd0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00016fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ff0: 2020 2020 2020 2020 2020 205f 616d 6f75             _amou
-00017000: 6e74 5f6f 7574 203d 2074 785f 616d 6f75  nt_out = tx_amou
-00017010: 6e74 5f6f 7574 2069 6620 6c61 7374 5f73  nt_out if last_s
-00017020: 7761 7020 656c 7365 205f 616d 6f75 6e74  wap else _amount
-00017030: 5f69 6e0a 2020 2020 2020 2020 2020 2020  _in.            
-00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017050: 5f61 6d6f 756e 745f 696e 5f6d 6178 203d  _amount_in_max =
-00017060: 2074 785f 616d 6f75 6e74 5f69 6e5f 6d61   tx_amount_in_ma
-00017070: 7820 6966 2066 6972 7374 5f73 7761 7020  x if first_swap 
-00017080: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+00016f60: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
+00016f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f90: 2020 2020 2055 6e69 7377 6170 5632 506f       UniswapV2Po
+00016fa0: 6f6c 5369 6d75 6c61 7469 6f6e 5265 7375  olSimulationResu
+00016fb0: 6c74 2c0a 2020 2020 2020 2020 2020 2020  lt,.            
+00016fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fe0: 556e 6973 7761 7056 3250 6f6f 6c53 696d  UniswapV2PoolSim
+00016ff0: 756c 6174 696f 6e52 6573 756c 742c 0a20  ulationResult,. 
+00017000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017020: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00017030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017040: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017070: 205f 6c61 7374 5f61 6d6f 756e 745f 696e   _last_amount_in
+00017080: 203d 206d 6178 280a 2020 2020 2020 2020   = max(.        
 00017090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170a0: 2020 2020 2020 205f 2c20 7633 5f73 696d         _, v3_sim
-000170b0: 5f72 6573 756c 7420 3d20 7365 6c66 2e5f  _result = self._
-000170c0: 7369 6d75 6c61 7465 5f76 335f 7377 6170  simulate_v3_swap
-000170d0: 5f65 7861 6374 5f6f 7574 280a 2020 2020  _exact_out(.    
+000170a0: 2020 2020 2020 2020 2020 2020 5f6c 6173              _las
+000170b0: 745f 7369 6d5f 7265 7375 6c74 2e61 6d6f  t_sim_result.amo
+000170c0: 756e 7430 5f64 656c 7461 2c0a 2020 2020  unt0_delta,.    
+000170d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000170e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170f0: 2020 2020 2020 2020 2020 2020 706f 6f6c              pool
-00017100: 3d76 335f 706f 6f6c 2c0a 2020 2020 2020  =v3_pool,.      
+000170f0: 5f6c 6173 745f 7369 6d5f 7265 7375 6c74  _last_sim_result
+00017100: 2e61 6d6f 756e 7431 5f64 656c 7461 2c0a  .amount1_delta,.
 00017110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017120: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00017130: 656e 743d 5f72 6563 6970 6965 6e74 2c0a  ent=_recipient,.
+00017120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017130: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
 00017140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017160: 746f 6b65 6e5f 696e 3d5f 746f 6b65 6e5f  token_in=_token_
-00017170: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00017150: 2020 2069 6620 5f61 6d6f 756e 745f 6f75     if _amount_ou
+00017160: 7420 213d 205f 6c61 7374 5f61 6d6f 756e  t != _last_amoun
+00017170: 745f 696e 3a0a 2020 2020 2020 2020 2020  t_in:.          
 00017180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017190: 2020 2020 616d 6f75 6e74 5f6f 7574 3d5f      amount_out=_
-000171a0: 616d 6f75 6e74 5f6f 7574 2c0a 2020 2020  amount_out,.    
-000171b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171c0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-000171d0: 6e74 5f69 6e5f 6d61 783d 5f61 6d6f 756e  nt_in_max=_amoun
-000171e0: 745f 696e 5f6d 6178 2c0a 2020 2020 2020  t_in_max,.      
-000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017200: 2020 2020 2020 2020 2020 6669 7273 745f            first_
-00017210: 7377 6170 3d66 6972 7374 5f73 7761 702c  swap=first_swap,
-00017220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017240: 206c 6173 745f 7377 6170 3d6c 6173 745f   last_swap=last_
-00017250: 7377 6170 2c0a 2020 2020 2020 2020 2020  swap,.          
-00017260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017270: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017290: 205f 616d 6f75 6e74 5f69 6e20 3d20 6d61   _amount_in = ma
-000172a0: 7828 0a20 2020 2020 2020 2020 2020 2020  x(.             
-000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172c0: 2020 2076 335f 7369 6d5f 7265 7375 6c74     v3_sim_result
-000172d0: 2e61 6d6f 756e 7430 5f64 656c 7461 2c0a  .amount0_delta,.
-000172e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017300: 7633 5f73 696d 5f72 6573 756c 742e 616d  v3_sim_result.am
-00017310: 6f75 6e74 315f 6465 6c74 612c 0a20 2020  ount1_delta,.   
-00017320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017330: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00017340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017350: 2020 2020 2020 2020 5f61 6d6f 756e 745f          _amount_
-00017360: 6f75 7420 3d20 2d6d 696e 280a 2020 2020  out = -min(.    
+00017190: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000171a0: 5472 616e 7361 6374 696f 6e45 7272 6f72  TransactionError
+000171b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000171c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171d0: 2020 2020 2020 2020 2020 6622 496e 7375            f"Insu
+000171e0: 6666 6963 6965 6e74 2073 7761 7020 616d  fficient swap am
+000171f0: 6f75 6e74 2074 6872 6f75 6768 2072 6571  ount through req
+00017200: 7565 7374 6564 2070 6f6f 6c20 7b76 335f  uested pool {v3_
+00017210: 706f 6f6c 7d2e 204e 6565 6465 6420 7b5f  pool}. Needed {_
+00017220: 6c61 7374 5f61 6d6f 756e 745f 696e 7d2c  last_amount_in},
+00017230: 2072 6563 6569 7665 6420 7b5f 616d 6f75   received {_amou
+00017240: 6e74 5f6f 7574 7d22 0a20 2020 2020 2020  nt_out}".       
+00017250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017260: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00017270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017280: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00017290: 2e73 696d 756c 6174 6564 5f70 6f6f 6c5f  .simulated_pool_
+000172a0: 7374 6174 6573 2e61 7070 656e 6428 2876  states.append((v
+000172b0: 335f 706f 6f6c 2c20 7633 5f73 696d 5f72  3_pool, v3_sim_r
+000172c0: 6573 756c 7429 290a 0a20 2020 2020 2020  esult))..       
+000172d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172e0: 2023 2056 3320 526f 7574 6572 2065 6e66   # V3 Router enf
+000172f0: 6f72 6365 7320 6120 6d61 7869 6d75 6d20  orces a maximum 
+00017300: 696e 7075 740a 2020 2020 2020 2020 2020  input.          
+00017310: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00017320: 2066 6972 7374 5f73 7761 703a 0a20 2020   first_swap:.   
+00017330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017340: 2020 2020 2020 2020 205f 7369 6d5f 7265           _sim_re
+00017350: 7375 6c74 3a20 4261 7365 5369 6d75 6c61  sult: BaseSimula
+00017360: 7469 6f6e 5265 7375 6c74 0a20 2020 2020  tionResult.     
 00017370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017380: 2020 2020 2020 2020 2020 2020 7633 5f73              v3_s
-00017390: 696d 5f72 6573 756c 742e 616d 6f75 6e74  im_result.amount
-000173a0: 305f 6465 6c74 612c 0a20 2020 2020 2020  0_delta,.       
-000173b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173c0: 2020 2020 2020 2020 2076 335f 7369 6d5f           v3_sim_
-000173d0: 7265 7375 6c74 2e61 6d6f 756e 7431 5f64  result.amount1_d
-000173e0: 656c 7461 2c0a 2020 2020 2020 2020 2020  elta,.          
+00017380: 2020 2020 2020 205f 2c20 5f73 696d 5f72         _, _sim_r
+00017390: 6573 756c 7420 3d20 7365 6c66 2e73 696d  esult = self.sim
+000173a0: 756c 6174 6564 5f70 6f6f 6c5f 7374 6174  ulated_pool_stat
+000173b0: 6573 5b2d 315d 0a0a 2020 2020 2020 2020  es[-1]..        
+000173c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173d0: 2020 2020 616d 6f75 6e74 5f64 6570 6f73      amount_depos
+000173e0: 6974 6564 203d 206d 6178 280a 2020 2020  ited = max(.    
 000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017400: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00017410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017420: 2023 2063 6865 636b 2074 6861 7420 7468   # check that th
-00017430: 6520 6f75 7470 7574 206f 6620 6561 6368  e output of each
-00017440: 2069 6e74 6572 6d65 6469 6174 6520 7377   intermediate sw
-00017450: 6170 206d 6565 7473 0a20 2020 2020 2020  ap meets.       
-00017460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017470: 2020 2020 2023 2074 6865 2069 6e70 7574       # the input
-00017480: 2066 6f72 2074 6865 206e 6578 7420 7377   for the next sw
-00017490: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-000174a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000174b0: 6620 6e6f 7420 6c61 7374 5f73 7761 703a  f not last_swap:
-000174c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017400: 2020 2020 2020 2020 2020 2020 5f73 696d              _sim
+00017410: 5f72 6573 756c 742e 616d 6f75 6e74 305f  _result.amount0_
+00017420: 6465 6c74 612c 0a20 2020 2020 2020 2020  delta,.         
+00017430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017440: 2020 2020 2020 205f 7369 6d5f 7265 7375         _sim_resu
+00017450: 6c74 2e61 6d6f 756e 7431 5f64 656c 7461  lt.amount1_delta
+00017460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017470: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017490: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000174a0: 616d 6f75 6e74 5f64 6570 6f73 6974 6564  amount_deposited
+000174b0: 203e 2074 785f 616d 6f75 6e74 5f69 6e5f   > tx_amount_in_
+000174c0: 6d61 783a 0a20 2020 2020 2020 2020 2020  max:.           
 000174d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174e0: 2023 2070 6f6f 6c20 7374 6174 6573 2061   # pool states a
-000174f0: 7265 2061 7070 656e 6465 6420 746f 2060  re appended to `
-00017500: 6675 7475 7265 5f70 6f6f 6c5f 7374 6174  future_pool_stat
-00017510: 6573 600a 2020 2020 2020 2020 2020 2020  es`.            
-00017520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017530: 2020 2020 2320 736f 2074 6865 2070 7265      # so the pre
-00017540: 7669 6f75 7320 7377 6170 2077 696c 6c20  vious swap will 
-00017550: 6265 2069 6e20 7468 6520 6c61 7374 2070  be in the last p
-00017560: 6f73 6974 696f 6e0a 2020 2020 2020 2020  osition.        
-00017570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017580: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00017590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175a0: 2020 2020 2020 2020 2020 2020 2020 5f2c                _,
-000175b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000175c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175d0: 2020 2020 205f 6c61 7374 5f73 696d 5f72       _last_sim_r
-000175e0: 6573 756c 742c 0a20 2020 2020 2020 2020  esult,.         
-000175f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017600: 2020 2020 2020 2029 203d 205f 7633 5f72         ) = _v3_r
-00017610: 6f75 7465 725f 6675 7475 7265 5f70 6f6f  outer_future_poo
-00017620: 6c5f 7374 6174 6573 5b2d 315d 0a0a 2020  l_states[-1]..  
-00017630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017640: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00017650: 2054 5950 455f 4348 4543 4b49 4e47 3a0a   TYPE_CHECKING:.
-00017660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017680: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00017690: 7461 6e63 6528 0a20 2020 2020 2020 2020  tance(.         
-000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176b0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-000176c0: 6c61 7374 5f73 696d 5f72 6573 756c 742c  last_sim_result,
-000176d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000176e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176f0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017720: 2020 2020 2020 2055 6e69 7377 6170 5632         UniswapV2
-00017730: 506f 6f6c 5369 6d75 6c61 7469 6f6e 5265  PoolSimulationRe
-00017740: 7375 6c74 2c0a 2020 2020 2020 2020 2020  sult,.          
-00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017770: 2020 556e 6973 7761 7056 3250 6f6f 6c53    UniswapV2PoolS
-00017780: 696d 756c 6174 696f 6e52 6573 756c 742c  imulationResult,
-00017790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000177a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177b0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-000177c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177e0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-000177f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017800: 2020 205f 6c61 7374 5f61 6d6f 756e 745f     _last_amount_
-00017810: 696e 203d 206d 6178 280a 2020 2020 2020  in = max(.      
-00017820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017830: 2020 2020 2020 2020 2020 2020 2020 5f6c                _l
-00017840: 6173 745f 7369 6d5f 7265 7375 6c74 2e61  ast_sim_result.a
-00017850: 6d6f 756e 7430 5f64 656c 7461 2c0a 2020  mount0_delta,.  
-00017860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017880: 2020 5f6c 6173 745f 7369 6d5f 7265 7375    _last_sim_resu
-00017890: 6c74 2e61 6d6f 756e 7431 5f64 656c 7461  lt.amount1_delta
-000178a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178c0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-000178d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178e0: 2020 2020 2069 6620 5f61 6d6f 756e 745f       if _amount_
-000178f0: 6f75 7420 213d 205f 6c61 7374 5f61 6d6f  out != _last_amo
-00017900: 756e 745f 696e 3a0a 2020 2020 2020 2020  unt_in:.        
+000174e0: 2020 2020 2072 6169 7365 2054 7261 6e73       raise Trans
+000174f0: 6163 7469 6f6e 4572 726f 7228 0a20 2020  actionError(.   
+00017500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017520: 2066 224d 6178 696d 756d 2069 6e70 7574   f"Maximum input
+00017530: 2065 7863 6565 6465 642e 2053 7065 6369   exceeded. Speci
+00017540: 6669 6564 207b 7478 5f61 6d6f 756e 745f  fied {tx_amount_
+00017550: 696e 5f6d 6178 7d2c 207b 616d 6f75 6e74  in_max}, {amount
+00017560: 5f64 6570 6f73 6974 6564 7d20 7265 7175  _deposited} requ
+00017570: 6972 6564 2e22 0a20 2020 2020 2020 2020  ired.".         
+00017580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017590: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000175a0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+000175b0: 7365 2022 756e 7772 6170 5745 5448 3922  se "unwrapWETH9"
+000175c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000175d0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+000175e0: 3a20 6966 2045 5448 2062 616c 616e 6365  : if ETH balance
+000175f0: 7320 6172 6520 6576 6572 206e 6565 6465  s are ever neede
+00017600: 642c 2068 616e 646c 6520 7468 650a 2020  d, handle the.  
+00017610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017620: 2020 2020 2020 2320 4554 4820 7472 616e        # ETH tran
+00017630: 7366 6572 2072 6573 756c 7469 6e67 2066  sfer resulting f
+00017640: 726f 6d20 7468 6973 2066 756e 6374 696f  rom this functio
+00017650: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00017660: 2020 2020 2020 2020 2020 616d 6f75 6e74            amount
+00017670: 4d69 6e20 3d20 6675 6e63 5f70 6172 616d  Min = func_param
+00017680: 735b 2261 6d6f 756e 744d 696e 696d 756d  s["amountMinimum
+00017690: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+000176a0: 2020 2020 2020 2020 2020 2077 7261 7070             wrapp
+000176b0: 6564 5f74 6f6b 656e 5f61 6464 7265 7373  ed_token_address
+000176c0: 203d 2057 5241 5050 4544 5f4e 4154 4956   = WRAPPED_NATIV
+000176d0: 455f 544f 4b45 4e53 5b73 656c 662e 6368  E_TOKENS[self.ch
+000176e0: 6169 6e5f 6964 5d0a 2020 2020 2020 2020  ain_id].        
+000176f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017700: 7772 6170 7065 645f 746f 6b65 6e5f 6261  wrapped_token_ba
+00017710: 6c61 6e63 6520 3d20 7365 6c66 2e6c 6564  lance = self.led
+00017720: 6765 722e 746f 6b65 6e5f 6261 6c61 6e63  ger.token_balanc
+00017730: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00017740: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017750: 656c 662e 726f 7574 6572 5f61 6464 7265  elf.router_addre
+00017760: 7373 2c20 7772 6170 7065 645f 746f 6b65  ss, wrapped_toke
+00017770: 6e5f 6164 6472 6573 730a 2020 2020 2020  n_address.      
+00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017790: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000177a0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+000177b0: 7261 7070 6564 5f74 6f6b 656e 5f62 616c  rapped_token_bal
+000177c0: 616e 6365 203c 2061 6d6f 756e 744d 696e  ance < amountMin
+000177d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000177e0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000177f0: 6973 6520 5472 616e 7361 6374 696f 6e45  ise TransactionE
+00017800: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017820: 2020 2020 2020 6622 5265 7175 6573 7465        f"Requeste
+00017830: 6420 756e 7772 6170 206f 6620 6d69 6e2e  d unwrap of min.
+00017840: 207b 616d 6f75 6e74 4d69 6e7d 2057 4554   {amountMin} WET
+00017850: 482c 2072 6563 6569 7665 6420 7b77 7261  H, received {wra
+00017860: 7070 6564 5f74 6f6b 656e 5f62 616c 616e  pped_token_balan
+00017870: 6365 7d22 0a20 2020 2020 2020 2020 2020  ce}".           
+00017880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017890: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+000178a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000178b0: 2e5f 7369 6d75 6c61 7465 5f75 6e77 7261  ._simulate_unwra
+000178c0: 7028 7772 6170 7065 645f 746f 6b65 6e5f  p(wrapped_token_
+000178d0: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
+000178e0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+000178f0: 7365 2022 756e 7772 6170 5745 5448 3957  se "unwrapWETH9W
+00017900: 6974 6846 6565 223a 0a20 2020 2020 2020  ithFee":.       
 00017910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017920: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00017930: 6520 5472 616e 7361 6374 696f 6e45 7272  e TransactionErr
-00017940: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00017950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017960: 2020 2020 2020 2020 2020 2020 6622 496e              f"In
-00017970: 7375 6666 6963 6965 6e74 2073 7761 7020  sufficient swap 
-00017980: 616d 6f75 6e74 2074 6872 6f75 6768 2072  amount through r
-00017990: 6571 7565 7374 6564 2070 6f6f 6c20 7b76  equested pool {v
-000179a0: 335f 706f 6f6c 7d2e 204e 6565 6465 6420  3_pool}. Needed 
-000179b0: 7b5f 6c61 7374 5f61 6d6f 756e 745f 696e  {_last_amount_in
-000179c0: 7d2c 2072 6563 6569 7665 6420 7b5f 616d  }, received {_am
-000179d0: 6f75 6e74 5f6f 7574 7d22 0a20 2020 2020  ount_out}".     
+00017920: 2023 2054 4f44 4f3a 2069 6620 4554 4820   # TODO: if ETH 
+00017930: 6261 6c61 6e63 6573 2061 7265 2065 7665  balances are eve
+00017940: 7220 6e65 6564 6564 2c20 6861 6e64 6c65  r needed, handle
+00017950: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00017960: 2020 2020 2020 2020 2020 2020 2023 2074               # t
+00017970: 776f 2045 5448 2074 7261 6e73 6665 7273  wo ETH transfers
+00017980: 2072 6573 756c 7469 6e67 2066 726f 6d20   resulting from 
+00017990: 7468 6973 2066 756e 6374 696f 6e0a 2020  this function.  
+000179a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179b0: 2020 2020 2020 5f61 6d6f 756e 745f 696e        _amount_in
+000179c0: 203d 2066 756e 635f 7061 7261 6d73 5b22   = func_params["
+000179d0: 616d 6f75 6e74 4d69 6e69 6d75 6d22 5d0a  amountMinimum"].
 000179e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00017a00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00017a10: 2020 2020 2020 2020 2020 2020 2020 5f76                _v
-00017a20: 335f 726f 7574 6572 5f66 7574 7572 655f  3_router_future_
-00017a30: 706f 6f6c 5f73 7461 7465 732e 6170 7065  pool_states.appe
-00017a40: 6e64 2828 7633 5f70 6f6f 6c2c 2076 335f  nd((v3_pool, v3_
-00017a50: 7369 6d5f 7265 7375 6c74 2929 0a0a 2020  sim_result))..  
+000179f0: 2020 2020 2020 2020 5f72 6563 6970 6965          _recipie
+00017a00: 6e74 203d 2066 756e 635f 7061 7261 6d73  nt = func_params
+00017a10: 5b22 7265 6369 7069 656e 7422 5d0a 2020  ["recipient"].  
+00017a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a30: 2020 2020 2020 5f66 6565 5f62 6970 7320        _fee_bips 
+00017a40: 3d20 6675 6e63 5f70 6172 616d 735b 2266  = func_params["f
+00017a50: 6565 4269 7073 225d 0a20 2020 2020 2020  eeBips"].       
 00017a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a70: 2020 2020 2020 2320 5633 2052 6f75 7465        # V3 Route
-00017a80: 7220 656e 666f 7263 6573 2061 206d 6178  r enforces a max
-00017a90: 696d 756d 2069 6e70 7574 0a20 2020 2020  imum input.     
+00017a70: 205f 6665 655f 7265 6369 7069 656e 7420   _fee_recipient 
+00017a80: 3d20 6675 6e63 5f70 6172 616d 735b 2266  = func_params["f
+00017a90: 6565 5265 6369 7069 656e 7422 5d0a 0a20  eeRecipient"].. 
 00017aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ab0: 2020 2069 6620 6669 7273 745f 7377 6170     if first_swap
-00017ac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017ad0: 2020 2020 2020 2020 2020 2020 2020 5f73                _s
-00017ae0: 696d 5f72 6573 756c 743a 2042 6173 6553  im_result: BaseS
-00017af0: 696d 756c 6174 696f 6e52 6573 756c 740a  imulationResult.
-00017b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b10: 2020 2020 2020 2020 2020 2020 5f2c 205f              _, _
-00017b20: 7369 6d5f 7265 7375 6c74 203d 205f 7633  sim_result = _v3
-00017b30: 5f72 6f75 7465 725f 6675 7475 7265 5f70  _router_future_p
-00017b40: 6f6f 6c5f 7374 6174 6573 5b2d 315d 0a0a  ool_states[-1]..
-00017b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b60: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-00017b70: 6e74 5f64 6570 6f73 6974 6564 203d 206d  nt_deposited = m
-00017b80: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
-00017b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ba0: 2020 2020 5f73 696d 5f72 6573 756c 742e      _sim_result.
-00017bb0: 616d 6f75 6e74 305f 6465 6c74 612c 0a20  amount0_delta,. 
-00017bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bd0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00017be0: 7369 6d5f 7265 7375 6c74 2e61 6d6f 756e  sim_result.amoun
-00017bf0: 7431 5f64 656c 7461 2c0a 2020 2020 2020  t1_delta,.      
-00017c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c10: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00017ab0: 2020 2020 2020 2077 7261 7070 6564 5f74         wrapped_t
+00017ac0: 6f6b 656e 5f61 6464 7265 7373 203d 2057  oken_address = W
+00017ad0: 5241 5050 4544 5f4e 4154 4956 455f 544f  RAPPED_NATIVE_TO
+00017ae0: 4b45 4e53 5b73 656c 662e 6368 6169 6e5f  KENS[self.chain_
+00017af0: 6964 5d0a 2020 2020 2020 2020 2020 2020  id].            
+00017b00: 2020 2020 2020 2020 2020 2020 7772 6170              wrap
+00017b10: 7065 645f 746f 6b65 6e5f 6261 6c61 6e63  ped_token_balanc
+00017b20: 6520 3d20 7365 6c66 2e6c 6564 6765 722e  e = self.ledger.
+00017b30: 746f 6b65 6e5f 6261 6c61 6e63 6528 0a20  token_balance(. 
+00017b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017b60: 726f 7574 6572 5f61 6464 7265 7373 2c20  router_address, 
+00017b70: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
+00017b80: 6472 6573 730a 2020 2020 2020 2020 2020  dress.          
+00017b90: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00017ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bb0: 2020 2020 2020 2020 6966 2077 7261 7070          if wrapp
+00017bc0: 6564 5f74 6f6b 656e 5f62 616c 616e 6365  ed_token_balance
+00017bd0: 203c 205f 616d 6f75 6e74 5f69 6e3a 0a20   < _amount_in:. 
+00017be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bf0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00017c00: 2054 7261 6e73 6163 7469 6f6e 4572 726f   TransactionErro
+00017c10: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
 00017c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c30: 2020 2020 2069 6620 616d 6f75 6e74 5f64       if amount_d
-00017c40: 6570 6f73 6974 6564 203e 2074 785f 616d  eposited > tx_am
-00017c50: 6f75 6e74 5f69 6e5f 6d61 783a 0a20 2020  ount_in_max:.   
-00017c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c70: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00017c80: 7365 2054 7261 6e73 6163 7469 6f6e 4572  se TransactionEr
-00017c90: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00017ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cb0: 2020 2020 2020 2020 2066 224d 6178 696d           f"Maxim
-00017cc0: 756d 2069 6e70 7574 2065 7863 6565 6465  um input exceede
-00017cd0: 642e 2053 7065 6369 6669 6564 207b 7478  d. Specified {tx
-00017ce0: 5f61 6d6f 756e 745f 696e 5f6d 6178 7d2c  _amount_in_max},
-00017cf0: 207b 616d 6f75 6e74 5f64 6570 6f73 6974   {amount_deposit
-00017d00: 6564 7d20 7265 7175 6972 6564 2e22 0a20  ed} required.". 
+00017c30: 2020 2066 2252 6571 7565 7374 6564 2075     f"Requested u
+00017c40: 6e77 7261 7020 6f66 206d 696e 2e20 7b5f  nwrap of min. {_
+00017c50: 616d 6f75 6e74 5f69 6e7d 2057 4554 482c  amount_in} WETH,
+00017c60: 2072 6563 6569 7665 6420 7b77 7261 7070   received {wrapp
+00017c70: 6564 5f74 6f6b 656e 5f62 616c 616e 6365  ed_token_balance
+00017c80: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00017c90: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00017ca0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00017cb0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00017cc0: 7369 6d75 6c61 7465 5f75 6e77 7261 7028  simulate_unwrap(
+00017cd0: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
+00017ce0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
+00017cf0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00017d00: 2022 7377 6565 7054 6f6b 656e 223a 0a20   "sweepToken":. 
 00017d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00017d30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00017d40: 2020 2020 2020 6361 7365 2022 756e 7772        case "unwr
-00017d50: 6170 5745 5448 3922 3a0a 2020 2020 2020  apWETH9":.      
-00017d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d70: 2020 2320 544f 444f 3a20 6966 2045 5448    # TODO: if ETH
-00017d80: 2062 616c 616e 6365 7320 6172 6520 6576   balances are ev
-00017d90: 6572 206e 6565 6465 642c 2068 616e 646c  er needed, handl
-00017da0: 6520 7468 650a 2020 2020 2020 2020 2020  e the.          
-00017db0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017dc0: 4554 4820 7472 616e 7366 6572 2072 6573  ETH transfer res
-00017dd0: 756c 7469 6e67 2066 726f 6d20 7468 6973  ulting from this
-00017de0: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00017d20: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00017d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d40: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+00017d50: 2074 7261 6e73 6665 7273 2074 6865 2063   transfers the c
+00017d60: 7572 7265 6e74 2074 6f6b 656e 2062 616c  urrent token bal
+00017d70: 616e 6365 0a20 2020 2020 2020 2020 2020  ance.           
+00017d80: 2020 2020 2020 2020 2020 2020 2068 656c               hel
+00017d90: 6420 6279 2074 6865 2063 6f6e 7472 6163  d by the contrac
+00017da0: 7420 746f 2060 7265 6369 7069 656e 7460  t to `recipient`
+00017db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017dc0: 2020 2020 2020 2020 2022 2222 0a0a 2020           """..  
+00017dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017de0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
 00017df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e00: 2020 616d 6f75 6e74 4d69 6e20 3d20 6675    amountMin = fu
-00017e10: 6e63 5f70 6172 616d 735b 2261 6d6f 756e  nc_params["amoun
-00017e20: 744d 696e 696d 756d 225d 0a20 2020 2020  tMinimum"].     
+00017e00: 2020 2020 2020 2074 785f 746f 6b65 6e5f         tx_token_
+00017e10: 6164 6472 6573 7320 3d20 6675 6e63 5f70  address = func_p
+00017e20: 6172 616d 735b 2274 6f6b 656e 225d 0a20  arams["token"]. 
 00017e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e40: 2020 2077 7261 7070 6564 5f74 6f6b 656e     wrapped_token
-00017e50: 5f61 6464 7265 7373 203d 2057 5241 5050  _address = WRAPP
-00017e60: 4544 5f4e 4154 4956 455f 544f 4b45 4e53  ED_NATIVE_TOKENS
-00017e70: 5b73 656c 662e 6368 6169 6e5f 6964 5d0a  [self.chain_id].
+00017e40: 2020 2020 2020 2020 2020 2074 785f 616d             tx_am
+00017e50: 6f75 6e74 5f6f 7574 5f6d 696e 696d 756d  ount_out_minimum
+00017e60: 203d 2066 756e 635f 7061 7261 6d73 5b22   = func_params["
+00017e70: 616d 6f75 6e74 4d69 6e69 6d75 6d22 5d0a  amountMinimum"].
 00017e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e90: 2020 2020 2020 2020 7772 6170 7065 645f          wrapped_
-00017ea0: 746f 6b65 6e5f 6261 6c61 6e63 6520 3d20  token_balance = 
-00017eb0: 7365 6c66 2e6c 6564 6765 722e 746f 6b65  self.ledger.toke
-00017ec0: 6e5f 6261 6c61 6e63 6528 0a20 2020 2020  n_balance(.     
+00017e90: 2020 2020 2020 2020 2020 2020 7478 5f72              tx_r
+00017ea0: 6563 6970 6965 6e74 203d 2066 756e 635f  ecipient = func_
+00017eb0: 7061 7261 6d73 2e67 6574 2822 7265 6369  params.get("reci
+00017ec0: 7069 656e 7422 290a 2020 2020 2020 2020  pient").        
 00017ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ee0: 2020 2020 2020 2073 656c 662e 726f 7574         self.rout
-00017ef0: 6572 5f61 6464 7265 7373 2c20 7772 6170  er_address, wrap
-00017f00: 7065 645f 746f 6b65 6e5f 6164 6472 6573  ped_token_addres
-00017f10: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00017f20: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00017f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f40: 2020 2020 6966 2077 7261 7070 6564 5f74      if wrapped_t
-00017f50: 6f6b 656e 5f62 616c 616e 6365 203c 2061  oken_balance < a
-00017f60: 6d6f 756e 744d 696e 3a0a 2020 2020 2020  mountMin:.      
-00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f80: 2020 2020 2020 7261 6973 6520 5472 616e        raise Tran
-00017f90: 7361 6374 696f 6e45 7272 6f72 280a 2020  sactionError(.  
-00017fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fb0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00017fc0: 5265 7175 6573 7465 6420 756e 7772 6170  Requested unwrap
-00017fd0: 206f 6620 6d69 6e2e 207b 616d 6f75 6e74   of min. {amount
-00017fe0: 4d69 6e7d 2057 4554 482c 2072 6563 6569  Min} WETH, recei
-00017ff0: 7665 6420 7b77 7261 7070 6564 5f74 6f6b  ved {wrapped_tok
-00018000: 656e 5f62 616c 616e 6365 7d22 0a20 2020  en_balance}".   
-00018010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018020: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00018030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018040: 2020 2020 7365 6c66 2e5f 7369 6d75 6c61      self._simula
-00018050: 7465 5f75 6e77 7261 7028 7772 6170 7065  te_unwrap(wrappe
-00018060: 645f 746f 6b65 6e5f 6164 6472 6573 7329  d_token_address)
-00018070: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00018080: 2020 2020 2020 6361 7365 2022 756e 7772        case "unwr
-00018090: 6170 5745 5448 3957 6974 6846 6565 223a  apWETH9WithFee":
-000180a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000180b0: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-000180c0: 2069 6620 4554 4820 6261 6c61 6e63 6573   if ETH balances
-000180d0: 2061 7265 2065 7665 7220 6e65 6564 6564   are ever needed
-000180e0: 2c20 6861 6e64 6c65 2074 6865 0a20 2020  , handle the.   
+00017ee0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00017ef0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00017f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f10: 2020 2070 7269 6e74 2865 290a 2020 2020     print(e).    
+00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f50: 2020 2020 2020 2320 526f 7574 6572 3220        # Router2 
+00017f60: 4142 4920 6f6d 6974 7320 6072 6563 6970  ABI omits `recip
+00017f70: 6965 6e74 602c 2061 6c77 6179 7320 7573  ient`, always us
+00017f80: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00017f90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017fa0: 2060 6d73 672e 7365 6e64 6572 600a 2020   `msg.sender`.  
+00017fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fc0: 2020 2020 2020 2020 2020 6966 2074 785f            if tx_
+00017fd0: 7265 6369 7069 656e 7420 6973 204e 6f6e  recipient is Non
+00017fe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00017ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018000: 2020 2074 785f 7265 6369 7069 656e 7420     tx_recipient 
+00018010: 3d20 7365 6c66 2e73 656e 6465 720a 2020  = self.sender.  
+00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018030: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018060: 7365 6c66 2e72 6563 6970 6965 6e74 732e  self.recipients.
+00018070: 6164 6428 7478 5f72 6563 6970 6965 6e74  add(tx_recipient
+00018080: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00018090: 2020 2020 2020 2020 2020 205f 6261 6c61             _bala
+000180a0: 6e63 6520 3d20 7365 6c66 2e6c 6564 6765  nce = self.ledge
+000180b0: 722e 746f 6b65 6e5f 6261 6c61 6e63 6528  r.token_balance(
+000180c0: 7365 6c66 2e72 6f75 7465 725f 6164 6472  self.router_addr
+000180d0: 6573 732c 2074 785f 746f 6b65 6e5f 6164  ess, tx_token_ad
+000180e0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
 000180f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018100: 2020 2020 2023 2074 776f 2045 5448 2074       # two ETH t
-00018110: 7261 6e73 6665 7273 2072 6573 756c 7469  ransfers resulti
-00018120: 6e67 2066 726f 6d20 7468 6973 2066 756e  ng from this fun
-00018130: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-00018140: 2020 2020 2020 2020 2020 2020 2020 5f61                _a
-00018150: 6d6f 756e 745f 696e 203d 2066 756e 635f  mount_in = func_
-00018160: 7061 7261 6d73 5b22 616d 6f75 6e74 4d69  params["amountMi
-00018170: 6e69 6d75 6d22 5d0a 2020 2020 2020 2020  nimum"].        
-00018180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018190: 5f72 6563 6970 6965 6e74 203d 2066 756e  _recipient = fun
-000181a0: 635f 7061 7261 6d73 5b22 7265 6369 7069  c_params["recipi
-000181b0: 656e 7422 5d0a 2020 2020 2020 2020 2020  ent"].          
-000181c0: 2020 2020 2020 2020 2020 2020 2020 5f66                _f
-000181d0: 6565 5f62 6970 7320 3d20 6675 6e63 5f70  ee_bips = func_p
-000181e0: 6172 616d 735b 2266 6565 4269 7073 225d  arams["feeBips"]
-000181f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018200: 2020 2020 2020 2020 205f 6665 655f 7265           _fee_re
-00018210: 6369 7069 656e 7420 3d20 6675 6e63 5f70  cipient = func_p
-00018220: 6172 616d 735b 2266 6565 5265 6369 7069  arams["feeRecipi
-00018230: 656e 7422 5d0a 0a20 2020 2020 2020 2020  ent"]..         
-00018240: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00018250: 7261 7070 6564 5f74 6f6b 656e 5f61 6464  rapped_token_add
-00018260: 7265 7373 203d 2057 5241 5050 4544 5f4e  ress = WRAPPED_N
-00018270: 4154 4956 455f 544f 4b45 4e53 5b73 656c  ATIVE_TOKENS[sel
-00018280: 662e 6368 6169 6e5f 6964 5d0a 2020 2020  f.chain_id].    
-00018290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182a0: 2020 2020 7772 6170 7065 645f 746f 6b65      wrapped_toke
-000182b0: 6e5f 6261 6c61 6e63 6520 3d20 7365 6c66  n_balance = self
-000182c0: 2e6c 6564 6765 722e 746f 6b65 6e5f 6261  .ledger.token_ba
-000182d0: 6c61 6e63 6528 0a20 2020 2020 2020 2020  lance(.         
-000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182f0: 2020 2073 656c 662e 726f 7574 6572 5f61     self.router_a
-00018300: 6464 7265 7373 2c20 7772 6170 7065 645f  ddress, wrapped_
-00018310: 746f 6b65 6e5f 6164 6472 6573 730a 2020  token_address.  
-00018320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018330: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00018340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018350: 6966 2077 7261 7070 6564 5f74 6f6b 656e  if wrapped_token
-00018360: 5f62 616c 616e 6365 203c 205f 616d 6f75  _balance < _amou
-00018370: 6e74 5f69 6e3a 0a20 2020 2020 2020 2020  nt_in:.         
-00018380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018390: 2020 2072 6169 7365 2054 7261 6e73 6163     raise Transac
-000183a0: 7469 6f6e 4572 726f 7228 0a20 2020 2020  tionError(.     
-000183b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183c0: 2020 2020 2020 2020 2020 2066 2252 6571             f"Req
-000183d0: 7565 7374 6564 2075 6e77 7261 7020 6f66  uested unwrap of
-000183e0: 206d 696e 2e20 7b5f 616d 6f75 6e74 5f69   min. {_amount_i
-000183f0: 6e7d 2057 4554 482c 2072 6563 6569 7665  n} WETH, receive
-00018400: 6420 7b77 7261 7070 6564 5f74 6f6b 656e  d {wrapped_token
-00018410: 5f62 616c 616e 6365 7d22 0a20 2020 2020  _balance}".     
-00018420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018430: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018450: 2020 7365 6c66 2e5f 7369 6d75 6c61 7465    self._simulate
-00018460: 5f75 6e77 7261 7028 7772 6170 7065 645f  _unwrap(wrapped_
-00018470: 746f 6b65 6e5f 6164 6472 6573 7329 0a0a  token_address)..
-00018480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018490: 2020 2020 6361 7365 2022 7377 6565 7054      case "sweepT
-000184a0: 6f6b 656e 223a 0a20 2020 2020 2020 2020  oken":.         
-000184b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000184c0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-000184d0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
-000184e0: 6675 6e63 7469 6f6e 2074 7261 6e73 6665  function transfe
-000184f0: 7273 2074 6865 2063 7572 7265 6e74 2074  rs the current t
-00018500: 6f6b 656e 2062 616c 616e 6365 0a20 2020  oken balance.   
-00018510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018520: 2020 2020 2068 656c 6420 6279 2074 6865       held by the
-00018530: 2063 6f6e 7472 6163 7420 746f 2060 7265   contract to `re
-00018540: 6369 7069 656e 7460 0a20 2020 2020 2020  cipient`.       
-00018550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018560: 2022 2222 0a0a 2020 2020 2020 2020 2020   """..          
-00018570: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00018580: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00018590: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000185a0: 785f 746f 6b65 6e5f 6164 6472 6573 7320  x_token_address 
-000185b0: 3d20 6675 6e63 5f70 6172 616d 735b 2274  = func_params["t
-000185c0: 6f6b 656e 225d 0a20 2020 2020 2020 2020  oken"].         
-000185d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185e0: 2020 2074 785f 616d 6f75 6e74 5f6f 7574     tx_amount_out
-000185f0: 5f6d 696e 696d 756d 203d 2066 756e 635f  _minimum = func_
-00018600: 7061 7261 6d73 5b22 616d 6f75 6e74 4d69  params["amountMi
-00018610: 6e69 6d75 6d22 5d0a 2020 2020 2020 2020  nimum"].        
+00018100: 6966 205f 6261 6c61 6e63 6520 3c20 7478  if _balance < tx
+00018110: 5f61 6d6f 756e 745f 6f75 745f 6d69 6e69  _amount_out_mini
+00018120: 6d75 6d3a 0a20 2020 2020 2020 2020 2020  mum:.           
+00018130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018140: 2072 6169 7365 2054 7261 6e73 6163 7469   raise Transacti
+00018150: 6f6e 4572 726f 7228 0a20 2020 2020 2020  onError(.       
+00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018170: 2020 2020 2020 2020 2066 2252 6571 7565           f"Reque
+00018180: 7374 6564 2073 7765 6570 206f 6620 6d69  sted sweep of mi
+00018190: 6e2e 207b 7478 5f61 6d6f 756e 745f 6f75  n. {tx_amount_ou
+000181a0: 745f 6d69 6e69 6d75 6d7d 207b 7478 5f74  t_minimum} {tx_t
+000181b0: 6f6b 656e 5f61 6464 7265 7373 7d2c 2072  oken_address}, r
+000181c0: 6563 6569 7665 6420 7b5f 6261 6c61 6e63  eceived {_balanc
+000181d0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
+000181e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181f0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00018200: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00018210: 5f73 696d 756c 6174 655f 7377 6565 7028  _simulate_sweep(
+00018220: 7478 5f74 6f6b 656e 5f61 6464 7265 7373  tx_token_address
+00018230: 2c20 7478 5f72 6563 6970 6965 6e74 290a  , tx_recipient).
+00018240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018250: 2020 2020 2063 6173 6520 2277 7261 7045       case "wrapE
+00018260: 5448 223a 0a20 2020 2020 2020 2020 2020  TH":.           
+00018270: 2020 2020 2020 2020 2020 2020 205f 7772               _wr
+00018280: 6170 7065 645f 746f 6b65 6e5f 616d 6f75  apped_token_amou
+00018290: 6e74 203d 2066 756e 635f 7061 7261 6d73  nt = func_params
+000182a0: 5b22 7661 6c75 6522 5d0a 2020 2020 2020  ["value"].      
+000182b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182c0: 2020 5f77 7261 7070 6564 5f74 6f6b 656e    _wrapped_token
+000182d0: 5f61 6464 7265 7373 203d 2057 5241 5050  _address = WRAPP
+000182e0: 4544 5f4e 4154 4956 455f 544f 4b45 4e53  ED_NATIVE_TOKENS
+000182f0: 5b73 656c 662e 6368 6169 6e5f 6964 5d0a  [self.chain_id].
+00018300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018310: 2020 2020 2020 2020 7365 6c66 2e6c 6564          self.led
+00018320: 6765 722e 6164 6a75 7374 280a 2020 2020  ger.adjust(.    
+00018330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018340: 2020 2020 2020 2020 7365 6c66 2e72 6f75          self.rou
+00018350: 7465 725f 6164 6472 6573 732c 0a20 2020  ter_address,.   
+00018360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018370: 2020 2020 2020 2020 205f 7772 6170 7065           _wrappe
+00018380: 645f 746f 6b65 6e5f 6164 6472 6573 732c  d_token_address,
+00018390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000183a0: 2020 2020 2020 2020 2020 2020 205f 7772               _wr
+000183b0: 6170 7065 645f 746f 6b65 6e5f 616d 6f75  apped_token_amou
+000183c0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+000183d0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000183e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183f0: 2020 2063 6173 6520 2269 6e63 7265 6173     case "increas
+00018400: 654c 6971 7569 6469 7479 223a 0a20 2020  eLiquidity":.   
+00018410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018420: 2020 2020 2069 6d70 6f72 7420 6a73 6f6e       import json
+00018430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018440: 2020 2020 2020 2020 2066 726f 6d20 6465           from de
+00018450: 6765 6e62 6f74 2e75 6e69 7377 6170 2e76  genbot.uniswap.v
+00018460: 335f 6c69 6272 6172 6965 7320 696d 706f  3_libraries impo
+00018470: 7274 2046 756c 6c4d 6174 682c 2054 6963  rt FullMath, Tic
+00018480: 6b4d 6174 682c 2063 6f6e 7374 616e 7473  kMath, constants
+00018490: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000184a0: 2020 2020 2020 2020 2020 6465 6620 6765            def ge
+000184b0: 744c 6971 7569 6469 7479 466f 7241 6d6f  tLiquidityForAmo
+000184c0: 756e 7430 280a 2020 2020 2020 2020 2020  unt0(.          
+000184d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184e0: 2020 7371 7274 5261 7469 6f41 5839 363a    sqrtRatioAX96:
+000184f0: 2069 6e74 2c20 7371 7274 5261 7469 6f42   int, sqrtRatioB
+00018500: 5839 363a 2069 6e74 2c20 616d 6f75 6e74  X96: int, amount
+00018510: 303a 2069 6e74 0a20 2020 2020 2020 2020  0: int.         
+00018520: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00018530: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+00018540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018550: 2020 2020 2069 6620 7371 7274 5261 7469       if sqrtRati
+00018560: 6f41 5839 3620 3e20 7371 7274 5261 7469  oAX96 > sqrtRati
+00018570: 6f42 5839 363a 0a20 2020 2020 2020 2020  oBX96:.         
+00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018590: 2020 2020 2020 2028 7371 7274 5261 7469         (sqrtRati
+000185a0: 6f41 5839 362c 2073 7172 7452 6174 696f  oAX96, sqrtRatio
+000185b0: 4258 3936 2920 3d20 2873 7172 7452 6174  BX96) = (sqrtRat
+000185c0: 696f 4258 3936 2c20 7371 7274 5261 7469  ioBX96, sqrtRati
+000185d0: 6f41 5839 3629 0a20 2020 2020 2020 2020  oAX96).         
+000185e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185f0: 2020 2069 6e74 6572 6d65 6469 6174 6520     intermediate 
+00018600: 3d20 4675 6c6c 4d61 7468 2e6d 756c 4469  = FullMath.mulDi
+00018610: 7628 0a20 2020 2020 2020 2020 2020 2020  v(.             
 00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018630: 2020 2020 7478 5f72 6563 6970 6965 6e74      tx_recipient
-00018640: 203d 2066 756e 635f 7061 7261 6d73 2e67   = func_params.g
-00018650: 6574 2822 7265 6369 7069 656e 7422 290a  et("recipient").
+00018630: 2020 2073 7172 7452 6174 696f 4158 3936     sqrtRatioAX96
+00018640: 2c20 7371 7274 5261 7469 6f42 5839 362c  , sqrtRatioBX96,
+00018650: 2063 6f6e 7374 616e 7473 2e51 3936 0a20   constants.Q96. 
 00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018670: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00018680: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00018690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000186b0: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-000186c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000186d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000186e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000186f0: 526f 7574 6572 3220 4142 4920 6f6d 6974  Router2 ABI omit
-00018700: 7320 6072 6563 6970 6965 6e74 602c 2061  s `recipient`, a
-00018710: 6c77 6179 7320 7573 6573 0a20 2020 2020  lways uses.     
-00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018730: 2020 2020 2020 2023 2060 6d73 672e 7365         # `msg.se
-00018740: 6e64 6572 600a 2020 2020 2020 2020 2020  nder`.          
-00018750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018760: 2020 6966 2074 785f 7265 6369 7069 656e    if tx_recipien
-00018770: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
-00018780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018790: 2020 2020 2020 2020 2020 2074 785f 7265             tx_re
-000187a0: 6369 7069 656e 7420 3d20 7365 6c66 2e73  cipient = self.s
-000187b0: 656e 6465 720a 2020 2020 2020 2020 2020  ender.          
-000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000187e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187f0: 2020 2020 2020 2020 7365 6c66 2e72 6563          self.rec
-00018800: 6970 6965 6e74 732e 6164 6428 7478 5f72  ipients.add(tx_r
-00018810: 6563 6970 6965 6e74 290a 0a20 2020 2020  ecipient)..     
-00018820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018830: 2020 205f 6261 6c61 6e63 6520 3d20 7365     _balance = se
-00018840: 6c66 2e6c 6564 6765 722e 746f 6b65 6e5f  lf.ledger.token_
-00018850: 6261 6c61 6e63 6528 7365 6c66 2e72 6f75  balance(self.rou
-00018860: 7465 725f 6164 6472 6573 732c 2074 785f  ter_address, tx_
-00018870: 746f 6b65 6e5f 6164 6472 6573 7329 0a0a  token_address)..
-00018880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018890: 2020 2020 2020 2020 6966 205f 6261 6c61          if _bala
-000188a0: 6e63 6520 3c20 7478 5f61 6d6f 756e 745f  nce < tx_amount_
-000188b0: 6f75 745f 6d69 6e69 6d75 6d3a 0a20 2020  out_minimum:.   
-000188c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188d0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-000188e0: 7261 6e73 6163 7469 6f6e 4572 726f 7228  ransactionError(
-000188f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018670: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018690: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000186a0: 4675 6c6c 4d61 7468 2e6d 756c 4469 7628  FullMath.mulDiv(
+000186b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000186c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186d0: 2061 6d6f 756e 7430 2c20 696e 7465 726d   amount0, interm
+000186e0: 6564 6961 7465 2c20 7371 7274 5261 7469  ediate, sqrtRati
+000186f0: 6f42 5839 3620 2d20 7371 7274 5261 7469  oBX96 - sqrtRati
+00018700: 6f41 5839 360a 2020 2020 2020 2020 2020  oAX96.          
+00018710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018720: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00018730: 2020 2020 2020 2020 2020 2020 2064 6566               def
+00018740: 2067 6574 4c69 7175 6964 6974 7946 6f72   getLiquidityFor
+00018750: 416d 6f75 6e74 3128 0a20 2020 2020 2020  Amount1(.       
+00018760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018770: 2020 2020 2073 7172 7452 6174 696f 4158       sqrtRatioAX
+00018780: 3936 3a20 696e 742c 2073 7172 7452 6174  96: int, sqrtRat
+00018790: 696f 4258 3936 3a20 696e 742c 2061 6d6f  ioBX96: int, amo
+000187a0: 756e 7431 3a20 696e 740a 2020 2020 2020  unt1: int.      
+000187b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187c0: 2020 2920 2d3e 2069 6e74 3a0a 2020 2020    ) -> int:.    
+000187d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187e0: 2020 2020 2020 2020 6966 2073 7172 7452          if sqrtR
+000187f0: 6174 696f 4158 3936 203e 2073 7172 7452  atioAX96 > sqrtR
+00018800: 6174 696f 4258 3936 3a0a 2020 2020 2020  atioBX96:.      
+00018810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018820: 2020 2020 2020 2020 2020 2873 7172 7452            (sqrtR
+00018830: 6174 696f 4158 3936 2c20 7371 7274 5261  atioAX96, sqrtRa
+00018840: 7469 6f42 5839 3629 203d 2028 7371 7274  tioBX96) = (sqrt
+00018850: 5261 7469 6f42 5839 362c 2073 7172 7452  RatioBX96, sqrtR
+00018860: 6174 696f 4158 3936 290a 2020 2020 2020  atioAX96).      
+00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018880: 2020 2020 2020 7265 7475 726e 2046 756c        return Ful
+00018890: 6c4d 6174 682e 6d75 6c44 6976 280a 2020  lMath.mulDiv(.  
+000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188b0: 2020 2020 2020 2020 2020 2020 2020 616d                am
+000188c0: 6f75 6e74 312c 2063 6f6e 7374 616e 7473  ount1, constants
+000188d0: 2e51 3936 2c20 7371 7274 5261 7469 6f42  .Q96, sqrtRatioB
+000188e0: 5839 3620 2d20 7371 7274 5261 7469 6f41  X96 - sqrtRatioA
+000188f0: 5839 360a 2020 2020 2020 2020 2020 2020  X96.            
 00018900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018910: 2066 2252 6571 7565 7374 6564 2073 7765   f"Requested swe
-00018920: 6570 206f 6620 6d69 6e2e 207b 7478 5f61  ep of min. {tx_a
-00018930: 6d6f 756e 745f 6f75 745f 6d69 6e69 6d75  mount_out_minimu
-00018940: 6d7d 207b 7478 5f74 6f6b 656e 5f61 6464  m} {tx_token_add
-00018950: 7265 7373 7d2c 2072 6563 6569 7665 6420  ress}, received 
-00018960: 7b5f 6261 6c61 6e63 657d 220a 2020 2020  {_balance}".    
-00018970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018980: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00018990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189a0: 2020 2073 656c 662e 5f73 696d 756c 6174     self._simulat
-000189b0: 655f 7377 6565 7028 7478 5f74 6f6b 656e  e_sweep(tx_token
-000189c0: 5f61 6464 7265 7373 2c20 7478 5f72 6563  _address, tx_rec
-000189d0: 6970 6965 6e74 290a 0a20 2020 2020 2020  ipient)..       
-000189e0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-000189f0: 6520 2277 7261 7045 5448 223a 0a20 2020  e "wrapETH":.   
+00018910: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00018920: 2020 2020 2020 2020 2020 2064 6566 2067             def g
+00018930: 6574 4c69 7175 6964 6974 7946 6f72 416d  etLiquidityForAm
+00018940: 6f75 6e74 7328 0a20 2020 2020 2020 2020  ounts(.         
+00018950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018960: 2020 2073 7172 7452 6174 696f 5839 363a     sqrtRatioX96:
+00018970: 2069 6e74 2c0a 2020 2020 2020 2020 2020   int,.          
+00018980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018990: 2020 7371 7274 5261 7469 6f41 5839 363a    sqrtRatioAX96:
+000189a0: 2069 6e74 2c0a 2020 2020 2020 2020 2020   int,.          
+000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189c0: 2020 7371 7274 5261 7469 6f42 5839 363a    sqrtRatioBX96:
+000189d0: 2069 6e74 2c0a 2020 2020 2020 2020 2020   int,.          
+000189e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189f0: 2020 616d 6f75 6e74 303a 2069 6e74 2c0a    amount0: int,.
 00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a10: 2020 2020 2070 7269 6e74 2866 2250 726f       print(f"Pro
-00018a20: 6365 7373 696e 6720 7b66 756e 635f 6e61  cessing {func_na
-00018a30: 6d65 7d22 290a 2020 2020 2020 2020 2020  me}").          
-00018a40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00018a50: 696e 7428 6622 7b73 656c 662e 6861 7368  int(f"{self.hash
-00018a60: 2e68 6578 2829 3d7d 2229 0a20 2020 2020  .hex()=}").     
-00018a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a80: 2020 205f 7772 6170 7065 645f 746f 6b65     _wrapped_toke
-00018a90: 6e5f 616d 6f75 6e74 203d 2066 756e 635f  n_amount = func_
-00018aa0: 7061 7261 6d73 5b22 7661 6c75 6522 5d0a  params["value"].
-00018ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ac0: 2020 2020 2020 2020 5f77 7261 7070 6564          _wrapped
-00018ad0: 5f74 6f6b 656e 5f61 6464 7265 7373 203d  _token_address =
-00018ae0: 2057 5241 5050 4544 5f4e 4154 4956 455f   WRAPPED_NATIVE_
-00018af0: 544f 4b45 4e53 5b73 656c 662e 6368 6169  TOKENS[self.chai
-00018b00: 6e5f 6964 5d0a 2020 2020 2020 2020 2020  n_id].          
-00018b10: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018b20: 6c66 2e6c 6564 6765 722e 6164 6a75 7374  lf.ledger.adjust
-00018b30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018b40: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018b50: 6c66 2e72 6f75 7465 725f 6164 6472 6573  lf.router_addres
-00018b60: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00018b70: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00018b80: 7772 6170 7065 645f 746f 6b65 6e5f 6164  wrapped_token_ad
-00018b90: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
-00018ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bb0: 2020 205f 7772 6170 7065 645f 746f 6b65     _wrapped_toke
-00018bc0: 6e5f 616d 6f75 6e74 2c0a 2020 2020 2020  n_amount,.      
-00018bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018be0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00018bf0: 2023 2043 6174 6368 2061 6e64 2072 652d   # Catch and re-
-00018c00: 7261 6973 6520 7769 7468 6f75 7420 7370  raise without sp
-00018c10: 6563 6961 6c20 6861 6e64 6c69 6e67 2e20  ecial handling. 
-00018c20: 5468 6573 6520 6172 6520 7261 6973 6564  These are raised
-00018c30: 2062 7920 7468 6973 2063 6c61 7373 2c20   by this class, 
-00018c40: 736f 2073 686f 7274 2d63 6972 6375 6974  so short-circuit
-00018c50: 2069 6620 6f6e 6520 6861 7320 6275 6262   if one has bubb
-00018c60: 6c65 6420 7570 2e0a 2020 2020 2020 2020  led up..        
-00018c70: 2020 2020 2320 5468 6973 2070 7265 7665      # This preve
-00018c80: 6e74 7320 6e65 7374 6564 206d 756c 7469  nts nested multi
-00018c90: 6361 6c6c 7320 6672 6f6d 2061 6464 696e  calls from addin
-00018ca0: 6720 7265 6475 6e64 616e 7420 7374 7269  g redundant stri
-00018cb0: 6e67 7320 746f 2065 7863 6570 7469 6f6e  ngs to exception
-00018cc0: 206d 6573 7361 6765 2e0a 2020 2020 2020   message..      
-00018cd0: 2020 2020 2020 2320 652e 672e 2027 5369        # e.g. 'Si
-00018ce0: 6d75 6c61 7469 6f6e 2066 6169 6c65 643a  mulation failed:
-00018cf0: 2053 696d 756c 6174 696f 6e20 6661 696c   Simulation fail
-00018d00: 6564 3a20 5369 6d75 6c61 7469 6f6e 2066  ed: Simulation f
-00018d10: 6169 6c65 643a 2053 696d 756c 6174 696f  ailed: Simulatio
-00018d20: 6e20 6661 696c 6564 3a20 7b65 7272 6f72  n failed: {error
-00018d30: 7d27 0a20 2020 2020 2020 2020 2020 2065  }'.            e
-00018d40: 7863 6570 7420 5472 616e 7361 6374 696f  xcept Transactio
-00018d50: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
-00018d60: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
-00018d70: 2020 2020 2020 2020 2020 2320 4361 7463            # Catc
-00018d80: 6820 6572 726f 7273 2066 726f 6d20 706f  h errors from po
-00018d90: 6f6c 2068 656c 7065 7220 7369 6d75 6c61  ol helper simula
-00018da0: 7469 6f6e 2061 7474 656d 7074 730a 2020  tion attempts.  
-00018db0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00018dc0: 2044 6567 656e 626f 7445 7272 6f72 2061   DegenbotError a
-00018dd0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00018de0: 2020 2020 2072 6169 7365 2054 7261 6e73       raise Trans
-00018df0: 6163 7469 6f6e 4572 726f 7228 6622 5369  actionError(f"Si
-00018e00: 6d75 6c61 7469 6f6e 2066 6169 6c65 643a  mulation failed:
-00018e10: 207b 657d 2229 2066 726f 6d20 650a 2020   {e}") from e.  
-00018e20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00018e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e40: 7265 7475 726e 205f 7633 5f72 6f75 7465  return _v3_route
-00018e50: 725f 6675 7475 7265 5f70 6f6f 6c5f 7374  r_future_pool_st
-00018e60: 6174 6573 0a0a 2020 2020 2020 2020 6465  ates..        de
-00018e70: 6620 5f70 726f 6365 7373 5f75 6e69 7377  f _process_unisw
-00018e80: 6170 5f75 6e69 7665 7273 616c 5f72 6f75  ap_universal_rou
-00018e90: 7465 725f 7472 616e 7361 6374 696f 6e28  ter_transaction(
-00018ea0: 2920 2d3e 2028 0a20 2020 2020 2020 2020  ) -> (.         
-00018eb0: 2020 204c 6973 745b 0a20 2020 2020 2020     List[.       
-00018ec0: 2020 2020 2020 2020 2054 7570 6c65 5b4c           Tuple[L
-00018ed0: 6971 7569 6469 7479 506f 6f6c 2c20 556e  iquidityPool, Un
-00018ee0: 6973 7761 7056 3250 6f6f 6c53 696d 756c  iswapV2PoolSimul
-00018ef0: 6174 696f 6e52 6573 756c 745d 0a20 2020  ationResult].   
-00018f00: 2020 2020 2020 2020 2020 2020 207c 2054               | T
-00018f10: 7570 6c65 5b56 334c 6971 7569 6469 7479  uple[V3Liquidity
-00018f20: 506f 6f6c 2c20 556e 6973 7761 7056 3350  Pool, UniswapV3P
-00018f30: 6f6f 6c53 696d 756c 6174 696f 6e52 6573  oolSimulationRes
-00018f40: 756c 745d 0a20 2020 2020 2020 2020 2020  ult].           
-00018f50: 205d 0a20 2020 2020 2020 2029 3a0a 2020   ].        ):.  
-00018f60: 2020 2020 2020 2020 2020 5f75 6e69 7665            _unive
-00018f70: 7273 616c 5f72 6f75 7465 725f 6675 7475  rsal_router_futu
-00018f80: 7265 5f70 6f6f 6c5f 7374 6174 6573 3a20  re_pool_states: 
-00018f90: 4c69 7374 5b0a 2020 2020 2020 2020 2020  List[.          
-00018fa0: 2020 2020 2020 5475 706c 655b 4c69 7175        Tuple[Liqu
-00018fb0: 6964 6974 7950 6f6f 6c2c 2055 6e69 7377  idityPool, Unisw
-00018fc0: 6170 5632 506f 6f6c 5369 6d75 6c61 7469  apV2PoolSimulati
-00018fd0: 6f6e 5265 7375 6c74 5d0a 2020 2020 2020  onResult].      
-00018fe0: 2020 2020 2020 2020 2020 7c20 5475 706c            | Tupl
-00018ff0: 655b 5633 4c69 7175 6964 6974 7950 6f6f  e[V3LiquidityPoo
-00019000: 6c2c 2055 6e69 7377 6170 5633 506f 6f6c  l, UniswapV3Pool
-00019010: 5369 6d75 6c61 7469 6f6e 5265 7375 6c74  SimulationResult
-00019020: 5d0a 2020 2020 2020 2020 2020 2020 5d20  ].            ] 
-00019030: 3d20 5b5d 0a0a 2020 2020 2020 2020 2020  = []..          
-00019040: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00019050: 227b 6675 6e63 5f6e 616d 657d 3a20 7b73  "{func_name}: {s
-00019060: 656c 662e 6861 7368 2e68 6578 2829 3d7d  elf.hash.hex()=}
-00019070: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00019080: 6966 2066 756e 635f 6e61 6d65 2021 3d20  if func_name != 
-00019090: 2265 7865 6375 7465 223a 0a20 2020 2020  "execute":.     
-000190a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000190b0: 2056 616c 7565 4572 726f 7228 6622 554e   ValueError(f"UN
-000190c0: 4841 4e44 4c45 4420 554e 4956 4552 5341  HANDLED UNIVERSA
-000190d0: 4c20 524f 5554 4552 2046 554e 4354 494f  L ROUTER FUNCTIO
-000190e0: 4e3a 207b 6675 6e63 5f6e 616d 657d 2229  N: {func_name}")
-000190f0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
-00019100: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00019110: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00019120: 2020 2020 2020 2020 2020 2020 7478 5f64              tx_d
-00019130: 6561 646c 696e 6520 3d20 6675 6e63 5f70  eadline = func_p
-00019140: 6172 616d 735b 2264 6561 646c 696e 6522  arams["deadline"
-00019150: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00019160: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00019170: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00019180: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00019190: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000191a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000191b0: 2020 2020 2020 7365 6c66 2e5f 7261 6973        self._rais
-000191c0: 655f 6966 5f65 7870 6972 6564 2874 785f  e_if_expired(tx_
-000191d0: 6465 6164 6c69 6e65 290a 0a20 2020 2020  deadline)..     
-000191e0: 2020 2020 2020 2020 2020 2074 785f 636f             tx_co
-000191f0: 6d6d 616e 6473 203d 2066 756e 635f 7061  mmands = func_pa
-00019200: 7261 6d73 5b22 636f 6d6d 616e 6473 225d  rams["commands"]
-00019210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019220: 2074 785f 696e 7075 7473 203d 2066 756e   tx_inputs = fun
-00019230: 635f 7061 7261 6d73 5b22 696e 7075 7473  c_params["inputs
-00019240: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
-00019250: 2020 2020 666f 7220 636f 6d6d 616e 642c      for command,
-00019260: 2069 6e70 7574 2069 6e20 7a69 7028 7478   input in zip(tx
-00019270: 5f63 6f6d 6d61 6e64 732c 2074 785f 696e  _commands, tx_in
-00019280: 7075 7473 293a 0a20 2020 2020 2020 2020  puts):.         
-00019290: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-000192a0: 7420 3d20 5f70 726f 6365 7373 5f75 6e69  t = _process_uni
-000192b0: 7665 7273 616c 5f72 6f75 7465 725f 636f  versal_router_co
-000192c0: 6d6d 616e 6428 0a20 2020 2020 2020 2020  mmand(.         
-000192d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000192e0: 6f6d 6d61 6e64 2c0a 2020 2020 2020 2020  ommand,.        
-000192f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019300: 696e 7075 742c 0a20 2020 2020 2020 2020  input,.         
-00019310: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00019320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019330: 2069 6620 7265 7375 6c74 3a0a 2020 2020   if result:.    
+00018a10: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
+00018a20: 6e74 313a 2069 6e74 2c0a 2020 2020 2020  nt1: int,.      
+00018a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a40: 2020 2920 2d3e 2069 6e74 3a0a 2020 2020    ) -> int:.    
+00018a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a60: 2020 2020 2020 2020 6966 2073 7172 7452          if sqrtR
+00018a70: 6174 696f 4158 3936 203e 2073 7172 7452  atioAX96 > sqrtR
+00018a80: 6174 696f 4258 3936 3a0a 2020 2020 2020  atioBX96:.      
+00018a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018aa0: 2020 2020 2020 2020 2020 2873 7172 7452            (sqrtR
+00018ab0: 6174 696f 4158 3936 2c20 7371 7274 5261  atioAX96, sqrtRa
+00018ac0: 7469 6f42 5839 3629 203d 2028 7371 7274  tioBX96) = (sqrt
+00018ad0: 5261 7469 6f42 5839 362c 2073 7172 7452  RatioBX96, sqrtR
+00018ae0: 6174 696f 4158 3936 290a 0a20 2020 2020  atioAX96)..     
+00018af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b00: 2020 2020 2020 2069 6620 7371 7274 5261         if sqrtRa
+00018b10: 7469 6f58 3936 203c 3d20 7371 7274 5261  tioX96 <= sqrtRa
+00018b20: 7469 6f41 5839 363a 0a20 2020 2020 2020  tioAX96:.       
+00018b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b40: 2020 2020 2020 2020 206c 6971 7569 6469           liquidi
+00018b50: 7479 203d 2067 6574 4c69 7175 6964 6974  ty = getLiquidit
+00018b60: 7946 6f72 416d 6f75 6e74 3028 0a20 2020  yForAmount0(.   
+00018b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b90: 2073 7172 7452 6174 696f 4158 3936 2c20   sqrtRatioAX96, 
+00018ba0: 7371 7274 5261 7469 6f42 5839 362c 2061  sqrtRatioBX96, a
+00018bb0: 6d6f 756e 7430 0a20 2020 2020 2020 2020  mount0.         
+00018bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bf0: 2020 2020 2065 6c69 6620 7371 7274 5261       elif sqrtRa
+00018c00: 7469 6f58 3936 203c 2073 7172 7452 6174  tioX96 < sqrtRat
+00018c10: 696f 4258 3936 3a0a 2020 2020 2020 2020  ioBX96:.        
+00018c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c30: 2020 2020 2020 2020 6c69 7175 6964 6974          liquidit
+00018c40: 7930 203d 2067 6574 4c69 7175 6964 6974  y0 = getLiquidit
+00018c50: 7946 6f72 416d 6f75 6e74 3028 0a20 2020  yForAmount0(.   
+00018c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c80: 2073 7172 7452 6174 696f 5839 362c 2073   sqrtRatioX96, s
+00018c90: 7172 7452 6174 696f 4258 3936 2c20 616d  qrtRatioBX96, am
+00018ca0: 6f75 6e74 300a 2020 2020 2020 2020 2020  ount0.          
+00018cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018cc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00018cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ce0: 2020 2020 2020 2020 6c69 7175 6964 6974          liquidit
+00018cf0: 7931 203d 2067 6574 4c69 7175 6964 6974  y1 = getLiquidit
+00018d00: 7946 6f72 416d 6f75 6e74 3128 0a20 2020  yForAmount1(.   
+00018d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d30: 2073 7172 7452 6174 696f 4158 3936 2c20   sqrtRatioAX96, 
+00018d40: 7371 7274 5261 7469 6f58 3936 2c20 616d  sqrtRatioX96, am
+00018d50: 6f75 6e74 310a 2020 2020 2020 2020 2020  ount1.          
+00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d70: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00018d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d90: 2020 2020 2020 2020 206c 6971 7569 6469           liquidi
+00018da0: 7479 203d 206c 6971 7569 6469 7479 3020  ty = liquidity0 
+00018db0: 6966 206c 6971 7569 6469 7479 3020 3c20  if liquidity0 < 
+00018dc0: 6c69 7175 6964 6974 7931 2065 6c73 6520  liquidity1 else 
+00018dd0: 6c69 7175 6964 6974 7931 0a20 2020 2020  liquidity1.     
+00018de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018df0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00018e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e10: 2020 2020 2020 2020 2020 2020 206c 6971               liq
+00018e20: 7569 6469 7479 203d 2067 6574 4c69 7175  uidity = getLiqu
+00018e30: 6964 6974 7946 6f72 416d 6f75 6e74 3128  idityForAmount1(
+00018e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e60: 2020 2020 2073 7172 7452 6174 696f 4158       sqrtRatioAX
+00018e70: 3936 2c20 7371 7274 5261 7469 6f42 5839  96, sqrtRatioBX9
+00018e80: 362c 2061 6d6f 756e 7431 0a20 2020 2020  6, amount1.     
+00018e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ea0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ec0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00018ed0: 206c 6971 7569 6469 7479 0a0a 2020 2020   liquidity..    
+00018ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ef0: 2020 2020 2320 7374 7275 6374 2049 6e63      # struct Inc
+00018f00: 7265 6173 654c 6971 7569 6469 7479 5061  reaseLiquidityPa
+00018f10: 7261 6d73 207b 0a20 2020 2020 2020 2020  rams {.         
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018f30: 2020 2020 2061 6464 7265 7373 2074 6f6b       address tok
+00018f40: 656e 303b 0a20 2020 2020 2020 2020 2020  en0;.           
+00018f50: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00018f60: 2020 2061 6464 7265 7373 2074 6f6b 656e     address token
+00018f70: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+00018f80: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00018f90: 2075 696e 7432 3536 2074 6f6b 656e 4964   uint256 tokenId
+00018fa0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00018fb0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00018fc0: 7569 6e74 3235 3620 616d 6f75 6e74 304d  uint256 amount0M
+00018fd0: 696e 3b0a 2020 2020 2020 2020 2020 2020  in;.            
+00018fe0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00018ff0: 2020 7569 6e74 3235 3620 616d 6f75 6e74    uint256 amount
+00019000: 314d 696e 3b0a 2020 2020 2020 2020 2020  1Min;.          
+00019010: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019020: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00019030: 2020 2020 2020 2020 2020 2023 2044 6563             # Dec
+00019040: 6f64 6520 696e 7075 7473 0a0a 2020 2020  ode inputs..    
+00019050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019060: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00019070: 6622 7b66 756e 635f 7061 7261 6d73 3d7d  f"{func_params=}
+00019080: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+00019090: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
+000190a0: 6e30 203d 2066 756e 635f 7061 7261 6d73  n0 = func_params
+000190b0: 5b22 7061 7261 6d73 225d 5b22 746f 6b65  ["params"]["toke
+000190c0: 6e30 225d 0a20 2020 2020 2020 2020 2020  n0"].           
+000190d0: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+000190e0: 656e 3120 3d20 6675 6e63 5f70 6172 616d  en1 = func_param
+000190f0: 735b 2270 6172 616d 7322 5d5b 2274 6f6b  s["params"]["tok
+00019100: 656e 3122 5d0a 2020 2020 2020 2020 2020  en1"].          
+00019110: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00019120: 6b65 6e5f 6964 203d 2066 756e 635f 7061  ken_id = func_pa
+00019130: 7261 6d73 5b22 7061 7261 6d73 225d 5b22  rams["params"]["
+00019140: 746f 6b65 6e49 6422 5d0a 2020 2020 2020  tokenId"].      
+00019150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019160: 2020 616d 6f75 6e74 305f 6d69 6e20 3d20    amount0_min = 
+00019170: 6675 6e63 5f70 6172 616d 735b 2270 6172  func_params["par
+00019180: 616d 7322 5d5b 2261 6d6f 756e 7430 4d69  ams"]["amount0Mi
+00019190: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
+000191a0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
+000191b0: 6e74 305f 6465 7369 7265 6420 3d20 7365  nt0_desired = se
+000191c0: 6c66 2e6c 6564 6765 722e 746f 6b65 6e5f  lf.ledger.token_
+000191d0: 6261 6c61 6e63 6528 7365 6c66 2e72 6f75  balance(self.rou
+000191e0: 7465 725f 6164 6472 6573 732c 2074 6f6b  ter_address, tok
+000191f0: 656e 3029 0a20 2020 2020 2020 2020 2020  en0).           
+00019200: 2020 2020 2020 2020 2020 2020 2061 6d6f               amo
+00019210: 756e 7431 5f6d 696e 203d 2066 756e 635f  unt1_min = func_
+00019220: 7061 7261 6d73 5b22 7061 7261 6d73 225d  params["params"]
+00019230: 5b22 616d 6f75 6e74 314d 696e 225d 0a20  ["amount1Min"]. 
+00019240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019250: 2020 2020 2020 2061 6d6f 756e 7431 5f64         amount1_d
+00019260: 6573 6972 6564 203d 2073 656c 662e 6c65  esired = self.le
+00019270: 6467 6572 2e74 6f6b 656e 5f62 616c 616e  dger.token_balan
+00019280: 6365 2873 656c 662e 726f 7574 6572 5f61  ce(self.router_a
+00019290: 6464 7265 7373 2c20 746f 6b65 6e31 290a  ddress, token1).
+000192a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000192b0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+000192c0: 696e 666f 2866 227b 746f 6b65 6e30 3d7d  info(f"{token0=}
+000192d0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+000192e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000192f0: 722e 696e 666f 2866 227b 746f 6b65 6e31  r.info(f"{token1
+00019300: 3d7d 2229 0a20 2020 2020 2020 2020 2020  =}").           
+00019310: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00019320: 6765 722e 696e 666f 2866 227b 746f 6b65  ger.info(f"{toke
+00019330: 6e5f 6964 3d7d 2229 0a20 2020 2020 2020  n_id=}").       
 00019340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019350: 2020 2020 5f75 6e69 7665 7273 616c 5f72      _universal_r
-00019360: 6f75 7465 725f 6675 7475 7265 5f70 6f6f  outer_future_poo
-00019370: 6c5f 7374 6174 6573 2e65 7874 656e 6428  l_states.extend(
-00019380: 7265 7375 6c74 290a 0a20 2020 2020 2020  result)..       
-00019390: 2020 2020 2023 2062 7567 6669 783a 2070       # bugfix: p
-000193a0: 7265 7665 6e74 7320 6e65 7374 6564 206d  revents nested m
-000193b0: 756c 7469 6361 6c6c 7320 6672 6f6d 2073  ulticalls from s
-000193c0: 7061 6d6d 696e 6720 6578 6365 7074 696f  pamming exceptio
-000193d0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
-000193e0: 6d65 7373 6167 652e 0a20 2020 2020 2020  message..       
-000193f0: 2020 2020 2023 2065 2e67 2e20 2753 696d       # e.g. 'Sim
-00019400: 756c 6174 696f 6e20 6661 696c 6564 3a20  ulation failed: 
-00019410: 5369 6d75 6c61 7469 6f6e 2066 6169 6c65  Simulation faile
-00019420: 643a 207b 6572 726f 727d 270a 2020 2020  d: {error}'.    
-00019430: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-00019440: 7261 6e73 6163 7469 6f6e 4572 726f 723a  ransactionError:
-00019450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019460: 2072 6169 7365 0a20 2020 2020 2020 2020   raise.         
-00019470: 2020 2023 2063 6174 6368 2067 656e 6572     # catch gener
-00019480: 6963 2044 6567 656e 626f 7445 7272 6f72  ic DegenbotError
-00019490: 2028 6e6f 6e2d 6661 7461 6c29 2061 6e64   (non-fatal) and
-000194a0: 2072 652d 7261 6973 6520 6173 0a20 2020   re-raise as.   
-000194b0: 2020 2020 2020 2020 2023 2054 7261 6e73           # Trans
-000194c0: 6163 7469 6f6e 4572 726f 720a 2020 2020  actionError.    
-000194d0: 2020 2020 2020 2020 6578 6365 7074 2044          except D
-000194e0: 6567 656e 626f 7445 7272 6f72 2061 7320  egenbotError as 
-000194f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00019500: 2020 2072 6169 7365 2054 7261 6e73 6163     raise Transac
-00019510: 7469 6f6e 4572 726f 7228 6622 5369 6d75  tionError(f"Simu
-00019520: 6c61 7469 6f6e 2066 6169 6c65 643a 207b  lation failed: {
-00019530: 657d 2229 2066 726f 6d20 650a 2020 2020  e}") from e.    
-00019540: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00019550: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00019560: 7475 726e 205f 756e 6976 6572 7361 6c5f  turn _universal_
-00019570: 726f 7574 6572 5f66 7574 7572 655f 706f  router_future_po
-00019580: 6f6c 5f73 7461 7465 730a 0a20 2020 2020  ol_states..     
-00019590: 2020 2069 6620 6675 6e63 5f6e 616d 6520     if func_name 
-000195a0: 696e 2056 325f 4655 4e43 5449 4f4e 533a  in V2_FUNCTIONS:
-000195b0: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
-000195c0: 5f66 7574 7572 655f 706f 6f6c 5f73 7461  _future_pool_sta
-000195d0: 7465 732e 6578 7465 6e64 280a 2020 2020  tes.extend(.    
-000195e0: 2020 2020 2020 2020 2020 2020 5f70 726f              _pro
-000195f0: 6365 7373 5f75 6e69 7377 6170 5f76 325f  cess_uniswap_v2_
-00019600: 7472 616e 7361 6374 696f 6e28 292c 0a20  transaction(),. 
-00019610: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00019620: 2020 2020 2065 6c69 6620 6675 6e63 5f6e       elif func_n
-00019630: 616d 6520 696e 2056 335f 4655 4e43 5449  ame in V3_FUNCTI
-00019640: 4f4e 533a 0a20 2020 2020 2020 2020 2020  ONS:.           
-00019650: 2061 6c6c 5f66 7574 7572 655f 706f 6f6c   all_future_pool
-00019660: 5f73 7461 7465 732e 6578 7465 6e64 280a  _states.extend(.
-00019670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019680: 5f70 726f 6365 7373 5f75 6e69 7377 6170  _process_uniswap
-00019690: 5f76 335f 7472 616e 7361 6374 696f 6e28  _v3_transaction(
-000196a0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-000196b0: 0a20 2020 2020 2020 2065 6c69 6620 6675  .        elif fu
-000196c0: 6e63 5f6e 616d 6520 696e 2055 4e49 5645  nc_name in UNIVE
-000196d0: 5253 414c 5f52 4f55 5445 525f 4655 4e43  RSAL_ROUTER_FUNC
-000196e0: 5449 4f4e 533a 0a20 2020 2020 2020 2020  TIONS:.         
-000196f0: 2020 2061 6c6c 5f66 7574 7572 655f 706f     all_future_po
-00019700: 6f6c 5f73 7461 7465 732e 6578 7465 6e64  ol_states.extend
-00019710: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019720: 2020 5f70 726f 6365 7373 5f75 6e69 7377    _process_unisw
-00019730: 6170 5f75 6e69 7665 7273 616c 5f72 6f75  ap_universal_rou
-00019740: 7465 725f 7472 616e 7361 6374 696f 6e28  ter_transaction(
-00019750: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-00019760: 0a20 2020 2020 2020 2065 6c69 6620 6675  .        elif fu
-00019770: 6e63 5f6e 616d 6520 696e 2055 4e48 414e  nc_name in UNHAN
-00019780: 444c 4544 5f46 554e 4354 494f 4e53 3a0a  DLED_FUNCTIONS:.
-00019790: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-000197a0: 444f 3a20 6164 6420 7072 6564 6963 7469  DO: add predicti
-000197b0: 6f6e 2066 6f72 2074 6865 7365 2066 756e  on for these fun
-000197c0: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
-000197d0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-000197e0: 6622 544f 444f 3a20 7b66 756e 635f 6e61  f"TODO: {func_na
-000197f0: 6d65 7d22 290a 2020 2020 2020 2020 2020  me}").          
-00019800: 2020 7261 6973 6520 5472 616e 7361 6374    raise Transact
-00019810: 696f 6e45 7272 6f72 280a 2020 2020 2020  ionError(.      
-00019820: 2020 2020 2020 2020 2020 6622 4162 6f72            f"Abor
-00019830: 7469 6e67 2073 696d 756c 6174 696f 6e20  ting simulation 
-00019840: 696e 766f 6c76 696e 6720 756e 2d69 6d70  involving un-imp
-00019850: 6c65 6d65 6e74 6564 2066 756e 6374 696f  lemented functio
-00019860: 6e3a 207b 6675 6e63 5f6e 616d 657d 220a  n: {func_name}".
-00019870: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00019880: 2020 2020 2020 656c 6966 2066 756e 635f        elif func_
-00019890: 6e61 6d65 2069 6e20 4e4f 5f4f 505f 4655  name in NO_OP_FU
-000198a0: 4e43 5449 4f4e 533a 0a20 2020 2020 2020  NCTIONS:.       
-000198b0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-000198c0: 6728 6622 4e4f 4e2d 4f50 3a20 7b66 756e  g(f"NON-OP: {fun
-000198d0: 635f 6e61 6d65 7d22 290a 2020 2020 2020  c_name}").      
-000198e0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-000198f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00019900: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00019910: 4572 726f 7228 6622 554e 4841 4e44 4c45  Error(f"UNHANDLE
-00019920: 443a 207b 6675 6e63 5f6e 616d 657d 2229  D: {func_name}")
-00019930: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00019940: 2061 6c6c 5f66 7574 7572 655f 706f 6f6c   all_future_pool
-00019950: 5f73 7461 7465 730a 0a20 2020 2064 6566  _states..    def
-00019960: 2073 696d 756c 6174 6528 0a20 2020 2020   simulate(.     
-00019970: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00019980: 2073 696c 656e 743a 2062 6f6f 6c20 3d20   silent: bool = 
-00019990: 4661 6c73 652c 0a20 2020 2020 2020 2073  False,.        s
-000199a0: 7461 7465 5f62 6c6f 636b 3a20 426c 6f63  tate_block: Bloc
-000199b0: 6b4e 756d 6265 7220 7c20 696e 7420 7c20  kNumber | int | 
-000199c0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-000199d0: 2029 202d 3e20 4c69 7374 5b0a 2020 2020   ) -> List[.    
-000199e0: 2020 2020 5475 706c 655b 4c69 7175 6964      Tuple[Liquid
-000199f0: 6974 7950 6f6f 6c2c 2055 6e69 7377 6170  ityPool, Uniswap
-00019a00: 5632 506f 6f6c 5369 6d75 6c61 7469 6f6e  V2PoolSimulation
-00019a10: 5265 7375 6c74 5d0a 2020 2020 2020 2020  Result].        
-00019a20: 7c20 5475 706c 655b 5633 4c69 7175 6964  | Tuple[V3Liquid
-00019a30: 6974 7950 6f6f 6c2c 2055 6e69 7377 6170  ityPool, Uniswap
-00019a40: 5633 506f 6f6c 5369 6d75 6c61 7469 6f6e  V3PoolSimulation
-00019a50: 5265 7375 6c74 5d0a 2020 2020 5d3a 0a20  Result].    ]:. 
-00019a60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00019a70: 2020 2045 7865 6375 7465 2061 2073 696d     Execute a sim
-00019a80: 756c 6174 696f 6e20 6f66 2061 2074 7261  ulation of a tra
-00019a90: 6e73 6163 7469 6f6e 2c20 7573 696e 6720  nsaction, using 
-00019aa0: 7468 6520 6174 7472 6962 7574 6573 0a20  the attributes. 
-00019ab0: 2020 2020 2020 2073 746f 7265 6420 696e         stored in
-00019ac0: 2074 6865 2063 6f6e 7374 7275 6374 6f72   the constructor
-00019ad0: 2e0a 0a20 2020 2020 2020 2044 6566 6572  ...        Defer
-00019ae0: 7320 7369 6d75 6c61 7469 6f6e 2074 6f20  s simulation to 
-00019af0: 7468 6520 605f 7369 6d75 6c61 7465 6020  the `_simulate` 
-00019b00: 6d65 7468 6f64 2c20 7768 6963 6820 6d61  method, which ma
-00019b10: 7920 7265 6375 7273 650a 2020 2020 2020  y recurse.      
-00019b20: 2020 6173 206e 6565 6465 6420 666f 7220    as needed for 
-00019b30: 6e65 7374 6564 206d 756c 7469 6361 6c6c  nested multicall
-00019b40: 732e 0a0a 2020 2020 2020 2020 5065 7266  s...        Perf
-00019b50: 6f72 6d73 2061 2066 696e 616c 2061 6363  orms a final acc
-00019b60: 6f75 6e74 696e 6720 6368 6563 6b20 6f66  ounting check of
-00019b70: 2061 6464 7265 7373 6573 2069 6e20 6073   addresses in `s
-00019b80: 656c 662e 6c65 6467 6572 600a 2020 2020  elf.ledger`.    
-00019b90: 2020 2020 6c65 6467 6572 2c20 6578 636c      ledger, excl
-00019ba0: 7564 696e 6720 7468 6520 606d 7367 2e73  uding the `msg.s
-00019bb0: 656e 6465 7260 2061 6e64 2060 7265 6369  ender` and `reci
-00019bc0: 7069 656e 7460 2061 6464 7265 7373 6573  pient` addresses
-00019bd0: 2e0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-00019be0: 2020 2020 2020 2073 656c 662e 7369 6c65         self.sile
-00019bf0: 6e74 203d 2073 696c 656e 740a 0a20 2020  nt = silent..   
-00019c00: 2020 2020 2073 656c 662e 7374 6174 655f       self.state_
-00019c10: 626c 6f63 6b3a 2042 6c6f 636b 4e75 6d62  block: BlockNumb
-00019c20: 6572 0a20 2020 2020 2020 2069 6620 7374  er.        if st
-00019c30: 6174 655f 626c 6f63 6b20 6973 204e 6f6e  ate_block is Non
-00019c40: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00019c50: 656c 662e 7374 6174 655f 626c 6f63 6b20  elf.state_block 
-00019c60: 3d20 636f 6e66 6967 2e67 6574 5f77 6562  = config.get_web
-00019c70: 3328 292e 6574 682e 6765 745f 626c 6f63  3().eth.get_bloc
-00019c80: 6b5f 6e75 6d62 6572 2829 0a20 2020 2020  k_number().     
-00019c90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00019ca0: 2020 2020 2073 656c 662e 7374 6174 655f       self.state_
-00019cb0: 626c 6f63 6b20 3d20 6361 7374 2842 6c6f  block = cast(Blo
-00019cc0: 636b 4e75 6d62 6572 2c20 7374 6174 655f  ckNumber, state_
-00019cd0: 626c 6f63 6b29 0a0a 2020 2020 2020 2020  block)..        
-00019ce0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00019cf0: 2072 6573 756c 7473 203d 2073 656c 662e   results = self.
-00019d00: 5f73 696d 756c 6174 6528 0a20 2020 2020  _simulate(.     
-00019d10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019d20: 6675 6e63 5f6e 616d 652c 0a20 2020 2020  func_name,.     
-00019d30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019d40: 6675 6e63 5f70 6172 616d 732c 0a20 2020  func_params,.   
-00019d50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00019d60: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
-00019d70: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-00019d80: 2020 2020 2020 2072 6169 7365 2054 7261         raise Tra
-00019d90: 6e73 6163 7469 6f6e 4572 726f 7228 6529  nsactionError(e)
-00019da0: 0a0a 2020 2020 2020 2020 6966 2073 6574  ..        if set
-00019db0: 2873 656c 662e 6c65 6467 6572 2e5f 6261  (self.ledger._ba
-00019dc0: 6c61 6e63 6573 2920 2d20 7365 7428 5b73  lances) - set([s
-00019dd0: 656c 662e 7365 6e64 6572 5d29 202d 2073  elf.sender]) - s
-00019de0: 656c 662e 7265 6369 7069 656e 7473 3a0a  elf.recipients:.
-00019df0: 2020 2020 2020 2020 2020 2020 2320 4967              # Ig
-00019e00: 6e6f 7265 2063 6173 6520 7768 6572 6520  nore case where 
-00019e10: 616e 2065 7863 6573 7320 7772 6170 7065  an excess wrappe
-00019e20: 6420 746f 6b65 6e20 6261 6c61 6e63 6520  d token balance 
-00019e30: 7265 6d61 696e 7320 6174 2074 6865 2072  remains at the r
-00019e40: 6f75 7465 720a 2020 2020 2020 2020 2020  outer.          
-00019e50: 2020 6966 2073 656c 662e 6c65 6467 6572    if self.ledger
-00019e60: 2e5f 6261 6c61 6e63 6573 5b73 656c 662e  ._balances[self.
-00019e70: 726f 7574 6572 5f61 6464 7265 7373 5d5b  router_address][
-00019e80: 5752 4150 5045 445f 4e41 5449 5645 5f54  WRAPPED_NATIVE_T
-00019e90: 4f4b 454e 535b 7365 6c66 2e63 6861 696e  OKENS[self.chain
-00019ea0: 5f69 645d 5d3a 0a20 2020 2020 2020 2020  _id]]:.         
-00019eb0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00019ec0: 666f 2822 5369 6d75 6c61 7469 6f6e 2072  fo("Simulation r
-00019ed0: 6573 756c 7473 2069 6e20 6c65 6674 6f76  esults in leftov
-00019ee0: 6572 2077 7261 7070 6564 2074 6f6b 656e  er wrapped token
-00019ef0: 2062 616c 616e 6365 2229 0a20 2020 2020   balance").     
-00019f00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00019f10: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00019f20: 7365 204c 6564 6765 7245 7272 6f72 280a  se LedgerError(.
-00019f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f40: 2020 2020 6622 554e 4143 434f 554e 5445      f"UNACCOUNTE
-00019f50: 4420 4241 4c41 4e43 4520 464f 554e 4421  D BALANCE FOUND!
-00019f60: 5c6e 7b70 7072 696e 742e 7066 6f72 6d61  \n{pprint.pforma
-00019f70: 7428 7365 6c66 2e6c 6564 6765 722e 5f62  t(self.ledger._b
-00019f80: 616c 616e 6365 7329 7d22 0a20 2020 2020  alances)}".     
-00019f90: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00019fa0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00019fb0: 756c 7473 0a                             ults.
+00019350: 206c 6f67 6765 722e 696e 666f 2866 227b   logger.info(f"{
+00019360: 616d 6f75 6e74 305f 6d69 6e3d 7d22 290a  amount0_min=}").
+00019370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019380: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00019390: 6e66 6f28 6622 7b61 6d6f 756e 7431 5f6d  nfo(f"{amount1_m
+000193a0: 696e 3d7d 2229 0a20 2020 2020 2020 2020  in=}").         
+000193b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000193c0: 6f67 6765 722e 696e 666f 2866 227b 616d  ogger.info(f"{am
+000193d0: 6f75 6e74 305f 6465 7369 7265 643d 7d22  ount0_desired=}"
+000193e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000193f0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00019400: 2e69 6e66 6f28 6622 7b61 6d6f 756e 7431  .info(f"{amount1
+00019410: 5f64 6573 6972 6564 3d7d 2229 0a0a 2020  _desired=}")..  
+00019420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019430: 2020 2020 2020 706f 7369 7469 6f6e 735f        positions_
+00019440: 636f 6e74 7261 6374 203d 2063 6f6e 6669  contract = confi
+00019450: 672e 6765 745f 7765 6233 2829 2e65 7468  g.get_web3().eth
+00019460: 2e63 6f6e 7472 6163 7428 0a20 2020 2020  .contract(.     
+00019470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019480: 2020 2020 2020 2061 6464 7265 7373 3d74         address=t
+00019490: 6f5f 6368 6563 6b73 756d 5f61 6464 7265  o_checksum_addre
+000194a0: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
+000194b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194c0: 2020 2020 2230 7843 3336 3434 3262 3461      "0xC36442b4a
+000194d0: 3435 3232 4538 3731 3339 3943 4437 3137  4522E871399CD717
+000194e0: 6142 4444 3834 3741 6231 3146 4538 3822  aBDD847Ab11FE88"
+000194f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019500: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 2020 2020 2020 2020 2020 2020 6162 693d              abi=
+00019530: 6a73 6f6e 2e6c 6f61 6473 280a 2020 2020  json.loads(.    
+00019540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019550: 2020 2020 2020 2020 2020 2020 2222 220a              """.
+00019560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019580: 5b7b 2269 6e70 7574 7322 3a5b 7b22 696e  [{"inputs":[{"in
+00019590: 7465 726e 616c 5479 7065 223a 2261 6464  ternalType":"add
+000195a0: 7265 7373 222c 226e 616d 6522 3a22 5f66  ress","name":"_f
+000195b0: 6163 746f 7279 222c 2274 7970 6522 3a22  actory","type":"
+000195c0: 6164 6472 6573 7322 7d2c 7b22 696e 7465  address"},{"inte
+000195d0: 726e 616c 5479 7065 223a 2261 6464 7265  rnalType":"addre
+000195e0: 7373 222c 226e 616d 6522 3a22 5f57 4554  ss","name":"_WET
+000195f0: 4839 222c 2274 7970 6522 3a22 6164 6472  H9","type":"addr
+00019600: 6573 7322 7d2c 7b22 696e 7465 726e 616c  ess"},{"internal
+00019610: 5479 7065 223a 2261 6464 7265 7373 222c  Type":"address",
+00019620: 226e 616d 6522 3a22 5f74 6f6b 656e 4465  "name":"_tokenDe
+00019630: 7363 7269 7074 6f72 5f22 2c22 7479 7065  scriptor_","type
+00019640: 223a 2261 6464 7265 7373 227d 5d2c 2273  ":"address"}],"s
+00019650: 7461 7465 4d75 7461 6269 6c69 7479 223a  tateMutability":
+00019660: 226e 6f6e 7061 7961 626c 6522 2c22 7479  "nonpayable","ty
+00019670: 7065 223a 2263 6f6e 7374 7275 6374 6f72  pe":"constructor
+00019680: 227d 2c7b 2261 6e6f 6e79 6d6f 7573 223a  "},{"anonymous":
+00019690: 6661 6c73 652c 2269 6e70 7574 7322 3a5b  false,"inputs":[
+000196a0: 7b22 696e 6465 7865 6422 3a74 7275 652c  {"indexed":true,
+000196b0: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+000196c0: 6164 6472 6573 7322 2c22 6e61 6d65 223a  address","name":
+000196d0: 226f 776e 6572 222c 2274 7970 6522 3a22  "owner","type":"
+000196e0: 6164 6472 6573 7322 7d2c 7b22 696e 6465  address"},{"inde
+000196f0: 7865 6422 3a74 7275 652c 2269 6e74 6572  xed":true,"inter
+00019700: 6e61 6c54 7970 6522 3a22 6164 6472 6573  nalType":"addres
+00019710: 7322 2c22 6e61 6d65 223a 2261 7070 726f  s","name":"appro
+00019720: 7665 6422 2c22 7479 7065 223a 2261 6464  ved","type":"add
+00019730: 7265 7373 227d 2c7b 2269 6e64 6578 6564  ress"},{"indexed
+00019740: 223a 7472 7565 2c22 696e 7465 726e 616c  ":true,"internal
+00019750: 5479 7065 223a 2275 696e 7432 3536 222c  Type":"uint256",
+00019760: 226e 616d 6522 3a22 746f 6b65 6e49 6422  "name":"tokenId"
+00019770: 2c22 7479 7065 223a 2275 696e 7432 3536  ,"type":"uint256
+00019780: 227d 5d2c 226e 616d 6522 3a22 4170 7072  "}],"name":"Appr
+00019790: 6f76 616c 222c 2274 7970 6522 3a22 6576  oval","type":"ev
+000197a0: 656e 7422 7d2c 7b22 616e 6f6e 796d 6f75  ent"},{"anonymou
+000197b0: 7322 3a66 616c 7365 2c22 696e 7075 7473  s":false,"inputs
+000197c0: 223a 5b7b 2269 6e64 6578 6564 223a 7472  ":[{"indexed":tr
+000197d0: 7565 2c22 696e 7465 726e 616c 5479 7065  ue,"internalType
+000197e0: 223a 2261 6464 7265 7373 222c 226e 616d  ":"address","nam
+000197f0: 6522 3a22 6f77 6e65 7222 2c22 7479 7065  e":"owner","type
+00019800: 223a 2261 6464 7265 7373 227d 2c7b 2269  ":"address"},{"i
+00019810: 6e64 6578 6564 223a 7472 7565 2c22 696e  ndexed":true,"in
+00019820: 7465 726e 616c 5479 7065 223a 2261 6464  ternalType":"add
+00019830: 7265 7373 222c 226e 616d 6522 3a22 6f70  ress","name":"op
+00019840: 6572 6174 6f72 222c 2274 7970 6522 3a22  erator","type":"
+00019850: 6164 6472 6573 7322 7d2c 7b22 696e 6465  address"},{"inde
+00019860: 7865 6422 3a66 616c 7365 2c22 696e 7465  xed":false,"inte
+00019870: 726e 616c 5479 7065 223a 2262 6f6f 6c22  rnalType":"bool"
+00019880: 2c22 6e61 6d65 223a 2261 7070 726f 7665  ,"name":"approve
+00019890: 6422 2c22 7479 7065 223a 2262 6f6f 6c22  d","type":"bool"
+000198a0: 7d5d 2c22 6e61 6d65 223a 2241 7070 726f  }],"name":"Appro
+000198b0: 7661 6c46 6f72 416c 6c22 2c22 7479 7065  valForAll","type
+000198c0: 223a 2265 7665 6e74 227d 2c7b 2261 6e6f  ":"event"},{"ano
+000198d0: 6e79 6d6f 7573 223a 6661 6c73 652c 2269  nymous":false,"i
+000198e0: 6e70 7574 7322 3a5b 7b22 696e 6465 7865  nputs":[{"indexe
+000198f0: 6422 3a74 7275 652c 2269 6e74 6572 6e61  d":true,"interna
+00019900: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+00019910: 2c22 6e61 6d65 223a 2274 6f6b 656e 4964  ,"name":"tokenId
+00019920: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+00019930: 3622 7d2c 7b22 696e 6465 7865 6422 3a66  6"},{"indexed":f
+00019940: 616c 7365 2c22 696e 7465 726e 616c 5479  alse,"internalTy
+00019950: 7065 223a 2261 6464 7265 7373 222c 226e  pe":"address","n
+00019960: 616d 6522 3a22 7265 6369 7069 656e 7422  ame":"recipient"
+00019970: 2c22 7479 7065 223a 2261 6464 7265 7373  ,"type":"address
+00019980: 227d 2c7b 2269 6e64 6578 6564 223a 6661  "},{"indexed":fa
+00019990: 6c73 652c 2269 6e74 6572 6e61 6c54 7970  lse,"internalTyp
+000199a0: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+000199b0: 6d65 223a 2261 6d6f 756e 7430 222c 2274  me":"amount0","t
+000199c0: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+000199d0: 7b22 696e 6465 7865 6422 3a66 616c 7365  {"indexed":false
+000199e0: 2c22 696e 7465 726e 616c 5479 7065 223a  ,"internalType":
+000199f0: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+00019a00: 3a22 616d 6f75 6e74 3122 2c22 7479 7065  :"amount1","type
+00019a10: 223a 2275 696e 7432 3536 227d 5d2c 226e  ":"uint256"}],"n
+00019a20: 616d 6522 3a22 436f 6c6c 6563 7422 2c22  ame":"Collect","
+00019a30: 7479 7065 223a 2265 7665 6e74 227d 2c7b  type":"event"},{
+00019a40: 2261 6e6f 6e79 6d6f 7573 223a 6661 6c73  "anonymous":fals
+00019a50: 652c 2269 6e70 7574 7322 3a5b 7b22 696e  e,"inputs":[{"in
+00019a60: 6465 7865 6422 3a74 7275 652c 2269 6e74  dexed":true,"int
+00019a70: 6572 6e61 6c54 7970 6522 3a22 7569 6e74  ernalType":"uint
+00019a80: 3235 3622 2c22 6e61 6d65 223a 2274 6f6b  256","name":"tok
+00019a90: 656e 4964 222c 2274 7970 6522 3a22 7569  enId","type":"ui
+00019aa0: 6e74 3235 3622 7d2c 7b22 696e 6465 7865  nt256"},{"indexe
+00019ab0: 6422 3a66 616c 7365 2c22 696e 7465 726e  d":false,"intern
+00019ac0: 616c 5479 7065 223a 2275 696e 7431 3238  alType":"uint128
+00019ad0: 222c 226e 616d 6522 3a22 6c69 7175 6964  ","name":"liquid
+00019ae0: 6974 7922 2c22 7479 7065 223a 2275 696e  ity","type":"uin
+00019af0: 7431 3238 227d 2c7b 2269 6e64 6578 6564  t128"},{"indexed
+00019b00: 223a 6661 6c73 652c 2269 6e74 6572 6e61  ":false,"interna
+00019b10: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+00019b20: 2c22 6e61 6d65 223a 2261 6d6f 756e 7430  ,"name":"amount0
+00019b30: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+00019b40: 3622 7d2c 7b22 696e 6465 7865 6422 3a66  6"},{"indexed":f
+00019b50: 616c 7365 2c22 696e 7465 726e 616c 5479  alse,"internalTy
+00019b60: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+00019b70: 616d 6522 3a22 616d 6f75 6e74 3122 2c22  ame":"amount1","
+00019b80: 7479 7065 223a 2275 696e 7432 3536 227d  type":"uint256"}
+00019b90: 5d2c 226e 616d 6522 3a22 4465 6372 6561  ],"name":"Decrea
+00019ba0: 7365 4c69 7175 6964 6974 7922 2c22 7479  seLiquidity","ty
+00019bb0: 7065 223a 2265 7665 6e74 227d 2c7b 2261  pe":"event"},{"a
+00019bc0: 6e6f 6e79 6d6f 7573 223a 6661 6c73 652c  nonymous":false,
+00019bd0: 2269 6e70 7574 7322 3a5b 7b22 696e 6465  "inputs":[{"inde
+00019be0: 7865 6422 3a74 7275 652c 2269 6e74 6572  xed":true,"inter
+00019bf0: 6e61 6c54 7970 6522 3a22 7569 6e74 3235  nalType":"uint25
+00019c00: 3622 2c22 6e61 6d65 223a 2274 6f6b 656e  6","name":"token
+00019c10: 4964 222c 2274 7970 6522 3a22 7569 6e74  Id","type":"uint
+00019c20: 3235 3622 7d2c 7b22 696e 6465 7865 6422  256"},{"indexed"
+00019c30: 3a66 616c 7365 2c22 696e 7465 726e 616c  :false,"internal
+00019c40: 5479 7065 223a 2275 696e 7431 3238 222c  Type":"uint128",
+00019c50: 226e 616d 6522 3a22 6c69 7175 6964 6974  "name":"liquidit
+00019c60: 7922 2c22 7479 7065 223a 2275 696e 7431  y","type":"uint1
+00019c70: 3238 227d 2c7b 2269 6e64 6578 6564 223a  28"},{"indexed":
+00019c80: 6661 6c73 652c 2269 6e74 6572 6e61 6c54  false,"internalT
+00019c90: 7970 6522 3a22 7569 6e74 3235 3622 2c22  ype":"uint256","
+00019ca0: 6e61 6d65 223a 2261 6d6f 756e 7430 222c  name":"amount0",
+00019cb0: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+00019cc0: 7d2c 7b22 696e 6465 7865 6422 3a66 616c  },{"indexed":fal
+00019cd0: 7365 2c22 696e 7465 726e 616c 5479 7065  se,"internalType
+00019ce0: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+00019cf0: 6522 3a22 616d 6f75 6e74 3122 2c22 7479  e":"amount1","ty
+00019d00: 7065 223a 2275 696e 7432 3536 227d 5d2c  pe":"uint256"}],
+00019d10: 226e 616d 6522 3a22 496e 6372 6561 7365  "name":"Increase
+00019d20: 4c69 7175 6964 6974 7922 2c22 7479 7065  Liquidity","type
+00019d30: 223a 2265 7665 6e74 227d 2c7b 2261 6e6f  ":"event"},{"ano
+00019d40: 6e79 6d6f 7573 223a 6661 6c73 652c 2269  nymous":false,"i
+00019d50: 6e70 7574 7322 3a5b 7b22 696e 6465 7865  nputs":[{"indexe
+00019d60: 6422 3a74 7275 652c 2269 6e74 6572 6e61  d":true,"interna
+00019d70: 6c54 7970 6522 3a22 6164 6472 6573 7322  lType":"address"
+00019d80: 2c22 6e61 6d65 223a 2266 726f 6d22 2c22  ,"name":"from","
+00019d90: 7479 7065 223a 2261 6464 7265 7373 227d  type":"address"}
+00019da0: 2c7b 2269 6e64 6578 6564 223a 7472 7565  ,{"indexed":true
+00019db0: 2c22 696e 7465 726e 616c 5479 7065 223a  ,"internalType":
+00019dc0: 2261 6464 7265 7373 222c 226e 616d 6522  "address","name"
+00019dd0: 3a22 746f 222c 2274 7970 6522 3a22 6164  :"to","type":"ad
+00019de0: 6472 6573 7322 7d2c 7b22 696e 6465 7865  dress"},{"indexe
+00019df0: 6422 3a74 7275 652c 2269 6e74 6572 6e61  d":true,"interna
+00019e00: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+00019e10: 2c22 6e61 6d65 223a 2274 6f6b 656e 4964  ,"name":"tokenId
+00019e20: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+00019e30: 3622 7d5d 2c22 6e61 6d65 223a 2254 7261  6"}],"name":"Tra
+00019e40: 6e73 6665 7222 2c22 7479 7065 223a 2265  nsfer","type":"e
+00019e50: 7665 6e74 227d 2c7b 2269 6e70 7574 7322  vent"},{"inputs"
+00019e60: 3a5b 5d2c 226e 616d 6522 3a22 444f 4d41  :[],"name":"DOMA
+00019e70: 494e 5f53 4550 4152 4154 4f52 222c 226f  IN_SEPARATOR","o
+00019e80: 7574 7075 7473 223a 5b7b 2269 6e74 6572  utputs":[{"inter
+00019e90: 6e61 6c54 7970 6522 3a22 6279 7465 7333  nalType":"bytes3
+00019ea0: 3222 2c22 6e61 6d65 223a 2222 2c22 7479  2","name":"","ty
+00019eb0: 7065 223a 2262 7974 6573 3332 227d 5d2c  pe":"bytes32"}],
+00019ec0: 2273 7461 7465 4d75 7461 6269 6c69 7479  "stateMutability
+00019ed0: 223a 2276 6965 7722 2c22 7479 7065 223a  ":"view","type":
+00019ee0: 2266 756e 6374 696f 6e22 7d2c 7b22 696e  "function"},{"in
+00019ef0: 7075 7473 223a 5b5d 2c22 6e61 6d65 223a  puts":[],"name":
+00019f00: 2250 4552 4d49 545f 5459 5045 4841 5348  "PERMIT_TYPEHASH
+00019f10: 222c 226f 7574 7075 7473 223a 5b7b 2269  ","outputs":[{"i
+00019f20: 6e74 6572 6e61 6c54 7970 6522 3a22 6279  nternalType":"by
+00019f30: 7465 7333 3222 2c22 6e61 6d65 223a 2222  tes32","name":""
+00019f40: 2c22 7479 7065 223a 2262 7974 6573 3332  ,"type":"bytes32
+00019f50: 227d 5d2c 2273 7461 7465 4d75 7461 6269  "}],"stateMutabi
+00019f60: 6c69 7479 223a 2276 6965 7722 2c22 7479  lity":"view","ty
+00019f70: 7065 223a 2266 756e 6374 696f 6e22 7d2c  pe":"function"},
+00019f80: 7b22 696e 7075 7473 223a 5b5d 2c22 6e61  {"inputs":[],"na
+00019f90: 6d65 223a 2257 4554 4839 222c 226f 7574  me":"WETH9","out
+00019fa0: 7075 7473 223a 5b7b 2269 6e74 6572 6e61  puts":[{"interna
+00019fb0: 6c54 7970 6522 3a22 6164 6472 6573 7322  lType":"address"
+00019fc0: 2c22 6e61 6d65 223a 2222 2c22 7479 7065  ,"name":"","type
+00019fd0: 223a 2261 6464 7265 7373 227d 5d2c 2273  ":"address"}],"s
+00019fe0: 7461 7465 4d75 7461 6269 6c69 7479 223a  tateMutability":
+00019ff0: 2276 6965 7722 2c22 7479 7065 223a 2266  "view","type":"f
+0001a000: 756e 6374 696f 6e22 7d2c 7b22 696e 7075  unction"},{"inpu
+0001a010: 7473 223a 5b7b 2269 6e74 6572 6e61 6c54  ts":[{"internalT
+0001a020: 7970 6522 3a22 6164 6472 6573 7322 2c22  ype":"address","
+0001a030: 6e61 6d65 223a 2274 6f22 2c22 7479 7065  name":"to","type
+0001a040: 223a 2261 6464 7265 7373 227d 2c7b 2269  ":"address"},{"i
+0001a050: 6e74 6572 6e61 6c54 7970 6522 3a22 7569  nternalType":"ui
+0001a060: 6e74 3235 3622 2c22 6e61 6d65 223a 2274  nt256","name":"t
+0001a070: 6f6b 656e 4964 222c 2274 7970 6522 3a22  okenId","type":"
+0001a080: 7569 6e74 3235 3622 7d5d 2c22 6e61 6d65  uint256"}],"name
+0001a090: 223a 2261 7070 726f 7665 222c 226f 7574  ":"approve","out
+0001a0a0: 7075 7473 223a 5b5d 2c22 7374 6174 654d  puts":[],"stateM
+0001a0b0: 7574 6162 696c 6974 7922 3a22 6e6f 6e70  utability":"nonp
+0001a0c0: 6179 6162 6c65 222c 2274 7970 6522 3a22  ayable","type":"
+0001a0d0: 6675 6e63 7469 6f6e 227d 2c7b 2269 6e70  function"},{"inp
+0001a0e0: 7574 7322 3a5b 7b22 696e 7465 726e 616c  uts":[{"internal
+0001a0f0: 5479 7065 223a 2261 6464 7265 7373 222c  Type":"address",
+0001a100: 226e 616d 6522 3a22 6f77 6e65 7222 2c22  "name":"owner","
+0001a110: 7479 7065 223a 2261 6464 7265 7373 227d  type":"address"}
+0001a120: 5d2c 226e 616d 6522 3a22 6261 6c61 6e63  ],"name":"balanc
+0001a130: 654f 6622 2c22 6f75 7470 7574 7322 3a5b  eOf","outputs":[
+0001a140: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001a150: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001a160: 3a22 222c 2274 7970 6522 3a22 7569 6e74  :"","type":"uint
+0001a170: 3235 3622 7d5d 2c22 7374 6174 654d 7574  256"}],"stateMut
+0001a180: 6162 696c 6974 7922 3a22 7669 6577 222c  ability":"view",
+0001a190: 2274 7970 6522 3a22 6675 6e63 7469 6f6e  "type":"function
+0001a1a0: 227d 2c7b 2269 6e70 7574 7322 3a5b 5d2c  "},{"inputs":[],
+0001a1b0: 226e 616d 6522 3a22 6261 7365 5552 4922  "name":"baseURI"
+0001a1c0: 2c22 6f75 7470 7574 7322 3a5b 7b22 696e  ,"outputs":[{"in
+0001a1d0: 7465 726e 616c 5479 7065 223a 2273 7472  ternalType":"str
+0001a1e0: 696e 6722 2c22 6e61 6d65 223a 2222 2c22  ing","name":"","
+0001a1f0: 7479 7065 223a 2273 7472 696e 6722 7d5d  type":"string"}]
+0001a200: 2c22 7374 6174 654d 7574 6162 696c 6974  ,"stateMutabilit
+0001a210: 7922 3a22 7075 7265 222c 2274 7970 6522  y":"pure","type"
+0001a220: 3a22 6675 6e63 7469 6f6e 227d 2c7b 2269  :"function"},{"i
+0001a230: 6e70 7574 7322 3a5b 7b22 696e 7465 726e  nputs":[{"intern
+0001a240: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001a250: 222c 226e 616d 6522 3a22 746f 6b65 6e49  ","name":"tokenI
+0001a260: 6422 2c22 7479 7065 223a 2275 696e 7432  d","type":"uint2
+0001a270: 3536 227d 5d2c 226e 616d 6522 3a22 6275  56"}],"name":"bu
+0001a280: 726e 222c 226f 7574 7075 7473 223a 5b5d  rn","outputs":[]
+0001a290: 2c22 7374 6174 654d 7574 6162 696c 6974  ,"stateMutabilit
+0001a2a0: 7922 3a22 7061 7961 626c 6522 2c22 7479  y":"payable","ty
+0001a2b0: 7065 223a 2266 756e 6374 696f 6e22 7d2c  pe":"function"},
+0001a2c0: 7b22 696e 7075 7473 223a 5b7b 2263 6f6d  {"inputs":[{"com
+0001a2d0: 706f 6e65 6e74 7322 3a5b 7b22 696e 7465  ponents":[{"inte
+0001a2e0: 726e 616c 5479 7065 223a 2275 696e 7432  rnalType":"uint2
+0001a2f0: 3536 222c 226e 616d 6522 3a22 746f 6b65  56","name":"toke
+0001a300: 6e49 6422 2c22 7479 7065 223a 2275 696e  nId","type":"uin
+0001a310: 7432 3536 227d 2c7b 2269 6e74 6572 6e61  t256"},{"interna
+0001a320: 6c54 7970 6522 3a22 6164 6472 6573 7322  lType":"address"
+0001a330: 2c22 6e61 6d65 223a 2272 6563 6970 6965  ,"name":"recipie
+0001a340: 6e74 222c 2274 7970 6522 3a22 6164 6472  nt","type":"addr
+0001a350: 6573 7322 7d2c 7b22 696e 7465 726e 616c  ess"},{"internal
+0001a360: 5479 7065 223a 2275 696e 7431 3238 222c  Type":"uint128",
+0001a370: 226e 616d 6522 3a22 616d 6f75 6e74 304d  "name":"amount0M
+0001a380: 6178 222c 2274 7970 6522 3a22 7569 6e74  ax","type":"uint
+0001a390: 3132 3822 7d2c 7b22 696e 7465 726e 616c  128"},{"internal
+0001a3a0: 5479 7065 223a 2275 696e 7431 3238 222c  Type":"uint128",
+0001a3b0: 226e 616d 6522 3a22 616d 6f75 6e74 314d  "name":"amount1M
+0001a3c0: 6178 222c 2274 7970 6522 3a22 7569 6e74  ax","type":"uint
+0001a3d0: 3132 3822 7d5d 2c22 696e 7465 726e 616c  128"}],"internal
+0001a3e0: 5479 7065 223a 2273 7472 7563 7420 494e  Type":"struct IN
+0001a3f0: 6f6e 6675 6e67 6962 6c65 506f 7369 7469  onfungiblePositi
+0001a400: 6f6e 4d61 6e61 6765 722e 436f 6c6c 6563  onManager.Collec
+0001a410: 7450 6172 616d 7322 2c22 6e61 6d65 223a  tParams","name":
+0001a420: 2270 6172 616d 7322 2c22 7479 7065 223a  "params","type":
+0001a430: 2274 7570 6c65 227d 5d2c 226e 616d 6522  "tuple"}],"name"
+0001a440: 3a22 636f 6c6c 6563 7422 2c22 6f75 7470  :"collect","outp
+0001a450: 7574 7322 3a5b 7b22 696e 7465 726e 616c  uts":[{"internal
+0001a460: 5479 7065 223a 2275 696e 7432 3536 222c  Type":"uint256",
+0001a470: 226e 616d 6522 3a22 616d 6f75 6e74 3022  "name":"amount0"
+0001a480: 2c22 7479 7065 223a 2275 696e 7432 3536  ,"type":"uint256
+0001a490: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001a4a0: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+0001a4b0: 6d65 223a 2261 6d6f 756e 7431 222c 2274  me":"amount1","t
+0001a4c0: 7970 6522 3a22 7569 6e74 3235 3622 7d5d  ype":"uint256"}]
+0001a4d0: 2c22 7374 6174 654d 7574 6162 696c 6974  ,"stateMutabilit
+0001a4e0: 7922 3a22 7061 7961 626c 6522 2c22 7479  y":"payable","ty
+0001a4f0: 7065 223a 2266 756e 6374 696f 6e22 7d2c  pe":"function"},
+0001a500: 7b22 696e 7075 7473 223a 5b7b 2269 6e74  {"inputs":[{"int
+0001a510: 6572 6e61 6c54 7970 6522 3a22 6164 6472  ernalType":"addr
+0001a520: 6573 7322 2c22 6e61 6d65 223a 2274 6f6b  ess","name":"tok
+0001a530: 656e 3022 2c22 7479 7065 223a 2261 6464  en0","type":"add
+0001a540: 7265 7373 227d 2c7b 2269 6e74 6572 6e61  ress"},{"interna
+0001a550: 6c54 7970 6522 3a22 6164 6472 6573 7322  lType":"address"
+0001a560: 2c22 6e61 6d65 223a 2274 6f6b 656e 3122  ,"name":"token1"
+0001a570: 2c22 7479 7065 223a 2261 6464 7265 7373  ,"type":"address
+0001a580: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001a590: 6522 3a22 7569 6e74 3234 222c 226e 616d  e":"uint24","nam
+0001a5a0: 6522 3a22 6665 6522 2c22 7479 7065 223a  e":"fee","type":
+0001a5b0: 2275 696e 7432 3422 7d2c 7b22 696e 7465  "uint24"},{"inte
+0001a5c0: 726e 616c 5479 7065 223a 2275 696e 7431  rnalType":"uint1
+0001a5d0: 3630 222c 226e 616d 6522 3a22 7371 7274  60","name":"sqrt
+0001a5e0: 5072 6963 6558 3936 222c 2274 7970 6522  PriceX96","type"
+0001a5f0: 3a22 7569 6e74 3136 3022 7d5d 2c22 6e61  :"uint160"}],"na
+0001a600: 6d65 223a 2263 7265 6174 6541 6e64 496e  me":"createAndIn
+0001a610: 6974 6961 6c69 7a65 506f 6f6c 4966 4e65  itializePoolIfNe
+0001a620: 6365 7373 6172 7922 2c22 6f75 7470 7574  cessary","output
+0001a630: 7322 3a5b 7b22 696e 7465 726e 616c 5479  s":[{"internalTy
+0001a640: 7065 223a 2261 6464 7265 7373 222c 226e  pe":"address","n
+0001a650: 616d 6522 3a22 706f 6f6c 222c 2274 7970  ame":"pool","typ
+0001a660: 6522 3a22 6164 6472 6573 7322 7d5d 2c22  e":"address"}],"
+0001a670: 7374 6174 654d 7574 6162 696c 6974 7922  stateMutability"
+0001a680: 3a22 7061 7961 626c 6522 2c22 7479 7065  :"payable","type
+0001a690: 223a 2266 756e 6374 696f 6e22 7d2c 7b22  ":"function"},{"
+0001a6a0: 696e 7075 7473 223a 5b7b 2263 6f6d 706f  inputs":[{"compo
+0001a6b0: 6e65 6e74 7322 3a5b 7b22 696e 7465 726e  nents":[{"intern
+0001a6c0: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001a6d0: 222c 226e 616d 6522 3a22 746f 6b65 6e49  ","name":"tokenI
+0001a6e0: 6422 2c22 7479 7065 223a 2275 696e 7432  d","type":"uint2
+0001a6f0: 3536 227d 2c7b 2269 6e74 6572 6e61 6c54  56"},{"internalT
+0001a700: 7970 6522 3a22 7569 6e74 3132 3822 2c22  ype":"uint128","
+0001a710: 6e61 6d65 223a 226c 6971 7569 6469 7479  name":"liquidity
+0001a720: 222c 2274 7970 6522 3a22 7569 6e74 3132  ","type":"uint12
+0001a730: 3822 7d2c 7b22 696e 7465 726e 616c 5479  8"},{"internalTy
+0001a740: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+0001a750: 616d 6522 3a22 616d 6f75 6e74 304d 696e  ame":"amount0Min
+0001a760: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001a770: 3622 7d2c 7b22 696e 7465 726e 616c 5479  6"},{"internalTy
+0001a780: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+0001a790: 616d 6522 3a22 616d 6f75 6e74 314d 696e  ame":"amount1Min
+0001a7a0: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001a7b0: 3622 7d2c 7b22 696e 7465 726e 616c 5479  6"},{"internalTy
+0001a7c0: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+0001a7d0: 616d 6522 3a22 6465 6164 6c69 6e65 222c  ame":"deadline",
+0001a7e0: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+0001a7f0: 7d5d 2c22 696e 7465 726e 616c 5479 7065  }],"internalType
+0001a800: 223a 2273 7472 7563 7420 494e 6f6e 6675  ":"struct INonfu
+0001a810: 6e67 6962 6c65 506f 7369 7469 6f6e 4d61  ngiblePositionMa
+0001a820: 6e61 6765 722e 4465 6372 6561 7365 4c69  nager.DecreaseLi
+0001a830: 7175 6964 6974 7950 6172 616d 7322 2c22  quidityParams","
+0001a840: 6e61 6d65 223a 2270 6172 616d 7322 2c22  name":"params","
+0001a850: 7479 7065 223a 2274 7570 6c65 227d 5d2c  type":"tuple"}],
+0001a860: 226e 616d 6522 3a22 6465 6372 6561 7365  "name":"decrease
+0001a870: 4c69 7175 6964 6974 7922 2c22 6f75 7470  Liquidity","outp
+0001a880: 7574 7322 3a5b 7b22 696e 7465 726e 616c  uts":[{"internal
+0001a890: 5479 7065 223a 2275 696e 7432 3536 222c  Type":"uint256",
+0001a8a0: 226e 616d 6522 3a22 616d 6f75 6e74 3022  "name":"amount0"
+0001a8b0: 2c22 7479 7065 223a 2275 696e 7432 3536  ,"type":"uint256
+0001a8c0: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001a8d0: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+0001a8e0: 6d65 223a 2261 6d6f 756e 7431 222c 2274  me":"amount1","t
+0001a8f0: 7970 6522 3a22 7569 6e74 3235 3622 7d5d  ype":"uint256"}]
+0001a900: 2c22 7374 6174 654d 7574 6162 696c 6974  ,"stateMutabilit
+0001a910: 7922 3a22 7061 7961 626c 6522 2c22 7479  y":"payable","ty
+0001a920: 7065 223a 2266 756e 6374 696f 6e22 7d2c  pe":"function"},
+0001a930: 7b22 696e 7075 7473 223a 5b5d 2c22 6e61  {"inputs":[],"na
+0001a940: 6d65 223a 2266 6163 746f 7279 222c 226f  me":"factory","o
+0001a950: 7574 7075 7473 223a 5b7b 2269 6e74 6572  utputs":[{"inter
+0001a960: 6e61 6c54 7970 6522 3a22 6164 6472 6573  nalType":"addres
+0001a970: 7322 2c22 6e61 6d65 223a 2222 2c22 7479  s","name":"","ty
+0001a980: 7065 223a 2261 6464 7265 7373 227d 5d2c  pe":"address"}],
+0001a990: 2273 7461 7465 4d75 7461 6269 6c69 7479  "stateMutability
+0001a9a0: 223a 2276 6965 7722 2c22 7479 7065 223a  ":"view","type":
+0001a9b0: 2266 756e 6374 696f 6e22 7d2c 7b22 696e  "function"},{"in
+0001a9c0: 7075 7473 223a 5b7b 2269 6e74 6572 6e61  puts":[{"interna
+0001a9d0: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001a9e0: 2c22 6e61 6d65 223a 2274 6f6b 656e 4964  ,"name":"tokenId
+0001a9f0: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001aa00: 3622 7d5d 2c22 6e61 6d65 223a 2267 6574  6"}],"name":"get
+0001aa10: 4170 7072 6f76 6564 222c 226f 7574 7075  Approved","outpu
+0001aa20: 7473 223a 5b7b 2269 6e74 6572 6e61 6c54  ts":[{"internalT
+0001aa30: 7970 6522 3a22 6164 6472 6573 7322 2c22  ype":"address","
+0001aa40: 6e61 6d65 223a 2222 2c22 7479 7065 223a  name":"","type":
+0001aa50: 2261 6464 7265 7373 227d 5d2c 2273 7461  "address"}],"sta
+0001aa60: 7465 4d75 7461 6269 6c69 7479 223a 2276  teMutability":"v
+0001aa70: 6965 7722 2c22 7479 7065 223a 2266 756e  iew","type":"fun
+0001aa80: 6374 696f 6e22 7d2c 7b22 696e 7075 7473  ction"},{"inputs
+0001aa90: 223a 5b7b 2263 6f6d 706f 6e65 6e74 7322  ":[{"components"
+0001aaa0: 3a5b 7b22 696e 7465 726e 616c 5479 7065  :[{"internalType
+0001aab0: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+0001aac0: 6522 3a22 746f 6b65 6e49 6422 2c22 7479  e":"tokenId","ty
+0001aad0: 7065 223a 2275 696e 7432 3536 227d 2c7b  pe":"uint256"},{
+0001aae0: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001aaf0: 7569 6e74 3235 3622 2c22 6e61 6d65 223a  uint256","name":
+0001ab00: 2261 6d6f 756e 7430 4465 7369 7265 6422  "amount0Desired"
+0001ab10: 2c22 7479 7065 223a 2275 696e 7432 3536  ,"type":"uint256
+0001ab20: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001ab30: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+0001ab40: 6d65 223a 2261 6d6f 756e 7431 4465 7369  me":"amount1Desi
+0001ab50: 7265 6422 2c22 7479 7065 223a 2275 696e  red","type":"uin
+0001ab60: 7432 3536 227d 2c7b 2269 6e74 6572 6e61  t256"},{"interna
+0001ab70: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001ab80: 2c22 6e61 6d65 223a 2261 6d6f 756e 7430  ,"name":"amount0
+0001ab90: 4d69 6e22 2c22 7479 7065 223a 2275 696e  Min","type":"uin
+0001aba0: 7432 3536 227d 2c7b 2269 6e74 6572 6e61  t256"},{"interna
+0001abb0: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001abc0: 2c22 6e61 6d65 223a 2261 6d6f 756e 7431  ,"name":"amount1
+0001abd0: 4d69 6e22 2c22 7479 7065 223a 2275 696e  Min","type":"uin
+0001abe0: 7432 3536 227d 2c7b 2269 6e74 6572 6e61  t256"},{"interna
+0001abf0: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001ac00: 2c22 6e61 6d65 223a 2264 6561 646c 696e  ,"name":"deadlin
+0001ac10: 6522 2c22 7479 7065 223a 2275 696e 7432  e","type":"uint2
+0001ac20: 3536 227d 5d2c 2269 6e74 6572 6e61 6c54  56"}],"internalT
+0001ac30: 7970 6522 3a22 7374 7275 6374 2049 4e6f  ype":"struct INo
+0001ac40: 6e66 756e 6769 626c 6550 6f73 6974 696f  nfungiblePositio
+0001ac50: 6e4d 616e 6167 6572 2e49 6e63 7265 6173  nManager.Increas
+0001ac60: 654c 6971 7569 6469 7479 5061 7261 6d73  eLiquidityParams
+0001ac70: 222c 226e 616d 6522 3a22 7061 7261 6d73  ","name":"params
+0001ac80: 222c 2274 7970 6522 3a22 7475 706c 6522  ","type":"tuple"
+0001ac90: 7d5d 2c22 6e61 6d65 223a 2269 6e63 7265  }],"name":"incre
+0001aca0: 6173 654c 6971 7569 6469 7479 222c 226f  aseLiquidity","o
+0001acb0: 7574 7075 7473 223a 5b7b 2269 6e74 6572  utputs":[{"inter
+0001acc0: 6e61 6c54 7970 6522 3a22 7569 6e74 3132  nalType":"uint12
+0001acd0: 3822 2c22 6e61 6d65 223a 226c 6971 7569  8","name":"liqui
+0001ace0: 6469 7479 222c 2274 7970 6522 3a22 7569  dity","type":"ui
+0001acf0: 6e74 3132 3822 7d2c 7b22 696e 7465 726e  nt128"},{"intern
+0001ad00: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001ad10: 222c 226e 616d 6522 3a22 616d 6f75 6e74  ","name":"amount
+0001ad20: 3022 2c22 7479 7065 223a 2275 696e 7432  0","type":"uint2
+0001ad30: 3536 227d 2c7b 2269 6e74 6572 6e61 6c54  56"},{"internalT
+0001ad40: 7970 6522 3a22 7569 6e74 3235 3622 2c22  ype":"uint256","
+0001ad50: 6e61 6d65 223a 2261 6d6f 756e 7431 222c  name":"amount1",
+0001ad60: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+0001ad70: 7d5d 2c22 7374 6174 654d 7574 6162 696c  }],"stateMutabil
+0001ad80: 6974 7922 3a22 7061 7961 626c 6522 2c22  ity":"payable","
+0001ad90: 7479 7065 223a 2266 756e 6374 696f 6e22  type":"function"
+0001ada0: 7d2c 7b22 696e 7075 7473 223a 5b7b 2269  },{"inputs":[{"i
+0001adb0: 6e74 6572 6e61 6c54 7970 6522 3a22 6164  nternalType":"ad
+0001adc0: 6472 6573 7322 2c22 6e61 6d65 223a 226f  dress","name":"o
+0001add0: 776e 6572 222c 2274 7970 6522 3a22 6164  wner","type":"ad
+0001ade0: 6472 6573 7322 7d2c 7b22 696e 7465 726e  dress"},{"intern
+0001adf0: 616c 5479 7065 223a 2261 6464 7265 7373  alType":"address
+0001ae00: 222c 226e 616d 6522 3a22 6f70 6572 6174  ","name":"operat
+0001ae10: 6f72 222c 2274 7970 6522 3a22 6164 6472  or","type":"addr
+0001ae20: 6573 7322 7d5d 2c22 6e61 6d65 223a 2269  ess"}],"name":"i
+0001ae30: 7341 7070 726f 7665 6446 6f72 416c 6c22  sApprovedForAll"
+0001ae40: 2c22 6f75 7470 7574 7322 3a5b 7b22 696e  ,"outputs":[{"in
+0001ae50: 7465 726e 616c 5479 7065 223a 2262 6f6f  ternalType":"boo
+0001ae60: 6c22 2c22 6e61 6d65 223a 2222 2c22 7479  l","name":"","ty
+0001ae70: 7065 223a 2262 6f6f 6c22 7d5d 2c22 7374  pe":"bool"}],"st
+0001ae80: 6174 654d 7574 6162 696c 6974 7922 3a22  ateMutability":"
+0001ae90: 7669 6577 222c 2274 7970 6522 3a22 6675  view","type":"fu
+0001aea0: 6e63 7469 6f6e 227d 2c7b 2269 6e70 7574  nction"},{"input
+0001aeb0: 7322 3a5b 7b22 636f 6d70 6f6e 656e 7473  s":[{"components
+0001aec0: 223a 5b7b 2269 6e74 6572 6e61 6c54 7970  ":[{"internalTyp
+0001aed0: 6522 3a22 6164 6472 6573 7322 2c22 6e61  e":"address","na
+0001aee0: 6d65 223a 2274 6f6b 656e 3022 2c22 7479  me":"token0","ty
+0001aef0: 7065 223a 2261 6464 7265 7373 227d 2c7b  pe":"address"},{
+0001af00: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001af10: 6164 6472 6573 7322 2c22 6e61 6d65 223a  address","name":
+0001af20: 2274 6f6b 656e 3122 2c22 7479 7065 223a  "token1","type":
+0001af30: 2261 6464 7265 7373 227d 2c7b 2269 6e74  "address"},{"int
+0001af40: 6572 6e61 6c54 7970 6522 3a22 7569 6e74  ernalType":"uint
+0001af50: 3234 222c 226e 616d 6522 3a22 6665 6522  24","name":"fee"
+0001af60: 2c22 7479 7065 223a 2275 696e 7432 3422  ,"type":"uint24"
+0001af70: 7d2c 7b22 696e 7465 726e 616c 5479 7065  },{"internalType
+0001af80: 223a 2269 6e74 3234 222c 226e 616d 6522  ":"int24","name"
+0001af90: 3a22 7469 636b 4c6f 7765 7222 2c22 7479  :"tickLower","ty
+0001afa0: 7065 223a 2269 6e74 3234 227d 2c7b 2269  pe":"int24"},{"i
+0001afb0: 6e74 6572 6e61 6c54 7970 6522 3a22 696e  nternalType":"in
+0001afc0: 7432 3422 2c22 6e61 6d65 223a 2274 6963  t24","name":"tic
+0001afd0: 6b55 7070 6572 222c 2274 7970 6522 3a22  kUpper","type":"
+0001afe0: 696e 7432 3422 7d2c 7b22 696e 7465 726e  int24"},{"intern
+0001aff0: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001b000: 222c 226e 616d 6522 3a22 616d 6f75 6e74  ","name":"amount
+0001b010: 3044 6573 6972 6564 222c 2274 7970 6522  0Desired","type"
+0001b020: 3a22 7569 6e74 3235 3622 7d2c 7b22 696e  :"uint256"},{"in
+0001b030: 7465 726e 616c 5479 7065 223a 2275 696e  ternalType":"uin
+0001b040: 7432 3536 222c 226e 616d 6522 3a22 616d  t256","name":"am
+0001b050: 6f75 6e74 3144 6573 6972 6564 222c 2274  ount1Desired","t
+0001b060: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+0001b070: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b080: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001b090: 3a22 616d 6f75 6e74 304d 696e 222c 2274  :"amount0Min","t
+0001b0a0: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+0001b0b0: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b0c0: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001b0d0: 3a22 616d 6f75 6e74 314d 696e 222c 2274  :"amount1Min","t
+0001b0e0: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+0001b0f0: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b100: 2261 6464 7265 7373 222c 226e 616d 6522  "address","name"
+0001b110: 3a22 7265 6369 7069 656e 7422 2c22 7479  :"recipient","ty
+0001b120: 7065 223a 2261 6464 7265 7373 227d 2c7b  pe":"address"},{
+0001b130: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001b140: 7569 6e74 3235 3622 2c22 6e61 6d65 223a  uint256","name":
+0001b150: 2264 6561 646c 696e 6522 2c22 7479 7065  "deadline","type
+0001b160: 223a 2275 696e 7432 3536 227d 5d2c 2269  ":"uint256"}],"i
+0001b170: 6e74 6572 6e61 6c54 7970 6522 3a22 7374  nternalType":"st
+0001b180: 7275 6374 2049 4e6f 6e66 756e 6769 626c  ruct INonfungibl
+0001b190: 6550 6f73 6974 696f 6e4d 616e 6167 6572  ePositionManager
+0001b1a0: 2e4d 696e 7450 6172 616d 7322 2c22 6e61  .MintParams","na
+0001b1b0: 6d65 223a 2270 6172 616d 7322 2c22 7479  me":"params","ty
+0001b1c0: 7065 223a 2274 7570 6c65 227d 5d2c 226e  pe":"tuple"}],"n
+0001b1d0: 616d 6522 3a22 6d69 6e74 222c 226f 7574  ame":"mint","out
+0001b1e0: 7075 7473 223a 5b7b 2269 6e74 6572 6e61  puts":[{"interna
+0001b1f0: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001b200: 2c22 6e61 6d65 223a 2274 6f6b 656e 4964  ,"name":"tokenId
+0001b210: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001b220: 3622 7d2c 7b22 696e 7465 726e 616c 5479  6"},{"internalTy
+0001b230: 7065 223a 2275 696e 7431 3238 222c 226e  pe":"uint128","n
+0001b240: 616d 6522 3a22 6c69 7175 6964 6974 7922  ame":"liquidity"
+0001b250: 2c22 7479 7065 223a 2275 696e 7431 3238  ,"type":"uint128
+0001b260: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001b270: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+0001b280: 6d65 223a 2261 6d6f 756e 7430 222c 2274  me":"amount0","t
+0001b290: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+0001b2a0: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b2b0: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001b2c0: 3a22 616d 6f75 6e74 3122 2c22 7479 7065  :"amount1","type
+0001b2d0: 223a 2275 696e 7432 3536 227d 5d2c 2273  ":"uint256"}],"s
+0001b2e0: 7461 7465 4d75 7461 6269 6c69 7479 223a  tateMutability":
+0001b2f0: 2270 6179 6162 6c65 222c 2274 7970 6522  "payable","type"
+0001b300: 3a22 6675 6e63 7469 6f6e 227d 2c7b 2269  :"function"},{"i
+0001b310: 6e70 7574 7322 3a5b 7b22 696e 7465 726e  nputs":[{"intern
+0001b320: 616c 5479 7065 223a 2262 7974 6573 5b5d  alType":"bytes[]
+0001b330: 222c 226e 616d 6522 3a22 6461 7461 222c  ","name":"data",
+0001b340: 2274 7970 6522 3a22 6279 7465 735b 5d22  "type":"bytes[]"
+0001b350: 7d5d 2c22 6e61 6d65 223a 226d 756c 7469  }],"name":"multi
+0001b360: 6361 6c6c 222c 226f 7574 7075 7473 223a  call","outputs":
+0001b370: 5b7b 2269 6e74 6572 6e61 6c54 7970 6522  [{"internalType"
+0001b380: 3a22 6279 7465 735b 5d22 2c22 6e61 6d65  :"bytes[]","name
+0001b390: 223a 2272 6573 756c 7473 222c 2274 7970  ":"results","typ
+0001b3a0: 6522 3a22 6279 7465 735b 5d22 7d5d 2c22  e":"bytes[]"}],"
+0001b3b0: 7374 6174 654d 7574 6162 696c 6974 7922  stateMutability"
+0001b3c0: 3a22 7061 7961 626c 6522 2c22 7479 7065  :"payable","type
+0001b3d0: 223a 2266 756e 6374 696f 6e22 7d2c 7b22  ":"function"},{"
+0001b3e0: 696e 7075 7473 223a 5b5d 2c22 6e61 6d65  inputs":[],"name
+0001b3f0: 223a 226e 616d 6522 2c22 6f75 7470 7574  ":"name","output
+0001b400: 7322 3a5b 7b22 696e 7465 726e 616c 5479  s":[{"internalTy
+0001b410: 7065 223a 2273 7472 696e 6722 2c22 6e61  pe":"string","na
+0001b420: 6d65 223a 2222 2c22 7479 7065 223a 2273  me":"","type":"s
+0001b430: 7472 696e 6722 7d5d 2c22 7374 6174 654d  tring"}],"stateM
+0001b440: 7574 6162 696c 6974 7922 3a22 7669 6577  utability":"view
+0001b450: 222c 2274 7970 6522 3a22 6675 6e63 7469  ","type":"functi
+0001b460: 6f6e 227d 2c7b 2269 6e70 7574 7322 3a5b  on"},{"inputs":[
+0001b470: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b480: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001b490: 3a22 746f 6b65 6e49 6422 2c22 7479 7065  :"tokenId","type
+0001b4a0: 223a 2275 696e 7432 3536 227d 5d2c 226e  ":"uint256"}],"n
+0001b4b0: 616d 6522 3a22 6f77 6e65 724f 6622 2c22  ame":"ownerOf","
+0001b4c0: 6f75 7470 7574 7322 3a5b 7b22 696e 7465  outputs":[{"inte
+0001b4d0: 726e 616c 5479 7065 223a 2261 6464 7265  rnalType":"addre
+0001b4e0: 7373 222c 226e 616d 6522 3a22 222c 2274  ss","name":"","t
+0001b4f0: 7970 6522 3a22 6164 6472 6573 7322 7d5d  ype":"address"}]
+0001b500: 2c22 7374 6174 654d 7574 6162 696c 6974  ,"stateMutabilit
+0001b510: 7922 3a22 7669 6577 222c 2274 7970 6522  y":"view","type"
+0001b520: 3a22 6675 6e63 7469 6f6e 227d 2c7b 2269  :"function"},{"i
+0001b530: 6e70 7574 7322 3a5b 7b22 696e 7465 726e  nputs":[{"intern
+0001b540: 616c 5479 7065 223a 2261 6464 7265 7373  alType":"address
+0001b550: 222c 226e 616d 6522 3a22 7370 656e 6465  ","name":"spende
+0001b560: 7222 2c22 7479 7065 223a 2261 6464 7265  r","type":"addre
+0001b570: 7373 227d 2c7b 2269 6e74 6572 6e61 6c54  ss"},{"internalT
+0001b580: 7970 6522 3a22 7569 6e74 3235 3622 2c22  ype":"uint256","
+0001b590: 6e61 6d65 223a 2274 6f6b 656e 4964 222c  name":"tokenId",
+0001b5a0: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+0001b5b0: 7d2c 7b22 696e 7465 726e 616c 5479 7065  },{"internalType
+0001b5c0: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+0001b5d0: 6522 3a22 6465 6164 6c69 6e65 222c 2274  e":"deadline","t
+0001b5e0: 7970 6522 3a22 7569 6e74 3235 3622 7d2c  ype":"uint256"},
+0001b5f0: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b600: 2275 696e 7438 222c 226e 616d 6522 3a22  "uint8","name":"
+0001b610: 7622 2c22 7479 7065 223a 2275 696e 7438  v","type":"uint8
+0001b620: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001b630: 6522 3a22 6279 7465 7333 3222 2c22 6e61  e":"bytes32","na
+0001b640: 6d65 223a 2272 222c 2274 7970 6522 3a22  me":"r","type":"
+0001b650: 6279 7465 7333 3222 7d2c 7b22 696e 7465  bytes32"},{"inte
+0001b660: 726e 616c 5479 7065 223a 2262 7974 6573  rnalType":"bytes
+0001b670: 3332 222c 226e 616d 6522 3a22 7322 2c22  32","name":"s","
+0001b680: 7479 7065 223a 2262 7974 6573 3332 227d  type":"bytes32"}
+0001b690: 5d2c 226e 616d 6522 3a22 7065 726d 6974  ],"name":"permit
+0001b6a0: 222c 226f 7574 7075 7473 223a 5b5d 2c22  ","outputs":[],"
+0001b6b0: 7374 6174 654d 7574 6162 696c 6974 7922  stateMutability"
+0001b6c0: 3a22 7061 7961 626c 6522 2c22 7479 7065  :"payable","type
+0001b6d0: 223a 2266 756e 6374 696f 6e22 7d2c 7b22  ":"function"},{"
+0001b6e0: 696e 7075 7473 223a 5b7b 2269 6e74 6572  inputs":[{"inter
+0001b6f0: 6e61 6c54 7970 6522 3a22 7569 6e74 3235  nalType":"uint25
+0001b700: 3622 2c22 6e61 6d65 223a 2274 6f6b 656e  6","name":"token
+0001b710: 4964 222c 2274 7970 6522 3a22 7569 6e74  Id","type":"uint
+0001b720: 3235 3622 7d5d 2c22 6e61 6d65 223a 2270  256"}],"name":"p
+0001b730: 6f73 6974 696f 6e73 222c 226f 7574 7075  ositions","outpu
+0001b740: 7473 223a 5b7b 2269 6e74 6572 6e61 6c54  ts":[{"internalT
+0001b750: 7970 6522 3a22 7569 6e74 3936 222c 226e  ype":"uint96","n
+0001b760: 616d 6522 3a22 6e6f 6e63 6522 2c22 7479  ame":"nonce","ty
+0001b770: 7065 223a 2275 696e 7439 3622 7d2c 7b22  pe":"uint96"},{"
+0001b780: 696e 7465 726e 616c 5479 7065 223a 2261  internalType":"a
+0001b790: 6464 7265 7373 222c 226e 616d 6522 3a22  ddress","name":"
+0001b7a0: 6f70 6572 6174 6f72 222c 2274 7970 6522  operator","type"
+0001b7b0: 3a22 6164 6472 6573 7322 7d2c 7b22 696e  :"address"},{"in
+0001b7c0: 7465 726e 616c 5479 7065 223a 2261 6464  ternalType":"add
+0001b7d0: 7265 7373 222c 226e 616d 6522 3a22 746f  ress","name":"to
+0001b7e0: 6b65 6e30 222c 2274 7970 6522 3a22 6164  ken0","type":"ad
+0001b7f0: 6472 6573 7322 7d2c 7b22 696e 7465 726e  dress"},{"intern
+0001b800: 616c 5479 7065 223a 2261 6464 7265 7373  alType":"address
+0001b810: 222c 226e 616d 6522 3a22 746f 6b65 6e31  ","name":"token1
+0001b820: 222c 2274 7970 6522 3a22 6164 6472 6573  ","type":"addres
+0001b830: 7322 7d2c 7b22 696e 7465 726e 616c 5479  s"},{"internalTy
+0001b840: 7065 223a 2275 696e 7432 3422 2c22 6e61  pe":"uint24","na
+0001b850: 6d65 223a 2266 6565 222c 2274 7970 6522  me":"fee","type"
+0001b860: 3a22 7569 6e74 3234 227d 2c7b 2269 6e74  :"uint24"},{"int
+0001b870: 6572 6e61 6c54 7970 6522 3a22 696e 7432  ernalType":"int2
+0001b880: 3422 2c22 6e61 6d65 223a 2274 6963 6b4c  4","name":"tickL
+0001b890: 6f77 6572 222c 2274 7970 6522 3a22 696e  ower","type":"in
+0001b8a0: 7432 3422 7d2c 7b22 696e 7465 726e 616c  t24"},{"internal
+0001b8b0: 5479 7065 223a 2269 6e74 3234 222c 226e  Type":"int24","n
+0001b8c0: 616d 6522 3a22 7469 636b 5570 7065 7222  ame":"tickUpper"
+0001b8d0: 2c22 7479 7065 223a 2269 6e74 3234 227d  ,"type":"int24"}
+0001b8e0: 2c7b 2269 6e74 6572 6e61 6c54 7970 6522  ,{"internalType"
+0001b8f0: 3a22 7569 6e74 3132 3822 2c22 6e61 6d65  :"uint128","name
+0001b900: 223a 226c 6971 7569 6469 7479 222c 2274  ":"liquidity","t
+0001b910: 7970 6522 3a22 7569 6e74 3132 3822 7d2c  ype":"uint128"},
+0001b920: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001b930: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001b940: 3a22 6665 6547 726f 7774 6849 6e73 6964  :"feeGrowthInsid
+0001b950: 6530 4c61 7374 5831 3238 222c 2274 7970  e0LastX128","typ
+0001b960: 6522 3a22 7569 6e74 3235 3622 7d2c 7b22  e":"uint256"},{"
+0001b970: 696e 7465 726e 616c 5479 7065 223a 2275  internalType":"u
+0001b980: 696e 7432 3536 222c 226e 616d 6522 3a22  int256","name":"
+0001b990: 6665 6547 726f 7774 6849 6e73 6964 6531  feeGrowthInside1
+0001b9a0: 4c61 7374 5831 3238 222c 2274 7970 6522  LastX128","type"
+0001b9b0: 3a22 7569 6e74 3235 3622 7d2c 7b22 696e  :"uint256"},{"in
+0001b9c0: 7465 726e 616c 5479 7065 223a 2275 696e  ternalType":"uin
+0001b9d0: 7431 3238 222c 226e 616d 6522 3a22 746f  t128","name":"to
+0001b9e0: 6b65 6e73 4f77 6564 3022 2c22 7479 7065  kensOwed0","type
+0001b9f0: 223a 2275 696e 7431 3238 227d 2c7b 2269  ":"uint128"},{"i
+0001ba00: 6e74 6572 6e61 6c54 7970 6522 3a22 7569  nternalType":"ui
+0001ba10: 6e74 3132 3822 2c22 6e61 6d65 223a 2274  nt128","name":"t
+0001ba20: 6f6b 656e 734f 7765 6431 222c 2274 7970  okensOwed1","typ
+0001ba30: 6522 3a22 7569 6e74 3132 3822 7d5d 2c22  e":"uint128"}],"
+0001ba40: 7374 6174 654d 7574 6162 696c 6974 7922  stateMutability"
+0001ba50: 3a22 7669 6577 222c 2274 7970 6522 3a22  :"view","type":"
+0001ba60: 6675 6e63 7469 6f6e 227d 2c7b 2269 6e70  function"},{"inp
+0001ba70: 7574 7322 3a5b 5d2c 226e 616d 6522 3a22  uts":[],"name":"
+0001ba80: 7265 6675 6e64 4554 4822 2c22 6f75 7470  refundETH","outp
+0001ba90: 7574 7322 3a5b 5d2c 2273 7461 7465 4d75  uts":[],"stateMu
+0001baa0: 7461 6269 6c69 7479 223a 2270 6179 6162  tability":"payab
+0001bab0: 6c65 222c 2274 7970 6522 3a22 6675 6e63  le","type":"func
+0001bac0: 7469 6f6e 227d 2c7b 2269 6e70 7574 7322  tion"},{"inputs"
+0001bad0: 3a5b 7b22 696e 7465 726e 616c 5479 7065  :[{"internalType
+0001bae0: 223a 2261 6464 7265 7373 222c 226e 616d  ":"address","nam
+0001baf0: 6522 3a22 6672 6f6d 222c 2274 7970 6522  e":"from","type"
+0001bb00: 3a22 6164 6472 6573 7322 7d2c 7b22 696e  :"address"},{"in
+0001bb10: 7465 726e 616c 5479 7065 223a 2261 6464  ternalType":"add
+0001bb20: 7265 7373 222c 226e 616d 6522 3a22 746f  ress","name":"to
+0001bb30: 222c 2274 7970 6522 3a22 6164 6472 6573  ","type":"addres
+0001bb40: 7322 7d2c 7b22 696e 7465 726e 616c 5479  s"},{"internalTy
+0001bb50: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+0001bb60: 616d 6522 3a22 746f 6b65 6e49 6422 2c22  ame":"tokenId","
+0001bb70: 7479 7065 223a 2275 696e 7432 3536 227d  type":"uint256"}
+0001bb80: 5d2c 226e 616d 6522 3a22 7361 6665 5472  ],"name":"safeTr
+0001bb90: 616e 7366 6572 4672 6f6d 222c 226f 7574  ansferFrom","out
+0001bba0: 7075 7473 223a 5b5d 2c22 7374 6174 654d  puts":[],"stateM
+0001bbb0: 7574 6162 696c 6974 7922 3a22 6e6f 6e70  utability":"nonp
+0001bbc0: 6179 6162 6c65 222c 2274 7970 6522 3a22  ayable","type":"
+0001bbd0: 6675 6e63 7469 6f6e 227d 2c7b 2269 6e70  function"},{"inp
+0001bbe0: 7574 7322 3a5b 7b22 696e 7465 726e 616c  uts":[{"internal
+0001bbf0: 5479 7065 223a 2261 6464 7265 7373 222c  Type":"address",
+0001bc00: 226e 616d 6522 3a22 6672 6f6d 222c 2274  "name":"from","t
+0001bc10: 7970 6522 3a22 6164 6472 6573 7322 7d2c  ype":"address"},
+0001bc20: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001bc30: 2261 6464 7265 7373 222c 226e 616d 6522  "address","name"
+0001bc40: 3a22 746f 222c 2274 7970 6522 3a22 6164  :"to","type":"ad
+0001bc50: 6472 6573 7322 7d2c 7b22 696e 7465 726e  dress"},{"intern
+0001bc60: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001bc70: 222c 226e 616d 6522 3a22 746f 6b65 6e49  ","name":"tokenI
+0001bc80: 6422 2c22 7479 7065 223a 2275 696e 7432  d","type":"uint2
+0001bc90: 3536 227d 2c7b 2269 6e74 6572 6e61 6c54  56"},{"internalT
+0001bca0: 7970 6522 3a22 6279 7465 7322 2c22 6e61  ype":"bytes","na
+0001bcb0: 6d65 223a 225f 6461 7461 222c 2274 7970  me":"_data","typ
+0001bcc0: 6522 3a22 6279 7465 7322 7d5d 2c22 6e61  e":"bytes"}],"na
+0001bcd0: 6d65 223a 2273 6166 6554 7261 6e73 6665  me":"safeTransfe
+0001bce0: 7246 726f 6d22 2c22 6f75 7470 7574 7322  rFrom","outputs"
+0001bcf0: 3a5b 5d2c 2273 7461 7465 4d75 7461 6269  :[],"stateMutabi
+0001bd00: 6c69 7479 223a 226e 6f6e 7061 7961 626c  lity":"nonpayabl
+0001bd10: 6522 2c22 7479 7065 223a 2266 756e 6374  e","type":"funct
+0001bd20: 696f 6e22 7d2c 7b22 696e 7075 7473 223a  ion"},{"inputs":
+0001bd30: 5b7b 2269 6e74 6572 6e61 6c54 7970 6522  [{"internalType"
+0001bd40: 3a22 6164 6472 6573 7322 2c22 6e61 6d65  :"address","name
+0001bd50: 223a 2274 6f6b 656e 222c 2274 7970 6522  ":"token","type"
+0001bd60: 3a22 6164 6472 6573 7322 7d2c 7b22 696e  :"address"},{"in
+0001bd70: 7465 726e 616c 5479 7065 223a 2275 696e  ternalType":"uin
+0001bd80: 7432 3536 222c 226e 616d 6522 3a22 7661  t256","name":"va
+0001bd90: 6c75 6522 2c22 7479 7065 223a 2275 696e  lue","type":"uin
+0001bda0: 7432 3536 227d 2c7b 2269 6e74 6572 6e61  t256"},{"interna
+0001bdb0: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001bdc0: 2c22 6e61 6d65 223a 2264 6561 646c 696e  ,"name":"deadlin
+0001bdd0: 6522 2c22 7479 7065 223a 2275 696e 7432  e","type":"uint2
+0001bde0: 3536 227d 2c7b 2269 6e74 6572 6e61 6c54  56"},{"internalT
+0001bdf0: 7970 6522 3a22 7569 6e74 3822 2c22 6e61  ype":"uint8","na
+0001be00: 6d65 223a 2276 222c 2274 7970 6522 3a22  me":"v","type":"
+0001be10: 7569 6e74 3822 7d2c 7b22 696e 7465 726e  uint8"},{"intern
+0001be20: 616c 5479 7065 223a 2262 7974 6573 3332  alType":"bytes32
+0001be30: 222c 226e 616d 6522 3a22 7222 2c22 7479  ","name":"r","ty
+0001be40: 7065 223a 2262 7974 6573 3332 227d 2c7b  pe":"bytes32"},{
+0001be50: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001be60: 6279 7465 7333 3222 2c22 6e61 6d65 223a  bytes32","name":
+0001be70: 2273 222c 2274 7970 6522 3a22 6279 7465  "s","type":"byte
+0001be80: 7333 3222 7d5d 2c22 6e61 6d65 223a 2273  s32"}],"name":"s
+0001be90: 656c 6650 6572 6d69 7422 2c22 6f75 7470  elfPermit","outp
+0001bea0: 7574 7322 3a5b 5d2c 2273 7461 7465 4d75  uts":[],"stateMu
+0001beb0: 7461 6269 6c69 7479 223a 2270 6179 6162  tability":"payab
+0001bec0: 6c65 222c 2274 7970 6522 3a22 6675 6e63  le","type":"func
+0001bed0: 7469 6f6e 227d 2c7b 2269 6e70 7574 7322  tion"},{"inputs"
+0001bee0: 3a5b 7b22 696e 7465 726e 616c 5479 7065  :[{"internalType
+0001bef0: 223a 2261 6464 7265 7373 222c 226e 616d  ":"address","nam
+0001bf00: 6522 3a22 746f 6b65 6e22 2c22 7479 7065  e":"token","type
+0001bf10: 223a 2261 6464 7265 7373 227d 2c7b 2269  ":"address"},{"i
+0001bf20: 6e74 6572 6e61 6c54 7970 6522 3a22 7569  nternalType":"ui
+0001bf30: 6e74 3235 3622 2c22 6e61 6d65 223a 226e  nt256","name":"n
+0001bf40: 6f6e 6365 222c 2274 7970 6522 3a22 7569  once","type":"ui
+0001bf50: 6e74 3235 3622 7d2c 7b22 696e 7465 726e  nt256"},{"intern
+0001bf60: 616c 5479 7065 223a 2275 696e 7432 3536  alType":"uint256
+0001bf70: 222c 226e 616d 6522 3a22 6578 7069 7279  ","name":"expiry
+0001bf80: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001bf90: 3622 7d2c 7b22 696e 7465 726e 616c 5479  6"},{"internalTy
+0001bfa0: 7065 223a 2275 696e 7438 222c 226e 616d  pe":"uint8","nam
+0001bfb0: 6522 3a22 7622 2c22 7479 7065 223a 2275  e":"v","type":"u
+0001bfc0: 696e 7438 227d 2c7b 2269 6e74 6572 6e61  int8"},{"interna
+0001bfd0: 6c54 7970 6522 3a22 6279 7465 7333 3222  lType":"bytes32"
+0001bfe0: 2c22 6e61 6d65 223a 2272 222c 2274 7970  ,"name":"r","typ
+0001bff0: 6522 3a22 6279 7465 7333 3222 7d2c 7b22  e":"bytes32"},{"
+0001c000: 696e 7465 726e 616c 5479 7065 223a 2262  internalType":"b
+0001c010: 7974 6573 3332 222c 226e 616d 6522 3a22  ytes32","name":"
+0001c020: 7322 2c22 7479 7065 223a 2262 7974 6573  s","type":"bytes
+0001c030: 3332 227d 5d2c 226e 616d 6522 3a22 7365  32"}],"name":"se
+0001c040: 6c66 5065 726d 6974 416c 6c6f 7765 6422  lfPermitAllowed"
+0001c050: 2c22 6f75 7470 7574 7322 3a5b 5d2c 2273  ,"outputs":[],"s
+0001c060: 7461 7465 4d75 7461 6269 6c69 7479 223a  tateMutability":
+0001c070: 2270 6179 6162 6c65 222c 2274 7970 6522  "payable","type"
+0001c080: 3a22 6675 6e63 7469 6f6e 227d 2c7b 2269  :"function"},{"i
+0001c090: 6e70 7574 7322 3a5b 7b22 696e 7465 726e  nputs":[{"intern
+0001c0a0: 616c 5479 7065 223a 2261 6464 7265 7373  alType":"address
+0001c0b0: 222c 226e 616d 6522 3a22 746f 6b65 6e22  ","name":"token"
+0001c0c0: 2c22 7479 7065 223a 2261 6464 7265 7373  ,"type":"address
+0001c0d0: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001c0e0: 6522 3a22 7569 6e74 3235 3622 2c22 6e61  e":"uint256","na
+0001c0f0: 6d65 223a 226e 6f6e 6365 222c 2274 7970  me":"nonce","typ
+0001c100: 6522 3a22 7569 6e74 3235 3622 7d2c 7b22  e":"uint256"},{"
+0001c110: 696e 7465 726e 616c 5479 7065 223a 2275  internalType":"u
+0001c120: 696e 7432 3536 222c 226e 616d 6522 3a22  int256","name":"
+0001c130: 6578 7069 7279 222c 2274 7970 6522 3a22  expiry","type":"
+0001c140: 7569 6e74 3235 3622 7d2c 7b22 696e 7465  uint256"},{"inte
+0001c150: 726e 616c 5479 7065 223a 2275 696e 7438  rnalType":"uint8
+0001c160: 222c 226e 616d 6522 3a22 7622 2c22 7479  ","name":"v","ty
+0001c170: 7065 223a 2275 696e 7438 227d 2c7b 2269  pe":"uint8"},{"i
+0001c180: 6e74 6572 6e61 6c54 7970 6522 3a22 6279  nternalType":"by
+0001c190: 7465 7333 3222 2c22 6e61 6d65 223a 2272  tes32","name":"r
+0001c1a0: 222c 2274 7970 6522 3a22 6279 7465 7333  ","type":"bytes3
+0001c1b0: 3222 7d2c 7b22 696e 7465 726e 616c 5479  2"},{"internalTy
+0001c1c0: 7065 223a 2262 7974 6573 3332 222c 226e  pe":"bytes32","n
+0001c1d0: 616d 6522 3a22 7322 2c22 7479 7065 223a  ame":"s","type":
+0001c1e0: 2262 7974 6573 3332 227d 5d2c 226e 616d  "bytes32"}],"nam
+0001c1f0: 6522 3a22 7365 6c66 5065 726d 6974 416c  e":"selfPermitAl
+0001c200: 6c6f 7765 6449 664e 6563 6573 7361 7279  lowedIfNecessary
+0001c210: 222c 226f 7574 7075 7473 223a 5b5d 2c22  ","outputs":[],"
+0001c220: 7374 6174 654d 7574 6162 696c 6974 7922  stateMutability"
+0001c230: 3a22 7061 7961 626c 6522 2c22 7479 7065  :"payable","type
+0001c240: 223a 2266 756e 6374 696f 6e22 7d2c 7b22  ":"function"},{"
+0001c250: 696e 7075 7473 223a 5b7b 2269 6e74 6572  inputs":[{"inter
+0001c260: 6e61 6c54 7970 6522 3a22 6164 6472 6573  nalType":"addres
+0001c270: 7322 2c22 6e61 6d65 223a 2274 6f6b 656e  s","name":"token
+0001c280: 222c 2274 7970 6522 3a22 6164 6472 6573  ","type":"addres
+0001c290: 7322 7d2c 7b22 696e 7465 726e 616c 5479  s"},{"internalTy
+0001c2a0: 7065 223a 2275 696e 7432 3536 222c 226e  pe":"uint256","n
+0001c2b0: 616d 6522 3a22 7661 6c75 6522 2c22 7479  ame":"value","ty
+0001c2c0: 7065 223a 2275 696e 7432 3536 227d 2c7b  pe":"uint256"},{
+0001c2d0: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001c2e0: 7569 6e74 3235 3622 2c22 6e61 6d65 223a  uint256","name":
+0001c2f0: 2264 6561 646c 696e 6522 2c22 7479 7065  "deadline","type
+0001c300: 223a 2275 696e 7432 3536 227d 2c7b 2269  ":"uint256"},{"i
+0001c310: 6e74 6572 6e61 6c54 7970 6522 3a22 7569  nternalType":"ui
+0001c320: 6e74 3822 2c22 6e61 6d65 223a 2276 222c  nt8","name":"v",
+0001c330: 2274 7970 6522 3a22 7569 6e74 3822 7d2c  "type":"uint8"},
+0001c340: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001c350: 2262 7974 6573 3332 222c 226e 616d 6522  "bytes32","name"
+0001c360: 3a22 7222 2c22 7479 7065 223a 2262 7974  :"r","type":"byt
+0001c370: 6573 3332 227d 2c7b 2269 6e74 6572 6e61  es32"},{"interna
+0001c380: 6c54 7970 6522 3a22 6279 7465 7333 3222  lType":"bytes32"
+0001c390: 2c22 6e61 6d65 223a 2273 222c 2274 7970  ,"name":"s","typ
+0001c3a0: 6522 3a22 6279 7465 7333 3222 7d5d 2c22  e":"bytes32"}],"
+0001c3b0: 6e61 6d65 223a 2273 656c 6650 6572 6d69  name":"selfPermi
+0001c3c0: 7449 664e 6563 6573 7361 7279 222c 226f  tIfNecessary","o
+0001c3d0: 7574 7075 7473 223a 5b5d 2c22 7374 6174  utputs":[],"stat
+0001c3e0: 654d 7574 6162 696c 6974 7922 3a22 7061  eMutability":"pa
+0001c3f0: 7961 626c 6522 2c22 7479 7065 223a 2266  yable","type":"f
+0001c400: 756e 6374 696f 6e22 7d2c 7b22 696e 7075  unction"},{"inpu
+0001c410: 7473 223a 5b7b 2269 6e74 6572 6e61 6c54  ts":[{"internalT
+0001c420: 7970 6522 3a22 6164 6472 6573 7322 2c22  ype":"address","
+0001c430: 6e61 6d65 223a 226f 7065 7261 746f 7222  name":"operator"
+0001c440: 2c22 7479 7065 223a 2261 6464 7265 7373  ,"type":"address
+0001c450: 227d 2c7b 2269 6e74 6572 6e61 6c54 7970  "},{"internalTyp
+0001c460: 6522 3a22 626f 6f6c 222c 226e 616d 6522  e":"bool","name"
+0001c470: 3a22 6170 7072 6f76 6564 222c 2274 7970  :"approved","typ
+0001c480: 6522 3a22 626f 6f6c 227d 5d2c 226e 616d  e":"bool"}],"nam
+0001c490: 6522 3a22 7365 7441 7070 726f 7661 6c46  e":"setApprovalF
+0001c4a0: 6f72 416c 6c22 2c22 6f75 7470 7574 7322  orAll","outputs"
+0001c4b0: 3a5b 5d2c 2273 7461 7465 4d75 7461 6269  :[],"stateMutabi
+0001c4c0: 6c69 7479 223a 226e 6f6e 7061 7961 626c  lity":"nonpayabl
+0001c4d0: 6522 2c22 7479 7065 223a 2266 756e 6374  e","type":"funct
+0001c4e0: 696f 6e22 7d2c 7b22 696e 7075 7473 223a  ion"},{"inputs":
+0001c4f0: 5b7b 2269 6e74 6572 6e61 6c54 7970 6522  [{"internalType"
+0001c500: 3a22 6279 7465 7334 222c 226e 616d 6522  :"bytes4","name"
+0001c510: 3a22 696e 7465 7266 6163 6549 6422 2c22  :"interfaceId","
+0001c520: 7479 7065 223a 2262 7974 6573 3422 7d5d  type":"bytes4"}]
+0001c530: 2c22 6e61 6d65 223a 2273 7570 706f 7274  ,"name":"support
+0001c540: 7349 6e74 6572 6661 6365 222c 226f 7574  sInterface","out
+0001c550: 7075 7473 223a 5b7b 2269 6e74 6572 6e61  puts":[{"interna
+0001c560: 6c54 7970 6522 3a22 626f 6f6c 222c 226e  lType":"bool","n
+0001c570: 616d 6522 3a22 222c 2274 7970 6522 3a22  ame":"","type":"
+0001c580: 626f 6f6c 227d 5d2c 2273 7461 7465 4d75  bool"}],"stateMu
+0001c590: 7461 6269 6c69 7479 223a 2276 6965 7722  tability":"view"
+0001c5a0: 2c22 7479 7065 223a 2266 756e 6374 696f  ,"type":"functio
+0001c5b0: 6e22 7d2c 7b22 696e 7075 7473 223a 5b7b  n"},{"inputs":[{
+0001c5c0: 2269 6e74 6572 6e61 6c54 7970 6522 3a22  "internalType":"
+0001c5d0: 6164 6472 6573 7322 2c22 6e61 6d65 223a  address","name":
+0001c5e0: 2274 6f6b 656e 222c 2274 7970 6522 3a22  "token","type":"
+0001c5f0: 6164 6472 6573 7322 7d2c 7b22 696e 7465  address"},{"inte
+0001c600: 726e 616c 5479 7065 223a 2275 696e 7432  rnalType":"uint2
+0001c610: 3536 222c 226e 616d 6522 3a22 616d 6f75  56","name":"amou
+0001c620: 6e74 4d69 6e69 6d75 6d22 2c22 7479 7065  ntMinimum","type
+0001c630: 223a 2275 696e 7432 3536 227d 2c7b 2269  ":"uint256"},{"i
+0001c640: 6e74 6572 6e61 6c54 7970 6522 3a22 6164  nternalType":"ad
+0001c650: 6472 6573 7322 2c22 6e61 6d65 223a 2272  dress","name":"r
+0001c660: 6563 6970 6965 6e74 222c 2274 7970 6522  ecipient","type"
+0001c670: 3a22 6164 6472 6573 7322 7d5d 2c22 6e61  :"address"}],"na
+0001c680: 6d65 223a 2273 7765 6570 546f 6b65 6e22  me":"sweepToken"
+0001c690: 2c22 6f75 7470 7574 7322 3a5b 5d2c 2273  ,"outputs":[],"s
+0001c6a0: 7461 7465 4d75 7461 6269 6c69 7479 223a  tateMutability":
+0001c6b0: 2270 6179 6162 6c65 222c 2274 7970 6522  "payable","type"
+0001c6c0: 3a22 6675 6e63 7469 6f6e 227d 2c7b 2269  :"function"},{"i
+0001c6d0: 6e70 7574 7322 3a5b 5d2c 226e 616d 6522  nputs":[],"name"
+0001c6e0: 3a22 7379 6d62 6f6c 222c 226f 7574 7075  :"symbol","outpu
+0001c6f0: 7473 223a 5b7b 2269 6e74 6572 6e61 6c54  ts":[{"internalT
+0001c700: 7970 6522 3a22 7374 7269 6e67 222c 226e  ype":"string","n
+0001c710: 616d 6522 3a22 222c 2274 7970 6522 3a22  ame":"","type":"
+0001c720: 7374 7269 6e67 227d 5d2c 2273 7461 7465  string"}],"state
+0001c730: 4d75 7461 6269 6c69 7479 223a 2276 6965  Mutability":"vie
+0001c740: 7722 2c22 7479 7065 223a 2266 756e 6374  w","type":"funct
+0001c750: 696f 6e22 7d2c 7b22 696e 7075 7473 223a  ion"},{"inputs":
+0001c760: 5b7b 2269 6e74 6572 6e61 6c54 7970 6522  [{"internalType"
+0001c770: 3a22 7569 6e74 3235 3622 2c22 6e61 6d65  :"uint256","name
+0001c780: 223a 2269 6e64 6578 222c 2274 7970 6522  ":"index","type"
+0001c790: 3a22 7569 6e74 3235 3622 7d5d 2c22 6e61  :"uint256"}],"na
+0001c7a0: 6d65 223a 2274 6f6b 656e 4279 496e 6465  me":"tokenByInde
+0001c7b0: 7822 2c22 6f75 7470 7574 7322 3a5b 7b22  x","outputs":[{"
+0001c7c0: 696e 7465 726e 616c 5479 7065 223a 2275  internalType":"u
+0001c7d0: 696e 7432 3536 222c 226e 616d 6522 3a22  int256","name":"
+0001c7e0: 222c 2274 7970 6522 3a22 7569 6e74 3235  ","type":"uint25
+0001c7f0: 3622 7d5d 2c22 7374 6174 654d 7574 6162  6"}],"stateMutab
+0001c800: 696c 6974 7922 3a22 7669 6577 222c 2274  ility":"view","t
+0001c810: 7970 6522 3a22 6675 6e63 7469 6f6e 227d  ype":"function"}
+0001c820: 2c7b 2269 6e70 7574 7322 3a5b 7b22 696e  ,{"inputs":[{"in
+0001c830: 7465 726e 616c 5479 7065 223a 2261 6464  ternalType":"add
+0001c840: 7265 7373 222c 226e 616d 6522 3a22 6f77  ress","name":"ow
+0001c850: 6e65 7222 2c22 7479 7065 223a 2261 6464  ner","type":"add
+0001c860: 7265 7373 227d 2c7b 2269 6e74 6572 6e61  ress"},{"interna
+0001c870: 6c54 7970 6522 3a22 7569 6e74 3235 3622  lType":"uint256"
+0001c880: 2c22 6e61 6d65 223a 2269 6e64 6578 222c  ,"name":"index",
+0001c890: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+0001c8a0: 7d5d 2c22 6e61 6d65 223a 2274 6f6b 656e  }],"name":"token
+0001c8b0: 4f66 4f77 6e65 7242 7949 6e64 6578 222c  OfOwnerByIndex",
+0001c8c0: 226f 7574 7075 7473 223a 5b7b 2269 6e74  "outputs":[{"int
+0001c8d0: 6572 6e61 6c54 7970 6522 3a22 7569 6e74  ernalType":"uint
+0001c8e0: 3235 3622 2c22 6e61 6d65 223a 2222 2c22  256","name":"","
+0001c8f0: 7479 7065 223a 2275 696e 7432 3536 227d  type":"uint256"}
+0001c900: 5d2c 2273 7461 7465 4d75 7461 6269 6c69  ],"stateMutabili
+0001c910: 7479 223a 2276 6965 7722 2c22 7479 7065  ty":"view","type
+0001c920: 223a 2266 756e 6374 696f 6e22 7d2c 7b22  ":"function"},{"
+0001c930: 696e 7075 7473 223a 5b7b 2269 6e74 6572  inputs":[{"inter
+0001c940: 6e61 6c54 7970 6522 3a22 7569 6e74 3235  nalType":"uint25
+0001c950: 3622 2c22 6e61 6d65 223a 2274 6f6b 656e  6","name":"token
+0001c960: 4964 222c 2274 7970 6522 3a22 7569 6e74  Id","type":"uint
+0001c970: 3235 3622 7d5d 2c22 6e61 6d65 223a 2274  256"}],"name":"t
+0001c980: 6f6b 656e 5552 4922 2c22 6f75 7470 7574  okenURI","output
+0001c990: 7322 3a5b 7b22 696e 7465 726e 616c 5479  s":[{"internalTy
+0001c9a0: 7065 223a 2273 7472 696e 6722 2c22 6e61  pe":"string","na
+0001c9b0: 6d65 223a 2222 2c22 7479 7065 223a 2273  me":"","type":"s
+0001c9c0: 7472 696e 6722 7d5d 2c22 7374 6174 654d  tring"}],"stateM
+0001c9d0: 7574 6162 696c 6974 7922 3a22 7669 6577  utability":"view
+0001c9e0: 222c 2274 7970 6522 3a22 6675 6e63 7469  ","type":"functi
+0001c9f0: 6f6e 227d 2c7b 2269 6e70 7574 7322 3a5b  on"},{"inputs":[
+0001ca00: 5d2c 226e 616d 6522 3a22 746f 7461 6c53  ],"name":"totalS
+0001ca10: 7570 706c 7922 2c22 6f75 7470 7574 7322  upply","outputs"
+0001ca20: 3a5b 7b22 696e 7465 726e 616c 5479 7065  :[{"internalType
+0001ca30: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+0001ca40: 6522 3a22 222c 2274 7970 6522 3a22 7569  e":"","type":"ui
+0001ca50: 6e74 3235 3622 7d5d 2c22 7374 6174 654d  nt256"}],"stateM
+0001ca60: 7574 6162 696c 6974 7922 3a22 7669 6577  utability":"view
+0001ca70: 222c 2274 7970 6522 3a22 6675 6e63 7469  ","type":"functi
+0001ca80: 6f6e 227d 2c7b 2269 6e70 7574 7322 3a5b  on"},{"inputs":[
+0001ca90: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001caa0: 2261 6464 7265 7373 222c 226e 616d 6522  "address","name"
+0001cab0: 3a22 6672 6f6d 222c 2274 7970 6522 3a22  :"from","type":"
+0001cac0: 6164 6472 6573 7322 7d2c 7b22 696e 7465  address"},{"inte
+0001cad0: 726e 616c 5479 7065 223a 2261 6464 7265  rnalType":"addre
+0001cae0: 7373 222c 226e 616d 6522 3a22 746f 222c  ss","name":"to",
+0001caf0: 2274 7970 6522 3a22 6164 6472 6573 7322  "type":"address"
+0001cb00: 7d2c 7b22 696e 7465 726e 616c 5479 7065  },{"internalType
+0001cb10: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+0001cb20: 6522 3a22 746f 6b65 6e49 6422 2c22 7479  e":"tokenId","ty
+0001cb30: 7065 223a 2275 696e 7432 3536 227d 5d2c  pe":"uint256"}],
+0001cb40: 226e 616d 6522 3a22 7472 616e 7366 6572  "name":"transfer
+0001cb50: 4672 6f6d 222c 226f 7574 7075 7473 223a  From","outputs":
+0001cb60: 5b5d 2c22 7374 6174 654d 7574 6162 696c  [],"stateMutabil
+0001cb70: 6974 7922 3a22 6e6f 6e70 6179 6162 6c65  ity":"nonpayable
+0001cb80: 222c 2274 7970 6522 3a22 6675 6e63 7469  ","type":"functi
+0001cb90: 6f6e 227d 2c7b 2269 6e70 7574 7322 3a5b  on"},{"inputs":[
+0001cba0: 7b22 696e 7465 726e 616c 5479 7065 223a  {"internalType":
+0001cbb0: 2275 696e 7432 3536 222c 226e 616d 6522  "uint256","name"
+0001cbc0: 3a22 616d 6f75 6e74 304f 7765 6422 2c22  :"amount0Owed","
+0001cbd0: 7479 7065 223a 2275 696e 7432 3536 227d  type":"uint256"}
+0001cbe0: 2c7b 2269 6e74 6572 6e61 6c54 7970 6522  ,{"internalType"
+0001cbf0: 3a22 7569 6e74 3235 3622 2c22 6e61 6d65  :"uint256","name
+0001cc00: 223a 2261 6d6f 756e 7431 4f77 6564 222c  ":"amount1Owed",
+0001cc10: 2274 7970 6522 3a22 7569 6e74 3235 3622  "type":"uint256"
+0001cc20: 7d2c 7b22 696e 7465 726e 616c 5479 7065  },{"internalType
+0001cc30: 223a 2262 7974 6573 222c 226e 616d 6522  ":"bytes","name"
+0001cc40: 3a22 6461 7461 222c 2274 7970 6522 3a22  :"data","type":"
+0001cc50: 6279 7465 7322 7d5d 2c22 6e61 6d65 223a  bytes"}],"name":
+0001cc60: 2275 6e69 7377 6170 5633 4d69 6e74 4361  "uniswapV3MintCa
+0001cc70: 6c6c 6261 636b 222c 226f 7574 7075 7473  llback","outputs
+0001cc80: 223a 5b5d 2c22 7374 6174 654d 7574 6162  ":[],"stateMutab
+0001cc90: 696c 6974 7922 3a22 6e6f 6e70 6179 6162  ility":"nonpayab
+0001cca0: 6c65 222c 2274 7970 6522 3a22 6675 6e63  le","type":"func
+0001ccb0: 7469 6f6e 227d 2c7b 2269 6e70 7574 7322  tion"},{"inputs"
+0001ccc0: 3a5b 7b22 696e 7465 726e 616c 5479 7065  :[{"internalType
+0001ccd0: 223a 2275 696e 7432 3536 222c 226e 616d  ":"uint256","nam
+0001cce0: 6522 3a22 616d 6f75 6e74 4d69 6e69 6d75  e":"amountMinimu
+0001ccf0: 6d22 2c22 7479 7065 223a 2275 696e 7432  m","type":"uint2
+0001cd00: 3536 227d 2c7b 2269 6e74 6572 6e61 6c54  56"},{"internalT
+0001cd10: 7970 6522 3a22 6164 6472 6573 7322 2c22  ype":"address","
+0001cd20: 6e61 6d65 223a 2272 6563 6970 6965 6e74  name":"recipient
+0001cd30: 222c 2274 7970 6522 3a22 6164 6472 6573  ","type":"addres
+0001cd40: 7322 7d5d 2c22 6e61 6d65 223a 2275 6e77  s"}],"name":"unw
+0001cd50: 7261 7057 4554 4839 222c 226f 7574 7075  rapWETH9","outpu
+0001cd60: 7473 223a 5b5d 2c22 7374 6174 654d 7574  ts":[],"stateMut
+0001cd70: 6162 696c 6974 7922 3a22 7061 7961 626c  ability":"payabl
+0001cd80: 6522 2c22 7479 7065 223a 2266 756e 6374  e","type":"funct
+0001cd90: 696f 6e22 7d2c 7b22 7374 6174 654d 7574  ion"},{"stateMut
+0001cda0: 6162 696c 6974 7922 3a22 7061 7961 626c  ability":"payabl
+0001cdb0: 6522 2c22 7479 7065 223a 2272 6563 6569  e","type":"recei
+0001cdc0: 7665 227d 5d0a 2020 2020 2020 2020 2020  ve"}].          
+0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cde0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce00: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0001ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce20: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0001ce30: 2020 2020 2020 2020 2020 2020 2320 4c6f              # Lo
+0001ce40: 6f6b 2075 7020 6c69 7175 6964 6974 7920  ok up liquidity 
+0001ce50: 706f 7369 7469 6f6e 2028 4e46 5420 706f  position (NFT po
+0001ce60: 7369 7469 6f6e 7320 7265 636f 7264 6564  sitions recorded
+0001ce70: 2062 7920 3078 4333 3634 3432 6234 6134   by 0xC36442b4a4
+0001ce80: 3532 3245 3837 3133 3939 4344 3731 3761  522E871399CD717a
+0001ce90: 4244 4438 3437 4162 3131 4645 3838 290a  BDD847Ab11FE88).
+0001cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ceb0: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ced0: 2020 2020 2020 5f6e 6f6e 6365 2c0a 2020        _nonce,.  
+0001cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cef0: 2020 2020 2020 2020 2020 5f6f 7065 7261            _opera
+0001cf00: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+0001cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf20: 205f 746f 6b65 6e30 2c0a 2020 2020 2020   _token0,.      
+0001cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf40: 2020 2020 2020 5f74 6f6b 656e 312c 0a20        _token1,. 
+0001cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf60: 2020 2020 2020 2020 2020 205f 6665 652c             _fee,
+0001cf70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf80: 2020 2020 2020 2020 2020 2020 205f 7469               _ti
+0001cf90: 636b 5f6c 6f77 6572 2c0a 2020 2020 2020  ck_lower,.      
+0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cfb0: 2020 2020 2020 5f74 6963 6b5f 7570 7065        _tick_uppe
+0001cfc0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0001cfd0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0001cfe0: 6c69 7175 6964 6974 792c 0a20 2020 2020  liquidity,.     
+0001cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d000: 2020 2020 2020 202a 5f2c 0a20 2020 2020         *_,.     
+0001d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d020: 2020 2029 203d 2070 6f73 6974 696f 6e73     ) = positions
+0001d030: 5f63 6f6e 7472 6163 742e 6675 6e63 7469  _contract.functi
+0001d040: 6f6e 732e 706f 7369 7469 6f6e 7328 746f  ons.positions(to
+0001d050: 6b65 6e5f 6964 292e 6361 6c6c 2829 0a20  ken_id).call(). 
+0001d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d070: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0001d080: 666f 2866 227b 5f74 6963 6b5f 6c6f 7765  fo(f"{_tick_lowe
+0001d090: 723d 7d22 290a 2020 2020 2020 2020 2020  r=}").          
+0001d0a0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001d0b0: 6767 6572 2e69 6e66 6f28 6622 7b5f 7469  gger.info(f"{_ti
+0001d0c0: 636b 5f75 7070 6572 3d7d 2229 0a0a 2020  ck_upper=}")..  
+0001d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d0e0: 2020 2020 2020 7633 5f70 6f6f 6c20 3d20        v3_pool = 
+0001d0f0: 7365 6c66 2e76 335f 706f 6f6c 5f6d 616e  self.v3_pool_man
+0001d100: 6167 6572 2e67 6574 5f70 6f6f 6c28 0a20  ager.get_pool(. 
+0001d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d120: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0001d130: 5f61 6464 7265 7373 6573 3d28 746f 6b65  _addresses=(toke
+0001d140: 6e30 2c20 746f 6b65 6e31 292c 0a20 2020  n0, token1),.   
+0001d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d160: 2020 2020 2020 2020 2070 6f6f 6c5f 6665           pool_fe
+0001d170: 653d 5f66 6565 2c0a 2020 2020 2020 2020  e=_fee,.        
+0001d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d190: 2020 2020 7369 6c65 6e74 3d73 656c 662e      silent=self.
+0001d1a0: 7369 6c65 6e74 2c0a 2020 2020 2020 2020  silent,.        
+0001d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1c0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001d1d0: 2020 2020 2020 2020 2020 2073 7172 7452             sqrtR
+0001d1e0: 6174 696f 4158 3936 203d 2054 6963 6b4d  atioAX96 = TickM
+0001d1f0: 6174 682e 6765 7453 7172 7452 6174 696f  ath.getSqrtRatio
+0001d200: 4174 5469 636b 285f 7469 636b 5f6c 6f77  AtTick(_tick_low
+0001d210: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+0001d220: 2020 2020 2020 2020 2020 2020 7371 7274              sqrt
+0001d230: 5261 7469 6f42 5839 3620 3d20 5469 636b  RatioBX96 = Tick
+0001d240: 4d61 7468 2e67 6574 5371 7274 5261 7469  Math.getSqrtRati
+0001d250: 6f41 7454 6963 6b28 5f74 6963 6b5f 7570  oAtTick(_tick_up
+0001d260: 7065 7229 0a0a 2020 2020 2020 2020 2020  per)..          
+0001d270: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0001d280: 7272 656e 745f 7371 7274 5f70 7269 6365  rrent_sqrt_price
+0001d290: 5f78 3936 203d 2028 0a20 2020 2020 2020  _x96 = (.       
+0001d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2b0: 2020 2020 2023 2054 4f44 4f3a 2072 6576       # TODO: rev
+0001d2c0: 6965 7720 7468 6973 2c20 6368 6563 6b20  iew this, check 
+0001d2d0: 666f 7220 6561 726c 6965 7220 706f 6f6c  for earlier pool
+0001d2e0: 2073 7461 7465 7320 7468 6174 206d 6179   states that may
+0001d2f0: 2064 6966 6665 720a 2020 2020 2020 2020   differ.        
+0001d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d310: 2020 2020 7633 5f70 6f6f 6c2e 7371 7274      v3_pool.sqrt
+0001d320: 5f70 7269 6365 5f78 3936 0a20 2020 2020  _price_x96.     
+0001d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d340: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0001d350: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001d360: 4765 7420 6164 6465 6420 6c69 7175 6964  Get added liquid
+0001d370: 6974 7920 284c 6971 7569 6469 7479 4d61  ity (LiquidityMa
+0001d380: 6e61 6765 6d65 6e74 2e73 6f6c 290a 2020  nagement.sol).  
+0001d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3a0: 2020 2020 2020 6164 6465 645f 6c69 7175        added_liqu
+0001d3b0: 6964 6974 7920 3d20 6765 744c 6971 7569  idity = getLiqui
+0001d3c0: 6469 7479 466f 7241 6d6f 756e 7473 280a  dityForAmounts(.
+0001d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3e0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001d3f0: 656e 745f 7371 7274 5f70 7269 6365 5f78  ent_sqrt_price_x
+0001d400: 3936 2c0a 2020 2020 2020 2020 2020 2020  96,.            
+0001d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d420: 7371 7274 5261 7469 6f41 5839 362c 0a20  sqrtRatioAX96,. 
+0001d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d440: 2020 2020 2020 2020 2020 2073 7172 7452             sqrtR
+0001d450: 6174 696f 4258 3936 2c0a 2020 2020 2020  atioBX96,.      
+0001d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d470: 2020 2020 2020 616d 6f75 6e74 305f 6465        amount0_de
+0001d480: 7369 7265 642c 0a20 2020 2020 2020 2020  sired,.         
+0001d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4a0: 2020 2061 6d6f 756e 7431 5f64 6573 6972     amount1_desir
+0001d4b0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+0001d4c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4e0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+0001d4f0: 6f28 6622 7b61 6464 6564 5f6c 6971 7569  o(f"{added_liqui
+0001d500: 6469 7479 3d7d 2229 0a0a 2020 2020 2020  dity=}")..      
+0001d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d520: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
+0001d530: 6561 7263 6869 6e67 2066 6f72 2070 6f6f  earching for poo
+0001d540: 6c20 696e 2070 6f6f 6c20 7374 6174 6573  l in pool states
+0001d550: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
+0001d560: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001d570: 7220 706f 6f6c 2c20 7374 6174 6520 696e  r pool, state in
+0001d580: 2073 656c 662e 7369 6d75 6c61 7465 645f   self.simulated_
+0001d590: 706f 6f6c 5f73 7461 7465 733a 0a20 2020  pool_states:.   
+0001d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5b0: 2020 2020 2020 2020 2069 6620 706f 6f6c           if pool
+0001d5c0: 203d 3d20 7633 5f70 6f6f 6c3a 0a20 2020   == v3_pool:.   
+0001d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001d5f0: 5459 5045 5f43 4845 434b 494e 473a 0a20  TYPE_CHECKING:. 
+0001d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d620: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0001d630: 616e 6365 2873 7461 7465 2c20 556e 6973  ance(state, Unis
+0001d640: 7761 7056 3350 6f6f 6c53 7461 7465 290a  wapV3PoolState).
+0001d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d670: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0001d680: 7461 6e63 6528 706f 6f6c 2c20 5633 4c69  tance(pool, V3Li
+0001d690: 7175 6964 6974 7950 6f6f 6c29 0a20 2020  quidityPool).   
+0001d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6b0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0001d6c0: 6765 722e 696e 666f 2822 466f 756e 6420  ger.info("Found 
+0001d6d0: 5633 2050 6f6f 6c21 2229 0a20 2020 2020  V3 Pool!").     
+0001d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6f0: 2020 2020 2020 2020 2020 2070 6f6f 6c2e             pool.
+0001d700: 7369 6d75 6c61 7465 5f61 6464 5f6c 6971  simulate_add_liq
+0001d710: 7569 6469 7479 2829 0a0a 2020 2020 2020  uidity()..      
+0001d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d730: 2020 2320 5369 6d75 6c61 7465 206d 696e    # Simulate min
+0001d740: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0001d750: 2020 2020 2020 2020 2020 2e2e 2e0a 0a20            ..... 
+0001d760: 2020 2020 2020 2020 2020 2023 2043 6174             # Cat
+0001d770: 6368 2061 6e64 2072 652d 7261 6973 6520  ch and re-raise 
+0001d780: 7769 7468 6f75 7420 7370 6563 6961 6c20  without special 
+0001d790: 6861 6e64 6c69 6e67 2e20 5468 6573 6520  handling. These 
+0001d7a0: 6172 6520 7261 6973 6564 2062 7920 7468  are raised by th
+0001d7b0: 6973 2063 6c61 7373 2c20 736f 2073 686f  is class, so sho
+0001d7c0: 7274 2d63 6972 6375 6974 2069 6620 6f6e  rt-circuit if on
+0001d7d0: 6520 6861 7320 6275 6262 6c65 6420 7570  e has bubbled up
+0001d7e0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0001d7f0: 5468 6973 2070 7265 7665 6e74 7320 6e65  This prevents ne
+0001d800: 7374 6564 206d 756c 7469 6361 6c6c 7320  sted multicalls 
+0001d810: 6672 6f6d 2061 6464 696e 6720 7265 6475  from adding redu
+0001d820: 6e64 616e 7420 7374 7269 6e67 7320 746f  ndant strings to
+0001d830: 2065 7863 6570 7469 6f6e 206d 6573 7361   exception messa
+0001d840: 6765 2e0a 2020 2020 2020 2020 2020 2020  ge..            
+0001d850: 2320 652e 672e 2027 5369 6d75 6c61 7469  # e.g. 'Simulati
+0001d860: 6f6e 2066 6169 6c65 643a 2053 696d 756c  on failed: Simul
+0001d870: 6174 696f 6e20 6661 696c 6564 3a20 5369  ation failed: Si
+0001d880: 6d75 6c61 7469 6f6e 2066 6169 6c65 643a  mulation failed:
+0001d890: 2053 696d 756c 6174 696f 6e20 6661 696c   Simulation fail
+0001d8a0: 6564 3a20 7b65 7272 6f72 7d27 0a20 2020  ed: {error}'.   
+0001d8b0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0001d8c0: 5472 616e 7361 6374 696f 6e45 7272 6f72  TransactionError
+0001d8d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001d8e0: 2020 7261 6973 650a 2020 2020 2020 2020    raise.        
+0001d8f0: 2020 2020 2320 4361 7463 6820 6572 726f      # Catch erro
+0001d900: 7273 2066 726f 6d20 706f 6f6c 2068 656c  rs from pool hel
+0001d910: 7065 7220 7369 6d75 6c61 7469 6f6e 2061  per simulation a
+0001d920: 7474 656d 7074 730a 2020 2020 2020 2020  ttempts.        
+0001d930: 2020 2020 6578 6365 7074 2044 6567 656e      except Degen
+0001d940: 626f 7445 7272 6f72 2061 7320 653a 0a20  botError as e:. 
+0001d950: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001d960: 6169 7365 2054 7261 6e73 6163 7469 6f6e  aise Transaction
+0001d970: 4572 726f 7228 6622 5369 6d75 6c61 7469  Error(f"Simulati
+0001d980: 6f6e 2066 6169 6c65 643a 207b 657d 2229  on failed: {e}")
+0001d990: 2066 726f 6d20 650a 0a20 2020 2020 2020   from e..       
+0001d9a0: 2064 6566 205f 7072 6f63 6573 735f 756e   def _process_un
+0001d9b0: 6973 7761 705f 756e 6976 6572 7361 6c5f  iswap_universal_
+0001d9c0: 726f 7574 6572 5f74 7261 6e73 6163 7469  router_transacti
+0001d9d0: 6f6e 2829 202d 3e20 4e6f 6e65 3a0a 2020  on() -> None:.  
+0001d9e0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0001d9f0: 2e64 6562 7567 2866 227b 6675 6e63 5f6e  .debug(f"{func_n
+0001da00: 616d 657d 3a20 7b73 656c 662e 6861 7368  ame}: {self.hash
+0001da10: 2e68 6578 2829 3d7d 2229 0a0a 2020 2020  .hex()=}")..    
+0001da20: 2020 2020 2020 2020 6966 2066 756e 635f          if func_
+0001da30: 6e61 6d65 2021 3d20 2265 7865 6375 7465  name != "execute
+0001da40: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0001da50: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001da60: 726f 7228 6622 554e 4841 4e44 4c45 4420  ror(f"UNHANDLED 
+0001da70: 554e 4956 4552 5341 4c20 524f 5554 4552  UNIVERSAL ROUTER
+0001da80: 2046 554e 4354 494f 4e3a 207b 6675 6e63   FUNCTION: {func
+0001da90: 5f6e 616d 657d 2229 0a0a 2020 2020 2020  _name}")..      
+0001daa0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001dab0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0001dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dad0: 2020 2020 7478 5f64 6561 646c 696e 6520      tx_deadline 
+0001dae0: 3d20 6675 6e63 5f70 6172 616d 735b 2264  = func_params["d
+0001daf0: 6561 646c 696e 6522 5d0a 2020 2020 2020  eadline"].      
+0001db00: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0001db10: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+0001db20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001db30: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+0001db40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001db50: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001db60: 6c66 2e5f 7261 6973 655f 6966 5f70 6173  lf._raise_if_pas
+0001db70: 745f 6465 6164 6c69 6e65 2874 785f 6465  t_deadline(tx_de
+0001db80: 6164 6c69 6e65 290a 0a20 2020 2020 2020  adline)..       
+0001db90: 2020 2020 2020 2020 2074 785f 636f 6d6d           tx_comm
+0001dba0: 616e 6473 203d 2066 756e 635f 7061 7261  ands = func_para
+0001dbb0: 6d73 5b22 636f 6d6d 616e 6473 225d 0a20  ms["commands"]. 
+0001dbc0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001dbd0: 785f 696e 7075 7473 203d 2066 756e 635f  x_inputs = func_
+0001dbe0: 7061 7261 6d73 5b22 696e 7075 7473 225d  params["inputs"]
+0001dbf0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001dc00: 2020 666f 7220 636f 6d6d 616e 642c 2069    for command, i
+0001dc10: 6e70 7574 2069 6e20 7a69 7028 7478 5f63  nput in zip(tx_c
+0001dc20: 6f6d 6d61 6e64 732c 2074 785f 696e 7075  ommands, tx_inpu
+0001dc30: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
+0001dc40: 2020 2020 2020 2020 205f 7072 6f63 6573           _proces
+0001dc50: 735f 756e 6976 6572 7361 6c5f 726f 7574  s_universal_rout
+0001dc60: 6572 5f63 6f6d 6d61 6e64 2863 6f6d 6d61  er_command(comma
+0001dc70: 6e64 2c20 696e 7075 7429 0a0a 2020 2020  nd, input)..    
+0001dc80: 2020 2020 2020 2020 2320 6275 6766 6978          # bugfix
+0001dc90: 3a20 7072 6576 656e 7473 206e 6573 7465  : prevents neste
+0001dca0: 6420 6d75 6c74 6963 616c 6c73 2066 726f  d multicalls fro
+0001dcb0: 6d20 7370 616d 6d69 6e67 2065 7863 6570  m spamming excep
+0001dcc0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+0001dcd0: 2023 206d 6573 7361 6765 2e0a 2020 2020   # message..    
+0001dce0: 2020 2020 2020 2020 2320 652e 672e 2027          # e.g. '
+0001dcf0: 5369 6d75 6c61 7469 6f6e 2066 6169 6c65  Simulation faile
+0001dd00: 643a 2053 696d 756c 6174 696f 6e20 6661  d: Simulation fa
+0001dd10: 696c 6564 3a20 7b65 7272 6f72 7d27 0a20  iled: {error}'. 
+0001dd20: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001dd30: 7420 5472 616e 7361 6374 696f 6e45 7272  t TransactionErr
+0001dd40: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0001dd50: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
+0001dd60: 2020 2020 2020 6578 6365 7074 2044 6567        except Deg
+0001dd70: 656e 626f 7445 7272 6f72 2061 7320 653a  enbotError as e:
+0001dd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dd90: 2072 6169 7365 2054 7261 6e73 6163 7469   raise Transacti
+0001dda0: 6f6e 4572 726f 7228 6622 5369 6d75 6c61  onError(f"Simula
+0001ddb0: 7469 6f6e 2066 6169 6c65 643a 207b 657d  tion failed: {e}
+0001ddc0: 2229 2066 726f 6d20 650a 0a20 2020 2020  ") from e..     
+0001ddd0: 2020 2069 6620 6675 6e63 5f6e 616d 6520     if func_name 
+0001dde0: 696e 2056 325f 4655 4e43 5449 4f4e 533a  in V2_FUNCTIONS:
+0001ddf0: 0a20 2020 2020 2020 2020 2020 205f 7072  .            _pr
+0001de00: 6f63 6573 735f 756e 6973 7761 705f 7632  ocess_uniswap_v2
+0001de10: 5f74 7261 6e73 6163 7469 6f6e 2829 0a20  _transaction(). 
+0001de20: 2020 2020 2020 2065 6c69 6620 6675 6e63         elif func
+0001de30: 5f6e 616d 6520 696e 2056 335f 4655 4e43  _name in V3_FUNC
+0001de40: 5449 4f4e 533a 0a20 2020 2020 2020 2020  TIONS:.         
+0001de50: 2020 205f 7072 6f63 6573 735f 756e 6973     _process_unis
+0001de60: 7761 705f 7633 5f74 7261 6e73 6163 7469  wap_v3_transacti
+0001de70: 6f6e 2829 0a20 2020 2020 2020 2065 6c69  on().        eli
+0001de80: 6620 6675 6e63 5f6e 616d 6520 696e 2055  f func_name in U
+0001de90: 4e49 5645 5253 414c 5f52 4f55 5445 525f  NIVERSAL_ROUTER_
+0001dea0: 4655 4e43 5449 4f4e 533a 0a20 2020 2020  FUNCTIONS:.     
+0001deb0: 2020 2020 2020 205f 7072 6f63 6573 735f         _process_
+0001dec0: 756e 6973 7761 705f 756e 6976 6572 7361  uniswap_universa
+0001ded0: 6c5f 726f 7574 6572 5f74 7261 6e73 6163  l_router_transac
+0001dee0: 7469 6f6e 2829 0a20 2020 2020 2020 2065  tion().        e
+0001def0: 6c69 6620 6675 6e63 5f6e 616d 6520 696e  lif func_name in
+0001df00: 2055 4e48 414e 444c 4544 5f46 554e 4354   UNHANDLED_FUNCT
+0001df10: 494f 4e53 3a0a 2020 2020 2020 2020 2020  IONS:.          
+0001df20: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+0001df30: 2254 4f44 4f3a 207b 6675 6e63 5f6e 616d  "TODO: {func_nam
+0001df40: 657d 2229 0a20 2020 2020 2020 2020 2020  e}").           
+0001df50: 2072 6169 7365 2054 7261 6e73 6163 7469   raise Transacti
+0001df60: 6f6e 4572 726f 7228 0a20 2020 2020 2020  onError(.       
+0001df70: 2020 2020 2020 2020 2066 2241 626f 7274           f"Abort
+0001df80: 696e 6720 7369 6d75 6c61 7469 6f6e 2069  ing simulation i
+0001df90: 6e76 6f6c 7669 6e67 2075 6e2d 696d 706c  nvolving un-impl
+0001dfa0: 656d 656e 7465 6420 6675 6e63 7469 6f6e  emented function
+0001dfb0: 3a20 7b66 756e 635f 6e61 6d65 7d22 0a20  : {func_name}". 
+0001dfc0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001dfd0: 2020 2020 2065 6c69 6620 6675 6e63 5f6e       elif func_n
+0001dfe0: 616d 6520 696e 204e 4f5f 4f50 5f46 554e  ame in NO_OP_FUN
+0001dff0: 4354 494f 4e53 3a0a 2020 2020 2020 2020  CTIONS:.        
+0001e000: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0001e010: 2866 224e 4f4e 2d4f 503a 207b 6675 6e63  (f"NON-OP: {func
+0001e020: 5f6e 616d 657d 2229 0a20 2020 2020 2020  _name}").       
+0001e030: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001e040: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0001e050: 726f 7228 6622 554e 4841 4e44 4c45 443a  ror(f"UNHANDLED:
+0001e060: 207b 6675 6e63 5f6e 616d 657d 2229 0a0a   {func_name}")..
+0001e070: 2020 2020 6465 6620 7369 6d75 6c61 7465      def simulate
+0001e080: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0001e090: 2020 2020 2020 2020 7369 6c65 6e74 3a20          silent: 
+0001e0a0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+0001e0b0: 2020 2020 2020 7374 6174 655f 626c 6f63        state_bloc
+0001e0c0: 6b3a 2042 6c6f 636b 4e75 6d62 6572 207c  k: BlockNumber |
+0001e0d0: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
+0001e0e0: 6e65 2c0a 2020 2020 2920 2d3e 204c 6973  ne,.    ) -> Lis
+0001e0f0: 745b 0a20 2020 2020 2020 2054 7570 6c65  t[.        Tuple
+0001e100: 5b4c 6971 7569 6469 7479 506f 6f6c 2c20  [LiquidityPool, 
+0001e110: 556e 6973 7761 7056 3250 6f6f 6c53 696d  UniswapV2PoolSim
+0001e120: 756c 6174 696f 6e52 6573 756c 745d 0a20  ulationResult]. 
+0001e130: 2020 2020 2020 207c 2054 7570 6c65 5b56         | Tuple[V
+0001e140: 334c 6971 7569 6469 7479 506f 6f6c 2c20  3LiquidityPool, 
+0001e150: 556e 6973 7761 7056 3350 6f6f 6c53 696d  UniswapV3PoolSim
+0001e160: 756c 6174 696f 6e52 6573 756c 745d 0a20  ulationResult]. 
+0001e170: 2020 205d 3a0a 2020 2020 2020 2020 2222     ]:.        ""
+0001e180: 220a 2020 2020 2020 2020 4578 6563 7574  ".        Execut
+0001e190: 6520 6120 7369 6d75 6c61 7469 6f6e 206f  e a simulation o
+0001e1a0: 6620 6120 7472 616e 7361 6374 696f 6e2c  f a transaction,
+0001e1b0: 2075 7369 6e67 2074 6865 2061 7474 7269   using the attri
+0001e1c0: 6275 7465 730a 2020 2020 2020 2020 7374  butes.        st
+0001e1d0: 6f72 6564 2069 6e20 7468 6520 636f 6e73  ored in the cons
+0001e1e0: 7472 7563 746f 722e 0a0a 2020 2020 2020  tructor...      
+0001e1f0: 2020 4465 6665 7273 2073 696d 756c 6174    Defers simulat
+0001e200: 696f 6e20 746f 2074 6865 2060 5f73 696d  ion to the `_sim
+0001e210: 756c 6174 6560 206d 6574 686f 642c 2077  ulate` method, w
+0001e220: 6869 6368 206d 6179 2072 6563 7572 7365  hich may recurse
+0001e230: 0a20 2020 2020 2020 2061 7320 6e65 6564  .        as need
+0001e240: 6564 2066 6f72 206e 6573 7465 6420 6d75  ed for nested mu
+0001e250: 6c74 6963 616c 6c73 2e0a 0a20 2020 2020  lticalls...     
+0001e260: 2020 2050 6572 666f 726d 7320 6120 6669     Performs a fi
+0001e270: 6e61 6c20 6163 636f 756e 7469 6e67 2063  nal accounting c
+0001e280: 6865 636b 206f 6620 6164 6472 6573 7365  heck of addresse
+0001e290: 7320 696e 2060 7365 6c66 2e6c 6564 6765  s in `self.ledge
+0001e2a0: 7260 0a20 2020 2020 2020 206c 6564 6765  r`.        ledge
+0001e2b0: 722c 2065 7863 6c75 6469 6e67 2074 6865  r, excluding the
+0001e2c0: 2060 6d73 672e 7365 6e64 6572 6020 616e   `msg.sender` an
+0001e2d0: 6420 6072 6563 6970 6965 6e74 6020 6164  d `recipient` ad
+0001e2e0: 6472 6573 7365 732e 0a20 2020 2020 2020  dresses..       
+0001e2f0: 2022 2222 0a0a 2020 2020 2020 2020 7365   """..        se
+0001e300: 6c66 2e73 696c 656e 7420 3d20 7369 6c65  lf.silent = sile
+0001e310: 6e74 0a0a 2020 2020 2020 2020 7365 6c66  nt..        self
+0001e320: 2e73 7461 7465 5f62 6c6f 636b 3a20 426c  .state_block: Bl
+0001e330: 6f63 6b4e 756d 6265 720a 2020 2020 2020  ockNumber.      
+0001e340: 2020 6966 2073 7461 7465 5f62 6c6f 636b    if state_block
+0001e350: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001e360: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
+0001e370: 5f62 6c6f 636b 203d 2063 6f6e 6669 672e  _block = config.
+0001e380: 6765 745f 7765 6233 2829 2e65 7468 2e67  get_web3().eth.g
+0001e390: 6574 5f62 6c6f 636b 5f6e 756d 6265 7228  et_block_number(
+0001e3a0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001e3b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e3c0: 2e73 7461 7465 5f62 6c6f 636b 203d 2063  .state_block = c
+0001e3d0: 6173 7428 426c 6f63 6b4e 756d 6265 722c  ast(BlockNumber,
+0001e3e0: 2073 7461 7465 5f62 6c6f 636b 290a 0a20   state_block).. 
+0001e3f0: 2020 2020 2020 2073 656c 662e 7369 6d75         self.simu
+0001e400: 6c61 7465 645f 706f 6f6c 5f73 7461 7465  lated_pool_state
+0001e410: 733a 204c 6973 745b 0a20 2020 2020 2020  s: List[.       
+0001e420: 2020 2020 2054 7570 6c65 5b4c 6971 7569       Tuple[Liqui
+0001e430: 6469 7479 506f 6f6c 2c20 556e 6973 7761  dityPool, Uniswa
+0001e440: 7056 3250 6f6f 6c53 696d 756c 6174 696f  pV2PoolSimulatio
+0001e450: 6e52 6573 756c 745d 0a20 2020 2020 2020  nResult].       
+0001e460: 2020 2020 207c 2054 7570 6c65 5b56 334c       | Tuple[V3L
+0001e470: 6971 7569 6469 7479 506f 6f6c 2c20 556e  iquidityPool, Un
+0001e480: 6973 7761 7056 3350 6f6f 6c53 696d 756c  iswapV3PoolSimul
+0001e490: 6174 696f 6e52 6573 756c 745d 0a20 2020  ationResult].   
+0001e4a0: 2020 2020 205d 203d 205b 5d0a 0a20 2020       ] = []..   
+0001e4b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001e4c0: 2020 2020 2020 7365 6c66 2e5f 7369 6d75        self._simu
+0001e4d0: 6c61 7465 280a 2020 2020 2020 2020 2020  late(.          
+0001e4e0: 2020 2020 2020 7365 6c66 2e66 756e 635f        self.func_
+0001e4f0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0001e500: 2020 2020 2020 7365 6c66 2e66 756e 635f        self.func_
+0001e510: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0001e520: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+0001e530: 6365 7074 2056 616c 7565 4572 726f 7220  cept ValueError 
+0001e540: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0001e550: 2020 7261 6973 6520 5472 616e 7361 6374    raise Transact
+0001e560: 696f 6e45 7272 6f72 2865 290a 0a20 2020  ionError(e)..   
+0001e570: 2020 2020 2069 6620 7365 6c66 2e72 6f75       if self.rou
+0001e580: 7465 725f 6164 6472 6573 7320 696e 2073  ter_address in s
+0001e590: 656c 662e 6c65 6467 6572 2e5f 6261 6c61  elf.ledger._bala
+0001e5a0: 6e63 6573 3a0a 2020 2020 2020 2020 2020  nces:.          
+0001e5b0: 2020 7261 6973 6520 7365 6c66 2e4c 6566    raise self.Lef
+0001e5c0: 746f 7665 7252 6f75 7465 7242 616c 616e  toverRouterBalan
+0001e5d0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+0001e5e0: 2020 2020 2255 6e61 6363 6f75 6e74 6564      "Unaccounted
+0001e5f0: 2072 6f75 7465 7220 6261 6c61 6e63 6522   router balance"
+0001e600: 2c20 7365 6c66 2e6c 6564 6765 722e 5f62  , self.ledger._b
+0001e610: 616c 616e 6365 735b 7365 6c66 2e72 6f75  alances[self.rou
+0001e620: 7465 725f 6164 6472 6573 735d 0a20 2020  ter_address].   
+0001e630: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001e640: 2020 2020 2320 6966 206e 6f74 2073 696c      # if not sil
+0001e650: 656e 743a 0a20 2020 2020 2020 2023 2020  ent:.        #  
+0001e660: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
+0001e670: 227b 7365 6c66 2e73 696d 756c 6174 6564  "{self.simulated
+0001e680: 5f70 6f6f 6c5f 7374 6174 6573 3d7d 2229  _pool_states=}")
+0001e690: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001e6a0: 2073 656c 662e 7369 6d75 6c61 7465 645f   self.simulated_
+0001e6b0: 706f 6f6c 5f73 7461 7465 730a            pool_states.
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/abi.py` & `degenbot-0.2.3/src/degenbot/uniswap/abi.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/managers.py` & `degenbot-0.2.3/src/degenbot/uniswap/managers.py`

 * *Files 2% similar despite different names*

```diff
@@ -188,20 +188,19 @@
                     self._token_manager.get_erc20token(
                         address=token_address,
                         silent=silent,
                     )
             except Exception:
                 raise ManagerError("Could not get both Erc20Token helpers")
 
-            if pool_address == ZERO_ADDRESS:
-                raise ManagerError("No V2 LP available")
-
             pool_address = to_checksum_address(
                 self._w3_contract.functions.getPair(*checksummed_token_addresses).call()
             )
+            if pool_address == ZERO_ADDRESS:
+                raise ManagerError("No V2 LP available")
 
         if TYPE_CHECKING:
             assert pool_address is not None
         # Address is now known, check if the pool is already being tracked
         pool_address = to_checksum_address(pool_address)
 
         if pool_address in self._untracked_pools:
@@ -309,18 +308,35 @@
             pass
 
         self._untracked_pools.discard(pool_address)
 
     def __repr__(self) -> str:  # pragma: no cover
         return f"UniswapV3LiquidityPoolManager(factory={self._factory_address})"
 
-    def _add_pool(self, pool_helper: V3LiquidityPool) -> None:
+    def _add_tracked_pool(self, pool_helper: V3LiquidityPool) -> None:
         with self._lock:
             self._tracked_pools[pool_helper.address] = pool_helper
 
+    def _apply_pending_liquidity_updates(self, pool: V3LiquidityPool) -> None:
+        """
+        Apply all pending updates from the snapshot.
+        """
+
+        if not self._snapshot:
+            return
+
+        # Reset the update block to zero so liquidity updates are accepted
+        starting_state_block = pool._update_block
+        pool._update_block = 0
+
+        # Apply updates and restore the non-liquidity state at the update block
+        for liquidity_update in self._snapshot.get_new_liquidity_updates(pool.address):
+            pool.external_update(liquidity_update)
+        pool.auto_update(block_number=starting_state_block)
+
     def get_pool(
         self,
         pool_address: ChecksumAddress | str | None = None,
         token_addresses: Tuple[
             ChecksumAddress | str,
             ChecksumAddress | str,
         ]
@@ -332,35 +348,27 @@
         state_block: int | None = None,
     ) -> V3LiquidityPool:
         """
         Get a `V3LiquidityPool` from its address, or a tuple of token addresses
         and fee in bips (e.g. 100, 500, 3000, 10000)
         """
 
-        def apply_liquidity_updates(pool: V3LiquidityPool) -> None:
-            logger.debug(f"Applying liquidity updates to {pool}")
-            if not self._snapshot:
-                return
-            for external_update in self._snapshot.get_pool_updates(pool.address):
-                pool.external_update(update=external_update, force=True)
-
         def find_or_build(
             pool_address: ChecksumAddress,
             state_block: int | None = None,
         ) -> V3LiquidityPool:
             if TYPE_CHECKING:
                 assert isinstance(v3liquiditypool_kwargs, dict)
 
             # Check if the AllPools collection already has this pool
-            pool_helper = AllPools(self.chain_id).get(pool_address)
-            if pool_helper:
+            if pool_helper := AllPools(self.chain_id).get(pool_address):
                 if TYPE_CHECKING:
                     assert isinstance(pool_helper, V3LiquidityPool)
                 if pool_helper.factory == self._factory_address:
-                    self._add_pool(pool_helper)
+                    self._add_tracked_pool(pool_helper)
                     return pool_helper
                 else:
                     self._untracked_pools.add(pool_address)
                     raise PoolNotAssociated(f"Pool {pool_address} is not associated with this DEX")
 
             if self._snapshot:
                 v3liquiditypool_kwargs.update(
@@ -385,16 +393,16 @@
                     **v3liquiditypool_kwargs,
                     state_block=state_block,
                 )
             except Exception as e:
                 self._untracked_pools.add(pool_address)
                 raise ManagerError(f"Could not build V3 pool {pool_address}: {e}") from e
             else:
-                apply_liquidity_updates(pool_helper)
-                self._add_pool(pool_helper)
+                self._apply_pending_liquidity_updates(pool_helper)
+                self._add_tracked_pool(pool_helper)
                 assert isinstance(
                     pool_helper, V3LiquidityPool
                 ), f"{self} Attempted to return non-V3 pool {pool_helper}! {pool_address=}, {token_addresses=}, {pool_fee=}"
                 return pool_helper
 
         if not (pool_address is None) ^ (token_addresses is None and pool_fee is None):
             raise ValueError("Insufficient arguments provided. Pass address OR tokens & fee")
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v2_dataclasses.py` & `degenbot-0.2.3/src/degenbot/uniswap/v2_dataclasses.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,34 +1,38 @@
 import dataclasses
-from typing import TYPE_CHECKING
-from ..baseclasses import BasePoolState, UniswapSimulationResult
 
-if TYPE_CHECKING:
-    from .v2_liquidity_pool import LiquidityPool
+from eth_typing import ChecksumAddress
+
+from ..baseclasses import BasePoolState, Message, UniswapSimulationResult
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV2PoolState(BasePoolState):
-    pool: "LiquidityPool"
+    pool: ChecksumAddress
     reserves_token0: int
     reserves_token1: int
 
     def copy(self) -> "UniswapV2PoolState":
         return UniswapV2PoolState(
             pool=self.pool,
             reserves_token0=self.reserves_token0,
             reserves_token1=self.reserves_token1,
         )
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV2PoolSimulationResult(UniswapSimulationResult):
-    current_state: UniswapV2PoolState
-    future_state: UniswapV2PoolState
+    initial_state: UniswapV2PoolState
+    final_state: UniswapV2PoolState
 
 
 @dataclasses.dataclass(slots=True, eq=False)
 class UniswapV2PoolExternalUpdate:
     block_number: int = dataclasses.field(compare=False)
     reserves_token0: int
     reserves_token1: int
     tx: str | None = dataclasses.field(compare=False, default=None)
+
+
+@dataclasses.dataclass(slots=True, frozen=True)
+class UniswapV2PoolStateUpdated(Message):
+    state: UniswapV2PoolState
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v2_functions.py` & `degenbot-0.2.3/src/degenbot/uniswap/v2_functions.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v2_liquidity_pool.py` & `degenbot-0.2.3/src/degenbot/uniswap/v2_liquidity_pool.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,44 +1,42 @@
-import warnings
 from bisect import bisect_left
 from fractions import Fraction
 from threading import Lock
-from typing import Any, Dict, Iterable, List, Set, Tuple
+from typing import Any, Dict, Iterable, List, Tuple
 
-from eth_typing import ChecksumAddress
+from eth_typing import BlockNumber, ChecksumAddress
 from eth_utils.address import to_checksum_address
+from typing_extensions import override
 from web3.contract.contract import Contract
 
 from .. import config
 from ..baseclasses import BaseLiquidityPool
 from ..erc20_token import Erc20Token
 from ..exceptions import (
-    DeprecationError,
     ExternalUpdateError,
     LiquidityPoolError,
     NoPoolStateAvailable,
     ZeroSwapError,
 )
 from ..logging import logger
 from ..manager.token_manager import Erc20TokenHelperManager
 from ..registry.all_pools import AllPools
-from ..subscription_mixins import Subscriber, SubscriptionMixin
 from .abi import CAMELOT_POOL_ABI, UNISWAP_V2_POOL_ABI
-from .mixins import CamelotStablePoolMixin
 from .v2_dataclasses import (
     UniswapV2PoolExternalUpdate,
     UniswapV2PoolSimulationResult,
     UniswapV2PoolState,
+    UniswapV2PoolStateUpdated,
 )
 from .v2_functions import generate_v2_pool_address
 
 
-class LiquidityPool(SubscriptionMixin, BaseLiquidityPool):
+class LiquidityPool(BaseLiquidityPool):
     """
-    Represents a Uniswap V2 liquidity pool
+    A Uniswap V2-based liquidity pool implementing the x*y=k constant function invariant.
     """
 
     uniswap_version = 2
 
     def __init__(
         self,
         address: ChecksumAddress | str,
@@ -48,16 +46,14 @@
         abi: List[Any] | None = None,
         factory_address: str | None = None,
         factory_init_hash: str | None = None,
         fee: Fraction | Iterable[Fraction] = Fraction(3, 1000),
         silent: bool = False,
         state_block: int | None = None,
         empty: bool = False,
-        update_reserves_on_start: bool | None = None,  # deprecated
-        unload_brownie_contract_after_init: bool | None = None,  # deprecated
     ) -> None:
         """
         Create a new `LiquidityPool` object for interaction with a Uniswap
         V2 pool.
 
         Arguments
         ---------
@@ -93,35 +89,29 @@
             height. Defaults to the latest block if omitted.
         empty: bool
             Set to `True` to initialize the pool without initial values
             retrieved from chain, and skipping some validation. Useful for
             simulating transactions through pools that do not exist.
         """
 
-        if empty and any([address is None, factory_address is None, tokens is None]):
+        if empty and any(
+            [
+                address is None,
+                factory_address is None,
+                tokens is None,
+            ]
+        ):
             raise ValueError(
                 "Empty LiquidityPool cannot be created without pool, factory, and token addresses"
             )
 
-        self.state: UniswapV2PoolState = UniswapV2PoolState(
-            pool=self,
-            reserves_token0=0,
-            reserves_token1=0,
-        )
-
+        self.factory: ChecksumAddress
+        self._state: UniswapV2PoolState | None = None
         self._state_lock = Lock()
 
-        if unload_brownie_contract_after_init is not None:  # pragma: no cover
-            warnings.warn("unload_brownie_contract_after_init has been deprecated and is ignored.")
-
-        if update_reserves_on_start is not None:  # pragma: no cover
-            warnings.warn(
-                "update_reserves_on_start has been deprecated in favor of `empty` argument."
-            )
-
         self.address: ChecksumAddress = to_checksum_address(address)
         self.abi = abi if abi is not None else UNISWAP_V2_POOL_ABI
 
         _w3 = config.get_web3()
         _w3_contract = self._w3_contract
 
         if factory_address:
@@ -146,26 +136,22 @@
                 raise TypeError(
                     f"LP fee was not correctly passed! "
                     f"Expected '{Fraction().__class__.__name__}', "
                     f"was '{fee.__class__.__name__}'"
                 )
 
         self._update_method = update_method
-        self.new_reserves = False
-
-        if empty:
-            self.update_block = 1
-        else:
-            self.update_block = (
-                state_block if state_block is not None else _w3.eth.get_block_number()
-            )
-            self.factory = _w3_contract.functions.factory().call()
-
-        chain_id = 1 if empty else _w3.eth.chain_id
+        self.update_block: BlockNumber | int = _w3.eth.get_block_number()
+        self.factory = (
+            to_checksum_address(factory_address)
+            if factory_address is not None
+            else _w3_contract.functions.factory().call()
+        )
 
+        chain_id = _w3.eth.chain_id
         if tokens is not None:
             if len(tokens) != 2:
                 raise ValueError(f"Expected 2 tokens, found {len(tokens)}")
             self.token0 = min(tokens)
             self.token1 = max(tokens)
         else:
             _token_manager = Erc20TokenHelperManager(chain_id)
@@ -190,50 +176,37 @@
                 raise ValueError(
                     f"Pool address {self.address} does not match deterministic address {computed_pool_address} from factory"
                 )
 
         if name is not None:
             self.name = name
         else:
-            if self.fee_token0 != self.fee_token1:
-                fee_string = f"{100*self.fee_token0.numerator/self.fee_token0.denominator:.2f}/{100*self.fee_token1.numerator/self.fee_token1.denominator:.2f}"
-            elif self.fee_token0 == self.fee_token1:
-                fee_string = f"{100*self.fee_token0.numerator/self.fee_token0.denominator:.2f}"
-
+            fee_string = (
+                f"{100*self.fee_token0.numerator/self.fee_token0.denominator:.2f}"
+                if self.fee_token0 == self.fee_token1
+                else f"{100*self.fee_token0.numerator/self.fee_token0.denominator:.2f}/{100*self.fee_token1.numerator/self.fee_token1.denominator:.2f}"
+            )
             self.name = f"{self.token0}-{self.token1} (V2, {fee_string}%)"
 
-        if not empty:
-            (
-                self.reserves_token0,
-                self.reserves_token1,
-                *_,
-            ) = _w3_contract.functions.getReserves().call(block_identifier=self.update_block)
-
         if self._update_method == "event":  # pragma: no cover
             raise ValueError(
                 "The 'event' update method is inaccurate and unsupported, please update your bot to use the default 'polling' method"
             )
 
-        self._pool_state_archive: Dict[int, UniswapV2PoolState] = {
-            0: UniswapV2PoolState(
-                pool=self,
-                reserves_token0=0,
-                reserves_token1=0,
-            ),
-            self.update_block: self.state,
-        }
+        self._pool_state_archive: Dict[int, UniswapV2PoolState] = {}
 
         AllPools(chain_id)[self.address] = self
 
-        self._subscribers: Set[Subscriber] = set()
+        self._subscribers = set()
 
-        if not silent:
+        if not silent:  # pragma: no cover
             logger.info(self.name)
-            logger.info(f"• Token 0: {self.token0} - Reserves: {self.reserves_token0}")
-            logger.info(f"• Token 1: {self.token1} - Reserves: {self.reserves_token1}")
+            if not empty:
+                logger.info(f"• Token 0: {self.token0} - Reserves: {self.reserves_token0}")
+                logger.info(f"• Token 1: {self.token1} - Reserves: {self.reserves_token1}")
 
     def __getstate__(self) -> Dict[str, Any]:
         # Remove objects that either cannot be pickled or are unnecessary to perform the calculation
         copied_attributes = ()
         dropped_attributes = (
             "_state_lock",
             "_subscribers",
@@ -248,42 +221,60 @@
             }
 
     def __repr__(self) -> str:  # pragma: no cover
         return f"{self.__class__.__name__}(address={self.address}, token0={self.token0}, token1={self.token1})"
 
     @property
     def _w3_contract(self) -> Contract:
-        return config.get_web3().eth.contract(
-            address=self.address,
-            abi=self.abi,
-        )
+        return config.get_web3().eth.contract(address=self.address, abi=self.abi)
 
     @property
     def reserves_token0(self) -> int:
         return self.state.reserves_token0
 
-    @reserves_token0.setter
-    def reserves_token0(self, new_reserves: int) -> None:
-        self.state = UniswapV2PoolState(
-            pool=self,
-            reserves_token0=new_reserves,
-            reserves_token1=self.reserves_token1,
-        )
-
     @property
     def reserves_token1(self) -> int:
         return self.state.reserves_token1
 
-    @reserves_token1.setter
-    def reserves_token1(self, new_reserves: int) -> None:
-        self.state = UniswapV2PoolState(
-            pool=self,
-            reserves_token0=self.reserves_token0,
-            reserves_token1=new_reserves,
+    @property
+    @override
+    def state(self) -> UniswapV2PoolState:
+        if self._state is None:
+            current_block = config.get_web3().eth.get_block_number()
+            logger.debug(f"Getting initial state for {self} at block {current_block}")
+            reserves0, reserves1, *_ = self._w3_contract.functions.getReserves().call(
+                block_identifier=current_block
+            )
+            self.update_block = current_block
+            self._state = UniswapV2PoolState(
+                pool=self.address,
+                reserves_token0=reserves0,
+                reserves_token1=reserves1,
+            )
+            self._pool_state_archive[current_block] = self._state
+        return self._state
+
+    @state.setter
+    @override
+    def state(self, new_state: UniswapV2PoolState) -> None:
+        self._state = new_state
+
+    def auto_update(
+        self,
+        block_number: int | None = None,
+        silent: bool = True,
+    ) -> Tuple[bool, UniswapV2PoolState]:
+        found_updates = self.update_reserves(
+            silent=silent,
+            print_ratios=not silent,
+            print_reserves=not silent,
+            update_block=block_number,
+            override_update_method="polling",
         )
+        return found_updates, self.state
 
     def calculate_tokens_in_from_ratio_out(
         self,
         token_in: Erc20Token,
         ratio_absolute: Fraction,
     ) -> int:
         """
@@ -316,87 +307,51 @@
                 ),
             )
 
     def calculate_tokens_in_from_tokens_out(
         self,
         token_out_quantity: int,
         token_out: Erc20Token,
-        token_in: Erc20Token | None = None,
-        override_reserves_token0: int | None = None,
-        override_reserves_token1: int | None = None,
         override_state: UniswapV2PoolState | None = None,
     ) -> int:
         """
-        Calculates the required token INPUT of token_in for a target OUTPUT
-        at current pool reserves. Uses the `self.token0` and `self.token1`
-        references to determine which token is being swapped in.
-
-        @dev This method accepts overrides in the form of individual tokens
-        reserves or a single override dictionary. The override dictionary is
-        used by other helpers and is the preferred method. The individual
-        overrides are left here for backward compatibility with older scripts,
-        and will be deprecated in the future.
-        """
-
-        if token_in is not None:
-            warnings.warn(
-                "The use of token_in is deprecated and will be removed in the future. Please modify your calling code to specify token_out instead."
-            )
-
-        if (
-            override_state is None
-            and override_reserves_token0 is not None
-            and override_reserves_token1 is not None
-        ):
-            override_state = UniswapV2PoolState(
-                pool=self,
-                reserves_token0=override_reserves_token0,
-                reserves_token1=override_reserves_token1,
-            )
-            warnings.warn(
-                "Overriding individual reserves is deprecated in favor of a single state override via override_state. The individual overrides have been transformed in-place, but this will be removed in a future release."
-            )
+        Calculates the required token INPUT of token_in for a target OUTPUT at current pool
+        reserves.
 
-        if override_state:
-            # if override_reserves_token0 or override_reserves_token1:
-            #     raise ValueError(
-            #         "Provide a single override via `override_state` or individual reserves."
-            #     )
-            override_reserves_token0 = override_state.reserves_token0
-            override_reserves_token1 = override_state.reserves_token1
-            logger.debug("Reserve overrides applied:")
-            logger.debug(f"token0: {override_reserves_token0}")
-            logger.debug(f"token1: {override_reserves_token1}")
-
-            # if (override_reserves_token0 and not override_reserves_token1) or (
-            #     not override_reserves_token0 and override_reserves_token1
-            # ):
-            #     raise ValueError("Must provide reserve override values for both tokens")
+        Accepts a `UniswapV2PoolState` state override for calculation against an arbitrary state
+        in lieu of the recorded state.
+        """
+
+        if token_out_quantity <= 0:  # pragma: no cover
+            raise ZeroSwapError("token_out_quantity must be positive")
+
+        if override_state:  # pragma: no cover
+            logger.debug(f"State overrides applied: {override_state}")
 
         if token_out == self.token1:
             reserves_in = (
-                override_reserves_token0
-                if override_reserves_token0 is not None
+                override_state.reserves_token0
+                if override_state is not None
                 else self.reserves_token0
             )
             reserves_out = (
-                override_reserves_token1
-                if override_reserves_token1 is not None
+                override_state.reserves_token1
+                if override_state is not None
                 else self.reserves_token1
             )
             fee = self.fee_token0
         elif token_out == self.token0:
             reserves_in = (
-                override_reserves_token1
-                if override_reserves_token1 is not None
+                override_state.reserves_token1
+                if override_state is not None
                 else self.reserves_token1
             )
             reserves_out = (
-                override_reserves_token0
-                if override_reserves_token0 is not None
+                override_state.reserves_token0
+                if override_state is not None
                 else self.reserves_token0
             )
             fee = self.fee_token1
         else:  # pragma: no cover
             raise ValueError(
                 f"Could not identify token_out: {token_out}! This pool holds: {self.token0} {self.token1}"
             )
@@ -411,411 +366,426 @@
         denominator = (reserves_out - token_out_quantity) * (fee.denominator - fee.numerator)
         return numerator // denominator + 1
 
     def calculate_tokens_out_from_tokens_in(
         self,
         token_in: Erc20Token,
         token_in_quantity: int,
-        override_reserves_token0: int | None = None,
-        override_reserves_token1: int | None = None,
         override_state: UniswapV2PoolState | None = None,
     ) -> int:
         """
         Calculates the expected token OUTPUT for a target INPUT at current pool reserves.
-        Uses the self.token0 and self.token1 pointers to determine which token is being swapped in
         """
 
-        if token_in_quantity <= 0:
+        if token_in_quantity <= 0:  # pragma: no cover
             raise ZeroSwapError("token_in_quantity must be positive")
 
-        if (
-            override_state is None
-            and override_reserves_token0 is not None
-            and override_reserves_token1 is not None
-        ):  # pragma: no cover
-            warnings.warn(
-                "Overriding individual reserves is deprecated in favor of a single state override via override_state. The individual overrides have been transformed in-place, but this will be removed in a future release."
-            )
-            override_state = UniswapV2PoolState(
-                pool=self,
-                reserves_token0=override_reserves_token0,
-                reserves_token1=override_reserves_token1,
-            )
-
-        if override_state:
-            override_reserves_token0 = override_state.reserves_token0
-            override_reserves_token1 = override_state.reserves_token1
-            logger.debug("Reserve overrides applied:")
-            logger.debug(f"token0: {override_reserves_token0}")
-            logger.debug(f"token1: {override_reserves_token1}")
+        if override_state:  # pragma: no cover
+            logger.debug(f"State overrides applied: {override_state}")
 
         if token_in == self.token0:
             reserves_in = (
-                override_reserves_token0
-                if override_reserves_token0 is not None
+                override_state.reserves_token0
+                if override_state is not None
                 else self.reserves_token0
             )
             reserves_out = (
-                override_reserves_token1
-                if override_reserves_token1 is not None
+                override_state.reserves_token1
+                if override_state is not None
                 else self.reserves_token1
             )
             fee = self.fee_token0
         elif token_in == self.token1:
             reserves_in = (
-                override_reserves_token1
-                if override_reserves_token1 is not None
+                override_state.reserves_token1
+                if override_state is not None
                 else self.reserves_token1
             )
             reserves_out = (
-                override_reserves_token0
-                if override_reserves_token0 is not None
+                override_state.reserves_token0
+                if override_state is not None
                 else self.reserves_token0
             )
             fee = self.fee_token1
         else:  # pragma: no cover
             raise ValueError(
                 f"Could not identify token_in: {token_in}! Pool holds: {self.token0} {self.token1}"
             )
 
         amount_in_with_fee = token_in_quantity * (fee.denominator - fee.numerator)
         numerator = amount_in_with_fee * reserves_out
         denominator = reserves_in * fee.denominator + amount_in_with_fee
 
         return numerator // denominator
 
+    def external_update(
+        self,
+        update: UniswapV2PoolExternalUpdate,
+        silent: bool = True,
+    ) -> bool:
+        return self.update_reserves(
+            silent=silent,
+            external_token0_reserves=update.reserves_token0,
+            external_token1_reserves=update.reserves_token1,
+            print_reserves=not silent,
+            print_ratios=not silent,
+            override_update_method="external",
+        )
+
+    def get_absolute_price(
+        self, token: Erc20Token, override_state: UniswapV2PoolState | None = None
+    ) -> Fraction:
+        """
+        Get the absolute price for the given token, expressed in units of the other.
+        """
+
+        return 1 / self.get_absolute_rate(token, override_state=override_state)
+
+    def get_absolute_rate(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV2PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the absolute rate for the given token, expressed in units of the other.
+        """
+
+        state = self.state if override_state is None else override_state
+
+        if token == self.token0:
+            return Fraction(state.reserves_token0) / Fraction(state.reserves_token1)
+        elif token == self.token1:
+            return Fraction(state.reserves_token1) / Fraction(state.reserves_token0)
+        else:  # pragma: no cover
+            raise ValueError(f"Unknown token {token}")
+
+    def get_nominal_price(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV2PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the nominal price for the given token, expressed in units of the other, corrected for
+        decimal place values.
+        """
+
+        return 1 / self.get_nominal_rate(token, override_state=override_state)
+
+    def get_nominal_rate(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV2PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the nominal rate for the given token, expressed in units of the other, corrected for
+        decimal place values.
+        """
+
+        state = self.state if override_state is None else override_state
+
+        if token == self.token0:
+            return Fraction(state.reserves_token0, 10**self.token0.decimals) * Fraction(
+                10**self.token1.decimals, state.reserves_token1
+            )
+        elif token == self.token1:
+            return Fraction(state.reserves_token1, 10**self.token1.decimals) * Fraction(
+                10**self.token0.decimals, state.reserves_token0
+            )
+        else:  # pragma: no cover
+            raise ValueError(f"Unknown token {token}")
+
     def restore_state_before_block(
         self,
         block: int,
     ) -> None:
         """
         Restore the last pool state recorded prior to a target block.
 
-        Use this method to maintain consistent state data following a chain
-        re-organization.
+        Use this method to maintain consistent state data following a chain re-organization.
         """
 
-        # Find the index for the most recent pool state PRIOR to the requested
-        # block number.
-        #
-        # e.g. Calling restore_state_before_block(block=104) for a pool with
-        # states at blocks 100, 101, 102, 103, 104. `bisect_left()` returns
-        # block_index=3, since block 104 is at index=4. The state held at
-        # index=3 is for block 103.
-
         with self._state_lock:
             known_blocks = list(self._pool_state_archive.keys())
+
+            # Finds the index prior to the requested block number
             block_index = bisect_left(known_blocks, block)
 
             if block_index == 0:
                 raise NoPoolStateAvailable(f"No pool state known prior to block {block}")
 
             # The last known state already meets the criterion, so return early
             if block_index == len(known_blocks):
                 return
 
             # Remove states at and after the specified block
             for block in known_blocks[block_index:]:
                 del self._pool_state_archive[block]
 
-            restored_block, restored_state = list(self._pool_state_archive.items())[-1]
-
             # Restore previous state and block
-            self.state = restored_state
-            self.update_block = restored_block
-            self._notify_subscribers()
+            self.update_block, self.state = list(self._pool_state_archive.items())[-1]
+            self._notify_subscribers(message=UniswapV2PoolStateUpdated(self.state))
 
-    def set_swap_target(self, *args: Any, **kwargs: Any) -> None:
-        warnings.warn(
+    def set_swap_target(self, *args: Any, **kwargs: Any) -> None:  # pragma: no cover
+        raise DeprecationWarning(
             "set_swap_target has been deprecated. Please convert your code to use the calculate_tokens_in_from_ratio_out method directly."
         )
 
     def simulate_add_liquidity(
         self,
         added_reserves_token0: int,
         added_reserves_token1: int,
         override_state: UniswapV2PoolState | None = None,
     ) -> UniswapV2PoolSimulationResult:
         if override_state:
             logger.debug(f"State override: {override_state}")
 
-        reserves_token0 = override_state.reserves_token0 if override_state else self.reserves_token0
-        reserves_token1 = override_state.reserves_token1 if override_state else self.reserves_token1
-
         with self._state_lock:
+            reserves_token0 = (
+                override_state.reserves_token0 if override_state else self.reserves_token0
+            )
+            reserves_token1 = (
+                override_state.reserves_token1 if override_state else self.reserves_token1
+            )
+
             return UniswapV2PoolSimulationResult(
                 amount0_delta=added_reserves_token0,
                 amount1_delta=added_reserves_token1,
-                current_state=self.state.copy(),
-                future_state=UniswapV2PoolState(
-                    pool=self,
+                initial_state=override_state if override_state is not None else self.state.copy(),
+                final_state=UniswapV2PoolState(
+                    pool=self.address,
                     reserves_token0=reserves_token0 + added_reserves_token0,
                     reserves_token1=reserves_token1 + added_reserves_token1,
                 ),
             )
 
     def simulate_remove_liquidity(
         self,
         removed_reserves_token0: int,
         removed_reserves_token1: int,
         override_state: UniswapV2PoolState | None = None,
     ) -> UniswapV2PoolSimulationResult:
         if override_state:
             logger.debug(f"State override: {override_state}")
 
-        reserves_token0 = override_state.reserves_token0 if override_state else self.reserves_token0
-        reserves_token1 = override_state.reserves_token1 if override_state else self.reserves_token1
-
         with self._state_lock:
+            reserves_token0 = (
+                override_state.reserves_token0 if override_state else self.reserves_token0
+            )
+            reserves_token1 = (
+                override_state.reserves_token1 if override_state else self.reserves_token1
+            )
+
             return UniswapV2PoolSimulationResult(
                 amount0_delta=-removed_reserves_token0,
                 amount1_delta=-removed_reserves_token1,
-                current_state=self.state.copy(),
-                future_state=UniswapV2PoolState(
-                    pool=self,
+                initial_state=self.state.copy(),
+                final_state=UniswapV2PoolState(
+                    pool=self.address,
                     reserves_token0=reserves_token0 - removed_reserves_token0,
                     reserves_token1=reserves_token1 - removed_reserves_token1,
                 ),
             )
 
-    def simulate_swap(
+    def simulate_exact_input_swap(
         self,
-        token_in: Erc20Token | None = None,
-        token_in_quantity: int | None = None,
-        token_out: Erc20Token | None = None,
-        token_out_quantity: int | None = None,
+        token_in: Erc20Token,
+        token_in_quantity: int,
         override_state: UniswapV2PoolState | None = None,
     ) -> UniswapV2PoolSimulationResult:
-        if token_in_quantity is None and token_out_quantity is None:
-            raise ValueError("No quantity was provided")
-
-        if token_in_quantity is not None and token_out_quantity is not None:
-            raise ValueError("Provide token_in_quantity or token_out_quantity, not both")
+        if token_in not in self.tokens:  # pragma: no cover
+            raise ValueError("token_in is unknown.")
 
-        if token_in and token_out and token_in == token_out:
-            raise ValueError("Both tokens are the same!")
+        if token_in_quantity == 0:  # pragma: no cover
+            raise ValueError("Zero input swap requested.")
 
         if override_state:
             logger.debug(f"State override: {override_state}")
 
-        if token_in and token_in not in self.tokens:
-            raise ValueError(
-                f"Token not found! token_in = {repr(token_in)}, pool holds {self.token0},{self.token1}"
-            )
-        if token_out and token_out not in self.tokens:
-            raise ValueError(
-                f"Token not found! token_out = {repr(token_out)}, pool holds {self.token0},{self.token1}"
-            )
+        current_state = override_state if override_state is not None else self.state.copy()
+        zero_for_one = token_in == self.token0
 
-        if token_in is not None and token_in == self.token0:
-            token_out = self.token1
-        elif token_in is not None and token_in == self.token1:
-            token_out = self.token0
+        token_out_quantity = self.calculate_tokens_out_from_tokens_in(
+            token_in=token_in,
+            token_in_quantity=token_in_quantity,
+            override_state=current_state,
+        )
+        token0_delta = -token_out_quantity if zero_for_one is False else token_in_quantity
+        token1_delta = -token_out_quantity if zero_for_one is True else token_in_quantity
 
-        if token_out is not None and token_out == self.token0:
-            token_in = self.token1
-        elif token_out is not None and token_out == self.token1:
-            token_in = self.token0
+        return UniswapV2PoolSimulationResult(
+            amount0_delta=token0_delta,
+            amount1_delta=token1_delta,
+            initial_state=current_state,
+            final_state=UniswapV2PoolState(
+                pool=self.address,
+                reserves_token0=self.reserves_token0 + token0_delta,
+                reserves_token1=self.reserves_token1 + token1_delta,
+            ),
+        )
 
-        if token_in is not None and token_in_quantity is not None:
-            token_out_quantity = self.calculate_tokens_out_from_tokens_in(
-                token_in=token_in,
-                token_in_quantity=token_in_quantity,
-                # WIP: consolidate into single override_state arg
-                override_state=override_state,
-            )
-            token0_delta = -token_out_quantity if token_in is self.token1 else token_in_quantity
-            token1_delta = -token_out_quantity if token_in is self.token0 else token_in_quantity
+    def simulate_exact_output_swap(
+        self,
+        token_out: Erc20Token,
+        token_out_quantity: int,
+        override_state: UniswapV2PoolState | None = None,
+    ) -> UniswapV2PoolSimulationResult:
+        if token_out not in self.tokens:  # pragma: no cover
+            raise ValueError("token_out is unknown.")
 
-        elif token_out is not None and token_out_quantity is not None:
-            token_in_quantity = self.calculate_tokens_in_from_tokens_out(
-                token_out=token_out,
-                token_out_quantity=token_out_quantity,
-                # WIP: consolidate into single override_state arg
-                override_state=override_state,
-            )
-            token0_delta = token_in_quantity if token_in == self.token0 else -token_out_quantity
-            token1_delta = token_in_quantity if token_in == self.token1 else -token_out_quantity
+        if token_out_quantity == 0:  # pragma: no cover
+            raise ValueError("Zero output swap requested.")
 
-        with self._state_lock:
-            return UniswapV2PoolSimulationResult(
-                amount0_delta=token0_delta,
-                amount1_delta=token1_delta,
-                current_state=self.state.copy(),
-                future_state=UniswapV2PoolState(
-                    pool=self,
-                    reserves_token0=self.reserves_token0 + token0_delta,
-                    reserves_token1=self.reserves_token1 + token1_delta,
-                ),
-            )
+        if override_state:
+            logger.debug(f"State override: {override_state}")
 
-    def auto_update(
-        self,
-        block_number: int | None = None,
-        silent: bool = True,
-    ) -> Tuple[bool, UniswapV2PoolState]:
-        found_updates: bool = self.update_reserves(
-            silent=silent,
-            print_ratios=not silent,
-            print_reserves=not silent,
-            update_block=block_number,
-            override_update_method="polling",
+        current_state = override_state if override_state is not None else self.state.copy()
+        zero_for_one = token_out == self.token1
+
+        token_in_quantity = self.calculate_tokens_in_from_tokens_out(
+            token_out=token_out,
+            token_out_quantity=token_out_quantity,
+            override_state=current_state,
         )
-        return found_updates, self.state
+        token0_delta = token_in_quantity if zero_for_one is True else -token_out_quantity
+        token1_delta = token_in_quantity if zero_for_one is False else -token_out_quantity
 
-    def external_update(
-        self,
-        update: UniswapV2PoolExternalUpdate,
-        silent: bool = True,
-    ) -> bool:
-        return self.update_reserves(
-            silent=silent,
-            external_token0_reserves=update.reserves_token0,
-            external_token1_reserves=update.reserves_token1,
-            print_reserves=not silent,
-            print_ratios=not silent,
+        return UniswapV2PoolSimulationResult(
+            amount0_delta=token0_delta,
+            amount1_delta=token1_delta,
+            initial_state=current_state,
+            final_state=UniswapV2PoolState(
+                pool=self.address,
+                reserves_token0=self.reserves_token0 + token0_delta,
+                reserves_token1=self.reserves_token1 + token1_delta,
+            ),
         )
 
     def update_reserves(
         self,
         silent: bool = False,
         print_reserves: bool = True,
         print_ratios: bool = True,
         external_token0_reserves: int | None = None,
         external_token1_reserves: int | None = None,
         override_update_method: str | None = None,
         update_block: int | None = None,
     ) -> bool:
         """
-        Checks for updated reserve values when set to "polling", otherwise
-        if set to "external" assumes that provided reserves are valid
+        Updates token reserves. If update method is set to "polling", uses Web3 to read current
+        contract values. If set to "external", uses the provided reserves without verification.
         """
 
         _w3_contract = self._w3_contract
 
-        updates = False
+        update_method = override_update_method or self._update_method
 
         # Fetch the chain height if a specific update_block is not provided
         if update_block is None:
             update_block = config.get_web3().eth.get_block_number()
 
         # discard stale updates, but allow updating the same pool multiple times per block (necessary if sending sync events individually)
         if update_block < self.update_block:
             raise ExternalUpdateError(
                 f"Current state recorded at block {self.update_block}, received update for stale block {update_block}"
             )
         else:
             self.update_block = update_block
 
-        if self._update_method == "polling" or override_update_method == "polling":
+        state_updated = False
+        if update_method == "polling":
             try:
-                (
-                    reserves0,
-                    reserves1,
-                    *_,
-                ) = _w3_contract.functions.getReserves().call(block_identifier=self.update_block)
-                if (self.reserves_token0, self.reserves_token1) != (
-                    reserves0,
-                    reserves1,
-                ):
-                    self.reserves_token0, self.reserves_token1 = (
-                        reserves0,
-                        reserves1,
+                reserves0, reserves1, *_ = _w3_contract.functions.getReserves().call(
+                    block_identifier=self.update_block
+                )
+                if (self.reserves_token0, self.reserves_token1) != (reserves0, reserves1):
+                    self.state = UniswapV2PoolState(
+                        pool=self.address,
+                        reserves_token0=reserves0,
+                        reserves_token1=reserves1,
                     )
-                    self._notify_subscribers()
+                    # self.reserves_token0, self.reserves_token1 = reserves0, reserves1
                     self._pool_state_archive[update_block] = self.state
-                    updates = True
 
-                    if not silent:
+                    self._notify_subscribers(
+                        message=UniswapV2PoolStateUpdated(self.state),
+                    )
+                    state_updated = True
+
+                    if not silent:  # pragma: no cover
                         logger.info(f"[{self.name}]")
                         if print_reserves:
                             logger.info(f"{self.token0}: {self.reserves_token0}")
                             logger.info(f"{self.token1}: {self.reserves_token1}")
                         if print_ratios:
                             logger.info(
                                 f"{self.token0}/{self.token1}: {(self.reserves_token0/10**self.token0.decimals) / (self.reserves_token1/10**self.token1.decimals)}"
                             )
                             logger.info(
                                 f"{self.token1}/{self.token0}: {(self.reserves_token1/10**self.token1.decimals) / (self.reserves_token0/10**self.token0.decimals)}"
                             )
-                else:
-                    updates = False
             except Exception as e:
                 print(f"LiquidityPool: Exception in update_reserves (polling): {e}")
-        elif self._update_method == "external":
+        elif update_method == "external":
             if not (external_token0_reserves is not None and external_token1_reserves is not None):
                 raise ValueError(
                     "Called update_reserves without providing reserve values for both tokens!"
                 )
 
             # Skip follow-up processing if no updated values were found
             if (
                 external_token0_reserves == self.reserves_token0
                 and external_token1_reserves == self.reserves_token1
             ):
-                self.new_reserves = False
-                updates = False
+                state_updated = False
             else:
-                self.reserves_token0 = external_token0_reserves
-                self.reserves_token1 = external_token1_reserves
-                self.new_reserves = True
+                self.state = UniswapV2PoolState(
+                    pool=self.address,
+                    reserves_token0=external_token0_reserves,
+                    reserves_token1=external_token1_reserves,
+                )
+                # self.reserves_token0 = external_token0_reserves
+                # self.reserves_token1 = external_token1_reserves
+
                 self._pool_state_archive[update_block] = self.state
-                self._notify_subscribers()
+                self._notify_subscribers(
+                    message=UniswapV2PoolStateUpdated(self.state),
+                )
 
-            if not silent:
+            if not silent:  # pragma: no cover
                 logger.info(f"[{self.name}]")
                 if print_reserves:
                     logger.info(f"{self.token0}: {self.reserves_token0}")
                     logger.info(f"{self.token1}: {self.reserves_token1}")
                 if print_ratios:
                     logger.info(
                         f"{self.token0}/{self.token1}: {self.reserves_token0 / self.reserves_token1}"
                     )
                     logger.info(
                         f"{self.token1}/{self.token0}: {self.reserves_token1 / self.reserves_token0}"
                     )
-        elif self._update_method == "event":  # pragma: no cover
-            raise DeprecationError(
-                "The 'event' update method is deprecated. Please update your bot to use the default 'polling' method"
-            )
         else:  # pragma: no cover
-            raise ValueError(f"Update method {self._update_method} is not recognized.")
+            raise ValueError(f"Update method {update_method} is not recognized.")
 
-        return updates
+        return state_updated
 
 
-class CamelotLiquidityPool(CamelotStablePoolMixin, LiquidityPool):
+class CamelotLiquidityPool(LiquidityPool):
     def __init__(
         self,
         address: str,
         tokens: List[Erc20Token] | None = None,
         name: str | None = None,
         update_method: str = "polling",
         abi: List[Any] | None = None,
         silent: bool = False,
-        update_reserves_on_start: bool | None = None,  # deprecated
-        unload_brownie_contract_after_init: bool | None = None,  # deprecated
     ) -> None:
-        if unload_brownie_contract_after_init is not None:  # pragma: no cover
-            warnings.warn(
-                "unload_brownie_contract_after_init is no longer needed and is "
-                "ignored. Remove constructor argument to stop seeing this "
-                "message."
-            )
-
-        if update_reserves_on_start is not None:  # pragma: no cover
-            warnings.warn("update_reserves_on_start has been deprecated.")
-
         address = to_checksum_address(address)
 
-        if abi is None:
-            abi = CAMELOT_POOL_ABI
-
         _w3 = config.get_web3()
-        _w3_contract = config.get_web3().eth.contract(address=address, abi=abi)
+        _w3_contract = config.get_web3().eth.contract(address=address, abi=abi or CAMELOT_POOL_ABI)
 
         state_block = _w3.eth.get_block_number()
 
         (
             _,
             _,
             fee_token0,
@@ -828,28 +798,120 @@
         fee_token1 = Fraction(fee_token1, self.fee_denominator)
 
         super().__init__(
             address=address,
             tokens=tokens,
             name=name,
             update_method=update_method,
-            abi=abi,
+            abi=abi or CAMELOT_POOL_ABI,
             fee=(fee_token0, fee_token1),
             silent=silent,
             state_block=state_block,
         )
 
         self.stable_swap: bool = _w3_contract.functions.stableSwap().call()
 
+    def _calculate_tokens_out_from_tokens_in_stable_swap(
+        self,
+        token_in: Erc20Token,
+        token_in_quantity: int,
+        override_state: UniswapV2PoolState | None = None,
+    ) -> int:
+        """
+        Calculates the expected token OUTPUT for a target INPUT at current pool reserves.
+        Uses the self.token0 and self.token1 pointers to determine which token is being swapped in
+        """
+
+        if override_state is not None:  # pragma: no cover
+            logger.debug(f"State overrides applied: {override_state}")
+
+        if token_in_quantity <= 0:  # pragma: no cover
+            raise ZeroSwapError("token_in_quantity must be positive")
+
+        precision_multiplier_token0: int = 10**self.token0.decimals
+        precision_multiplier_token1: int = 10**self.token1.decimals
+
+        def _k(balance_0: int, balance_1: int) -> int:
+            _x: int = balance_0 * 10**18 // precision_multiplier_token0
+            _y: int = balance_1 * 10**18 // precision_multiplier_token1
+            _a: int = _x * _y // 10**18
+            _b: int = (_x * _x // 10**18) + (_y * _y // 10**18)
+            return _a * _b // 10**18  # x^3*y+y^3*x >= k
+
+        def _get_y(x_0: int, xy: int, y: int) -> int:
+            for _ in range(255):
+                y_prev = y
+                k = _f(x_0, y)
+                if k < xy:
+                    dy = (xy - k) * 10**18 // _d(x_0, y)
+                    y = y + dy
+                else:
+                    dy = (k - xy) * 10**18 // _d(x_0, y)
+                    y = y - dy
+
+                if y > y_prev:
+                    if y - y_prev <= 1:
+                        return y
+                else:
+                    if y_prev - y <= 1:
+                        return y
+
+            return y
+
+        def _f(x_0: int, y: int) -> int:
+            return (
+                x_0 * (y * y // 10**18 * y // 10**18) // 10**18
+                + (x_0 * x_0 // 10**18 * x_0 // 10**18) * y // 10**18
+            )
+
+        def _d(x_0: int, y: int) -> int:
+            return 3 * x_0 * (y * y // 10**18) // 10**18 + (x_0 * x_0 // 10**18 * x_0 // 10**18)
+
+        fee_percent = self.fee_denominator * (
+            self.fee_token0 if token_in is self.token0 else self.fee_token1
+        )
+
+        reserves_token0 = (
+            override_state.reserves_token0 if override_state is not None else self.reserves_token0
+        )
+        reserves_token1 = (
+            override_state.reserves_token1 if override_state is not None else self.reserves_token1
+        )
+
+        # Remove fee from amount received
+        token_in_quantity -= token_in_quantity * fee_percent // self.fee_denominator
+        xy = _k(reserves_token0, reserves_token1)
+        reserves_token0 = reserves_token0 * 10**18 // precision_multiplier_token0
+        reserves_token1 = reserves_token1 * 10**18 // precision_multiplier_token1
+        reserve_a, reserve_b = (
+            (reserves_token0, reserves_token1)
+            if token_in is self.token0
+            else (reserves_token1, reserves_token0)
+        )
+        token_in_quantity = (
+            token_in_quantity * 10**18 // precision_multiplier_token0
+            if token_in is self.token0
+            else token_in_quantity * 10**18 // precision_multiplier_token1
+        )
+        y = reserve_b - _get_y(token_in_quantity + reserve_a, xy, reserve_b)
+
+        return (
+            y
+            * (
+                precision_multiplier_token1
+                if token_in is self.token0
+                else precision_multiplier_token0
+            )
+            // 10**18
+        )
+
     def calculate_tokens_out_from_tokens_in(
         self,
         token_in: Erc20Token,
         token_in_quantity: int,
-        override_reserves_token0: int | None = None,  # TODO: drop after removing in superclass
-        override_reserves_token1: int | None = None,  # TODO: drop after removing in superclass
         override_state: UniswapV2PoolState | None = None,
     ) -> int:
         if self.stable_swap:
             return self._calculate_tokens_out_from_tokens_in_stable_swap(
                 token_in=token_in,
                 token_in_quantity=token_in_quantity,
                 override_state=override_state,
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_dataclasses.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_dataclasses.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 import dataclasses
-from typing import TYPE_CHECKING, Any, Dict, Tuple
+from typing import Any, Dict, Tuple
 
-from ..baseclasses import BasePoolState, UniswapSimulationResult
+from eth_typing import ChecksumAddress
 
-if TYPE_CHECKING:
-    from .v3_liquidity_pool import V3LiquidityPool
+from ..baseclasses import BasePoolState, Message, UniswapSimulationResult
 
 
 @dataclasses.dataclass(slots=True)
 class UniswapV3BitmapAtWord:
     bitmap: int = 0
     block: int | None = dataclasses.field(compare=False, default=None)
 
@@ -37,25 +36,28 @@
 
 @dataclasses.dataclass(slots=True, eq=False)
 class UniswapV3PoolExternalUpdate:
     block_number: int = dataclasses.field(compare=False)
     liquidity: int | None = None
     sqrt_price_x96: int | None = None
     tick: int | None = None
-    liquidity_change: Tuple[
-        int,  # Liquidity
-        int,  # TickLower
-        int,  # TickUpper
-    ] | None = None
+    liquidity_change: (
+        Tuple[
+            int,  # Liquidity
+            int,  # TickLower
+            int,  # TickUpper
+        ]
+        | None
+    ) = None
     tx: str | None = dataclasses.field(compare=False, default=None)
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV3PoolState(BasePoolState):
-    pool: "V3LiquidityPool"
+    pool: ChecksumAddress
     liquidity: int
     sqrt_price_x96: int
     tick: int
     tick_bitmap: Dict[int, UniswapV3BitmapAtWord] | None = dataclasses.field(default=None)
     tick_data: Dict[int, UniswapV3LiquidityAtTick] | None = dataclasses.field(default=None)
 
     def copy(self) -> "UniswapV3PoolState":
@@ -67,9 +69,14 @@
             tick_bitmap=self.tick_bitmap.copy() if self.tick_bitmap is not None else None,
             tick_data=self.tick_data.copy() if self.tick_data is not None else None,
         )
 
 
 @dataclasses.dataclass(slots=True, frozen=True)
 class UniswapV3PoolSimulationResult(UniswapSimulationResult):
-    current_state: UniswapV3PoolState = dataclasses.field(compare=False)
-    future_state: UniswapV3PoolState = dataclasses.field(compare=False)
+    initial_state: UniswapV3PoolState = dataclasses.field(compare=False)
+    final_state: UniswapV3PoolState = dataclasses.field(compare=False)
+
+
+@dataclasses.dataclass(slots=True, frozen=True)
+class UniswapV3PoolStateUpdated(Message):
+    state: UniswapV3PoolState
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_functions.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_functions.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,50 +1,71 @@
+from fractions import Fraction
 from itertools import cycle
-from typing import Iterable, List
+from typing import Callable, Iterable, Iterator, List, Tuple
 
 import eth_abi.abi
 from eth_typing import ChecksumAddress
 from eth_utils.address import to_checksum_address
 from hexbytes import HexBytes
 from web3 import Web3
 
 
 def decode_v3_path(path: bytes) -> List[ChecksumAddress | int]:
     """
-    Decode the `path` byte string used by the Uniswap V3 Router/Router2 contracts.
-    `path` is a close-packed encoding of pool addresses (20 bytes) and fees
-    (3 bytes).
+    Decode the `path` bytes used by the Uniswap V3 Router/Router2 contracts. `path` is a
+    close-packed encoding of 20 byte pool addresses, interleaved with 3 byte fees.
     """
+    ADDRESS_BYTES = 20
+    FEE_BYTES = 3
 
     def _extract_address(chunk: bytes) -> ChecksumAddress:
         return to_checksum_address(chunk)
 
     def _extract_fee(chunk: bytes) -> int:
         return int.from_bytes(chunk, byteorder="big")
 
-    path_pos = 0
+    if any(
+        [
+            len(path) < ADDRESS_BYTES + FEE_BYTES + ADDRESS_BYTES,
+            len(path) % (ADDRESS_BYTES + FEE_BYTES) != ADDRESS_BYTES,
+        ]
+    ):  # pragma: no cover
+        raise ValueError("Invalid path.")
+
+    chunk_length_and_decoder_function: Iterator[
+        Tuple[
+            int,
+            Callable[
+                [bytes],
+                ChecksumAddress | int,
+            ],
+        ]
+    ] = cycle(
+        [
+            (ADDRESS_BYTES, _extract_address),
+            (FEE_BYTES, _extract_fee),
+        ]
+    )
+
+    path_offset = 0
     decoded_path: List[ChecksumAddress | int] = []
-    # read alternating 20 and 3 byte chunks from the encoded path,
-    # store each address (hex string) and fee (int)
-    for byte_length in cycle((20, 3)):
-        chunk = HexBytes(path[path_pos : path_pos + byte_length])
-
-        match byte_length:
-            case 3:
-                decoded_path.append(_extract_fee(chunk))
-            case 20:
-                decoded_path.append(_extract_address(chunk))
-
-        path_pos += byte_length
-        if path_pos == len(path):
-            break
+    while path_offset != len(path):
+        byte_length, extraction_func = next(chunk_length_and_decoder_function)
+        chunk = HexBytes(path[path_offset : path_offset + byte_length])
+        decoded_path.append(extraction_func(chunk))
+        path_offset += byte_length
 
     return decoded_path
 
 
+def exchange_rate_from_sqrt_price_x96(sqrt_price_x96: int) -> Fraction:
+    # ref: https://blog.uniswap.org/uniswap-v3-math-primer
+    return Fraction(sqrt_price_x96**2, 2**192)
+
+
 def generate_v3_pool_address(
     token_addresses: Iterable[str],
     fee: int,
     factory_address: str,
     init_hash: str,
 ) -> ChecksumAddress:
     """
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/bit_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/bit_math.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/full_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/full_math.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/functions.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/functions.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/liquidity_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/liquidity_math.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/sqrt_price_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/sqrt_price_math.py`

 * *Files 12% similar despite different names*

```diff
@@ -68,33 +68,30 @@
 
 def getNextSqrtPriceFromAmount0RoundingUp(
     sqrtPX96: int,
     liquidity: int,
     amount: int,
     add: bool,
 ) -> int:
-    # we short circuit amount == 0 because the result is otherwise not guaranteed to equal the input price
     if amount == 0:
         return sqrtPX96
 
     numerator1 = liquidity << Q96_RESOLUTION
 
     if add:
-        product = amount * sqrtPX96
-        if product // amount == sqrtPX96:
-            denominator = numerator1 + product
-            if denominator >= numerator1:
-                # always fits in 160 bits
-                return FullMath.mulDivRoundingUp(numerator1, sqrtPX96, denominator)
-        return UnsafeMath.divRoundingUp(numerator1, numerator1 // sqrtPX96 + amount)
+        return (
+            FullMath.mulDivRoundingUp(numerator1, sqrtPX96, denominator)
+            if (
+                (product := amount * sqrtPX96) // amount == sqrtPX96
+                and (denominator := numerator1 + product) >= numerator1
+            )
+            else UnsafeMath.divRoundingUp(numerator1, numerator1 // sqrtPX96 + amount)
+        )
     else:
         product = amount * sqrtPX96
-        # if the product overflows, we know the denominator underflows
-        # in addition, we must check that the denominator does not underflow
-
         if not (product // amount == sqrtPX96 and numerator1 > product):
             raise EVMRevertError("product / amount == sqrtPX96 && numerator1 > product")
 
         denominator = numerator1 - product
         return to_uint160(FullMath.mulDivRoundingUp(numerator1, sqrtPX96, denominator))
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/swap_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/swap_math.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/tick_bitmap.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/tick_bitmap.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_libraries/tick_math.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_libraries/tick_math.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_liquidity_pool.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_liquidity_pool.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,51 +1,52 @@
 # TODO: add event prototype exporter method and handler for callbacks
 
 import dataclasses
 import warnings
 from bisect import bisect_left
 from decimal import Decimal
+from fractions import Fraction
 from threading import Lock
-from typing import TYPE_CHECKING, Any, Dict, List, Set, Tuple
+from typing import TYPE_CHECKING, Any, Dict, List, Tuple
 
 from eth_typing import ChecksumAddress
 from eth_utils.address import to_checksum_address
 from web3.contract.contract import Contract
 
 from .. import config
 from ..baseclasses import BaseLiquidityPool
 from ..dex.uniswap import TICKLENS_ADDRESSES
 from ..erc20_token import Erc20Token
 from ..exceptions import (
     BitmapWordUnavailableError,
-    BlockUnavailableError,
     EVMRevertError,
     ExternalUpdateError,
+    InsufficientAmountOutError,
     LiquidityPoolError,
     NoPoolStateAvailable,
 )
 from ..logging import logger
 from ..manager.token_manager import Erc20TokenHelperManager
 from ..registry.all_pools import AllPools
-from ..subscription_mixins import Subscriber, SubscriptionMixin
 from .abi import UNISWAP_V3_POOL_ABI
 from .v3_dataclasses import (
     UniswapV3BitmapAtWord,
     UniswapV3LiquidityAtTick,
     UniswapV3PoolExternalUpdate,
     UniswapV3PoolSimulationResult,
     UniswapV3PoolState,
+    UniswapV3PoolStateUpdated,
 )
-from .v3_functions import generate_v3_pool_address
+from .v3_functions import exchange_rate_from_sqrt_price_x96, generate_v3_pool_address
 from .v3_libraries import LiquidityMath, SwapMath, TickBitmap, TickMath
 from .v3_libraries.functions import to_int256
 from .v3_tick_lens import TickLens
 
 
-class V3LiquidityPool(SubscriptionMixin, BaseLiquidityPool):
+class V3LiquidityPool(BaseLiquidityPool):
     # Holds a reference to a TickLens contract object. This is a singleton
     # contract so there is no need to create separate references for each pool.
     # Dict is keyed by a tuple of chain ID and factory address
     _lens_contracts: Dict[Tuple[int, ChecksumAddress], TickLens] = dict()
 
     uniswap_version = 3
 
@@ -65,26 +66,26 @@
         name: str = "",
         update_method: str | None = None,
         abi: List[Any] | None = None,
         factory_address: str | None = None,
         factory_init_hash: str | None = None,
         extra_words: int = 10,
         silent: bool = False,
-        tick_data: Dict[int, Dict[str, Any]] | None = None,
-        tick_bitmap: Dict[int, Dict[str, Any]] | None = None,
+        tick_data: Dict[int, Dict[str, Any] | UniswapV3LiquidityAtTick] | None = None,
+        tick_bitmap: Dict[int, Dict[str, Any] | UniswapV3BitmapAtWord] | None = None,
         state_block: int | None = None,
     ):
         self.address = to_checksum_address(address)
         self.abi = abi if abi is not None else UNISWAP_V3_POOL_ABI
 
         _w3 = config.get_web3()
         _w3_contract = self._w3_contract
 
         self.state: UniswapV3PoolState = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=0,
             sqrt_price_x96=0,
             tick=0,
             tick_bitmap=dict(),
             tick_data=dict(),
         )
 
@@ -202,17 +203,17 @@
                     else liquidity_at_tick
                 )
                 for tick, liquidity_at_tick in tick_data.items()
             }
 
         if tick_bitmap is None and tick_data is None:
             logger.debug(f"{self} @ {self.address} updating -> {tick_bitmap=}, {tick_data=}")
-            word_position, _ = self._get_tick_bitmap_position(self.tick)
+            word_position, _ = self._get_tick_bitmap_word_and_bit_position(self.tick)
 
-            self._update_tick_data_at_word(
+            self._fetch_tick_data_at_word(
                 word_position,
                 block_number=self._update_block,
             )
 
         self.liquidity = _w3_contract.functions.liquidity().call(
             block_identifier=self._update_block
         )
@@ -221,27 +222,27 @@
             self.sqrt_price_x96,
             self.tick,
             *_,
         ) = _w3_contract.functions.slot0().call(block_identifier=self._update_block)
 
         self._pool_state_archive: Dict[int, UniswapV3PoolState] = {
             0: UniswapV3PoolState(
-                pool=self,
+                pool=self.address,
                 liquidity=0,
                 sqrt_price_x96=0,
                 tick=0,
             ),
             self._update_block: self.state,
         }
 
         AllPools(_w3.eth.chain_id)[self.address] = self
 
-        self._subscribers: Set[Subscriber] = set()
+        self._subscribers = set()
 
-        if not silent:
+        if not silent:  # pragma: no cover
             logger.info(self.name)
             logger.info(f"• Token 0: {self.token0}")
             logger.info(f"• Token 1: {self.token1}")
             logger.info(f"• Fee: {self._fee}")
             logger.info(f"• Liquidity: {self.liquidity}")
             logger.info(f"• SqrtPrice: {self.sqrt_price_x96}")
             logger.info(f"• Tick: {self.tick}")
@@ -269,94 +270,34 @@
 
     def __repr__(self) -> str:  # pragma: no cover
         return f"V3LiquidityPool(address={self.address}, token0={self.token0}, token1={self.token1}, fee={self._fee})"
 
     def __str__(self) -> str:
         return self.name
 
-    def _get_tick_bitmap_position(self, tick: int) -> Tuple[int, int]:
-        """
-        Retrieves the wordPosition and bitPosition for the input tick
-
-        This function corrects internally for tick spacing! e.g. tick=600 is the
-        11th initialized tick for an LP with tickSpacing of 60, starting at 0.
-        Each "word" in the tickBitmap holds 256 initialized positions, so the 11th
-        position of the 1st word will represent tick=600.
-
-        Calling `get_tick_bitmap_position(600)` returns (0,10), where:
-            0 = wordPosition (zero-indexed)
-            10 = bitPosition (zero-indexed)
-        """
-        return TickBitmap.position(int(Decimal(tick) // self._tick_spacing))
-
-    def _update_tick_data_at_word(
+    def _calculate_swap(
         self,
-        word_position: int,
-        block_number: int | None = None,
-    ) -> None:
-        """
-        Update the initialized tick values at a specific word (a 32 byte number
-        representing 256 ticks at the tickSpacing interval). Store
-        the liquidity values in the `self.tick_data` dictionary using the tick
-        as the key, and update the `self.tick_bitmap` dictionary.
-
-        Uses a lock to guard state-modifying methods that might cause race conditions
-        when used with threads.
-        """
-
-        if word_position in self.tick_bitmap:
-            logger.debug(f"Short-circuiting update, word position {word_position} already known.")
-            return
-
-        _w3_contract = self._w3_contract
-
-        if block_number is None:
-            block_number = config.get_web3().eth.get_block_number()
-
-        with self._state_lock:
-            try:
-                _tick_bitmap = _w3_contract.functions.tickBitmap(word_position).call(
-                    block_identifier=block_number,
-                )
-                _tick_data = self.lens._w3_contract.functions.getPopulatedTicksInWord(
-                    self.address, word_position
-                ).call(block_identifier=block_number)
-            except Exception as e:
-                print(f"(V3LiquidityPool) (_update_tick_data_at_word) (single tick): {e}")
-                print(type(e))
-                raise
-            else:
-                self.tick_bitmap[word_position] = UniswapV3BitmapAtWord(
-                    bitmap=_tick_bitmap,
-                    block=block_number,
-                )
-                for tick, liquidity_net, liquidity_gross in _tick_data:
-                    self.tick_data[tick] = UniswapV3LiquidityAtTick(
-                        liquidityNet=liquidity_net,
-                        liquidityGross=liquidity_gross,
-                        block=block_number,
-                    )
-
-    def _uniswap_v3_pool_swap(
-        self,
-        zeroForOne: bool,
+        zero_for_one: bool,
         amount_specified: int,
         sqrt_price_limit_x96: int,
         override_start_liquidity: int | None = None,
         override_start_sqrt_price_x96: int | None = None,
         override_start_tick: int | None = None,
         override_tick_data: Dict[int, Any] | None = None,
         override_tick_bitmap: Dict[int, Any] | None = None,
     ) -> Tuple[int, int, int, int, int]:
         """
-        This function is ported and adapted from the UniswapV3Pool.sol contract
-        at https://github.com/Uniswap/v3-core/blob/main/contracts/UniswapV3Pool.sol
+        This function is ported and adapted from the UniswapV3Pool.sol contract at
+        https://github.com/Uniswap/v3-core/blob/main/contracts/UniswapV3Pool.sol
 
-        It is called by the `calculate_tokens_in_from_tokens_out` and `calculate_tokens_out_from_tokens_in` methods to calculate
-        swap amounts, ticks crossed, liquidity changes at various ticks, etc.
+        Returns a tuple with amounts and final pool state values for a successful swap:
+        (amount0, amount1, sqrt_price_x96, liquidity, tick)
+
+        A negative amount indicates the token quantity sent to the swapper, and a positive amount
+        indicates the token quantity deposited.
         """
 
         @dataclasses.dataclass(slots=True, eq=False)
         class SwapCache:
             liquidity_start: int
             tick_cumulative: int
 
@@ -374,15 +315,15 @@
             tick_next: int = 0
             initialized: bool = False
             sqrt_price_next_x96: int = 0
             amount_in: int = 0
             amount_out: int = 0
             fee_amount: int = 0
 
-        if amount_specified == 0:
+        if amount_specified == 0:  # pragma: no cover
             raise EVMRevertError("AS")
 
         _liquidity = (
             override_start_liquidity if override_start_liquidity is not None else self.liquidity
         )
         _sqrt_price_x96 = (
             override_start_sqrt_price_x96
@@ -391,72 +332,75 @@
         )
         _tick = override_start_tick if override_start_tick is not None else self.tick
         _tick_bitmap = (
             override_tick_bitmap if override_tick_bitmap is not None else self.tick_bitmap
         )
         _tick_data = override_tick_data if override_tick_data is not None else self.tick_data
 
-        if not (
+        if zero_for_one is True and not (
             sqrt_price_limit_x96 < _sqrt_price_x96
             and sqrt_price_limit_x96 > TickMath.MIN_SQRT_RATIO
-            if zeroForOne
-            else sqrt_price_limit_x96 > _sqrt_price_x96
+        ):  # pragma: no cover
+            raise EVMRevertError("SPL")
+
+        if zero_for_one is False and not (
+            sqrt_price_limit_x96 > _sqrt_price_x96
             and sqrt_price_limit_x96 < TickMath.MAX_SQRT_RATIO
-        ):
+        ):  # pragma: no cover
             raise EVMRevertError("SPL")
 
-        exactInput = amount_specified > 0
+        exact_input = amount_specified > 0
         cache = SwapCache(liquidity_start=_liquidity, tick_cumulative=0)
         state = SwapState(
             amount_specified_remaining=amount_specified,
             amount_calculated=0,
             sqrt_price_x96=_sqrt_price_x96,
             tick=_tick,
             liquidity=cache.liquidity_start,
         )
 
         while (
             state.amount_specified_remaining != 0 and state.sqrt_price_x96 != sqrt_price_limit_x96
         ):
             step = StepComputations()
-
             step.sqrt_price_start_x96 = state.sqrt_price_x96
 
             while True:
                 try:
                     (
                         step.tick_next,
                         step.initialized,
                     ) = TickBitmap.nextInitializedTickWithinOneWord(
                         _tick_bitmap,
                         state.tick,
                         self._tick_spacing,
-                        zeroForOne,
+                        zero_for_one,
                     )
                 except BitmapWordUnavailableError as e:
                     missing_word = e.args[1]
                     if self._sparse_bitmap:
                         logger.debug(f"(swap) {self.name} fetching word {missing_word}")
-                        self._update_tick_data_at_word(word_position=missing_word)
+                        self._fetch_tick_data_at_word(word_position=missing_word)
                     else:
                         # bitmap is complete, so mark the word as empty
                         # self.tick_bitmap[missing_word] = UniswapV3BitmapAtWord()
                         _tick_bitmap[missing_word] = UniswapV3BitmapAtWord()
                 else:
                     # nextInitializedTickWithinOneWord will search up to 256 ticks away, which may
                     # return a tick in an adjacent word if there are no initialized ticks in the current word.
                     # This word may not be known to the helper, so check and fetch the containing word for this tick
-                    tick_next_word, _ = self._get_tick_bitmap_position(step.tick_next)
+                    tick_next_word, _ = self._get_tick_bitmap_word_and_bit_position(step.tick_next)
 
                     if self._sparse_bitmap and tick_next_word not in _tick_bitmap:
                         logger.debug(
                             f"tickNext={step.tick_next} out of range! Fetching word={tick_next_word}"
                             f"\n{self.name}"
                         )
-                        self._update_tick_data_at_word(word_position=tick_next_word)
+                        self._fetch_tick_data_at_word(word_position=tick_next_word)
+
                     break
 
             # ensure that we do not overshoot the min/max tick, as the tick bitmap is not aware of these bounds
             if step.tick_next < TickMath.MIN_TICK:
                 step.tick_next = TickMath.MIN_TICK
             elif step.tick_next > TickMath.MAX_TICK:
                 step.tick_next = TickMath.MAX_TICK
@@ -471,108 +415,152 @@
                 step.amount_out,
                 step.fee_amount,
             ) = SwapMath.computeSwapStep(
                 state.sqrt_price_x96,
                 sqrt_price_limit_x96
                 if (
                     step.sqrt_price_next_x96 < sqrt_price_limit_x96
-                    if zeroForOne
+                    if zero_for_one
                     else step.sqrt_price_next_x96 > sqrt_price_limit_x96
                 )
                 else step.sqrt_price_next_x96,
                 state.liquidity,
                 state.amount_specified_remaining,
                 self._fee,
             )
 
-            if exactInput:
+            if exact_input:
                 state.amount_specified_remaining -= to_int256(step.amount_in + step.fee_amount)
                 state.amount_calculated = to_int256(state.amount_calculated - step.amount_out)
             else:
                 state.amount_specified_remaining += to_int256(step.amount_out)
                 state.amount_calculated = to_int256(
                     state.amount_calculated + step.amount_in + step.fee_amount
                 )
 
             # shift tick if we reached the next price
-            if state.sqrt_price_x96 == step.sqrt_price_next_x96:
+            if state.sqrt_price_x96 == step.sqrt_price_next_x96:  # pragma: no branch
                 # if the tick is initialized, run the tick transition
                 if step.initialized:
                     tick_next = step.tick_next
                     liquidityNet = _tick_data[tick_next].liquidityNet
 
-                    if zeroForOne:
+                    if zero_for_one:
                         liquidityNet = -liquidityNet
 
                     state.liquidity = LiquidityMath.addDelta(state.liquidity, liquidityNet)
 
-                state.tick = step.tick_next - 1 if zeroForOne else step.tick_next
+                state.tick = step.tick_next - 1 if zero_for_one else step.tick_next
 
-            elif state.sqrt_price_x96 != step.sqrt_price_start_x96:
+            elif state.sqrt_price_x96 != step.sqrt_price_start_x96:  # pragma: no branch
                 # recompute unless we're on a lower tick boundary (i.e. already transitioned ticks), and haven't moved
                 state.tick = TickMath.getTickAtSqrtRatio(state.sqrt_price_x96)
 
         amount0, amount1 = (
             (
                 amount_specified - state.amount_specified_remaining,
                 state.amount_calculated,
             )
-            if zeroForOne == exactInput
+            if zero_for_one == exact_input
             else (
                 state.amount_calculated,
                 amount_specified - state.amount_specified_remaining,
             )
         )
 
         return (
             amount0,
             amount1,
             state.sqrt_price_x96,
             state.liquidity,
             state.tick,
         )
 
+    def _fetch_tick_data_at_word(
+        self,
+        word_position: int,
+        block_number: int | None = None,
+    ) -> None:
+        """
+        Update the initialized tick values within a specified word position. A word is divided into
+        256 ticks, spaced per the tickSpacing interval.
+        """
+
+        _w3_contract = self._w3_contract
+
+        if block_number is None:
+            block_number = config.get_web3().eth.get_block_number()
+
+        try:
+            _tick_bitmap = _w3_contract.functions.tickBitmap(word_position).call(
+                block_identifier=block_number,
+            )
+            _tick_data = self.lens._w3_contract.functions.getPopulatedTicksInWord(
+                self.address, word_position
+            ).call(block_identifier=block_number)
+        except Exception as e:
+            print(f"(V3LiquidityPool) (_update_tick_data_at_word) (single tick): {e}")
+            print(type(e))
+            raise
+        else:
+            self.tick_bitmap[word_position] = UniswapV3BitmapAtWord(
+                bitmap=_tick_bitmap,
+                block=block_number,
+            )
+            for tick, liquidity_net, liquidity_gross in _tick_data:
+                self.tick_data[tick] = UniswapV3LiquidityAtTick(
+                    liquidityNet=liquidity_net,
+                    liquidityGross=liquidity_gross,
+                    block=block_number,
+                )
+
+    def _get_tick_bitmap_word_and_bit_position(self, tick: int) -> Tuple[int, int]:
+        """
+        Retrieves the word and bit position (both zero indexed) for the tick. Accounts for the pool spacing.
+        """
+        return TickBitmap.position(int(Decimal(tick) // self._tick_spacing))
+
     @property
     def liquidity(self) -> int:
         return self.state.liquidity
 
     @liquidity.setter
     def liquidity(self, new_liquidity: int) -> None:
         self.state = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=new_liquidity,
             sqrt_price_x96=self.sqrt_price_x96,
             tick=self.tick,
             tick_bitmap=self.tick_bitmap,
             tick_data=self.tick_data,
         )
 
     @property
     def sqrt_price_x96(self) -> int:
         return self.state.sqrt_price_x96
 
     @sqrt_price_x96.setter
     def sqrt_price_x96(self, new_sqrt_price_x96: int) -> None:
         self.state = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=self.liquidity,
             sqrt_price_x96=new_sqrt_price_x96,
             tick=self.tick,
             tick_bitmap=self.tick_bitmap,
             tick_data=self.tick_data,
         )
 
     @property
     def tick(self) -> int:
         return self.state.tick
 
     @tick.setter
     def tick(self, new_tick: int) -> None:
         self.state = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=self.liquidity,
             sqrt_price_x96=self.sqrt_price_x96,
             tick=new_tick,
             tick_bitmap=self.tick_bitmap,
             tick_data=self.tick_data,
         )
 
@@ -581,15 +569,15 @@
         if TYPE_CHECKING:
             assert self.state.tick_bitmap is not None
         return self.state.tick_bitmap
 
     @tick_bitmap.setter
     def tick_bitmap(self, new_tick_bitmap: Dict[int, UniswapV3BitmapAtWord]) -> None:
         self.state = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=self.liquidity,
             sqrt_price_x96=self.sqrt_price_x96,
             tick=self.tick,
             tick_bitmap=new_tick_bitmap,
             tick_data=self.tick_data,
         )
 
@@ -598,15 +586,15 @@
         if TYPE_CHECKING:
             assert self.state.tick_data is not None
         return self.state.tick_data
 
     @tick_data.setter
     def tick_data(self, new_tick_data: Dict[int, UniswapV3LiquidityAtTick]) -> None:
         self.state = UniswapV3PoolState(
-            pool=self,
+            pool=self.address,
             liquidity=self.liquidity,
             sqrt_price_x96=self.sqrt_price_x96,
             tick=self.tick,
             tick_bitmap=self.tick_bitmap,
             tick_data=new_tick_data,
         )
 
@@ -635,29 +623,20 @@
         """
 
         _w3_contract = self._w3_contract
 
         with self._state_lock:
             updated = False
 
-            # use the block_number if provided, otherwise pull from web3
-            if block_number is None:
-                block_number = config.get_web3().eth.get_block_number()
-
-            if block_number < self._update_block:
-                raise ExternalUpdateError(
-                    f"Current state recorded at block {self._update_block}, received update for stale block {block_number}"
-                )
+            block_number = (
+                config.get_web3().eth.get_block_number() if block_number is None else block_number
+            )
 
-            (
-                _sqrt_price_x96,
-                _tick,
-                *_,
-            ) = _w3_contract.functions.slot0().call(
-                block_identifier=block_number,
+            _sqrt_price_x96, _tick, *_ = _w3_contract.functions.slot0().call(
+                block_identifier=block_number
             )
             _liquidity = _w3_contract.functions.liquidity().call(block_identifier=block_number)
 
             if self.sqrt_price_x96 != _sqrt_price_x96:
                 updated = True
                 self.sqrt_price_x96 = _sqrt_price_x96
 
@@ -666,27 +645,24 @@
                 self.tick = _tick
 
             if self.liquidity != _liquidity:
                 updated = True
                 self.liquidity = _liquidity
 
             if updated:
-                self._notify_subscribers()
-                # WIP: maintain a dict of pool states by block to unwind updates that were removed by a re-org
+                self._notify_subscribers(
+                    message=UniswapV3PoolStateUpdated(self.state),
+                )
                 self._pool_state_archive[block_number] = self.state
 
-            if not silent:
+            if not silent:  # pragma: no cover
                 logger.info(f"Liquidity: {self.liquidity}")
                 logger.info(f"SqrtPriceX96: {self.sqrt_price_x96}")
                 logger.info(f"Tick: {self.tick}")
 
-            # WORKAROUND: update the block even if there are no state changes
-            # pools were being repeatedly caught by "stale pool" checks
-            self._update_block = block_number
-
         return updated, self.state
 
     def calculate_tokens_out_from_tokens_in(
         self,
         token_in: Erc20Token,
         token_in_quantity: int,
         override_state: UniswapV3PoolState | None = None,
@@ -713,25 +689,25 @@
             - 'liquidity'
             - 'sqrt_price_x96'
             - 'tick'
             - 'tick_data'  (not yet implemented)
             - 'tick_bitmap'  (not yet implemented)
         """
 
-        if token_in not in self.tokens:
+        if token_in not in self.tokens:  # pragma: no cover
             raise ValueError("token_in not found!")
 
         if override_state:
             logger.debug(f"V3 calc with overridden state: {override_state}")
 
         _is_zero_for_one = token_in == self.token0
 
         try:
-            amount0_delta, amount1_delta, *_ = self._uniswap_v3_pool_swap(
-                zeroForOne=_is_zero_for_one,
+            amount0_delta, amount1_delta, *_ = self._calculate_swap(
+                zero_for_one=_is_zero_for_one,
                 amount_specified=token_in_quantity,
                 sqrt_price_limit_x96=(
                     TickMath.MIN_SQRT_RATIO + 1 if _is_zero_for_one else TickMath.MAX_SQRT_RATIO - 1
                 ),
                 override_start_liquidity=(
                     override_state.liquidity if override_state is not None else None
                 ),
@@ -742,15 +718,15 @@
                 override_tick_bitmap=(
                     override_state.tick_bitmap if override_state is not None else self.tick_bitmap
                 ),
                 override_tick_data=(
                     override_state.tick_data if override_state is not None else self.tick_data
                 ),
             )
-        except EVMRevertError as e:
+        except EVMRevertError as e:  # pragma: no cover
             raise LiquidityPoolError(f"Simulated execution reverted: {e}") from e
         else:
             return -amount1_delta if _is_zero_for_one else -amount0_delta
 
     def calculate_tokens_in_from_tokens_out(
         self,
         token_out: Erc20Token,
@@ -763,37 +739,37 @@
 
         It is similar to calling quoteExactOutputSingle using the quoter contract with arguments:
         `quoteExactOutputSingle(
             tokenIn=[automatically determined by helper],
             tokenOut=token_out,
             fee=[automatically determined by helper],
             amountOut=token_out_quantity,
-            sqrt_price_limitX96 = 0
+            sqrtPriceLimitX96 = 0
         )` which returns the value `amountIn`
 
-        Note that this wrapper function always assumes that the sqrt_price_limitx96 argument is unset, thus the
+        Note that this wrapper function always assumes that the sqrtPriceLimitX96 argument is unset, thus the
         swap calculation will continue until the target amount is satisfied, regardless of price impact
 
         Accepts a dictionary of state values (`override_state`) to allow calculations beginning from an
         arbitrary starting point. This dictionary must have one or more of the following keys:
             - 'liquidity'
             - 'sqrt_price_x96'
             - 'tick'
-            - 'tick_data'  (not yet implemented)
-            - 'tick_bitmap'  (not yet implemented)
+            - 'tick_data'
+            - 'tick_bitmap'
         """
 
-        if token_out not in self.tokens:
+        if token_out not in self.tokens:  # pragma: no cover
             raise ValueError("token_out not found!")
 
         _is_zero_for_one = token_out == self.token1
 
         try:
-            amount0_delta, amount1_delta, *_ = self._uniswap_v3_pool_swap(
-                zeroForOne=_is_zero_for_one,
+            amount0_delta, amount1_delta, *_ = self._calculate_swap(
+                zero_for_one=_is_zero_for_one,
                 amount_specified=-token_out_quantity,
                 sqrt_price_limit_x96=(
                     TickMath.MIN_SQRT_RATIO + 1 if _is_zero_for_one else TickMath.MAX_SQRT_RATIO - 1
                 ),
                 override_start_liquidity=(
                     override_state.liquidity if override_state is not None else None
                 ),
@@ -804,163 +780,103 @@
                 override_tick_bitmap=(
                     override_state.tick_bitmap if override_state is not None else self.tick_bitmap
                 ),
                 override_tick_data=(
                     override_state.tick_data if override_state is not None else self.tick_data
                 ),
             )
-        except EVMRevertError as e:
+        except EVMRevertError as e:  # pragma: no cover
             raise LiquidityPoolError(f"Simulated execution reverted: {e}") from e
         else:
+            if _is_zero_for_one is True and -amount1_delta < token_out_quantity:
+                raise InsufficientAmountOutError(
+                    "Insufficient liquidity to swap for the requested amount."
+                )
+            if _is_zero_for_one is False and -amount0_delta < token_out_quantity:
+                raise InsufficientAmountOutError(
+                    "Insufficient liquidity to swap for the requested amount."
+                )
+
             return amount0_delta if _is_zero_for_one else amount1_delta
 
     def external_update(
         self,
-        update: UniswapV3PoolExternalUpdate | None = None,
-        updates: Dict[str, Any] | None = None,
-        block_number: int | None = None,
+        update: UniswapV3PoolExternalUpdate,
         silent: bool = True,
-        fetch_missing: bool | None = None,
-        force: bool = False,  # added primarily to support liquidity bootstrapping without excessive refactoring
     ) -> bool:
         """
         Process a `UniswapV3PoolExternalUpdate` with one or more of the following update types:
+            - `block_number`: int
             - `tick`: int
             - `liquidity`: int
             - `sqrt_price_x96`: int
-            - `liquidity_change`: tuple of (liquidity_delta, lower_tick, upper_tick). The delta can be positive or negative to indicate added or removed liquidity.
+            - `liquidity_change`: tuple of (liquidity_delta, lower_tick, upper_tick). The delta can
+                be positive or negative to indicate added or removed liquidity.
 
-        `block_number` is validated against the most recently recorded block prior to recording any changes. If `force=True`, the block check is skipped.
+        `block_number` is validated against the most recently recorded block prior to recording any changes.
 
         If any update is processed, `self.state` and `self.update_block` are updated.
 
         Returns a bool indicating whether any updated state value was recorded.
 
         @dev This method uses a lock to guard state-modifying methods that might cause race conditions when used with threads.
         """
 
-        def is_valid_update_block(block_number: int) -> bool:
-            """
-            Check if `block_number` is valid (matches or exceeds the last update block)
-
-            The `force` argument to `external_update` will trigger this to always return True
-            """
-            return True if force else block_number >= self._update_block
-
-        if fetch_missing is not None:
-            raise DeprecationWarning(
-                "The fetch_missing argument has been deprecated, to address this exception remove it from any calls to external_update"
-            )
-
-        # warnings.warn(
-        #     "\n"
-        #     + "The `updates` dict argument is deprecated and will be "
-        #     + "removed in the future. It has been converted in-place to a "
-        #     + "`UniswapV3PoolExternalUpdate` object. Pass this using the "
-        #     + "`update=` argument to remove this warning."
-        #     + "\n"
-        #     + "For the values you've provided, pass this data using "
-        #     + "the format: \n"
-        #     + "update=UniswapV3PoolExternalUpdate(\n"
-        #     + (
-        #         f"    liquidity={val}\n"
-        #         if (val := updates.get("liquidity")) is not None
-        #         else ""
-        #     )
-        #     + (
-        #         f"    sqrt_price_x96={val}\n"
-        #         if (val := updates.get("sqrt_price_x96")) is not None
-        #         else ""
-        #     )
-        #     + (
-        #         f"    tick={val}\n"
-        #         if (val := updates.get("tick")) is not None
-        #         else ""
-        #     )
-        #     + ")",
-        # )
-
         if TYPE_CHECKING:
             assert isinstance(update, UniswapV3PoolExternalUpdate)
 
-        # If a block number was not provided, pull from web3
-        if block_number is None:
-            if update is not None:
-                block_number = update.block_number
-            else:
-                block_number = config.get_web3().eth.get_block_number()
-                logger.warning(
-                    f"(V3LiquidityPool.external_update) block_number was not provided, using {block_number} from chain"
-                )
-
-        if not is_valid_update_block(block_number):
+        if update.block_number < self._update_block:
             raise ExternalUpdateError(
-                f"Rejected update for block {block_number} in the past, current update block is {self._update_block}"
-            )
-
-        if updates and not update:
-            update = UniswapV3PoolExternalUpdate(
-                block_number=block_number,
-                liquidity=updates.get("liquidity"),
-                sqrt_price_x96=updates.get("sqrt_price_x96"),
-                tick=updates.get("tick"),
-                liquidity_change=updates.get("liquidity_change"),
+                f"Rejected update for block {update.block_number} in the past, current update block is {self._update_block}"
             )
 
         with self._state_lock:
             updated_state = False
 
-            for update_type in ("tick", "liquidity", "sqrt_price_x96"):
-                if (update_value := getattr(update, update_type, None)) and update_value != getattr(
-                    self, update_type
-                ):
-                    setattr(self, update_type, update_value)
-                    updated_state = True
-
-            if update.liquidity_change and update.liquidity_change[0] != 0:
-                (
-                    liquidity_delta,
-                    lower_tick,
-                    upper_tick,
-                ) = update.liquidity_change
+            if update.tick is not None and update.tick != self.tick:
+                updated_state = True
+                self.tick = update.tick
 
+            if update.liquidity is not None and update.liquidity != self.liquidity:
                 updated_state = True
+                self.liquidity = update.liquidity
 
-                # adjust in-range liquidity if current tick is within the position's range
-                if lower_tick <= self.tick < upper_tick and not force:
+            if update.sqrt_price_x96 is not None and update.sqrt_price_x96 != self.sqrt_price_x96:
+                updated_state = True
+                self.sqrt_price_x96 = update.sqrt_price_x96
+
+            if update.liquidity_change is not None and update.liquidity_change[0] != 0:
+                updated_state = True
+                liquidity_delta, lower_tick, upper_tick = update.liquidity_change
+
+                # Adjust in-range liquidity if current tick is within the modified range
+                if lower_tick <= self.tick < upper_tick:
                     liquidity_before = self.liquidity
                     self.liquidity += liquidity_delta
                     logger.debug(
                         f"Adjusting in-range liquidity, TX {update.tx}, tick range = [{lower_tick},{upper_tick}], current tick = {self.tick}, {self.address=}, previous liquidity = {liquidity_before}, liquidity change = {liquidity_delta}, current liquidity = {self.liquidity}"
                     )
-                    assert (
-                        self.liquidity >= 0
-                    ), f"{self.address=}, {liquidity_before=}, {self.liquidity=}, {update=} {block_number=} {self.tick=}"
 
-                for i, tick in enumerate([lower_tick, upper_tick]):
-                    tick_word, _ = self._get_tick_bitmap_position(tick)
+                for tick in (lower_tick, upper_tick):
+                    tick_word, _ = self._get_tick_bitmap_word_and_bit_position(tick)
 
                     if tick_word not in self.tick_bitmap:
-                        # the tick bitmap must be available for the word prior to flipping
-                        # the initialized status of any tick
+                        # The tick bitmap must be known for the word prior to changing the
+                        # initialized status of any tick
 
                         if self._sparse_bitmap:
                             logger.debug(
                                 f"(external_update) {tick_word=} not found in tick_bitmap {self.tick_bitmap.keys()=}"
                             )
-                            try:
-                                self._update_tick_data_at_word(
-                                    word_position=tick_word,
-                                    # Fetch the word using the previous block as a known "good" state snapshot
-                                    block_number=block_number - 1,
-                                )
-                            except ValueError as e:
-                                raise BlockUnavailableError(
-                                    f"Could not query chain at block {block_number - 1}"
-                                ) from e
+                            self._fetch_tick_data_at_word(
+                                word_position=tick_word,
+                                # Fetch the word using the previous block as a known "good" state snapshot
+                                block_number=update.block_number - 1,
+                            )
+
                         else:
                             # The bitmap is complete (sparse=False), so mark this word as empty
                             self.tick_bitmap[tick_word] = UniswapV3BitmapAtWord()
 
                     # Get the liquidity info for this tick
                     try:
                         tick_liquidity_net, tick_liquidity_gross = (
@@ -971,75 +887,139 @@
                         # if it doesn't exist, initialize the tick and set the current values to zero
                         tick_liquidity_net = 0
                         tick_liquidity_gross = 0
                         TickBitmap.flipTick(
                             self.tick_bitmap,
                             tick,
                             self._tick_spacing,
-                            update_block=block_number,
+                            update_block=update.block_number,
                         )
 
                     # MINT: add liquidity at lower tick (i==0), subtract at upper tick (i==1)
                     # BURN: subtract liquidity at lower tick (i==0), add at upper tick (i==1)
                     # Same equation, but for BURN events the liquidity_delta value is negative
                     new_liquidity_net = (
                         tick_liquidity_net + liquidity_delta
-                        if i == 0
+                        if tick == lower_tick
                         else tick_liquidity_net - liquidity_delta
                     )
                     new_liquidity_gross = tick_liquidity_gross + liquidity_delta
 
-                    # Delete entirely if there is no liquidity referencing this tick, then flip it in the bitmap
                     if new_liquidity_gross == 0:
+                        # Delete if there is no remaining liquidity referencing this tick, then
+                        # flip it in the bitmap
                         del self.tick_data[tick]
                         TickBitmap.flipTick(
                             self.tick_bitmap,
                             tick,
                             self._tick_spacing,
-                            update_block=block_number,
+                            update_block=update.block_number,
                         )
-                    # otherwise record the new values
                     else:
                         self.tick_data[tick] = UniswapV3LiquidityAtTick(
                             liquidityNet=new_liquidity_net,
                             liquidityGross=new_liquidity_gross,
-                            block=block_number,
+                            block=update.block_number,
                         )
 
             if not silent:
                 logger.debug(f"Liquidity: {self.liquidity}")
                 logger.debug(f"SqrtPriceX96: {self.sqrt_price_x96}")
                 logger.debug(f"Tick: {self.tick}")
                 logger.debug(
                     f"liquidity event: {liquidity_delta} in tick range [{lower_tick},{upper_tick}], pool: {self.name}"
                     "\n"
                     f"old liquidity: {tick_liquidity_net} net, {tick_liquidity_gross} gross"
                     "\n"
                     f"new liquidity: {new_liquidity_net} net, {new_liquidity_gross} gross"
                 )
-                logger.debug(f"update block: {block_number} (last={self._update_block})")
+                logger.debug(f"update block: {update.block_number} (last={self._update_block})")
 
             if updated_state:
-                self._pool_state_archive[block_number] = self.state
-                self._notify_subscribers()
-
-                if not force:
-                    self._update_block = block_number
+                self._pool_state_archive[update.block_number] = self.state
+                self._notify_subscribers(
+                    message=UniswapV3PoolStateUpdated(self.state),
+                )
+                self._update_block = update.block_number
 
             return updated_state
 
+    def get_absolute_price(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV3PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the absolute price for the given token, expressed in units of the other.
+        """
+
+        return 1 / self.get_absolute_rate(token, override_state=override_state)
+
+    def get_absolute_rate(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV3PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the absolute rate of exchange for the given token, expressed in units of the other.
+        """
+
+        state = self.state if override_state is None else override_state
+
+        if token == self.token0:
+            return 1 / exchange_rate_from_sqrt_price_x96(state.sqrt_price_x96)
+        elif token == self.token1:
+            return exchange_rate_from_sqrt_price_x96(state.sqrt_price_x96)
+        else:  # pragma: no cover
+            raise ValueError(f"Unknown token {token}")
+
+    def get_nominal_price(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV3PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the nominal price for the given token, expressed in units of the other, corrected for
+        decimal place values.
+        """
+        return 1 / self.get_nominal_rate(token, override_state=override_state)
+
+    def get_nominal_rate(
+        self,
+        token: Erc20Token,
+        override_state: UniswapV3PoolState | None = None,
+    ) -> Fraction:
+        """
+        Get the nominal rate for the given token, expressed in units of the other, corrected for
+        decimal place values.
+        """
+
+        state = self.state if override_state is None else override_state
+
+        if token == self.token0:
+            return (
+                1
+                / exchange_rate_from_sqrt_price_x96(state.sqrt_price_x96)
+                * Fraction(10**self.token1.decimals, 10**self.token0.decimals)
+            )
+        elif token == self.token1:
+            return exchange_rate_from_sqrt_price_x96(state.sqrt_price_x96) * Fraction(
+                10**self.token0.decimals, 10**self.token1.decimals
+            )
+        else:  # pragma: no cover
+            raise ValueError(f"Unknown token {token}")
+
     def restore_state_before_block(
         self,
         block: int,
     ) -> None:
         """
         Restore the last pool state recorded prior to a target block.
 
-        Use this method to maintain consistent state data following a chain
-        re-organization.
+        Use this method to maintain consistent state data following a chain re-organization.
         """
 
         # Find the index for the most recent pool state PRIOR to the requested
         # block number.
         #
         # e.g. Calling restore_state_before_block(block=104) for a pool with
         # states at blocks 100, 101, 102, 103, 104. `bisect_left()` returns
@@ -1063,90 +1043,127 @@
                 del self._pool_state_archive[block]
 
             restored_block, restored_state = list(self._pool_state_archive.items())[-1]
 
             self.state = restored_state
             self._update_block = restored_block
 
-        self._notify_subscribers()
+        self._notify_subscribers(
+            message=UniswapV3PoolStateUpdated(self.state),
+        )
 
-    def simulate_swap(
+    def simulate_exact_input_swap(
         self,
-        token_in: Erc20Token | None = None,
-        token_in_quantity: int | None = None,
-        token_out: Erc20Token | None = None,
-        token_out_quantity: int | None = None,
-        sqrt_price_limit: int | None = None,
+        token_in: Erc20Token,
+        token_in_quantity: int,
+        sqrt_price_limit_x96: int | None = None,
         override_state: UniswapV3PoolState | None = None,
     ) -> UniswapV3PoolSimulationResult:
         """
-        [TBD]
+        Simulate an exact input swap.
         """
 
-        if token_in is not None and token_in not in self.tokens:
+        if token_in not in self.tokens:  # pragma: no cover
             raise ValueError("token_in is unknown!")
-        if token_out is not None and token_out not in self.tokens:
+        if token_in_quantity == 0:  # pragma: no cover
+            raise ValueError("Zero input swap requested.")
+
+        zero_for_one = token_in == self.token0
+
+        try:
+            (
+                amount0_delta,
+                amount1_delta,
+                end_sqrt_price_x96,
+                end_liquidity,
+                end_tick,
+            ) = self._calculate_swap(
+                zero_for_one=zero_for_one,
+                amount_specified=token_in_quantity,
+                sqrt_price_limit_x96=(
+                    sqrt_price_limit_x96
+                    if sqrt_price_limit_x96 is not None
+                    else (
+                        TickMath.MIN_SQRT_RATIO + 1 if zero_for_one else TickMath.MAX_SQRT_RATIO - 1
+                    )
+                ),
+                override_start_liquidity=override_state.liquidity if override_state else None,
+                override_start_sqrt_price_x96=override_state.sqrt_price_x96
+                if override_state
+                else None,
+                override_start_tick=override_state.tick if override_state else None,
+                override_tick_bitmap=override_state.tick_bitmap if override_state else None,
+                override_tick_data=override_state.tick_data if override_state else None,
+            )
+        except EVMRevertError as e:  # pragma: no cover
+            raise LiquidityPoolError(f"Simulated execution reverted: {e}") from e
+        else:
+            return UniswapV3PoolSimulationResult(
+                amount0_delta=amount0_delta,
+                amount1_delta=amount1_delta,
+                initial_state=self.state.copy(),
+                final_state=UniswapV3PoolState(
+                    pool=self.address,
+                    liquidity=end_liquidity,
+                    sqrt_price_x96=end_sqrt_price_x96,
+                    tick=end_tick,
+                ),
+            )
+
+    def simulate_exact_output_swap(
+        self,
+        token_out: Erc20Token,
+        token_out_quantity: int,
+        sqrt_price_limit_x96: int | None = None,
+        override_state: UniswapV3PoolState | None = None,
+    ) -> UniswapV3PoolSimulationResult:
+        """
+        Simulate an exact output swap.
+        """
+
+        if token_out not in self.tokens:  # pragma: no cover
             raise ValueError("token_out is unknown!")
 
-        if token_in is None and token_out is None:
-            raise ValueError("Neither token_in nor token_out were provided.")
-        elif token_in is not None and token_out is not None:
-            raise ValueError("Provide token_in or token_out, not both.")
-
-        if token_in is not None and token_in_quantity is None:
-            raise ValueError("token_in_quantity not provided.")
-        if token_out is not None and token_out_quantity is None:
-            raise ValueError("token_out_quantity not provided.")
-
-        if 0 in (token_in_quantity, token_out_quantity):
-            raise ValueError("Zero input/output swap requested.")
-
-        # determine whether the swap is token0 -> token1
-        if token_in is not None:
-            zeroForOne = True if token_in == self.token0 else False
-        elif token_out is not None:
-            zeroForOne = True if token_out == self.token1 else False
-
-        _sqrt_price_limit = (
-            sqrt_price_limit
-            if sqrt_price_limit is not None
-            else (TickMath.MIN_SQRT_RATIO + 1 if zeroForOne else TickMath.MAX_SQRT_RATIO - 1)
-        )
+        if token_out_quantity == 0:  # pragma: no cover
+            raise ValueError("Zero output swap requested.")
 
-        if token_in_quantity is not None:
-            _amount_specified = token_in_quantity
-        elif token_out_quantity is not None:
-            _amount_specified = -token_out_quantity
+        zero_for_one = token_out == self.token1
 
         try:
             (
                 amount0_delta,
                 amount1_delta,
                 end_sqrtprice,
                 end_liquidity,
                 end_tick,
-            ) = self._uniswap_v3_pool_swap(
-                zeroForOne=zeroForOne,
-                amount_specified=_amount_specified,
-                sqrt_price_limit_x96=_sqrt_price_limit,
+            ) = self._calculate_swap(
+                zero_for_one=zero_for_one,
+                amount_specified=-token_out_quantity,
+                sqrt_price_limit_x96=(
+                    sqrt_price_limit_x96
+                    if sqrt_price_limit_x96 is not None
+                    else (
+                        TickMath.MIN_SQRT_RATIO + 1 if zero_for_one else TickMath.MAX_SQRT_RATIO - 1
+                    )
+                ),
                 override_start_liquidity=override_state.liquidity if override_state else None,
                 override_start_sqrt_price_x96=override_state.sqrt_price_x96
                 if override_state
                 else None,
                 override_start_tick=override_state.tick if override_state else None,
                 override_tick_bitmap=override_state.tick_bitmap if override_state else None,
                 override_tick_data=override_state.tick_data if override_state else None,
             )
-        except EVMRevertError as e:
+        except EVMRevertError as e:  # pragma: no cover
             raise LiquidityPoolError(f"Simulated execution reverted: {e}") from e
         else:
             return UniswapV3PoolSimulationResult(
                 amount0_delta=amount0_delta,
                 amount1_delta=amount1_delta,
-                current_state=self.state.copy(),
-                future_state=UniswapV3PoolState(
-                    pool=self,
+                initial_state=self.state.copy(),
+                final_state=UniswapV3PoolState(
+                    pool=self.address,
                     liquidity=end_liquidity,
                     sqrt_price_x96=end_sqrtprice,
                     tick=end_tick,
                 ),
             )
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_snapshot.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_snapshot.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,7 +1,10 @@
+# TODO: support unwinding updates for re-org
+
+
 from io import TextIOWrapper
 from typing import Any, Dict, List, TextIO, Tuple
 
 import ujson
 from eth_typing import ChecksumAddress
 from eth_utils.address import to_checksum_address
 from web3 import Web3
@@ -13,63 +16,56 @@
 from .abi import UNISWAP_V3_POOL_ABI
 from .v3_dataclasses import (
     UniswapV3BitmapAtWord,
     UniswapV3LiquidityAtTick,
     UniswapV3LiquidityEvent,
     UniswapV3PoolExternalUpdate,
 )
-from .v3_liquidity_pool import V3LiquidityPool
 
 
 class UniswapV3LiquiditySnapshot:
     """
     Retrieve and maintain liquidity positions for Uniswap V3 pools.
     """
 
     def __init__(
         self,
         file: TextIO | str,
         chain_id: int | None = None,
     ):
-        _file: TextIOWrapper
+        file_handle: TextIOWrapper
         json_liquidity_snapshot: Dict[str, Any]
 
-        try:
-            if isinstance(file, TextIOWrapper):
-                _file = file
+        match file:
+            case TextIOWrapper():
+                file_handle = file
                 json_liquidity_snapshot = ujson.load(file)
-            elif isinstance(file, str):
-                with open(file) as _file:
-                    json_liquidity_snapshot = ujson.load(_file)
-            else:
-                raise ValueError(f"GOT {type(file)}")
-        except:
-            raise
-        finally:
-            _file.close()
+            case str():
+                with open(file) as file_handle:
+                    json_liquidity_snapshot = ujson.load(file_handle)
+            case _:  # pragma: no cover
+                raise ValueError(f"Unrecognized file type {type(file)}")
 
         self._chain_id = chain_id if chain_id is not None else config.get_web3().eth.chain_id
 
         self.newest_block = json_liquidity_snapshot.pop("snapshot_block")
 
-        self._liquidity_snapshot: Dict[ChecksumAddress, Dict[str, Any]] = dict()
-        for (
-            pool_address,
-            pool_liquidity_snapshot,
-        ) in json_liquidity_snapshot.items():
-            self._liquidity_snapshot[to_checksum_address(pool_address)] = {
+        self._liquidity_snapshot: Dict[ChecksumAddress, Dict[str, Any]] = {
+            to_checksum_address(pool_address): {
                 "tick_bitmap": {
                     int(k): UniswapV3BitmapAtWord(**v)
                     for k, v in pool_liquidity_snapshot["tick_bitmap"].items()
                 },
                 "tick_data": {
                     int(k): UniswapV3LiquidityAtTick(**v)
                     for k, v in pool_liquidity_snapshot["tick_data"].items()
                 },
             }
+            for pool_address, pool_liquidity_snapshot in json_liquidity_snapshot.items()
+        }
 
         logger.info(
             f"Loaded LP snapshot: {len(json_liquidity_snapshot)} pools @ block {self.newest_block}"
         )
 
         self._liquidity_events: Dict[ChecksumAddress, List[UniswapV3LiquidityEvent]] = dict()
 
@@ -129,108 +125,81 @@
                 )
 
                 event_logs = config.get_web3().eth.get_logs(event_filter_params)
 
                 for log in event_logs:
                     pool_address, liquidity_event = _process_log()
 
-                    # skip zero liquidity events
-                    if liquidity_event.liquidity == 0:
+                    if liquidity_event.liquidity == 0:  # pragma: no cover
                         continue
 
                     self._add_pool_if_missing(pool_address)
                     self._liquidity_events[pool_address].append(liquidity_event)
 
                 if end_block == to_block:
                     break
                 else:
                     start_block = end_block + 1
 
         logger.info(f"Updated snapshot to block {to_block}")
         self.newest_block = to_block
 
-    def get_pool_updates(self, pool_address: str) -> List[UniswapV3PoolExternalUpdate]:
+    def get_new_liquidity_updates(self, pool_address: str) -> List[UniswapV3PoolExternalUpdate]:
         pool_address = to_checksum_address(pool_address)
+        pool_updates = self._liquidity_events.get(pool_address, list())
+        self._liquidity_events[pool_address] = list()
 
-        try:
-            self._liquidity_events[pool_address]
-        except KeyError:
-            return []
-        else:
-            # Sort the liquidity events by block, then transaction index
-            # before returning them.
-            # @dev the V3LiquidityPool helper will reject liquidity events
-            # associated with a past block, so they must be processed in
-            # chronological order
-            sorted_events = sorted(
-                self._liquidity_events[pool_address],
-                key=lambda event: (event.block_number, event.tx_index),
-            )
-            self._liquidity_events[pool_address].clear()
+        # The V3LiquidityPool helper will reject liquidity events associated with a past block, so
+        # they must be applied in chronological order
+        sorted_events = sorted(
+            pool_updates,
+            key=lambda event: (event.block_number, event.tx_index),
+        )
 
-            return [
-                UniswapV3PoolExternalUpdate(
-                    block_number=event.block_number,
-                    liquidity_change=(
-                        event.liquidity,
-                        event.tick_lower,
-                        event.tick_upper,
-                    ),
-                )
-                for event in sorted_events
-            ]
+        return [
+            UniswapV3PoolExternalUpdate(
+                block_number=event.block_number,
+                liquidity_change=(
+                    event.liquidity,
+                    event.tick_lower,
+                    event.tick_upper,
+                ),
+            )
+            for event in sorted_events
+        ]
 
-    def get_tick_bitmap(
-        self, pool: V3LiquidityPool | ChecksumAddress
-    ) -> Dict[int, UniswapV3BitmapAtWord]:
-        if isinstance(pool, V3LiquidityPool):
-            pool_address = pool.address
-        elif isinstance(pool, str):
-            pool_address = to_checksum_address(pool)
-        else:
-            raise ValueError(f"Unexpected input for pool: {type(pool)}")
+    def get_tick_bitmap(self, pool: ChecksumAddress | str) -> Dict[int, UniswapV3BitmapAtWord]:
+        pool_address = to_checksum_address(pool)
 
         try:
             tick_bitmap: Dict[int, UniswapV3BitmapAtWord] = self._liquidity_snapshot[pool_address][
                 "tick_bitmap"
             ]
             return tick_bitmap
         except KeyError:
             return dict()
 
-    def get_tick_data(
-        self, pool: V3LiquidityPool | ChecksumAddress
-    ) -> Dict[int, UniswapV3LiquidityAtTick]:
-        if isinstance(pool, V3LiquidityPool):
-            pool_address = pool.address
-        elif isinstance(pool, str):
-            pool_address = to_checksum_address(pool)
-        else:
-            raise ValueError(f"Unexpected input for pool: {type(pool)}")
+    def get_tick_data(self, pool: ChecksumAddress | str) -> Dict[int, UniswapV3LiquidityAtTick]:
+        pool_address = to_checksum_address(pool)
 
         try:
             tick_data: Dict[int, UniswapV3LiquidityAtTick] = self._liquidity_snapshot[pool_address][
                 "tick_data"
             ]
             return tick_data
         except KeyError:
             return {}
 
     def update_snapshot(
         self,
-        pool: V3LiquidityPool | ChecksumAddress,
+        pool: ChecksumAddress | str,
         tick_data: Dict[int, UniswapV3LiquidityAtTick],
         tick_bitmap: Dict[int, UniswapV3BitmapAtWord],
     ) -> None:
-        if isinstance(pool, V3LiquidityPool):
-            pool_address = pool.address
-        elif isinstance(pool, str):
-            pool_address = to_checksum_address(pool)
-        else:
-            raise ValueError(f"Unexpected input for pool: {type(pool)}")
+        pool_address = to_checksum_address(pool)
 
         self._add_pool_if_missing(pool_address)
         self._liquidity_snapshot[pool_address].update(
             {
                 "tick_bitmap": tick_bitmap,
             }
         )
```

### Comparing `degenbot-0.2.2/src/degenbot/uniswap/v3_tick_lens.py` & `degenbot-0.2.3/src/degenbot/uniswap/v3_tick_lens.py`

 * *Files identical despite different names*

### Comparing `degenbot-0.2.2/src/degenbot.egg-info/PKG-INFO` & `degenbot-0.2.3/src/degenbot.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: degenbot
-Version: 0.2.2
+Version: 0.2.3
 Summary: Python classes to aid rapid development of Uniswap V2 & V3, and Curve V1 arbitrage bots on EVM-compatible blockchains
 Author-email: BowTiedDevil <devil@bowtieddevil.com>
 License: MIT
 Project-URL: Homepage, https://www.degencode.com
 Project-URL: Repository, https://github.com/BowTiedDevil/degenbot
 Project-URL: Tracker, https://github.com/BowTiedDevil/degenbot/issues
 Project-URL: Twitter, https://twitter.com/BowTiedDevil
```

### Comparing `degenbot-0.2.2/src/degenbot.egg-info/SOURCES.txt` & `degenbot-0.2.3/src/degenbot.egg-info/SOURCES.txt`

 * *Files 14% similar despite different names*

```diff
@@ -8,27 +8,21 @@
 src/degenbot/config.py
 src/degenbot/constants.py
 src/degenbot/erc20_token.py
 src/degenbot/exceptions.py
 src/degenbot/functions.py
 src/degenbot/logging.py
 src/degenbot/py.typed
-src/degenbot/subscription_mixins.py
 src/degenbot.egg-info/PKG-INFO
 src/degenbot.egg-info/SOURCES.txt
 src/degenbot.egg-info/dependency_links.txt
 src/degenbot.egg-info/requires.txt
 src/degenbot.egg-info/top_level.txt
 src/degenbot/arbitrage/__init__.py
 src/degenbot/arbitrage/arbitrage_dataclasses.py
-src/degenbot/arbitrage/flash_borrow_to_lp_swap.py
-src/degenbot/arbitrage/flash_borrow_to_lp_swap_new.py
-src/degenbot/arbitrage/flash_borrow_to_lp_swap_with_future.py
-src/degenbot/arbitrage/flash_borrow_to_router_swap.py
-src/degenbot/arbitrage/lp_swap_with_future.py
 src/degenbot/arbitrage/uniswap_curve_cycle.py
 src/degenbot/arbitrage/uniswap_lp_cycle.py
 src/degenbot/curve/__init__.py
 src/degenbot/curve/abi.py
 src/degenbot/curve/curve_stableswap_dataclasses.py
 src/degenbot/curve/curve_stableswap_liquidity_pool.py
 src/degenbot/dex/__init__.py
@@ -43,19 +37,17 @@
 src/degenbot/registry/all_tokens.py
 src/degenbot/transaction/__init__.py
 src/degenbot/transaction/simulation_ledger.py
 src/degenbot/transaction/uniswap_transaction.py
 src/degenbot/uniswap/__init__.py
 src/degenbot/uniswap/abi.py
 src/degenbot/uniswap/managers.py
-src/degenbot/uniswap/mixins.py
 src/degenbot/uniswap/v2_dataclasses.py
 src/degenbot/uniswap/v2_functions.py
 src/degenbot/uniswap/v2_liquidity_pool.py
-src/degenbot/uniswap/v2_multi_liquidity_pool.py
 src/degenbot/uniswap/v3_dataclasses.py
 src/degenbot/uniswap/v3_functions.py
 src/degenbot/uniswap/v3_liquidity_pool.py
 src/degenbot/uniswap/v3_snapshot.py
 src/degenbot/uniswap/v3_tick_lens.py
 src/degenbot/uniswap/v3_libraries/__init__.py
 src/degenbot/uniswap/v3_libraries/bit_math.py
@@ -66,13 +58,13 @@
 src/degenbot/uniswap/v3_libraries/sqrt_price_math.py
 src/degenbot/uniswap/v3_libraries/swap_math.py
 src/degenbot/uniswap/v3_libraries/tick.py
 src/degenbot/uniswap/v3_libraries/tick_bitmap.py
 src/degenbot/uniswap/v3_libraries/tick_math.py
 src/degenbot/uniswap/v3_libraries/unsafe_math.py
 src/degenbot/uniswap/v3_libraries/yul_operations.py
-tests/test_baseclasses.py
 tests/test_builder_endpoint.py
 tests/test_chainlink_price_feed.py
 tests/test_config.py
 tests/test_erc20_token.py
-tests/test_functions.py
+tests/test_functions.py
+tests/test_registry.py
```

### Comparing `degenbot-0.2.2/tests/test_builder_endpoint.py` & `degenbot-0.2.3/tests/test_builder_endpoint.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,11 +1,12 @@
-import degenbot.fork
+import aiohttp
 import eth_account
 import pytest
 from degenbot.builder_endpoint import BuilderEndpoint
+from degenbot.fork.anvil_fork import AnvilFork
 from eth_account.signers.local import LocalAccount
 
 BEAVERBUILD_URL = "https://rpc.beaverbuild.org"
 BUILDER0X69_URL = "https://builder0x69.io"
 FLASHBOTS_URL = "https://relay.flashbots.net"
 RSYNCBUILDER_URL = "https://rsync-builder.xyz"
 TITANBUILDER_URL = "https://rpc.titanbuilder.xyz"
@@ -15,14 +16,17 @@
     "beaverbuild",
     "builder0x69",
     "flashbots",
     "rsyncbuilder",
     "titanbuilder",
 ]
 
+TEST_BUNDLE_HASH: str
+TEST_BUNDLE_BLOCK: int
+
 # Taken from https://privatekeys.pw/keys/ethereum/random
 SIGNER_KEY = "52661f05c0512d64e2dc681900f45996e9946856ec352b7a2950203b150dbd28"
 
 
 @pytest.fixture()
 def beaverbuild() -> BuilderEndpoint:
     return BuilderEndpoint(
@@ -83,33 +87,52 @@
     BUILDER_FIXTURES,
 )
 def test_create_builders(builder_name: str, request: pytest.FixtureRequest):
     builder = request.getfixturevalue(builder_name)
     assert isinstance(builder, BuilderEndpoint)
 
 
+async def test_bad_url():
+    with pytest.raises(ValueError):
+        BuilderEndpoint(url="ws://www.google.com", endpoints=["eth_sendBundle"])
+
+
 async def test_blank_eth_send_bundle(
     beaverbuild: BuilderEndpoint,
-    fork_mainnet: degenbot.fork.AnvilFork,
+    fork_mainnet: AnvilFork,
 ):
     current_block = fork_mainnet.w3.eth.block_number
     response = await beaverbuild.send_eth_bundle(
         bundle=[],
         block_number=current_block + 1,
     )
     assert isinstance(response, dict)
     assert "bundleHash" in response
 
 
+async def test_blank_eth_send_bundle_with_session(
+    beaverbuild: BuilderEndpoint,
+    fork_mainnet: AnvilFork,
+):
+    async with aiohttp.ClientSession(raise_for_status=True) as session:
+        current_block = fork_mainnet.w3.eth.block_number
+        response = await beaverbuild.send_eth_bundle(
+            bundle=[], block_number=current_block + 1, http_session=session
+        )
+        assert isinstance(response, dict)
+        assert "bundleHash" in response
+
+
 async def test_eth_call_bundle(
     flashbots: BuilderEndpoint,
-    fork_mainnet: degenbot.fork.AnvilFork,
+    fork_mainnet: AnvilFork,
 ):
     current_block = fork_mainnet.w3.eth.block_number
     current_base_fee = fork_mainnet.w3.eth.get_block("latest")["baseFeePerGas"]
+    current_block_timestamp = fork_mainnet.w3.eth.get_block("latest")["timestamp"]
 
     signer: LocalAccount = eth_account.Account.from_key(SIGNER_KEY)
     SIGNER_ADDRESS = signer.address
 
     transaction_1 = {
         "chainId": 1,
         "data": b"",
@@ -143,18 +166,37 @@
         bundle=[signed_tx_1, signed_tx_2],
         block_number=current_block + 1,
         state_block=current_block,
         signer_key=SIGNER_KEY,
     )
     assert isinstance(response, dict)
 
+    # Test with "latest" state block alias
+    response = await flashbots.call_eth_bundle(
+        bundle=[signed_tx_1, signed_tx_2],
+        block_number=current_block + 1,
+        state_block="latest",
+        signer_key=SIGNER_KEY,
+    )
+    assert isinstance(response, dict)
+
+    # Test with timestamp
+    response = await flashbots.call_eth_bundle(
+        bundle=[signed_tx_1, signed_tx_2],
+        block_number=current_block + 1,
+        block_timestamp=current_block_timestamp + 12,
+        state_block=current_block,
+        signer_key=SIGNER_KEY,
+    )
+    assert isinstance(response, dict)
+
 
 async def test_eth_send_bundle(
     flashbots: BuilderEndpoint,
-    fork_mainnet: degenbot.fork.AnvilFork,
+    fork_mainnet: AnvilFork,
 ):
     current_block = fork_mainnet.w3.eth.block_number
     current_base_fee = fork_mainnet.w3.eth.get_block("latest")["baseFeePerGas"]
 
     signer: LocalAccount = eth_account.Account.from_key(SIGNER_KEY)
     SIGNER_ADDRESS = signer.address
 
@@ -189,24 +231,24 @@
 
     response = await flashbots.send_eth_bundle(
         bundle=[signed_tx_1, signed_tx_2],
         block_number=current_block + 1,
         signer_key=SIGNER_KEY,
     )
     assert isinstance(response, dict)
+
     global TEST_BUNDLE_HASH
     global TEST_BUNDLE_BLOCK
-
     TEST_BUNDLE_HASH = response["bundleHash"]
     TEST_BUNDLE_BLOCK = current_block + 1
 
 
 async def test_get_user_stats(
     flashbots: BuilderEndpoint,
-    fork_mainnet: degenbot.fork.AnvilFork,
+    fork_mainnet: AnvilFork,
 ):
     current_block = fork_mainnet.w3.eth.block_number
     await flashbots.get_user_stats(
         signer_key=SIGNER_KEY,
         block_number=current_block,
     )
```

### Comparing `degenbot-0.2.2/tests/test_config.py` & `degenbot-0.2.3/tests/test_config.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,19 +1,21 @@
 import degenbot
-from degenbot.exceptions import DegenbotError
-import web3
 import pytest
+import web3
+from degenbot.config import set_web3
+from degenbot.erc20_token import Erc20Token
+from degenbot.exceptions import DegenbotError
 
 
 def test_disconnected_web3():
     w3 = web3.Web3(web3.HTTPProvider("https://google.com"))
     with pytest.raises(DegenbotError, match="Web3 object is not connected."):
-        degenbot.set_web3(w3)
+        set_web3(w3)
 
 
 def test_unset_web3():
     WETH_ADDRESS = "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
 
     del degenbot.config._web3
 
     with pytest.raises(DegenbotError, match="A Web3 instance has not been provided."):
-        degenbot.Erc20Token(WETH_ADDRESS)
+        Erc20Token(WETH_ADDRESS)
```

### Comparing `degenbot-0.2.2/tests/test_functions.py` & `degenbot-0.2.3/tests/test_functions.py`

 * *Files 20% similar despite different names*

```diff
@@ -6,41 +6,61 @@
     BlockNumber,
     Hash32,
     HexStr,
 )
 from hexbytes import HexBytes
 
 
-def test_convert_identifier(fork_mainnet_archive):
+def test_converting_block_identifier_to_int(fork_mainnet_archive):
     """
-    Check that all inputs for type BlockIdentifier can be converted to an integer
+    Check that all inputs for web3 type `BlockIdentifier` can be converted to an integer
     """
 
     degenbot.config.set_web3(fork_mainnet_archive.w3)
-    for block_identifier in [
-        "latest",  # BlockParams
-        "earliest",  # BlockParams
-        "pending",  # BlockParams
-        "safe",  # BlockParams
-        "finalized",  # BlockParams
-        BlockNumber(1),  # BlockNumber
-        Hash32(int(1).to_bytes(length=32, byteorder="big")),  # Hash32
-        HexStr("0x" + int(128).to_bytes(32, byteorder="big").hex()),  # HexStr
-        HexBytes(1),  # HexBytes
-        1,  # int
-    ]:
-        assert isinstance(get_number_for_block_identifier(block_identifier), int)
+
+    # Known string literals
+    assert isinstance(get_number_for_block_identifier("latest"), int)
+    assert isinstance(get_number_for_block_identifier("earliest"), int)
+    assert isinstance(get_number_for_block_identifier("pending"), int)
+    assert isinstance(get_number_for_block_identifier("safe"), int)
+    assert isinstance(get_number_for_block_identifier("finalized"), int)
+
+    # BlockNumber
+    assert isinstance(
+        get_number_for_block_identifier(BlockNumber(1)),
+        int,
+    )
+
+    # Hash32
+    assert isinstance(
+        get_number_for_block_identifier(Hash32(int(1).to_bytes(length=32, byteorder="big"))),
+        int,
+    )
+
+    # HexStr
+    assert isinstance(
+        get_number_for_block_identifier(
+            HexStr("0x" + int(128).to_bytes(32, byteorder="big").hex())
+        ),
+        int,
+    )
+
+    # HexBytes
+    assert isinstance(get_number_for_block_identifier(HexBytes(1)), int)
+
+    # int
+    assert isinstance(get_number_for_block_identifier(1), int)
 
     for invalid_block_number in [-1, MAX_UINT256 + 1]:
         with pytest.raises(ValueError):
             get_number_for_block_identifier(invalid_block_number)
 
     for invalid_tag in ["Latest", "latest ", "next", "previous"]:
         with pytest.raises(ValueError):
-            get_number_for_block_identifier(invalid_tag)
+            get_number_for_block_identifier(invalid_tag)  # type: ignore[arg-type]
 
 
 def test_fee_calcs():
     BASE_FEE = 100 * 10**9
 
     # EIP-1559 target is 50% full blocks, so a 50% full block should return the same base fee
     assert (
```

