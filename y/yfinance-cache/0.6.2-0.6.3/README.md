# Comparing `tmp/yfinance_cache-0.6.2.tar.gz` & `tmp/yfinance_cache-0.6.3.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "yfinance_cache-0.6.2.tar", last modified: Thu Apr 25 17:59:14 2024, max compression
+gzip compressed data, was "yfinance_cache-0.6.3.tar", last modified: Sun May 26 16:08:19 2024, max compression
```

## Comparing `yfinance_cache-0.6.2.tar` & `yfinance_cache-0.6.3.tar`

### file list

```diff
@@ -1,54 +1,54 @@
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-04-25 17:59:14.054618 yfinance_cache-0.6.2/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1068 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/LICENSE
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5939 2024-04-25 17:59:14.054618 yfinance_cache-0.6.2/PKG-INFO
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5247 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/README.md
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      104 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/pyproject.toml
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      829 2024-04-25 17:59:14.054618 yfinance_cache-0.6.2/setup.cfg
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-04-25 17:59:14.053618 yfinance_cache-0.6.2/tests/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/__init__.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1675 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/context.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     8469 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_cache.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      991 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_datetime-assumptions.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74555 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_intervals_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    70793 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_intervals_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74237 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_intervals_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    71006 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_intervals_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24913 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_schedules_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24789 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_schedules_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    32509 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_schedules_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    23272 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_market_schedules_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12038 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_missing_intervals_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12079 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_missing_intervals_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13799 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_missing_intervals_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13077 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_missing_intervals_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    25165 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_price_data_aging_1d.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    16811 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_price_data_aging_1h.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    17013 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_price_data_aging_1w.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2447 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_time_utils.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1698 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_utils.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2955 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yf_assumptions.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    32294 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yfc_adjust.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12038 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yfc_backend.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12467 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yfc_financials.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    40121 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yfc_interface.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     4270 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/test_yfc_ticker.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5085 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/tests/utils.py
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-04-25 17:59:14.047618 yfinance_cache-0.6.2/yfinance_cache/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      354 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/__init__.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    16324 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_cache_manager.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    52610 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_dat.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    89428 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_financials_manager.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2197 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_logging.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     6792 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_multi.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1453 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_options.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)   204038 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_prices_manager.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    39338 2024-04-25 17:58:13.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_ticker.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    81302 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_time.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      653 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_upgrade.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    25372 2024-04-25 17:55:15.000000 yfinance_cache-0.6.2/yfinance_cache/yfc_utils.py
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-04-25 17:59:14.054618 yfinance_cache-0.6.2/yfinance_cache.egg-info/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5939 2024-04-25 17:59:14.000000 yfinance_cache-0.6.2/yfinance_cache.egg-info/PKG-INFO
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2316 2024-04-25 17:59:14.000000 yfinance_cache-0.6.2/yfinance_cache.egg-info/SOURCES.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)        1 2024-04-25 17:59:14.000000 yfinance_cache-0.6.2/yfinance_cache.egg-info/dependency_links.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       79 2024-04-25 17:59:14.000000 yfinance_cache-0.6.2/yfinance_cache.egg-info/requires.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2024-04-25 17:59:14.000000 yfinance_cache-0.6.2/yfinance_cache.egg-info/top_level.txt
+drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-05-26 16:08:19.365854 yfinance_cache-0.6.3/
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1068 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/LICENSE
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     6496 2024-05-26 16:08:19.365854 yfinance_cache-0.6.3/PKG-INFO
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5804 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/README.md
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)      104 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/pyproject.toml
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)      829 2024-05-26 16:08:19.366854 yfinance_cache-0.6.3/setup.cfg
+drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-05-26 16:08:19.365854 yfinance_cache-0.6.3/tests/
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/__init__.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1675 2024-05-04 12:46:08.000000 yfinance_cache-0.6.3/tests/context.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     8505 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_cache.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)      991 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_datetime-assumptions.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74555 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_intervals_asx.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    70793 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_intervals_nze.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74237 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_intervals_tlv.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    71006 2024-05-04 11:58:33.000000 yfinance_cache-0.6.3/tests/test_market_intervals_usa.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24913 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_schedules_asx.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24789 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_schedules_nze.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    32509 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_schedules_tlv.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    23272 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_market_schedules_usa.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12038 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_missing_intervals_asx.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12079 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_missing_intervals_nze.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13799 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_missing_intervals_tlv.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13077 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_missing_intervals_usa.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    25165 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_price_data_aging_1d.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    16811 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_price_data_aging_1h.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    17063 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_price_data_aging_1w.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2447 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_time_utils.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1698 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_utils.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2955 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_yf_assumptions.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    32171 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_yfc_adjust.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12042 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_yfc_backend.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12471 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_yfc_financials.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    40606 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/tests/test_yfc_interface.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     4270 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/tests/test_yfc_ticker.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     5085 2024-04-13 10:53:27.000000 yfinance_cache-0.6.3/tests/utils.py
+drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-05-26 16:08:19.358854 yfinance_cache-0.6.3/yfinance_cache/
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)      395 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/__init__.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    16334 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_cache_manager.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    52826 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_dat.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    90247 2024-05-26 15:27:14.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_financials_manager.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2197 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_logging.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     6792 2024-02-10 20:27:47.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_multi.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1453 2024-02-10 13:35:58.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_options.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)   201869 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_prices_manager.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    39431 2024-05-26 15:27:14.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_ticker.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    82619 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_time.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1290 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_upgrade.py
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)    26255 2024-05-26 15:27:13.000000 yfinance_cache-0.6.3/yfinance_cache/yfc_utils.py
+drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2024-05-26 16:08:19.365854 yfinance_cache-0.6.3/yfinance_cache.egg-info/
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     6496 2024-05-26 16:08:19.000000 yfinance_cache-0.6.3/yfinance_cache.egg-info/PKG-INFO
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2316 2024-05-26 16:08:19.000000 yfinance_cache-0.6.3/yfinance_cache.egg-info/SOURCES.txt
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)        1 2024-05-26 16:08:19.000000 yfinance_cache-0.6.3/yfinance_cache.egg-info/dependency_links.txt
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)       79 2024-05-26 16:08:19.000000 yfinance_cache-0.6.3/yfinance_cache.egg-info/requires.txt
+-rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2024-05-26 16:08:19.000000 yfinance_cache-0.6.3/yfinance_cache.egg-info/top_level.txt
```

### Comparing `yfinance_cache-0.6.2/LICENSE` & `yfinance_cache-0.6.3/LICENSE`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/PKG-INFO` & `yfinance_cache-0.6.3/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: yfinance-cache
-Version: 0.6.2
+Version: 0.6.3
 Summary: Smart caching wrapper for 'yfinance' module
 Home-page: https://github.com/ValueRaider/yfinance-cache
 Author: ValueRaider
 Author-email: ValueRaider@protonmail.com
 Project-URL: Bug Tracker, https://github.com/ValueRaider/yfinance-cache/issues
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
@@ -32,14 +32,18 @@
 Everything else cached once but never updated (unless you delete their files).
 
 Persistent cache stored in your user cache folder:
 - Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
 - Linux = /home/\<USER\>/.cache/py-yfinance-cache
 - MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
 
+## Install
+
+Available via PIP: `pip install yfinance_cache`
+
 ## Interface
 
 Interaction almost identical to yfinance, listed is attributes with auto-update:
 
 ```python
 import yfinance_cache as yfc
 
@@ -124,51 +128,59 @@
 Instead, YFC analyses earnings dates to determine exactly when next earnings will be, 
 or if Yahoo data is incomplete then YFC will predict.
 You can inspect this schedule in new function `dat.get_release_dates()`.
 
 ## Verifying cache
 
 Cached prices can be compared against latest Yahoo Finance data, and correct differences:
+
 ```python
 # Verify prices of one ticker symbol
 msft.verify_cached_prices(
 	rtol=0.0001,  # relative tolerance for differences
 	vol_rtol=0.005,  # relative tolerance specifically for Volume
-	correct=False,  # delete incorrect cached data?
+	correct=[False|'one'|'all'],  # delete incorrect cached data? 'one' = stop after correcting first incorrect prices table ; 'all' = correct all tickers & intervals
 	discard_old=False,  # if cached data too old to check (e.g. 30m), assume incorrect and delete?
 	quiet=True,  # enable to print nothing, disable to print summary detail of why cached data wrong
 	debug=False,  # enable even more detail for debugging 
 	debug_interval=None)  # only verify this interval (note: 1d always verified)
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
-	session=None,  # recommend you provide a requests_cache here
+	session=None,  # recommend you provide a requests_cache here if debugging
 	rtol=0.0001,
 	vol_rtol=0.005,
-	correct=False,
+	correct=[False|'one'|'all'],
 	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
-With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
+These return `False` if difference detected else `True`, regardless of if difference was corrected.
+
+- to scan for first data mismatch but not correct: `yfc.verify_cached_tickers_prices()`. 
 
-If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
+- to fix all data issues: `yfc.verify_cached_tickers_prices(correct='all', halt_on_fail=False)`
+
+I hope latest version 0.6.2 fixed the last bugs in applying new dividend-adjustments and splits to cached prices (`Adj Close` etc).
+Only genuine differences in not-adjusted prices are Volume differences (~0.5%) - 
+Yahoo sometimes changes Volume over 24 hours after that day ended e.g. updating Monday Volume on Wednesday, 
+sometimes weeks later!
+
+If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong.
+Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience.
+Cross-check against TradingView or stock exchange website.
 
 ## Performance
 
 For each ticker, YFC basically performs 2 tasks:
 
 1 - check if fetch needed
 
 2 - fetch data and integrate into cache
 
 Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
 
-## Installation
-
-Available on PIP: `pip install yfinance_cache`
-
 ## Limitations
 
 - intraday pre/post price data not available
```

### Comparing `yfinance_cache-0.6.2/README.md` & `yfinance_cache-0.6.3/README.md`

 * *Files 9% similar despite different names*

```diff
@@ -12,14 +12,18 @@
 Everything else cached once but never updated (unless you delete their files).
 
 Persistent cache stored in your user cache folder:
 - Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
 - Linux = /home/\<USER\>/.cache/py-yfinance-cache
 - MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
 
+## Install
+
+Available via PIP: `pip install yfinance_cache`
+
 ## Interface
 
 Interaction almost identical to yfinance, listed is attributes with auto-update:
 
 ```python
 import yfinance_cache as yfc
 
@@ -104,51 +108,59 @@
 Instead, YFC analyses earnings dates to determine exactly when next earnings will be, 
 or if Yahoo data is incomplete then YFC will predict.
 You can inspect this schedule in new function `dat.get_release_dates()`.
 
 ## Verifying cache
 
 Cached prices can be compared against latest Yahoo Finance data, and correct differences:
+
 ```python
 # Verify prices of one ticker symbol
 msft.verify_cached_prices(
 	rtol=0.0001,  # relative tolerance for differences
 	vol_rtol=0.005,  # relative tolerance specifically for Volume
-	correct=False,  # delete incorrect cached data?
+	correct=[False|'one'|'all'],  # delete incorrect cached data? 'one' = stop after correcting first incorrect prices table ; 'all' = correct all tickers & intervals
 	discard_old=False,  # if cached data too old to check (e.g. 30m), assume incorrect and delete?
 	quiet=True,  # enable to print nothing, disable to print summary detail of why cached data wrong
 	debug=False,  # enable even more detail for debugging 
 	debug_interval=None)  # only verify this interval (note: 1d always verified)
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
-	session=None,  # recommend you provide a requests_cache here
+	session=None,  # recommend you provide a requests_cache here if debugging
 	rtol=0.0001,
 	vol_rtol=0.005,
-	correct=False,
+	correct=[False|'one'|'all'],
 	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
-With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
+These return `False` if difference detected else `True`, regardless of if difference was corrected.
+
+- to scan for first data mismatch but not correct: `yfc.verify_cached_tickers_prices()`. 
 
-If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
+- to fix all data issues: `yfc.verify_cached_tickers_prices(correct='all', halt_on_fail=False)`
+
+I hope latest version 0.6.2 fixed the last bugs in applying new dividend-adjustments and splits to cached prices (`Adj Close` etc).
+Only genuine differences in not-adjusted prices are Volume differences (~0.5%) - 
+Yahoo sometimes changes Volume over 24 hours after that day ended e.g. updating Monday Volume on Wednesday, 
+sometimes weeks later!
+
+If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong.
+Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience.
+Cross-check against TradingView or stock exchange website.
 
 ## Performance
 
 For each ticker, YFC basically performs 2 tasks:
 
 1 - check if fetch needed
 
 2 - fetch data and integrate into cache
 
 Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
 
-## Installation
-
-Available on PIP: `pip install yfinance_cache`
-
 ## Limitations
 
 - intraday pre/post price data not available
```

### Comparing `yfinance_cache-0.6.2/setup.cfg` & `yfinance_cache-0.6.3/setup.cfg`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = yfinance-cache
-version = 0.6.2
+version = 0.6.3
 author = ValueRaider
 author_email = ValueRaider@protonmail.com
 description = Smart caching wrapper for 'yfinance' module
 long_description = file: README.md
 long_description_content_type = text/markdown
 url = https://github.com/ValueRaider/yfinance-cache
 project_urls =
```

### Comparing `yfinance_cache-0.6.2/tests/context.py` & `yfinance_cache-0.6.3/tests/context.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_cache.py` & `yfinance_cache-0.6.3/tests/test_cache.py`

 * *Files 2% similar despite different names*

```diff
@@ -6,14 +6,15 @@
 
 import os, shutil, tempfile
 import json, pickle
 
 from time import sleep
 from datetime import datetime, date, time, timedelta
 from zoneinfo import ZoneInfo
+import pandas as pd
 
 from pprint import pprint
 
 class Test_Yfc_Cache(unittest.TestCase):
 
     def setUp(self):
         self.ticker = "INTC"
@@ -62,15 +63,15 @@
         self.assertEqual(obj, value)
 
 
 
     def test_cache_store_expiry(self):
         value = 123
 
-        dt = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         exp = dt + timedelta(seconds=1)
 
         yfcm.StoreCacheDatum(self.ticker, self.objName, value, expiry=exp)
 
         # Confirm write
         fp = os.path.join(yfcm.GetCacheDirpath(), self.ticker, self.objName+".json")
         self.assertTrue(os.path.isfile(fp))
@@ -114,15 +115,15 @@
 
 
     def test_cache_store_packed_expiry(self):
         var = "balance_sheet"
         var_grp = "annuals"
         value = 123
 
-        dt = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         exp = dt + timedelta(seconds=1)
 
         yfcm.StoreCachePackedDatum(self.ticker, var, value, expiry=exp)
 
         # Confirm write
         fp = os.path.join(yfcm.GetCacheDirpath(), self.ticker, var_grp+".pkl")
         self.assertTrue(os.path.isfile(fp))
@@ -143,15 +144,15 @@
 
 
     def test_cache_store_types(self):
         json_values = []
         json_values.append(int(1))
         json_values.append(float(1))
         json_values.append([1, 3])
-        json_values.append(datetime.utcnow().replace(tzinfo=ZoneInfo("UTC")))
+        json_values.append(pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC")))
         json_values.append(timedelta(seconds=2.01))
 
         pkl_values = []
         pkl_values.append(set([1, 3]))
         pkl_values.append({'a':1, 'b':2})
 
         for value in json_values+pkl_values:
@@ -190,15 +191,15 @@
         self.assertEqual(md, mdc)
 
 
     def test_cache_metadata_write_expiry(self):
         key = "k1"
         value = 123
         md = {key:value}
-        exp = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC")) + timedelta(hours=1)
+        exp = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC")) + timedelta(hours=1)
 
         yfcm.StoreCacheDatum(self.ticker, self.objName, value, expiry=exp, metadata=md)
         obj,mdc = yfcm.ReadCacheDatum(self.ticker, self.objName, return_metadata_too=True)
         md["__expiry__"] = exp
         self.assertEqual(obj, value)
         self.assertEqual(md, mdc)
```

### Comparing `yfinance_cache-0.6.2/tests/test_datetime-assumptions.py` & `yfinance_cache-0.6.3/tests/test_datetime-assumptions.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_intervals_asx.py` & `yfinance_cache-0.6.3/tests/test_market_intervals_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_intervals_nze.py` & `yfinance_cache-0.6.3/tests/test_market_intervals_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_intervals_tlv.py` & `yfinance_cache-0.6.3/tests/test_market_intervals_tlv.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_intervals_usa.py` & `yfinance_cache-0.6.3/tests/test_market_intervals_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_schedules_asx.py` & `yfinance_cache-0.6.3/tests/test_market_schedules_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_schedules_nze.py` & `yfinance_cache-0.6.3/tests/test_market_schedules_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_schedules_tlv.py` & `yfinance_cache-0.6.3/tests/test_market_schedules_tlv.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_market_schedules_usa.py` & `yfinance_cache-0.6.3/tests/test_market_schedules_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_missing_intervals_asx.py` & `yfinance_cache-0.6.3/tests/test_missing_intervals_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_missing_intervals_nze.py` & `yfinance_cache-0.6.3/tests/test_missing_intervals_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_missing_intervals_tlv.py` & `yfinance_cache-0.6.3/tests/test_missing_intervals_tlv.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_missing_intervals_usa.py` & `yfinance_cache-0.6.3/tests/test_missing_intervals_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_price_data_aging_1d.py` & `yfinance_cache-0.6.3/tests/test_price_data_aging_1d.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_price_data_aging_1h.py` & `yfinance_cache-0.6.3/tests/test_price_data_aging_1h.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_price_data_aging_1w.py` & `yfinance_cache-0.6.3/tests/test_price_data_aging_1w.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,23 +47,23 @@
     def test_CalcIntervalLastDataDt_USA_weekly(self):
         interval = yfcd.Interval.Week
 
         lag = timedelta(minutes=15)
         dts = []
         answers = []
         week_start_day = date(2022, 2, 7)
-        answer = datetime.combine(week_start_day + 7*self.td1d, self.market_open, self.market_tz) + self.td4h
+        answer = datetime.combine(week_start_day + 7*self.td1d, self.market_open, self.market_tz) + self.td4h+self.td1d
         for d in range(7, 12):
             day = date(2022, 2,d)
             dt = datetime.combine(day, time(14, 30), self.market_tz)
             dts.append(dt)
             answers.append(answer+lag)
 
         week_start_day = date(2022, 2, 14)
-        answer = datetime.combine(week_start_day + 7*self.td1d, self.market_open, self.market_tz) + self.td4h + self.td1d  # Monday holiday
+        answer = datetime.combine(week_start_day + 7*self.td1d, self.market_open, self.market_tz) + self.td4h+self.td1d + self.td1d  # Monday holiday
         for d in range(14, 19):
             day = date(2022, 2,d)
             dt = datetime.combine(day, time(14, 30), self.market_tz)
             dts.append(dt)
             answers.append(answer + lag)
         for i in range(len(dts)):
             response = yfct.CalcIntervalLastDataDt(self.exchange, dts[i], interval, yf_lag=lag)
@@ -121,27 +121,27 @@
         tz = self.nze_market_tz
         yfct.SetExchangeTzName(exchange, self.nze_market_tz_name)
 
         lag = timedelta(minutes=15)
         dts = []
         answers = []
         week_start_day = date(2022, 4, 4)
-        answer = datetime.combine(date(2022, 4, 11), self.nze_market_open_time, tz) + self.td4h
+        answer = datetime.combine(date(2022, 4, 11), self.nze_market_open_time, tz) + self.td4h+self.td1d
         for d in range(4, 9):
             day = date(2022, 4, d)
 
             dts.append(datetime.combine(day, time(0), tz))
             answers.append(answer+lag)
             dts.append(datetime.combine(day, time(12), tz))
             answers.append(answer+lag)
             dts.append(datetime.combine(day, time(20), tz))
             answers.append(answer+lag)
 
         week_start_day = date(2022, 4, 11)
-        answer = datetime.combine(date(2022, 4, 19), time(10), tz) + self.td4h
+        answer = datetime.combine(date(2022, 4, 19), time(10), tz) + self.td4h+self.td1d
         for d in range(11, 16):
             day = date(2022, 4, d)
             
             dts.append(datetime.combine(day, time(0), tz))
             answers.append(answer+lag)
             dts.append(datetime.combine(day, time(12), tz))
             answers.append(answer+lag)
@@ -175,15 +175,15 @@
         exchange = self.uk_exchange
         tz = self.uk_market_tz
         yfct.SetExchangeTzName(exchange, self.uk_market_tz_name)
 
         lag = timedelta(0)
         dts = []
         answers = []
-        answer = datetime.combine(date(2022, 5, 9), time(8), tz) + self.td4h
+        answer = datetime.combine(date(2022, 5, 9), time(8), tz) + self.td4h+self.td1d
         for d in range(3, 7):  # 2nd is holiday
             day = date(2022, 5, d)
             dt = datetime.combine(day, time(14, 30), tz)
             dts.append(dt)
             answers.append(answer+lag)
 
         response_batch = yfct.CalcIntervalLastDataDt_batch(exchange, dts, interval, yf_lag=lag)
```

### Comparing `yfinance_cache-0.6.2/tests/test_time_utils.py` & `yfinance_cache-0.6.3/tests/test_time_utils.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_utils.py` & `yfinance_cache-0.6.3/tests/test_utils.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_yf_assumptions.py` & `yfinance_cache-0.6.3/tests/test_yf_assumptions.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/test_yfc_adjust.py` & `yfinance_cache-0.6.3/tests/test_yfc_adjust.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,15 +47,15 @@
         if not isinstance(answer.index, pd.DatetimeIndex):
             answer.index = pd.to_datetime(answer.index, utc=True)
             answer.index = answer.index.tz_convert(tz)
         else:
             answer.index = answer.index.tz_localize(tz)
 
         df = dat.history(start="2022-01-04", end="2022-08-20", adjust_splits=False, adjust_divs=False)
-        self.verify_df(df, answer, 1e-10)
+        self.verify_df(df, answer, 5e-5)
 
 
     def test_adjust_simple(self):
         # Fetch with empty cache, adjustment should match YF
 
         tkr = "PNL.L"
 
@@ -99,15 +99,15 @@
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
         df = dat.history(start="2022-01-01", end="2022-08-20", adjust_divs=False, adjust_splits=False)
         self.verify_df(df, answer_noadjust, 1e-10)
 
         df = dat.history(start="2022-01-01",end="2022-08-20",adjust_divs=False)
         answer_splitAdjusted = yf.Ticker(tkr, self.session).history(start="2022-01-01",end="2022-08-20",auto_adjust=False)
-        self.verify_df(df, answer_splitAdjusted, 1e-7)
+        self.verify_df(df, answer_splitAdjusted, 5e-5)
 
         df = dat.history(start="2022-01-01",end="2022-08-20")
         answer_adjusted = yf.Ticker(tkr, self.session).history(start="2022-01-01",end="2022-08-20")
         self.verify_df(df, answer_adjusted, 9e-6)
 
     def test_adjust_append2(self):
         # Have Jan->May cached. Fetch Jun->August (dividends & stock split), should append and back-adjust correctly
@@ -133,15 +133,15 @@
 
         answer_noadjust = pd.read_csv("./tests/Adjustment/pnl-unadjusted.csv",parse_dates=["Date"],index_col="Date")
         if not isinstance(answer_noadjust.index, pd.DatetimeIndex):
             answer_noadjust.index = pd.to_datetime(answer_noadjust.index, utc=True)
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
         df = dat.history(start="2022-01-01", end="2022-08-20", adjust_divs=False, adjust_splits=False)
-        self.verify_df(df, answer_noadjust, 1e-10)
+        self.verify_df(df, answer_noadjust, 5e-5)
 
         df = dat.history(start="2022-01-01",end="2022-08-20",adjust_divs=False)
         answer_splitAdjusted = yf.Ticker(tkr, self.session).history(start="2022-01-01",end="2022-08-20",auto_adjust=False)
         self.verify_df(df, answer_splitAdjusted, 5e-6)
 
         df = dat.history(start="2022-01-01",end="2022-08-20")
         answer_adjusted = yf.Ticker(tkr, self.session).history(start="2022-01-01",end="2022-08-20")
@@ -158,15 +158,15 @@
         df = dat.history(start="2022-01-01", end="2022-08-20", adjust_divs=False, adjust_splits=False)
 
         answer_noadjust = pd.read_csv("./tests/Adjustment/pnl-unadjusted.csv",parse_dates=["Date"],index_col="Date")
         if not isinstance(answer_noadjust.index, pd.DatetimeIndex):
             answer_noadjust.index = pd.to_datetime(answer_noadjust.index, utc=True)
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
-        self.verify_df(df, answer_noadjust, 1e-10)
+        self.verify_df(df, answer_noadjust, 5e-5)
 
     def test_adjust_prepend2(self):
         # Fetch 2nd Aug (after split day) -> now, then Jan -> now
         
         tkr = "PNL.L"
         dat = yfc.Ticker(tkr, self.session)
         tz = dat.fast_info["timezone"]
@@ -174,15 +174,15 @@
         df = dat.history(start="2022-01-01", end="2022-08-20", adjust_divs=False, adjust_splits=False)
 
         answer_noadjust = pd.read_csv("./tests/Adjustment/pnl-unadjusted.csv",parse_dates=["Date"],index_col="Date")
         if not isinstance(answer_noadjust.index, pd.DatetimeIndex):
             answer_noadjust.index = pd.to_datetime(answer_noadjust.index, utc=True)
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
-        self.verify_df(df, answer_noadjust, 1e-10)
+        self.verify_df(df, answer_noadjust, 5e-5)
 
     def test_adjust_prepend3(self):
         # Fetch 28th July (before split day) -> now, then Jan -> now
         
         tkr = "PNL.L"
         dat = yfc.Ticker(tkr, self.session)
         tz = dat.fast_info["timezone"]
@@ -190,15 +190,15 @@
         df = dat.history(start="2022-01-01", end="2022-08-20", adjust_divs=False, adjust_splits=False)
 
         answer_noadjust = pd.read_csv("./tests/Adjustment/pnl-unadjusted.csv",parse_dates=["Date"],index_col="Date")
         if not isinstance(answer_noadjust.index, pd.DatetimeIndex):
             answer_noadjust.index = pd.to_datetime(answer_noadjust.index, utc=True)
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
-        self.verify_df(df, answer_noadjust, 1e-10)
+        self.verify_df(df, answer_noadjust, 5e-5)
 
 
     def test_weekly_simple(self):
         start_d = date(2022,1,3)
         end_d = date(2022,8,22)
 
         for tkr in self.tkrs:
@@ -337,28 +337,28 @@
             else:
                 answer = dat_yf.history(start=start1_d, end=end3_d, interval="1wk", repair=True)
 
             self.verify_df(df, answer, 5e-6)
 
 
     def test_hourly_simple(self):
-        end_d = datetime.utcnow().date()
+        end_d = pd.Timestamp.utcnow().date()
         if not end_d.weekday() == 5:
             end_d -= timedelta(days=end_d.weekday()+2)
         start_d = end_d - timedelta(days=5) - timedelta(days=8*7)
         td_1d = timedelta(days=1)
         td_5d = timedelta(days=5)
 
         for tkr in self.tkrs:
             dat = yfc.Ticker(tkr, session=self.session)
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregate YFC by day)
             df_yfc = dat.history(start=start_d, end=end_d, interval="1h")
-            df_yf = dat_yf.history(start=start_d, end=end_d, interval="1d")
+            df_yf = dat_yf.history(start=start_d, end=end_d, interval="1d", repair=True)
             df_yfc_daily = df_yfc.copy()
             df_yfc_daily["_day"] = pd.to_datetime(df_yfc_daily.index.date).tz_localize(df_yfc.index.tz)
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==0,"Stock Splits"]=1
             df_yfc_daily = df_yfc_daily.groupby("_day").agg(
                 Open=("Open", "first"),
                 Close=("Close", "last"),
                 Low=("Low", "min"),
@@ -367,19 +367,15 @@
                 Dividends=("Dividends", "sum"),
                 StockSplits=("Stock Splits", "prod"))
             df_yfc_daily = df_yfc_daily.rename(columns={"StockSplits":"Stock Splits"})
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==1,"Stock Splits"]=0
             # Loose tolerance because just checking that in same ballpark
             # - ignore volume here, and missing hour intervals
             df_yf2 = df_yf[df_yf.index.isin(df_yfc_daily.index)]
-            if tkr == "I3E.L" and start_d <= date(2022,11,29):
-                # Skip test, because there is genuine difference between 1d and 1h on 2022-11-29
-                pass
-            else:
-                self.verify_df(df_yfc_daily.drop("Volume",axis=1), df_yf2.drop("Volume",axis=1), 1e-1)
+            self.verify_df(df_yfc_daily.drop("Volume",axis=1), df_yf2.drop("Volume",axis=1), 1e-1)
 
             # Now compare against YF hourly
             # Note: Yahoo doesn't dividend-adjust hourly
             df_yfc = dat.history(start=start_d, end=end_d, interval="1h", adjust_divs=False)
             df_yf = dat_yf.history(start=start_d-td_5d, end=end_d+td_5d, interval='1h', repair=True).loc[str(start_d):str(end_d-td_1d)]
             # Discard 0-volume data at market close
             sched = yfct.GetExchangeSchedule(dat.fast_info["exchange"], df_yf.index.date.min(), df_yf.index.date.max()+td_1d)
@@ -395,15 +391,15 @@
             ss_rcp = 1.0/ss
             csf = ss_rcp.sort_index(ascending=False).cumprod().sort_index(ascending=True).shift(-1, fill_value=1.0)
             df_yf["Volume"] /= csf
             df_yf = df_yf[df_yf.index.date<end_d]
             self.verify_df(df_yfc, df_yf, 1e-7)
 
     def test_hourly_append(self):
-        end2_d = datetime.utcnow().date()
+        end2_d = pd.Timestamp.utcnow().date()
         if not end2_d.weekday() == 5:
             end2_d -= timedelta(days=end2_d.weekday()+2)
         start2_d = end2_d - timedelta(days=5) - timedelta(days=4*7)
         end1_d = start2_d - timedelta(days=2)
         start1_d = end1_d - timedelta(days=5) - timedelta(days=4*7)
         td_5d = timedelta(days=5)
 
@@ -413,15 +409,15 @@
             # print(f"start2_d={start2_d} end2_d={end2_d}")
             dat.history(start=start2_d, end=end2_d, interval="1h")
 
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregate YFC by day)
             df_yfc = dat.history(start=start1_d, end=end2_d, interval="1h")
-            df_yf = dat_yf.history(start=start1_d, end=end2_d, interval="1d")
+            df_yf = dat_yf.history(start=start1_d, end=end2_d, interval="1d", repair=True)
             df_yfc_daily = df_yfc.copy()
             df_yfc_daily["_day"] = pd.to_datetime(df_yfc_daily.index.date).tz_localize(df_yfc.index.tz)
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==0,"Stock Splits"]=1
             df_yfc_daily = df_yfc_daily.groupby("_day").agg(
                 Open=("Open", "first"),
                 Close=("Close", "last"),
                 Low=("Low", "min"),
@@ -457,15 +453,15 @@
             ss_rcp = 1.0/ss
             csf = ss_rcp.sort_index(ascending=False).cumprod().sort_index(ascending=True).shift(-1, fill_value=1.0)
             df_yf["Volume"] /= csf
             df_yf = df_yf[df_yf.index.date<end2_d]
             self.verify_df(df_yfc, df_yf, 1e-7)
 
     def test_hourly_prepend(self):
-        end2_d = datetime.utcnow().date()
+        end2_d = pd.Timestamp.utcnow().date()
         if not end2_d.weekday() == 5:
             end2_d -= timedelta(days=end2_d.weekday()+2)
         start2_d = end2_d - timedelta(days=5) - timedelta(days=4*7)
         end1_d = start2_d - timedelta(days=2)
         start1_d = end1_d - timedelta(days=5) - timedelta(days=4*7)
         td_5d = timedelta(days=5)
 
@@ -474,15 +470,15 @@
             dat.history(start=start2_d, end=end2_d, interval="1h")
             dat.history(start=start1_d, end=end1_d, interval="1h")
 
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregate YFC by day)
             df_yfc = dat.history(start=start1_d, end=end2_d, interval="1h")
-            df_yf = dat_yf.history(start=start1_d, end=end2_d, interval="1d")
+            df_yf = dat_yf.history(start=start1_d, end=end2_d, interval="1d", repair=True)
             df_yfc_daily = df_yfc.copy()
             df_yfc_daily["_day"] = pd.to_datetime(df_yfc_daily.index.date).tz_localize(df_yfc.index.tz)
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==0,"Stock Splits"]=1
             df_yfc_daily = df_yfc_daily.groupby("_day").agg(
                 Open=("Open", "first"),
                 Close=("Close", "last"),
                 Low=("Low", "min"),
@@ -519,15 +515,15 @@
             ss_rcp = 1.0/ss
             csf = ss_rcp.sort_index(ascending=False).cumprod().sort_index(ascending=True).shift(-1, fill_value=1.0)
             df_yf["Volume"] /= csf
             df_yf = df_yf[df_yf.index.date<end2_d]
             self.verify_df(df_yfc, df_yf, 1e-7)
 
     def test_hourly_insert1(self):
-        end3_d = datetime.utcnow().date()
+        end3_d = pd.Timestamp.utcnow().date()
         if not end3_d.weekday() == 5:
             end3_d -= timedelta(days=end3_d.weekday()+2)
         start3_d = end3_d - timedelta(days=5) - timedelta(days=4*7)
         end2_d = start3_d - timedelta(days=2)
         start2_d = end2_d - timedelta(days=5) - timedelta(days=4*7)
         end1_d = start2_d - timedelta(days=2)
         start1_d = end1_d - timedelta(days=5) - timedelta(days=4*7)
@@ -540,15 +536,15 @@
             dat.history(start=start1_d, end=end1_d, interval="1h")
             dat.history(start=start2_d, end=end2_d, interval="1h")
 
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregate YFC by day)
             df_yfc = dat.history(start=start1_d, end=end3_d, interval="1h")
-            df_yf = dat_yf.history(start=start1_d, end=end3_d, interval="1d")
+            df_yf = dat_yf.history(start=start1_d, end=end3_d, interval="1d", repair=True)
             df_yfc_daily = df_yfc.copy()
             df_yfc_daily["_day"] = pd.to_datetime(df_yfc_daily.index.date).tz_localize(df_yfc.index.tz)
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==0,"Stock Splits"]=1
             df_yfc_daily = df_yfc_daily.groupby("_day").agg(
                 Open=("Open", "first"),
                 Close=("Close", "last"),
                 Low=("Low", "min"),
@@ -584,15 +580,15 @@
             ss_rcp = 1.0/ss
             csf = ss_rcp.sort_index(ascending=False).cumprod().sort_index(ascending=True).shift(-1, fill_value=1.0)
             df_yf["Volume"] /= csf
             df_yf = df_yf[df_yf.index.date<end3_d]
             self.verify_df(df_yfc, df_yf, 1e-7)
 
     def test_hourly_insert2(self):
-        end3_d = datetime.utcnow().date()
+        end3_d = pd.Timestamp.utcnow().date()
         if not end3_d.weekday() == 5:
             end3_d -= timedelta(days=end3_d.weekday()+2)
         start3_d = end3_d - timedelta(days=5) - timedelta(days=4*7)
         end2_d = start3_d - timedelta(days=2)
         start2_d = end2_d - timedelta(days=5) - timedelta(days=4*7)
         end1_d = start2_d - timedelta(days=2)
         start1_d = end1_d - timedelta(days=5) - timedelta(days=4*7)
@@ -605,15 +601,15 @@
             dat.history(start=start3_d, end=end3_d, interval="1h")
             dat.history(start=start2_d, end=end2_d, interval="1h")
 
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregate YFC by day)
             df_yfc = dat.history(start=start1_d, end=end3_d, interval="1h")
-            df_yf = dat_yf.history(start=start1_d, end=end3_d, interval="1d")
+            df_yf = dat_yf.history(start=start1_d, end=end3_d, interval="1d", repair=True)
             df_yfc_daily = df_yfc.copy()
             df_yfc_daily["_day"] = pd.to_datetime(df_yfc_daily.index.date).tz_localize(df_yfc.index.tz)
             df_yfc_daily.loc[df_yfc_daily["Stock Splits"]==0,"Stock Splits"]=1
             df_yfc_daily = df_yfc_daily.groupby("_day").agg(
                 Open=("Open", "first"),
                 Close=("Close", "last"),
                 Low=("Low", "min"),
```

### Comparing `yfinance_cache-0.6.2/tests/test_yfc_backend.py` & `yfinance_cache-0.6.3/tests/test_yfc_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -84,15 +84,15 @@
         self.tempCacheDir.cleanup()
         self.session.close()
 
     def test_yf_lag(self):
         ## Only use high-volume stocks:
         tkr_candidates = ["AZN.L", "ASML.AS", "BHG.JO", "INTC", "MEL.NZ"]
 
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
 
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr, session=self.session)
             if not yfct.IsTimestampInActiveSession(dat.fast_info["exchange"], dt_now):
                 continue
             expected_lag = yfcd.exchangeToYfLag[dat.fast_info["exchange"]]
```

### Comparing `yfinance_cache-0.6.2/tests/test_yfc_financials.py` & `yfinance_cache-0.6.3/tests/test_yfc_financials.py`

 * *Files 0% similar despite different names*

```diff
@@ -279,15 +279,15 @@
     # tg_caldts, True or False
     def _test_tagged_calendar_dates_noRefresh(self):
         cal_dts = self.fin._get_tagged_calendar_dates(refresh=False)
         pprint(cal_dts)
         self.assertTrue(cal_dts is None or len(cal_dts)==0)
     def _test_tagged_calendar_dates_withRefresh(self):
         # Preset the cache
-        cal = {'Earnings Date': [date(2024, 4, 26), date(2024, 4, 30)], 'FetchDate': datetime.utcnow()}
+        cal = {'Earnings Date': [date(2024, 4, 26), date(2024, 4, 30)], 'FetchDate': pd.Timestamp.utcnow()}
         yfcm.StoreCacheDatum(self.T, "calendar", cal)
 
         cal_dts = self.fin._get_tagged_calendar_dates(refresh=True)
         for x in cal_dts:
             pprint(x)
 
     # fetch_dts, True or False
```

### Comparing `yfinance_cache-0.6.2/tests/test_yfc_interface.py` & `yfinance_cache-0.6.3/tests/test_yfc_interface.py`

 * *Files 9% similar despite different names*

```diff
@@ -81,80 +81,86 @@
         self.tempCacheDir.cleanup()
         self.session.close()
 
 
     def test_history_basics1_usa(self):
         # A fetch of prices, then another fetch of same prices, should return identical
 
-        self.assertFalse(os.path.isdir(os.path.join(self.tempCacheDir.name, self.usa_tkr)))
+        self.assertFalse(os.path.isdir(os.path.join(self.tempCacheDir.name, self.usa_tkr, "history-1d.pkl")))
+
+        week_start = date.today()
+        week_start -= timedelta(days=28)
+        week_start -= timedelta(days=week_start.weekday())
+        td_1d = timedelta(days=1)
+        td_7d = timedelta(days=7)
 
         ## Daily 
-        df1 = self.usa_dat.history(interval="1d", start=date(2022,2,7), end=date(2022,2,15))
+        df1 = self.usa_dat.history(interval="1d", start=week_start, end=week_start+td_7d)
         try:
-            self.assertEqual(df1.shape[0], 6)
+            self.assertGreaterEqual(df1.shape[0], 3)
         except:
             print("df1:")
             print(df1)
             print("")
             raise
-        df2 = self.usa_dat.history(interval="1d", start=date(2022,2,7), end=date(2022,2,15))
+        df2 = self.usa_dat.history(interval="1d", start=week_start, end=week_start+td_7d)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
         self.assertTrue((df2.index.time==time(0)).all())
 
         ## Daily with actions
-        df1 = self.usa_dat.history(interval="1d", start=date(2022,2,7), end=date(2022,2,15), actions=True)
+        df1 = self.usa_dat.history(interval="1d", start=week_start, end=week_start+td_7d, actions=True)
         self.assertTrue("Dividends" in df1.columns.values)
         self.assertTrue("Stock Splits" in df1.columns.values)
-        self.assertEqual(df1.shape[0], 6)
-        df2 = self.usa_dat.history(interval="1d", start=date(2022,2,7), end=date(2022,2,15), actions=True)
+        self.assertGreaterEqual(df1.shape[0], 3)
+        df2 = self.usa_dat.history(interval="1d", start=week_start, end=week_start+td_7d, actions=True)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
         self.assertTrue((df2.index.time==time(0)).all())
 
         ## Hourly
-        df1 = self.usa_dat.history(interval="1h", start=date(2022,2,7), end=date(2022,2,9))
+        df1 = self.usa_dat.history(interval="1h", start=week_start, end=week_start+td_1d*2)
         try:
-            self.assertEqual(df1.shape[0], 14)
+            self.assertGreaterEqual(df1.shape[0], 7)
         except:
             print("df1:")
             print(df1)
             raise
-        df2 = self.usa_dat.history(interval="1h", start=date(2022,2,7), end=date(2022,2,9))
+        df2 = self.usa_dat.history(interval="1h", start=week_start, end=week_start+td_1d*2)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
 
-        ## Weekly 
-        df1 = self.usa_dat.history(interval="1wk", start=date(2022,2,7), end=date(2022,2,19))
+        ## Weekly
+        df1 = self.usa_dat.history(interval="1wk", start=week_start, end=week_start+td_1d*14)
         self.assertEqual(df1.shape[0], 2)
-        df2 = self.usa_dat.history(interval="1wk", start=date(2022,2,7), end=date(2022,2,19))
+        df2 = self.usa_dat.history(interval="1wk", start=week_start, end=week_start+td_1d*14)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
@@ -176,68 +182,74 @@
             print("")
             raise
 
 
     def test_history_basics1_nze(self):
         # A fetch of prices, then another fetch of same prices, should return identical
 
-        self.assertFalse(os.path.isdir(os.path.join(self.tempCacheDir.name, self.nze_tkr)))
+        self.assertFalse(os.path.isdir(os.path.join(self.tempCacheDir.name, self.nze_tkr, "history-1d.pkl")))
+
+        week_start = date.today()
+        week_start -= timedelta(days=28)
+        week_start -= timedelta(days=week_start.weekday())
+        td_1d = timedelta(days=1)
+        td_7d = timedelta(days=7)
 
         ## Daily 
-        df1 = self.nze_dat.history(interval="1d", start=date(2022,2,8), end=date(2022,2,15))
-        self.assertEqual(df1.shape[0], 5)
-        df2 = self.nze_dat.history(interval="1d", start=date(2022,2,8), end=date(2022,2,15))
+        df1 = self.nze_dat.history(interval="1d", start=week_start, end=week_start+td_7d)
+        self.assertGreaterEqual(df1.shape[0], 3)
+        df2 = self.nze_dat.history(interval="1d", start=week_start, end=week_start+td_7d)
         try:
             self.verify_df(df1, df2)
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
         self.assertTrue((df2.index.time==time(0)).all())
 
         ## Daily with actions
-        df1 = self.nze_dat.history(interval="1d", start=date(2022,2,8), end=date(2022,2,15), actions=True)
+        df1 = self.nze_dat.history(interval="1d", start=week_start, end=week_start+td_7d, actions=True)
         self.assertTrue("Dividends" in df1.columns.values)
         self.assertTrue("Stock Splits" in df1.columns.values)
-        self.assertEqual(df1.shape[0], 5)
-        df2 = self.nze_dat.history(interval="1d", start=date(2022,2,8), end=date(2022,2,15), actions=True)
+        self.assertGreaterEqual(df1.shape[0], 3)
+        df2 = self.nze_dat.history(interval="1d", start=week_start, end=week_start+td_7d, actions=True)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
 
         ## Hourly
-        df1 = self.nze_dat.history(interval="1h", start=date(2022,2,8), end=date(2022,2,10))
-        self.assertEqual(df1.shape[0], 14)
-        df2 = self.nze_dat.history(interval="1h", start=date(2022,2,8), end=date(2022,2,10))
+        df1 = self.nze_dat.history(interval="1h", start=week_start, end=week_start+td_1d*2)
+        self.assertGreaterEqual(df1.shape[0], 7)
+        df2 = self.nze_dat.history(interval="1h", start=week_start, end=week_start+td_1d*2)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
             print(df2)
             print("")
             raise
 
         ## Weekly 
-        df1 = self.nze_dat.history(interval="1wk", start=date(2022,2,7), end=date(2022,2,19))
+        df1 = self.nze_dat.history(interval="1wk", start=week_start, end=week_start+td_7d*2)
         self.assertEqual(df1.shape[0], 2)
-        df2 = self.nze_dat.history(interval="1wk", start=date(2022,2,7), end=date(2022,2,19))
+        df2 = self.nze_dat.history(interval="1wk", start=week_start, end=week_start+td_7d*2)
         try:
             self.assertTrue(df1.equals(df2))
         except:
             print("df1:")
             print(df1)
             print("")
             print("df2:")
@@ -397,15 +409,15 @@
 
 
     def test_history_final(self):
         # Test 'Final?' column
         tkr_candidates = ["BHG.JO", "INTC", "MEL.NZ"]
         interval = yfcd.Interval.Days1
 
-        dt_now_utc = datetime.utcnow()
+        dt_now_utc = pd.Timestamp.utcnow()
         dt_now = dt_now_utc.replace(tzinfo=ZoneInfo("UTC"))
 
         start_d = dt_now_utc.date() -timedelta(days=7)
         end_d = dt_now_utc.date() +timedelta(days=1)
 
         # First, check during a live session
         for tkr in tkr_candidates:
@@ -424,15 +436,15 @@
                     print(df1)
                     raise
 
     def test_history_final_v2(self):
         # Test 'Final?' column
         tkr_candidates = ["BHG.JO", "INTC", "MEL.NZ"]
 
-        dt_now_utc = datetime.utcnow()
+        dt_now_utc = pd.Timestamp.utcnow()
         dt_now = dt_now_utc.replace(tzinfo=ZoneInfo("UTC"))
 
         # start_d = dt_now_utc.date() - timedelta(days=7)
         # end_d = dt_now_utc.date() + timedelta(days=1)
 
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr, session=self.session)
@@ -597,15 +609,15 @@
         tkr_candidates = self.tkrs
         interval = yfcd.Interval.Days1
 
         # Exclude low-volume tickers
         del tkr_candidates[tkr_candidates.index("HLTH")]
         del tkr_candidates[tkr_candidates.index("MEL.NZ")]
 
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         start_dt = dt_now - timedelta(days=7)
         end_dt = dt_now+timedelta(days=1)
         start_d = start_dt.date()
         end_d = end_dt.date()
 
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr)
@@ -688,15 +700,15 @@
     def test_history_live_1h_evening(self):
         # Fetch during evening after active session
         tkr_candidates = self.tkrs
         interval = yfcd.Interval.Hours1
         #
         tkr_candidates = ["BHG.JO"]
         #
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         td_1d = timedelta(days=1)
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr, session=None)
             exchange = dat.fast_info["exchange"]
             tz = dat.fast_info["timezone"]
             yfct.SetExchangeTzName(exchange, tz)
             d_now = dt_now.astimezone(ZoneInfo(tz)).date()
@@ -755,15 +767,15 @@
                     self.verify_df(df1, df_yf, rtol=1e-10)
 
     def test_history_live_1d_evening(self):
         # Fetch during evening after active session
         tkr_candidates = self.tkrs
         interval = yfcd.Interval.Days1
         #
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         d_now = dt_now.date()
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr, session=None)
             exchange = dat.fast_info["exchange"]
             yfct.SetExchangeTzName(exchange, dat.fast_info["timezone"])
             if yfct.ExchangeOpenOnDay(exchange, d_now):
                 sched = yfct.GetExchangeSchedule(exchange, d_now, d_now+timedelta(days=1))
@@ -797,15 +809,15 @@
                     self.verify_df(df1, df_yf, rtol=1e-10)
 
     def test_history_live_1w_evening(self):
         # Fetch during evening after active session
         tkr_candidates = self.tkrs
         interval = yfcd.Interval.Week
         #
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         d_now = dt_now.date()
         for tkr in tkr_candidates:
             dat = yfc.Ticker(tkr, session=self.session)
 
             exchange = dat.fast_info["exchange"]
             yfct.SetExchangeTzName(exchange, dat.fast_info["timezone"])
             if yfct.ExchangeOpenOnDay(exchange, d_now):
@@ -853,15 +865,15 @@
         tkr = "IMP.JO"
         dat = yfc.Ticker(tkr, session=self.session)
         exchange = dat.fast_info["exchange"]
         tz_name = dat.fast_info["timezone"]
         tz = ZoneInfo(tz_name)
         yfct.SetExchangeTzName(exchange, tz_name)
 
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         # d_now = dt_now.date()
         d_now = dt_now.astimezone(tz).date()
         td_1d = timedelta(days=1)
         if yfct.ExchangeOpenOnDay(exchange, d_now):
             sched = yfct.GetExchangeSchedule(exchange, d_now-5*td_1d, d_now+td_1d)
             if not sched is None:
                 for i in range(sched.shape[0]-1, -1, -1):
@@ -910,15 +922,15 @@
         dat = yfc.Ticker(tkr, session=self.session)
         start_d = date(2022,7,4)
         end_d = date(2022,7,9)
 
         exchange = dat.fast_info["exchange"]
         yfct.SetExchangeTzName(exchange, dat.fast_info["timezone"])
 
-        dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
         if yfct.IsTimestampInActiveSession(exchange, dt_now):
             df = dat.history(start=start_d, end=end_d, interval="1d", keepna=True)
             idx = 2 # 3rd row = 2022-7-6
             self.assertTrue(np.isnan(df["Close"][idx]) or df["Volume"][idx]==0)
 
             df = dat.history(start=start_d, end=start_d+timedelta(days=1), interval="1h", keepna=True)
             idx = 1
```

### Comparing `yfinance_cache-0.6.2/tests/test_yfc_ticker.py` & `yfinance_cache-0.6.3/tests/test_yfc_ticker.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/tests/utils.py` & `yfinance_cache-0.6.3/tests/utils.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_cache_manager.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_cache_manager.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,12 +1,12 @@
 import os
 import pickle
 import json
 import appdirs
-from pandas import Timedelta
+import pandas as pd
 
 from datetime import datetime, date, timedelta
 from zoneinfo import ZoneInfo
 
 from . import yfc_dat as yfcd
 from . import yfc_utils as yfcu
 
@@ -171,15 +171,15 @@
     d = _ReadData(ticker, objectName)
     if d is not None:
         data   = d["data"]
         md     = d["metadata"] if "metadata" in d else None
         expiry = d["expiry"]   if "expiry"   in d else None
 
         if expiry is not None:
-            dtnow = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+            dtnow = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
             if dtnow >= expiry:
                 if verbose:
                     print("Deleting expired datum '{0}/{1}'".format(ticker, objectName))
                 fp = GetFilepath(ticker, objectName)
                 os.remove(fp)
                 if return_metadata_too:
                     return None, None
@@ -209,15 +209,15 @@
     if (pkData is not None) and (objectName in pkData):
         objData = pkData[objectName]
         data   = objData["data"]
         md     = objData["metadata"] if "metadata" in objData else None
         expiry = objData["expiry"]   if "expiry"   in objData else None
 
         if expiry is not None:
-            dtnow = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+            dtnow = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
             if dtnow >= expiry:
                 if verbose:
                     print("Deleting expired packed datum '{0}/{1}'".format(ticker, objectName))
                 del pkData[objectName]
                 fp = GetFilepath(ticker, objectName)
                 with open(fp, 'wb') as outData:
                     pickle.dump(pkData, outData, 4)
@@ -246,15 +246,15 @@
         return
 
     if (metadata is not None) and not isinstance(metadata, dict):
         raise Exception("'metadata' must be dict of scalars")
     if expiry is not None:
         if isinstance(expiry, yfcd.Interval):
             # Convert interval to actual datetime
-            expiry = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC")) + yfcd.intervalToTimedelta[expiry]
+            expiry = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC")) + yfcd.intervalToTimedelta[expiry]
         if not isinstance(expiry, datetime):
             raise Exception("'expiry' must be datetime or yfcd.Interval")
 
     td = os.path.join(GetCacheDirpath(), ticker)
     if not os.path.isdir(td):
         os.makedirs(td)
 
@@ -310,15 +310,15 @@
 
     if (metadata is not None):
         if not isinstance(metadata, dict):
             raise Exception("'metadata' must be dict of scalars")
     if expiry is not None:
         if isinstance(expiry, yfcd.Interval):
             # Convert interval to actual datetime
-            expiry = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC")) + yfcd.intervalToTimedelta[expiry]
+            expiry = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC")) + yfcd.intervalToTimedelta[expiry]
         if not isinstance(expiry, datetime):
             raise Exception("'expiry' must be datetime or yfcd.Interval")
         if (metadata is not None) and "Expiry" in metadata.keys():
             raise Exception("'metadata' already contains 'Expiry'")
 
     td = os.path.join(GetCacheDirpath(), ticker)
     if not os.path.isdir(td):
@@ -448,15 +448,15 @@
 
     def __getattr__(self, key):
         return self.data.get(key)
 
     def __setattr__(self, key, value):
         if self.name == 'max_ages':
             # Type-check value
-            Timedelta(value)
+            pd.Timedelta(value)
 
         self.data[key] = value
         global _option_manager
         _option_manager._save_option()
 
     def __len__(self):
         return len(self.__dict__['data'])
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_dat.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_dat.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,54 +9,48 @@
 yf_data_cols = yf_price_data_cols+['Volume', 'Dividends', 'Stock Splits']
 yf_min_year = 1950
 
 
 class Period(Enum):
     Days1 = 0
     Days5 = 1
-    Week = 2
     Months1 = 10
     Months3 = 11
     Months6 = 12
     Years1 = 20
     Years2 = 21
     Years5 = 22
-    Years10 = 23
     Ytd = 24
     Max = 30
 periodToString = {}
 periodToString[Period.Days1] = "1d"
 periodToString[Period.Days5] = "5d"
-periodToString[Period.Week] = "1wk"
 periodToString[Period.Months1] = "1mo"
 periodToString[Period.Months3] = "3mo"
 periodToString[Period.Months6] = "6mo"
 periodToString[Period.Years1] = "1y"
 periodToString[Period.Years2] = "2y"
 periodToString[Period.Years5] = "5y"
-periodToString[Period.Years10] = "10y"
 periodToString[Period.Ytd] = "ytd"
 periodToString[Period.Max] = "max"
 periodStrToEnum = {v: k for k, v in periodToString.items()}
 periodToTimedelta = {}
 periodToTimedelta[Period.Days1] = timedelta(days=1)
-periodToTimedelta[Period.Days5] = timedelta(days=5)
-periodToTimedelta[Period.Week] = timedelta(days=7)
+periodToTimedelta[Period.Days5] = timedelta(days=7)
 periodToTimedelta[Period.Months1] = relativedelta(months=1)
 periodToTimedelta[Period.Months3] = relativedelta(months=3)
 periodToTimedelta[Period.Months6] = relativedelta(months=6)
 periodToTimedelta[Period.Years1] = relativedelta(years=1)
 periodToTimedelta[Period.Years2] = relativedelta(years=2)
 periodToTimedelta[Period.Years5] = relativedelta(years=5)
-periodToTimedelta[Period.Years10] = relativedelta(years=10)
 
 
+# Months3 = 0
+# Months1 = 2
 class Interval(Enum):
-    Months3 = 0
-    Months1 = 2
     Week = 5
     Days1 = 10
     Hours1 = 20
     Mins90 = 21
     Mins60 = 22
     Mins30 = 23
     Mins15 = 24
@@ -70,30 +64,30 @@
 intervalToString[Interval.Mins15] = "15m"
 intervalToString[Interval.Mins30] = "30m"
 intervalToString[Interval.Mins60] = "60m"
 intervalToString[Interval.Mins90] = "90m"
 intervalToString[Interval.Hours1] = "1h"
 intervalToString[Interval.Days1] = "1d"
 intervalToString[Interval.Week] = "1wk"
-intervalToString[Interval.Months1] = "1mo"
-intervalToString[Interval.Months3] = "3mo"
+# intervalToString[Interval.Months1] = "1mo"
+# intervalToString[Interval.Months3] = "3mo"
 intervalStrToEnum = {v: k for k, v in intervalToString.items()}
 intervalToTimedelta = {}
 intervalToTimedelta[Interval.Mins1] = timedelta(minutes=1)
 intervalToTimedelta[Interval.Mins2] = timedelta(minutes=2)
 intervalToTimedelta[Interval.Mins5] = timedelta(minutes=5)
 intervalToTimedelta[Interval.Mins15] = timedelta(minutes=15)
 intervalToTimedelta[Interval.Mins30] = timedelta(minutes=30)
 intervalToTimedelta[Interval.Mins60] = timedelta(minutes=60)
 intervalToTimedelta[Interval.Mins90] = timedelta(minutes=90)
 intervalToTimedelta[Interval.Hours1] = timedelta(hours=1)
 intervalToTimedelta[Interval.Days1] = timedelta(days=1)
 intervalToTimedelta[Interval.Week] = timedelta(days=7)
-intervalToTimedelta[Interval.Months1] = relativedelta(months=1)
-intervalToTimedelta[Interval.Months3] = relativedelta(months=3)
+# intervalToTimedelta[Interval.Months1] = relativedelta(months=1)
+# intervalToTimedelta[Interval.Months3] = relativedelta(months=3)
 
 
 exchangeToXcalExchange = {}
 # USA:
 exchangeToXcalExchange["NYQ"] = "XNYS"
 exchangeToXcalExchange["ASE"] = exchangeToXcalExchange["NYQ"]
 exchangeToXcalExchange["PCX"] = exchangeToXcalExchange["NYQ"]  # NYSE Arca
@@ -108,14 +102,15 @@
 exchangeToXcalExchange["CNQ"] = exchangeToXcalExchange["TOR"]  # CSE. TSX competitor, but has same hours
 # Europe:
 exchangeToXcalExchange["LSE"] = "XLON"  # London
 exchangeToXcalExchange["IOB"] = exchangeToXcalExchange["LSE"]
 exchangeToXcalExchange["AMS"] = "XAMS"  # Amsterdam
 exchangeToXcalExchange["ATH"] = "ASEX"  # Athens
 exchangeToXcalExchange["BRU"] = "XBRU"  # Brussels
+exchangeToXcalExchange["BVB"] = "XBSE"  # Bucharest
 exchangeToXcalExchange["CPH"] = "XCSE"  # Copenhagen
 exchangeToXcalExchange["EBS"] = "XSWX"  # Zurich
 exchangeToXcalExchange["FRA"] = "XFRA"  # Frankfurt. Germany also has XETRA but that's part of Frankfurt exchange
 exchangeToXcalExchange["GER"] = "XFRA"  # Frankfurt
 exchangeToXcalExchange["HAM"] = exchangeToXcalExchange["GER"] # Hamburg, assume same as Frankfurt
 exchangeToXcalExchange["HEL"] = "XHEL"  # Helsinki
 exchangeToXcalExchange["ISE"] = "XDUB"  # Ireland
@@ -136,14 +131,17 @@
 exchangeToXcalExchange["JPX"] = "JPX"   # Tokyo
 exchangeToXcalExchange["TAI"] = "XTAI"  # Taiwan
 exchangeToXcalExchange["KSC"] = "XKRX"  # Korea
 exchangeToXcalExchange["SES"] = "XSES"  # Singapore
 exchangeToXcalExchange["HKG"] = "XHKG"  # Hong Kong
 exchangeToXcalExchange["ASX"] = "ASX"   # Australia
 exchangeToXcalExchange["NZE"] = "XNZE"  # New Zealand
+exchangeToXcalExchange["SAU"] = "XSAU"  # Saudi Arabia
+# FX
+exchangeToXcalExchange["CCY"] = "IEPA"  # ICE Data Services
 
 exchangesWithBreaks = {"HKG"}
 
 # Yahoo specify data delays here:
 # https://help.yahoo.com/kb/SLN2310.html?guccounter=1
 exchangeToYfLag = {}
 # USA:
@@ -161,14 +159,15 @@
 exchangeToYfLag["CNQ"] = exchangeToYfLag["TOR"]
 # Europe:
 exchangeToYfLag["LSE"] = timedelta(minutes=20)
 exchangeToYfLag["IOB"] = timedelta(minutes=20)
 exchangeToYfLag["AMS"] = timedelta(minutes=15)
 exchangeToYfLag["ATH"] = timedelta(minutes=15)
 exchangeToYfLag["BRU"] = timedelta(minutes=15)
+exchangeToYfLag["BVB"] = timedelta(minutes=15)
 exchangeToYfLag["CPH"] = timedelta(0)
 exchangeToYfLag["EBS"] = timedelta(minutes=30)
 exchangeToYfLag["FRA"] = timedelta(minutes=15)
 exchangeToYfLag["GER"] = timedelta(minutes=15)
 exchangeToYfLag["HAM"] = exchangeToYfLag["GER"]
 exchangeToYfLag["HEL"] = timedelta(0)
 exchangeToYfLag["ISE"] = timedelta(minutes=15)
@@ -189,14 +188,18 @@
 exchangeToYfLag["JPX"] = timedelta(minutes=20)
 exchangeToYfLag["TAI"] = timedelta(minutes=20)
 exchangeToYfLag["KSC"] = timedelta(minutes=20)
 exchangeToYfLag["SES"] = timedelta(minutes=20)
 exchangeToYfLag["HKG"] = timedelta(minutes=15)
 exchangeToYfLag["ASX"] = timedelta(minutes=20)
 exchangeToYfLag["NZE"] = timedelta(minutes=20)
+exchangeToYfLag["SAU"] = timedelta(minutes=15)
+# FX:
+exchangeToYfLag["CCY"] = timedelta(0)
+exchangeToYfLag["CCC"] = timedelta(0)
 
 # After-market auctions:
 exchangesWithAuction = set()
 exchangeAuctionDelay = {}
 exchangeAuctionDuration = {}
 # ASX after-market auction starts 10m after close but no end time given. So allow 1 minute
 exchangesWithAuction.add("ASX")
@@ -215,36 +218,36 @@
 yfMaxFetchRange[Interval.Mins15] = timedelta(days=60)
 yfMaxFetchRange[Interval.Mins30] = timedelta(days=60)
 yfMaxFetchRange[Interval.Mins90] = timedelta(days=60)
 yfMaxFetchRange[Interval.Mins60] = timedelta(days=730)
 yfMaxFetchRange[Interval.Hours1] = timedelta(days=730)
 yfMaxFetchRange[Interval.Days1] = None
 yfMaxFetchRange[Interval.Week] = None
-yfMaxFetchRange[Interval.Months1] = None
-yfMaxFetchRange[Interval.Months3] = None
+# yfMaxFetchRange[Interval.Months1] = None
+# yfMaxFetchRange[Interval.Months3] = None
 
 yfMaxFetchLookback = {}
 yfMaxFetchLookback[Interval.Mins1] = timedelta(days=30)
 yfMaxFetchLookback[Interval.Mins2] = timedelta(days=60)
 yfMaxFetchLookback[Interval.Mins5] = timedelta(days=60)
 yfMaxFetchLookback[Interval.Mins15] = timedelta(days=60)
 yfMaxFetchLookback[Interval.Mins30] = timedelta(days=60)
 yfMaxFetchLookback[Interval.Mins90] = timedelta(days=60)
 yfMaxFetchLookback[Interval.Mins60] = timedelta(days=730)
 yfMaxFetchLookback[Interval.Hours1] = timedelta(days=730)
 yfMaxFetchLookback[Interval.Days1] = None
 yfMaxFetchLookback[Interval.Week] = None
-yfMaxFetchLookback[Interval.Months1] = None
-yfMaxFetchLookback[Interval.Months3] = None
+# yfMaxFetchLookback[Interval.Months1] = None
+# yfMaxFetchLookback[Interval.Months3] = None
 
 listing_date_check_tols = {}
 listing_date_check_tols[Interval.Days1] = timedelta(days=7)
 listing_date_check_tols[Interval.Week] = timedelta(days=14)
-listing_date_check_tols[Interval.Months1] = timedelta(days=35)
-listing_date_check_tols[Interval.Months3] = timedelta(days=35*3)
+# listing_date_check_tols[Interval.Months1] = timedelta(days=35)
+# listing_date_check_tols[Interval.Months3] = timedelta(days=35*3)
 
 
 class Financials(Enum):
     IncomeStmt = 0
     BalanceSheet = 1
     CashFlow = 2
 
@@ -421,15 +424,18 @@
         if not isinstance(other, DateIntervalIndex):
             return False
         if len(self.array) != len(other.array):
             return False
         return np.equal(self.array, other.array)
 
     def equals(self, other):
-        return (self == other).all()
+        e = self == other
+        if isinstance(e, np.ndarray):
+            e = e.all()
+        return e
 
     def __str__(self):
         s = "DateIntervalIndex([ "
         for x in self.array:
             s += x.__str__() + " , "
         s += "])"
         return s
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_financials_manager.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_financials_manager.py`

 * *Files 0% similar despite different names*

```diff
@@ -3,18 +3,19 @@
 from . import yfc_dat as yfcd
 from . import yfc_cache_manager as yfcm
 from . import yfc_utils as yfcu
 
 import numpy as np
 import pandas as pd
 import scipy.stats as stats
+from time import sleep
 from datetime import datetime, date, timedelta
 from dateutil.relativedelta import relativedelta
 import os
-from statistics import mean, stdev
+from statistics import mean
 import math
 from decimal import Decimal
 from pprint import pprint
 
 
 d_today = date.today()
 yf_spam_window = timedelta(days=7)
@@ -270,15 +271,17 @@
                     # Use crude logic to estimate when to re-fetch
                     if 'LastFetch' in md.keys():
                         do_fetch = md['LastFetch'] < (dt_now - td_1d*30)
                     else:
                         do_fetch = True
                 else:
                     next_release = None
-                    last_d = df.columns.max().date()
+                    # last_d = df.columns.max().date()
+                    # Update: analyse pruned dates:
+                    last_d = self._prune_yf_financial_df(df).columns.max().date()
                     for r in releases:
                         # Release is newer than cache
                         try:
                             if r.period_end <= last_d:
                                 continue
                         except yfcd.AmbiguousComparisonException:
                             # Treat as match
@@ -1555,33 +1558,35 @@
 
         last_fetch = None
         if self._earnings_dates is None:
             if yfcm.IsDatumCached(self.ticker, "earnings_dates"):
                 if debug:
                     print("- retrieving earnings dates from cache")
                 self._earnings_dates, md = yfcm.ReadCacheDatum(self.ticker, "earnings_dates", True)
-
                 if md is None:
-                    raise Exception("f{self.ticker}: Why earnings_dates metadata None?")
                     md = {}
-                if 'LastFetch' not in md:
-                    raise Exception("f{self.ticker}: Why earnings_dates metadata missing 'LastFetch'?")
-                    fp = yfcm.GetFilepath(self.ticker, "earnings_dates")
-                    last_fetch = datetime.fromtimestamp(os.path.getmtime(fp)).astimezone()
-                    md['LastFetch'] = last_fetch
-                    yfcm.WriteCacheMetadata(self.ticker, "earnings_dates", 'LastFetch', md['LastFetch'])
-                if self._earnings_dates.empty:
-                    self._earnings_dates = None
+                if self._earnings_dates is None:
+                    # Fine, just means last call failed to get earnings_dates
+                    pass
                 else:
-                    edf_clean = self._clean_earnings_dates(self._earnings_dates, refresh)
-                    if len(edf_clean) < len(self._earnings_dates):
-                        # This is ok, because since the last fetch, the calendar can be updated which then allows resolving a 
-                        # near-duplication in earnings_dates.
-                        yfcm.StoreCacheDatum(self.ticker, "earnings_dates", edf_clean)
-                    self._earnings_dates = edf_clean
+                    if 'LastFetch' not in md:
+                        raise Exception("f{self.ticker}: Why earnings_dates metadata missing 'LastFetch'?")
+                        fp = yfcm.GetFilepath(self.ticker, "earnings_dates")
+                        last_fetch = datetime.fromtimestamp(os.path.getmtime(fp)).astimezone()
+                        md['LastFetch'] = last_fetch
+                        yfcm.WriteCacheMetadata(self.ticker, "earnings_dates", 'LastFetch', md['LastFetch'])
+                    if self._earnings_dates.empty:
+                        self._earnings_dates = None
+                    else:
+                        edf_clean = self._clean_earnings_dates(self._earnings_dates, refresh)
+                        if len(edf_clean) < len(self._earnings_dates):
+                            # This is ok, because since the last fetch, the calendar can be updated which then allows resolving a 
+                            # near-duplication in earnings_dates.
+                            yfcm.StoreCacheDatum(self.ticker, "earnings_dates", edf_clean)
+                        self._earnings_dates = edf_clean
 
         last_fetch = yfcm.ReadCacheMetadata(self.ticker, "earnings_dates", "LastFetch")
         if debug:
             print("- last_fetch =", last_fetch)
 
         # Ensure column 'Date confirmed?' is present, and update with calendar
         df_modified = False
@@ -1828,15 +1833,29 @@
         # debug = True
 
         if debug:
             print(f"{self.ticker}: _fetch_earnings_dates(limit={limit}, refresh={refresh})")
         elif print_fetches:
             print(f"{self.ticker}: fetching {limit} earnings dates")
 
-        df = self.dat.get_earnings_dates(limit)
+        repeat_fetch = False
+        try:
+            df = self.dat.get_earnings_dates(limit)
+        except KeyError as e:
+            if "Earnings Date" in str(e):
+                # Rarely, Yahoo returns a completely different table for earnings dates.
+                # Try again.
+                repeat_fetch = True
+            else:
+                raise
+        if repeat_fetch:
+            sleep(1)
+            # Avoid cache this time, but add sleeps to maintain rate-limiting
+            df = yf.Ticker(self.ticker).get_earnings_dates(limit)
+            sleep(1)
         if df is None or df.empty:
             if debug:
                 print("- Yahoo returned None")
             return None
         df['FetchDate'] = pd.Timestamp.utcnow().tz_convert(self.tzName)
 
         if df.shape[0] < limit:
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_logging.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_logging.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_multi.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_multi.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_options.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_options.py`

 * *Files identical despite different names*

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_prices_manager.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_prices_manager.py`

 * *Files 2% similar despite different names*

```diff
@@ -231,12523 +231,12387 @@
 00000e60: 636d 2e52 6561 6443 6163 6865 4461 7475  cm.ReadCacheDatu
 00000e70: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
 00000e80: 7370 6c69 7473 2229 2e73 6f72 745f 696e  splits").sort_in
 00000e90: 6465 7828 290a 2020 2020 2020 2020 656c  dex().        el
 00000ea0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
 00000eb0: 7365 6c66 2e73 706c 6974 7320 3d20 4e6f  self.splits = No
 00000ec0: 6e65 0a0a 2020 2020 6465 6620 4765 7444  ne..    def GetD
-00000ed0: 6976 7328 7365 6c66 2c20 7374 6172 742c  ivs(self, start,
-00000ee0: 2065 6e64 3d4e 6f6e 6529 3a0a 2020 2020   end=None):.    
-00000ef0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-00000f00: 636b 4461 7465 5374 7269 6374 2873 7461  ckDateStrict(sta
-00000f10: 7274 2c20 2273 7461 7274 2229 0a20 2020  rt, "start").   
-00000f20: 2020 2020 2069 6620 656e 6420 6973 206e       if end is n
-00000f30: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00000f40: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00000f50: 6563 6b44 6174 6553 7472 6963 7428 656e  eckDateStrict(en
-00000f60: 642c 2022 656e 6422 290a 0a20 2020 2020  d, "end")..     
-00000f70: 2020 2069 6620 7365 6c66 2e64 6976 7320     if self.divs 
-00000f80: 6973 204e 6f6e 6520 6f72 2073 656c 662e  is None or self.
-00000f90: 6469 7673 2e65 6d70 7479 3a0a 2020 2020  divs.empty:.    
-00000fa0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00000fb0: 6f6e 650a 0a20 2020 2020 2020 2074 7a20  one..        tz 
-00000fc0: 3d20 7365 6c66 2e64 6976 732e 696e 6465  = self.divs.inde
-00000fd0: 785b 305d 2e74 7a0a 2020 2020 2020 2020  x[0].tz.        
-00000fe0: 7374 6172 7420 3d20 7064 2e54 696d 6573  start = pd.Times
-00000ff0: 7461 6d70 2873 7461 7274 292e 747a 5f6c  tamp(start).tz_l
-00001000: 6f63 616c 697a 6528 747a 290a 2020 2020  ocalize(tz).    
-00001010: 2020 2020 6966 2065 6e64 2069 7320 6e6f      if end is no
-00001020: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00001030: 2020 2020 656e 6420 3d20 7064 2e54 696d      end = pd.Tim
-00001040: 6573 7461 6d70 2865 6e64 292e 747a 5f6c  estamp(end).tz_l
-00001050: 6f63 616c 697a 6528 747a 290a 0a20 2020  ocalize(tz)..   
-00001060: 2020 2020 2074 645f 3164 203d 2074 696d       td_1d = tim
-00001070: 6564 656c 7461 2864 6179 733d 3129 0a20  edelta(days=1). 
-00001080: 2020 2020 2020 2069 6620 656e 6420 6973         if end is
-00001090: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000010a0: 2020 2073 6c63 203d 2073 656c 662e 6469     slc = self.di
-000010b0: 7673 2e6c 6f63 5b73 7461 7274 3a5d 0a20  vs.loc[start:]. 
-000010c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000010d0: 2020 2020 2020 2020 2073 6c63 203d 2073           slc = s
-000010e0: 656c 662e 6469 7673 2e6c 6f63 5b73 7461  elf.divs.loc[sta
-000010f0: 7274 3a65 6e64 2d74 645f 3164 5d0a 2020  rt:end-td_1d].  
-00001100: 2020 2020 2020 6966 2073 6c63 2e65 6d70        if slc.emp
-00001110: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00001120: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-00001130: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00001140: 2020 2020 2020 7265 7475 726e 2073 6c63        return slc
-00001150: 2e63 6f70 7928 290a 0a20 2020 2064 6566  .copy()..    def
-00001160: 2047 6574 4469 7673 4665 7463 6865 6453   GetDivsFetchedS
-00001170: 696e 6365 2873 656c 662c 2064 7429 3a0a  ince(self, dt):.
-00001180: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00001190: 6543 6865 636b 4461 7465 7469 6d65 2864  eCheckDatetime(d
-000011a0: 742c 2022 6474 2229 0a0a 2020 2020 2020  t, "dt")..      
-000011b0: 2020 6966 2073 656c 662e 6469 7673 2069    if self.divs i
-000011c0: 7320 4e6f 6e65 206f 7220 7365 6c66 2e64  s None or self.d
-000011d0: 6976 732e 656d 7074 793a 0a20 2020 2020  ivs.empty:.     
-000011e0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-000011f0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
-00001200: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00001210: 203d 2073 656c 662e 6469 7673 5b22 4665   = self.divs["Fe
-00001220: 7463 6844 6174 6522 5d20 3e20 6474 0a20  tchDate"] > dt. 
-00001230: 2020 2020 2020 2020 2020 2069 6620 662e             if f.
-00001240: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-00001250: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00001260: 7365 6c66 2e64 6976 735b 665d 2e63 6f70  self.divs[f].cop
-00001270: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00001280: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00001290: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
-000012a0: 6f6e 650a 0a20 2020 2020 2020 2072 6574  one..        ret
-000012b0: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-000012c0: 6465 6620 4765 7453 706c 6974 7328 7365  def GetSplits(se
-000012d0: 6c66 2c20 7374 6172 742c 2065 6e64 3d4e  lf, start, end=N
-000012e0: 6f6e 6529 3a0a 2020 2020 2020 2020 7966  one):.        yf
-000012f0: 6375 2e54 7970 6543 6865 636b 4461 7465  cu.TypeCheckDate
-00001300: 5374 7269 6374 2873 7461 7274 2c20 2273  Strict(start, "s
-00001310: 7461 7274 2229 0a20 2020 2020 2020 2069  tart").        i
-00001320: 6620 656e 6420 6973 206e 6f74 204e 6f6e  f end is not Non
-00001330: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
-00001340: 6663 752e 5479 7065 4368 6563 6b44 6174  fcu.TypeCheckDat
-00001350: 6553 7472 6963 7428 656e 642c 2022 656e  eStrict(end, "en
-00001360: 6422 290a 0a20 2020 2020 2020 2072 6573  d")..        res
-00001370: 756c 7420 3d20 4e6f 6e65 0a20 2020 2020  ult = None.     
-00001380: 2020 2069 6620 7365 6c66 2e73 706c 6974     if self.split
-00001390: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
-000013a0: 6420 6e6f 7420 7365 6c66 2e73 706c 6974  d not self.split
-000013b0: 732e 656d 7074 793a 0a20 2020 2020 2020  s.empty:.       
-000013c0: 2020 2020 2073 7461 7274 203d 2070 642e       start = pd.
-000013d0: 5469 6d65 7374 616d 7028 7374 6172 7429  Timestamp(start)
-000013e0: 2e74 7a5f 6c6f 6361 6c69 7a65 2873 656c  .tz_localize(sel
-000013f0: 662e 7370 6c69 7473 2e69 6e64 6578 5b30  f.splits.index[0
-00001400: 5d2e 747a 290a 2020 2020 2020 2020 2020  ].tz).          
-00001410: 2020 6966 2065 6e64 2069 7320 6e6f 7420    if end is not 
-00001420: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00001430: 2020 2020 2020 656e 6420 3d20 7064 2e54        end = pd.T
-00001440: 696d 6573 7461 6d70 2865 6e64 292e 747a  imestamp(end).tz
-00001450: 5f6c 6f63 616c 697a 6528 7365 6c66 2e73  _localize(self.s
-00001460: 706c 6974 732e 696e 6465 785b 305d 2e74  plits.index[0].t
-00001470: 7a29 0a20 2020 2020 2020 2020 2020 2074  z).            t
-00001480: 645f 3164 203d 2074 696d 6564 656c 7461  d_1d = timedelta
-00001490: 2864 6179 733d 3129 0a20 2020 2020 2020  (days=1).       
-000014a0: 2020 2020 2069 6620 656e 6420 6973 204e       if end is N
-000014b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000014c0: 2020 2020 2073 6c63 203d 2073 656c 662e       slc = self.
-000014d0: 7370 6c69 7473 2e6c 6f63 5b73 7461 7274  splits.loc[start
-000014e0: 3a5d 0a20 2020 2020 2020 2020 2020 2065  :].            e
-000014f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00001500: 2020 2020 2073 6c63 203d 2073 656c 662e       slc = self.
-00001510: 7370 6c69 7473 2e6c 6f63 5b73 7461 7274  splits.loc[start
-00001520: 3a65 6e64 2d74 645f 3164 5d0a 0a20 2020  :end-td_1d]..   
-00001530: 2020 2020 2020 2020 2069 6620 736c 632e           if slc.
-00001540: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
-00001550: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00001560: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00001570: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00001580: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00001590: 736c 632e 636f 7079 2829 0a0a 2020 2020  slc.copy()..    
-000015a0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-000015b0: 740a 0a20 2020 2064 6566 2047 6574 5370  t..    def GetSp
-000015c0: 6c69 7473 4665 7463 6865 6453 696e 6365  litsFetchedSince
-000015d0: 2873 656c 662c 2064 7429 3a0a 2020 2020  (self, dt):.    
-000015e0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-000015f0: 636b 4461 7465 7469 6d65 2864 742c 2022  ckDatetime(dt, "
-00001600: 6474 2229 0a0a 2020 2020 2020 2020 6966  dt")..        if
-00001610: 2073 656c 662e 7370 6c69 7473 2069 7320   self.splits is 
-00001620: 4e6f 6e65 206f 7220 7365 6c66 2e73 706c  None or self.spl
-00001630: 6974 732e 656d 7074 793a 0a20 2020 2020  its.empty:.     
-00001640: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00001650: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
-00001660: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00001670: 203d 2073 656c 662e 7370 6c69 7473 5b22   = self.splits["
-00001680: 4665 7463 6844 6174 6522 5d20 3e20 6474  FetchDate"] > dt
-00001690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000016a0: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
-000016b0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-000016c0: 3d20 7365 6c66 2e73 706c 6974 735b 665d  = self.splits[f]
-000016d0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-000016e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000016f0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00001700: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-00001710: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00001720: 2020 2020 6465 6620 5570 6461 7465 5370      def UpdateSp
-00001730: 6c69 7473 2873 656c 662c 2073 706c 6974  lits(self, split
-00001740: 735f 6466 293a 0a20 2020 2020 2020 206e  s_df):.        n
-00001750: 203d 2073 706c 6974 735f 6466 2e73 6861   = splits_df.sha
-00001760: 7065 5b30 5d0a 2020 2020 2020 2020 7966  pe[0].        yf
-00001770: 636c 2e54 7261 6365 456e 7465 7228 6622  cl.TraceEnter(f"
-00001780: 504d 3a20 5570 6461 7465 5370 6c69 7473  PM: UpdateSplits
-00001790: 287b 7370 6c69 7473 5f64 662e 696e 6465  ({splits_df.inde
-000017a0: 782e 6461 7465 7d29 2229 2069 6620 6e20  x.date})") if n 
-000017b0: 3c3d 2032 2065 6c73 6520 7966 636c 2e54  <= 2 else yfcl.T
-000017c0: 7261 6365 456e 7465 7228 6622 504d 3a20  raceEnter(f"PM: 
-000017d0: 5570 6461 7465 5370 6c69 7473 286e 3d7b  UpdateSplits(n={
-000017e0: 6e7d 2922 290a 0a20 2020 2020 2020 2073  n})")..        s
-000017f0: 656c 665f 7370 6c69 7473 5f6d 6f64 6966  elf_splits_modif
-00001800: 6965 6420 3d20 4661 6c73 650a 0a20 2020  ied = False..   
-00001810: 2020 2020 2064 6562 7567 203d 2046 616c       debug = Fal
-00001820: 7365 0a20 2020 2020 2020 2023 2064 6562  se.        # deb
-00001830: 7567 203d 2054 7275 650a 0a20 2020 2020  ug = True..     
-00001840: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
-00001850: 6b44 6174 6146 7261 6d65 2873 706c 6974  kDataFrame(split
-00001860: 735f 6466 2c20 2273 706c 6974 735f 6466  s_df, "splits_df
-00001870: 2229 0a20 2020 2020 2020 2073 706c 6974  ").        split
-00001880: 735f 6466 203d 2073 706c 6974 735f 6466  s_df = splits_df
-00001890: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-000018a0: 6966 206e 6f74 2073 706c 6974 735f 6466  if not splits_df
-000018b0: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
-000018c0: 2020 2020 6578 7065 6374 6564 5f63 6f6c      expected_col
-000018d0: 7320 3d20 5b22 5374 6f63 6b20 5370 6c69  s = ["Stock Spli
-000018e0: 7473 222c 2022 4665 7463 6844 6174 6522  ts", "FetchDate"
-000018f0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-00001900: 7220 6320 696e 2065 7870 6563 7465 645f  r c in expected_
-00001910: 636f 6c73 3a0a 2020 2020 2020 2020 2020  cols:.          
-00001920: 2020 2020 2020 6966 2063 206e 6f74 2069        if c not i
-00001930: 6e20 7370 6c69 7473 5f64 662e 636f 6c75  n splits_df.colu
-00001940: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-00001950: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00001960: 616c 7565 4572 726f 7228 2255 7064 6174  alueError("Updat
-00001970: 6553 706c 6974 7328 2920 2773 706c 6974  eSplits() 'split
-00001980: 735f 6466 2720 636f 6c75 6d6e 7320 6d75  s_df' columns mu
-00001990: 7374 2063 6f6e 7461 696e 3a20 277b 6578  st contain: '{ex
-000019a0: 7065 6374 6564 5f63 6f6c 737d 2722 290a  pected_cols}'").
-000019b0: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-000019c0: 7265 7061 7265 2027 7370 6c69 7473 5f64  repare 'splits_d
-000019d0: 6627 2066 6f72 2061 7070 656e 640a 2020  f' for append.  
-000019e0: 2020 2020 2020 2020 2020 7370 6c69 7473            splits
-000019f0: 5f64 665b 2253 7570 6572 7365 6465 6420  _df["Superseded 
-00001a00: 7370 6c69 7422 5d20 3d20 302e 300a 2020  split"] = 0.0.  
-00001a10: 2020 2020 2020 2020 2020 7370 6c69 7473            splits
-00001a20: 5f64 665b 2253 7570 6572 7365 6465 6420  _df["Superseded 
-00001a30: 7370 6c69 7420 4665 7463 6844 6174 6522  split FetchDate"
-00001a40: 5d20 3d20 7064 2e4e 6154 0a20 2020 2020  ] = pd.NaT.     
-00001a50: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
-00001a60: 2073 706c 6974 735f 6466 2e69 6e64 6578   splits_df.index
-00001a70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00001a80: 2020 6e65 775f 7370 6c69 7420 3d20 7370    new_split = sp
-00001a90: 6c69 7473 5f64 662e 6c6f 635b 6474 2c20  lits_df.loc[dt, 
-00001aa0: 2253 746f 636b 2053 706c 6974 7322 5d0a  "Stock Splits"].
-00001ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ac0: 6966 2073 656c 662e 7370 6c69 7473 2069  if self.splits i
-00001ad0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2064  s not None and d
-00001ae0: 7420 696e 2073 656c 662e 7370 6c69 7473  t in self.splits
-00001af0: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
-00001b00: 2020 2020 2020 2020 2020 2020 6361 6368              cach
-00001b10: 6564 5f73 706c 6974 203d 2073 656c 662e  ed_split = self.
-00001b20: 7370 6c69 7473 2e6c 6f63 5b64 742c 2022  splits.loc[dt, "
-00001b30: 5374 6f63 6b20 5370 6c69 7473 225d 0a20  Stock Splits"]. 
-00001b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b50: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-00001b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b70: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
-00001b80: 7269 6e74 2866 2270 7265 2d65 7869 7374  rint(f"pre-exist
-00001b90: 696e 6720 7374 6f63 6b2d 7370 6c69 7420  ing stock-split 
-00001ba0: 4020 7b64 747d 3a20 7b63 6163 6865 645f  @ {dt}: {cached_
-00001bb0: 7370 6c69 747d 2076 7320 7b6e 6577 5f73  split} vs {new_s
-00001bc0: 706c 6974 7d22 290a 2020 2020 2020 2020  plit}").        
-00001bd0: 2020 2020 2020 2020 2020 2020 6469 6666              diff
-00001be0: 5f70 6374 203d 2031 3030 2a61 6273 2863  _pct = 100*abs(c
-00001bf0: 6163 6865 645f 7370 6c69 742d 6e65 775f  ached_split-new_
-00001c00: 7370 6c69 7429 2f63 6163 6865 645f 7370  split)/cached_sp
-00001c10: 6c69 740a 2020 2020 2020 2020 2020 2020  lit.            
-00001c20: 2020 2020 2020 2020 6966 2064 6966 665f          if diff_
-00001c30: 7063 7420 3c20 302e 3031 3a0a 2020 2020  pct < 0.01:.    
+00000ed0: 6976 7328 7365 6c66 2c20 7374 6172 743d  ivs(self, start=
+00000ee0: 4e6f 6e65 2c20 656e 643d 4e6f 6e65 293a  None, end=None):
+00000ef0: 0a20 2020 2020 2020 2069 6620 7374 6172  .        if star
+00000f00: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+00000f10: 2020 2020 2020 2020 2020 2079 6663 752e             yfcu.
+00000f20: 5479 7065 4368 6563 6b44 6174 6553 7472  TypeCheckDateStr
+00000f30: 6963 7428 7374 6172 742c 2022 7374 6172  ict(start, "star
+00000f40: 7422 290a 2020 2020 2020 2020 6966 2065  t").        if e
+00000f50: 6e64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nd is not None:.
+00000f60: 2020 2020 2020 2020 2020 2020 7966 6375              yfcu
+00000f70: 2e54 7970 6543 6865 636b 4461 7465 5374  .TypeCheckDateSt
+00000f80: 7269 6374 2865 6e64 2c20 2265 6e64 2229  rict(end, "end")
+00000f90: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00000fa0: 662e 6469 7673 2069 7320 4e6f 6e65 206f  f.divs is None o
+00000fb0: 7220 7365 6c66 2e64 6976 732e 656d 7074  r self.divs.empt
+00000fc0: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
+00000fd0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00000fe0: 2020 2020 6966 2073 7461 7274 2069 7320      if start is 
+00000ff0: 4e6f 6e65 2061 6e64 2065 6e64 2069 7320  None and end is 
+00001000: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00001010: 2020 7265 7475 726e 2073 656c 662e 6469    return self.di
+00001020: 7673 2e63 6f70 7928 290a 0a20 2020 2020  vs.copy()..     
+00001030: 2020 2074 7a20 3d20 7365 6c66 2e64 6976     tz = self.div
+00001040: 732e 696e 6465 785b 305d 2e74 7a0a 2020  s.index[0].tz.  
+00001050: 2020 2020 2020 6966 2073 7461 7274 2069        if start i
+00001060: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00001070: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00001080: 7064 2e54 696d 6573 7461 6d70 2873 7461  pd.Timestamp(sta
+00001090: 7274 292e 747a 5f6c 6f63 616c 697a 6528  rt).tz_localize(
+000010a0: 747a 290a 2020 2020 2020 2020 6966 2065  tz).        if e
+000010b0: 6e64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nd is not None:.
+000010c0: 2020 2020 2020 2020 2020 2020 656e 6420              end 
+000010d0: 3d20 7064 2e54 696d 6573 7461 6d70 2865  = pd.Timestamp(e
+000010e0: 6e64 292e 747a 5f6c 6f63 616c 697a 6528  nd).tz_localize(
+000010f0: 747a 290a 0a20 2020 2020 2020 2074 645f  tz)..        td_
+00001100: 3164 203d 2074 696d 6564 656c 7461 2864  1d = timedelta(d
+00001110: 6179 733d 3129 0a20 2020 2020 2020 2069  ays=1).        i
+00001120: 6620 656e 6420 6973 204e 6f6e 653a 0a20  f end is None:. 
+00001130: 2020 2020 2020 2020 2020 2073 6c63 203d             slc =
+00001140: 2073 656c 662e 6469 7673 2e6c 6f63 5b73   self.divs.loc[s
+00001150: 7461 7274 3a5d 0a20 2020 2020 2020 2065  tart:].        e
+00001160: 6c69 6620 7374 6172 7420 6973 204e 6f6e  lif start is Non
+00001170: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00001180: 6c63 203d 2073 656c 662e 6469 7673 2e6c  lc = self.divs.l
+00001190: 6f63 5b3a 656e 642d 7464 5f31 645d 0a20  oc[:end-td_1d]. 
+000011a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000011b0: 2020 2020 2020 2020 2073 6c63 203d 2073           slc = s
+000011c0: 656c 662e 6469 7673 2e6c 6f63 5b73 7461  elf.divs.loc[sta
+000011d0: 7274 3a65 6e64 2d74 645f 3164 5d0a 2020  rt:end-td_1d].  
+000011e0: 2020 2020 2020 6966 2073 6c63 2e65 6d70        if slc.emp
+000011f0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00001200: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+00001210: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001220: 2020 2020 2020 7265 7475 726e 2073 6c63        return slc
+00001230: 2e63 6f70 7928 290a 0a20 2020 2064 6566  .copy()..    def
+00001240: 2047 6574 4469 7673 4665 7463 6865 6453   GetDivsFetchedS
+00001250: 696e 6365 2873 656c 662c 2064 7429 3a0a  ince(self, dt):.
+00001260: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
+00001270: 6543 6865 636b 4461 7465 7469 6d65 2864  eCheckDatetime(d
+00001280: 742c 2022 6474 2229 0a0a 2020 2020 2020  t, "dt")..      
+00001290: 2020 6966 2073 656c 662e 6469 7673 2069    if self.divs i
+000012a0: 7320 4e6f 6e65 206f 7220 7365 6c66 2e64  s None or self.d
+000012b0: 6976 732e 656d 7074 793a 0a20 2020 2020  ivs.empty:.     
+000012c0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+000012d0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
+000012e0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+000012f0: 203d 2073 656c 662e 6469 7673 5b22 4665   = self.divs["Fe
+00001300: 7463 6844 6174 6522 5d20 3e20 6474 0a20  tchDate"] > dt. 
+00001310: 2020 2020 2020 2020 2020 2069 6620 662e             if f.
+00001320: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+00001330: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00001340: 7365 6c66 2e64 6976 735b 665d 2e63 6f70  self.divs[f].cop
+00001350: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+00001360: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001370: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
+00001380: 6f6e 650a 0a20 2020 2020 2020 2072 6574  one..        ret
+00001390: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
+000013a0: 6465 6620 4765 7453 706c 6974 7328 7365  def GetSplits(se
+000013b0: 6c66 2c20 7374 6172 742c 2065 6e64 3d4e  lf, start, end=N
+000013c0: 6f6e 6529 3a0a 2020 2020 2020 2020 7966  one):.        yf
+000013d0: 6375 2e54 7970 6543 6865 636b 4461 7465  cu.TypeCheckDate
+000013e0: 5374 7269 6374 2873 7461 7274 2c20 2273  Strict(start, "s
+000013f0: 7461 7274 2229 0a20 2020 2020 2020 2069  tart").        i
+00001400: 6620 656e 6420 6973 206e 6f74 204e 6f6e  f end is not Non
+00001410: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
+00001420: 6663 752e 5479 7065 4368 6563 6b44 6174  fcu.TypeCheckDat
+00001430: 6553 7472 6963 7428 656e 642c 2022 656e  eStrict(end, "en
+00001440: 6422 290a 0a20 2020 2020 2020 2072 6573  d")..        res
+00001450: 756c 7420 3d20 4e6f 6e65 0a20 2020 2020  ult = None.     
+00001460: 2020 2069 6620 7365 6c66 2e73 706c 6974     if self.split
+00001470: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+00001480: 6420 6e6f 7420 7365 6c66 2e73 706c 6974  d not self.split
+00001490: 732e 656d 7074 793a 0a20 2020 2020 2020  s.empty:.       
+000014a0: 2020 2020 2073 7461 7274 203d 2070 642e       start = pd.
+000014b0: 5469 6d65 7374 616d 7028 7374 6172 7429  Timestamp(start)
+000014c0: 2e74 7a5f 6c6f 6361 6c69 7a65 2873 656c  .tz_localize(sel
+000014d0: 662e 7370 6c69 7473 2e69 6e64 6578 5b30  f.splits.index[0
+000014e0: 5d2e 747a 290a 2020 2020 2020 2020 2020  ].tz).          
+000014f0: 2020 6966 2065 6e64 2069 7320 6e6f 7420    if end is not 
+00001500: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00001510: 2020 2020 2020 656e 6420 3d20 7064 2e54        end = pd.T
+00001520: 696d 6573 7461 6d70 2865 6e64 292e 747a  imestamp(end).tz
+00001530: 5f6c 6f63 616c 697a 6528 7365 6c66 2e73  _localize(self.s
+00001540: 706c 6974 732e 696e 6465 785b 305d 2e74  plits.index[0].t
+00001550: 7a29 0a20 2020 2020 2020 2020 2020 2074  z).            t
+00001560: 645f 3164 203d 2074 696d 6564 656c 7461  d_1d = timedelta
+00001570: 2864 6179 733d 3129 0a20 2020 2020 2020  (days=1).       
+00001580: 2020 2020 2069 6620 656e 6420 6973 204e       if end is N
+00001590: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000015a0: 2020 2020 2073 6c63 203d 2073 656c 662e       slc = self.
+000015b0: 7370 6c69 7473 2e6c 6f63 5b73 7461 7274  splits.loc[start
+000015c0: 3a5d 0a20 2020 2020 2020 2020 2020 2065  :].            e
+000015d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000015e0: 2020 2020 2073 6c63 203d 2073 656c 662e       slc = self.
+000015f0: 7370 6c69 7473 2e6c 6f63 5b73 7461 7274  splits.loc[start
+00001600: 3a65 6e64 2d74 645f 3164 5d0a 0a20 2020  :end-td_1d]..   
+00001610: 2020 2020 2020 2020 2069 6620 736c 632e           if slc.
+00001620: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
+00001630: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00001640: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00001650: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00001660: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00001670: 736c 632e 636f 7079 2829 0a0a 2020 2020  slc.copy()..    
+00001680: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00001690: 740a 0a20 2020 2064 6566 2047 6574 5370  t..    def GetSp
+000016a0: 6c69 7473 4665 7463 6865 6453 696e 6365  litsFetchedSince
+000016b0: 2873 656c 662c 2064 7429 3a0a 2020 2020  (self, dt):.    
+000016c0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
+000016d0: 636b 4461 7465 7469 6d65 2864 742c 2022  ckDatetime(dt, "
+000016e0: 6474 2229 0a0a 2020 2020 2020 2020 6966  dt")..        if
+000016f0: 2073 656c 662e 7370 6c69 7473 2069 7320   self.splits is 
+00001700: 4e6f 6e65 206f 7220 7365 6c66 2e73 706c  None or self.spl
+00001710: 6974 732e 656d 7074 793a 0a20 2020 2020  its.empty:.     
+00001720: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00001730: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
+00001740: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00001750: 203d 2073 656c 662e 7370 6c69 7473 5b22   = self.splits["
+00001760: 4665 7463 6844 6174 6522 5d20 3e20 6474  FetchDate"] > dt
+00001770: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00001780: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
+00001790: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+000017a0: 3d20 7365 6c66 2e73 706c 6974 735b 665d  = self.splits[f]
+000017b0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+000017c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000017d0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000017e0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+000017f0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00001800: 2020 2020 6465 6620 5570 6461 7465 5370      def UpdateSp
+00001810: 6c69 7473 2873 656c 662c 2073 706c 6974  lits(self, split
+00001820: 735f 6466 293a 0a20 2020 2020 2020 206e  s_df):.        n
+00001830: 203d 2073 706c 6974 735f 6466 2e73 6861   = splits_df.sha
+00001840: 7065 5b30 5d0a 2020 2020 2020 2020 7966  pe[0].        yf
+00001850: 636c 2e54 7261 6365 456e 7465 7228 6622  cl.TraceEnter(f"
+00001860: 504d 3a20 5570 6461 7465 5370 6c69 7473  PM: UpdateSplits
+00001870: 287b 7370 6c69 7473 5f64 662e 696e 6465  ({splits_df.inde
+00001880: 782e 6461 7465 7d29 2229 2069 6620 6e20  x.date})") if n 
+00001890: 3c3d 2032 2065 6c73 6520 7966 636c 2e54  <= 2 else yfcl.T
+000018a0: 7261 6365 456e 7465 7228 6622 504d 3a20  raceEnter(f"PM: 
+000018b0: 5570 6461 7465 5370 6c69 7473 286e 3d7b  UpdateSplits(n={
+000018c0: 6e7d 2922 290a 0a20 2020 2020 2020 2073  n})")..        s
+000018d0: 656c 665f 7370 6c69 7473 5f6d 6f64 6966  elf_splits_modif
+000018e0: 6965 6420 3d20 4661 6c73 650a 0a20 2020  ied = False..   
+000018f0: 2020 2020 2064 6562 7567 203d 2046 616c       debug = Fal
+00001900: 7365 0a20 2020 2020 2020 2023 2064 6562  se.        # deb
+00001910: 7567 203d 2054 7275 650a 0a20 2020 2020  ug = True..     
+00001920: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+00001930: 6b44 6174 6146 7261 6d65 2873 706c 6974  kDataFrame(split
+00001940: 735f 6466 2c20 2273 706c 6974 735f 6466  s_df, "splits_df
+00001950: 2229 0a20 2020 2020 2020 2073 706c 6974  ").        split
+00001960: 735f 6466 203d 2073 706c 6974 735f 6466  s_df = splits_df
+00001970: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00001980: 6966 206e 6f74 2073 706c 6974 735f 6466  if not splits_df
+00001990: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+000019a0: 2020 2020 6578 7065 6374 6564 5f63 6f6c      expected_col
+000019b0: 7320 3d20 5b22 5374 6f63 6b20 5370 6c69  s = ["Stock Spli
+000019c0: 7473 222c 2022 4665 7463 6844 6174 6522  ts", "FetchDate"
+000019d0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+000019e0: 7220 6320 696e 2065 7870 6563 7465 645f  r c in expected_
+000019f0: 636f 6c73 3a0a 2020 2020 2020 2020 2020  cols:.          
+00001a00: 2020 2020 2020 6966 2063 206e 6f74 2069        if c not i
+00001a10: 6e20 7370 6c69 7473 5f64 662e 636f 6c75  n splits_df.colu
+00001a20: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
+00001a30: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00001a40: 616c 7565 4572 726f 7228 2255 7064 6174  alueError("Updat
+00001a50: 6553 706c 6974 7328 2920 2773 706c 6974  eSplits() 'split
+00001a60: 735f 6466 2720 636f 6c75 6d6e 7320 6d75  s_df' columns mu
+00001a70: 7374 2063 6f6e 7461 696e 3a20 277b 6578  st contain: '{ex
+00001a80: 7065 6374 6564 5f63 6f6c 737d 2722 290a  pected_cols}'").
+00001a90: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00001aa0: 7265 7061 7265 2027 7370 6c69 7473 5f64  repare 'splits_d
+00001ab0: 6627 2066 6f72 2061 7070 656e 640a 2020  f' for append.  
+00001ac0: 2020 2020 2020 2020 2020 7370 6c69 7473            splits
+00001ad0: 5f64 665b 2253 7570 6572 7365 6465 6420  _df["Superseded 
+00001ae0: 7370 6c69 7422 5d20 3d20 302e 300a 2020  split"] = 0.0.  
+00001af0: 2020 2020 2020 2020 2020 7370 6c69 7473            splits
+00001b00: 5f64 665b 2253 7570 6572 7365 6465 6420  _df["Superseded 
+00001b10: 7370 6c69 7420 4665 7463 6844 6174 6522  split FetchDate"
+00001b20: 5d20 3d20 7064 2e4e 6154 0a20 2020 2020  ] = pd.NaT.     
+00001b30: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+00001b40: 2073 706c 6974 735f 6466 2e69 6e64 6578   splits_df.index
+00001b50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001b60: 2020 6e65 775f 7370 6c69 7420 3d20 7370    new_split = sp
+00001b70: 6c69 7473 5f64 662e 6c6f 635b 6474 2c20  lits_df.loc[dt, 
+00001b80: 2253 746f 636b 2053 706c 6974 7322 5d0a  "Stock Splits"].
+00001b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ba0: 6966 2073 656c 662e 7370 6c69 7473 2069  if self.splits i
+00001bb0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2064  s not None and d
+00001bc0: 7420 696e 2073 656c 662e 7370 6c69 7473  t in self.splits
+00001bd0: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
+00001be0: 2020 2020 2020 2020 2020 2020 6361 6368              cach
+00001bf0: 6564 5f73 706c 6974 203d 2073 656c 662e  ed_split = self.
+00001c00: 7370 6c69 7473 2e6c 6f63 5b64 742c 2022  splits.loc[dt, "
+00001c10: 5374 6f63 6b20 5370 6c69 7473 225d 0a20  Stock Splits"]. 
+00001c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001c30: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
 00001c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c50: 2020 2020 2320 7469 6e79 2064 6966 6665      # tiny diffe
-00001c60: 7265 6e63 652c 2065 6173 6965 7220 746f  rence, easier to
-00001c70: 206a 7573 7420 6b65 6570 206f 6c64 2076   just keep old v
-00001c80: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-00001c90: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-00001ca0: 6974 735f 6466 203d 2073 706c 6974 735f  its_df = splits_
-00001cb0: 6466 2e64 726f 7028 6474 290a 2020 2020  df.drop(dt).    
-00001cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cd0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-00001ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cf0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00001d00: 7261 6365 5072 696e 7428 2269 676e 6f72  racePrint("ignor
-00001d10: 696e 6722 290a 2020 2020 2020 2020 2020  ing").          
-00001d20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00001d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d40: 2020 2020 2020 2020 7370 6c69 7473 5f64          splits_d
-00001d50: 662e 6c6f 635b 6474 2c20 2253 7570 6572  f.loc[dt, "Super
-00001d60: 7365 6465 6420 7370 6c69 7422 5d20 3d20  seded split"] = 
-00001d70: 7365 6c66 2e73 706c 6974 732e 6c6f 635b  self.splits.loc[
-00001d80: 6474 2c20 2253 746f 636b 2053 706c 6974  dt, "Stock Split
-00001d90: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
-00001da0: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
-00001db0: 7473 5f64 662e 6c6f 635b 6474 2c20 2253  ts_df.loc[dt, "S
-00001dc0: 7570 6572 7365 6465 6420 7370 6c69 7420  uperseded split 
-00001dd0: 4665 7463 6844 6174 6522 5d20 3d20 7365  FetchDate"] = se
-00001de0: 6c66 2e73 706c 6974 732e 6c6f 635b 6474  lf.splits.loc[dt
-00001df0: 2c20 2246 6574 6368 4461 7465 225d 0a20  , "FetchDate"]. 
-00001e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e10: 2020 2020 2020 2073 656c 662e 7370 6c69         self.spli
-00001e20: 7473 203d 2073 656c 662e 7370 6c69 7473  ts = self.splits
-00001e30: 2e64 726f 7028 6474 290a 2020 2020 2020  .drop(dt).      
-00001e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e50: 2020 7365 6c66 5f73 706c 6974 735f 6d6f    self_splits_mo
-00001e60: 6469 6669 6564 203d 2054 7275 650a 2020  dified = True.  
-00001e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e80: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
-00001e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ea0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
-00001eb0: 2e54 7261 6365 5072 696e 7428 2273 7570  .TracePrint("sup
-00001ec0: 6572 7365 6465 2229 0a0a 2020 2020 2020  ersede")..      
-00001ed0: 2020 2020 2020 636f 6c73 203d 205b 2253        cols = ["S
-00001ee0: 746f 636b 2053 706c 6974 7322 2c20 2246  tock Splits", "F
-00001ef0: 6574 6368 4461 7465 222c 2022 5375 7065  etchDate", "Supe
-00001f00: 7273 6564 6564 2073 706c 6974 222c 2022  rseded split", "
-00001f10: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
-00001f20: 2046 6574 6368 4461 7465 225d 0a20 2020   FetchDate"].   
-00001f30: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00001f40: 7370 6c69 7473 5f64 662e 656d 7074 793a  splits_df.empty:
-00001f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001f60: 2073 706c 6974 735f 7072 6574 7479 203d   splits_pretty =
-00001f70: 2073 706c 6974 735f 6466 5b22 5374 6f63   splits_df["Stoc
-00001f80: 6b20 5370 6c69 7473 225d 0a20 2020 2020  k Splits"].     
-00001f90: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00001fa0: 735f 7072 6574 7479 2e69 6e64 6578 203d  s_pretty.index =
-00001fb0: 2073 706c 6974 735f 7072 6574 7479 2e69   splits_pretty.i
-00001fc0: 6e64 6578 2e64 6174 652e 6173 7479 7065  ndex.date.astype
-00001fd0: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
-00001fe0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-00001ff0: 6572 2e4c 6f67 4576 656e 7428 2269 6e66  er.LogEvent("inf
-00002000: 6f22 2c20 2253 706c 6974 4d61 6e61 6765  o", "SplitManage
-00002010: 7222 2c20 6622 7b73 706c 6974 735f 7072  r", f"{splits_pr
-00002020: 6574 7479 2e73 6861 7065 5b30 5d7d 206e  etty.shape[0]} n
-00002030: 6577 2073 706c 6974 733a 207b 7370 6c69  ew splits: {spli
-00002040: 7473 5f70 7265 7474 792e 746f 5f64 6963  ts_pretty.to_dic
-00002050: 7428 297d 2229 0a0a 2020 2020 2020 2020  t()}")..        
-00002060: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00002070: 7370 6c69 7473 2069 7320 4e6f 6e65 3a0a  splits is None:.
-00002080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002090: 2020 2020 7365 6c66 2e73 706c 6974 7320      self.splits 
-000020a0: 3d20 7370 6c69 7473 5f64 665b 636f 6c73  = splits_df[cols
-000020b0: 5d2e 636f 7079 2829 0a20 2020 2020 2020  ].copy().       
-000020c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020e0: 2020 2073 656c 662e 7370 6c69 7473 203d     self.splits =
-000020f0: 2070 642e 636f 6e63 6174 285b 7365 6c66   pd.concat([self
-00002100: 2e73 706c 6974 732c 2073 706c 6974 735f  .splits, splits_
-00002110: 6466 5b63 6f6c 735d 5d2c 2073 6f72 743d  df[cols]], sort=
-00002120: 5472 7565 292e 736f 7274 5f69 6e64 6578  True).sort_index
-00002130: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00002140: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-00002150: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-00002160: 6b65 722c 2022 7370 6c69 7473 222c 2073  ker, "splits", s
-00002170: 656c 662e 7370 6c69 7473 290a 2020 2020  elf.splits).    
-00002180: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00002190: 665f 7370 6c69 7473 5f6d 6f64 6966 6965  f_splits_modifie
-000021a0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-000021b0: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-000021c0: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-000021d0: 6b65 722c 2022 7370 6c69 7473 222c 2073  ker, "splits", s
-000021e0: 656c 662e 7370 6c69 7473 290a 0a20 2020  elf.splits)..   
-000021f0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
-00002200: 7869 7428 2255 7064 6174 6553 706c 6974  xit("UpdateSplit
-00002210: 7328 2920 7265 7475 726e 696e 6722 290a  s() returning").
-00002220: 0a20 2020 2064 6566 2055 7064 6174 6544  .    def UpdateD
-00002230: 6976 6964 656e 6473 2873 656c 662c 2064  ividends(self, d
-00002240: 6976 735f 6466 293a 0a20 2020 2020 2020  ivs_df):.       
-00002250: 2064 6562 7567 203d 2046 616c 7365 0a20   debug = False. 
-00002260: 2020 2020 2020 2023 2064 6562 7567 203d         # debug =
-00002270: 2054 7275 650a 0a20 2020 2020 2020 206e   True..        n
-00002280: 203d 2064 6976 735f 6466 2e73 6861 7065   = divs_df.shape
-00002290: 5b30 5d0a 2020 2020 2020 2020 7966 636c  [0].        yfcl
-000022a0: 2e54 7261 6365 456e 7465 7228 6622 504d  .TraceEnter(f"PM
-000022b0: 3a20 5570 6461 7465 4469 7669 6465 6e64  : UpdateDividend
-000022c0: 7328 7b64 6976 735f 6466 2e69 6e64 6578  s({divs_df.index
-000022d0: 2e64 6174 657d 2922 2920 6966 206e 203c  .date})") if n <
-000022e0: 3d20 3220 656c 7365 2079 6663 6c2e 5472  = 2 else yfcl.Tr
-000022f0: 6163 6545 6e74 6572 2866 2250 4d3a 2055  aceEnter(f"PM: U
-00002300: 7064 6174 6544 6976 6964 656e 6473 286e  pdateDividends(n
-00002310: 3d7b 6e7d 2922 290a 0a20 2020 2020 2020  ={n})")..       
-00002320: 2073 656c 665f 6469 7673 5f6d 6f64 6966   self_divs_modif
-00002330: 6965 6420 3d20 4661 6c73 650a 0a20 2020  ied = False..   
-00002340: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00002350: 6563 6b44 6174 6146 7261 6d65 2864 6976  eckDataFrame(div
-00002360: 735f 6466 2c20 2264 6976 735f 6466 2229  s_df, "divs_df")
-00002370: 0a20 2020 2020 2020 2064 6976 735f 6466  .        divs_df
-00002380: 203d 2064 6976 735f 6466 2e63 6f70 7928   = divs_df.copy(
-00002390: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-000023a0: 2064 6976 735f 6466 2e65 6d70 7479 3a0a   divs_df.empty:.
-000023b0: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-000023c0: 6374 6564 5f63 6f6c 7320 3d20 5b22 4469  cted_cols = ["Di
-000023d0: 7669 6465 6e64 7322 2c20 2246 6574 6368  vidends", "Fetch
-000023e0: 4461 7465 222c 2022 436c 6f73 6520 6461  Date", "Close da
-000023f0: 7920 6265 666f 7265 225d 0a20 2020 2020  y before"].     
-00002400: 2020 2020 2020 2023 2065 7870 6563 7465         # expecte
-00002410: 645f 636f 6c73 203d 205b 2244 6976 6964  d_cols = ["Divid
-00002420: 656e 6473 222c 2022 4665 7463 6844 6174  ends", "FetchDat
-00002430: 6522 2c20 2243 6c6f 7365 2074 6f64 6179  e", "Close today
-00002440: 225d 0a20 2020 2020 2020 2020 2020 2066  "].            f
-00002450: 6f72 2063 2069 6e20 6578 7065 6374 6564  or c in expected
-00002460: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
-00002470: 2020 2020 2020 2069 6620 6320 6e6f 7420         if c not 
-00002480: 696e 2064 6976 735f 6466 2e63 6f6c 756d  in divs_df.colum
-00002490: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000024a0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000024b0: 6c75 6545 7272 6f72 2866 2241 6464 4469  lueError(f"AddDi
-000024c0: 7669 6465 6e64 7328 2920 2764 6976 735f  vidends() 'divs_
-000024d0: 6466 2720 6973 206d 6973 7369 6e67 2063  df' is missing c
-000024e0: 6f6c 756d 6e3a 2027 7b63 7d27 2229 0a0a  olumn: '{c}'")..
-000024f0: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
-00002500: 6570 6172 6520 2764 6976 735f 6466 2720  epare 'divs_df' 
-00002510: 666f 7220 6170 7065 6e64 0a20 2020 2020  for append.     
-00002520: 2020 2020 2020 2064 6976 735f 6466 5b22         divs_df["
-00002530: 4261 636b 2041 646a 2e22 5d20 3d20 6e70  Back Adj."] = np
-00002540: 2e6e 616e 0a20 2020 2020 2020 2020 2020  .nan.           
-00002550: 2064 6976 735f 6466 5b22 5375 7065 7273   divs_df["Supers
-00002560: 6564 6564 2064 6976 225d 203d 2030 2e30  eded div"] = 0.0
-00002570: 0a20 2020 2020 2020 2020 2020 2064 6976  .            div
-00002580: 735f 6466 5b22 5375 7065 7273 6564 6564  s_df["Superseded
-00002590: 2062 6163 6b20 6164 6a2e 225d 203d 2030   back adj."] = 0
-000025a0: 2e30 0a20 2020 2020 2020 2020 2020 2064  .0.            d
-000025b0: 6976 735f 6466 5b22 5375 7065 7273 6564  ivs_df["Supersed
-000025c0: 6564 2064 6976 2046 6574 6368 4461 7465  ed div FetchDate
-000025d0: 225d 203d 2070 642e 4e61 540a 2020 2020  "] = pd.NaT.    
-000025e0: 2020 2020 2020 2020 666f 7220 6474 2069          for dt i
-000025f0: 6e20 6469 7673 5f64 662e 696e 6465 783a  n divs_df.index:
-00002600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002610: 206e 6577 5f64 6976 203d 2064 6976 735f   new_div = divs_
-00002620: 6466 2e6c 6f63 5b64 742c 2022 4469 7669  df.loc[dt, "Divi
-00002630: 6465 6e64 7322 5d0a 0a20 2020 2020 2020  dends"]..       
-00002640: 2020 2020 2020 2020 2063 6c6f 7365 5f62           close_b
-00002650: 6566 6f72 6520 3d20 6469 7673 5f64 662e  efore = divs_df.
-00002660: 6c6f 635b 6474 2c20 2243 6c6f 7365 2064  loc[dt, "Close d
-00002670: 6179 2062 6566 6f72 6522 5d0a 2020 2020  ay before"].    
-00002680: 2020 2020 2020 2020 2020 2020 2320 6164              # ad
-00002690: 6a20 3d20 2863 6c6f 7365 5f62 6566 6f72  j = (close_befor
-000026a0: 6520 2d20 6e65 775f 6469 7629 202f 2063  e - new_div) / c
-000026b0: 6c6f 7365 5f62 6566 6f72 650a 2020 2020  lose_before.    
-000026c0: 2020 2020 2020 2020 2020 2020 6164 6a20              adj 
-000026d0: 3d20 312e 3020 2d20 6e65 775f 6469 7620  = 1.0 - new_div 
-000026e0: 2f20 636c 6f73 655f 6265 666f 7265 0a20  / close_before. 
-000026f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00002700: 2023 2046 203d 2050 322f 2850 322b 4429   # F = P2/(P2+D)
-00002710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002720: 2023 2023 2068 7474 703a 2f2f 6d61 7275   # # http://maru
-00002730: 626f 7a75 2e62 6c6f 6773 706f 742e 636f  bozu.blogspot.co
-00002740: 6d2f 3230 3036 2f30 392f 686f 772d 7961  m/2006/09/how-ya
-00002750: 686f 6f2d 6361 6c63 756c 6174 6573 2d61  hoo-calculates-a
-00002760: 646a 7573 7465 642d 636c 6f73 696e 672e  djusted-closing.
-00002770: 6874 6d6c 2363 3830 3338 3036 3439 3735  html#c8038064975
-00002780: 3138 3537 3038 3835 360a 2020 2020 2020  185708856.      
-00002790: 2020 2020 2020 2020 2020 2320 636c 6f73            # clos
-000027a0: 655f 746f 6461 7920 3d20 6469 7673 5f64  e_today = divs_d
-000027b0: 662e 6c6f 635b 6474 2c20 2243 6c6f 7365  f.loc[dt, "Close
-000027c0: 2074 6f64 6179 225d 0a20 2020 2020 2020   today"].       
-000027d0: 2020 2020 2020 2020 2023 2061 646a 203d           # adj =
-000027e0: 2063 6c6f 7365 5f74 6f64 6179 202f 2028   close_today / (
-000027f0: 636c 6f73 655f 746f 6461 7920 2b20 6e65  close_today + ne
-00002800: 775f 6469 7629 0a20 2020 2020 2020 2020  w_div).         
-00002810: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00002820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002830: 6966 206e 702e 6973 6e61 6e28 6164 6a29  if np.isnan(adj)
-00002840: 3a20 2023 2074 6f64 6f3a 2072 656d 6f76  :  # todo: remov
-00002850: 6520 6f6e 6365 2063 6f6e 6669 726d 2059  e once confirm Y
-00002860: 4643 2062 7567 2d66 7265 650a 2020 2020  FC bug-free.    
-00002870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002880: 2020 2020 7072 696e 7428 6469 7673 5f64      print(divs_d
-00002890: 662e 6c6f 635b 6474 5d29 0a20 2020 2020  f.loc[dt]).     
-000028a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000028b0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-000028c0: 6f6e 2822 4261 636b 2041 646a 2e20 6973  on("Back Adj. is
-000028d0: 204e 614e 2229 0a20 2020 2020 2020 2020   NaN").         
-000028e0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-000028f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002900: 2020 2070 7269 6e74 2822 6474 3d22 2c20     print("dt=", 
-00002910: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-00002920: 2020 2020 2020 2020 7072 696e 7428 2254          print("T
-00002930: 3d22 2c20 7365 6c66 2e74 6963 6b65 7229  =", self.ticker)
-00002940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002950: 2020 2020 2070 7269 6e74 2822 6469 7673       print("divs
-00002960: 5f64 663a 2229 203b 2070 7269 6e74 2864  _df:") ; print(d
-00002970: 6976 735f 6466 290a 2020 2020 2020 2020  ivs_df).        
-00002980: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00002990: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000029a0: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
+00001c50: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
+00001c60: 7269 6e74 2866 2270 7265 2d65 7869 7374  rint(f"pre-exist
+00001c70: 696e 6720 7374 6f63 6b2d 7370 6c69 7420  ing stock-split 
+00001c80: 4020 7b64 747d 3a20 7b63 6163 6865 645f  @ {dt}: {cached_
+00001c90: 7370 6c69 747d 2076 7320 7b6e 6577 5f73  split} vs {new_s
+00001ca0: 706c 6974 7d22 290a 2020 2020 2020 2020  plit}").        
+00001cb0: 2020 2020 2020 2020 2020 2020 6469 6666              diff
+00001cc0: 5f70 6374 203d 2031 3030 2a61 6273 2863  _pct = 100*abs(c
+00001cd0: 6163 6865 645f 7370 6c69 742d 6e65 775f  ached_split-new_
+00001ce0: 7370 6c69 7429 2f63 6163 6865 645f 7370  split)/cached_sp
+00001cf0: 6c69 740a 2020 2020 2020 2020 2020 2020  lit.            
+00001d00: 2020 2020 2020 2020 6966 2064 6966 665f          if diff_
+00001d10: 7063 7420 3c20 302e 3031 3a0a 2020 2020  pct < 0.01:.    
+00001d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d30: 2020 2020 2320 7469 6e79 2064 6966 6665      # tiny diffe
+00001d40: 7265 6e63 652c 2065 6173 6965 7220 746f  rence, easier to
+00001d50: 206a 7573 7420 6b65 6570 206f 6c64 2076   just keep old v
+00001d60: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+00001d70: 2020 2020 2020 2020 2020 2020 2073 706c               spl
+00001d80: 6974 735f 6466 203d 2073 706c 6974 735f  its_df = splits_
+00001d90: 6466 2e64 726f 7028 6474 290a 2020 2020  df.drop(dt).    
+00001da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001db0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+00001dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001dd0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00001de0: 7261 6365 5072 696e 7428 2269 676e 6f72  racePrint("ignor
+00001df0: 696e 6722 290a 2020 2020 2020 2020 2020  ing").          
+00001e00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00001e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e20: 2020 2020 2020 2020 7370 6c69 7473 5f64          splits_d
+00001e30: 662e 6c6f 635b 6474 2c20 2253 7570 6572  f.loc[dt, "Super
+00001e40: 7365 6465 6420 7370 6c69 7422 5d20 3d20  seded split"] = 
+00001e50: 7365 6c66 2e73 706c 6974 732e 6c6f 635b  self.splits.loc[
+00001e60: 6474 2c20 2253 746f 636b 2053 706c 6974  dt, "Stock Split
+00001e70: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
+00001e80: 2020 2020 2020 2020 2020 2020 7370 6c69              spli
+00001e90: 7473 5f64 662e 6c6f 635b 6474 2c20 2253  ts_df.loc[dt, "S
+00001ea0: 7570 6572 7365 6465 6420 7370 6c69 7420  uperseded split 
+00001eb0: 4665 7463 6844 6174 6522 5d20 3d20 7365  FetchDate"] = se
+00001ec0: 6c66 2e73 706c 6974 732e 6c6f 635b 6474  lf.splits.loc[dt
+00001ed0: 2c20 2246 6574 6368 4461 7465 225d 0a20  , "FetchDate"]. 
+00001ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ef0: 2020 2020 2020 2073 656c 662e 7370 6c69         self.spli
+00001f00: 7473 203d 2073 656c 662e 7370 6c69 7473  ts = self.splits
+00001f10: 2e64 726f 7028 6474 290a 2020 2020 2020  .drop(dt).      
+00001f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f30: 2020 7365 6c66 5f73 706c 6974 735f 6d6f    self_splits_mo
+00001f40: 6469 6669 6564 203d 2054 7275 650a 2020  dified = True.  
+00001f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f60: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+00001f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f80: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+00001f90: 2e54 7261 6365 5072 696e 7428 2273 7570  .TracePrint("sup
+00001fa0: 6572 7365 6465 2229 0a0a 2020 2020 2020  ersede")..      
+00001fb0: 2020 2020 2020 636f 6c73 203d 205b 2253        cols = ["S
+00001fc0: 746f 636b 2053 706c 6974 7322 2c20 2246  tock Splits", "F
+00001fd0: 6574 6368 4461 7465 222c 2022 5375 7065  etchDate", "Supe
+00001fe0: 7273 6564 6564 2073 706c 6974 222c 2022  rseded split", "
+00001ff0: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
+00002000: 2046 6574 6368 4461 7465 225d 0a20 2020   FetchDate"].   
+00002010: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00002020: 7370 6c69 7473 5f64 662e 656d 7074 793a  splits_df.empty:
+00002030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002040: 2073 706c 6974 735f 7072 6574 7479 203d   splits_pretty =
+00002050: 2073 706c 6974 735f 6466 5b22 5374 6f63   splits_df["Stoc
+00002060: 6b20 5370 6c69 7473 225d 0a20 2020 2020  k Splits"].     
+00002070: 2020 2020 2020 2020 2020 2073 706c 6974             split
+00002080: 735f 7072 6574 7479 2e69 6e64 6578 203d  s_pretty.index =
+00002090: 2073 706c 6974 735f 7072 6574 7479 2e69   splits_pretty.i
+000020a0: 6e64 6578 2e64 6174 652e 6173 7479 7065  ndex.date.astype
+000020b0: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
+000020c0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
+000020d0: 6572 2e4c 6f67 4576 656e 7428 2269 6e66  er.LogEvent("inf
+000020e0: 6f22 2c20 2253 706c 6974 4d61 6e61 6765  o", "SplitManage
+000020f0: 7222 2c20 6622 7b73 706c 6974 735f 7072  r", f"{splits_pr
+00002100: 6574 7479 2e73 6861 7065 5b30 5d7d 206e  etty.shape[0]} n
+00002110: 6577 2073 706c 6974 733a 207b 7370 6c69  ew splits: {spli
+00002120: 7473 5f70 7265 7474 792e 746f 5f64 6963  ts_pretty.to_dic
+00002130: 7428 297d 2229 0a0a 2020 2020 2020 2020  t()}")..        
+00002140: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00002150: 7370 6c69 7473 2069 7320 4e6f 6e65 3a0a  splits is None:.
+00002160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002170: 2020 2020 7365 6c66 2e73 706c 6974 7320      self.splits 
+00002180: 3d20 7370 6c69 7473 5f64 665b 636f 6c73  = splits_df[cols
+00002190: 5d2e 636f 7079 2829 0a20 2020 2020 2020  ].copy().       
+000021a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000021b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021c0: 2020 2073 656c 662e 7370 6c69 7473 203d     self.splits =
+000021d0: 2070 642e 636f 6e63 6174 285b 7365 6c66   pd.concat([self
+000021e0: 2e73 706c 6974 732c 2073 706c 6974 735f  .splits, splits_
+000021f0: 6466 5b63 6f6c 735d 5d2c 2073 6f72 743d  df[cols]], sort=
+00002200: 5472 7565 292e 736f 7274 5f69 6e64 6578  True).sort_index
+00002210: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00002220: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
+00002230: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
+00002240: 6b65 722c 2022 7370 6c69 7473 222c 2073  ker, "splits", s
+00002250: 656c 662e 7370 6c69 7473 290a 2020 2020  elf.splits).    
+00002260: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+00002270: 665f 7370 6c69 7473 5f6d 6f64 6966 6965  f_splits_modifie
+00002280: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00002290: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
+000022a0: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
+000022b0: 6b65 722c 2022 7370 6c69 7473 222c 2073  ker, "splits", s
+000022c0: 656c 662e 7370 6c69 7473 290a 0a20 2020  elf.splits)..   
+000022d0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+000022e0: 7869 7428 2255 7064 6174 6553 706c 6974  xit("UpdateSplit
+000022f0: 7328 2920 7265 7475 726e 696e 6722 290a  s() returning").
+00002300: 0a20 2020 2064 6566 2055 7064 6174 6544  .    def UpdateD
+00002310: 6976 6964 656e 6473 2873 656c 662c 2064  ividends(self, d
+00002320: 6976 735f 6466 293a 0a20 2020 2020 2020  ivs_df):.       
+00002330: 2064 6562 7567 203d 2046 616c 7365 0a20   debug = False. 
+00002340: 2020 2020 2020 2023 2064 6562 7567 203d         # debug =
+00002350: 2054 7275 650a 0a20 2020 2020 2020 206e   True..        n
+00002360: 203d 2064 6976 735f 6466 2e73 6861 7065   = divs_df.shape
+00002370: 5b30 5d0a 2020 2020 2020 2020 7966 636c  [0].        yfcl
+00002380: 2e54 7261 6365 456e 7465 7228 6622 504d  .TraceEnter(f"PM
+00002390: 3a20 5570 6461 7465 4469 7669 6465 6e64  : UpdateDividend
+000023a0: 7328 7b64 6976 735f 6466 2e69 6e64 6578  s({divs_df.index
+000023b0: 2e64 6174 657d 2922 2920 6966 206e 203c  .date})") if n <
+000023c0: 3d20 3220 656c 7365 2079 6663 6c2e 5472  = 2 else yfcl.Tr
+000023d0: 6163 6545 6e74 6572 2866 2250 4d3a 2055  aceEnter(f"PM: U
+000023e0: 7064 6174 6544 6976 6964 656e 6473 286e  pdateDividends(n
+000023f0: 3d7b 6e7d 2922 290a 0a20 2020 2020 2020  ={n})")..       
+00002400: 2073 656c 665f 6469 7673 5f6d 6f64 6966   self_divs_modif
+00002410: 6965 6420 3d20 4661 6c73 650a 0a20 2020  ied = False..   
+00002420: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00002430: 6563 6b44 6174 6146 7261 6d65 2864 6976  eckDataFrame(div
+00002440: 735f 6466 2c20 2264 6976 735f 6466 2229  s_df, "divs_df")
+00002450: 0a20 2020 2020 2020 2064 6976 735f 6466  .        divs_df
+00002460: 203d 2064 6976 735f 6466 2e63 6f70 7928   = divs_df.copy(
+00002470: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00002480: 2064 6976 735f 6466 2e65 6d70 7479 3a0a   divs_df.empty:.
+00002490: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+000024a0: 6374 6564 5f63 6f6c 7320 3d20 5b22 4469  cted_cols = ["Di
+000024b0: 7669 6465 6e64 7322 2c20 2246 6574 6368  vidends", "Fetch
+000024c0: 4461 7465 222c 2022 436c 6f73 6520 6461  Date", "Close da
+000024d0: 7920 6265 666f 7265 225d 0a20 2020 2020  y before"].     
+000024e0: 2020 2020 2020 2023 2065 7870 6563 7465         # expecte
+000024f0: 645f 636f 6c73 203d 205b 2244 6976 6964  d_cols = ["Divid
+00002500: 656e 6473 222c 2022 4665 7463 6844 6174  ends", "FetchDat
+00002510: 6522 2c20 2243 6c6f 7365 2074 6f64 6179  e", "Close today
+00002520: 225d 0a20 2020 2020 2020 2020 2020 2066  "].            f
+00002530: 6f72 2063 2069 6e20 6578 7065 6374 6564  or c in expected
+00002540: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
+00002550: 2020 2020 2020 2069 6620 6320 6e6f 7420         if c not 
+00002560: 696e 2064 6976 735f 6466 2e63 6f6c 756d  in divs_df.colum
+00002570: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00002580: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00002590: 6c75 6545 7272 6f72 2866 2241 6464 4469  lueError(f"AddDi
+000025a0: 7669 6465 6e64 7328 2920 2764 6976 735f  vidends() 'divs_
+000025b0: 6466 2720 6973 206d 6973 7369 6e67 2063  df' is missing c
+000025c0: 6f6c 756d 6e3a 2027 7b63 7d27 2229 0a0a  olumn: '{c}'")..
+000025d0: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
+000025e0: 6570 6172 6520 2764 6976 735f 6466 2720  epare 'divs_df' 
+000025f0: 666f 7220 6170 7065 6e64 0a20 2020 2020  for append.     
+00002600: 2020 2020 2020 2064 6976 735f 6466 5b22         divs_df["
+00002610: 4261 636b 2041 646a 2e22 5d20 3d20 6e70  Back Adj."] = np
+00002620: 2e6e 616e 0a20 2020 2020 2020 2020 2020  .nan.           
+00002630: 2064 6976 735f 6466 5b22 5375 7065 7273   divs_df["Supers
+00002640: 6564 6564 2064 6976 225d 203d 2030 2e30  eded div"] = 0.0
+00002650: 0a20 2020 2020 2020 2020 2020 2064 6976  .            div
+00002660: 735f 6466 5b22 5375 7065 7273 6564 6564  s_df["Superseded
+00002670: 2062 6163 6b20 6164 6a2e 225d 203d 2030   back adj."] = 0
+00002680: 2e30 0a20 2020 2020 2020 2020 2020 2064  .0.            d
+00002690: 6976 735f 6466 5b22 5375 7065 7273 6564  ivs_df["Supersed
+000026a0: 6564 2064 6976 2046 6574 6368 4461 7465  ed div FetchDate
+000026b0: 225d 203d 2070 642e 4e61 540a 2020 2020  "] = pd.NaT.    
+000026c0: 2020 2020 2020 2020 6469 7673 5f64 665f          divs_df_
+000026d0: 6474 7320 3d20 6469 7673 5f64 662e 696e  dts = divs_df.in
+000026e0: 6465 782e 636f 7079 2829 0a20 2020 2020  dex.copy().     
+000026f0: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+00002700: 2064 6976 735f 6466 5f64 7473 3a0a 2020   divs_df_dts:.  
+00002710: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00002720: 775f 6469 7620 3d20 6469 7673 5f64 662e  w_div = divs_df.
+00002730: 6c6f 635b 6474 2c20 2244 6976 6964 656e  loc[dt, "Dividen
+00002740: 6473 225d 0a0a 2020 2020 2020 2020 2020  ds"]..          
+00002750: 2020 2020 2020 636c 6f73 655f 6265 666f        close_befo
+00002760: 7265 203d 2064 6976 735f 6466 2e6c 6f63  re = divs_df.loc
+00002770: 5b64 742c 2022 436c 6f73 6520 6461 7920  [dt, "Close day 
+00002780: 6265 666f 7265 225d 0a20 2020 2020 2020  before"].       
+00002790: 2020 2020 2020 2020 2023 2061 646a 203d           # adj =
+000027a0: 2028 636c 6f73 655f 6265 666f 7265 202d   (close_before -
+000027b0: 206e 6577 5f64 6976 2920 2f20 636c 6f73   new_div) / clos
+000027c0: 655f 6265 666f 7265 0a20 2020 2020 2020  e_before.       
+000027d0: 2020 2020 2020 2020 2061 646a 203d 2031           adj = 1
+000027e0: 2e30 202d 206e 6577 5f64 6976 202f 2063  .0 - new_div / c
+000027f0: 6c6f 7365 5f62 6566 6f72 650a 2020 2020  lose_before.    
+00002800: 2020 2020 2020 2020 2020 2020 2320 2320              # # 
+00002810: 4620 3d20 5032 2f28 5032 2b44 290a 2020  F = P2/(P2+D).  
+00002820: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00002830: 2320 6874 7470 3a2f 2f6d 6172 7562 6f7a  # http://maruboz
+00002840: 752e 626c 6f67 7370 6f74 2e63 6f6d 2f32  u.blogspot.com/2
+00002850: 3030 362f 3039 2f68 6f77 2d79 6168 6f6f  006/09/how-yahoo
+00002860: 2d63 616c 6375 6c61 7465 732d 6164 6a75  -calculates-adju
+00002870: 7374 6564 2d63 6c6f 7369 6e67 2e68 746d  sted-closing.htm
+00002880: 6c23 6338 3033 3830 3634 3937 3531 3835  l#c8038064975185
+00002890: 3730 3838 3536 0a20 2020 2020 2020 2020  708856.         
+000028a0: 2020 2020 2020 2023 2063 6c6f 7365 5f74         # close_t
+000028b0: 6f64 6179 203d 2064 6976 735f 6466 2e6c  oday = divs_df.l
+000028c0: 6f63 5b64 742c 2022 436c 6f73 6520 746f  oc[dt, "Close to
+000028d0: 6461 7922 5d0a 2020 2020 2020 2020 2020  day"].          
+000028e0: 2020 2020 2020 2320 6164 6a20 3d20 636c        # adj = cl
+000028f0: 6f73 655f 746f 6461 7920 2f20 2863 6c6f  ose_today / (clo
+00002900: 7365 5f74 6f64 6179 202b 206e 6577 5f64  se_today + new_d
+00002910: 6976 290a 2020 2020 2020 2020 2020 2020  iv).            
+00002920: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00002930: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002940: 6e70 2e69 736e 616e 2861 646a 293a 2020  np.isnan(adj):  
+00002950: 2320 746f 646f 3a20 7265 6d6f 7665 206f  # todo: remove o
+00002960: 6e63 6520 636f 6e66 6972 6d20 5946 4320  nce confirm YFC 
+00002970: 6275 672d 6672 6565 0a20 2020 2020 2020  bug-free.       
+00002980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002990: 2070 7269 6e74 2864 6976 735f 6466 2e6c   print(divs_df.l
+000029a0: 6f63 5b64 745d 290a 2020 2020 2020 2020  oc[dt]).        
 000029b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029c0: 6665 7463 685f 6474 203d 2064 6976 735f  fetch_dt = divs_
-000029d0: 6466 2e6c 6f63 5b64 742c 2022 4665 7463  df.loc[dt, "Fetc
-000029e0: 6844 6174 6522 5d0a 2020 2020 2020 2020  hDate"].        
-000029f0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00002a00: 3d20 6622 6e65 7720 6469 7669 6465 6e64  = f"new dividend
-00002a10: 3a20 7b6e 6577 5f64 6976 7d20 4020 7b64  : {new_div} @ {d
-00002a20: 742e 6461 7465 2829 7d20 6164 6a3d 7b61  t.date()} adj={a
-00002a30: 646a 3a2e 3566 7d20 636c 6f73 655f 6265  dj:.5f} close_be
-00002a40: 666f 7265 3d7b 636c 6f73 655f 6265 666f  fore={close_befo
-00002a50: 7265 3a2e 3466 7d20 6665 7463 683d 7b66  re:.4f} fetch={f
-00002a60: 6574 6368 5f64 742e 7374 7266 7469 6d65  etch_dt.strftime
-00002a70: 2827 2559 2d25 6d2d 2564 2025 483a 254d  ('%Y-%m-%d %H:%M
-00002a80: 3a25 5325 7a27 297d 220a 2020 2020 2020  :%S%z')}".      
-00002a90: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00002aa0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-00002ab0: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-00002ac0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-00002ad0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-00002ae0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-00002af0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00002b00: 2020 2064 6976 735f 6466 2e6c 6f63 5b64     divs_df.loc[d
-00002b10: 742c 2022 4261 636b 2041 646a 2e22 5d20  t, "Back Adj."] 
-00002b20: 3d20 6164 6a0a 0a20 2020 2020 2020 2020  = adj..         
-00002b30: 2020 2020 2020 2069 6620 7365 6c66 2e64         if self.d
-00002b40: 6976 7320 6973 206e 6f74 204e 6f6e 6520  ivs is not None 
-00002b50: 616e 6420 6474 2069 6e20 7365 6c66 2e64  and dt in self.d
-00002b60: 6976 732e 696e 6465 783a 0a20 2020 2020  ivs.index:.     
-00002b70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00002b80: 2052 6570 6c61 6365 6420 6361 6368 6564   Replaced cached
-00002b90: 2064 6976 6964 656e 6420 6576 656e 7420   dividend event 
-00002ba0: 6966 2028 6929 2064 6976 6964 656e 6420  if (i) dividend 
-00002bb0: 6469 6666 6572 656e 7420 6f72 2028 6969  different or (ii
-00002bc0: 2920 6164 6a20 6469 6666 6572 656e 742e  ) adj different.
-00002bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002be0: 2020 2020 2063 6163 6865 645f 6469 7620       cached_div 
-00002bf0: 3d20 7365 6c66 2e64 6976 732e 6c6f 635b  = self.divs.loc[
-00002c00: 6474 2c20 2244 6976 6964 656e 6473 225d  dt, "Dividends"]
-00002c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c20: 2020 2020 2063 6163 6865 645f 6164 6a20       cached_adj 
-00002c30: 3d20 7365 6c66 2e64 6976 732e 6c6f 635b  = self.divs.loc[
-00002c40: 6474 2c20 2242 6163 6b20 4164 6a2e 225d  dt, "Back Adj."]
-00002c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c60: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
-00002c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c80: 2020 2020 2020 206d 7367 203d 2066 2270         msg = f"p
-00002c90: 7265 2d65 7869 7374 696e 6720 6469 7669  re-existing divi
-00002ca0: 6465 6e64 2040 207b 6474 7d3a 207b 6361  dend @ {dt}: {ca
-00002cb0: 6368 6564 5f64 6976 7d20 7673 207b 6e65  ched_div} vs {ne
-00002cc0: 775f 6469 767d 220a 2020 2020 2020 2020  w_div}".        
-00002cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ce0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00002cf0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00002d00: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-00002d10: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
-00002d20: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
-00002d30: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00002d40: 2020 2020 2020 2020 2064 6966 665f 7063           diff_pc
-00002d50: 7420 3d20 3130 302a 6162 7328 6361 6368  t = 100*abs(cach
-00002d60: 6564 5f64 6976 2d6e 6577 5f64 6976 292f  ed_div-new_div)/
-00002d70: 6361 6368 6564 5f64 6976 0a20 2020 2020  cached_div.     
-00002d80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002d90: 6966 665f 7063 7432 203d 2031 3030 2a61  iff_pct2 = 100*a
-00002da0: 6273 2863 6163 6865 645f 6164 6a2d 6164  bs(cached_adj-ad
-00002db0: 6a29 2f63 6163 6865 645f 6164 6a0a 2020  j)/cached_adj.  
-00002dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002dd0: 2020 6469 6666 5f70 6374 203d 206d 6178    diff_pct = max
-00002de0: 2864 6966 665f 7063 742c 2064 6966 665f  (diff_pct, diff_
-00002df0: 7063 7432 290a 2020 2020 2020 2020 2020  pct2).          
-00002e00: 2020 2020 2020 2020 2020 6966 2064 6966            if dif
-00002e10: 665f 7063 7420 3c20 302e 3031 3a0a 2020  f_pct < 0.01:.  
-00002e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e30: 2020 2020 2020 2320 7469 6e79 2064 6966        # tiny dif
-00002e40: 6665 7265 6e63 652c 2065 6173 6965 7220  ference, easier 
-00002e50: 746f 206a 7573 7420 6b65 6570 206f 6c64  to just keep old
-00002e60: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-00002e70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002e80: 6976 735f 6466 203d 2064 6976 735f 6466  ivs_df = divs_df
-00002e90: 2e64 726f 7028 6474 290a 2020 2020 2020  .drop(dt).      
-00002ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002eb0: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
-00002ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ed0: 2020 2020 2020 2020 6d73 6720 3d20 2269          msg = "i
-00002ee0: 676e 6f72 696e 6720 6e65 7720 6469 7622  gnoring new div"
-00002ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002f00: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00002f10: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-00002f20: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-00002f30: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-00002f40: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
-00002f50: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
-00002f60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002f70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00002f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002f90: 2020 2020 6469 7673 5f64 662e 6c6f 635b      divs_df.loc[
-00002fa0: 6474 2c20 2253 7570 6572 7365 6465 6420  dt, "Superseded 
-00002fb0: 6469 7622 5d20 3d20 7365 6c66 2e64 6976  div"] = self.div
-00002fc0: 732e 6c6f 635b 6474 2c20 2244 6976 6964  s.loc[dt, "Divid
-00002fd0: 656e 6473 225d 0a20 2020 2020 2020 2020  ends"].         
-00002fe0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002ff0: 6976 735f 6466 2e6c 6f63 5b64 742c 2022  ivs_df.loc[dt, "
-00003000: 5375 7065 7273 6564 6564 2062 6163 6b20  Superseded back 
-00003010: 6164 6a2e 225d 203d 2073 656c 662e 6469  adj."] = self.di
-00003020: 7673 2e6c 6f63 5b64 742c 2022 4261 636b  vs.loc[dt, "Back
-00003030: 2041 646a 2e22 5d0a 2020 2020 2020 2020   Adj."].        
-00003040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003050: 6469 7673 5f64 662e 6c6f 635b 6474 2c20  divs_df.loc[dt, 
-00003060: 2253 7570 6572 7365 6465 6420 6469 7620  "Superseded div 
-00003070: 4665 7463 6844 6174 6522 5d20 3d20 7365  FetchDate"] = se
-00003080: 6c66 2e64 6976 732e 6c6f 635b 6474 2c20  lf.divs.loc[dt, 
-00003090: 2246 6574 6368 4461 7465 225d 0a20 2020  "FetchDate"].   
-000030a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000030b0: 2020 2020 2073 656c 662e 6469 7673 203d       self.divs =
-000030c0: 2073 656c 662e 6469 7673 2e64 726f 7028   self.divs.drop(
-000030d0: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-000030e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000030f0: 5f64 6976 735f 6d6f 6469 6669 6564 203d  _divs_modified =
-00003100: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00003110: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00003120: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-00003130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003140: 2020 2020 6d73 6720 3d20 2272 6570 6c61      msg = "repla
-00003150: 6369 6e67 206f 6c64 2064 6976 220a 2020  cing old div".  
-00003160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003170: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00003180: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
-00003190: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-000031a0: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
-000031b0: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
-000031c0: 6b65 727d 3a20 2220 2b20 6d73 6729 0a0a  ker}: " + msg)..
-000031d0: 2020 2020 2020 2020 2020 2020 6469 7673              divs
-000031e0: 5f64 6620 3d20 6469 7673 5f64 662e 6472  _df = divs_df.dr
-000031f0: 6f70 2822 436c 6f73 6520 6461 7920 6265  op("Close day be
-00003200: 666f 7265 222c 2061 7869 733d 3129 0a20  fore", axis=1). 
-00003210: 2020 2020 2020 2020 2020 2063 6f6c 7320             cols 
-00003220: 3d20 5b22 4469 7669 6465 6e64 7322 2c20  = ["Dividends", 
-00003230: 2242 6163 6b20 4164 6a2e 222c 2022 4665  "Back Adj.", "Fe
-00003240: 7463 6844 6174 6522 2c20 2253 7570 6572  tchDate", "Super
-00003250: 7365 6465 6420 6469 7622 2c20 2253 7570  seded div", "Sup
-00003260: 6572 7365 6465 6420 6261 636b 2061 646a  erseded back adj
-00003270: 2e22 2c20 2253 7570 6572 7365 6465 6420  .", "Superseded 
-00003280: 6469 7620 4665 7463 6844 6174 6522 5d0a  div FetchDate"].
-00003290: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000032a0: 6f74 2064 6976 735f 6466 2e65 6d70 7479  ot divs_df.empty
-000032b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000032c0: 2020 6469 7673 5f70 7265 7474 7920 3d20    divs_pretty = 
-000032d0: 6469 7673 5f64 665b 2244 6976 6964 656e  divs_df["Dividen
-000032e0: 6473 225d 0a20 2020 2020 2020 2020 2020  ds"].           
-000032f0: 2020 2020 2064 6976 735f 7072 6574 7479       divs_pretty
-00003300: 2e69 6e64 6578 203d 2064 6976 735f 7072  .index = divs_pr
-00003310: 6574 7479 2e69 6e64 6578 2e64 6174 652e  etty.index.date.
-00003320: 6173 7479 7065 2873 7472 290a 2020 2020  astype(str).    
-00003330: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00003340: 2e6d 616e 6167 6572 2e4c 6f67 4576 656e  .manager.LogEven
-00003350: 7428 2269 6e66 6f22 2c20 2244 6976 6964  t("info", "Divid
-00003360: 656e 644d 616e 6167 6572 222c 2066 227b  endManager", f"{
-00003370: 6469 7673 5f70 7265 7474 792e 7368 6170  divs_pretty.shap
-00003380: 655b 305d 7d20 6e65 7720 6469 7669 6465  e[0]} new divide
-00003390: 6e64 733a 207b 6469 7673 5f70 7265 7474  nds: {divs_prett
-000033a0: 792e 746f 5f64 6963 7428 297d 2229 0a0a  y.to_dict()}")..
-000033b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000033c0: 6966 2073 656c 662e 6469 7673 2069 7320  if self.divs is 
-000033d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000033e0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-000033f0: 6976 7320 3d20 6469 7673 5f64 665b 636f  ivs = divs_df[co
-00003400: 6c73 5d2e 636f 7079 2829 0a20 2020 2020  ls].copy().     
-00003410: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00003420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003430: 2020 2020 2073 656c 662e 6469 7673 203d       self.divs =
-00003440: 2070 642e 636f 6e63 6174 285b 7365 6c66   pd.concat([self
-00003450: 2e64 6976 732c 2064 6976 735f 6466 5b63  .divs, divs_df[c
-00003460: 6f6c 735d 5d2c 2073 6f72 743d 5472 7565  ols]], sort=True
-00003470: 292e 736f 7274 5f69 6e64 6578 2829 0a20  ).sort_index(). 
-00003480: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00003490: 6663 6d2e 5374 6f72 6543 6163 6865 4461  fcm.StoreCacheDa
-000034a0: 7475 6d28 7365 6c66 2e74 6963 6b65 722c  tum(self.ticker,
-000034b0: 2022 6469 7669 6465 6e64 7322 2c20 7365   "dividends", se
-000034c0: 6c66 2e64 6976 7329 0a20 2020 2020 2020  lf.divs).       
-000034d0: 2020 2020 2065 6c69 6620 7365 6c66 5f64       elif self_d
-000034e0: 6976 735f 6d6f 6469 6669 6564 3a0a 2020  ivs_modified:.  
-000034f0: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00003500: 636d 2e53 746f 7265 4361 6368 6544 6174  cm.StoreCacheDat
-00003510: 756d 2873 656c 662e 7469 636b 6572 2c20  um(self.ticker, 
-00003520: 2264 6976 6964 656e 6473 222c 2073 656c  "dividends", sel
-00003530: 662e 6469 7673 290a 0a20 2020 2020 2020  f.divs)..       
-00003540: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
-00003550: 2255 7064 6174 6544 6976 6964 656e 6473  "UpdateDividends
-00003560: 2829 2072 6574 7572 6e69 6e67 2229 0a0a  () returning")..
-00003570: 0a63 6c61 7373 2050 7269 6365 4869 7374  .class PriceHist
-00003580: 6f72 793a 0a20 2020 2064 6566 205f 5f69  ory:.    def __i
-00003590: 6e69 745f 5f28 7365 6c66 2c20 6d61 6e61  nit__(self, mana
-000035a0: 6765 722c 2074 6963 6b65 722c 2065 7863  ger, ticker, exc
-000035b0: 6861 6e67 652c 2074 7a4e 616d 652c 2069  hange, tzName, i
-000035c0: 6e74 6572 7661 6c2c 2073 6573 7369 6f6e  nterval, session
-000035d0: 2c20 7072 6f78 792c 2072 6570 6169 723d  , proxy, repair=
-000035e0: 5472 7565 2c20 636f 6e74 6967 756f 7573  True, contiguous
-000035f0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00003600: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-00003610: 6e74 6572 7661 6c2c 2073 7472 293a 0a20  nterval, str):. 
-00003620: 2020 2020 2020 2020 2020 2069 6620 696e             if in
-00003630: 7465 7276 616c 206e 6f74 2069 6e20 7966  terval not in yf
-00003640: 6364 2e69 6e74 6572 7661 6c53 7472 546f  cd.intervalStrTo
-00003650: 456e 756d 2e6b 6579 7328 293a 0a20 2020  Enum.keys():.   
-00003660: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00003670: 7365 2045 7863 6570 7469 6f6e 2822 2769  se Exception("'i
-00003680: 6e74 6572 7661 6c27 2069 6620 7374 7220  nterval' if str 
-00003690: 6d75 7374 2062 6520 6f6e 6520 6f66 3a20  must be one of: 
-000036a0: 7b7d 222e 666f 726d 6174 2879 6663 642e  {}".format(yfcd.
-000036b0: 696e 7465 7276 616c 5374 7254 6f45 6e75  intervalStrToEnu
-000036c0: 6d2e 6b65 7973 2829 2929 0a20 2020 2020  m.keys())).     
-000036d0: 2020 2020 2020 2069 6e74 6572 7661 6c20         interval 
-000036e0: 3d20 7966 6364 2e69 6e74 6572 7661 6c53  = yfcd.intervalS
-000036f0: 7472 546f 456e 756d 5b69 6e74 6572 7661  trToEnum[interva
-00003700: 6c5d 0a20 2020 2020 2020 2079 6663 752e  l].        yfcu.
-00003710: 5479 7065 4368 6563 6b53 7472 2874 6963  TypeCheckStr(tic
-00003720: 6b65 722c 2022 7469 636b 6572 2229 0a20  ker, "ticker"). 
-00003730: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
-00003740: 4368 6563 6b53 7472 2865 7863 6861 6e67  CheckStr(exchang
-00003750: 652c 2022 6578 6368 616e 6765 2229 0a20  e, "exchange"). 
-00003760: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
-00003770: 4368 6563 6b53 7472 2874 7a4e 616d 652c  CheckStr(tzName,
-00003780: 2022 747a 4e61 6d65 2229 0a20 2020 2020   "tzName").     
-00003790: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
-000037a0: 6b42 6f6f 6c28 7265 7061 6972 2c20 2272  kBool(repair, "r
-000037b0: 6570 6169 7222 290a 2020 2020 2020 2020  epair").        
-000037c0: 7966 6375 2e54 7970 6543 6865 636b 426f  yfcu.TypeCheckBo
-000037d0: 6f6c 2863 6f6e 7469 6775 6f75 732c 2022  ol(contiguous, "
-000037e0: 636f 6e74 6967 756f 7573 2229 0a0a 2020  contiguous")..  
-000037f0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-00003800: 6572 203d 206d 616e 6167 6572 0a20 2020  er = manager.   
-00003810: 2020 2020 2073 656c 662e 7469 636b 6572       self.ticker
-00003820: 203d 2074 6963 6b65 720a 2020 2020 2020   = ticker.      
-00003830: 2020 7365 6c66 2e65 7863 6861 6e67 6520    self.exchange 
-00003840: 3d20 6578 6368 616e 6765 0a20 2020 2020  = exchange.     
-00003850: 2020 2073 656c 662e 747a 4e61 6d65 203d     self.tzName =
-00003860: 2074 7a4e 616d 650a 2020 2020 2020 2020   tzName.        
-00003870: 7365 6c66 2e69 6e74 6572 7661 6c20 3d20  self.interval = 
-00003880: 696e 7465 7276 616c 0a20 2020 2020 2020  interval.       
-00003890: 2073 656c 662e 7365 7373 696f 6e20 3d20   self.session = 
-000038a0: 7365 7373 696f 6e0a 2020 2020 2020 2020  session.        
-000038b0: 7365 6c66 2e70 726f 7879 203d 2070 726f  self.proxy = pro
-000038c0: 7879 0a20 2020 2020 2020 2073 656c 662e  xy.        self.
-000038d0: 7265 7061 6972 203d 2072 6570 6169 720a  repair = repair.
-000038e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-000038f0: 7469 6775 6f75 7320 3d20 636f 6e74 6967  tiguous = contig
-00003900: 756f 7573 0a0a 2020 2020 2020 2020 7365  uous..        se
-00003910: 6c66 2e64 6174 203d 2079 662e 5469 636b  lf.dat = yf.Tick
-00003920: 6572 2873 656c 662e 7469 636b 6572 2c20  er(self.ticker, 
-00003930: 7365 7373 696f 6e3d 7365 6c66 2e73 6573  session=self.ses
-00003940: 7369 6f6e 290a 2020 2020 2020 2020 7365  sion).        se
-00003950: 6c66 2e74 7a20 3d20 5a6f 6e65 496e 666f  lf.tz = ZoneInfo
-00003960: 2873 656c 662e 747a 4e61 6d65 290a 0a20  (self.tzName).. 
-00003970: 2020 2020 2020 2073 656c 662e 6974 6420         self.itd 
-00003980: 3d20 7966 6364 2e69 6e74 6572 7661 6c54  = yfcd.intervalT
-00003990: 6f54 696d 6564 656c 7461 5b73 656c 662e  oTimedelta[self.
-000039a0: 696e 7465 7276 616c 5d0a 2020 2020 2020  interval].      
-000039b0: 2020 7365 6c66 2e69 7374 7220 3d20 7966    self.istr = yf
-000039c0: 6364 2e69 6e74 6572 7661 6c54 6f53 7472  cd.intervalToStr
-000039d0: 696e 675b 7365 6c66 2e69 6e74 6572 7661  ing[self.interva
-000039e0: 6c5d 0a20 2020 2020 2020 2073 656c 662e  l].        self.
-000039f0: 696e 7465 7264 6179 203d 2073 656c 662e  interday = self.
-00003a00: 696e 7465 7276 616c 2069 6e20 5b79 6663  interval in [yfc
-00003a10: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
-00003a20: 2c20 7966 6364 2e49 6e74 6572 7661 6c2e  , yfcd.Interval.
-00003a30: 5765 656b 2c20 7966 6364 2e49 6e74 6572  Week, yfcd.Inter
-00003a40: 7661 6c2e 4d6f 6e74 6873 312c 2079 6663  val.Months1, yfc
-00003a50: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
-00003a60: 7333 5d0a 2020 2020 2020 2020 7365 6c66  s3].        self
-00003a70: 2e69 6e74 7261 6461 7920 3d20 6e6f 7420  .intraday = not 
-00003a80: 7365 6c66 2e69 6e74 6572 6461 790a 2020  self.interday.  
-00003a90: 2020 2020 2020 7365 6c66 2e6d 756c 7469        self.multi
-00003aa0: 6461 7920 3d20 7365 6c66 2e69 6e74 6572  day = self.inter
-00003ab0: 6461 7920 616e 6420 7365 6c66 2e69 6e74  day and self.int
-00003ac0: 6572 7661 6c20 213d 2079 6663 642e 496e  erval != yfcd.In
-00003ad0: 7465 7276 616c 2e44 6179 7331 0a0a 2020  terval.Days1..  
-00003ae0: 2020 2020 2020 2320 4c6f 6164 2066 726f        # Load fro
-00003af0: 6d20 6361 6368 650a 2020 2020 2020 2020  m cache.        
-00003b00: 7365 6c66 2e63 6163 6865 5f6b 6579 203d  self.cache_key =
-00003b10: 2022 6869 7374 6f72 792d 222b 7365 6c66   "history-"+self
-00003b20: 2e69 7374 720a 2020 2020 2020 2020 7365  .istr.        se
-00003b30: 6c66 2e68 203d 2073 656c 662e 5f67 6574  lf.h = self._get
-00003b40: 4361 6368 6564 5072 6963 6573 2829 0a20  CachedPrices(). 
-00003b50: 2020 2020 2020 2073 656c 662e 5f72 6576         self._rev
-00003b60: 6965 774e 6577 4469 7673 2829 0a0a 2020  iewNewDivs()..  
-00003b70: 2020 2020 2020 2320 4120 706c 6163 6520        # A place 
-00003b80: 746f 2074 656d 706f 7261 7269 6c79 2073  to temporarily s
-00003b90: 746f 7265 206e 6577 2064 6976 6964 656e  tore new dividen
-00003ba0: 6473 2c20 756e 7469 6c20 7072 6963 6573  ds, until prices
-00003bb0: 2068 6176 650a 2020 2020 2020 2020 2320   have.        # 
-00003bc0: 6265 656e 2072 6570 6169 7265 642c 2074  been repaired, t
-00003bd0: 6865 6e20 7468 6579 2063 616e 2062 6520  hen they can be 
-00003be0: 7365 6e74 2074 6f20 4576 656e 7473 4869  sent to EventsHi
-00003bf0: 7374 6f72 790a 0a20 2020 2020 2020 2073  story..        s
-00003c00: 656c 662e 5f64 6562 7567 203d 2046 616c  elf._debug = Fal
-00003c10: 7365 0a20 2020 2020 2020 2023 2073 656c  se.        # sel
-00003c20: 662e 5f64 6562 7567 203d 2054 7275 650a  f._debug = True.
-00003c30: 0a20 2020 2020 2020 2023 204d 616e 6167  .        # Manag
-00003c40: 6520 706f 7465 6e74 6961 6c20 666f 7220  e potential for 
-00003c50: 696e 6669 6e69 7465 2072 6563 7572 7369  infinite recursi
-00003c60: 6f6e 2064 7572 696e 6720 7072 6963 6520  on during price 
-00003c70: 7265 7061 6972 3a0a 2020 2020 2020 2020  repair:.        
-00003c80: 7365 6c66 2e5f 7265 636f 7264 5f73 7461  self._record_sta
-00003c90: 636b 5f74 7261 6365 203d 2054 7275 650a  ck_trace = True.
-00003ca0: 2020 2020 2020 2020 2320 7365 6c66 2e5f          # self._
-00003cb0: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
-00003cc0: 6365 203d 2046 616c 7365 0a20 2020 2020  ce = False.     
-00003cd0: 2020 2073 656c 662e 5f73 7461 636b 5f74     self._stack_t
-00003ce0: 7261 6365 203d 205b 5d0a 2020 2020 2020  race = [].      
-00003cf0: 2020 7365 6c66 2e5f 696e 6669 6e69 7465    self._infinite
-00003d00: 5f72 6563 7572 7369 6f6e 5f64 6574 6563  _recursion_detec
-00003d10: 7465 6420 3d20 4661 6c73 650a 0a20 2020  ted = False..   
-00003d20: 2064 6566 205f 6765 7443 6163 6865 6450   def _getCachedP
-00003d30: 7269 6365 7328 7365 6c66 293a 0a20 2020  rices(self):.   
-00003d40: 2020 2020 2068 203d 204e 6f6e 650a 2020       h = None.  
-00003d50: 2020 2020 2020 6966 2079 6663 6d2e 4973        if yfcm.Is
-00003d60: 4461 7475 6d43 6163 6865 6428 7365 6c66  DatumCached(self
-00003d70: 2e74 6963 6b65 722c 2073 656c 662e 6361  .ticker, self.ca
-00003d80: 6368 655f 6b65 7929 3a0a 2020 2020 2020  che_key):.      
-00003d90: 2020 2020 2020 6820 3d20 7966 636d 2e52        h = yfcm.R
-00003da0: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
-00003db0: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-00003dc0: 6361 6368 655f 6b65 7929 0a0a 2020 2020  cache_key)..    
-00003dd0: 2020 2020 6966 2068 2069 7320 6e6f 7420      if h is not 
-00003de0: 4e6f 6e65 2061 6e64 2068 2e65 6d70 7479  None and h.empty
-00003df0: 3a0a 2020 2020 2020 2020 2020 2020 6820  :.            h 
-00003e00: 3d20 4e6f 6e65 0a20 2020 2020 2020 2065  = None.        e
-00003e10: 6c69 6620 6820 6973 206e 6f74 204e 6f6e  lif h is not Non
-00003e20: 653a 0a20 2020 2020 2020 2020 2020 2068  e:.            h
-00003e30: 5f6d 6f64 6966 6965 6420 3d20 4661 6c73  _modified = Fals
-00003e40: 650a 0a20 2020 2020 2020 2020 2020 2023  e..            #
-00003e50: 2068 203d 2079 6663 752e 4375 7374 6f6d   h = yfcu.Custom
-00003e60: 4e61 6e43 6865 636b 696e 6744 6174 6146  NanCheckingDataF
-00003e70: 7261 6d65 2868 290a 0a20 2020 2020 2020  rame(h)..       
-00003e80: 2020 2020 2069 6620 2241 646a 2043 6c6f       if "Adj Clo
-00003e90: 7365 2220 696e 2068 2e63 6f6c 756d 6e73  se" in h.columns
-00003ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003eb0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00003ec0: 6e28 2241 646a 2043 6c6f 7365 2069 6e20  n("Adj Close in 
-00003ed0: 6361 6368 6564 2068 2229 0a0a 2020 2020  cached h")..    
-00003ee0: 2020 2020 2020 2020 665f 6475 7073 203d          f_dups =
-00003ef0: 2068 2e69 6e64 6578 2e64 7570 6c69 6361   h.index.duplica
-00003f00: 7465 6428 290a 2020 2020 2020 2020 2020  ted().          
-00003f10: 2020 6966 2066 5f64 7570 732e 616e 7928    if f_dups.any(
-00003f20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00003f30: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00003f40: 6f6e 2822 7b7d 3a20 5468 6573 6520 7469  on("{}: These ti
-00003f50: 6d65 706f 696e 7473 2068 6176 6520 6265  mepoints have be
-00003f60: 656e 2064 7570 6c69 6361 7465 643a 207b  en duplicated: {
-00003f70: 7d22 2e66 6f72 6d61 7428 7365 6c66 2e74  }".format(self.t
-00003f80: 6963 6b65 722c 2068 2e69 6e64 6578 5b66  icker, h.index[f
-00003f90: 5f64 7570 735d 2929 0a0a 2020 2020 2020  _dups]))..      
-00003fa0: 2020 2020 2020 665f 6e61 203d 206e 702e        f_na = np.
-00003fb0: 6973 6e61 6e28 685b 2243 4446 225d 2e74  isnan(h["CDF"].t
-00003fc0: 6f5f 6e75 6d70 7928 2929 0a20 2020 2020  o_numpy()).     
-00003fd0: 2020 2020 2020 2069 6620 665f 6e61 2e61         if f_na.a
-00003fe0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00003ff0: 2020 2020 2020 685b 2243 4446 225d 203d        h["CDF"] =
-00004000: 2068 5b22 4344 4622 5d2e 6669 6c6c 6e61   h["CDF"].fillna
-00004010: 286d 6574 686f 643d 2262 6669 6c6c 2229  (method="bfill")
-00004020: 2e66 696c 6c6e 6128 6d65 7468 6f64 3d22  .fillna(method="
-00004030: 6666 696c 6c22 290a 2020 2020 2020 2020  ffill").        
-00004040: 2020 2020 2020 2020 665f 6e61 203d 2068          f_na = h
-00004050: 5b22 4344 4622 5d2e 6973 6e61 2829 0a20  ["CDF"].isna(). 
-00004060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004070: 6620 665f 6e61 2e61 6e79 2829 3a0a 2020  f f_na.any():.  
-00004080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004090: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-000040a0: 6e28 2243 4446 204e 614e 2072 6570 6169  n("CDF NaN repai
-000040b0: 7220 6661 696c 6564 2229 0a20 2020 2020  r failed").     
-000040c0: 2020 2020 2020 2020 2020 2068 5f6d 6f64             h_mod
-000040d0: 6966 6965 6420 3d20 5472 7565 0a0a 2020  ified = True..  
-000040e0: 2020 2020 2020 2020 2020 6966 2068 5f6d            if h_m
-000040f0: 6f64 6966 6965 643a 0a20 2020 2020 2020  odified:.       
-00004100: 2020 2020 2020 2020 2079 6663 6d2e 5374           yfcm.St
-00004110: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
-00004120: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-00004130: 6361 6368 655f 6b65 792c 2068 290a 0a20  cache_key, h).. 
-00004140: 2020 2020 2020 2072 6574 7572 6e20 680a         return h.
-00004150: 0a20 2020 2064 6566 205f 7570 6461 7465  .    def _update
-00004160: 6443 6163 6865 6450 7269 6365 7328 7365  dCachedPrices(se
-00004170: 6c66 2c20 6466 293a 0a20 2020 2020 2020  lf, df):.       
-00004180: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
-00004190: 6174 6146 7261 6d65 2864 662c 2022 6466  ataFrame(df, "df
-000041a0: 2229 0a0a 2020 2020 2020 2020 6578 7065  ")..        expe
-000041b0: 6374 6564 5f63 6f6c 7320 3d20 5b22 4f70  cted_cols = ["Op
-000041c0: 656e 222c 2022 4869 6768 222c 2022 4c6f  en", "High", "Lo
-000041d0: 7722 2c20 2243 6c6f 7365 222c 2022 566f  w", "Close", "Vo
-000041e0: 6c75 6d65 222c 2022 4469 7669 6465 6e64  lume", "Dividend
-000041f0: 7322 2c20 2253 746f 636b 2053 706c 6974  s", "Stock Split
-00004200: 7322 5d0a 2020 2020 2020 2020 6578 7065  s"].        expe
-00004210: 6374 6564 5f63 6f6c 7320 2b3d 205b 2246  cted_cols += ["F
-00004220: 696e 616c 3f22 2c20 2243 2d43 6865 636b  inal?", "C-Check
-00004230: 3f22 2c20 2246 6574 6368 4461 7465 222c  ?", "FetchDate",
-00004240: 2022 4353 4622 2c20 2243 4446 225d 0a20   "CSF", "CDF"]. 
-00004250: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00004260: 636f 6c73 202b 3d20 5b22 4c61 7374 4469  cols += ["LastDi
-00004270: 7641 646a 7573 7444 7422 2c20 224c 6173  vAdjustDt", "Las
-00004280: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
-00004290: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
-000042a0: 675f 636f 6c73 203d 205b 6320 666f 7220  g_cols = [c for 
-000042b0: 6320 696e 2065 7870 6563 7465 645f 636f  c in expected_co
-000042c0: 6c73 2069 6620 6320 6e6f 7420 696e 2064  ls if c not in d
-000042d0: 662e 636f 6c75 6d6e 735d 0a20 2020 2020  f.columns].     
-000042e0: 2020 2069 6620 6c65 6e28 6d69 7373 696e     if len(missin
-000042f0: 675f 636f 6c73 2920 3e20 303a 0a20 2020  g_cols) > 0:.   
-00004300: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-00004310: 7863 6570 7469 6f6e 2866 2244 4620 6d69  xception(f"DF mi
-00004320: 7373 696e 6720 7468 6573 6520 636f 6c75  ssing these colu
-00004330: 6d6e 733a 207b 6d69 7373 696e 675f 636f  mns: {missing_co
-00004340: 6c73 7d22 290a 0a20 2020 2020 2020 2069  ls}")..        i
-00004350: 6620 6466 2e65 6d70 7479 3a0a 2020 2020  f df.empty:.    
-00004360: 2020 2020 2020 2020 6466 203d 204e 6f6e          df = Non
-00004370: 650a 2020 2020 2020 2020 7966 636d 2e53  e.        yfcm.S
-00004380: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
-00004390: 656c 662e 7469 636b 6572 2c20 7365 6c66  elf.ticker, self
-000043a0: 2e63 6163 6865 5f6b 6579 2c20 6466 290a  .cache_key, df).
-000043b0: 0a20 2020 2020 2020 2073 656c 662e 6820  .        self.h 
-000043c0: 3d20 6466 0a0a 2020 2020 6465 6620 5f72  = df..    def _r
-000043d0: 6576 6965 774e 6577 4469 7673 2873 656c  eviewNewDivs(sel
-000043e0: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
-000043f0: 656c 662e 696e 7465 7276 616c 2021 3d20  elf.interval != 
-00004400: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-00004410: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
-00004420: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-00004430: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
-00004440: 203d 2079 6663 6d2e 5265 6164 4361 6368   = yfcm.ReadCach
-00004450: 6544 6174 756d 2873 656c 662e 7469 636b  eDatum(self.tick
-00004460: 6572 2c20 226e 6577 5f64 6976 7322 290a  er, "new_divs").
-00004470: 2020 2020 2020 2020 6966 2063 6163 6865          if cache
-00004480: 645f 6e65 775f 6469 7673 2069 7320 6e6f  d_new_divs is no
-00004490: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000044a0: 2020 2020 6966 2079 6663 6d2e 5265 6164      if yfcm.Read
-000044b0: 4361 6368 654d 6574 6164 6174 6128 7365  CacheMetadata(se
-000044c0: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
-000044d0: 6469 7673 222c 2022 6c6f 636b 6564 2229  divs", "locked")
-000044e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000044f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00004500: 5468 6973 2069 7320 6261 642c 206d 6561  This is bad, mea
-00004510: 6e73 2059 4643 2077 6173 206b 696c 6c65  ns YFC was kille
-00004520: 6420 6265 666f 7265 2027 6e65 775f 6469  d before 'new_di
-00004530: 7673 2720 636f 756c 6420 6265 2070 726f  vs' could be pro
-00004540: 6365 7373 6564 2e0a 2020 2020 2020 2020  cessed..        
-00004550: 2020 2020 2020 2020 2320 4d65 616e 7320          # Means 
-00004560: 706f 7465 6e74 6961 6c6c 7920 6675 7475  potentially futu
-00004570: 7265 206e 6577 2064 6976 6964 656e 6473  re new dividends
-00004580: 2068 6176 6520 6e6f 7420 6265 656e 2070   have not been p
-00004590: 726f 6365 7373 6564 0a20 2020 2020 2020  rocessed.       
-000045a0: 2020 2020 2020 2020 2068 5f64 6976 7320           h_divs 
-000045b0: 3d20 7365 6c66 2e68 2e6c 6f63 5b73 656c  = self.h.loc[sel
-000045c0: 662e 685b 2244 6976 6964 656e 6473 225d  f.h["Dividends"]
-000045d0: 213d 302c 205b 2244 6976 6964 656e 6473  !=0, ["Dividends
-000045e0: 222c 2022 4665 7463 6844 6174 6522 5d5d  ", "FetchDate"]]
-000045f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004600: 2068 5f64 6976 735f 7369 6e63 6520 3d20   h_divs_since = 
-00004610: 685f 6469 7673 5b68 5f64 6976 732e 696e  h_divs[h_divs.in
-00004620: 6465 7820 3e20 6361 6368 6564 5f6e 6577  dex > cached_new
-00004630: 5f64 6976 732e 696e 6465 782e 6d61 7828  _divs.index.max(
-00004640: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
-00004650: 2020 2069 6620 6e6f 7420 685f 6469 7673     if not h_divs
-00004660: 5f73 696e 6365 2e65 6d70 7479 3a0a 2020  _since.empty:.  
-00004670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004680: 2020 6361 6368 6564 5f6e 6577 5f64 6976    cached_new_div
-00004690: 7320 3d20 7064 2e63 6f6e 6361 7428 5b63  s = pd.concat([c
-000046a0: 6163 6865 645f 6e65 775f 6469 7673 2c20  ached_new_divs, 
-000046b0: 685f 6469 7673 5f73 696e 6365 5d29 0a20  h_divs_since]). 
-000046c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046d0: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-000046e0: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-000046f0: 6b65 722c 2022 6e65 775f 6469 7673 222c  ker, "new_divs",
-00004700: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
-00004710: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00004720: 2020 7966 636d 2e57 7269 7465 4361 6368    yfcm.WriteCach
-00004730: 654d 6574 6164 6174 6128 7365 6c66 2e74  eMetadata(self.t
-00004740: 6963 6b65 722c 2022 6e65 775f 6469 7673  icker, "new_divs
-00004750: 222c 2022 6c6f 636b 6564 222c 204e 6f6e  ", "locked", Non
-00004760: 6529 0a0a 2020 2020 6465 6620 6765 7428  e)..    def get(
-00004770: 7365 6c66 2c20 7374 6172 743d 4e6f 6e65  self, start=None
-00004780: 2c20 656e 643d 4e6f 6e65 2c20 7065 7269  , end=None, peri
-00004790: 6f64 3d4e 6f6e 652c 206d 6178 5f61 6765  od=None, max_age
-000047a0: 3d4e 6f6e 652c 2074 7269 6767 6572 5f61  =None, trigger_a
-000047b0: 745f 6d61 726b 6574 5f63 6c6f 7365 3d46  t_market_close=F
-000047c0: 616c 7365 2c20 7265 7061 6972 3d54 7275  alse, repair=Tru
-000047d0: 652c 2070 7265 706f 7374 3d46 616c 7365  e, prepost=False
-000047e0: 2c20 6164 6a75 7374 5f73 706c 6974 733d  , adjust_splits=
-000047f0: 4661 6c73 652c 2061 646a 7573 745f 6469  False, adjust_di
-00004800: 7673 3d46 616c 7365 2c20 7175 6965 743d  vs=False, quiet=
-00004810: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-00004820: 6966 2073 7461 7274 2069 7320 4e6f 6e65  if start is None
-00004830: 2061 6e64 2065 6e64 2069 7320 4e6f 6e65   and end is None
-00004840: 2061 6e64 2070 6572 696f 6420 6973 204e   and period is N
-00004850: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00004860: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00004870: 7228 224d 7573 7420 7072 6f76 6964 6520  r("Must provide 
-00004880: 7661 6c75 6520 666f 7220 6f6e 6520 6f66  value for one of
-00004890: 3a20 2773 7461 7274 272c 2027 656e 6427  : 'start', 'end'
-000048a0: 2c20 2770 6572 696f 6427 2229 0a20 2020  , 'period'").   
-000048b0: 2020 2020 2069 6620 7374 6172 7420 6973       if start is
-000048c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000048d0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
-000048e0: 4368 6563 6b49 6e74 6572 7661 6c44 7428  CheckIntervalDt(
-000048f0: 7374 6172 742c 2073 656c 662e 696e 7465  start, self.inte
-00004900: 7276 616c 2c20 2273 7461 7274 222c 2073  rval, "start", s
-00004910: 7472 6963 743d 4661 6c73 6529 0a20 2020  trict=False).   
-00004920: 2020 2020 2069 6620 656e 6420 6973 206e       if end is n
-00004930: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00004940: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00004950: 6563 6b49 6e74 6572 7661 6c44 7428 656e  eckIntervalDt(en
-00004960: 642c 2073 656c 662e 696e 7465 7276 616c  d, self.interval
-00004970: 2c20 2265 6e64 222c 2073 7472 6963 743d  , "end", strict=
-00004980: 4661 6c73 6529 0a20 2020 2020 2020 2069  False).        i
-00004990: 6620 7065 7269 6f64 2069 7320 6e6f 7420  f period is not 
-000049a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000049b0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-000049c0: 5065 7269 6f64 2870 6572 696f 642c 2022  Period(period, "
-000049d0: 7065 7269 6f64 2229 0a20 2020 2020 2020  period").       
-000049e0: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
-000049f0: 6f6f 6c28 7472 6967 6765 725f 6174 5f6d  ool(trigger_at_m
-00004a00: 6172 6b65 745f 636c 6f73 652c 2022 7472  arket_close, "tr
-00004a10: 6967 6765 725f 6174 5f6d 6172 6b65 745f  igger_at_market_
-00004a20: 636c 6f73 6522 290a 2020 2020 2020 2020  close").        
-00004a30: 7966 6375 2e54 7970 6543 6865 636b 426f  yfcu.TypeCheckBo
-00004a40: 6f6c 2872 6570 6169 722c 2022 7265 7061  ol(repair, "repa
-00004a50: 6972 2229 0a20 2020 2020 2020 2079 6663  ir").        yfc
-00004a60: 752e 5479 7065 4368 6563 6b42 6f6f 6c28  u.TypeCheckBool(
-00004a70: 6164 6a75 7374 5f73 706c 6974 732c 2022  adjust_splits, "
-00004a80: 6164 6a75 7374 5f73 706c 6974 7322 290a  adjust_splits").
-00004a90: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00004aa0: 6543 6865 636b 426f 6f6c 2861 646a 7573  eCheckBool(adjus
-00004ab0: 745f 6469 7673 2c20 2261 646a 7573 745f  t_divs, "adjust_
-00004ac0: 6469 7673 2229 0a0a 2020 2020 2020 2020  divs")..        
-00004ad0: 2320 544f 444f 3a20 656e 666f 7263 6520  # TODO: enforce 
-00004ae0: 276d 6178 5f61 6765 2720 7661 6c75 6520  'max_age' value 
-00004af0: 7072 6f76 6964 6564 2e20 4f6e 6c79 2027  provided. Only '
-00004b00: 4e6f 6e65 2720 7768 696c 6520 4920 6465  None' while I de
-00004b10: 760a 2020 2020 2020 2020 6966 206d 6178  v.        if max
-00004b20: 5f61 6765 2069 7320 4e6f 6e65 3a0a 2020  _age is None:.  
-00004b30: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00004b40: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-00004b50: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
-00004b60: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00004b70: 2020 206d 6178 5f61 6765 203d 2074 696d     max_age = tim
-00004b80: 6564 656c 7461 2868 6f75 7273 3d34 290a  edelta(hours=4).
-00004b90: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00004ba0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-00004bb0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-00004bc0: 5765 656b 3a0a 2020 2020 2020 2020 2020  Week:.          
-00004bd0: 2020 2020 2020 6d61 785f 6167 6520 3d20        max_age = 
-00004be0: 7469 6d65 6465 6c74 6128 686f 7572 733d  timedelta(hours=
-00004bf0: 3630 290a 2020 2020 2020 2020 2020 2020  60).            
-00004c00: 656c 6966 2073 656c 662e 696e 7465 7276  elif self.interv
-00004c10: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-00004c20: 7661 6c2e 4d6f 6e74 6873 313a 0a20 2020  val.Months1:.   
-00004c30: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00004c40: 5f61 6765 203d 2074 696d 6564 656c 7461  _age = timedelta
-00004c50: 2864 6179 733d 3135 290a 2020 2020 2020  (days=15).      
-00004c60: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-00004c70: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-00004c80: 2e49 6e74 6572 7661 6c2e 4d6f 6e74 6873  .Interval.Months
-00004c90: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-00004ca0: 2020 206d 6178 5f61 6765 203d 2074 696d     max_age = tim
-00004cb0: 6564 656c 7461 2864 6179 733d 3435 290a  edelta(days=45).
-00004cc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004cd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004ce0: 2020 6d61 785f 6167 6520 3d20 302e 352a    max_age = 0.5*
-00004cf0: 7966 6364 2e69 6e74 6572 7661 6c54 6f54  yfcd.intervalToT
-00004d00: 696d 6564 656c 7461 5b73 656c 662e 696e  imedelta[self.in
-00004d10: 7465 7276 616c 5d0a 0a20 2020 2020 2020  terval]..       
-00004d20: 2023 2059 4643 2063 616e 6e6f 7420 6861   # YFC cannot ha
-00004d30: 6e64 6c65 2070 7265 2d20 616e 6420 706f  ndle pre- and po
-00004d40: 7374 2d6d 6172 6b65 7420 696e 7472 6164  st-market intrad
-00004d50: 6179 0a20 2020 2020 2020 2070 7265 706f  ay.        prepo
-00004d60: 7374 203d 2073 656c 662e 696e 7465 7264  st = self.interd
-00004d70: 6179 0a0a 2020 2020 2020 2020 7966 6374  ay..        yfct
-00004d80: 2e53 6574 4578 6368 616e 6765 547a 4e61  .SetExchangeTzNa
-00004d90: 6d65 2873 656c 662e 6578 6368 616e 6765  me(self.exchange
-00004da0: 2c20 7365 6c66 2e74 7a4e 616d 6529 0a20  , self.tzName). 
-00004db0: 2020 2020 2020 2074 645f 3164 203d 2074         td_1d = t
-00004dc0: 696d 6564 656c 7461 2864 6179 733d 3129  imedelta(days=1)
-00004dd0: 0a20 2020 2020 2020 2074 7a5f 6578 6368  .        tz_exch
-00004de0: 616e 6765 203d 205a 6f6e 6549 6e66 6f28  ange = ZoneInfo(
-00004df0: 7365 6c66 2e74 7a4e 616d 6529 0a20 2020  self.tzName).   
-00004e00: 2020 2020 2064 745f 6e6f 7720 3d20 7064       dt_now = pd
-00004e10: 2e54 696d 6573 7461 6d70 2e75 7463 6e6f  .Timestamp.utcno
-00004e20: 7728 292e 747a 5f63 6f6e 7665 7274 2874  w().tz_convert(t
-00004e30: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
-00004e40: 2020 2020 645f 6e6f 775f 6578 6368 616e      d_now_exchan
-00004e50: 6765 203d 2064 745f 6e6f 772e 6461 7465  ge = dt_now.date
-00004e60: 2829 0a20 2020 2020 2020 2074 6f6d 6f72  ().        tomor
-00004e70: 726f 775f 6420 3d20 645f 6e6f 775f 6578  row_d = d_now_ex
-00004e80: 6368 616e 6765 202b 2074 645f 3164 0a20  change + td_1d. 
-00004e90: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00004ea0: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
-00004eb0: 2020 2020 2074 6f6d 6f72 726f 7720 3d20       tomorrow = 
-00004ec0: 746f 6d6f 7272 6f77 5f64 0a20 2020 2020  tomorrow_d.     
-00004ed0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004ee0: 2020 2020 2074 6f6d 6f72 726f 7720 3d20       tomorrow = 
-00004ef0: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
-00004f00: 2874 6f6d 6f72 726f 775f 642c 2074 696d  (tomorrow_d, tim
-00004f10: 6528 3029 2c20 747a 5f65 7863 6861 6e67  e(0), tz_exchang
-00004f20: 6529 0a20 2020 2020 2020 2069 6620 7374  e).        if st
-00004f30: 6172 7420 6973 206e 6f74 204e 6f6e 653a  art is not None:
-00004f40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00004f50: 656e 6420 6973 206e 6f74 204e 6f6e 6520  end is not None 
-00004f60: 616e 6420 7374 6172 7420 3e3d 2065 6e64  and start >= end
-00004f70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004f80: 2020 2320 7261 6973 6520 5661 6c75 6545    # raise ValueE
-00004f90: 7272 6f72 2866 2273 7461 7274 3d7b 7374  rror(f"start={st
-00004fa0: 6172 747d 206d 7573 7420 3c20 656e 643d  art} must < end=
-00004fb0: 7b65 6e64 7d22 290a 2020 2020 2020 2020  {end}").        
-00004fc0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00004fd0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00004fe0: 2320 6966 2028 7365 6c66 2e69 6e74 6572  # if (self.inter
-00004ff0: 6461 7920 616e 6420 7374 6172 7420 3e3d  day and start >=
-00005000: 2074 6f6d 6f72 726f 7729 206f 7220 286e   tomorrow) or (n
-00005010: 6f74 2073 656c 662e 696e 7465 7264 6179  ot self.interday
-00005020: 2061 6e64 2073 7461 7274 203e 2064 745f   and start > dt_
-00005030: 6e6f 7729 3a0a 2020 2020 2020 2020 2020  now):.          
-00005040: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00005050: 7374 6172 742c 2064 6174 6574 696d 6529  start, datetime)
-00005060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005070: 2020 6966 2073 7461 7274 203e 2064 745f    if start > dt_
-00005080: 6e6f 773a 0a20 2020 2020 2020 2020 2020  now:.           
-00005090: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000050a0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000050b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000050c0: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
-000050d0: 3e3d 2074 6f6d 6f72 726f 775f 643a 0a20  >= tomorrow_d:. 
-000050e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050f0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00005100: 2020 2020 2020 2020 6465 6275 675f 7966          debug_yf
-00005110: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00005120: 2064 6562 7567 5f79 6663 203d 2073 656c   debug_yfc = sel
-00005130: 662e 5f64 6562 7567 0a20 2020 2020 2020  f._debug.       
-00005140: 2023 2064 6562 7567 5f79 6663 203d 2054   # debug_yfc = T
-00005150: 7275 650a 0a20 2020 2020 2020 2069 6620  rue..        if 
-00005160: 7065 7269 6f64 2069 7320 6e6f 7420 4e6f  period is not No
-00005170: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00005180: 6c6f 675f 6d73 6720 3d20 6622 5072 6963  log_msg = f"Pric
-00005190: 6548 6973 746f 7279 2d7b 7365 6c66 2e69  eHistory-{self.i
-000051a0: 7374 727d 2e67 6574 2874 6b72 3d7b 7365  str}.get(tkr={se
-000051b0: 6c66 2e74 6963 6b65 727d 2c20 7065 7269  lf.ticker}, peri
-000051c0: 6f64 3d7b 7065 7269 6f64 7d2c 206d 6178  od={period}, max
-000051d0: 5f61 6765 3d7b 6d61 785f 6167 657d 2c20  _age={max_age}, 
-000051e0: 7472 6967 6765 725f 6174 5f6d 6172 6b65  trigger_at_marke
-000051f0: 745f 636c 6f73 653d 7b74 7269 6767 6572  t_close={trigger
-00005200: 5f61 745f 6d61 726b 6574 5f63 6c6f 7365  _at_market_close
-00005210: 7d2c 2070 7265 706f 7374 3d7b 7072 6570  }, prepost={prep
-00005220: 6f73 747d 2c20 7265 7061 6972 3d7b 7265  ost}, repair={re
-00005230: 7061 6972 7d29 220a 2020 2020 2020 2020  pair})".        
-00005240: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005250: 2020 6c6f 675f 6d73 6720 3d20 6622 5072    log_msg = f"Pr
-00005260: 6963 6548 6973 746f 7279 2d7b 7365 6c66  iceHistory-{self
-00005270: 2e69 7374 727d 2e67 6574 2874 6b72 3d7b  .istr}.get(tkr={
-00005280: 7365 6c66 2e74 6963 6b65 727d 2c20 7374  self.ticker}, st
-00005290: 6172 743d 7b73 7461 7274 7d2c 2065 6e64  art={start}, end
-000052a0: 3d7b 656e 647d 2c20 6d61 785f 6167 653d  ={end}, max_age=
-000052b0: 7b6d 6178 5f61 6765 7d2c 2074 7269 6767  {max_age}, trigg
-000052c0: 6572 5f61 745f 6d61 726b 6574 5f63 6c6f  er_at_market_clo
-000052d0: 7365 3d7b 7472 6967 6765 725f 6174 5f6d  se={trigger_at_m
-000052e0: 6172 6b65 745f 636c 6f73 657d 2c20 7072  arket_close}, pr
-000052f0: 6570 6f73 743d 7b70 7265 706f 7374 7d2c  epost={prepost},
-00005300: 2072 6570 6169 723d 7b72 6570 6169 727d   repair={repair}
-00005310: 2922 0a20 2020 2020 2020 2069 6620 7966  )".        if yf
-00005320: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00005330: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-00005340: 2020 2079 6663 6c2e 5472 6163 6545 6e74     yfcl.TraceEnt
-00005350: 6572 286c 6f67 5f6d 7367 290a 2020 2020  er(log_msg).    
-00005360: 2020 2020 656c 6966 2064 6562 7567 5f79      elif debug_y
-00005370: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-00005380: 7072 696e 7428 6c6f 675f 6d73 6729 0a0a  print(log_msg)..
-00005390: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
-000053a0: 706c 794e 6577 4576 656e 7473 2829 0a0a  plyNewEvents()..
-000053b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000053c0: 2020 2020 2020 2020 2079 665f 6c61 6720           yf_lag 
-000053d0: 3d20 7966 6364 2e65 7863 6861 6e67 6554  = yfcd.exchangeT
-000053e0: 6f59 664c 6167 5b73 656c 662e 6578 6368  oYfLag[self.exch
-000053f0: 616e 6765 5d0a 2020 2020 2020 2020 6578  ange].        ex
-00005400: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00005410: 2020 7072 696e 7428 6622 2d20 7469 636b    print(f"- tick
-00005420: 6572 203d 207b 7365 6c66 2e74 6963 6b65  er = {self.ticke
-00005430: 727d 2229 0a20 2020 2020 2020 2020 2020  r}").           
-00005440: 2072 6169 7365 0a0a 2020 2020 2020 2020   raise..        
-00005450: 7073 7472 203d 204e 6f6e 650a 2020 2020  pstr = None.    
-00005460: 2020 2020 656e 645f 6420 3d20 4e6f 6e65      end_d = None
-00005470: 203b 2065 6e64 5f64 7420 3d20 4e6f 6e65   ; end_dt = None
-00005480: 0a20 2020 2020 2020 2069 6620 7065 7269  .        if peri
-00005490: 6f64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  od is not None:.
-000054a0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000054b0: 745f 642c 2065 6e64 5f64 203d 2079 6663  t_d, end_d = yfc
-000054c0: 742e 4d61 7050 6572 696f 6454 6f44 6174  t.MapPeriodToDat
-000054d0: 6573 2873 656c 662e 6578 6368 616e 6765  es(self.exchange
-000054e0: 2c20 7065 7269 6f64 2c20 7365 6c66 2e69  , period, self.i
-000054f0: 6e74 6572 7661 6c29 0a20 2020 2020 2020  nterval).       
-00005500: 2020 2020 2070 6572 696f 6420 3d20 4e6f       period = No
-00005510: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
-00005520: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
-00005530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005540: 2073 7461 7274 203d 2073 7461 7274 5f64   start = start_d
-00005550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005560: 2065 6e64 203d 2065 6e64 5f64 0a20 2020   end = end_d.   
-00005570: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00005580: 7274 5f64 7420 3d20 6461 7465 7469 6d65  rt_dt = datetime
-00005590: 2e63 6f6d 6269 6e65 2873 7461 7274 5f64  .combine(start_d
-000055a0: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
-000055b0: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
-000055c0: 2020 2020 2020 2020 656e 645f 6474 203d          end_dt =
-000055d0: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
-000055e0: 6528 656e 645f 642c 2074 696d 6528 3029  e(end_d, time(0)
-000055f0: 2c20 747a 5f65 7863 6861 6e67 6529 0a20  , tz_exchange). 
-00005600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00005610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005620: 2073 7461 7274 203d 2064 6174 6574 696d   start = datetim
-00005630: 652e 636f 6d62 696e 6528 7374 6172 745f  e.combine(start_
-00005640: 642c 2074 696d 6528 3029 2c20 747a 5f65  d, time(0), tz_e
-00005650: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00005660: 2020 2020 2020 2020 2065 6e64 203d 204e           end = N
-00005670: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00005680: 2020 2020 7374 6172 745f 6474 203d 2073      start_dt = s
-00005690: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
-000056a0: 2020 2020 2065 6e64 5f64 7420 3d20 4e6f       end_dt = No
-000056b0: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
-000056c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000056d0: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-000056e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000056f0: 7461 7274 5f64 7420 3d20 6461 7465 7469  tart_dt = dateti
-00005700: 6d65 2e63 6f6d 6269 6e65 2873 7461 7274  me.combine(start
-00005710: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
-00005720: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
-00005730: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00005740: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00005750: 6e73 7461 6e63 6528 7374 6172 742c 2064  nstance(start, d
-00005760: 6174 6574 696d 6529 3a0a 2020 2020 2020  atetime):.      
-00005770: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00005780: 6172 745f 6474 203d 2073 7461 7274 0a20  art_dt = start. 
-00005790: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000057a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000057b0: 2020 2020 2020 2020 2073 7461 7274 5f64           start_d
-000057c0: 7420 3d20 6461 7465 7469 6d65 2e63 6f6d  t = datetime.com
-000057d0: 6269 6e65 2873 7461 7274 2c20 7469 6d65  bine(start, time
-000057e0: 2830 292c 2074 7a5f 6578 6368 616e 6765  (0), tz_exchange
-000057f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00005800: 2020 2020 2020 7374 6172 7420 3d20 7374        start = st
-00005810: 6172 745f 6474 0a0a 2020 2020 2020 2020  art_dt..        
-00005820: 6966 2065 6e64 2069 7320 4e6f 6e65 2061  if end is None a
-00005830: 6e64 2070 7374 7220 6973 204e 6f6e 653a  nd pstr is None:
-00005840: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005850: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-00005860: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00005870: 6e64 203d 2064 5f6e 6f77 5f65 7863 6861  nd = d_now_excha
-00005880: 6e67 652b 7464 5f31 640a 2020 2020 2020  nge+td_1d.      
-00005890: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000058a0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-000058b0: 6420 3d20 7966 6374 2e47 6574 4578 6368  d = yfct.GetExch
-000058c0: 616e 6765 5363 6865 6475 6c65 2873 656c  angeSchedule(sel
-000058d0: 662e 6578 6368 616e 6765 2c20 645f 6e6f  f.exchange, d_no
-000058e0: 775f 6578 6368 616e 6765 2c20 645f 6e6f  w_exchange, d_no
-000058f0: 775f 6578 6368 616e 6765 2b74 645f 3164  w_exchange+td_1d
-00005900: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00005910: 2020 6966 2073 6368 6564 2069 7320 4e6f    if sched is No
-00005920: 6e65 206f 7220 2864 745f 6e6f 7720 2b20  ne or (dt_now + 
-00005930: 7966 5f6c 6167 2920 3c20 7363 6865 645b  yf_lag) < sched[
-00005940: 226f 7065 6e22 5d2e 696c 6f63 5b30 5d3a  "open"].iloc[0]:
-00005950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005960: 2020 2020 2023 2042 6566 6f72 6520 6d61       # Before ma
-00005970: 726b 6574 206f 7065 6e0a 2020 2020 2020  rket open.      
+000029c0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+000029d0: 2242 6163 6b20 4164 6a2e 2069 7320 4e61  "Back Adj. is Na
+000029e0: 4e22 290a 2020 2020 2020 2020 2020 2020  N").            
+000029f0: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00002a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a10: 7072 696e 7428 2264 743d 222c 2064 7429  print("dt=", dt)
+00002a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002a30: 2020 2020 2070 7269 6e74 2822 543d 222c       print("T=",
+00002a40: 2073 656c 662e 7469 636b 6572 290a 2020   self.ticker).  
+00002a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a60: 2020 7072 696e 7428 2264 6976 735f 6466    print("divs_df
+00002a70: 3a22 2920 3b20 7072 696e 7428 6469 7673  :") ; print(divs
+00002a80: 5f64 6629 0a20 2020 2020 2020 2020 2020  _df).           
+00002a90: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
+00002aa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00002ab0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+00002ac0: 2020 2020 2020 2020 2020 2020 2066 6574               fet
+00002ad0: 6368 5f64 7420 3d20 6469 7673 5f64 662e  ch_dt = divs_df.
+00002ae0: 6c6f 635b 6474 2c20 2246 6574 6368 4461  loc[dt, "FetchDa
+00002af0: 7465 225d 0a20 2020 2020 2020 2020 2020  te"].           
+00002b00: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+00002b10: 226e 6577 2064 6976 6964 656e 643a 207b  "new dividend: {
+00002b20: 6e65 775f 6469 767d 2040 207b 6474 2e64  new_div} @ {dt.d
+00002b30: 6174 6528 297d 2061 646a 3d7b 6164 6a3a  ate()} adj={adj:
+00002b40: 2e35 667d 2063 6c6f 7365 5f62 6566 6f72  .5f} close_befor
+00002b50: 653d 7b63 6c6f 7365 5f62 6566 6f72 653a  e={close_before:
+00002b60: 2e34 667d 2066 6574 6368 3d7b 6665 7463  .4f} fetch={fetc
+00002b70: 685f 6474 2e73 7472 6674 696d 6528 2725  h_dt.strftime('%
+00002b80: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+00002b90: 257a 2729 7d22 0a20 2020 2020 2020 2020  %z')}".         
+00002ba0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+00002bb0: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
+00002bc0: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+00002bd0: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
+00002be0: 7072 696e 7428 6622 7b73 656c 662e 7469  print(f"{self.ti
+00002bf0: 636b 6572 7d3a 2022 202b 206d 7367 290a  cker}: " + msg).
+00002c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c10: 6469 7673 5f64 662e 6c6f 635b 6474 2c20  divs_df.loc[dt, 
+00002c20: 2242 6163 6b20 4164 6a2e 225d 203d 2061  "Back Adj."] = a
+00002c30: 646a 0a0a 2020 2020 2020 2020 2020 2020  dj..            
+00002c40: 2020 2020 6966 2073 656c 662e 6469 7673      if self.divs
+00002c50: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00002c60: 2064 7420 696e 2073 656c 662e 6469 7673   dt in self.divs
+00002c70: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
+00002c80: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00002c90: 706c 6163 6564 2063 6163 6865 6420 6469  placed cached di
+00002ca0: 7669 6465 6e64 2065 7665 6e74 2069 6620  vidend event if 
+00002cb0: 2869 2920 6469 7669 6465 6e64 2064 6966  (i) dividend dif
+00002cc0: 6665 7265 6e74 206f 7220 2869 6929 2061  ferent or (ii) a
+00002cd0: 646a 2064 6966 6665 7265 6e74 2e0a 2020  dj different..  
+00002ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002cf0: 2020 6361 6368 6564 5f64 6976 203d 2073    cached_div = s
+00002d00: 656c 662e 6469 7673 2e6c 6f63 5b64 742c  elf.divs.loc[dt,
+00002d10: 2022 4469 7669 6465 6e64 7322 5d0a 2020   "Dividends"].  
+00002d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d30: 2020 6361 6368 6564 5f61 646a 203d 2073    cached_adj = s
+00002d40: 656c 662e 6469 7673 2e6c 6f63 5b64 742c  elf.divs.loc[dt,
+00002d50: 2022 4261 636b 2041 646a 2e22 5d0a 2020   "Back Adj."].  
+00002d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d70: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
+00002d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d90: 2020 2020 6d73 6720 3d20 6622 7072 652d      msg = f"pre-
+00002da0: 6578 6973 7469 6e67 2064 6976 6964 656e  existing dividen
+00002db0: 6420 4020 7b64 747d 3a20 7b63 6163 6865  d @ {dt}: {cache
+00002dc0: 645f 6469 767d 2076 7320 7b6e 6577 5f64  d_div} vs {new_d
+00002dd0: 6976 7d22 0a20 2020 2020 2020 2020 2020  iv}".           
+00002de0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00002df0: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00002e00: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00002e10: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00002e20: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
+00002e30: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
+00002e40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00002e50: 2020 2020 2020 6469 6666 5f70 6374 203d        diff_pct =
+00002e60: 2031 3030 2a61 6273 2863 6163 6865 645f   100*abs(cached_
+00002e70: 6469 762d 6e65 775f 6469 7629 2f63 6163  div-new_div)/cac
+00002e80: 6865 645f 6469 760a 2020 2020 2020 2020  hed_div.        
+00002e90: 2020 2020 2020 2020 2020 2020 6469 6666              diff
+00002ea0: 5f70 6374 3220 3d20 3130 302a 6162 7328  _pct2 = 100*abs(
+00002eb0: 6361 6368 6564 5f61 646a 2d61 646a 292f  cached_adj-adj)/
+00002ec0: 6361 6368 6564 5f61 646a 0a20 2020 2020  cached_adj.     
+00002ed0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00002ee0: 6966 665f 7063 7420 3d20 6d61 7828 6469  iff_pct = max(di
+00002ef0: 6666 5f70 6374 2c20 6469 6666 5f70 6374  ff_pct, diff_pct
+00002f00: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
+00002f10: 2020 2020 2020 2069 6620 6469 6666 5f70         if diff_p
+00002f20: 6374 203c 2030 2e30 313a 0a20 2020 2020  ct < 0.01:.     
+00002f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002f40: 2020 2023 2074 696e 7920 6469 6666 6572     # tiny differ
+00002f50: 656e 6365 2c20 6561 7369 6572 2074 6f20  ence, easier to 
+00002f60: 6a75 7374 206b 6565 7020 6f6c 6420 7661  just keep old va
+00002f70: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00002f80: 2020 2020 2020 2020 2020 2020 6469 7673              divs
+00002f90: 5f64 6620 3d20 6469 7673 5f64 662e 6472  _df = divs_df.dr
+00002fa0: 6f70 2864 7429 0a20 2020 2020 2020 2020  op(dt).         
+00002fb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00002fc0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fe0: 2020 2020 206d 7367 203d 2022 6967 6e6f       msg = "igno
+00002ff0: 7269 6e67 206e 6577 2064 6976 220a 2020  ring new div".  
+00003000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003010: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00003020: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
+00003030: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+00003040: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
+00003050: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
+00003060: 6b65 727d 3a20 2220 2b20 6d73 6729 0a20  ker}: " + msg). 
+00003070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003080: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000030a0: 2064 6976 735f 6466 2e6c 6f63 5b64 742c   divs_df.loc[dt,
+000030b0: 2022 5375 7065 7273 6564 6564 2064 6976   "Superseded div
+000030c0: 225d 203d 2073 656c 662e 6469 7673 2e6c  "] = self.divs.l
+000030d0: 6f63 5b64 742c 2022 4469 7669 6465 6e64  oc[dt, "Dividend
+000030e0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
+000030f0: 2020 2020 2020 2020 2020 2020 6469 7673              divs
+00003100: 5f64 662e 6c6f 635b 6474 2c20 2253 7570  _df.loc[dt, "Sup
+00003110: 6572 7365 6465 6420 6261 636b 2061 646a  erseded back adj
+00003120: 2e22 5d20 3d20 7365 6c66 2e64 6976 732e  ."] = self.divs.
+00003130: 6c6f 635b 6474 2c20 2242 6163 6b20 4164  loc[dt, "Back Ad
+00003140: 6a2e 225d 0a20 2020 2020 2020 2020 2020  j."].           
+00003150: 2020 2020 2020 2020 2020 2020 2064 6976               div
+00003160: 735f 6466 2e6c 6f63 5b64 742c 2022 5375  s_df.loc[dt, "Su
+00003170: 7065 7273 6564 6564 2064 6976 2046 6574  perseded div Fet
+00003180: 6368 4461 7465 225d 203d 2073 656c 662e  chDate"] = self.
+00003190: 6469 7673 2e6c 6f63 5b64 742c 2022 4665  divs.loc[dt, "Fe
+000031a0: 7463 6844 6174 6522 5d0a 2020 2020 2020  tchDate"].      
+000031b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000031c0: 2020 7365 6c66 2e64 6976 7320 3d20 7365    self.divs = se
+000031d0: 6c66 2e64 6976 732e 6472 6f70 2864 7429  lf.divs.drop(dt)
+000031e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000031f0: 2020 2020 2020 2020 2073 656c 665f 6469           self_di
+00003200: 7673 5f6d 6f64 6966 6965 6420 3d20 5472  vs_modified = Tr
+00003210: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00003220: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00003230: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+00003240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003250: 206d 7367 203d 2022 7265 706c 6163 696e   msg = "replacin
+00003260: 6720 6f6c 6420 6469 7622 0a20 2020 2020  g old div".     
+00003270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003280: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00003290: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+000032a0: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+000032b0: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+000032c0: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
+000032d0: 7d3a 2022 202b 206d 7367 290a 2020 2020  }: " + msg).    
+000032e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+000032f0: 206e 6577 5f64 6976 203d 3d20 302e 303a   new_div == 0.0:
+00003300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003310: 2020 2020 2023 2044 6973 6361 7264 2c20       # Discard, 
+00003320: 7761 7320 6f6e 6c79 2073 656e 7420 746f  was only sent to
+00003330: 2064 6570 7265 6361 7465 2070 7265 7669   deprecate previ
+00003340: 6f75 7320 6469 7669 6465 6e64 206f 6e20  ous dividend on 
+00003350: 7468 6973 2064 6174 650a 2020 2020 2020  this date.      
+00003360: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00003370: 7673 5f64 6620 3d20 6469 7673 5f64 662e  vs_df = divs_df.
+00003380: 6472 6f70 2864 7429 0a0a 2020 2020 2020  drop(dt)..      
+00003390: 2020 2020 2020 636f 6c73 203d 205b 2244        cols = ["D
+000033a0: 6976 6964 656e 6473 222c 2022 4261 636b  ividends", "Back
+000033b0: 2041 646a 2e22 2c20 2246 6574 6368 4461   Adj.", "FetchDa
+000033c0: 7465 222c 2022 5375 7065 7273 6564 6564  te", "Superseded
+000033d0: 2064 6976 222c 2022 5375 7065 7273 6564   div", "Supersed
+000033e0: 6564 2062 6163 6b20 6164 6a2e 222c 2022  ed back adj.", "
+000033f0: 5375 7065 7273 6564 6564 2064 6976 2046  Superseded div F
+00003400: 6574 6368 4461 7465 225d 0a20 2020 2020  etchDate"].     
+00003410: 2020 2020 2020 2069 6620 6e6f 7420 6469         if not di
+00003420: 7673 5f64 662e 656d 7074 793a 0a20 2020  vs_df.empty:.   
+00003430: 2020 2020 2020 2020 2020 2020 2064 6976               div
+00003440: 735f 7072 6574 7479 203d 2064 6976 735f  s_pretty = divs_
+00003450: 6466 5b5b 2244 6976 6964 656e 6473 222c  df[["Dividends",
+00003460: 2022 4261 636b 2041 646a 2e22 2c20 2243   "Back Adj.", "C
+00003470: 6c6f 7365 2064 6179 2062 6566 6f72 6522  lose day before"
+00003480: 5d5d 2e63 6f70 7928 290a 2020 2020 2020  ]].copy().      
+00003490: 2020 2020 2020 2020 2020 6469 7673 5f70            divs_p
+000034a0: 7265 7474 7920 3d20 6469 7673 5f70 7265  retty = divs_pre
+000034b0: 7474 792e 7265 6e61 6d65 2863 6f6c 756d  tty.rename(colum
+000034c0: 6e73 3d7b 2744 6976 6964 656e 6473 273a  ns={'Dividends':
+000034d0: 2744 6976 272c 2027 4261 636b 2041 646a  'Div', 'Back Adj
+000034e0: 2e27 3a27 4164 6a27 2c20 2743 6c6f 7365  .':'Adj', 'Close
+000034f0: 2064 6179 2062 6566 6f72 6527 3a27 436c   day before':'Cl
+00003500: 6f73 6527 7d29 0a20 2020 2020 2020 2020  ose'}).         
+00003510: 2020 2020 2020 2064 6976 735f 7072 6574         divs_pret
+00003520: 7479 5b27 4164 6a27 5d20 3d20 6469 7673  ty['Adj'] = divs
+00003530: 5f70 7265 7474 795b 2741 646a 275d 2e72  _pretty['Adj'].r
+00003540: 6f75 6e64 2833 290a 2020 2020 2020 2020  ound(3).        
+00003550: 2020 2020 2020 2020 6469 7673 5f70 7265          divs_pre
+00003560: 7474 795b 2743 6c6f 7365 275d 203d 2064  tty['Close'] = d
+00003570: 6976 735f 7072 6574 7479 5b27 436c 6f73  ivs_pretty['Clos
+00003580: 6527 5d2e 726f 756e 6428 3329 0a20 2020  e'].round(3).   
+00003590: 2020 2020 2020 2020 2020 2020 2064 6976               div
+000035a0: 735f 7072 6574 7479 2e69 6e64 6578 203d  s_pretty.index =
+000035b0: 2064 6976 735f 7072 6574 7479 2e69 6e64   divs_pretty.ind
+000035c0: 6578 2e64 6174 652e 6173 7479 7065 2873  ex.date.astype(s
+000035d0: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
+000035e0: 2020 2020 6e20 3d20 6469 7673 5f70 7265      n = divs_pre
+000035f0: 7474 792e 7368 6170 655b 305d 0a20 2020  tty.shape[0].   
+00003600: 2020 2020 2020 2020 2020 2020 206e 5f73               n_s
+00003610: 7570 203d 206e 702e 7375 6d28 2864 6976  up = np.sum((div
+00003620: 735f 6466 5b27 5375 7065 7273 6564 6564  s_df['Superseded
+00003630: 2064 6976 275d 3e30 2e30 292e 746f 5f6e   div']>0.0).to_n
+00003640: 756d 7079 2829 290a 2020 2020 2020 2020  umpy()).        
+00003650: 2020 2020 2020 2020 6e5f 6e65 7720 3d20          n_new = 
+00003660: 6e20 2d20 6e5f 7375 700a 2020 2020 2020  n - n_sup.      
+00003670: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00003680: 616e 6167 6572 2e4c 6f67 4576 656e 7428  anager.LogEvent(
+00003690: 2269 6e66 6f22 2c20 2244 6976 6964 656e  "info", "Dividen
+000036a0: 644d 616e 6167 6572 222c 2066 2273 746f  dManager", f"sto
+000036b0: 7265 6420 7b6e 7d20 6469 7669 6465 6e64  red {n} dividend
+000036c0: 7320 287b 6e5f 6e65 777d 206e 6577 2c20  s ({n_new} new, 
+000036d0: 7b6e 5f73 7570 7d20 7375 7065 7273 6564  {n_sup} supersed
+000036e0: 6564 293a 207b 6469 7673 5f70 7265 7474  ed): {divs_prett
+000036f0: 792e 746f 5f64 6963 7428 6f72 6965 6e74  y.to_dict(orient
+00003700: 3d27 696e 6465 7827 297d 2229 0a0a 2020  ='index')}")..  
+00003710: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00003720: 2073 656c 662e 6469 7673 2069 7320 4e6f   self.divs is No
+00003730: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00003740: 2020 2020 2020 2020 7365 6c66 2e64 6976          self.div
+00003750: 7320 3d20 6469 7673 5f64 665b 636f 6c73  s = divs_df[cols
+00003760: 5d2e 636f 7079 2829 0a20 2020 2020 2020  ].copy().       
+00003770: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00003780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003790: 2020 2073 656c 662e 6469 7673 203d 2070     self.divs = p
+000037a0: 642e 636f 6e63 6174 285b 7365 6c66 2e64  d.concat([self.d
+000037b0: 6976 732c 2064 6976 735f 6466 5b63 6f6c  ivs, divs_df[col
+000037c0: 735d 5d2c 2073 6f72 743d 5472 7565 292e  s]], sort=True).
+000037d0: 736f 7274 5f69 6e64 6578 2829 0a20 2020  sort_index().   
+000037e0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+000037f0: 6d2e 5374 6f72 6543 6163 6865 4461 7475  m.StoreCacheDatu
+00003800: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
+00003810: 6469 7669 6465 6e64 7322 2c20 7365 6c66  dividends", self
+00003820: 2e64 6976 7329 0a20 2020 2020 2020 2020  .divs).         
+00003830: 2020 2065 6c69 6620 7365 6c66 5f64 6976     elif self_div
+00003840: 735f 6d6f 6469 6669 6564 3a0a 2020 2020  s_modified:.    
+00003850: 2020 2020 2020 2020 2020 2020 7966 636d              yfcm
+00003860: 2e53 746f 7265 4361 6368 6544 6174 756d  .StoreCacheDatum
+00003870: 2873 656c 662e 7469 636b 6572 2c20 2264  (self.ticker, "d
+00003880: 6976 6964 656e 6473 222c 2073 656c 662e  ividends", self.
+00003890: 6469 7673 290a 0a20 2020 2020 2020 2079  divs)..        y
+000038a0: 6663 6c2e 5472 6163 6545 7869 7428 2255  fcl.TraceExit("U
+000038b0: 7064 6174 6544 6976 6964 656e 6473 2829  pdateDividends()
+000038c0: 2072 6574 7572 6e69 6e67 2229 0a0a 0a63   returning")...c
+000038d0: 6c61 7373 2050 7269 6365 4869 7374 6f72  lass PriceHistor
+000038e0: 793a 0a20 2020 2064 6566 205f 5f69 6e69  y:.    def __ini
+000038f0: 745f 5f28 7365 6c66 2c20 6d61 6e61 6765  t__(self, manage
+00003900: 722c 2074 6963 6b65 722c 2065 7863 6861  r, ticker, excha
+00003910: 6e67 652c 2074 7a4e 616d 652c 2069 6e74  nge, tzName, int
+00003920: 6572 7661 6c2c 2073 6573 7369 6f6e 2c20  erval, session, 
+00003930: 7072 6f78 792c 2072 6570 6169 723d 5472  proxy, repair=Tr
+00003940: 7565 2c20 636f 6e74 6967 756f 7573 3d46  ue, contiguous=F
+00003950: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
+00003960: 6620 6973 696e 7374 616e 6365 2869 6e74  f isinstance(int
+00003970: 6572 7661 6c2c 2073 7472 293a 0a20 2020  erval, str):.   
+00003980: 2020 2020 2020 2020 2069 6620 696e 7465           if inte
+00003990: 7276 616c 206e 6f74 2069 6e20 7966 6364  rval not in yfcd
+000039a0: 2e69 6e74 6572 7661 6c53 7472 546f 456e  .intervalStrToEn
+000039b0: 756d 2e6b 6579 7328 293a 0a20 2020 2020  um.keys():.     
+000039c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000039d0: 2045 7863 6570 7469 6f6e 2822 2769 6e74   Exception("'int
+000039e0: 6572 7661 6c27 2069 6620 7374 7220 6d75  erval' if str mu
+000039f0: 7374 2062 6520 6f6e 6520 6f66 3a20 7b7d  st be one of: {}
+00003a00: 222e 666f 726d 6174 2879 6663 642e 696e  ".format(yfcd.in
+00003a10: 7465 7276 616c 5374 7254 6f45 6e75 6d2e  tervalStrToEnum.
+00003a20: 6b65 7973 2829 2929 0a20 2020 2020 2020  keys())).       
+00003a30: 2020 2020 2069 6e74 6572 7661 6c20 3d20       interval = 
+00003a40: 7966 6364 2e69 6e74 6572 7661 6c53 7472  yfcd.intervalStr
+00003a50: 546f 456e 756d 5b69 6e74 6572 7661 6c5d  ToEnum[interval]
+00003a60: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
+00003a70: 7065 4368 6563 6b53 7472 2874 6963 6b65  peCheckStr(ticke
+00003a80: 722c 2022 7469 636b 6572 2229 0a20 2020  r, "ticker").   
+00003a90: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00003aa0: 6563 6b53 7472 2865 7863 6861 6e67 652c  eckStr(exchange,
+00003ab0: 2022 6578 6368 616e 6765 2229 0a20 2020   "exchange").   
+00003ac0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00003ad0: 6563 6b53 7472 2874 7a4e 616d 652c 2022  eckStr(tzName, "
+00003ae0: 747a 4e61 6d65 2229 0a20 2020 2020 2020  tzName").       
+00003af0: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
+00003b00: 6f6f 6c28 7265 7061 6972 2c20 2272 6570  ool(repair, "rep
+00003b10: 6169 7222 290a 2020 2020 2020 2020 7966  air").        yf
+00003b20: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
+00003b30: 2863 6f6e 7469 6775 6f75 732c 2022 636f  (contiguous, "co
+00003b40: 6e74 6967 756f 7573 2229 0a0a 2020 2020  ntiguous")..    
+00003b50: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
+00003b60: 203d 206d 616e 6167 6572 0a20 2020 2020   = manager.     
+00003b70: 2020 2073 656c 662e 7469 636b 6572 203d     self.ticker =
+00003b80: 2074 6963 6b65 720a 2020 2020 2020 2020   ticker.        
+00003b90: 7365 6c66 2e65 7863 6861 6e67 6520 3d20  self.exchange = 
+00003ba0: 6578 6368 616e 6765 0a20 2020 2020 2020  exchange.       
+00003bb0: 2073 656c 662e 747a 4e61 6d65 203d 2074   self.tzName = t
+00003bc0: 7a4e 616d 650a 2020 2020 2020 2020 7365  zName.        se
+00003bd0: 6c66 2e69 6e74 6572 7661 6c20 3d20 696e  lf.interval = in
+00003be0: 7465 7276 616c 0a20 2020 2020 2020 2073  terval.        s
+00003bf0: 656c 662e 7365 7373 696f 6e20 3d20 7365  elf.session = se
+00003c00: 7373 696f 6e0a 2020 2020 2020 2020 7365  ssion.        se
+00003c10: 6c66 2e70 726f 7879 203d 2070 726f 7879  lf.proxy = proxy
+00003c20: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00003c30: 7061 6972 203d 2072 6570 6169 720a 2020  pair = repair.  
+00003c40: 2020 2020 2020 7365 6c66 2e63 6f6e 7469        self.conti
+00003c50: 6775 6f75 7320 3d20 636f 6e74 6967 756f  guous = contiguo
+00003c60: 7573 0a0a 2020 2020 2020 2020 7365 6c66  us..        self
+00003c70: 2e64 6174 203d 2079 662e 5469 636b 6572  .dat = yf.Ticker
+00003c80: 2873 656c 662e 7469 636b 6572 2c20 7365  (self.ticker, se
+00003c90: 7373 696f 6e3d 7365 6c66 2e73 6573 7369  ssion=self.sessi
+00003ca0: 6f6e 290a 2020 2020 2020 2020 7365 6c66  on).        self
+00003cb0: 2e74 7a20 3d20 5a6f 6e65 496e 666f 2873  .tz = ZoneInfo(s
+00003cc0: 656c 662e 747a 4e61 6d65 290a 0a20 2020  elf.tzName)..   
+00003cd0: 2020 2020 2073 656c 662e 6974 6420 3d20       self.itd = 
+00003ce0: 7966 6364 2e69 6e74 6572 7661 6c54 6f54  yfcd.intervalToT
+00003cf0: 696d 6564 656c 7461 5b73 656c 662e 696e  imedelta[self.in
+00003d00: 7465 7276 616c 5d0a 2020 2020 2020 2020  terval].        
+00003d10: 7365 6c66 2e69 7374 7220 3d20 7966 6364  self.istr = yfcd
+00003d20: 2e69 6e74 6572 7661 6c54 6f53 7472 696e  .intervalToStrin
+00003d30: 675b 7365 6c66 2e69 6e74 6572 7661 6c5d  g[self.interval]
+00003d40: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+00003d50: 7465 7264 6179 203d 2073 656c 662e 696e  terday = self.in
+00003d60: 7465 7276 616c 2069 6e20 5b79 6663 642e  terval in [yfcd.
+00003d70: 496e 7465 7276 616c 2e44 6179 7331 2c20  Interval.Days1, 
+00003d80: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
+00003d90: 656b 5d23 2c20 7966 6364 2e49 6e74 6572  ek]#, yfcd.Inter
+00003da0: 7661 6c2e 4d6f 6e74 6873 312c 2079 6663  val.Months1, yfc
+00003db0: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
+00003dc0: 7333 5d0a 2020 2020 2020 2020 7365 6c66  s3].        self
+00003dd0: 2e69 6e74 7261 6461 7920 3d20 6e6f 7420  .intraday = not 
+00003de0: 7365 6c66 2e69 6e74 6572 6461 790a 2020  self.interday.  
+00003df0: 2020 2020 2020 7365 6c66 2e6d 756c 7469        self.multi
+00003e00: 6461 7920 3d20 7365 6c66 2e69 6e74 6572  day = self.inter
+00003e10: 6461 7920 616e 6420 7365 6c66 2e69 6e74  day and self.int
+00003e20: 6572 7661 6c20 213d 2079 6663 642e 496e  erval != yfcd.In
+00003e30: 7465 7276 616c 2e44 6179 7331 0a0a 2020  terval.Days1..  
+00003e40: 2020 2020 2020 2320 4c6f 6164 2066 726f        # Load fro
+00003e50: 6d20 6361 6368 650a 2020 2020 2020 2020  m cache.        
+00003e60: 7365 6c66 2e63 6163 6865 5f6b 6579 203d  self.cache_key =
+00003e70: 2022 6869 7374 6f72 792d 222b 7365 6c66   "history-"+self
+00003e80: 2e69 7374 720a 2020 2020 2020 2020 7365  .istr.        se
+00003e90: 6c66 2e68 203d 2073 656c 662e 5f67 6574  lf.h = self._get
+00003ea0: 4361 6368 6564 5072 6963 6573 2829 0a20  CachedPrices(). 
+00003eb0: 2020 2020 2020 2073 656c 662e 5f72 6576         self._rev
+00003ec0: 6965 774e 6577 4469 7673 2829 0a0a 2020  iewNewDivs()..  
+00003ed0: 2020 2020 2020 2320 4120 706c 6163 6520        # A place 
+00003ee0: 746f 2074 656d 706f 7261 7269 6c79 2073  to temporarily s
+00003ef0: 746f 7265 206e 6577 2064 6976 6964 656e  tore new dividen
+00003f00: 6473 2c20 756e 7469 6c20 7072 6963 6573  ds, until prices
+00003f10: 2068 6176 650a 2020 2020 2020 2020 2320   have.        # 
+00003f20: 6265 656e 2072 6570 6169 7265 642c 2074  been repaired, t
+00003f30: 6865 6e20 7468 6579 2063 616e 2062 6520  hen they can be 
+00003f40: 7365 6e74 2074 6f20 4576 656e 7473 4869  sent to EventsHi
+00003f50: 7374 6f72 790a 0a20 2020 2020 2020 2073  story..        s
+00003f60: 656c 662e 5f64 6562 7567 203d 2046 616c  elf._debug = Fal
+00003f70: 7365 0a20 2020 2020 2020 2023 2073 656c  se.        # sel
+00003f80: 662e 5f64 6562 7567 203d 2054 7275 650a  f._debug = True.
+00003f90: 0a20 2020 2020 2020 2023 204d 616e 6167  .        # Manag
+00003fa0: 6520 706f 7465 6e74 6961 6c20 666f 7220  e potential for 
+00003fb0: 696e 6669 6e69 7465 2072 6563 7572 7369  infinite recursi
+00003fc0: 6f6e 2064 7572 696e 6720 7072 6963 6520  on during price 
+00003fd0: 7265 7061 6972 3a0a 2020 2020 2020 2020  repair:.        
+00003fe0: 7365 6c66 2e5f 7265 636f 7264 5f73 7461  self._record_sta
+00003ff0: 636b 5f74 7261 6365 203d 2054 7275 650a  ck_trace = True.
+00004000: 2020 2020 2020 2020 2320 7365 6c66 2e5f          # self._
+00004010: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
+00004020: 6365 203d 2046 616c 7365 0a20 2020 2020  ce = False.     
+00004030: 2020 2073 656c 662e 5f73 7461 636b 5f74     self._stack_t
+00004040: 7261 6365 203d 205b 5d0a 2020 2020 2020  race = [].      
+00004050: 2020 7365 6c66 2e5f 696e 6669 6e69 7465    self._infinite
+00004060: 5f72 6563 7572 7369 6f6e 5f64 6574 6563  _recursion_detec
+00004070: 7465 6420 3d20 4661 6c73 650a 0a20 2020  ted = False..   
+00004080: 2064 6566 205f 6765 7443 6163 6865 6450   def _getCachedP
+00004090: 7269 6365 7328 7365 6c66 293a 0a20 2020  rices(self):.   
+000040a0: 2020 2020 2068 203d 204e 6f6e 650a 2020       h = None.  
+000040b0: 2020 2020 2020 6966 2079 6663 6d2e 4973        if yfcm.Is
+000040c0: 4461 7475 6d43 6163 6865 6428 7365 6c66  DatumCached(self
+000040d0: 2e74 6963 6b65 722c 2073 656c 662e 6361  .ticker, self.ca
+000040e0: 6368 655f 6b65 7929 3a0a 2020 2020 2020  che_key):.      
+000040f0: 2020 2020 2020 6820 3d20 7966 636d 2e52        h = yfcm.R
+00004100: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
+00004110: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
+00004120: 6361 6368 655f 6b65 7929 0a0a 2020 2020  cache_key)..    
+00004130: 2020 2020 6966 2068 2069 7320 6e6f 7420      if h is not 
+00004140: 4e6f 6e65 2061 6e64 2068 2e65 6d70 7479  None and h.empty
+00004150: 3a0a 2020 2020 2020 2020 2020 2020 6820  :.            h 
+00004160: 3d20 4e6f 6e65 0a20 2020 2020 2020 2065  = None.        e
+00004170: 6c69 6620 6820 6973 206e 6f74 204e 6f6e  lif h is not Non
+00004180: 653a 0a20 2020 2020 2020 2020 2020 2068  e:.            h
+00004190: 5f6d 6f64 6966 6965 6420 3d20 4661 6c73  _modified = Fals
+000041a0: 650a 0a20 2020 2020 2020 2020 2020 2023  e..            #
+000041b0: 2068 203d 2079 6663 752e 4375 7374 6f6d   h = yfcu.Custom
+000041c0: 4e61 6e43 6865 636b 696e 6744 6174 6146  NanCheckingDataF
+000041d0: 7261 6d65 2868 290a 0a20 2020 2020 2020  rame(h)..       
+000041e0: 2020 2020 2069 6620 2241 646a 2043 6c6f       if "Adj Clo
+000041f0: 7365 2220 696e 2068 2e63 6f6c 756d 6e73  se" in h.columns
+00004200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00004210: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00004220: 6e28 2241 646a 2043 6c6f 7365 2069 6e20  n("Adj Close in 
+00004230: 6361 6368 6564 2068 2229 0a0a 2020 2020  cached h")..    
+00004240: 2020 2020 2020 2020 665f 6475 7073 203d          f_dups =
+00004250: 2068 2e69 6e64 6578 2e64 7570 6c69 6361   h.index.duplica
+00004260: 7465 6428 290a 2020 2020 2020 2020 2020  ted().          
+00004270: 2020 6966 2066 5f64 7570 732e 616e 7928    if f_dups.any(
+00004280: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00004290: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+000042a0: 6f6e 2822 7b7d 3a20 5468 6573 6520 7469  on("{}: These ti
+000042b0: 6d65 706f 696e 7473 2068 6176 6520 6265  mepoints have be
+000042c0: 656e 2064 7570 6c69 6361 7465 643a 207b  en duplicated: {
+000042d0: 7d22 2e66 6f72 6d61 7428 7365 6c66 2e74  }".format(self.t
+000042e0: 6963 6b65 722c 2068 2e69 6e64 6578 5b66  icker, h.index[f
+000042f0: 5f64 7570 735d 2929 0a0a 2020 2020 2020  _dups]))..      
+00004300: 2020 2020 2020 665f 6e61 203d 206e 702e        f_na = np.
+00004310: 6973 6e61 6e28 685b 2243 4446 225d 2e74  isnan(h["CDF"].t
+00004320: 6f5f 6e75 6d70 7928 2929 0a20 2020 2020  o_numpy()).     
+00004330: 2020 2020 2020 2069 6620 665f 6e61 2e61         if f_na.a
+00004340: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+00004350: 2020 2020 2020 685b 2243 4446 225d 203d        h["CDF"] =
+00004360: 2068 5b22 4344 4622 5d2e 6669 6c6c 6e61   h["CDF"].fillna
+00004370: 286d 6574 686f 643d 2262 6669 6c6c 2229  (method="bfill")
+00004380: 2e66 696c 6c6e 6128 6d65 7468 6f64 3d22  .fillna(method="
+00004390: 6666 696c 6c22 290a 2020 2020 2020 2020  ffill").        
+000043a0: 2020 2020 2020 2020 665f 6e61 203d 2068          f_na = h
+000043b0: 5b22 4344 4622 5d2e 6973 6e61 2829 0a20  ["CDF"].isna(). 
+000043c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000043d0: 6620 665f 6e61 2e61 6e79 2829 3a0a 2020  f f_na.any():.  
+000043e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043f0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00004400: 6e28 2243 4446 204e 614e 2072 6570 6169  n("CDF NaN repai
+00004410: 7220 6661 696c 6564 2229 0a20 2020 2020  r failed").     
+00004420: 2020 2020 2020 2020 2020 2068 5f6d 6f64             h_mod
+00004430: 6966 6965 6420 3d20 5472 7565 0a0a 2020  ified = True..  
+00004440: 2020 2020 2020 2020 2020 6966 2068 5f6d            if h_m
+00004450: 6f64 6966 6965 643a 0a20 2020 2020 2020  odified:.       
+00004460: 2020 2020 2020 2020 2079 6663 6d2e 5374           yfcm.St
+00004470: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
+00004480: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
+00004490: 6361 6368 655f 6b65 792c 2068 290a 0a20  cache_key, h).. 
+000044a0: 2020 2020 2020 2072 6574 7572 6e20 680a         return h.
+000044b0: 0a20 2020 2064 6566 205f 7570 6461 7465  .    def _update
+000044c0: 6443 6163 6865 6450 7269 6365 7328 7365  dCachedPrices(se
+000044d0: 6c66 2c20 6466 293a 0a20 2020 2020 2020  lf, df):.       
+000044e0: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
+000044f0: 6174 6146 7261 6d65 2864 662c 2022 6466  ataFrame(df, "df
+00004500: 2229 0a0a 2020 2020 2020 2020 6578 7065  ")..        expe
+00004510: 6374 6564 5f63 6f6c 7320 3d20 5b22 4f70  cted_cols = ["Op
+00004520: 656e 222c 2022 4869 6768 222c 2022 4c6f  en", "High", "Lo
+00004530: 7722 2c20 2243 6c6f 7365 222c 2022 566f  w", "Close", "Vo
+00004540: 6c75 6d65 222c 2022 4469 7669 6465 6e64  lume", "Dividend
+00004550: 7322 2c20 2253 746f 636b 2053 706c 6974  s", "Stock Split
+00004560: 7322 5d0a 2020 2020 2020 2020 6578 7065  s"].        expe
+00004570: 6374 6564 5f63 6f6c 7320 2b3d 205b 2246  cted_cols += ["F
+00004580: 696e 616c 3f22 2c20 2243 2d43 6865 636b  inal?", "C-Check
+00004590: 3f22 2c20 2246 6574 6368 4461 7465 222c  ?", "FetchDate",
+000045a0: 2022 4353 4622 2c20 2243 4446 225d 0a20   "CSF", "CDF"]. 
+000045b0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+000045c0: 636f 6c73 202b 3d20 5b22 4c61 7374 4469  cols += ["LastDi
+000045d0: 7641 646a 7573 7444 7422 2c20 224c 6173  vAdjustDt", "Las
+000045e0: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+000045f0: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
+00004600: 675f 636f 6c73 203d 205b 6320 666f 7220  g_cols = [c for 
+00004610: 6320 696e 2065 7870 6563 7465 645f 636f  c in expected_co
+00004620: 6c73 2069 6620 6320 6e6f 7420 696e 2064  ls if c not in d
+00004630: 662e 636f 6c75 6d6e 735d 0a20 2020 2020  f.columns].     
+00004640: 2020 2069 6620 6c65 6e28 6d69 7373 696e     if len(missin
+00004650: 675f 636f 6c73 2920 3e20 303a 0a20 2020  g_cols) > 0:.   
+00004660: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+00004670: 7863 6570 7469 6f6e 2866 2244 4620 6d69  xception(f"DF mi
+00004680: 7373 696e 6720 7468 6573 6520 636f 6c75  ssing these colu
+00004690: 6d6e 733a 207b 6d69 7373 696e 675f 636f  mns: {missing_co
+000046a0: 6c73 7d22 290a 0a20 2020 2020 2020 2069  ls}")..        i
+000046b0: 6620 6466 2e65 6d70 7479 3a0a 2020 2020  f df.empty:.    
+000046c0: 2020 2020 2020 2020 6466 203d 204e 6f6e          df = Non
+000046d0: 650a 2020 2020 2020 2020 7966 636d 2e53  e.        yfcm.S
+000046e0: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
+000046f0: 656c 662e 7469 636b 6572 2c20 7365 6c66  elf.ticker, self
+00004700: 2e63 6163 6865 5f6b 6579 2c20 6466 290a  .cache_key, df).
+00004710: 0a20 2020 2020 2020 2073 656c 662e 6820  .        self.h 
+00004720: 3d20 6466 0a0a 2020 2020 6465 6620 5f72  = df..    def _r
+00004730: 6576 6965 774e 6577 4469 7673 2873 656c  eviewNewDivs(sel
+00004740: 6629 3a0a 2020 2020 2020 2020 6966 2073  f):.        if s
+00004750: 656c 662e 696e 7465 7276 616c 2021 3d20  elf.interval != 
+00004760: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
+00004770: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
+00004780: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+00004790: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
+000047a0: 203d 2079 6663 6d2e 5265 6164 4361 6368   = yfcm.ReadCach
+000047b0: 6544 6174 756d 2873 656c 662e 7469 636b  eDatum(self.tick
+000047c0: 6572 2c20 226e 6577 5f64 6976 7322 290a  er, "new_divs").
+000047d0: 2020 2020 2020 2020 6966 2063 6163 6865          if cache
+000047e0: 645f 6e65 775f 6469 7673 2069 7320 6e6f  d_new_divs is no
+000047f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00004800: 2020 2020 6966 2079 6663 6d2e 5265 6164      if yfcm.Read
+00004810: 4361 6368 654d 6574 6164 6174 6128 7365  CacheMetadata(se
+00004820: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
+00004830: 6469 7673 222c 2022 6c6f 636b 6564 2229  divs", "locked")
+00004840: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00004850: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00004860: 5468 6973 2069 7320 6261 642c 206d 6561  This is bad, mea
+00004870: 6e73 2059 4643 2077 6173 206b 696c 6c65  ns YFC was kille
+00004880: 6420 6265 666f 7265 2027 6e65 775f 6469  d before 'new_di
+00004890: 7673 2720 636f 756c 6420 6265 2070 726f  vs' could be pro
+000048a0: 6365 7373 6564 2e0a 2020 2020 2020 2020  cessed..        
+000048b0: 2020 2020 2020 2020 2320 4d65 616e 7320          # Means 
+000048c0: 706f 7465 6e74 6961 6c6c 7920 6675 7475  potentially futu
+000048d0: 7265 206e 6577 2064 6976 6964 656e 6473  re new dividends
+000048e0: 2068 6176 6520 6e6f 7420 6265 656e 2070   have not been p
+000048f0: 726f 6365 7373 6564 0a20 2020 2020 2020  rocessed.       
+00004900: 2020 2020 2020 2020 2068 5f64 6976 7320           h_divs 
+00004910: 3d20 7365 6c66 2e68 2e6c 6f63 5b73 656c  = self.h.loc[sel
+00004920: 662e 685b 2244 6976 6964 656e 6473 225d  f.h["Dividends"]
+00004930: 213d 302c 205b 2244 6976 6964 656e 6473  !=0, ["Dividends
+00004940: 222c 2022 4665 7463 6844 6174 6522 5d5d  ", "FetchDate"]]
+00004950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004960: 2068 5f64 6976 735f 7369 6e63 6520 3d20   h_divs_since = 
+00004970: 685f 6469 7673 5b68 5f64 6976 732e 696e  h_divs[h_divs.in
+00004980: 6465 7820 3e20 6361 6368 6564 5f6e 6577  dex > cached_new
+00004990: 5f64 6976 732e 696e 6465 782e 6d61 7828  _divs.index.max(
+000049a0: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
+000049b0: 2020 2069 6620 6e6f 7420 685f 6469 7673     if not h_divs
+000049c0: 5f73 696e 6365 2e65 6d70 7479 3a0a 2020  _since.empty:.  
+000049d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049e0: 2020 6966 2027 4465 7370 6c69 7474 6564    if 'Desplitted
+000049f0: 3f27 206e 6f74 2069 6e20 6361 6368 6564  ?' not in cached
+00004a00: 5f6e 6577 5f64 6976 732e 636f 6c75 6d6e  _new_divs.column
+00004a10: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00004a20: 2020 2020 2020 2020 2020 2063 6163 6865             cache
+00004a30: 645f 6e65 775f 6469 7673 5b27 4465 7370  d_new_divs['Desp
+00004a40: 6c69 7474 6564 3f27 5d20 3d20 4661 6c73  litted?'] = Fals
+00004a50: 6520 2023 2061 7373 756d 650a 2020 2020  e  # assume.    
+00004a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a70: 685f 6469 7673 5f73 696e 6365 5b27 4465  h_divs_since['De
+00004a80: 7370 6c69 7474 6564 3f27 5d20 3d20 5472  splitted?'] = Tr
+00004a90: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00004aa0: 2020 2020 2020 2063 6163 6865 645f 6e65         cached_ne
+00004ab0: 775f 6469 7673 203d 2070 642e 636f 6e63  w_divs = pd.conc
+00004ac0: 6174 285b 6361 6368 6564 5f6e 6577 5f64  at([cached_new_d
+00004ad0: 6976 732c 2068 5f64 6976 735f 7369 6e63  ivs, h_divs_sinc
+00004ae0: 655d 290a 2020 2020 2020 2020 2020 2020  e]).            
+00004af0: 2020 2020 2020 2020 7966 636d 2e53 746f          yfcm.Sto
+00004b00: 7265 4361 6368 6544 6174 756d 2873 656c  reCacheDatum(sel
+00004b10: 662e 7469 636b 6572 2c20 226e 6577 5f64  f.ticker, "new_d
+00004b20: 6976 7322 2c20 6361 6368 6564 5f6e 6577  ivs", cached_new
+00004b30: 5f64 6976 7329 0a20 2020 2020 2020 2020  _divs).         
+00004b40: 2020 2020 2020 2079 6663 6d2e 5772 6974         yfcm.Writ
+00004b50: 6543 6163 6865 4d65 7461 6461 7461 2873  eCacheMetadata(s
+00004b60: 656c 662e 7469 636b 6572 2c20 226e 6577  elf.ticker, "new
+00004b70: 5f64 6976 7322 2c20 226c 6f63 6b65 6422  _divs", "locked"
+00004b80: 2c20 4e6f 6e65 290a 0a20 2020 2064 6566  , None)..    def
+00004b90: 2067 6574 2873 656c 662c 2073 7461 7274   get(self, start
+00004ba0: 3d4e 6f6e 652c 2065 6e64 3d4e 6f6e 652c  =None, end=None,
+00004bb0: 2070 6572 696f 643d 4e6f 6e65 2c20 6d61   period=None, ma
+00004bc0: 785f 6167 653d 4e6f 6e65 2c20 7472 6967  x_age=None, trig
+00004bd0: 6765 725f 6174 5f6d 6172 6b65 745f 636c  ger_at_market_cl
+00004be0: 6f73 653d 4661 6c73 652c 2072 6570 6169  ose=False, repai
+00004bf0: 723d 5472 7565 2c20 7072 6570 6f73 743d  r=True, prepost=
+00004c00: 4661 6c73 652c 2061 646a 7573 745f 7370  False, adjust_sp
+00004c10: 6c69 7473 3d46 616c 7365 2c20 6164 6a75  lits=False, adju
+00004c20: 7374 5f64 6976 733d 4661 6c73 652c 2071  st_divs=False, q
+00004c30: 7569 6574 3d46 616c 7365 293a 0a20 2020  uiet=False):.   
+00004c40: 2020 2020 2069 6620 7374 6172 7420 6973       if start is
+00004c50: 204e 6f6e 6520 616e 6420 656e 6420 6973   None and end is
+00004c60: 204e 6f6e 6520 616e 6420 7065 7269 6f64   None and period
+00004c70: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00004c80: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00004c90: 6545 7272 6f72 2822 4d75 7374 2070 726f  eError("Must pro
+00004ca0: 7669 6465 2076 616c 7565 2066 6f72 206f  vide value for o
+00004cb0: 6e65 206f 663a 2027 7374 6172 7427 2c20  ne of: 'start', 
+00004cc0: 2765 6e64 272c 2027 7065 7269 6f64 2722  'end', 'period'"
+00004cd0: 290a 2020 2020 2020 2020 6966 2073 7461  ).        if sta
+00004ce0: 7274 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rt is not None:.
+00004cf0: 2020 2020 2020 2020 2020 2020 7966 6375              yfcu
+00004d00: 2e54 7970 6543 6865 636b 496e 7465 7276  .TypeCheckInterv
+00004d10: 616c 4474 2873 7461 7274 2c20 7365 6c66  alDt(start, self
+00004d20: 2e69 6e74 6572 7661 6c2c 2022 7374 6172  .interval, "star
+00004d30: 7422 2c20 7374 7269 6374 3d46 616c 7365  t", strict=False
+00004d40: 290a 2020 2020 2020 2020 6966 2065 6e64  ).        if end
+00004d50: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00004d60: 2020 2020 2020 2020 2020 7966 6375 2e54            yfcu.T
+00004d70: 7970 6543 6865 636b 496e 7465 7276 616c  ypeCheckInterval
+00004d80: 4474 2865 6e64 2c20 7365 6c66 2e69 6e74  Dt(end, self.int
+00004d90: 6572 7661 6c2c 2022 656e 6422 2c20 7374  erval, "end", st
+00004da0: 7269 6374 3d46 616c 7365 290a 2020 2020  rict=False).    
+00004db0: 2020 2020 6966 2070 6572 696f 6420 6973      if period is
+00004dc0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00004dd0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+00004de0: 4368 6563 6b50 6572 696f 6428 7065 7269  CheckPeriod(peri
+00004df0: 6f64 2c20 2270 6572 696f 6422 290a 2020  od, "period").  
+00004e00: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
+00004e10: 6865 636b 426f 6f6c 2874 7269 6767 6572  heckBool(trigger
+00004e20: 5f61 745f 6d61 726b 6574 5f63 6c6f 7365  _at_market_close
+00004e30: 2c20 2274 7269 6767 6572 5f61 745f 6d61  , "trigger_at_ma
+00004e40: 726b 6574 5f63 6c6f 7365 2229 0a20 2020  rket_close").   
+00004e50: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00004e60: 6563 6b42 6f6f 6c28 7265 7061 6972 2c20  eckBool(repair, 
+00004e70: 2272 6570 6169 7222 290a 2020 2020 2020  "repair").      
+00004e80: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+00004e90: 426f 6f6c 2861 646a 7573 745f 7370 6c69  Bool(adjust_spli
+00004ea0: 7473 2c20 2261 646a 7573 745f 7370 6c69  ts, "adjust_spli
+00004eb0: 7473 2229 0a20 2020 2020 2020 2079 6663  ts").        yfc
+00004ec0: 752e 5479 7065 4368 6563 6b42 6f6f 6c28  u.TypeCheckBool(
+00004ed0: 6164 6a75 7374 5f64 6976 732c 2022 6164  adjust_divs, "ad
+00004ee0: 6a75 7374 5f64 6976 7322 290a 0a20 2020  just_divs")..   
+00004ef0: 2020 2020 2023 2054 4f44 4f3a 2065 6e66       # TODO: enf
+00004f00: 6f72 6365 2027 6d61 785f 6167 6527 2076  orce 'max_age' v
+00004f10: 616c 7565 2070 726f 7669 6465 642e 204f  alue provided. O
+00004f20: 6e6c 7920 274e 6f6e 6527 2077 6869 6c65  nly 'None' while
+00004f30: 2049 2064 6576 0a20 2020 2020 2020 2069   I dev.        i
+00004f40: 6620 6d61 785f 6167 6520 6973 204e 6f6e  f max_age is Non
+00004f50: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00004f60: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+00004f70: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+00004f80: 2e44 6179 7331 3a0a 2020 2020 2020 2020  .Days1:.        
+00004f90: 2020 2020 2020 2020 6d61 785f 6167 6520          max_age 
+00004fa0: 3d20 7469 6d65 6465 6c74 6128 686f 7572  = timedelta(hour
+00004fb0: 733d 3429 0a20 2020 2020 2020 2020 2020  s=4).           
+00004fc0: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
+00004fd0: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+00004fe0: 7276 616c 2e57 6565 6b3a 0a20 2020 2020  rval.Week:.     
+00004ff0: 2020 2020 2020 2020 2020 206d 6178 5f61             max_a
+00005000: 6765 203d 2074 696d 6564 656c 7461 2868  ge = timedelta(h
+00005010: 6f75 7273 3d36 3029 0a20 2020 2020 2020  ours=60).       
+00005020: 2020 2020 2023 2065 6c69 6620 7365 6c66       # elif self
+00005030: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+00005040: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
+00005050: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
+00005060: 2320 2020 2020 6d61 785f 6167 6520 3d20  #     max_age = 
+00005070: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
+00005080: 3529 0a20 2020 2020 2020 2020 2020 2023  5).            #
+00005090: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
+000050a0: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+000050b0: 7276 616c 2e4d 6f6e 7468 7333 3a0a 2020  rval.Months3:.  
+000050c0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+000050d0: 6d61 785f 6167 6520 3d20 7469 6d65 6465  max_age = timede
+000050e0: 6c74 6128 6461 7973 3d34 3529 0a20 2020  lta(days=45).   
+000050f0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00005100: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00005110: 6178 5f61 6765 203d 2030 2e35 2a79 6663  ax_age = 0.5*yfc
+00005120: 642e 696e 7465 7276 616c 546f 5469 6d65  d.intervalToTime
+00005130: 6465 6c74 615b 7365 6c66 2e69 6e74 6572  delta[self.inter
+00005140: 7661 6c5d 0a0a 2020 2020 2020 2020 2320  val]..        # 
+00005150: 5946 4320 6361 6e6e 6f74 2068 616e 646c  YFC cannot handl
+00005160: 6520 7072 652d 2061 6e64 2070 6f73 742d  e pre- and post-
+00005170: 6d61 726b 6574 2069 6e74 7261 6461 790a  market intraday.
+00005180: 2020 2020 2020 2020 7072 6570 6f73 7420          prepost 
+00005190: 3d20 7365 6c66 2e69 6e74 6572 6461 790a  = self.interday.
+000051a0: 0a20 2020 2020 2020 2079 6663 742e 5365  .        yfct.Se
+000051b0: 7445 7863 6861 6e67 6554 7a4e 616d 6528  tExchangeTzName(
+000051c0: 7365 6c66 2e65 7863 6861 6e67 652c 2073  self.exchange, s
+000051d0: 656c 662e 747a 4e61 6d65 290a 2020 2020  elf.tzName).    
+000051e0: 2020 2020 7464 5f31 6420 3d20 7469 6d65      td_1d = time
+000051f0: 6465 6c74 6128 6461 7973 3d31 290a 2020  delta(days=1).  
+00005200: 2020 2020 2020 747a 5f65 7863 6861 6e67        tz_exchang
+00005210: 6520 3d20 5a6f 6e65 496e 666f 2873 656c  e = ZoneInfo(sel
+00005220: 662e 747a 4e61 6d65 290a 2020 2020 2020  f.tzName).      
+00005230: 2020 6474 5f6e 6f77 203d 2070 642e 5469    dt_now = pd.Ti
+00005240: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
+00005250: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
+00005260: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
+00005270: 2064 5f6e 6f77 5f65 7863 6861 6e67 6520   d_now_exchange 
+00005280: 3d20 6474 5f6e 6f77 2e64 6174 6528 290a  = dt_now.date().
+00005290: 2020 2020 2020 2020 746f 6d6f 7272 6f77          tomorrow
+000052a0: 5f64 203d 2064 5f6e 6f77 5f65 7863 6861  _d = d_now_excha
+000052b0: 6e67 6520 2b20 7464 5f31 640a 2020 2020  nge + td_1d.    
+000052c0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+000052d0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+000052e0: 2020 746f 6d6f 7272 6f77 203d 2074 6f6d    tomorrow = tom
+000052f0: 6f72 726f 775f 640a 2020 2020 2020 2020  orrow_d.        
+00005300: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00005310: 2020 746f 6d6f 7272 6f77 203d 2064 6174    tomorrow = dat
+00005320: 6574 696d 652e 636f 6d62 696e 6528 746f  etime.combine(to
+00005330: 6d6f 7272 6f77 5f64 2c20 7469 6d65 2830  morrow_d, time(0
+00005340: 292c 2074 7a5f 6578 6368 616e 6765 290a  ), tz_exchange).
+00005350: 2020 2020 2020 2020 6966 2073 7461 7274          if start
+00005360: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00005370: 2020 2020 2020 2020 2020 6966 2065 6e64            if end
+00005380: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00005390: 2073 7461 7274 203e 3d20 656e 643a 0a20   start >= end:. 
+000053a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000053b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000053c0: 7228 6622 7374 6172 743d 7b73 7461 7274  r(f"start={start
+000053d0: 7d20 6d75 7374 203c 2065 6e64 3d7b 656e  } must < end={en
+000053e0: 647d 2229 0a20 2020 2020 2020 2020 2020  d}").           
+000053f0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00005400: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+00005410: 6620 2873 656c 662e 696e 7465 7264 6179  f (self.interday
+00005420: 2061 6e64 2073 7461 7274 203e 3d20 746f   and start >= to
+00005430: 6d6f 7272 6f77 2920 6f72 2028 6e6f 7420  morrow) or (not 
+00005440: 7365 6c66 2e69 6e74 6572 6461 7920 616e  self.interday an
+00005450: 6420 7374 6172 7420 3e20 6474 5f6e 6f77  d start > dt_now
+00005460: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00005470: 6620 6973 696e 7374 616e 6365 2873 7461  f isinstance(sta
+00005480: 7274 2c20 6461 7465 7469 6d65 293a 0a20  rt, datetime):. 
+00005490: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000054a0: 6620 7374 6172 7420 3e20 6474 5f6e 6f77  f start > dt_now
+000054b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000054c0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+000054d0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+000054e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000054f0: 2020 2020 6966 2073 7461 7274 203e 3d20      if start >= 
+00005500: 746f 6d6f 7272 6f77 5f64 3a0a 2020 2020  tomorrow_d:.    
+00005510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005520: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+00005530: 2020 2020 2064 6562 7567 5f79 6620 3d20       debug_yf = 
+00005540: 4661 6c73 650a 2020 2020 2020 2020 6465  False.        de
+00005550: 6275 675f 7966 6320 3d20 7365 6c66 2e5f  bug_yfc = self._
+00005560: 6465 6275 670a 2020 2020 2020 2020 2320  debug.        # 
+00005570: 6465 6275 675f 7966 6320 3d20 5472 7565  debug_yfc = True
+00005580: 0a0a 2020 2020 2020 2020 6966 2070 6572  ..        if per
+00005590: 696f 6420 6973 206e 6f74 204e 6f6e 653a  iod is not None:
+000055a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000055b0: 5f6d 7367 203d 2066 2250 7269 6365 4869  _msg = f"PriceHi
+000055c0: 7374 6f72 792d 7b73 656c 662e 6973 7472  story-{self.istr
+000055d0: 7d2e 6765 7428 746b 723d 7b73 656c 662e  }.get(tkr={self.
+000055e0: 7469 636b 6572 7d2c 2070 6572 696f 643d  ticker}, period=
+000055f0: 7b70 6572 696f 647d 2c20 6d61 785f 6167  {period}, max_ag
+00005600: 653d 7b6d 6178 5f61 6765 7d2c 2074 7269  e={max_age}, tri
+00005610: 6767 6572 5f61 745f 6d61 726b 6574 5f63  gger_at_market_c
+00005620: 6c6f 7365 3d7b 7472 6967 6765 725f 6174  lose={trigger_at
+00005630: 5f6d 6172 6b65 745f 636c 6f73 657d 2c20  _market_close}, 
+00005640: 7072 6570 6f73 743d 7b70 7265 706f 7374  prepost={prepost
+00005650: 7d2c 2072 6570 6169 723d 7b72 6570 6169  }, repair={repai
+00005660: 727d 2922 0a20 2020 2020 2020 2065 6c73  r})".        els
+00005670: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+00005680: 6f67 5f6d 7367 203d 2066 2250 7269 6365  og_msg = f"Price
+00005690: 4869 7374 6f72 792d 7b73 656c 662e 6973  History-{self.is
+000056a0: 7472 7d2e 6765 7428 746b 723d 7b73 656c  tr}.get(tkr={sel
+000056b0: 662e 7469 636b 6572 7d2c 2073 7461 7274  f.ticker}, start
+000056c0: 3d7b 7374 6172 747d 2c20 656e 643d 7b65  ={start}, end={e
+000056d0: 6e64 7d2c 206d 6178 5f61 6765 3d7b 6d61  nd}, max_age={ma
+000056e0: 785f 6167 657d 2c20 7472 6967 6765 725f  x_age}, trigger_
+000056f0: 6174 5f6d 6172 6b65 745f 636c 6f73 653d  at_market_close=
+00005700: 7b74 7269 6767 6572 5f61 745f 6d61 726b  {trigger_at_mark
+00005710: 6574 5f63 6c6f 7365 7d2c 2070 7265 706f  et_close}, prepo
+00005720: 7374 3d7b 7072 6570 6f73 747d 2c20 7265  st={prepost}, re
+00005730: 7061 6972 3d7b 7265 7061 6972 7d29 220a  pair={repair})".
+00005740: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
+00005750: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+00005760: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00005770: 7966 636c 2e54 7261 6365 456e 7465 7228  yfcl.TraceEnter(
+00005780: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
+00005790: 2065 6c69 6620 6465 6275 675f 7966 633a   elif debug_yfc:
+000057a0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000057b0: 6e74 286c 6f67 5f6d 7367 290a 0a20 2020  nt(log_msg)..   
+000057c0: 2020 2020 2073 656c 662e 5f61 7070 6c79       self._apply
+000057d0: 4e65 7745 7665 6e74 7328 290a 0a20 2020  NewEvents()..   
+000057e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000057f0: 2020 2020 2020 7966 5f6c 6167 203d 2079        yf_lag = y
+00005800: 6663 642e 6578 6368 616e 6765 546f 5966  fcd.exchangeToYf
+00005810: 4c61 675b 7365 6c66 2e65 7863 6861 6e67  Lag[self.exchang
+00005820: 655d 0a20 2020 2020 2020 2065 7863 6570  e].        excep
+00005830: 743a 0a20 2020 2020 2020 2020 2020 2070  t:.            p
+00005840: 7269 6e74 2866 222d 2074 6963 6b65 7220  rint(f"- ticker 
+00005850: 3d20 7b73 656c 662e 7469 636b 6572 7d22  = {self.ticker}"
+00005860: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
+00005870: 6973 650a 0a20 2020 2020 2020 2070 7374  ise..        pst
+00005880: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
+00005890: 2065 6e64 5f64 203d 204e 6f6e 6520 3b20   end_d = None ; 
+000058a0: 656e 645f 6474 203d 204e 6f6e 650a 2020  end_dt = None.  
+000058b0: 2020 2020 2020 6966 2070 6572 696f 6420        if period 
+000058c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000058d0: 2020 2020 2020 2020 2073 7461 7274 5f64           start_d
+000058e0: 2c20 656e 645f 6420 3d20 7966 6374 2e4d  , end_d = yfct.M
+000058f0: 6170 5065 7269 6f64 546f 4461 7465 7328  apPeriodToDates(
+00005900: 7365 6c66 2e65 7863 6861 6e67 652c 2070  self.exchange, p
+00005910: 6572 696f 642c 2073 656c 662e 696e 7465  eriod, self.inte
+00005920: 7276 616c 290a 2020 2020 2020 2020 2020  rval).          
+00005930: 2020 7065 7269 6f64 203d 204e 6f6e 650a    period = None.
+00005940: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00005950: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
+00005960: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00005970: 6172 7420 3d20 7374 6172 745f 640a 2020  art = start_d.  
 00005980: 2020 2020 2020 2020 2020 2020 2020 656e                en
-00005990: 6420 3d20 6461 7465 7469 6d65 2e63 6f6d  d = datetime.com
-000059a0: 6269 6e65 2864 5f6e 6f77 5f65 7863 6861  bine(d_now_excha
-000059b0: 6e67 652c 2074 696d 6528 3029 2c20 747a  nge, time(0), tz
-000059c0: 5f65 7863 6861 6e67 6529 0a20 2020 2020  _exchange).     
-000059d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000059e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000059f0: 2020 2020 2069 203d 2079 6663 742e 4765       i = yfct.Ge
-00005a00: 7454 696d 6573 7461 6d70 4375 7272 656e  tTimestampCurren
-00005a10: 7449 6e74 6572 7661 6c28 7365 6c66 2e65  tInterval(self.e
-00005a20: 7863 6861 6e67 652c 2064 745f 6e6f 772b  xchange, dt_now+
-00005a30: 7966 5f6c 6167 2c20 7365 6c66 2e69 6e74  yf_lag, self.int
-00005a40: 6572 7661 6c2c 2069 676e 6f72 655f 6272  erval, ignore_br
-00005a50: 6561 6b73 3d54 7275 6529 0a20 2020 2020  eaks=True).     
-00005a60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00005a70: 6620 6920 6973 204e 6f6e 653a 0a20 2020  f i is None:.   
-00005a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a90: 2020 2020 2023 2041 6674 6572 2069 6e74       # After int
-00005aa0: 6572 7661 6c0a 2020 2020 2020 2020 2020  erval.          
-00005ab0: 2020 2020 2020 2020 2020 2020 2020 656e                en
-00005ac0: 6420 3d20 6461 7465 7469 6d65 2e63 6f6d  d = datetime.com
-00005ad0: 6269 6e65 2864 5f6e 6f77 5f65 7863 6861  bine(d_now_excha
-00005ae0: 6e67 652b 7464 5f31 642c 2074 696d 6528  nge+td_1d, time(
-00005af0: 3029 2c20 747a 5f65 7863 6861 6e67 6529  0), tz_exchange)
-00005b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005b10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00005b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b30: 2020 2023 2044 7572 696e 6720 696e 7465     # During inte
-00005b40: 7276 616c 0a20 2020 2020 2020 2020 2020  rval.           
-00005b50: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-00005b60: 203d 2069 5b22 696e 7465 7276 616c 5f63   = i["interval_c
-00005b70: 6c6f 7365 225d 0a20 2020 2020 2020 2069  lose"].        i
-00005b80: 6620 656e 6420 6973 206e 6f74 204e 6f6e  f end is not Non
-00005b90: 6520 616e 6420 656e 645f 6474 2069 7320  e and end_dt is 
-00005ba0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00005bb0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00005bc0: 656e 642c 2064 6174 6574 696d 6529 3a0a  end, datetime):.
-00005bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005be0: 656e 645f 6474 203d 2065 6e64 0a20 2020  end_dt = end.   
-00005bf0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00005c00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005c10: 2065 6e64 5f64 7420 3d20 6461 7465 7469   end_dt = dateti
-00005c20: 6d65 2e63 6f6d 6269 6e65 2865 6e64 2b74  me.combine(end+t
-00005c30: 645f 3164 2c20 7469 6d65 2830 292c 2074  d_1d, time(0), t
-00005c40: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
-00005c50: 2020 2020 2020 2020 2020 2020 656e 645f              end_
-00005c60: 6474 203d 2064 6174 6574 696d 652e 636f  dt = datetime.co
-00005c70: 6d62 696e 6528 656e 642c 2074 696d 6528  mbine(end, time(
-00005c80: 3029 2c20 747a 5f65 7863 6861 6e67 6529  0), tz_exchange)
-00005c90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005ca0: 6e6f 7420 7365 6c66 2e69 6e74 6572 6461  not self.interda
-00005cb0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00005cc0: 2020 2065 6e64 203d 2065 6e64 5f64 740a     end = end_dt.
-00005cd0: 0a20 2020 2020 2020 2069 6620 7065 7269  .        if peri
-00005ce0: 6f64 2069 7320 4e6f 6e65 3a0a 2020 2020  od is None:.    
-00005cf0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005d00: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
-00005d10: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-00005d20: 6e73 7461 6e63 6528 7374 6172 742c 2064  nstance(start, d
-00005d30: 6174 6574 696d 6529 206f 7220 6973 696e  atetime) or isin
-00005d40: 7374 616e 6365 2865 6e64 2c20 6461 7465  stance(end, date
-00005d50: 7469 6d65 293a 0a20 2020 2020 2020 2020  time):.         
-00005d60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00005d70: 2054 7970 6545 7272 6f72 2866 2227 7374   TypeError(f"'st
-00005d80: 6172 7427 2061 6e64 2027 656e 6427 206d  art' and 'end' m
-00005d90: 7573 7420 6265 2064 6174 6520 7479 7065  ust be date type
-00005da0: 206e 6f74 207b 7479 7065 2873 7461 7274   not {type(start
-00005db0: 297d 2c20 7b74 7970 6528 656e 6429 7d22  )}, {type(end)}"
-00005dc0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00005dd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00005de0: 2020 2020 6966 2028 6e6f 7420 6973 696e      if (not isin
-00005df0: 7374 616e 6365 2873 7461 7274 2c20 6461  stance(start, da
-00005e00: 7465 7469 6d65 2929 2061 6e64 2028 6e6f  tetime)) and (no
-00005e10: 7420 6973 696e 7374 616e 6365 2865 6e64  t isinstance(end
-00005e20: 2c20 6461 7465 7469 6d65 2929 3a0a 2020  , datetime)):.  
-00005e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e40: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-00005e50: 7228 6622 2773 7461 7274 2720 616e 6420  r(f"'start' and 
-00005e60: 2765 6e64 2720 6d75 7374 2062 6520 6461  'end' must be da
-00005e70: 7465 7469 6d65 2074 7970 6520 6e6f 7420  tetime type not 
-00005e80: 7b74 7970 6528 7374 6172 7429 7d2c 207b  {type(start)}, {
-00005e90: 7479 7065 2865 6e64 297d 2229 0a0a 2020  type(end)}")..  
-00005ea0: 2020 2020 2020 6c69 7374 696e 675f 6461        listing_da
-00005eb0: 7465 203d 2079 6663 6d2e 5265 6164 4361  te = yfcm.ReadCa
-00005ec0: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
-00005ed0: 636b 6572 2c20 226c 6973 7469 6e67 5f64  cker, "listing_d
-00005ee0: 6174 6522 290a 2020 2020 2020 2020 6966  ate").        if
-00005ef0: 206c 6973 7469 6e67 5f64 6174 6520 6973   listing_date is
-00005f00: 206e 6f74 204e 6f6e 6520 616e 6420 7374   not None and st
-00005f10: 6172 7420 6973 206e 6f74 204e 6f6e 653a  art is not None:
-00005f20: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
-00005f30: 7469 6e67 5f64 6174 655f 6474 203d 2064  ting_date_dt = d
-00005f40: 6174 6574 696d 652e 636f 6d62 696e 6528  atetime.combine(
-00005f50: 6c69 7374 696e 675f 6461 7465 2c20 7469  listing_date, ti
-00005f60: 6d65 2830 292c 2074 7a5f 6578 6368 616e  me(0), tz_exchan
-00005f70: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
-00005f80: 6966 2069 7369 6e73 7461 6e63 6528 7374  if isinstance(st
-00005f90: 6172 742c 2064 6174 6574 696d 6529 3a0a  art, datetime):.
-00005fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fb0: 7374 6172 7420 3d20 6d61 7828 7374 6172  start = max(star
-00005fc0: 742c 206c 6973 7469 6e67 5f64 6174 655f  t, listing_date_
-00005fd0: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-00005fe0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005ff0: 2020 2020 2020 7374 6172 7420 3d20 6d61        start = ma
-00006000: 7828 7374 6172 742c 206c 6973 7469 6e67  x(start, listing
-00006010: 5f64 6174 6529 0a0a 2020 2020 2020 2020  _date)..        
-00006020: 6966 2073 656c 662e 6820 6973 206e 6f74  if self.h is not
-00006030: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00006040: 2020 2069 6620 7365 6c66 2e68 2e65 6d70     if self.h.emp
-00006050: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00006060: 2020 2020 7365 6c66 2e68 203d 204e 6f6e      self.h = Non
-00006070: 650a 0a20 2020 2020 2020 2023 2052 656d  e..        # Rem
-00006080: 6f76 6520 6578 7069 7265 6420 696e 7465  ove expired inte
-00006090: 7276 616c 7320 6672 6f6d 2063 6163 6865  rvals from cache
-000060a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000060b0: 2e68 2069 7320 6e6f 7420 4e6f 6e65 3a0a  .h is not None:.
-000060c0: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-000060d0: 7365 6c66 2e68 2e73 6861 7065 5b30 5d0a  self.h.shape[0].
-000060e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000060f0: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
-00006100: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00006110: 696e 7465 7276 616c 5f64 7473 203d 2073  interval_dts = s
-00006120: 656c 662e 682e 696e 6465 782e 6461 7465  elf.h.index.date
-00006130: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-00006140: 656c 662e 682e 696e 6465 785b 305d 2c20  elf.h.index[0], 
-00006150: 7064 2e54 696d 6573 7461 6d70 2920 656c  pd.Timestamp) el
-00006160: 7365 2073 656c 662e 682e 696e 6465 780a  se self.h.index.
-00006170: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00006180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006190: 2020 685f 696e 7465 7276 616c 5f64 7473    h_interval_dts
-000061a0: 203d 206e 702e 6172 7261 7928 5b79 6663   = np.array([yfc
-000061b0: 742e 436f 6e76 6572 7454 6f44 6174 6574  t.ConvertToDatet
-000061c0: 696d 6528 6474 2c20 747a 3d74 7a5f 6578  ime(dt, tz=tz_ex
-000061d0: 6368 616e 6765 2920 666f 7220 6474 2069  change) for dt i
-000061e0: 6e20 7365 6c66 2e68 2e69 6e64 6578 5d29  n self.h.index])
-000061f0: 0a20 2020 2020 2020 2020 2020 2068 5f69  .            h_i
-00006200: 6e74 6572 7661 6c5f 6474 7320 3d20 6e70  nterval_dts = np
-00006210: 2e61 7272 6179 2868 5f69 6e74 6572 7661  .array(h_interva
-00006220: 6c5f 6474 7329 0a20 2020 2020 2020 2020  l_dts).         
-00006230: 2020 2023 2069 6620 7365 6c66 2e69 6e74     # if self.int
-00006240: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00006250: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
-00006260: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00006270: 662e 636f 6e74 6967 756f 7573 3a0a 2020  f.contiguous:.  
-00006280: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00006290: 4461 696c 7920 6461 7461 2069 7320 616c  Daily data is al
-000062a0: 7761 7973 2063 6f6e 7469 6775 6f75 7320  ways contiguous 
-000062b0: 736f 206f 6e6c 7920 6e65 6564 2074 6f20  so only need to 
-000062c0: 6368 6563 6b20 6c61 7374 2072 6f77 0a20  check last row. 
-000062d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000062e0: 5f69 6e74 6572 7661 6c5f 6474 203d 2068  _interval_dt = h
-000062f0: 5f69 6e74 6572 7661 6c5f 6474 735b 2d31  _interval_dts[-1
-00006300: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00006310: 2020 6665 7463 685f 6474 203d 2079 6663    fetch_dt = yfc
-00006320: 742e 436f 6e76 6572 7454 6f44 6174 6574  t.ConvertToDatet
-00006330: 696d 6528 7365 6c66 2e68 5b22 4665 7463  ime(self.h["Fetc
-00006340: 6844 6174 6522 5d2e 696c 6f63 5b2d 315d  hDate"].iloc[-1]
-00006350: 2c20 747a 3d74 7a5f 6578 6368 616e 6765  , tz=tz_exchange
-00006360: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006370: 2020 665f 6669 6e61 6c20 3d20 7365 6c66    f_final = self
-00006380: 2e68 5b22 4669 6e61 6c3f 225d 2e74 6f5f  .h["Final?"].to_
-00006390: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-000063a0: 2020 2020 2020 2020 665f 6e66 696e 616c          f_nfinal
-000063b0: 203d 207e 665f 6669 6e61 6c0a 2020 2020   = ~f_final.    
-000063c0: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
-000063d0: 616c 736f 2074 7265 6174 2072 6570 6169  also treat repai
-000063e0: 7265 6420 6461 7461 2061 7320 6e6f 6e2d  red data as non-
-000063f0: 6669 6e61 6c2c 2069 6620 6665 7463 6865  final, if fetche
-00006400: 6420 6e65 6172 2074 6f20 696e 7465 7276  d near to interv
-00006410: 616c 2074 696d 6570 6f69 6e74 0a20 2020  al timepoint.   
-00006420: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00006430: 2062 6563 6175 7365 2059 6168 6f6f 206d   because Yahoo m
-00006440: 6967 6874 206e 6f77 2068 6176 6520 636f  ight now have co
-00006450: 7272 6563 7420 6461 7461 0a20 2020 2020  rrect data.     
-00006460: 2020 2020 2020 2020 2020 2023 202d 2061             # - a
-00006470: 6e64 2074 7265 6174 204e 614e 2064 6174  nd treat NaN dat
-00006480: 6120 6173 2072 6570 6169 7265 640a 2020  a as repaired.  
-00006490: 2020 2020 2020 2020 2020 2020 2020 665f                f_
-000064a0: 7265 7061 6972 203d 2073 656c 662e 685b  repair = self.h[
-000064b0: 2252 6570 6169 7265 643f 225d 2e74 6f5f  "Repaired?"].to_
-000064c0: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-000064d0: 2020 2020 2020 2020 665f 6e61 203d 2073          f_na = s
-000064e0: 656c 662e 685b 2743 6c6f 7365 275d 2e69  elf.h['Close'].i
-000064f0: 736e 6128 292e 746f 5f6e 756d 7079 2829  sna().to_numpy()
-00006500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006510: 2066 5f72 6570 6169 7220 3d20 665f 7265   f_repair = f_re
-00006520: 7061 6972 207c 2066 5f6e 610a 2020 2020  pair | f_na.    
-00006530: 2020 2020 2020 2020 2020 2020 6375 746f              cuto
-00006540: 6666 5f64 7473 203d 2073 656c 662e 682e  ff_dts = self.h.
-00006550: 696e 6465 7820 2b20 7365 6c66 2e69 7464  index + self.itd
-00006560: 202b 2074 696d 6564 656c 7461 2864 6179   + timedelta(day
-00006570: 733d 3729 0a20 2020 2020 2020 2020 2020  s=7).           
-00006580: 2020 2020 2023 2049 676e 6f72 6520 7265       # Ignore re
-00006590: 7061 6972 6564 2064 6174 6120 6966 2066  paired data if f
-000065a0: 6574 6368 6564 2f72 6570 6169 7265 6420  etched/repaired 
-000065b0: 372b 2064 6179 7320 6166 7465 7220 696e  7+ days after in
-000065c0: 7465 7276 616c 2065 6e64 0a20 2020 2020  terval end.     
-000065d0: 2020 2020 2020 2020 2020 2066 5f72 6570             f_rep
-000065e0: 6169 725b 7365 6c66 2e68 5b27 4665 7463  air[self.h['Fetc
-000065f0: 6844 6174 6527 5d20 3e20 6375 746f 6666  hDate'] > cutoff
-00006600: 5f64 7473 5d20 3d20 4661 6c73 650a 2020  _dts] = False.  
-00006610: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00006620: 2066 5f72 6570 6169 722e 616e 7928 293a   f_repair.any():
-00006630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006640: 2020 2020 2066 5f6e 6669 6e61 6c20 3d20       f_nfinal = 
-00006650: 665f 6e66 696e 616c 207c 2066 5f72 6570  f_nfinal | f_rep
-00006660: 6169 720a 2020 2020 2020 2020 2020 2020  air.            
-00006670: 2020 2020 6966 2066 5f6e 6669 6e61 6c2e      if f_nfinal.
-00006680: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-00006690: 2020 2020 2020 2020 2020 2069 6478 3020             idx0 
-000066a0: 3d20 6e70 2e77 6865 7265 2866 5f6e 6669  = np.where(f_nfi
-000066b0: 6e61 6c29 5b30 5d5b 305d 0a20 2020 2020  nal)[0][0].     
-000066c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000066d0: 6570 6169 7265 6420 3d20 665f 7265 7061  epaired = f_repa
-000066e0: 6972 5b69 6478 305d 0a20 2020 2020 2020  ir[idx0].       
-000066f0: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
-00006700: 6e74 6572 7661 6c5f 6474 203d 2068 5f69  nterval_dt = h_i
-00006710: 6e74 6572 7661 6c5f 6474 735b 6964 7830  nterval_dts[idx0
-00006720: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00006730: 2020 2020 2020 6665 7463 685f 6474 203d        fetch_dt =
-00006740: 2079 6663 742e 436f 6e76 6572 7454 6f44   yfct.ConvertToD
-00006750: 6174 6574 696d 6528 7365 6c66 2e68 5b22  atetime(self.h["
-00006760: 4665 7463 6844 6174 6522 5d2e 696c 6f63  FetchDate"].iloc
-00006770: 5b69 6478 305d 2c20 747a 3d74 7a5f 6578  [idx0], tz=tz_ex
-00006780: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
-00006790: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000067a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000067b0: 2020 2020 2020 2020 2065 7870 6972 6564           expired
-000067c0: 203d 2079 6663 742e 4973 5072 6963 6544   = yfct.IsPriceD
-000067d0: 6174 6170 6f69 6e74 4578 7069 7265 6428  atapointExpired(
-000067e0: 685f 696e 7465 7276 616c 5f64 742c 2066  h_interval_dt, f
-000067f0: 6574 6368 5f64 742c 2072 6570 6169 7265  etch_dt, repaire
-00006800: 642c 206d 6178 5f61 6765 2c20 7365 6c66  d, max_age, self
-00006810: 2e65 7863 6861 6e67 652c 2073 656c 662e  .exchange, self.
-00006820: 696e 7465 7276 616c 2c20 7966 5f6c 6167  interval, yf_lag
-00006830: 3d79 665f 6c61 672c 2074 7269 6767 6572  =yf_lag, trigger
-00006840: 4578 7069 7279 4f6e 436c 6f73 653d 7472  ExpiryOnClose=tr
-00006850: 6967 6765 725f 6174 5f6d 6172 6b65 745f  igger_at_market_
-00006860: 636c 6f73 6529 0a20 2020 2020 2020 2020  close).         
-00006870: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00006880: 7420 7966 6364 2e54 696d 6573 7461 6d70  t yfcd.Timestamp
-00006890: 4f75 7473 6964 6549 6e74 6572 7661 6c45  OutsideIntervalE
-000068a0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068c0: 2020 2020 2020 2069 6620 665f 6e61 5b69         if f_na[i
-000068d0: 6478 305d 3a0a 2020 2020 2020 2020 2020  dx0]:.          
-000068e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068f0: 2020 2320 5946 4320 6d75 7374 2068 6176    # YFC must hav
-00006900: 6520 696e 7365 7274 6564 2061 2072 6f77  e inserted a row
-00006910: 206f 6620 4e61 4e73 2c20 7772 6f6e 676c   of NaNs, wrongl
-00006920: 7920 7468 696e 6b69 6e67 2065 7863 6861  y thinking excha
-00006930: 6e67 6520 7368 6f75 6c64 2068 6176 6520  nge should have 
-00006940: 6265 656e 206f 7065 6e20 6865 7265 2e0a  been open here..
-00006950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006960: 2020 2020 2020 2020 2020 2020 6578 7069              expi
-00006970: 7265 6420 3d20 5472 7565 0a20 2020 2020  red = True.     
-00006980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006990: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000069a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069b0: 2020 2020 2072 6169 7365 2065 0a20 2020       raise e.   
-000069c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069d0: 2069 6620 6578 7069 7265 643a 0a20 2020   if expired:.   
-000069e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069f0: 2020 2020 2073 656c 662e 6820 3d20 7365       self.h = se
-00006a00: 6c66 2e68 2e69 6c6f 635b 3a69 6478 305d  lf.h.iloc[:idx0]
-00006a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006a20: 2020 2020 2020 2020 2068 5f69 6e74 6572           h_inter
-00006a30: 7661 6c5f 6474 7320 3d20 685f 696e 7465  val_dts = h_inte
-00006a40: 7276 616c 5f64 7473 5b3a 6964 7830 5d0a  rval_dts[:idx0].
-00006a50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00006a60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00006a70: 2020 2065 7870 6972 6564 203d 206e 702e     expired = np.
-00006a80: 6172 7261 7928 5b46 616c 7365 5d2a 6e29  array([False]*n)
-00006a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006aa0: 2066 5f66 696e 616c 203d 2073 656c 662e   f_final = self.
-00006ab0: 685b 2246 696e 616c 3f22 5d2e 746f 5f6e  h["Final?"].to_n
-00006ac0: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
-00006ad0: 2020 2020 2020 2066 5f6e 6669 6e61 6c20         f_nfinal 
-00006ae0: 3d20 7e66 5f66 696e 616c 0a20 2020 2020  = ~f_final.     
-00006af0: 2020 2020 2020 2020 2020 2023 202d 2061             # - a
-00006b00: 6c73 6f20 7472 6561 7420 7265 7061 6972  lso treat repair
-00006b10: 6564 2064 6174 6120 6173 206e 6f6e 2d66  ed data as non-f
-00006b20: 696e 616c 2c20 6966 2066 6574 6368 6564  inal, if fetched
-00006b30: 206e 6561 7220 746f 2069 6e74 6572 7661   near to interva
-00006b40: 6c20 7469 6d65 706f 696e 740a 2020 2020  l timepoint.    
-00006b50: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00006b60: 6265 6361 7573 6520 5961 686f 6f20 6d69  because Yahoo mi
-00006b70: 6768 7420 6e6f 7720 6861 7665 2063 6f72  ght now have cor
-00006b80: 7265 6374 2064 6174 610a 2020 2020 2020  rect data.      
-00006b90: 2020 2020 2020 2020 2020 2320 2d20 616e            # - an
-00006ba0: 6420 7472 6561 7420 4e61 4e20 6461 7461  d treat NaN data
-00006bb0: 2061 7320 7265 7061 6972 6564 0a20 2020   as repaired.   
-00006bc0: 2020 2020 2020 2020 2020 2020 2063 7574               cut
-00006bd0: 6f66 665f 6474 203d 2064 745f 6e6f 7720  off_dt = dt_now 
-00006be0: 2d20 7469 6d65 6465 6c74 6128 6461 7973  - timedelta(days
-00006bf0: 3d37 290a 2020 2020 2020 2020 2020 2020  =7).            
-00006c00: 2020 2020 6964 7820 3d20 7365 6c66 2e68      idx = self.h
-00006c10: 2e69 6e64 6578 2e67 6574 5f69 6e64 6578  .index.get_index
-00006c20: 6572 285b 6375 746f 6666 5f64 745d 2c20  er([cutoff_dt], 
-00006c30: 6d65 7468 6f64 3d27 6266 696c 6c27 295b  method='bfill')[
-00006c40: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-00006c50: 2020 2066 5f72 6570 6169 7220 3d20 7365     f_repair = se
-00006c60: 6c66 2e68 5b22 5265 7061 6972 6564 3f22  lf.h["Repaired?"
-00006c70: 5d2e 746f 5f6e 756d 7079 2829 0a20 2020  ].to_numpy().   
-00006c80: 2020 2020 2020 2020 2020 2020 2066 5f6e               f_n
-00006c90: 6120 3d20 7365 6c66 2e68 5b27 436c 6f73  a = self.h['Clos
-00006ca0: 6527 5d2e 6973 6e61 2829 2e74 6f5f 6e75  e'].isna().to_nu
-00006cb0: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-00006cc0: 2020 2020 2020 665f 7265 7061 6972 203d        f_repair =
-00006cd0: 2066 5f72 6570 6169 7220 7c20 665f 6e61   f_repair | f_na
-00006ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006cf0: 2063 7574 6f66 665f 6474 7320 3d20 7365   cutoff_dts = se
-00006d00: 6c66 2e68 2e69 6e64 6578 202b 2073 656c  lf.h.index + sel
-00006d10: 662e 6974 6420 2b20 7469 6d65 6465 6c74  f.itd + timedelt
-00006d20: 6128 6461 7973 3d37 290a 2020 2020 2020  a(days=7).      
-00006d30: 2020 2020 2020 2020 2020 2320 4967 6e6f            # Igno
-00006d40: 7265 2072 6570 6169 7265 6420 6461 7461  re repaired data
-00006d50: 2069 6620 6665 7463 6865 642f 7265 7061   if fetched/repa
-00006d60: 6972 6564 2037 2b20 6461 7973 2061 6674  ired 7+ days aft
-00006d70: 6572 2069 6e74 6572 7661 6c20 656e 640a  er interval end.
-00006d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d90: 665f 7265 7061 6972 5b73 656c 662e 685b  f_repair[self.h[
-00006da0: 2746 6574 6368 4461 7465 275d 203e 2063  'FetchDate'] > c
-00006db0: 7574 6f66 665f 6474 735d 203d 2046 616c  utoff_dts] = Fal
-00006dc0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00006dd0: 2020 2069 6620 665f 7265 7061 6972 2e61     if f_repair.a
-00006de0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00006df0: 2020 2020 2020 2020 2020 665f 6e66 696e            f_nfin
-00006e00: 616c 203d 2066 5f6e 6669 6e61 6c20 7c20  al = f_nfinal | 
-00006e10: 665f 7265 7061 6972 0a20 2020 2020 2020  f_repair.       
-00006e20: 2020 2020 2020 2020 2066 6f72 2069 6478           for idx
-00006e30: 2069 6e20 6e70 2e77 6865 7265 2866 5f6e   in np.where(f_n
-00006e40: 6669 6e61 6c29 5b30 5d3a 0a20 2020 2020  final)[0]:.     
-00006e50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006e60: 2072 6570 6169 7265 6420 3d20 4661 6c73   repaired = Fals
-00006e70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00006e80: 2020 2020 2020 7265 7061 6972 6564 203d        repaired =
-00006e90: 2066 5f72 6570 6169 725b 6964 785d 0a20   f_repair[idx]. 
-00006ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006eb0: 2020 2068 5f69 6e74 6572 7661 6c5f 6474     h_interval_dt
-00006ec0: 203d 2068 5f69 6e74 6572 7661 6c5f 6474   = h_interval_dt
-00006ed0: 735b 6964 785d 0a20 2020 2020 2020 2020  s[idx].         
-00006ee0: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
-00006ef0: 5f64 7420 3d20 7966 6374 2e43 6f6e 7665  _dt = yfct.Conve
-00006f00: 7274 546f 4461 7465 7469 6d65 2873 656c  rtToDatetime(sel
-00006f10: 662e 685b 2246 6574 6368 4461 7465 225d  f.h["FetchDate"]
-00006f20: 2e69 6c6f 635b 6964 785d 2c20 747a 3d74  .iloc[idx], tz=t
-00006f30: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
-00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00006f60: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-00006f70: 6972 6564 5f69 6478 203d 2079 6663 742e  ired_idx = yfct.
-00006f80: 4973 5072 6963 6544 6174 6170 6f69 6e74  IsPriceDatapoint
-00006f90: 4578 7069 7265 6428 685f 696e 7465 7276  Expired(h_interv
-00006fa0: 616c 5f64 742c 2066 6574 6368 5f64 742c  al_dt, fetch_dt,
-00006fb0: 2072 6570 6169 7265 642c 206d 6178 5f61   repaired, max_a
-00006fc0: 6765 2c20 7365 6c66 2e65 7863 6861 6e67  ge, self.exchang
-00006fd0: 652c 2073 656c 662e 696e 7465 7276 616c  e, self.interval
-00006fe0: 2c20 7966 5f6c 6167 3d79 665f 6c61 672c  , yf_lag=yf_lag,
-00006ff0: 2074 7269 6767 6572 4578 7069 7279 4f6e   triggerExpiryOn
-00007000: 436c 6f73 653d 7472 6967 6765 725f 6174  Close=trigger_at
-00007010: 5f6d 6172 6b65 745f 636c 6f73 6529 0a20  _market_close). 
-00007020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007030: 2020 2065 7863 6570 7420 7966 6364 2e54     except yfcd.T
-00007040: 696d 6573 7461 6d70 4f75 7473 6964 6549  imestampOutsideI
-00007050: 6e74 6572 7661 6c45 7863 6570 7469 6f6e  ntervalException
-00007060: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00007070: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00007080: 6620 665f 6e61 5b69 6478 305d 3a0a 2020  f f_na[idx0]:.  
-00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070a0: 2020 2020 2020 2020 2020 2320 5946 4320            # YFC 
-000070b0: 6d75 7374 2068 6176 6520 696e 7365 7274  must have insert
-000070c0: 6564 2061 2072 6f77 206f 6620 4e61 4e73  ed a row of NaNs
-000070d0: 2c20 7772 6f6e 676c 7920 7468 696e 6b69  , wrongly thinki
-000070e0: 6e67 2065 7863 6861 6e67 6520 7368 6f75  ng exchange shou
-000070f0: 6c64 2068 6176 6520 6265 656e 206f 7065  ld have been ope
-00007100: 6e20 6865 7265 2e0a 2020 2020 2020 2020  n here..        
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 2020 2020 6578 7069 7265 645f 6964 7820      expired_idx 
-00007130: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-00007140: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00007150: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007170: 2072 6169 7365 2065 0a20 2020 2020 2020   raise e.       
-00007180: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-00007190: 6972 6564 5b69 6478 5d20 3d20 6578 7069  ired[idx] = expi
-000071a0: 7265 645f 6964 780a 2020 2020 2020 2020  red_idx.        
-000071b0: 2020 2020 2020 2020 6966 2065 7870 6972          if expir
-000071c0: 6564 2e61 6e79 2829 3a0a 2020 2020 2020  ed.any():.      
-000071d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000071e0: 6c66 2e68 203d 2073 656c 662e 682e 6472  lf.h = self.h.dr
-000071f0: 6f70 2873 656c 662e 682e 696e 6465 785b  op(self.h.index[
-00007200: 6578 7069 7265 645d 290a 2020 2020 2020  expired]).      
-00007210: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00007220: 696e 7465 7276 616c 5f64 7473 203d 2068  interval_dts = h
-00007230: 5f69 6e74 6572 7661 6c5f 6474 735b 7e65  _interval_dts[~e
-00007240: 7870 6972 6564 5d0a 2020 2020 2020 2020  xpired].        
-00007250: 2020 2020 6966 2073 656c 662e 682e 656d      if self.h.em
-00007260: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-00007270: 2020 2020 2073 656c 662e 6820 3d20 4e6f       self.h = No
-00007280: 6e65 0a0a 2020 2020 2020 2020 7261 6e67  ne..        rang
-00007290: 6573 5f74 6f5f 6665 7463 6820 3d20 5b5d  es_to_fetch = []
-000072a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000072b0: 2e68 2069 7320 4e6f 6e65 3a0a 2020 2020  .h is None:.    
-000072c0: 2020 2020 2020 2020 2320 5369 6d70 6c65          # Simple
-000072d0: 2c20 6a75 7374 2066 6574 6368 2074 6865  , just fetch the
-000072e0: 2072 6571 7565 7374 6564 2064 6174 610a   requested data.
-000072f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00007300: 7065 7269 6f64 2069 7320 6e6f 7420 4e6f  period is not No
-00007310: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00007320: 2020 2020 6820 3d20 7365 6c66 2e5f 6665      h = self._fe
-00007330: 7463 6859 6648 6973 746f 7279 2870 7374  tchYfHistory(pst
-00007340: 722c 204e 6f6e 652c 204e 6f6e 652c 2070  r, None, None, p
-00007350: 7265 706f 7374 2c20 6465 6275 675f 7966  repost, debug_yf
-00007360: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007370: 2020 6966 2068 2069 7320 4e6f 6e65 3a0a    if h is None:.
-00007380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007390: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-000073a0: 696f 6e28 6622 7b73 656c 662e 7469 636b  ion(f"{self.tick
-000073b0: 6572 7d3a 2046 6169 6c65 6420 746f 2066  er}: Failed to f
-000073c0: 6574 6368 2070 6572 696f 643d 7b70 6572  etch period={per
-000073d0: 696f 647d 2229 0a20 2020 2020 2020 2020  iod}").         
-000073e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000073f0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00007400: 2e63 6f6e 7469 6775 6f75 733a 0a20 2020  .contiguous:.   
-00007410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007420: 2023 2045 6e73 7572 6520 6461 696c 7920   # Ensure daily 
-00007430: 616c 7761 7973 2075 702d 746f 2d6e 6f77  always up-to-now
-00007440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007450: 2020 2020 2068 203d 2073 656c 662e 5f66       h = self._f
-00007460: 6574 6368 5966 4869 7374 6f72 7928 7073  etchYfHistory(ps
-00007470: 7472 2c20 7374 6172 742c 2074 6f6d 6f72  tr, start, tomor
-00007480: 726f 772c 2070 7265 706f 7374 2c20 6465  row, prepost, de
-00007490: 6275 675f 7966 290a 2020 2020 2020 2020  bug_yf).        
-000074a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000074b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074c0: 2020 6820 3d20 7365 6c66 2e5f 6665 7463    h = self._fetc
-000074d0: 6859 6648 6973 746f 7279 2870 7374 722c  hYfHistory(pstr,
-000074e0: 2073 7461 7274 2c20 656e 642c 2070 7265   start, end, pre
-000074f0: 706f 7374 2c20 6465 6275 675f 7966 290a  post, debug_yf).
-00007500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007510: 6966 2068 2069 7320 4e6f 6e65 3a0a 2020  if h is None:.  
-00007520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007530: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00007540: 6e28 6622 7b73 656c 662e 7469 636b 6572  n(f"{self.ticker
-00007550: 7d3a 2046 6169 6c65 6420 746f 2066 6574  }: Failed to fet
-00007560: 6368 2064 6174 6520 7261 6e67 6520 7b73  ch date range {s
-00007570: 7461 7274 7d2d 3e7b 656e 647d 2229 0a0a  tart}->{end}")..
-00007580: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-00007590: 6a75 7374 0a20 2020 2020 2020 2020 2020  just.           
-000075a0: 2068 203d 2073 656c 662e 5f72 6576 6572   h = self._rever
-000075b0: 7365 5961 686f 6f41 646a 7573 7428 6829  seYahooAdjust(h)
-000075c0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-000075d0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-000075e0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-000075f0: 4461 7973 313a 0a20 2020 2020 2020 2020  Days1:.         
-00007600: 2020 2020 2020 2068 5f73 706c 6974 7320         h_splits 
-00007610: 3d20 685b 685b 2253 746f 636b 2053 706c  = h[h["Stock Spl
-00007620: 6974 7322 5d20 213d 2030 5d0a 2020 2020  its"] != 0].    
-00007630: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00007640: 656e 2868 5f73 706c 6974 7329 203e 2030  en(h_splits) > 0
-00007650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007660: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-00007670: 6572 2e47 6574 4869 7374 6f72 7928 2245  er.GetHistory("E
-00007680: 7665 6e74 7322 292e 5570 6461 7465 5370  vents").UpdateSp
-00007690: 6c69 7473 2868 5f73 706c 6974 7329 0a0a  lits(h_splits)..
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 685f 6469 7673 203d 2068 5b68 5b22 4469  h_divs = h[h["Di
-000076c0: 7669 6465 6e64 7322 5d20 213d 2030 5d5b  vidends"] != 0][
-000076d0: 5b22 4469 7669 6465 6e64 7322 2c20 2246  ["Dividends", "F
-000076e0: 6574 6368 4461 7465 225d 5d2e 636f 7079  etchDate"]].copy
-000076f0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00007700: 2020 2069 6620 6c65 6e28 685f 6469 7673     if len(h_divs
-00007710: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00007720: 2020 2020 2020 2020 2020 2066 5f64 7570             f_dup
-00007730: 7320 3d20 685f 6469 7673 2e69 6e64 6578  s = h_divs.index
-00007740: 2e64 7570 6c69 6361 7465 6428 290a 2020  .duplicated().  
-00007750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007760: 2020 6966 2066 5f64 7570 732e 616e 7928    if f_dups.any(
-00007770: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00007780: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00007790: 2868 5f64 6976 7329 0a20 2020 2020 2020  (h_divs).       
-000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077b0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-000077c0: 2822 4475 706c 6963 6174 6573 2064 6574  ("Duplicates det
-000077d0: 6563 7465 6420 696e 2068 5f64 6976 7322  ected in h_divs"
-000077e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000077f0: 2020 2020 2020 6361 6368 6564 5f6e 6577        cached_new
-00007800: 5f64 6976 7320 3d20 7966 636d 2e52 6561  _divs = yfcm.Rea
-00007810: 6443 6163 6865 4461 7475 6d28 7365 6c66  dCacheDatum(self
-00007820: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
-00007830: 7673 2229 0a20 2020 2020 2020 2020 2020  vs").           
-00007840: 2020 2020 2020 2020 2069 6620 6361 6368           if cach
-00007850: 6564 5f6e 6577 5f64 6976 7320 6973 206e  ed_new_divs is n
-00007860: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007880: 2068 5f64 6976 7320 3d20 685f 6469 7673   h_divs = h_divs
-00007890: 5b7e 685f 6469 7673 2e69 6e64 6578 2e69  [~h_divs.index.i
-000078a0: 7369 6e28 6361 6368 6564 5f6e 6577 5f64  sin(cached_new_d
-000078b0: 6976 732e 696e 6465 7829 5d0a 2020 2020  ivs.index)].    
-000078c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078d0: 2020 2020 6966 206e 6f74 2068 5f64 6976      if not h_div
-000078e0: 732e 656d 7074 793a 0a20 2020 2020 2020  s.empty:.       
-000078f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007900: 2020 2020 2069 6620 7966 636d 2e52 6561       if yfcm.Rea
-00007910: 6443 6163 6865 4d65 7461 6461 7461 2873  dCacheMetadata(s
-00007920: 656c 662e 7469 636b 6572 2c20 226e 6577  elf.ticker, "new
-00007930: 5f64 6976 7322 2c20 226c 6f63 6b65 6422  _divs", "locked"
-00007940: 2920 6973 206e 6f74 204e 6f6e 653a 0a20  ) is not None:. 
-00007950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007960: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007970: 206c 6f63 6b65 640a 2020 2020 2020 2020   locked.        
-00007980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007990: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-000079a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000079c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000079e0: 6163 6865 645f 6e65 775f 6469 7673 203d  ached_new_divs =
-000079f0: 2070 642e 636f 6e63 6174 285b 6361 6368   pd.concat([cach
-00007a00: 6564 5f6e 6577 5f64 6976 732c 2068 5f64  ed_new_divs, h_d
-00007a10: 6976 735d 290a 2020 2020 2020 2020 2020  ivs]).          
-00007a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a30: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-00007a40: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-00007a50: 7469 636b 6572 2c20 226e 6577 5f64 6976  ticker, "new_div
-00007a60: 7322 2c20 6361 6368 6564 5f6e 6577 5f64  s", cached_new_d
-00007a70: 6976 7329 0a20 2020 2020 2020 2020 2020  ivs).           
-00007a80: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00007a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007aa0: 2020 2020 2020 2079 6663 6d2e 5374 6f72         yfcm.Stor
-00007ab0: 6543 6163 6865 4461 7475 6d28 7365 6c66  eCacheDatum(self
-00007ac0: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
-00007ad0: 7673 222c 2068 5f64 6976 732e 636f 7079  vs", h_divs.copy
-00007ae0: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-00007af0: 2073 656c 662e 5f75 7064 6174 6564 4361   self._updatedCa
-00007b00: 6368 6564 5072 6963 6573 2868 290a 0a20  chedPrices(h).. 
-00007b10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007b20: 2020 2020 2020 2020 2023 2043 6f6d 7061           # Compa
-00007b30: 7265 2072 6571 7565 7374 2061 6761 696e  re request again
-00007b40: 7374 2063 6163 6865 6420 6461 7461 2c20  st cached data, 
-00007b50: 6f6e 6c79 2066 6574 6368 206d 6973 7369  only fetch missi
-00007b60: 6e67 2f65 7870 6972 6564 2064 6174 610a  ng/expired data.
-00007b70: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00007b80: 6572 666f 726d 616e 6365 2054 4f44 4f3a  erformance TODO:
-00007b90: 2074 6167 2072 6f77 7320 6173 2066 756c   tag rows as ful
-00007ba0: 6c79 2063 6f6e 7469 6775 6f75 7320 746f  ly contiguous to
-00007bb0: 2061 766f 6964 2073 6561 7263 6869 6e67   avoid searching
-00007bc0: 2066 6f72 2067 6170 730a 0a20 2020 2020   for gaps..     
-00007bd0: 2020 2020 2020 2023 2043 616c 6375 6c61         # Calcula
-00007be0: 7465 2072 616e 6765 735f 746f 5f66 6574  te ranges_to_fet
-00007bf0: 6368 0a20 2020 2020 2020 2020 2020 2069  ch.            i
-00007c00: 6620 7365 6c66 2e63 6f6e 7469 6775 6f75  f self.contiguou
-00007c10: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00007c20: 2020 2069 6620 7365 6c66 2e68 2069 7320     if self.h is 
-00007c30: 4e6f 6e65 206f 7220 7365 6c66 2e68 2e65  None or self.h.e
-00007c40: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-00007c50: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00007c60: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 6966 2073 656c 662e 6d75 6c74      if self.mult
-00007c90: 6964 6179 3a0a 2020 2020 2020 2020 2020  iday:.          
-00007ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007cb0: 2020 7261 6e67 6573 5f74 6f5f 6665 7463    ranges_to_fetc
-00007cc0: 6820 3d20 7966 6374 2e49 6465 6e74 6966  h = yfct.Identif
-00007cd0: 794d 6973 7369 6e67 496e 7465 7276 616c  yMissingInterval
-00007ce0: 5261 6e67 6573 2873 656c 662e 6578 6368  Ranges(self.exch
-00007cf0: 616e 6765 2c20 7374 6172 745f 642c 2065  ange, start_d, e
-00007d00: 6e64 5f64 2b73 656c 662e 6974 642c 2073  nd_d+self.itd, s
-00007d10: 656c 662e 696e 7465 7276 616c 2c20 5b5d  elf.interval, []
-00007d20: 2c20 6d69 6e44 6973 7461 6e63 6554 6872  , minDistanceThr
-00007d30: 6573 686f 6c64 3d35 290a 2020 2020 2020  eshold=5).      
-00007d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00007d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d70: 2020 2020 7261 6e67 6573 5f74 6f5f 6665      ranges_to_fe
-00007d80: 7463 6820 3d20 7966 6374 2e49 6465 6e74  tch = yfct.Ident
-00007d90: 6966 794d 6973 7369 6e67 496e 7465 7276  ifyMissingInterv
-00007da0: 616c 5261 6e67 6573 2873 656c 662e 6578  alRanges(self.ex
-00007db0: 6368 616e 6765 2c20 7374 6172 745f 642c  change, start_d,
-00007dc0: 2065 6e64 5f64 2c20 7365 6c66 2e69 6e74   end_d, self.int
-00007dd0: 6572 7661 6c2c 205b 5d2c 206d 696e 4469  erval, [], minDi
-00007de0: 7374 616e 6365 5468 7265 7368 6f6c 643d  stanceThreshold=
-00007df0: 3529 0a20 2020 2020 2020 2020 2020 2020  5).             
-00007e00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e20: 2020 2020 2072 616e 6765 735f 746f 5f66       ranges_to_f
-00007e30: 6574 6368 203d 2079 6663 742e 4964 656e  etch = yfct.Iden
-00007e40: 7469 6679 4d69 7373 696e 6749 6e74 6572  tifyMissingInter
-00007e50: 7661 6c52 616e 6765 7328 7365 6c66 2e65  valRanges(self.e
-00007e60: 7863 6861 6e67 652c 2073 7461 7274 2c20  xchange, start, 
-00007e70: 656e 642c 2073 656c 662e 696e 7465 7276  end, self.interv
-00007e80: 616c 2c20 5b5d 2c20 6d69 6e44 6973 7461  al, [], minDista
-00007e90: 6e63 6554 6872 6573 686f 6c64 3d35 290a  nceThreshold=5).
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007eb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00007ec0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
-00007ed0: 7265 2074 6861 7420 6461 696c 7920 6461  re that daily da
-00007ee0: 7461 2061 6c77 6179 7320 7570 2d74 6f2d  ta always up-to-
-00007ef0: 6461 7465 2074 6f20 6e6f 770a 2020 2020  date to now.    
-00007f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f10: 2320 5570 6461 7465 3a20 6f6e 6c79 206e  # Update: only n
-00007f20: 6563 6573 7361 7279 2074 6f20 6265 2075  ecessary to be u
-00007f30: 702d 746f 2d64 6174 6520 746f 206e 6f77  p-to-date to now
-00007f40: 2069 6620 6120 6665 7463 6820 6861 7070   if a fetch happ
-00007f50: 656e 730a 2020 2020 2020 2020 2020 2020  ens.            
-00007f60: 2020 2020 2020 2020 6474 5f73 7461 7274          dt_start
-00007f70: 203d 2079 6663 742e 436f 6e76 6572 7454   = yfct.ConvertT
-00007f80: 6f44 6174 6574 696d 6528 7365 6c66 2e68  oDatetime(self.h
-00007f90: 2e69 6e64 6578 5b30 5d2c 2074 7a3d 747a  .index[0], tz=tz
-00007fa0: 5f65 7863 6861 6e67 6529 0a20 2020 2020  _exchange).     
-00007fb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00007fc0: 745f 656e 6420 3d20 7966 6374 2e43 6f6e  t_end = yfct.Con
-00007fd0: 7665 7274 546f 4461 7465 7469 6d65 2873  vertToDatetime(s
-00007fe0: 656c 662e 682e 696e 6465 785b 2d31 5d2c  elf.h.index[-1],
-00007ff0: 2074 7a3d 747a 5f65 7863 6861 6e67 6529   tz=tz_exchange)
-00008000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008010: 2020 2020 2068 5f73 7461 7274 203d 2079       h_start = y
-00008020: 6663 742e 4765 7454 696d 6573 7461 6d70  fct.GetTimestamp
-00008030: 4375 7272 656e 7449 6e74 6572 7661 6c28  CurrentInterval(
-00008040: 7365 6c66 2e65 7863 6861 6e67 652c 2064  self.exchange, d
-00008050: 745f 7374 6172 742c 2073 656c 662e 696e  t_start, self.in
-00008060: 7465 7276 616c 2c20 6967 6e6f 7265 5f62  terval, ignore_b
-00008070: 7265 616b 733d 5472 7565 295b 2269 6e74  reaks=True)["int
-00008080: 6572 7661 6c5f 6f70 656e 225d 0a20 2020  erval_open"].   
-00008090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080a0: 206c 6173 745f 696e 7465 7276 616c 203d   last_interval =
-000080b0: 2079 6663 742e 4765 7454 696d 6573 7461   yfct.GetTimesta
-000080c0: 6d70 4375 7272 656e 7449 6e74 6572 7661  mpCurrentInterva
-000080d0: 6c28 7365 6c66 2e65 7863 6861 6e67 652c  l(self.exchange,
-000080e0: 2064 745f 656e 642c 2073 656c 662e 696e   dt_end, self.in
-000080f0: 7465 7276 616c 2c20 6967 6e6f 7265 5f62  terval, ignore_b
-00008100: 7265 616b 733d 5472 7565 290a 2020 2020  reaks=True).    
-00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008120: 6966 206c 6173 745f 696e 7465 7276 616c  if last_interval
-00008130: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00005990: 6420 3d20 656e 645f 640a 2020 2020 2020  d = end_d.      
+000059a0: 2020 2020 2020 2020 2020 7374 6172 745f            start_
+000059b0: 6474 203d 2064 6174 6574 696d 652e 636f  dt = datetime.co
+000059c0: 6d62 696e 6528 7374 6172 745f 642c 2074  mbine(start_d, t
+000059d0: 696d 6528 3029 2c20 747a 5f65 7863 6861  ime(0), tz_excha
+000059e0: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
+000059f0: 2020 2020 2065 6e64 5f64 7420 3d20 6461       end_dt = da
+00005a00: 7465 7469 6d65 2e63 6f6d 6269 6e65 2865  tetime.combine(e
+00005a10: 6e64 5f64 2c20 7469 6d65 2830 292c 2074  nd_d, time(0), t
+00005a20: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
+00005a30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00005a40: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00005a50: 6172 7420 3d20 6461 7465 7469 6d65 2e63  art = datetime.c
+00005a60: 6f6d 6269 6e65 2873 7461 7274 5f64 2c20  ombine(start_d, 
+00005a70: 7469 6d65 2830 292c 2074 7a5f 6578 6368  time(0), tz_exch
+00005a80: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+00005a90: 2020 2020 2020 656e 6420 3d20 4e6f 6e65        end = None
+00005aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ab0: 2073 7461 7274 5f64 7420 3d20 7374 6172   start_dt = star
+00005ac0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00005ad0: 2020 656e 645f 6474 203d 204e 6f6e 650a    end_dt = None.
+00005ae0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00005af0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00005b00: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
+00005b10: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00005b20: 745f 6474 203d 2064 6174 6574 696d 652e  t_dt = datetime.
+00005b30: 636f 6d62 696e 6528 7374 6172 742c 2074  combine(start, t
+00005b40: 696d 6528 3029 2c20 747a 5f65 7863 6861  ime(0), tz_excha
+00005b50: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
+00005b60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00005b70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00005b80: 616e 6365 2873 7461 7274 2c20 6461 7465  ance(start, date
+00005b90: 7469 6d65 293a 0a20 2020 2020 2020 2020  time):.         
+00005ba0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00005bb0: 5f64 7420 3d20 7374 6172 740a 2020 2020  _dt = start.    
+00005bc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00005bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005be0: 2020 2020 2020 7374 6172 745f 6474 203d        start_dt =
+00005bf0: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00005c00: 6528 7374 6172 742c 2074 696d 6528 3029  e(start, time(0)
+00005c10: 2c20 747a 5f65 7863 6861 6e67 6529 0a20  , tz_exchange). 
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c30: 2020 2073 7461 7274 203d 2073 7461 7274     start = start
+00005c40: 5f64 740a 0a20 2020 2020 2020 2069 6620  _dt..        if 
+00005c50: 656e 6420 6973 204e 6f6e 6520 616e 6420  end is None and 
+00005c60: 7073 7472 2069 7320 4e6f 6e65 3a0a 2020  pstr is None:.  
+00005c70: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00005c80: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
+00005c90: 2020 2020 2020 2020 2020 2020 656e 6420              end 
+00005ca0: 3d20 645f 6e6f 775f 6578 6368 616e 6765  = d_now_exchange
+00005cb0: 2b74 645f 3164 0a20 2020 2020 2020 2020  +td_1d.         
+00005cc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00005cd0: 2020 2020 2020 2020 2073 6368 6564 203d           sched =
+00005ce0: 2079 6663 742e 4765 7445 7863 6861 6e67   yfct.GetExchang
+00005cf0: 6553 6368 6564 756c 6528 7365 6c66 2e65  eSchedule(self.e
+00005d00: 7863 6861 6e67 652c 2064 5f6e 6f77 5f65  xchange, d_now_e
+00005d10: 7863 6861 6e67 652c 2064 5f6e 6f77 5f65  xchange, d_now_e
+00005d20: 7863 6861 6e67 652b 7464 5f31 6429 0a20  xchange+td_1d). 
+00005d30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00005d40: 6620 7363 6865 6420 6973 204e 6f6e 6520  f sched is None 
+00005d50: 6f72 2028 6474 5f6e 6f77 202b 2079 665f  or (dt_now + yf_
+00005d60: 6c61 6729 203c 2073 6368 6564 5b22 6f70  lag) < sched["op
+00005d70: 656e 225d 2e69 6c6f 635b 305d 3a0a 2020  en"].iloc[0]:.  
+00005d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005d90: 2020 2320 4265 666f 7265 206d 6172 6b65    # Before marke
+00005da0: 7420 6f70 656e 0a20 2020 2020 2020 2020  t open.         
+00005db0: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
+00005dc0: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00005dd0: 6528 645f 6e6f 775f 6578 6368 616e 6765  e(d_now_exchange
+00005de0: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
+00005df0: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+00005e00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00005e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e20: 2020 6920 3d20 7966 6374 2e47 6574 5469    i = yfct.GetTi
+00005e30: 6d65 7374 616d 7043 7572 7265 6e74 496e  mestampCurrentIn
+00005e40: 7465 7276 616c 2873 656c 662e 6578 6368  terval(self.exch
+00005e50: 616e 6765 2c20 6474 5f6e 6f77 2b79 665f  ange, dt_now+yf_
+00005e60: 6c61 672c 2073 656c 662e 696e 7465 7276  lag, self.interv
+00005e70: 616c 2c20 6967 6e6f 7265 5f62 7265 616b  al, ignore_break
+00005e80: 733d 5472 7565 290a 2020 2020 2020 2020  s=True).        
+00005e90: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00005ea0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00005eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005ec0: 2020 2320 4166 7465 7220 696e 7465 7276    # After interv
+00005ed0: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
+00005ee0: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
+00005ef0: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00005f00: 6528 645f 6e6f 775f 6578 6368 616e 6765  e(d_now_exchange
+00005f10: 2b74 645f 3164 2c20 7469 6d65 2830 292c  +td_1d, time(0),
+00005f20: 2074 7a5f 6578 6368 616e 6765 290a 2020   tz_exchange).  
+00005f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005f60: 2320 4475 7269 6e67 2069 6e74 6572 7661  # During interva
+00005f70: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00005f80: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
+00005f90: 695b 2269 6e74 6572 7661 6c5f 636c 6f73  i["interval_clos
+00005fa0: 6522 5d0a 2020 2020 2020 2020 6966 2065  e"].        if e
+00005fb0: 6e64 2069 7320 6e6f 7420 4e6f 6e65 2061  nd is not None a
+00005fc0: 6e64 2065 6e64 5f64 7420 6973 204e 6f6e  nd end_dt is Non
+00005fd0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00005fe0: 6620 6973 696e 7374 616e 6365 2865 6e64  f isinstance(end
+00005ff0: 2c20 6461 7465 7469 6d65 293a 0a20 2020  , datetime):.   
+00006000: 2020 2020 2020 2020 2020 2020 2065 6e64               end
+00006010: 5f64 7420 3d20 656e 640a 2020 2020 2020  _dt = end.      
+00006020: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006030: 2020 2020 2020 2020 2020 2020 2320 656e              # en
+00006040: 645f 6474 203d 2064 6174 6574 696d 652e  d_dt = datetime.
+00006050: 636f 6d62 696e 6528 656e 642b 7464 5f31  combine(end+td_1
+00006060: 642c 2074 696d 6528 3029 2c20 747a 5f65  d, time(0), tz_e
+00006070: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
+00006080: 2020 2020 2020 2020 2065 6e64 5f64 7420           end_dt 
+00006090: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+000060a0: 6e65 2865 6e64 2c20 7469 6d65 2830 292c  ne(end, time(0),
+000060b0: 2074 7a5f 6578 6368 616e 6765 290a 2020   tz_exchange).  
+000060c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000060d0: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
+000060e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060f0: 656e 6420 3d20 656e 645f 6474 0a0a 2020  end = end_dt..  
+00006100: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+00006110: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
+00006120: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00006130: 6528 7374 6172 742c 2064 6174 6574 696d  e(start, datetim
+00006140: 6529 206f 7220 6973 696e 7374 616e 6365  e) or isinstance
+00006150: 2865 6e64 2c20 6461 7465 7469 6d65 293a  (end, datetime):
+00006160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006170: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+00006180: 2866 2227 7374 6172 7427 2061 6e64 2027  (f"'start' and '
+00006190: 656e 6427 206d 7573 7420 6265 2064 6174  end' must be dat
+000061a0: 6520 7479 7065 206e 6f74 207b 7479 7065  e type not {type
+000061b0: 2873 7461 7274 297d 2c20 7b74 7970 6528  (start)}, {type(
+000061c0: 656e 6429 7d22 290a 2020 2020 2020 2020  end)}").        
+000061d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000061e0: 2020 6966 2028 6e6f 7420 6973 696e 7374    if (not isinst
+000061f0: 616e 6365 2873 7461 7274 2c20 6461 7465  ance(start, date
+00006200: 7469 6d65 2929 2061 6e64 2028 6e6f 7420  time)) and (not 
+00006210: 6973 696e 7374 616e 6365 2865 6e64 2c20  isinstance(end, 
+00006220: 6461 7465 7469 6d65 2929 3a0a 2020 2020  datetime)):.    
+00006230: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00006240: 6520 5479 7065 4572 726f 7228 6622 2773  e TypeError(f"'s
+00006250: 7461 7274 2720 616e 6420 2765 6e64 2720  tart' and 'end' 
+00006260: 6d75 7374 2062 6520 6461 7465 7469 6d65  must be datetime
+00006270: 2074 7970 6520 6e6f 7420 7b74 7970 6528   type not {type(
+00006280: 7374 6172 7429 7d2c 207b 7479 7065 2865  start)}, {type(e
+00006290: 6e64 297d 2229 0a0a 2020 2020 2020 2020  nd)}")..        
+000062a0: 6c69 7374 696e 675f 6461 7465 203d 2079  listing_date = y
+000062b0: 6663 6d2e 5265 6164 4361 6368 6544 6174  fcm.ReadCacheDat
+000062c0: 756d 2873 656c 662e 7469 636b 6572 2c20  um(self.ticker, 
+000062d0: 226c 6973 7469 6e67 5f64 6174 6522 290a  "listing_date").
+000062e0: 2020 2020 2020 2020 6966 206c 6973 7469          if listi
+000062f0: 6e67 5f64 6174 6520 6973 206e 6f74 204e  ng_date is not N
+00006300: 6f6e 6520 616e 6420 7374 6172 7420 6973  one and start is
+00006310: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00006320: 2020 2020 2020 206c 6973 7469 6e67 5f64         listing_d
+00006330: 6174 655f 6474 203d 2064 6174 6574 696d  ate_dt = datetim
+00006340: 652e 636f 6d62 696e 6528 6c69 7374 696e  e.combine(listin
+00006350: 675f 6461 7465 2c20 7469 6d65 2830 292c  g_date, time(0),
+00006360: 2074 7a5f 6578 6368 616e 6765 290a 2020   tz_exchange).  
+00006370: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00006380: 6e73 7461 6e63 6528 7374 6172 742c 2064  nstance(start, d
+00006390: 6174 6574 696d 6529 3a0a 2020 2020 2020  atetime):.      
+000063a0: 2020 2020 2020 2020 2020 7374 6172 7420            start 
+000063b0: 3d20 6d61 7828 7374 6172 742c 206c 6973  = max(start, lis
+000063c0: 7469 6e67 5f64 6174 655f 6474 290a 2020  ting_date_dt).  
+000063d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063f0: 7374 6172 7420 3d20 6d61 7828 7374 6172  start = max(star
+00006400: 742c 206c 6973 7469 6e67 5f64 6174 6529  t, listing_date)
+00006410: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00006420: 662e 6820 6973 206e 6f74 204e 6f6e 653a  f.h is not None:
+00006430: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00006440: 7365 6c66 2e68 2e65 6d70 7479 3a0a 2020  self.h.empty:.  
+00006450: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00006460: 6c66 2e68 203d 204e 6f6e 650a 0a20 2020  lf.h = None..   
+00006470: 2020 2020 2023 2052 656d 6f76 6520 6578       # Remove ex
+00006480: 7069 7265 6420 696e 7465 7276 616c 7320  pired intervals 
+00006490: 6672 6f6d 2063 6163 6865 0a20 2020 2020  from cache.     
+000064a0: 2020 2069 6620 7365 6c66 2e68 2069 7320     if self.h is 
+000064b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000064c0: 2020 2020 2020 6e20 3d20 7365 6c66 2e68        n = self.h
+000064d0: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+000064e0: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+000064f0: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
+00006500: 2020 2020 2020 2020 685f 696e 7465 7276          h_interv
+00006510: 616c 5f64 7473 203d 2073 656c 662e 682e  al_dts = self.h.
+00006520: 696e 6465 782e 6461 7465 2069 6620 6973  index.date if is
+00006530: 696e 7374 616e 6365 2873 656c 662e 682e  instance(self.h.
+00006540: 696e 6465 785b 305d 2c20 7064 2e54 696d  index[0], pd.Tim
+00006550: 6573 7461 6d70 2920 656c 7365 2073 656c  estamp) else sel
+00006560: 662e 682e 696e 6465 780a 2020 2020 2020  f.h.index.      
+00006570: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006580: 2020 2020 2020 2020 2020 2020 685f 696e              h_in
+00006590: 7465 7276 616c 5f64 7473 203d 206e 702e  terval_dts = np.
+000065a0: 6172 7261 7928 5b79 6663 742e 436f 6e76  array([yfct.Conv
+000065b0: 6572 7454 6f44 6174 6574 696d 6528 6474  ertToDatetime(dt
+000065c0: 2c20 747a 3d74 7a5f 6578 6368 616e 6765  , tz=tz_exchange
+000065d0: 2920 666f 7220 6474 2069 6e20 7365 6c66  ) for dt in self
+000065e0: 2e68 2e69 6e64 6578 5d29 0a20 2020 2020  .h.index]).     
+000065f0: 2020 2020 2020 2068 5f69 6e74 6572 7661         h_interva
+00006600: 6c5f 6474 7320 3d20 6e70 2e61 7272 6179  l_dts = np.array
+00006610: 2868 5f69 6e74 6572 7661 6c5f 6474 7329  (h_interval_dts)
+00006620: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+00006630: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+00006640: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+00006650: 2e44 6179 7331 3a0a 2020 2020 2020 2020  .Days1:.        
+00006660: 2020 2020 6966 2073 656c 662e 636f 6e74      if self.cont
+00006670: 6967 756f 7573 3a0a 2020 2020 2020 2020  iguous:.        
+00006680: 2020 2020 2020 2020 2320 4461 696c 7920          # Daily 
+00006690: 6461 7461 2069 7320 616c 7761 7973 2063  data is always c
+000066a0: 6f6e 7469 6775 6f75 7320 736f 206f 6e6c  ontiguous so onl
+000066b0: 7920 6e65 6564 2074 6f20 6368 6563 6b20  y need to check 
+000066c0: 6c61 7374 2072 6f77 0a20 2020 2020 2020  last row.       
+000066d0: 2020 2020 2020 2020 2068 5f69 6e74 6572           h_inter
+000066e0: 7661 6c5f 6474 203d 2068 5f69 6e74 6572  val_dt = h_inter
+000066f0: 7661 6c5f 6474 735b 2d31 5d0a 2020 2020  val_dts[-1].    
+00006700: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00006710: 685f 6474 203d 2079 6663 742e 436f 6e76  h_dt = yfct.Conv
+00006720: 6572 7454 6f44 6174 6574 696d 6528 7365  ertToDatetime(se
+00006730: 6c66 2e68 5b22 4665 7463 6844 6174 6522  lf.h["FetchDate"
+00006740: 5d2e 696c 6f63 5b2d 315d 2c20 747a 3d74  ].iloc[-1], tz=t
+00006750: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
+00006760: 2020 2020 2020 2020 2020 2020 665f 6669              f_fi
+00006770: 6e61 6c20 3d20 7365 6c66 2e68 5b22 4669  nal = self.h["Fi
+00006780: 6e61 6c3f 225d 2e74 6f5f 6e75 6d70 7928  nal?"].to_numpy(
+00006790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000067a0: 2020 665f 6e66 696e 616c 203d 207e 665f    f_nfinal = ~f_
+000067b0: 6669 6e61 6c0a 2020 2020 2020 2020 2020  final.          
+000067c0: 2020 2020 2020 2320 2d20 616c 736f 2074        # - also t
+000067d0: 7265 6174 2072 6570 6169 7265 6420 6461  reat repaired da
+000067e0: 7461 2061 7320 6e6f 6e2d 6669 6e61 6c2c  ta as non-final,
+000067f0: 2069 6620 6665 7463 6865 6420 6e65 6172   if fetched near
+00006800: 2074 6f20 696e 7465 7276 616c 2074 696d   to interval tim
+00006810: 6570 6f69 6e74 0a20 2020 2020 2020 2020  epoint.         
+00006820: 2020 2020 2020 2023 2020 2062 6563 6175         #   becau
+00006830: 7365 2059 6168 6f6f 206d 6967 6874 206e  se Yahoo might n
+00006840: 6f77 2068 6176 6520 636f 7272 6563 7420  ow have correct 
+00006850: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+00006860: 2020 2020 2023 202d 2061 6e64 2074 7265       # - and tre
+00006870: 6174 204e 614e 2064 6174 6120 6173 2072  at NaN data as r
+00006880: 6570 6169 7265 640a 2020 2020 2020 2020  epaired.        
+00006890: 2020 2020 2020 2020 665f 7265 7061 6972          f_repair
+000068a0: 203d 2073 656c 662e 685b 2252 6570 6169   = self.h["Repai
+000068b0: 7265 643f 225d 2e74 6f5f 6e75 6d70 7928  red?"].to_numpy(
+000068c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000068d0: 2020 665f 6e61 203d 2073 656c 662e 685b    f_na = self.h[
+000068e0: 2743 6c6f 7365 275d 2e69 736e 6128 292e  'Close'].isna().
+000068f0: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
+00006900: 2020 2020 2020 2020 2020 2066 5f72 6570             f_rep
+00006910: 6169 7220 3d20 665f 7265 7061 6972 207c  air = f_repair |
+00006920: 2066 5f6e 610a 2020 2020 2020 2020 2020   f_na.          
+00006930: 2020 2020 2020 6375 746f 6666 5f64 7473        cutoff_dts
+00006940: 203d 2073 656c 662e 682e 696e 6465 7820   = self.h.index 
+00006950: 2b20 7365 6c66 2e69 7464 202b 2074 696d  + self.itd + tim
+00006960: 6564 656c 7461 2864 6179 733d 3729 0a20  edelta(days=7). 
+00006970: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00006980: 2049 676e 6f72 6520 7265 7061 6972 6564   Ignore repaired
+00006990: 2064 6174 6120 6966 2066 6574 6368 6564   data if fetched
+000069a0: 2f72 6570 6169 7265 6420 372b 2064 6179  /repaired 7+ day
+000069b0: 7320 6166 7465 7220 696e 7465 7276 616c  s after interval
+000069c0: 2065 6e64 0a20 2020 2020 2020 2020 2020   end.           
+000069d0: 2020 2020 2066 5f72 6570 6169 725b 7365       f_repair[se
+000069e0: 6c66 2e68 5b27 4665 7463 6844 6174 6527  lf.h['FetchDate'
+000069f0: 5d20 3e20 6375 746f 6666 5f64 7473 5d20  ] > cutoff_dts] 
+00006a00: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00006a10: 2020 2020 2020 2020 6966 2066 5f72 6570          if f_rep
+00006a20: 6169 722e 616e 7928 293a 0a20 2020 2020  air.any():.     
+00006a30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006a40: 5f6e 6669 6e61 6c20 3d20 665f 6e66 696e  _nfinal = f_nfin
+00006a50: 616c 207c 2066 5f72 6570 6169 720a 2020  al | f_repair.  
+00006a60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00006a70: 2066 5f6e 6669 6e61 6c2e 616e 7928 293a   f_nfinal.any():
+00006a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a90: 2020 2020 2069 6478 3020 3d20 6e70 2e77       idx0 = np.w
+00006aa0: 6865 7265 2866 5f6e 6669 6e61 6c29 5b30  here(f_nfinal)[0
+00006ab0: 5d5b 305d 0a20 2020 2020 2020 2020 2020  ][0].           
+00006ac0: 2020 2020 2020 2020 2072 6570 6169 7265           repaire
+00006ad0: 6420 3d20 665f 7265 7061 6972 5b69 6478  d = f_repair[idx
+00006ae0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00006af0: 2020 2020 2020 2068 5f69 6e74 6572 7661         h_interva
+00006b00: 6c5f 6474 203d 2068 5f69 6e74 6572 7661  l_dt = h_interva
+00006b10: 6c5f 6474 735b 6964 7830 5d0a 2020 2020  l_dts[idx0].    
+00006b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b30: 6665 7463 685f 6474 203d 2079 6663 742e  fetch_dt = yfct.
+00006b40: 436f 6e76 6572 7454 6f44 6174 6574 696d  ConvertToDatetim
+00006b50: 6528 7365 6c66 2e68 5b22 4665 7463 6844  e(self.h["FetchD
+00006b60: 6174 6522 5d2e 696c 6f63 5b69 6478 305d  ate"].iloc[idx0]
+00006b70: 2c20 747a 3d74 7a5f 6578 6368 616e 6765  , tz=tz_exchange
+00006b80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00006b90: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00006ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bb0: 2020 2065 7870 6972 6564 203d 2079 6663     expired = yfc
+00006bc0: 742e 4973 5072 6963 6544 6174 6170 6f69  t.IsPriceDatapoi
+00006bd0: 6e74 4578 7069 7265 6428 685f 696e 7465  ntExpired(h_inte
+00006be0: 7276 616c 5f64 742c 2066 6574 6368 5f64  rval_dt, fetch_d
+00006bf0: 742c 2072 6570 6169 7265 642c 206d 6178  t, repaired, max
+00006c00: 5f61 6765 2c20 7365 6c66 2e65 7863 6861  _age, self.excha
+00006c10: 6e67 652c 2073 656c 662e 696e 7465 7276  nge, self.interv
+00006c20: 616c 2c20 7966 5f6c 6167 3d79 665f 6c61  al, yf_lag=yf_la
+00006c30: 672c 2074 7269 6767 6572 4578 7069 7279  g, triggerExpiry
+00006c40: 4f6e 436c 6f73 653d 7472 6967 6765 725f  OnClose=trigger_
+00006c50: 6174 5f6d 6172 6b65 745f 636c 6f73 6529  at_market_close)
+00006c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006c70: 2020 2020 2065 7863 6570 7420 7966 6364       except yfcd
+00006c80: 2e54 696d 6573 7461 6d70 4f75 7473 6964  .TimestampOutsid
+00006c90: 6549 6e74 6572 7661 6c45 7863 6570 7469  eIntervalExcepti
+00006ca0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cc0: 2069 6620 665f 6e61 5b69 6478 305d 3a0a   if f_na[idx0]:.
+00006cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ce0: 2020 2020 2020 2020 2020 2020 2320 5946              # YF
+00006cf0: 4320 6d75 7374 2068 6176 6520 696e 7365  C must have inse
+00006d00: 7274 6564 2061 2072 6f77 206f 6620 4e61  rted a row of Na
+00006d10: 4e73 2c20 7772 6f6e 676c 7920 7468 696e  Ns, wrongly thin
+00006d20: 6b69 6e67 2065 7863 6861 6e67 6520 7368  king exchange sh
+00006d30: 6f75 6c64 2068 6176 6520 6265 656e 206f  ould have been o
+00006d40: 7065 6e20 6865 7265 2e0a 2020 2020 2020  pen here..      
+00006d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d60: 2020 2020 2020 6578 7069 7265 6420 3d20        expired = 
+00006d70: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00006d80: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00006d90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00006da0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006db0: 6169 7365 2065 0a20 2020 2020 2020 2020  aise e.         
+00006dc0: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00006dd0: 7069 7265 643a 0a20 2020 2020 2020 2020  pired:.         
+00006de0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00006df0: 656c 662e 6820 3d20 7365 6c66 2e68 2e69  elf.h = self.h.i
+00006e00: 6c6f 635b 3a69 6478 305d 0a20 2020 2020  loc[:idx0].     
+00006e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e20: 2020 2068 5f69 6e74 6572 7661 6c5f 6474     h_interval_dt
+00006e30: 7320 3d20 685f 696e 7465 7276 616c 5f64  s = h_interval_d
+00006e40: 7473 5b3a 6964 7830 5d0a 0a20 2020 2020  ts[:idx0]..     
+00006e50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00006e60: 2020 2020 2020 2020 2020 2020 2065 7870               exp
+00006e70: 6972 6564 203d 206e 702e 6172 7261 7928  ired = np.array(
+00006e80: 5b46 616c 7365 5d2a 6e29 0a20 2020 2020  [False]*n).     
+00006e90: 2020 2020 2020 2020 2020 2066 5f66 696e             f_fin
+00006ea0: 616c 203d 2073 656c 662e 685b 2246 696e  al = self.h["Fin
+00006eb0: 616c 3f22 5d2e 746f 5f6e 756d 7079 2829  al?"].to_numpy()
+00006ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006ed0: 2066 5f6e 6669 6e61 6c20 3d20 7e66 5f66   f_nfinal = ~f_f
+00006ee0: 696e 616c 0a20 2020 2020 2020 2020 2020  inal.           
+00006ef0: 2020 2020 2023 202d 2061 6c73 6f20 7472       # - also tr
+00006f00: 6561 7420 7265 7061 6972 6564 2064 6174  eat repaired dat
+00006f10: 6120 6173 206e 6f6e 2d66 696e 616c 2c20  a as non-final, 
+00006f20: 6966 2066 6574 6368 6564 206e 6561 7220  if fetched near 
+00006f30: 746f 2069 6e74 6572 7661 6c20 7469 6d65  to interval time
+00006f40: 706f 696e 740a 2020 2020 2020 2020 2020  point.          
+00006f50: 2020 2020 2020 2320 2020 6265 6361 7573        #   becaus
+00006f60: 6520 5961 686f 6f20 6d69 6768 7420 6e6f  e Yahoo might no
+00006f70: 7720 6861 7665 2063 6f72 7265 6374 2064  w have correct d
+00006f80: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00006f90: 2020 2020 2320 2d20 616e 6420 7472 6561      # - and trea
+00006fa0: 7420 4e61 4e20 6461 7461 2061 7320 7265  t NaN data as re
+00006fb0: 7061 6972 6564 0a20 2020 2020 2020 2020  paired.         
+00006fc0: 2020 2020 2020 2063 7574 6f66 665f 6474         cutoff_dt
+00006fd0: 203d 2064 745f 6e6f 7720 2d20 7469 6d65   = dt_now - time
+00006fe0: 6465 6c74 6128 6461 7973 3d37 290a 2020  delta(days=7).  
+00006ff0: 2020 2020 2020 2020 2020 2020 2020 6964                id
+00007000: 7820 3d20 7365 6c66 2e68 2e69 6e64 6578  x = self.h.index
+00007010: 2e67 6574 5f69 6e64 6578 6572 285b 6375  .get_indexer([cu
+00007020: 746f 6666 5f64 745d 2c20 6d65 7468 6f64  toff_dt], method
+00007030: 3d27 6266 696c 6c27 295b 305d 0a20 2020  ='bfill')[0].   
+00007040: 2020 2020 2020 2020 2020 2020 2066 5f72               f_r
+00007050: 6570 6169 7220 3d20 7365 6c66 2e68 5b22  epair = self.h["
+00007060: 5265 7061 6972 6564 3f22 5d2e 746f 5f6e  Repaired?"].to_n
+00007070: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
+00007080: 2020 2020 2020 2066 5f6e 6120 3d20 7365         f_na = se
+00007090: 6c66 2e68 5b27 436c 6f73 6527 5d2e 6973  lf.h['Close'].is
+000070a0: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
+000070b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070c0: 665f 7265 7061 6972 203d 2066 5f72 6570  f_repair = f_rep
+000070d0: 6169 7220 7c20 665f 6e61 0a20 2020 2020  air | f_na.     
+000070e0: 2020 2020 2020 2020 2020 2063 7574 6f66             cutof
+000070f0: 665f 6474 7320 3d20 7365 6c66 2e68 2e69  f_dts = self.h.i
+00007100: 6e64 6578 202b 2073 656c 662e 6974 6420  ndex + self.itd 
+00007110: 2b20 7469 6d65 6465 6c74 6128 6461 7973  + timedelta(days
+00007120: 3d37 290a 2020 2020 2020 2020 2020 2020  =7).            
+00007130: 2020 2020 2320 4967 6e6f 7265 2072 6570      # Ignore rep
+00007140: 6169 7265 6420 6461 7461 2069 6620 6665  aired data if fe
+00007150: 7463 6865 642f 7265 7061 6972 6564 2037  tched/repaired 7
+00007160: 2b20 6461 7973 2061 6674 6572 2069 6e74  + days after int
+00007170: 6572 7661 6c20 656e 640a 2020 2020 2020  erval end.      
+00007180: 2020 2020 2020 2020 2020 665f 7265 7061            f_repa
+00007190: 6972 5b73 656c 662e 685b 2746 6574 6368  ir[self.h['Fetch
+000071a0: 4461 7465 275d 203e 2063 7574 6f66 665f  Date'] > cutoff_
+000071b0: 6474 735d 203d 2046 616c 7365 0a20 2020  dts] = False.   
+000071c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000071d0: 665f 7265 7061 6972 2e61 6e79 2829 3a0a  f_repair.any():.
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2020 665f 6e66 696e 616c 203d 2066      f_nfinal = f
+00007200: 5f6e 6669 6e61 6c20 7c20 665f 7265 7061  _nfinal | f_repa
+00007210: 6972 0a20 2020 2020 2020 2020 2020 2020  ir.             
+00007220: 2020 2066 6f72 2069 6478 2069 6e20 6e70     for idx in np
+00007230: 2e77 6865 7265 2866 5f6e 6669 6e61 6c29  .where(f_nfinal)
+00007240: 5b30 5d3a 0a20 2020 2020 2020 2020 2020  [0]:.           
+00007250: 2020 2020 2020 2020 2023 2072 6570 6169           # repai
+00007260: 7265 6420 3d20 4661 6c73 650a 2020 2020  red = False.    
+00007270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007280: 7265 7061 6972 6564 203d 2066 5f72 6570  repaired = f_rep
+00007290: 6169 725b 6964 785d 0a20 2020 2020 2020  air[idx].       
+000072a0: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
+000072b0: 6e74 6572 7661 6c5f 6474 203d 2068 5f69  nterval_dt = h_i
+000072c0: 6e74 6572 7661 6c5f 6474 735b 6964 785d  nterval_dts[idx]
+000072d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000072e0: 2020 2020 2066 6574 6368 5f64 7420 3d20       fetch_dt = 
+000072f0: 7966 6374 2e43 6f6e 7665 7274 546f 4461  yfct.ConvertToDa
+00007300: 7465 7469 6d65 2873 656c 662e 685b 2246  tetime(self.h["F
+00007310: 6574 6368 4461 7465 225d 2e69 6c6f 635b  etchDate"].iloc[
+00007320: 6964 785d 2c20 747a 3d74 7a5f 6578 6368  idx], tz=tz_exch
+00007330: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+00007340: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00007350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007360: 2020 2020 2020 2065 7870 6972 6564 5f69         expired_i
+00007370: 6478 203d 2079 6663 742e 4973 5072 6963  dx = yfct.IsPric
+00007380: 6544 6174 6170 6f69 6e74 4578 7069 7265  eDatapointExpire
+00007390: 6428 685f 696e 7465 7276 616c 5f64 742c  d(h_interval_dt,
+000073a0: 2066 6574 6368 5f64 742c 2072 6570 6169   fetch_dt, repai
+000073b0: 7265 642c 206d 6178 5f61 6765 2c20 7365  red, max_age, se
+000073c0: 6c66 2e65 7863 6861 6e67 652c 2073 656c  lf.exchange, sel
+000073d0: 662e 696e 7465 7276 616c 2c20 7966 5f6c  f.interval, yf_l
+000073e0: 6167 3d79 665f 6c61 672c 2074 7269 6767  ag=yf_lag, trigg
+000073f0: 6572 4578 7069 7279 4f6e 436c 6f73 653d  erExpiryOnClose=
+00007400: 7472 6967 6765 725f 6174 5f6d 6172 6b65  trigger_at_marke
+00007410: 745f 636c 6f73 6529 0a20 2020 2020 2020  t_close).       
+00007420: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00007430: 6570 7420 7966 6364 2e54 696d 6573 7461  ept yfcd.Timesta
+00007440: 6d70 4f75 7473 6964 6549 6e74 6572 7661  mpOutsideInterva
+00007450: 6c45 7863 6570 7469 6f6e 2061 7320 653a  lException as e:
+00007460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007470: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
+00007480: 5b69 6478 305d 3a0a 2020 2020 2020 2020  [idx0]:.        
+00007490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074a0: 2020 2020 2320 5946 4320 6d75 7374 2068      # YFC must h
+000074b0: 6176 6520 696e 7365 7274 6564 2061 2072  ave inserted a r
+000074c0: 6f77 206f 6620 4e61 4e73 2c20 7772 6f6e  ow of NaNs, wron
+000074d0: 676c 7920 7468 696e 6b69 6e67 2065 7863  gly thinking exc
+000074e0: 6861 6e67 6520 7368 6f75 6c64 2068 6176  hange should hav
+000074f0: 6520 6265 656e 206f 7065 6e20 6865 7265  e been open here
+00007500: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007510: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00007520: 7069 7265 645f 6964 7820 3d20 5472 7565  pired_idx = True
+00007530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007540: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00007550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007560: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007570: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
+00007580: 2020 2020 2020 2065 7870 6972 6564 5b69         expired[i
+00007590: 6478 5d20 3d20 6578 7069 7265 645f 6964  dx] = expired_id
+000075a0: 780a 2020 2020 2020 2020 2020 2020 2020  x.              
+000075b0: 2020 6966 2065 7870 6972 6564 2e61 6e79    if expired.any
+000075c0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000075d0: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
+000075e0: 2073 656c 662e 682e 6472 6f70 2873 656c   self.h.drop(sel
+000075f0: 662e 682e 696e 6465 785b 6578 7069 7265  f.h.index[expire
+00007600: 645d 290a 2020 2020 2020 2020 2020 2020  d]).            
+00007610: 2020 2020 2020 2020 685f 696e 7465 7276          h_interv
+00007620: 616c 5f64 7473 203d 2068 5f69 6e74 6572  al_dts = h_inter
+00007630: 7661 6c5f 6474 735b 7e65 7870 6972 6564  val_dts[~expired
+00007640: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00007650: 2073 656c 662e 682e 656d 7074 793a 0a20   self.h.empty:. 
+00007660: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00007670: 656c 662e 6820 3d20 4e6f 6e65 0a0a 2020  elf.h = None..  
+00007680: 2020 2020 2020 7261 6e67 6573 5f74 6f5f        ranges_to_
+00007690: 6665 7463 6820 3d20 5b5d 0a20 2020 2020  fetch = [].     
+000076a0: 2020 2069 6620 7365 6c66 2e68 2069 7320     if self.h is 
+000076b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000076c0: 2020 2320 5369 6d70 6c65 2c20 6a75 7374    # Simple, just
+000076d0: 2066 6574 6368 2074 6865 2072 6571 7565   fetch the reque
+000076e0: 7374 6564 2064 6174 610a 0a20 2020 2020  sted data..     
+000076f0: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00007700: 6f6e 7469 6775 6f75 733a 0a20 2020 2020  ontiguous:.     
+00007710: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00007720: 7572 6520 6461 696c 7920 616c 7761 7973  ure daily always
+00007730: 2075 702d 746f 2d6e 6f77 0a20 2020 2020   up-to-now.     
+00007740: 2020 2020 2020 2020 2020 2068 203d 2073             h = s
+00007750: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
+00007760: 6f72 7928 7374 6172 742c 2074 6f6d 6f72  ory(start, tomor
+00007770: 726f 772c 2070 7265 706f 7374 2c20 6465  row, prepost, de
+00007780: 6275 675f 7966 290a 2020 2020 2020 2020  bug_yf).        
+00007790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000077a0: 2020 2020 2020 2020 2020 6820 3d20 7365            h = se
+000077b0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
+000077c0: 7279 2873 7461 7274 2c20 656e 642c 2070  ry(start, end, p
+000077d0: 7265 706f 7374 2c20 6465 6275 675f 7966  repost, debug_yf
+000077e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000077f0: 2068 2069 7320 4e6f 6e65 3a0a 2020 2020   h is None:.    
+00007800: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00007810: 6520 4578 6365 7074 696f 6e28 6622 7b73  e Exception(f"{s
+00007820: 656c 662e 7469 636b 6572 7d3a 2046 6169  elf.ticker}: Fai
+00007830: 6c65 6420 746f 2066 6574 6368 2064 6174  led to fetch dat
+00007840: 6520 7261 6e67 6520 7b73 7461 7274 7d2d  e range {start}-
+00007850: 3e7b 656e 647d 2229 0a0a 2020 2020 2020  >{end}")..      
+00007860: 2020 2020 2020 2320 4164 6a75 7374 0a20        # Adjust. 
+00007870: 2020 2020 2020 2020 2020 2068 203d 2073             h = s
+00007880: 656c 662e 5f72 6576 6572 7365 5961 686f  elf._reverseYaho
+00007890: 6f41 646a 7573 7428 6829 0a0a 2020 2020  oAdjust(h)..    
+000078a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000078b0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+000078c0: 2e49 6e74 6572 7661 6c2e 4461 7973 313a  .Interval.Days1:
+000078d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000078e0: 2068 5f73 706c 6974 7320 3d20 685b 685b   h_splits = h[h[
+000078f0: 2253 746f 636b 2053 706c 6974 7322 5d20  "Stock Splits"] 
+00007900: 213d 2030 5d0a 2020 2020 2020 2020 2020  != 0].          
+00007910: 2020 2020 2020 6966 206c 656e 2868 5f73        if len(h_s
+00007920: 706c 6974 7329 203e 2030 3a0a 2020 2020  plits) > 0:.    
+00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007940: 7365 6c66 2e6d 616e 6167 6572 2e47 6574  self.manager.Get
+00007950: 4869 7374 6f72 7928 2245 7665 6e74 7322  History("Events"
+00007960: 292e 5570 6461 7465 5370 6c69 7473 2868  ).UpdateSplits(h
+00007970: 5f73 706c 6974 7329 0a0a 2020 2020 2020  _splits)..      
+00007980: 2020 2020 2020 7365 6c66 2e5f 7570 6461        self._upda
+00007990: 7465 6443 6163 6865 6450 7269 6365 7328  tedCachedPrices(
+000079a0: 6829 0a0a 2020 2020 2020 2020 656c 7365  h)..        else
+000079b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000079c0: 436f 6d70 6172 6520 7265 7175 6573 7420  Compare request 
+000079d0: 6167 6169 6e73 7420 6361 6368 6564 2064  against cached d
+000079e0: 6174 612c 206f 6e6c 7920 6665 7463 6820  ata, only fetch 
+000079f0: 6d69 7373 696e 672f 6578 7069 7265 6420  missing/expired 
+00007a00: 6461 7461 0a0a 2020 2020 2020 2020 2020  data..          
+00007a10: 2020 2320 5065 7266 6f72 6d61 6e63 6520    # Performance 
+00007a20: 544f 444f 3a20 7461 6720 726f 7773 2061  TODO: tag rows a
+00007a30: 7320 6675 6c6c 7920 636f 6e74 6967 756f  s fully contiguo
+00007a40: 7573 2074 6f20 6176 6f69 6420 7365 6172  us to avoid sear
+00007a50: 6368 696e 6720 666f 7220 6761 7073 0a0a  ching for gaps..
+00007a60: 2020 2020 2020 2020 2020 2020 2320 4361              # Ca
+00007a70: 6c63 756c 6174 6520 7261 6e67 6573 5f74  lculate ranges_t
+00007a80: 6f5f 6665 7463 680a 2020 2020 2020 2020  o_fetch.        
+00007a90: 2020 2020 6966 2073 656c 662e 636f 6e74      if self.cont
+00007aa0: 6967 756f 7573 3a0a 2020 2020 2020 2020  iguous:.        
+00007ab0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00007ac0: 6820 6973 204e 6f6e 6520 6f72 2073 656c  h is None or sel
+00007ad0: 662e 682e 656d 7074 793a 0a20 2020 2020  f.h.empty:.     
+00007ae0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007af0: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
+00007b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007b10: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00007b20: 2e6d 756c 7469 6461 793a 0a20 2020 2020  .multiday:.     
+00007b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b40: 2020 2020 2020 2072 616e 6765 735f 746f         ranges_to
+00007b50: 5f66 6574 6368 203d 2079 6663 742e 4964  _fetch = yfct.Id
+00007b60: 656e 7469 6679 4d69 7373 696e 6749 6e74  entifyMissingInt
+00007b70: 6572 7661 6c52 616e 6765 7328 7365 6c66  ervalRanges(self
+00007b80: 2e65 7863 6861 6e67 652c 2073 7461 7274  .exchange, start
+00007b90: 5f64 2c20 656e 645f 642b 7365 6c66 2e69  _d, end_d+self.i
+00007ba0: 7464 2c20 7365 6c66 2e69 6e74 6572 7661  td, self.interva
+00007bb0: 6c2c 205b 5d2c 206d 696e 4469 7374 616e  l, [], minDistan
+00007bc0: 6365 5468 7265 7368 6f6c 643d 3529 0a20  ceThreshold=5). 
+00007bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007be0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00007bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c00: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
+00007c10: 746f 5f66 6574 6368 203d 2079 6663 742e  to_fetch = yfct.
+00007c20: 4964 656e 7469 6679 4d69 7373 696e 6749  IdentifyMissingI
+00007c30: 6e74 6572 7661 6c52 616e 6765 7328 7365  ntervalRanges(se
+00007c40: 6c66 2e65 7863 6861 6e67 652c 2073 7461  lf.exchange, sta
+00007c50: 7274 5f64 2c20 656e 645f 642c 2073 656c  rt_d, end_d, sel
+00007c60: 662e 696e 7465 7276 616c 2c20 5b5d 2c20  f.interval, [], 
+00007c70: 6d69 6e44 6973 7461 6e63 6554 6872 6573  minDistanceThres
+00007c80: 686f 6c64 3d35 290a 2020 2020 2020 2020  hold=5).        
+00007c90: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00007ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007cb0: 2020 2020 2020 2020 2020 7261 6e67 6573            ranges
+00007cc0: 5f74 6f5f 6665 7463 6820 3d20 7966 6374  _to_fetch = yfct
+00007cd0: 2e49 6465 6e74 6966 794d 6973 7369 6e67  .IdentifyMissing
+00007ce0: 496e 7465 7276 616c 5261 6e67 6573 2873  IntervalRanges(s
+00007cf0: 656c 662e 6578 6368 616e 6765 2c20 7374  elf.exchange, st
+00007d00: 6172 742c 2065 6e64 2c20 7365 6c66 2e69  art, end, self.i
+00007d10: 6e74 6572 7661 6c2c 205b 5d2c 206d 696e  nterval, [], min
+00007d20: 4469 7374 616e 6365 5468 7265 7368 6f6c  DistanceThreshol
+00007d30: 643d 3529 0a20 2020 2020 2020 2020 2020  d=5).           
+00007d40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007d50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00007d60: 2045 6e73 7572 6520 7468 6174 2064 6169   Ensure that dai
+00007d70: 6c79 2064 6174 6120 616c 7761 7973 2075  ly data always u
+00007d80: 702d 746f 2d64 6174 6520 746f 206e 6f77  p-to-date to now
+00007d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007da0: 2020 2020 2023 2055 7064 6174 653a 206f       # Update: o
+00007db0: 6e6c 7920 6e65 6365 7373 6172 7920 746f  nly necessary to
+00007dc0: 2062 6520 7570 2d74 6f2d 6461 7465 2074   be up-to-date t
+00007dd0: 6f20 6e6f 7720 6966 2061 2066 6574 6368  o now if a fetch
+00007de0: 2068 6170 7065 6e73 0a20 2020 2020 2020   happens.       
+00007df0: 2020 2020 2020 2020 2020 2020 2064 745f               dt_
+00007e00: 7374 6172 7420 3d20 7966 6374 2e43 6f6e  start = yfct.Con
+00007e10: 7665 7274 546f 4461 7465 7469 6d65 2873  vertToDatetime(s
+00007e20: 656c 662e 682e 696e 6465 785b 305d 2c20  elf.h.index[0], 
+00007e30: 747a 3d74 7a5f 6578 6368 616e 6765 290a  tz=tz_exchange).
+00007e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e50: 2020 2020 6474 5f65 6e64 203d 2079 6663      dt_end = yfc
+00007e60: 742e 436f 6e76 6572 7454 6f44 6174 6574  t.ConvertToDatet
+00007e70: 696d 6528 7365 6c66 2e68 2e69 6e64 6578  ime(self.h.index
+00007e80: 5b2d 315d 2c20 747a 3d74 7a5f 6578 6368  [-1], tz=tz_exch
+00007e90: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+00007ea0: 2020 2020 2020 2020 2020 685f 7374 6172            h_star
+00007eb0: 7420 3d20 7966 6374 2e47 6574 5469 6d65  t = yfct.GetTime
+00007ec0: 7374 616d 7043 7572 7265 6e74 496e 7465  stampCurrentInte
+00007ed0: 7276 616c 2873 656c 662e 6578 6368 616e  rval(self.exchan
+00007ee0: 6765 2c20 6474 5f73 7461 7274 2c20 7365  ge, dt_start, se
+00007ef0: 6c66 2e69 6e74 6572 7661 6c2c 2069 676e  lf.interval, ign
+00007f00: 6f72 655f 6272 6561 6b73 3d54 7275 6529  ore_breaks=True)
+00007f10: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
+00007f20: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007f30: 2020 2020 2020 6c61 7374 5f69 6e74 6572        last_inter
+00007f40: 7661 6c20 3d20 7966 6374 2e47 6574 5469  val = yfct.GetTi
+00007f50: 6d65 7374 616d 7043 7572 7265 6e74 496e  mestampCurrentIn
+00007f60: 7465 7276 616c 2873 656c 662e 6578 6368  terval(self.exch
+00007f70: 616e 6765 2c20 6474 5f65 6e64 2c20 7365  ange, dt_end, se
+00007f80: 6c66 2e69 6e74 6572 7661 6c2c 2069 676e  lf.interval, ign
+00007f90: 6f72 655f 6272 6561 6b73 3d54 7275 6529  ore_breaks=True)
+00007fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007fb0: 2020 2020 2069 6620 6c61 7374 5f69 6e74       if last_int
+00007fc0: 6572 7661 6c20 6973 204e 6f6e 653a 0a20  erval is None:. 
+00007fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fe0: 2020 2020 2020 2023 2050 6f73 7369 626c         # Possibl
+00007ff0: 6520 6966 2059 6168 6f6f 2072 6574 7572  e if Yahoo retur
+00008000: 6e65 6420 7072 6963 6520 6461 7461 2077  ned price data w
+00008010: 6865 6e20 2765 7863 6861 6e67 655f 6361  hen 'exchange_ca
+00008020: 6c65 6e64 6172 7327 2074 6869 6e6b 7320  lendars' thinks 
+00008030: 6578 6368 616e 6765 2077 6173 2063 6c6f  exchange was clo
+00008040: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
+00008050: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00008060: 6920 696e 2072 616e 6765 2831 2c20 3529  i in range(1, 5)
+00008070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008080: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00008090: 7374 5f69 6e74 6572 7661 6c20 3d20 7966  st_interval = yf
+000080a0: 6374 2e47 6574 5469 6d65 7374 616d 7043  ct.GetTimestampC
+000080b0: 7572 7265 6e74 496e 7465 7276 616c 2873  urrentInterval(s
+000080c0: 656c 662e 6578 6368 616e 6765 2c20 6474  elf.exchange, dt
+000080d0: 5f65 6e64 202d 2074 645f 3164 2a69 2c20  _end - td_1d*i, 
+000080e0: 7365 6c66 2e69 6e74 6572 7661 6c2c 2069  self.interval, i
+000080f0: 676e 6f72 655f 6272 6561 6b73 3d54 7275  gnore_breaks=Tru
+00008100: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00008110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00008120: 6620 6c61 7374 5f69 6e74 6572 7661 6c20  f last_interval 
+00008130: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
 00008140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008150: 2020 2320 506f 7373 6962 6c65 2069 6620    # Possible if 
-00008160: 5961 686f 6f20 7265 7475 726e 6564 2070  Yahoo returned p
-00008170: 7269 6365 2064 6174 6120 7768 656e 2027  rice data when '
-00008180: 6578 6368 616e 6765 5f63 616c 656e 6461  exchange_calenda
-00008190: 7273 2720 7468 696e 6b73 2065 7863 6861  rs' thinks excha
-000081a0: 6e67 6520 7761 7320 636c 6f73 6564 0a20  nge was closed. 
-000081b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081c0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-000081d0: 7261 6e67 6528 312c 2035 293a 0a20 2020  range(1, 5):.   
-000081e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000081f0: 2020 2020 2020 2020 206c 6173 745f 696e           last_in
-00008200: 7465 7276 616c 203d 2079 6663 742e 4765  terval = yfct.Ge
-00008210: 7454 696d 6573 7461 6d70 4375 7272 656e  tTimestampCurren
-00008220: 7449 6e74 6572 7661 6c28 7365 6c66 2e65  tInterval(self.e
-00008230: 7863 6861 6e67 652c 2064 745f 656e 6420  xchange, dt_end 
-00008240: 2d20 7464 5f31 642a 692c 2073 656c 662e  - td_1d*i, self.
-00008250: 696e 7465 7276 616c 2c20 6967 6e6f 7265  interval, ignore
-00008260: 5f62 7265 616b 733d 5472 7565 290a 2020  _breaks=True).  
-00008270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008280: 2020 2020 2020 2020 2020 6966 206c 6173            if las
-00008290: 745f 696e 7465 7276 616c 2069 7320 6e6f  t_interval is no
-000082a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000082b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082c0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00008150: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00008160: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
+00008170: 2020 2020 2020 2068 5f65 6e64 203d 206c         h_end = l
+00008180: 6173 745f 696e 7465 7276 616c 5b22 696e  ast_interval["in
+00008190: 7465 7276 616c 5f63 6c6f 7365 225d 0a0a  terval_close"]..
+000081a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081b0: 2020 2020 7261 6e67 6550 7265 5f74 6f5f      rangePre_to_
+000081c0: 6665 7463 6820 3d20 4e6f 6e65 0a20 2020  fetch = None.   
+000081d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081e0: 2069 6620 7374 6172 7420 3c20 685f 7374   if start < h_st
+000081f0: 6172 743a 0a20 2020 2020 2020 2020 2020  art:.           
+00008200: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00008210: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+00008220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008230: 2020 2020 2020 206d 7367 203d 2022 6368         msg = "ch
+00008240: 6563 6b69 6e67 2066 6f72 2072 616e 6765  ecking for range
+00008250: 5072 655f 746f 5f66 6574 6368 220a 2020  Pre_to_fetch".  
+00008260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008270: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00008280: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
+00008290: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+000082a0: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
+000082b0: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
+000082c0: 6b65 727d 3a20 2220 2b20 6d73 6729 0a20  ker}: " + msg). 
 000082d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000082e0: 2020 685f 656e 6420 3d20 6c61 7374 5f69    h_end = last_i
-000082f0: 6e74 6572 7661 6c5b 2269 6e74 6572 7661  nterval["interva
-00008300: 6c5f 636c 6f73 6522 5d0a 0a20 2020 2020  l_close"]..     
-00008310: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00008320: 616e 6765 5072 655f 746f 5f66 6574 6368  angePre_to_fetch
-00008330: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00008340: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00008350: 7461 7274 203c 2068 5f73 7461 7274 3a0a  tart < h_start:.
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-00008380: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
-00008390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083a0: 2020 6d73 6720 3d20 2263 6865 636b 696e    msg = "checkin
-000083b0: 6720 666f 7220 7261 6e67 6550 7265 5f74  g for rangePre_t
-000083c0: 6f5f 6665 7463 6822 0a20 2020 2020 2020  o_fetch".       
-000083d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083e0: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
-000083f0: 7269 6e74 286d 7367 2920 6966 2079 6663  rint(msg) if yfc
-00008400: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
-00008410: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
-00008420: 6622 7b73 656c 662e 7469 636b 6572 7d3a  f"{self.ticker}:
-00008430: 2022 202b 206d 7367 290a 2020 2020 2020   " + msg).      
-00008440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008450: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00008460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008470: 2020 2072 616e 6765 5072 655f 746f 5f66     rangePre_to_f
-00008480: 6574 6368 203d 2079 6663 742e 4964 656e  etch = yfct.Iden
-00008490: 7469 6679 4d69 7373 696e 6749 6e74 6572  tifyMissingInter
-000084a0: 7661 6c52 616e 6765 7328 7365 6c66 2e65  valRanges(self.e
-000084b0: 7863 6861 6e67 652c 2073 7461 7274 2c20  xchange, start, 
-000084c0: 685f 7374 6172 742c 2073 656c 662e 696e  h_start, self.in
-000084d0: 7465 7276 616c 2c20 4e6f 6e65 2c20 6967  terval, None, ig
-000084e0: 6e6f 7265 5f62 7265 616b 733d 5472 7565  nore_breaks=True
-000084f0: 2c20 6d69 6e44 6973 7461 6e63 6554 6872  , minDistanceThr
-00008500: 6573 686f 6c64 3d35 290a 2020 2020 2020  eshold=5).      
-00008510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008520: 2020 6578 6365 7074 2079 6663 642e 4e6f    except yfcd.No
-00008530: 496e 7465 7276 616c 7349 6e52 616e 6765  IntervalsInRange
-00008540: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00008550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008560: 2020 2020 2020 2072 616e 6765 5072 655f         rangePre_
-00008570: 746f 5f66 6574 6368 203d 204e 6f6e 650a  to_fetch = None.
-00008580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008590: 2020 2020 6966 2072 616e 6765 5072 655f      if rangePre_
-000085a0: 746f 5f66 6574 6368 2069 7320 6e6f 7420  to_fetch is not 
-000085b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000085c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000085d0: 206c 656e 2872 616e 6765 5072 655f 746f   len(rangePre_to
-000085e0: 5f66 6574 6368 2920 3e20 313a 0a20 2020  _fetch) > 1:.   
-000085f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008600: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-00008610: 7863 6570 7469 6f6e 2822 4578 7065 6374  xception("Expect
-00008620: 6564 206f 6e6c 7920 6f6e 6520 656c 656d  ed only one elem
-00008630: 656e 7420 696e 2072 616e 6765 5072 655f  ent in rangePre_
-00008640: 746f 5f66 6574 6368 5b5d 2c20 6275 7420  to_fetch[], but 
-00008650: 3d20 7b7d 222e 666f 726d 6174 2872 616e  = {}".format(ran
-00008660: 6765 5072 655f 746f 5f66 6574 6368 2929  gePre_to_fetch))
-00008670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008680: 2020 2020 2020 2020 2072 616e 6765 5072           rangePr
-00008690: 655f 746f 5f66 6574 6368 203d 2072 616e  e_to_fetch = ran
-000086a0: 6765 5072 655f 746f 5f66 6574 6368 5b30  gePre_to_fetch[0
-000086b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000086c0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-000086d0: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-000086e0: 6550 6f73 745f 746f 5f66 6574 6368 203d  ePost_to_fetch =
-000086f0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00008700: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00008710: 662e 685b 2246 696e 616c 3f22 5d2e 696c  f.h["Final?"].il
-00008720: 6f63 5b2d 315d 2061 6e64 2028 6d69 6e28  oc[-1] and (min(
-00008730: 7966 6374 2e43 616c 6349 6e74 6572 7661  yfct.CalcInterva
-00008740: 6c4c 6173 7444 6174 6144 7428 7365 6c66  lLastDataDt(self
-00008750: 2e65 7863 6861 6e67 652c 2064 745f 656e  .exchange, dt_en
-00008760: 642c 2073 656c 662e 696e 7465 7276 616c  d, self.interval
-00008770: 292c 2073 656c 662e 685b 2246 6574 6368  ), self.h["Fetch
-00008780: 4461 7465 225d 2e69 6c6f 635b 2d31 5d29  Date"].iloc[-1])
-00008790: 2b6d 6178 5f61 6765 203c 3d20 6474 5f6e  +max_age <= dt_n
-000087a0: 6f77 293a 0a20 2020 2020 2020 2020 2020  ow):.           
-000087b0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-000087c0: 6f74 653a 2069 6620 7365 6c66 2e68 5b22  ote: if self.h["
-000087d0: 4669 6e61 6c3f 225d 2e69 6c6f 635b 2d31  Final?"].iloc[-1
-000087e0: 5d20 3d3d 2046 616c 7365 2c20 7468 656e  ] == False, then
-000087f0: 2074 6861 7420 6d65 616e 7320 6162 6f76   that means abov
-00008800: 6520 6578 7069 7279 2063 6865 636b 2064  e expiry check d
-00008810: 6964 6e27 7420 7265 6d6f 7665 2069 7420  idn't remove it 
-00008820: 736f 2064 6f6e 2774 2066 6574 6368 2061  so don't fetch a
-00008830: 6e79 7468 696e 670a 2020 2020 2020 2020  nything.        
-00008840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008850: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
+000082e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000082f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008300: 2020 2020 2020 2020 7261 6e67 6550 7265          rangePre
+00008310: 5f74 6f5f 6665 7463 6820 3d20 7966 6374  _to_fetch = yfct
+00008320: 2e49 6465 6e74 6966 794d 6973 7369 6e67  .IdentifyMissing
+00008330: 496e 7465 7276 616c 5261 6e67 6573 2873  IntervalRanges(s
+00008340: 656c 662e 6578 6368 616e 6765 2c20 7374  elf.exchange, st
+00008350: 6172 742c 2068 5f73 7461 7274 2c20 7365  art, h_start, se
+00008360: 6c66 2e69 6e74 6572 7661 6c2c 204e 6f6e  lf.interval, Non
+00008370: 652c 2069 676e 6f72 655f 6272 6561 6b73  e, ignore_breaks
+00008380: 3d54 7275 652c 206d 696e 4469 7374 616e  =True, minDistan
+00008390: 6365 5468 7265 7368 6f6c 643d 3529 0a20  ceThreshold=5). 
+000083a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083b0: 2020 2020 2020 2065 7863 6570 7420 7966         except yf
+000083c0: 6364 2e4e 6f49 6e74 6572 7661 6c73 496e  cd.NoIntervalsIn
+000083d0: 5261 6e67 6545 7863 6570 7469 6f6e 3a0a  RangeException:.
+000083e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083f0: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
+00008400: 6550 7265 5f74 6f5f 6665 7463 6820 3d20  ePre_to_fetch = 
+00008410: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00008420: 2020 2020 2020 2020 2069 6620 7261 6e67           if rang
+00008430: 6550 7265 5f74 6f5f 6665 7463 6820 6973  ePre_to_fetch is
+00008440: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00008450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008460: 2020 2069 6620 6c65 6e28 7261 6e67 6550     if len(rangeP
+00008470: 7265 5f74 6f5f 6665 7463 6829 203e 2031  re_to_fetch) > 1
+00008480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008490: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000084a0: 6973 6520 4578 6365 7074 696f 6e28 2245  ise Exception("E
+000084b0: 7870 6563 7465 6420 6f6e 6c79 206f 6e65  xpected only one
+000084c0: 2065 6c65 6d65 6e74 2069 6e20 7261 6e67   element in rang
+000084d0: 6550 7265 5f74 6f5f 6665 7463 685b 5d2c  ePre_to_fetch[],
+000084e0: 2062 7574 203d 207b 7d22 2e66 6f72 6d61   but = {}".forma
+000084f0: 7428 7261 6e67 6550 7265 5f74 6f5f 6665  t(rangePre_to_fe
+00008500: 7463 6829 290a 2020 2020 2020 2020 2020  tch)).          
+00008510: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00008520: 6e67 6550 7265 5f74 6f5f 6665 7463 6820  ngePre_to_fetch 
+00008530: 3d20 7261 6e67 6550 7265 5f74 6f5f 6665  = rangePre_to_fe
+00008540: 7463 685b 305d 0a20 2020 2020 2020 2020  tch[0].         
+00008550: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00008560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008570: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
+00008580: 7463 6820 3d20 4e6f 6e65 0a20 2020 2020  tch = None.     
+00008590: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000085a0: 6620 7365 6c66 2e68 5b22 4669 6e61 6c3f  f self.h["Final?
+000085b0: 225d 2e69 6c6f 635b 2d31 5d20 616e 6420  "].iloc[-1] and 
+000085c0: 286d 696e 2879 6663 742e 4361 6c63 496e  (min(yfct.CalcIn
+000085d0: 7465 7276 616c 4c61 7374 4461 7461 4474  tervalLastDataDt
+000085e0: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
+000085f0: 6474 5f65 6e64 2c20 7365 6c66 2e69 6e74  dt_end, self.int
+00008600: 6572 7661 6c29 2c20 7365 6c66 2e68 5b22  erval), self.h["
+00008610: 4665 7463 6844 6174 6522 5d2e 696c 6f63  FetchDate"].iloc
+00008620: 5b2d 315d 292b 6d61 785f 6167 6520 3c3d  [-1])+max_age <=
+00008630: 2064 745f 6e6f 7729 3a0a 2020 2020 2020   dt_now):.      
+00008640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008650: 2020 2320 4e6f 7465 3a20 6966 2073 656c    # Note: if sel
+00008660: 662e 685b 2246 696e 616c 3f22 5d2e 696c  f.h["Final?"].il
+00008670: 6f63 5b2d 315d 203d 3d20 4661 6c73 652c  oc[-1] == False,
+00008680: 2074 6865 6e20 7468 6174 206d 6561 6e73   then that means
+00008690: 2061 626f 7665 2065 7870 6972 7920 6368   above expiry ch
+000086a0: 6563 6b20 6469 646e 2774 2072 656d 6f76  eck didn't remov
+000086b0: 6520 6974 2073 6f20 646f 6e27 7420 6665  e it so don't fe
+000086c0: 7463 6820 616e 7974 6869 6e67 0a20 2020  tch anything.   
+000086d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086e0: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
+000086f0: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+00008700: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00008710: 7367 203d 2022 6368 6563 6b69 6e67 2066  sg = "checking f
+00008720: 6f72 2072 616e 6765 506f 7374 5f74 6f5f  or rangePost_to_
+00008730: 6665 7463 6822 0a20 2020 2020 2020 2020  fetch".         
+00008740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008750: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
+00008760: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
+00008770: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+00008780: 2829 2065 6c73 6520 7072 696e 7428 6622  () else print(f"
+00008790: 7b73 656c 662e 7469 636b 6572 7d3a 2022  {self.ticker}: "
+000087a0: 202b 206d 7367 290a 2020 2020 2020 2020   + msg).        
+000087b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087c0: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
+000087d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000087e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000087f0: 2072 616e 6765 5072 655f 746f 5f66 6574   rangePre_to_fet
+00008800: 6368 2069 7320 6e6f 7420 4e6f 6e65 206f  ch is not None o
+00008810: 7220 656e 6420 3e20 685f 656e 643a 0a20  r end > h_end:. 
+00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008830: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00008840: 6172 6765 745f 656e 645f 6420 3d20 746f  arget_end_d = to
+00008850: 6d6f 7272 6f77 5f64 0a20 2020 2020 2020  morrow_d.       
 00008860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008870: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-00008880: 2263 6865 636b 696e 6720 666f 7220 7261  "checking for ra
-00008890: 6e67 6550 6f73 745f 746f 5f66 6574 6368  ngePost_to_fetch
-000088a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000088b0: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-000088c0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-000088d0: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-000088e0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-000088f0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-00008900: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-00008910: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00008920: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00008930: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-00008940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008950: 2020 2020 2020 2020 2069 6620 7261 6e67           if rang
-00008960: 6550 7265 5f74 6f5f 6665 7463 6820 6973  ePre_to_fetch is
-00008970: 206e 6f74 204e 6f6e 6520 6f72 2065 6e64   not None or end
-00008980: 203e 2068 5f65 6e64 3a0a 2020 2020 2020   > h_end:.      
+00008870: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00008880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008890: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+000088a0: 745f 656e 645f 6420 3d20 656e 640a 2020  t_end_d = end.  
+000088b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000088c0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000088d0: 662e 6d75 6c74 6964 6179 3a0a 2020 2020  f.multiday:.    
+000088e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000088f0: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00008900: 6574 5f65 6e64 5f64 202b 3d20 7365 6c66  et_end_d += self
+00008910: 2e69 7464 2020 2320 7465 7374 696e 6720  .itd  # testing 
+00008920: 6e65 7720 636f 6465 0a20 2020 2020 2020  new code.       
+00008930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008940: 2020 2020 2069 6620 685f 656e 6420 3c20       if h_end < 
+00008950: 7461 7267 6574 5f65 6e64 5f64 3a0a 2020  target_end_d:.  
+00008960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008970: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00008980: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
 00008990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089a0: 2020 2020 2020 2020 2020 7461 7267 6574            target
-000089b0: 5f65 6e64 5f64 203d 2074 6f6d 6f72 726f  _end_d = tomorro
-000089c0: 775f 640a 2020 2020 2020 2020 2020 2020  w_d.            
-000089d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000089e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000089f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a00: 2020 2020 2020 7461 7267 6574 5f65 6e64        target_end
-00008a10: 5f64 203d 2065 6e64 0a20 2020 2020 2020  _d = end.       
-00008a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a30: 2020 2020 2069 6620 7365 6c66 2e6d 756c       if self.mul
-00008a40: 7469 6461 793a 0a20 2020 2020 2020 2020  tiday:.         
-00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a60: 2020 2020 2020 2074 6172 6765 745f 656e         target_en
-00008a70: 645f 6420 2b3d 2073 656c 662e 6974 6420  d_d += self.itd 
-00008a80: 2023 2074 6573 7469 6e67 206e 6577 2063   # testing new c
-00008a90: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
-00008aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ab0: 6966 2068 5f65 6e64 203c 2074 6172 6765  if h_end < targe
-00008ac0: 745f 656e 645f 643a 0a20 2020 2020 2020  t_end_d:.       
-00008ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ae0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00008af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b10: 2020 7261 6e67 6550 6f73 745f 746f 5f66    rangePost_to_f
-00008b20: 6574 6368 203d 2079 6663 742e 4964 656e  etch = yfct.Iden
-00008b30: 7469 6679 4d69 7373 696e 6749 6e74 6572  tifyMissingInter
-00008b40: 7661 6c52 616e 6765 7328 7365 6c66 2e65  valRanges(self.e
-00008b50: 7863 6861 6e67 652c 2068 5f65 6e64 2c20  xchange, h_end, 
-00008b60: 7461 7267 6574 5f65 6e64 5f64 2c20 7365  target_end_d, se
-00008b70: 6c66 2e69 6e74 6572 7661 6c2c 204e 6f6e  lf.interval, Non
-00008b80: 652c 206d 696e 4469 7374 616e 6365 5468  e, minDistanceTh
-00008b90: 7265 7368 6f6c 643d 3529 0a20 2020 2020  reshold=5).     
-00008ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bb0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00008bc0: 7420 7966 6364 2e4e 6f49 6e74 6572 7661  t yfcd.NoInterva
-00008bd0: 6c73 496e 5261 6e67 6545 7863 6570 7469  lsInRangeExcepti
-00008be0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00008bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c00: 2020 2020 2020 2020 7261 6e67 6550 6f73          rangePos
-00008c10: 745f 746f 5f66 6574 6368 203d 204e 6f6e  t_to_fetch = Non
-00008c20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00008c30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00008c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c50: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00008c60: 616e 6765 5072 655f 746f 5f66 6574 6368  angePre_to_fetch
-00008c70: 2069 7320 6e6f 7420 4e6f 6e65 206f 7220   is not None or 
-00008c80: 656e 6420 3e20 685f 656e 643a 0a20 2020  end > h_end:.   
-00008c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ca0: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00008cb0: 6765 745f 656e 645f 6474 203d 2064 745f  get_end_dt = dt_
-00008cc0: 6e6f 770a 2020 2020 2020 2020 2020 2020  now.            
+000089a0: 2020 2020 2020 2072 616e 6765 506f 7374         rangePost
+000089b0: 5f74 6f5f 6665 7463 6820 3d20 7966 6374  _to_fetch = yfct
+000089c0: 2e49 6465 6e74 6966 794d 6973 7369 6e67  .IdentifyMissing
+000089d0: 496e 7465 7276 616c 5261 6e67 6573 2873  IntervalRanges(s
+000089e0: 656c 662e 6578 6368 616e 6765 2c20 685f  elf.exchange, h_
+000089f0: 656e 642c 2074 6172 6765 745f 656e 645f  end, target_end_
+00008a00: 642c 2073 656c 662e 696e 7465 7276 616c  d, self.interval
+00008a10: 2c20 4e6f 6e65 2c20 6d69 6e44 6973 7461  , None, minDista
+00008a20: 6e63 6554 6872 6573 686f 6c64 3d35 290a  nceThreshold=5).
+00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a50: 6578 6365 7074 2079 6663 642e 4e6f 496e  except yfcd.NoIn
+00008a60: 7465 7276 616c 7349 6e52 616e 6765 4578  tervalsInRangeEx
+00008a70: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00008a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a90: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00008aa0: 6765 506f 7374 5f74 6f5f 6665 7463 6820  gePost_to_fetch 
+00008ab0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00008ac0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00008ad0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00008ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008af0: 2069 6620 7261 6e67 6550 7265 5f74 6f5f   if rangePre_to_
+00008b00: 6665 7463 6820 6973 206e 6f74 204e 6f6e  fetch is not Non
+00008b10: 6520 6f72 2065 6e64 203e 2068 5f65 6e64  e or end > h_end
+00008b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b40: 2020 7461 7267 6574 5f65 6e64 5f64 7420    target_end_dt 
+00008b50: 3d20 6474 5f6e 6f77 0a20 2020 2020 2020  = dt_now.       
+00008b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00008b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b90: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+00008ba0: 745f 656e 645f 6474 203d 2065 6e64 0a20  t_end_dt = end. 
+00008bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bc0: 2020 2020 2020 2020 2020 2064 203d 2074             d = t
+00008bd0: 6172 6765 745f 656e 645f 6474 2e61 7374  arget_end_dt.ast
+00008be0: 696d 657a 6f6e 6528 747a 5f65 7863 6861  imezone(tz_excha
+00008bf0: 6e67 6529 2e64 6174 6528 290a 2020 2020  nge).date().    
+00008c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c10: 2020 2020 2020 2020 7363 6865 6420 3d20          sched = 
+00008c20: 7966 6374 2e47 6574 4578 6368 616e 6765  yfct.GetExchange
+00008c30: 5363 6865 6475 6c65 2873 656c 662e 6578  Schedule(self.ex
+00008c40: 6368 616e 6765 2c20 642c 2064 202b 2074  change, d, d + t
+00008c50: 645f 3164 290a 2020 2020 2020 2020 2020  d_1d).          
+00008c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c70: 2020 6966 2028 7363 6865 6420 6973 206e    if (sched is n
+00008c80: 6f74 204e 6f6e 6529 2061 6e64 2028 6e6f  ot None) and (no
+00008c90: 7420 7363 6865 642e 656d 7074 7929 2061  t sched.empty) a
+00008ca0: 6e64 2028 6474 5f6e 6f77 203e 2073 6368  nd (dt_now > sch
+00008cb0: 6564 5b22 6f70 656e 225d 2e69 6c6f 635b  ed["open"].iloc[
+00008cc0: 305d 293a 0a20 2020 2020 2020 2020 2020  0]):.           
 00008cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ce0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d00: 2020 2020 2020 7461 7267 6574 5f65 6e64        target_end
-00008d10: 5f64 7420 3d20 656e 640a 2020 2020 2020  _dt = end.      
+00008ce0: 2020 2020 2074 6172 6765 745f 656e 645f       target_end_
+00008cf0: 6474 203d 2073 6368 6564 5b22 636c 6f73  dt = sched["clos
+00008d00: 6522 5d2e 696c 6f63 5b30 5d2b 7469 6d65  e"].iloc[0]+time
+00008d10: 6465 6c74 6128 686f 7572 733d 3229 0a20  delta(hours=2). 
 00008d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d30: 2020 2020 2020 6420 3d20 7461 7267 6574        d = target
-00008d40: 5f65 6e64 5f64 742e 6173 7469 6d65 7a6f  _end_dt.astimezo
-00008d50: 6e65 2874 7a5f 6578 6368 616e 6765 292e  ne(tz_exchange).
-00008d60: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
-00008d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d80: 2020 2073 6368 6564 203d 2079 6663 742e     sched = yfct.
-00008d90: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
-00008da0: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
-00008db0: 652c 2064 2c20 6420 2b20 7464 5f31 6429  e, d, d + td_1d)
-00008dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008dd0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008de0: 2873 6368 6564 2069 7320 6e6f 7420 4e6f  (sched is not No
-00008df0: 6e65 2920 616e 6420 286e 6f74 2073 6368  ne) and (not sch
-00008e00: 6564 2e65 6d70 7479 2920 616e 6420 2864  ed.empty) and (d
-00008e10: 745f 6e6f 7720 3e20 7363 6865 645b 226f  t_now > sched["o
-00008e20: 7065 6e22 5d2e 696c 6f63 5b30 5d29 3a0a  pen"].iloc[0]):.
+00008d30: 2020 2020 2020 2020 2020 2069 6620 685f             if h_
+00008d40: 656e 6420 3c20 7461 7267 6574 5f65 6e64  end < target_end
+00008d50: 5f64 743a 0a20 2020 2020 2020 2020 2020  _dt:.           
+00008d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00008d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d90: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00008da0: 6e67 6550 6f73 745f 746f 5f66 6574 6368  ngePost_to_fetch
+00008db0: 203d 2079 6663 742e 4964 656e 7469 6679   = yfct.Identify
+00008dc0: 4d69 7373 696e 6749 6e74 6572 7661 6c52  MissingIntervalR
+00008dd0: 616e 6765 7328 7365 6c66 2e65 7863 6861  anges(self.excha
+00008de0: 6e67 652c 2068 5f65 6e64 2c20 7461 7267  nge, h_end, targ
+00008df0: 6574 5f65 6e64 5f64 742c 2073 656c 662e  et_end_dt, self.
+00008e00: 696e 7465 7276 616c 2c20 4e6f 6e65 2c20  interval, None, 
+00008e10: 6d69 6e44 6973 7461 6e63 6554 6872 6573  minDistanceThres
+00008e20: 686f 6c64 3d35 290a 2020 2020 2020 2020  hold=5).        
 00008e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e50: 7461 7267 6574 5f65 6e64 5f64 7420 3d20  target_end_dt = 
-00008e60: 7363 6865 645b 2263 6c6f 7365 225d 2e69  sched["close"].i
-00008e70: 6c6f 635b 305d 2b74 696d 6564 656c 7461  loc[0]+timedelta
-00008e80: 2868 6f75 7273 3d32 290a 2020 2020 2020  (hours=2).      
-00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ea0: 2020 2020 2020 6966 2068 5f65 6e64 203c        if h_end <
-00008eb0: 2074 6172 6765 745f 656e 645f 6474 3a0a   target_end_dt:.
-00008ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ee0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f00: 2020 2020 2020 2020 2072 616e 6765 506f           rangePo
-00008f10: 7374 5f74 6f5f 6665 7463 6820 3d20 7966  st_to_fetch = yf
-00008f20: 6374 2e49 6465 6e74 6966 794d 6973 7369  ct.IdentifyMissi
-00008f30: 6e67 496e 7465 7276 616c 5261 6e67 6573  ngIntervalRanges
-00008f40: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
-00008f50: 685f 656e 642c 2074 6172 6765 745f 656e  h_end, target_en
-00008f60: 645f 6474 2c20 7365 6c66 2e69 6e74 6572  d_dt, self.inter
-00008f70: 7661 6c2c 204e 6f6e 652c 206d 696e 4469  val, None, minDi
-00008f80: 7374 616e 6365 5468 7265 7368 6f6c 643d  stanceThreshold=
-00008f90: 3529 0a20 2020 2020 2020 2020 2020 2020  5).             
-00008fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008fb0: 2020 2065 7863 6570 7420 7966 6364 2e4e     except yfcd.N
-00008fc0: 6f49 6e74 6572 7661 6c73 496e 5261 6e67  oIntervalsInRang
-00008fd0: 6545 7863 6570 7469 6f6e 3a0a 2020 2020  eException:.    
-00008fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009000: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
-00009010: 6368 203d 204e 6f6e 650a 2020 2020 2020  ch = None.      
-00009020: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00009030: 6e67 6573 5f74 6f5f 6665 7463 6820 3d20  nges_to_fetch = 
-00009040: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-00009050: 2020 2020 2020 2069 6620 7261 6e67 6550         if rangeP
-00009060: 6f73 745f 746f 5f66 6574 6368 2069 7320  ost_to_fetch is 
-00009070: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00009080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009090: 2020 6966 206c 656e 2872 616e 6765 506f    if len(rangePo
-000090a0: 7374 5f74 6f5f 6665 7463 6829 203e 2031  st_to_fetch) > 1
-000090b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000090c0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000090d0: 6973 6520 4578 6365 7074 696f 6e28 2245  ise Exception("E
-000090e0: 7870 6563 7465 6420 6f6e 6c79 206f 6e65  xpected only one
-000090f0: 2065 6c65 6d65 6e74 2069 6e20 7261 6e67   element in rang
-00009100: 6550 6f73 745f 746f 5f66 6574 6368 5b5d  ePost_to_fetch[]
-00009110: 2c20 6275 7420 3d20 7b7d 222e 666f 726d  , but = {}".form
-00009120: 6174 2872 616e 6765 506f 7374 5f74 6f5f  at(rangePost_to_
-00009130: 6665 7463 6829 290a 2020 2020 2020 2020  fetch)).        
-00009140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009150: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
-00009160: 6368 203d 2072 616e 6765 506f 7374 5f74  ch = rangePost_t
-00009170: 6f5f 6665 7463 685b 305d 0a20 2020 2020  o_fetch[0].     
-00009180: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009190: 6620 7261 6e67 6550 7265 5f74 6f5f 6665  f rangePre_to_fe
-000091a0: 7463 6820 6973 206e 6f74 204e 6f6e 653a  tch is not None:
-000091b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000091c0: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
-000091d0: 746f 5f66 6574 6368 2e61 7070 656e 6428  to_fetch.append(
-000091e0: 7261 6e67 6550 7265 5f74 6f5f 6665 7463  rangePre_to_fetc
-000091f0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00009200: 2020 2020 2020 2069 6620 7261 6e67 6550         if rangeP
-00009210: 6f73 745f 746f 5f66 6574 6368 2069 7320  ost_to_fetch is 
-00009220: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00009230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009240: 2020 7261 6e67 6573 5f74 6f5f 6665 7463    ranges_to_fetc
-00009250: 682e 6170 7065 6e64 2872 616e 6765 506f  h.append(rangePo
-00009260: 7374 5f74 6f5f 6665 7463 6829 0a20 2020  st_to_fetch).   
-00009270: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00009280: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00009290: 5f69 6e74 6572 7661 6c73 203d 2079 6663  _intervals = yfc
-000092a0: 742e 4765 7454 696d 6573 7461 6d70 4375  t.GetTimestampCu
-000092b0: 7272 656e 7449 6e74 6572 7661 6c5f 6261  rrentInterval_ba
-000092c0: 7463 6828 7365 6c66 2e65 7863 6861 6e67  tch(self.exchang
-000092d0: 652c 2068 5f69 6e74 6572 7661 6c5f 6474  e, h_interval_dt
-000092e0: 732c 2073 656c 662e 696e 7465 7276 616c  s, self.interval
-000092f0: 2c20 6967 6e6f 7265 5f62 7265 616b 733d  , ignore_breaks=
-00009300: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-00009310: 2020 2020 2020 6966 2068 5f69 6e74 6572        if h_inter
-00009320: 7661 6c73 2069 7320 4e6f 6e65 3a0a 2020  vals is None:.  
-00009330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009340: 2020 685f 696e 7465 7276 616c 7320 3d20    h_intervals = 
-00009350: 7064 2e44 6174 6146 7261 6d65 2864 6174  pd.DataFrame(dat
-00009360: 613d 7b22 696e 7465 7276 616c 5f6f 7065  a={"interval_ope
-00009370: 6e22 3a20 5b5d 2c20 2269 6e74 6572 7661  n": [], "interva
-00009380: 6c5f 636c 6f73 6522 3a20 5b5d 7d29 0a20  l_close": []}). 
-00009390: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000093a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000093b0: 2020 2020 2020 2020 2066 5f6e 6120 3d20           f_na = 
-000093c0: 685f 696e 7465 7276 616c 735b 2269 6e74  h_intervals["int
-000093d0: 6572 7661 6c5f 6f70 656e 225d 2e69 736e  erval_open"].isn
-000093e0: 6128 292e 746f 5f6e 756d 7079 2829 0a20  a().to_numpy(). 
+00008e40: 2020 2020 2020 2020 6578 6365 7074 2079          except y
+00008e50: 6663 642e 4e6f 496e 7465 7276 616c 7349  fcd.NoIntervalsI
+00008e60: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
+00008e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e90: 2020 2020 2072 616e 6765 506f 7374 5f74       rangePost_t
+00008ea0: 6f5f 6665 7463 6820 3d20 4e6f 6e65 0a20  o_fetch = None. 
+00008eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ec0: 2020 2072 616e 6765 735f 746f 5f66 6574     ranges_to_fet
+00008ed0: 6368 203d 205b 5d0a 2020 2020 2020 2020  ch = [].        
+00008ee0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00008ef0: 616e 6765 506f 7374 5f74 6f5f 6665 7463  angePost_to_fetc
+00008f00: 6820 6973 206e 6f74 204e 6f6e 653a 0a20  h is not None:. 
+00008f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f20: 2020 2020 2020 2069 6620 6c65 6e28 7261         if len(ra
+00008f30: 6e67 6550 6f73 745f 746f 5f66 6574 6368  ngePost_to_fetch
+00008f40: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+00008f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f60: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+00008f70: 6f6e 2822 4578 7065 6374 6564 206f 6e6c  on("Expected onl
+00008f80: 7920 6f6e 6520 656c 656d 656e 7420 696e  y one element in
+00008f90: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
+00008fa0: 7463 685b 5d2c 2062 7574 203d 207b 7d22  tch[], but = {}"
+00008fb0: 2e66 6f72 6d61 7428 7261 6e67 6550 6f73  .format(rangePos
+00008fc0: 745f 746f 5f66 6574 6368 2929 0a20 2020  t_to_fetch)).   
+00008fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fe0: 2020 2020 2072 616e 6765 506f 7374 5f74       rangePost_t
+00008ff0: 6f5f 6665 7463 6820 3d20 7261 6e67 6550  o_fetch = rangeP
+00009000: 6f73 745f 746f 5f66 6574 6368 5b30 5d0a  ost_to_fetch[0].
+00009010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009020: 2020 2020 6966 2072 616e 6765 5072 655f      if rangePre_
+00009030: 746f 5f66 6574 6368 2069 7320 6e6f 7420  to_fetch is not 
+00009040: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00009050: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00009060: 6e67 6573 5f74 6f5f 6665 7463 682e 6170  nges_to_fetch.ap
+00009070: 7065 6e64 2872 616e 6765 5072 655f 746f  pend(rangePre_to
+00009080: 5f66 6574 6368 290a 2020 2020 2020 2020  _fetch).        
+00009090: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+000090a0: 616e 6765 506f 7374 5f74 6f5f 6665 7463  angePost_to_fetc
+000090b0: 6820 6973 206e 6f74 204e 6f6e 653a 0a20  h is not None:. 
+000090c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090d0: 2020 2020 2020 2072 616e 6765 735f 746f         ranges_to
+000090e0: 5f66 6574 6368 2e61 7070 656e 6428 7261  _fetch.append(ra
+000090f0: 6e67 6550 6f73 745f 746f 5f66 6574 6368  ngePost_to_fetch
+00009100: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00009110: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009120: 2020 2020 685f 696e 7465 7276 616c 7320      h_intervals 
+00009130: 3d20 7966 6374 2e47 6574 5469 6d65 7374  = yfct.GetTimest
+00009140: 616d 7043 7572 7265 6e74 496e 7465 7276  ampCurrentInterv
+00009150: 616c 5f62 6174 6368 2873 656c 662e 6578  al_batch(self.ex
+00009160: 6368 616e 6765 2c20 685f 696e 7465 7276  change, h_interv
+00009170: 616c 5f64 7473 2c20 7365 6c66 2e69 6e74  al_dts, self.int
+00009180: 6572 7661 6c2c 2069 676e 6f72 655f 6272  erval, ignore_br
+00009190: 6561 6b73 3d54 7275 6529 0a20 2020 2020  eaks=True).     
+000091a0: 2020 2020 2020 2020 2020 2069 6620 685f             if h_
+000091b0: 696e 7465 7276 616c 7320 6973 204e 6f6e  intervals is Non
+000091c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000091d0: 2020 2020 2020 2068 5f69 6e74 6572 7661         h_interva
+000091e0: 6c73 203d 2070 642e 4461 7461 4672 616d  ls = pd.DataFram
+000091f0: 6528 6461 7461 3d7b 2269 6e74 6572 7661  e(data={"interva
+00009200: 6c5f 6f70 656e 223a 205b 5d2c 2022 696e  l_open": [], "in
+00009210: 7465 7276 616c 5f63 6c6f 7365 223a 205b  terval_close": [
+00009220: 5d7d 290a 2020 2020 2020 2020 2020 2020  ]}).            
+00009230: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00009240: 2020 2020 2020 2020 2020 2020 2020 665f                f_
+00009250: 6e61 203d 2068 5f69 6e74 6572 7661 6c73  na = h_intervals
+00009260: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
+00009270: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
+00009280: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+00009290: 2020 2020 2020 2020 6966 2066 5f6e 612e          if f_na.
+000092a0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+000092b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000092c0: 204d 6170 7069 6e67 2059 6168 6f6f 2069   Mapping Yahoo i
+000092d0: 6e74 6572 7661 6c73 202d 3e20 7863 616c  ntervals -> xcal
+000092e0: 2063 616e 2066 6169 6c20 6e6f 772c 2062   can fail now, b
+000092f0: 6563 6175 7365 2073 6f6d 6574 696d 6520  ecause sometime 
+00009300: 7863 616c 2069 7320 7772 6f6e 672e 0a20  xcal is wrong.. 
+00009310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009320: 2020 2020 2020 2023 204e 6565 6420 746f         # Need to
+00009330: 2074 6f6c 6572 6174 650a 2020 2020 2020   tolerate.      
+00009340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009350: 2020 685f 696e 7465 7276 616c 732e 6c6f    h_intervals.lo
+00009360: 635b 665f 6e61 2c20 2269 6e74 6572 7661  c[f_na, "interva
+00009370: 6c5f 6f70 656e 225d 203d 2068 5f69 6e74  l_open"] = h_int
+00009380: 6572 7661 6c5f 6474 735b 665f 6e61 5d0a  erval_dts[f_na].
+00009390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093a0: 2020 2020 2020 2020 685f 696e 7465 7276          h_interv
+000093b0: 616c 732e 6c6f 635b 665f 6e61 2c20 2269  als.loc[f_na, "i
+000093c0: 6e74 6572 7661 6c5f 636c 6f73 6522 5d20  nterval_close"] 
+000093d0: 3d20 685f 696e 7465 7276 616c 5f64 7473  = h_interval_dts
+000093e0: 5b66 5f6e 615d 2b73 656c 662e 6974 640a  [f_na]+self.itd.
 000093f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009400: 2020 2069 6620 665f 6e61 2e61 6e79 2829     if f_na.any()
-00009410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009420: 2020 2020 2020 2020 2020 2320 4d61 7070            # Mapp
-00009430: 696e 6720 5961 686f 6f20 696e 7465 7276  ing Yahoo interv
-00009440: 616c 7320 2d3e 2078 6361 6c20 6361 6e20  als -> xcal can 
-00009450: 6661 696c 206e 6f77 2c20 6265 6361 7573  fail now, becaus
-00009460: 6520 736f 6d65 7469 6d65 2078 6361 6c20  e sometime xcal 
-00009470: 6973 2077 726f 6e67 2e0a 2020 2020 2020  is wrong..      
-00009480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009490: 2020 2320 4e65 6564 2074 6f20 746f 6c65    # Need to tole
-000094a0: 7261 7465 0a20 2020 2020 2020 2020 2020  rate.           
-000094b0: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
-000094c0: 6e74 6572 7661 6c73 2e6c 6f63 5b66 5f6e  ntervals.loc[f_n
-000094d0: 612c 2022 696e 7465 7276 616c 5f6f 7065  a, "interval_ope
-000094e0: 6e22 5d20 3d20 685f 696e 7465 7276 616c  n"] = h_interval
-000094f0: 5f64 7473 5b66 5f6e 615d 0a20 2020 2020  _dts[f_na].     
-00009500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009510: 2020 2068 5f69 6e74 6572 7661 6c73 2e6c     h_intervals.l
-00009520: 6f63 5b66 5f6e 612c 2022 696e 7465 7276  oc[f_na, "interv
-00009530: 616c 5f63 6c6f 7365 225d 203d 2068 5f69  al_close"] = h_i
-00009540: 6e74 6572 7661 6c5f 6474 735b 665f 6e61  nterval_dts[f_na
-00009550: 5d2b 7365 6c66 2e69 7464 0a20 2020 2020  ]+self.itd.     
-00009560: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
-00009570: 6f74 2068 5f69 6e74 6572 7661 6c73 2e65  ot h_intervals.e
-00009580: 6d70 7479 2920 616e 6420 6973 696e 7374  mpty) and isinst
-00009590: 616e 6365 2868 5f69 6e74 6572 7661 6c73  ance(h_intervals
-000095a0: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
-000095b0: 5d2e 696c 6f63 5b30 5d2c 2064 6174 6574  ].iloc[0], datet
-000095c0: 696d 6529 3a0a 2020 2020 2020 2020 2020  ime):.          
-000095d0: 2020 2020 2020 2020 2020 685f 696e 7465            h_inte
-000095e0: 7276 616c 5f6f 7065 6e73 203d 205b 782e  rval_opens = [x.
-000095f0: 746f 5f70 7964 6174 6574 696d 6528 292e  to_pydatetime().
-00009600: 6173 7469 6d65 7a6f 6e65 2874 7a5f 6578  astimezone(tz_ex
-00009610: 6368 616e 6765 2920 666f 7220 7820 696e  change) for x in
-00009620: 2068 5f69 6e74 6572 7661 6c73 5b22 696e   h_intervals["in
-00009630: 7465 7276 616c 5f6f 7065 6e22 5d5d 0a20  terval_open"]]. 
-00009640: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00009650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00009660: 2020 2020 2020 2020 2068 5f69 6e74 6572           h_inter
-00009670: 7661 6c5f 6f70 656e 7320 3d20 685f 696e  val_opens = h_in
-00009680: 7465 7276 616c 735b 2269 6e74 6572 7661  tervals["interva
-00009690: 6c5f 6f70 656e 225d 2e74 6f5f 6e75 6d70  l_open"].to_nump
-000096a0: 7928 290a 0a20 2020 2020 2020 2020 2020  y()..           
-000096b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000096c0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-000096d0: 7267 6574 5f65 6e64 203d 2065 6e64 0a20  rget_end = end. 
-000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096f0: 2020 2069 6620 7365 6c66 2e6d 756c 7469     if self.multi
-00009700: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
-00009710: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00009720: 6765 745f 656e 6420 2b3d 2073 656c 662e  get_end += self.
-00009730: 6974 640a 2020 2020 2020 2020 2020 2020  itd.            
-00009740: 2020 2020 2020 2020 7261 6e67 6573 5f74          ranges_t
-00009750: 6f5f 6665 7463 6820 3d20 7966 6374 2e49  o_fetch = yfct.I
-00009760: 6465 6e74 6966 794d 6973 7369 6e67 496e  dentifyMissingIn
-00009770: 7465 7276 616c 5261 6e67 6573 2873 656c  tervalRanges(sel
-00009780: 662e 6578 6368 616e 6765 2c20 7374 6172  f.exchange, star
-00009790: 742c 2074 6172 6765 745f 656e 642c 2073  t, target_end, s
-000097a0: 656c 662e 696e 7465 7276 616c 2c20 685f  elf.interval, h_
-000097b0: 696e 7465 7276 616c 5f6f 7065 6e73 2c20  interval_opens, 
-000097c0: 6967 6e6f 7265 5f62 7265 616b 733d 5472  ignore_breaks=Tr
-000097d0: 7565 2c20 6d69 6e44 6973 7461 6e63 6554  ue, minDistanceT
-000097e0: 6872 6573 686f 6c64 3d35 290a 2020 2020  hreshold=5).    
-000097f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009800: 6966 2072 616e 6765 735f 746f 5f66 6574  if ranges_to_fet
-00009810: 6368 2069 7320 4e6f 6e65 3a0a 2020 2020  ch is None:.    
-00009820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009830: 2020 2020 7261 6e67 6573 5f74 6f5f 6665      ranges_to_fe
-00009840: 7463 6820 3d20 5b5d 0a20 2020 2020 2020  tch = [].       
-00009850: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00009860: 7966 6364 2e4e 6f49 6e74 6572 7661 6c73  yfcd.NoIntervals
-00009870: 496e 5261 6e67 6545 7863 6570 7469 6f6e  InRangeException
-00009880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009890: 2020 2020 2020 7261 6e67 6573 5f74 6f5f        ranges_to_
-000098a0: 6665 7463 6820 3d20 5b5d 0a20 2020 2020  fetch = [].     
-000098b0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-000098c0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
-000098d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000098e0: 2070 7269 6e74 2822 5469 636b 6572 203d   print("Ticker =
-000098f0: 222c 2073 656c 662e 7469 636b 6572 290a  ", self.ticker).
-00009900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009910: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
-00009920: 2020 2020 2020 2320 5072 756e 6520 7261        # Prune ra
-00009930: 6e67 6573 2069 6e20 6675 7475 7265 3a0a  nges in future:.
-00009940: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00009950: 6920 696e 2072 616e 6765 286c 656e 2872  i in range(len(r
-00009960: 616e 6765 735f 746f 5f66 6574 6368 292d  anges_to_fetch)-
-00009970: 312c 202d 312c 202d 3129 3a0a 2020 2020  1, -1, -1):.    
-00009980: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-00009990: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
-000099a0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
-000099b0: 2020 2078 203d 2072 5b30 5d0a 2020 2020     x = r[0].    
-000099c0: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
-000099d0: 7465 5f72 616e 6765 203d 2046 616c 7365  te_range = False
-000099e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000099f0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-00009a00: 2c20 2864 6174 6574 696d 652c 2070 642e  , (datetime, pd.
-00009a10: 5469 6d65 7374 616d 7029 293a 0a20 2020  Timestamp)):.   
-00009a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a30: 2069 6620 7820 3e20 6474 5f6e 6f77 3a0a   if x > dt_now:.
-00009a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a50: 2020 2020 2020 2020 6465 6c65 7465 5f72          delete_r
-00009a60: 616e 6765 203d 2054 7275 650a 2020 2020  ange = True.    
-00009a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009a90: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-00009aa0: 6865 6420 3d20 7966 6374 2e47 6574 4578  hed = yfct.GetEx
-00009ab0: 6368 616e 6765 5363 6865 6475 6c65 2873  changeSchedule(s
-00009ac0: 656c 662e 6578 6368 616e 6765 2c20 782e  elf.exchange, x.
-00009ad0: 6461 7465 2829 2c20 782e 6461 7465 2829  date(), x.date()
-00009ae0: 202b 2074 645f 3164 290a 2020 2020 2020   + td_1d).      
+00009400: 6966 2028 6e6f 7420 685f 696e 7465 7276  if (not h_interv
+00009410: 616c 732e 656d 7074 7929 2061 6e64 2069  als.empty) and i
+00009420: 7369 6e73 7461 6e63 6528 685f 696e 7465  sinstance(h_inte
+00009430: 7276 616c 735b 2269 6e74 6572 7661 6c5f  rvals["interval_
+00009440: 6f70 656e 225d 2e69 6c6f 635b 305d 2c20  open"].iloc[0], 
+00009450: 6461 7465 7469 6d65 293a 0a20 2020 2020  datetime):.     
+00009460: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00009470: 5f69 6e74 6572 7661 6c5f 6f70 656e 7320  _interval_opens 
+00009480: 3d20 5b78 2e74 6f5f 7079 6461 7465 7469  = [x.to_pydateti
+00009490: 6d65 2829 2e61 7374 696d 657a 6f6e 6528  me().astimezone(
+000094a0: 747a 5f65 7863 6861 6e67 6529 2066 6f72  tz_exchange) for
+000094b0: 2078 2069 6e20 685f 696e 7465 7276 616c   x in h_interval
+000094c0: 735b 2269 6e74 6572 7661 6c5f 6f70 656e  s["interval_open
+000094d0: 225d 5d0a 2020 2020 2020 2020 2020 2020  "]].            
+000094e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000094f0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+00009500: 696e 7465 7276 616c 5f6f 7065 6e73 203d  interval_opens =
+00009510: 2068 5f69 6e74 6572 7661 6c73 5b22 696e   h_intervals["in
+00009520: 7465 7276 616c 5f6f 7065 6e22 5d2e 746f  terval_open"].to
+00009530: 5f6e 756d 7079 2829 0a0a 2020 2020 2020  _numpy()..      
+00009540: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00009550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009560: 2020 2074 6172 6765 745f 656e 6420 3d20     target_end = 
+00009570: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
+00009580: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00009590: 6d75 6c74 6964 6179 3a0a 2020 2020 2020  multiday:.      
+000095a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095b0: 2020 7461 7267 6574 5f65 6e64 202b 3d20    target_end += 
+000095c0: 7365 6c66 2e69 7464 0a20 2020 2020 2020  self.itd.       
+000095d0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+000095e0: 6765 735f 746f 5f66 6574 6368 203d 2079  ges_to_fetch = y
+000095f0: 6663 742e 4964 656e 7469 6679 4d69 7373  fct.IdentifyMiss
+00009600: 696e 6749 6e74 6572 7661 6c52 616e 6765  ingIntervalRange
+00009610: 7328 7365 6c66 2e65 7863 6861 6e67 652c  s(self.exchange,
+00009620: 2073 7461 7274 2c20 7461 7267 6574 5f65   start, target_e
+00009630: 6e64 2c20 7365 6c66 2e69 6e74 6572 7661  nd, self.interva
+00009640: 6c2c 2068 5f69 6e74 6572 7661 6c5f 6f70  l, h_interval_op
+00009650: 656e 732c 2069 676e 6f72 655f 6272 6561  ens, ignore_brea
+00009660: 6b73 3d54 7275 652c 206d 696e 4469 7374  ks=True, minDist
+00009670: 616e 6365 5468 7265 7368 6f6c 643d 3529  anceThreshold=5)
+00009680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009690: 2020 2020 2069 6620 7261 6e67 6573 5f74       if ranges_t
+000096a0: 6f5f 6665 7463 6820 6973 204e 6f6e 653a  o_fetch is None:
+000096b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000096c0: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
+000096d0: 746f 5f66 6574 6368 203d 205b 5d0a 2020  to_fetch = [].  
+000096e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000096f0: 6365 7074 2079 6663 642e 4e6f 496e 7465  cept yfcd.NoInte
+00009700: 7276 616c 7349 6e52 616e 6765 4578 6365  rvalsInRangeExce
+00009710: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+00009720: 2020 2020 2020 2020 2020 2072 616e 6765             range
+00009730: 735f 746f 5f66 6574 6368 203d 205b 5d0a  s_to_fetch = [].
+00009740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009750: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00009760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009770: 2020 2020 2020 7072 696e 7428 2254 6963        print("Tic
+00009780: 6b65 7220 3d22 2c20 7365 6c66 2e74 6963  ker =", self.tic
+00009790: 6b65 7229 0a20 2020 2020 2020 2020 2020  ker).           
+000097a0: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
+000097b0: 2020 2020 2020 2020 2020 2023 2050 7275             # Pru
+000097c0: 6e65 2072 616e 6765 7320 696e 2066 7574  ne ranges in fut
+000097d0: 7572 653a 0a20 2020 2020 2020 2020 2020  ure:.           
+000097e0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+000097f0: 6c65 6e28 7261 6e67 6573 5f74 6f5f 6665  len(ranges_to_fe
+00009800: 7463 6829 2d31 2c20 2d31 2c20 2d31 293a  tch)-1, -1, -1):
+00009810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009820: 2072 203d 2072 616e 6765 735f 746f 5f66   r = ranges_to_f
+00009830: 6574 6368 5b69 5d0a 2020 2020 2020 2020  etch[i].        
+00009840: 2020 2020 2020 2020 7820 3d20 725b 305d          x = r[0]
+00009850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009860: 2064 656c 6574 655f 7261 6e67 6520 3d20   delete_range = 
+00009870: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00009880: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00009890: 6e63 6528 782c 2028 6461 7465 7469 6d65  nce(x, (datetime
+000098a0: 2c20 7064 2e54 696d 6573 7461 6d70 2929  , pd.Timestamp))
+000098b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000098c0: 2020 2020 2020 6966 2078 203e 2064 745f        if x > dt_
+000098d0: 6e6f 773a 0a20 2020 2020 2020 2020 2020  now:.           
+000098e0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+000098f0: 6574 655f 7261 6e67 6520 3d20 5472 7565  ete_range = True
+00009900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009910: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 2020 2073 6368 6564 203d 2079 6663 742e     sched = yfct.
+00009940: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
+00009950: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
+00009960: 652c 2078 2e64 6174 6528 292c 2078 2e64  e, x.date(), x.d
+00009970: 6174 6528 2920 2b20 7464 5f31 6429 0a20  ate() + td_1d). 
+00009980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009990: 2020 2020 2020 2064 656c 6574 655f 7261         delete_ra
+000099a0: 6e67 6520 3d20 2873 6368 6564 2069 7320  nge = (sched is 
+000099b0: 6e6f 7420 4e6f 6e65 2920 616e 6420 6474  not None) and dt
+000099c0: 5f6e 6f77 203c 2028 7363 6865 645b 226f  _now < (sched["o
+000099d0: 7065 6e22 5d2e 696c 6f63 5b30 5d20 2b20  pen"].iloc[0] + 
+000099e0: 7966 5f6c 6167 290a 2020 2020 2020 2020  yf_lag).        
+000099f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a10: 2020 6966 2064 6174 6574 696d 652e 636f    if datetime.co
+00009a20: 6d62 696e 6528 782c 2074 696d 6528 3029  mbine(x, time(0)
+00009a30: 2c20 747a 696e 666f 3d74 7a5f 6578 6368  , tzinfo=tz_exch
+00009a40: 616e 6765 2920 3e20 6474 5f6e 6f77 3a0a  ange) > dt_now:.
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a60: 2020 2020 2020 2020 6465 6c65 7465 5f72          delete_r
+00009a70: 616e 6765 203d 2054 7275 650a 2020 2020  ange = True.    
+00009a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00009aa0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00009ab0: 6865 6420 3d20 7966 6374 2e47 6574 4578  hed = yfct.GetEx
+00009ac0: 6368 616e 6765 5363 6865 6475 6c65 2873  changeSchedule(s
+00009ad0: 656c 662e 6578 6368 616e 6765 2c20 782c  elf.exchange, x,
+00009ae0: 2078 202b 2074 645f 3164 290a 2020 2020   x + td_1d).    
 00009af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b00: 2020 6465 6c65 7465 5f72 616e 6765 203d    delete_range =
-00009b10: 2028 7363 6865 6420 6973 206e 6f74 204e   (sched is not N
-00009b20: 6f6e 6529 2061 6e64 2064 745f 6e6f 7720  one) and dt_now 
-00009b30: 3c20 2873 6368 6564 5b22 6f70 656e 225d  < (sched["open"]
-00009b40: 2e69 6c6f 635b 305d 202b 2079 665f 6c61  .iloc[0] + yf_la
-00009b50: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00009b60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00009b70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00009b80: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
-00009b90: 2878 2c20 7469 6d65 2830 292c 2074 7a69  (x, time(0), tzi
-00009ba0: 6e66 6f3d 747a 5f65 7863 6861 6e67 6529  nfo=tz_exchange)
-00009bb0: 203e 2064 745f 6e6f 773a 0a20 2020 2020   > dt_now:.     
-00009bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009bd0: 2020 2064 656c 6574 655f 7261 6e67 6520     delete_range 
-00009be0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-00009bf0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00009c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009c10: 2020 2020 2020 2020 2073 6368 6564 203d           sched =
-00009c20: 2079 6663 742e 4765 7445 7863 6861 6e67   yfct.GetExchang
-00009c30: 6553 6368 6564 756c 6528 7365 6c66 2e65  eSchedule(self.e
-00009c40: 7863 6861 6e67 652c 2078 2c20 7820 2b20  xchange, x, x + 
-00009c50: 7464 5f31 6429 0a20 2020 2020 2020 2020  td_1d).         
-00009c60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009c70: 656c 6574 655f 7261 6e67 6520 3d20 2873  elete_range = (s
-00009c80: 6368 6564 2069 7320 6e6f 7420 4e6f 6e65  ched is not None
-00009c90: 2920 616e 6420 6474 5f6e 6f77 203c 2028  ) and dt_now < (
-00009ca0: 7363 6865 645b 226f 7065 6e22 5d2e 696c  sched["open"].il
-00009cb0: 6f63 5b30 5d20 2b20 7966 5f6c 6167 290a  oc[0] + yf_lag).
-00009cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cd0: 6966 2064 656c 6574 655f 7261 6e67 653a  if delete_range:
-00009ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009cf0: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
-00009d00: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-00009d10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00009d20: 2822 2d20 6465 6c65 7469 6e67 2066 7574  ("- deleting fut
-00009d30: 7572 6520 7261 6e67 653a 222c 2072 5b69  ure range:", r[i
-00009d40: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00009d50: 2020 2020 2020 2064 656c 2072 616e 6765         del range
-00009d60: 735f 746f 5f66 6574 6368 5b69 5d0a 2020  s_to_fetch[i].  
-00009d70: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00009d80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009d90: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00009da0: 6966 2072 616e 6765 2065 6e64 7320 696e  if range ends in
-00009db0: 2066 7574 7572 652c 2069 6620 7965 7320   future, if yes 
-00009dc0: 7468 656e 2061 646a 7573 7420 746f 2074  then adjust to t
-00009dd0: 6f6d 6f72 726f 7720 6d61 780a 2020 2020  omorrow max.    
+00009b00: 2020 2020 6465 6c65 7465 5f72 616e 6765      delete_range
+00009b10: 203d 2028 7363 6865 6420 6973 206e 6f74   = (sched is not
+00009b20: 204e 6f6e 6529 2061 6e64 2064 745f 6e6f   None) and dt_no
+00009b30: 7720 3c20 2873 6368 6564 5b22 6f70 656e  w < (sched["open
+00009b40: 225d 2e69 6c6f 635b 305d 202b 2079 665f  "].iloc[0] + yf_
+00009b50: 6c61 6729 0a20 2020 2020 2020 2020 2020  lag).           
+00009b60: 2020 2020 2069 6620 6465 6c65 7465 5f72       if delete_r
+00009b70: 616e 6765 3a0a 2020 2020 2020 2020 2020  ange:.          
+00009b80: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00009b90: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00009ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bb0: 7072 696e 7428 222d 2064 656c 6574 696e  print("- deletin
+00009bc0: 6720 6675 7475 7265 2072 616e 6765 3a22  g future range:"
+00009bd0: 2c20 725b 695d 290a 2020 2020 2020 2020  , r[i]).        
+00009be0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00009bf0: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
+00009c00: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00009c10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00009c20: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+00009c30: 6865 636b 2069 6620 7261 6e67 6520 656e  heck if range en
+00009c40: 6473 2069 6e20 6675 7475 7265 2c20 6966  ds in future, if
+00009c50: 2079 6573 2074 6865 6e20 6164 6a75 7374   yes then adjust
+00009c60: 2074 6f20 746f 6d6f 7272 6f77 206d 6178   to tomorrow max
+00009c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009c80: 2020 2020 2079 203d 2072 5b31 5d0a 2020       y = r[1].  
+00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ca0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00009cb0: 792c 2028 6461 7465 7469 6d65 2c20 7064  y, (datetime, pd
+00009cc0: 2e54 696d 6573 7461 6d70 2929 3a0a 2020  .Timestamp)):.  
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ce0: 2020 2020 2020 6966 2079 203e 2064 745f        if y > dt_
+00009cf0: 6e6f 773a 0a20 2020 2020 2020 2020 2020  now:.           
+00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d10: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+00009d20: 5b69 5d20 3d20 2872 5b30 5d2c 206d 696e  [i] = (r[0], min
+00009d30: 2864 745f 6e6f 772e 6365 696c 2827 3144  (dt_now.ceil('1D
+00009d40: 2729 2c20 7929 290a 2020 2020 2020 2020  '), y)).        
+00009d50: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00009d60: 2079 203e 2064 5f6e 6f77 5f65 7863 6861   y > d_now_excha
+00009d70: 6e67 653a 0a20 2020 2020 2020 2020 2020  nge:.           
+00009d80: 2020 2020 2020 2020 2020 2020 2073 6368               sch
+00009d90: 6564 203d 2079 6663 742e 4765 7445 7863  ed = yfct.GetExc
+00009da0: 6861 6e67 6553 6368 6564 756c 6528 7365  hangeSchedule(se
+00009db0: 6c66 2e65 7863 6861 6e67 652c 2064 5f6e  lf.exchange, d_n
+00009dc0: 6f77 5f65 7863 6861 6e67 652c 2079 202b  ow_exchange, y +
+00009dd0: 2074 645f 3164 290a 2020 2020 2020 2020   td_1d).        
 00009de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009df0: 7920 3d20 725b 315d 0a20 2020 2020 2020  y = r[1].       
-00009e00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00009e10: 6973 696e 7374 616e 6365 2879 2c20 2864  isinstance(y, (d
-00009e20: 6174 6574 696d 652c 2070 642e 5469 6d65  atetime, pd.Time
-00009e30: 7374 616d 7029 293a 0a20 2020 2020 2020  stamp)):.       
+00009df0: 6966 2073 6368 6564 2069 7320 6e6f 7420  if sched is not 
+00009e00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00009e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e20: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e50: 2069 6620 7920 3e20 6474 5f6e 6f77 3a0a   if y > dt_now:.
-00009e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e70: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-00009e80: 6573 5f74 6f5f 6665 7463 685b 695d 203d  es_to_fetch[i] =
-00009e90: 2028 725b 305d 2c20 6d69 6e28 6474 5f6e   (r[0], min(dt_n
-00009ea0: 6f77 2e63 6569 6c28 2731 4427 292c 2079  ow.ceil('1D'), y
-00009eb0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00009ec0: 2020 2020 2020 2065 6c69 6620 7920 3e20         elif y > 
-00009ed0: 645f 6e6f 775f 6578 6368 616e 6765 3a0a  d_now_exchange:.
-00009ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ef0: 2020 2020 2020 2020 7363 6865 6420 3d20          sched = 
-00009f00: 7966 6374 2e47 6574 4578 6368 616e 6765  yfct.GetExchange
-00009f10: 5363 6865 6475 6c65 2873 656c 662e 6578  Schedule(self.ex
-00009f20: 6368 616e 6765 2c20 645f 6e6f 775f 6578  change, d_now_ex
-00009f30: 6368 616e 6765 2c20 7920 2b20 7464 5f31  change, y + td_1
-00009f40: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-00009f50: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-00009f60: 6865 6420 6973 206e 6f74 204e 6f6e 653a  hed is not None:
-00009f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009f80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00009f90: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
-00009fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fb0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00009fc0: 2822 2d20 6361 7070 696e 6720 6c61 7374  ("- capping last
-00009fd0: 2072 616e 6765 5f74 6f5f 6665 7463 6820   range_to_fetch 
-00009fe0: 656e 6420 746f 2064 5f6e 6f77 5f65 7863  end to d_now_exc
-00009ff0: 6861 6e67 6522 290a 2020 2020 2020 2020  hange").        
-0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a010: 2020 2020 6966 2064 745f 6e6f 7720 3c20      if dt_now < 
-0000a020: 7363 6865 645b 226f 7065 6e22 5d2e 696c  sched["open"].il
-0000a030: 6f63 5b30 5d3a 0a20 2020 2020 2020 2020  oc[0]:.         
-0000a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a050: 2020 2020 2020 2072 616e 6765 735f 746f         ranges_to
-0000a060: 5f66 6574 6368 5b69 5d20 3d20 2872 5b30  _fetch[i] = (r[0
-0000a070: 5d2c 2064 5f6e 6f77 5f65 7863 6861 6e67  ], d_now_exchang
-0000a080: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0000a090: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000a0a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2020 2072 616e 6765 735f 746f 5f66       ranges_to_f
-0000a0d0: 6574 6368 5b69 5d20 3d20 2872 5b30 5d2c  etch[i] = (r[0],
-0000a0e0: 2064 5f6e 6f77 5f65 7863 6861 6e67 6520   d_now_exchange 
-0000a0f0: 2b20 7464 5f31 6429 0a0a 2020 2020 2020  + td_1d)..      
-0000a100: 2020 2020 2020 2320 496d 706f 7274 616e        # Importan
-0000a110: 7420 7468 6174 2072 616e 6765 735f 746f  t that ranges_to
-0000a120: 5f66 6574 6368 2069 6e20 7265 7665 7273  _fetch in revers
-0000a130: 6520 6f72 6465 7221 0a20 2020 2020 2020  e order!.       
-0000a140: 2020 2020 2072 616e 6765 735f 746f 5f66       ranges_to_f
-0000a150: 6574 6368 2e73 6f72 7428 6b65 793d 6c61  etch.sort(key=la
-0000a160: 6d62 6461 2078 3a20 785b 305d 2c20 7265  mbda x: x[0], re
-0000a170: 7665 7273 653d 5472 7565 290a 2020 2020  verse=True).    
-0000a180: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-0000a190: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
-0000a1a0: 2020 2020 2020 7072 696e 7428 222d 2072        print("- r
-0000a1b0: 616e 6765 735f 746f 5f66 6574 6368 3a22  anges_to_fetch:"
-0000a1c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a1d0: 2020 7070 7269 6e74 2872 616e 6765 735f    pprint(ranges_
-0000a1e0: 746f 5f66 6574 6368 290a 0a20 2020 2020  to_fetch)..     
-0000a1f0: 2020 2020 2020 2069 6620 6c65 6e28 7261         if len(ra
-0000a200: 6e67 6573 5f74 6f5f 6665 7463 6829 203e  nges_to_fetch) >
-0000a210: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0000a220: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0000a230: 682e 656d 7074 793a 0a20 2020 2020 2020  h.empty:.       
-0000a240: 2020 2020 2020 2020 2020 2020 2023 2045               # E
-0000a250: 6e73 7572 6520 6f6e 6c79 206f 6e65 2072  nsure only one r
-0000a260: 616e 6765 206d 6178 2069 7320 6166 7465  ange max is afte
-0000a270: 7220 6361 6368 6564 2064 6174 613a 0a20  r cached data:. 
-0000a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a290: 2020 2068 5f6c 6173 745f 6474 203d 2073     h_last_dt = s
-0000a2a0: 656c 662e 682e 696e 6465 785b 2d31 5d2e  elf.h.index[-1].
-0000a2b0: 746f 5f70 7964 6174 6574 696d 6528 290a  to_pydatetime().
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-0000a2e0: 7461 6e63 6528 7261 6e67 6573 5f74 6f5f  tance(ranges_to_
-0000a2f0: 6665 7463 685b 305d 5b30 5d2c 2064 6174  fetch[0][0], dat
-0000a300: 6574 696d 6529 3a0a 2020 2020 2020 2020  etime):.        
-0000a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a320: 685f 6c61 7374 5f64 7420 3d20 685f 6c61  h_last_dt = h_la
-0000a330: 7374 5f64 742e 6173 7469 6d65 7a6f 6e65  st_dt.astimezone
-0000a340: 2874 7a5f 6578 6368 616e 6765 292e 6461  (tz_exchange).da
-0000a350: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
-0000a360: 2020 2020 2020 2020 206e 203d 2030 0a20           n = 0. 
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 2066 6f72 2072 2069 6e20 7261 6e67     for r in rang
-0000a390: 6573 5f74 6f5f 6665 7463 683a 0a20 2020  es_to_fetch:.   
-0000a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3b0: 2020 2020 2069 6620 725b 305d 203e 2068       if r[0] > h
-0000a3c0: 5f6c 6173 745f 6474 3a0a 2020 2020 2020  _last_dt:.      
-0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a3e0: 2020 2020 2020 6e20 2b3d 2031 0a20 2020        n += 1.   
-0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a400: 2069 6620 6e20 3e20 313a 0a20 2020 2020   if n > 1:.     
-0000a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a420: 2020 2070 7269 6e74 2822 7261 6e67 6573     print("ranges
-0000a430: 5f74 6f5f 6665 7463 683a 2229 0a20 2020  _to_fetch:").   
-0000a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a450: 2020 2020 2070 7072 696e 7428 7261 6e67       pprint(rang
-0000a460: 6573 5f74 6f5f 6665 7463 6829 0a20 2020  es_to_fetch).   
-0000a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a480: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0000a490: 7469 6f6e 2822 7261 6e67 6573 5f74 6f5f  tion("ranges_to_
-0000a4a0: 6665 7463 6820 636f 6e74 6169 6e73 207b  fetch contains {
-0000a4b0: 7d20 7261 6e67 6573 2074 6861 7420 6f63  } ranges that oc
-0000a4c0: 6375 7220 6166 7465 7220 685f 6c61 7374  cur after h_last
-0000a4d0: 5f64 743d 7b7d 2c20 6578 7065 6374 6564  _dt={}, expected
-0000a4e0: 2031 206d 6178 222e 666f 726d 6174 286e   1 max".format(n
-0000a4f0: 2c20 685f 6c61 7374 5f64 7429 290a 0a20  , h_last_dt)).. 
-0000a500: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a510: 2069 6620 6e6f 7420 7175 6965 743a 0a20   if not quiet:. 
-0000a520: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a530: 2020 2020 2071 7569 6574 203d 2070 6572       quiet = per
-0000a540: 696f 6420 6973 206e 6f74 204e 6f6e 6520  iod is not None 
-0000a550: 2023 2059 4643 2067 656e 6572 6174 6564   # YFC generated
-0000a560: 2064 6174 6520 7261 6e67 6520 736f 2064   date range so d
-0000a570: 6f6e 2774 2070 7269 6e74 206d 6573 7361  on't print messa
-0000a580: 6765 0a20 2020 2020 2020 2020 2020 2020  ge.             
-0000a590: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-0000a5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a5b0: 2020 2020 2071 7569 6574 203d 2046 616c       quiet = Fal
-0000a5c0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0000a5d0: 2020 2020 2020 2023 2071 7569 6574 203d         # quiet =
-0000a5e0: 206e 6f74 2064 6562 7567 5f79 6663 0a20   not debug_yfc. 
-0000a5f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a600: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
-0000a610: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-0000a620: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
-0000a630: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0000a640: 662e 636f 6e74 6967 756f 7573 3a0a 2020  f.contiguous:.  
-0000a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a660: 2020 7365 6c66 2e5f 6665 7463 6841 6e64    self._fetchAnd
-0000a670: 4164 6452 616e 6765 735f 636f 6e74 6967  AddRanges_contig
-0000a680: 756f 7573 2870 7374 722c 2072 616e 6765  uous(pstr, range
-0000a690: 735f 746f 5f66 6574 6368 2c20 7072 6570  s_to_fetch, prep
-0000a6a0: 6f73 742c 2064 6562 7567 5f79 662c 2071  ost, debug_yf, q
-0000a6b0: 7569 6574 3d71 7569 6574 290a 2020 2020  uiet=quiet).    
-0000a6c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000a6d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a6e0: 2020 2020 2020 7365 6c66 2e5f 6665 7463        self._fetc
-0000a6f0: 6841 6e64 4164 6452 616e 6765 735f 7370  hAndAddRanges_sp
-0000a700: 6172 7365 2870 7374 722c 2072 616e 6765  arse(pstr, range
-0000a710: 735f 746f 5f66 6574 6368 2c20 7072 6570  s_to_fetch, prep
-0000a720: 6f73 742c 2064 6562 7567 5f79 662c 2071  ost, debug_yf, q
-0000a730: 7569 6574 3d71 7569 6574 290a 0a20 2020  uiet=quiet)..   
-0000a740: 2020 2020 2023 2072 6570 6169 7220 6166       # repair af
-0000a750: 7465 7220 616c 6c20 6665 7463 6865 7320  ter all fetches 
-0000a760: 636f 6d70 6c65 7465 0a20 2020 2020 2020  complete.       
-0000a770: 2069 6620 7365 6c66 2e72 6570 6169 7220   if self.repair 
-0000a780: 616e 6420 7265 7061 6972 3a0a 2020 2020  and repair:.    
-0000a790: 2020 2020 2020 2020 665f 6368 6563 6b65          f_checke
-0000a7a0: 6420 3d20 7365 6c66 2e68 5b22 432d 4368  d = self.h["C-Ch
-0000a7b0: 6563 6b3f 225d 2e74 6f5f 6e75 6d70 7928  eck?"].to_numpy(
-0000a7c0: 290a 2020 2020 2020 2020 2020 2020 665f  ).            f_
-0000a7d0: 6e6f 745f 6368 6563 6b65 6420 3d20 7e66  not_checked = ~f
-0000a7e0: 5f63 6865 636b 6564 0a20 2020 2020 2020  _checked.       
-0000a7f0: 2020 2020 2069 6620 665f 6e6f 745f 6368       if f_not_ch
-0000a800: 6563 6b65 642e 616e 7928 293a 0a20 2020  ecked.any():.   
-0000a810: 2020 2020 2020 2020 2020 2020 2023 2043               # C
-0000a820: 6865 636b 2066 6f72 2031 3030 7820 6572  heck for 100x er
-0000a830: 726f 7273 2061 6372 6f73 7320 454e 5449  rors across ENTI
-0000a840: 5245 2074 6162 6c65 2077 6974 6820 7370  RE table with sp
-0000a850: 6c69 742d 6164 6a75 7374 6d65 6e74 2061  lit-adjustment a
-0000a860: 7070 6c69 6564 2074 656d 706f 7261 7269  pplied temporari
-0000a870: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-0000a880: 2020 2020 2320 506f 7465 6e74 6961 6c20      # Potential 
-0000a890: 7072 6f62 6c65 6d20 7769 7468 2076 6572  problem with ver
-0000a8a0: 7920 7370 6172 7365 2064 6174 612c 2062  y sparse data, b
-0000a8b0: 7574 2061 7373 756d 6520 6d6f 7374 2075  ut assume most u
-0000a8c0: 7365 7273 2077 696c 6c0a 2020 2020 2020  sers will.      
-0000a8d0: 2020 2020 2020 2020 2020 2320 6665 7463            # fetc
-0000a8e0: 6820 2273 7061 7273 6522 2066 6169 726c  h "sparse" fairl
-0000a8f0: 7920 636f 6e74 6967 756f 7573 6c79 2e0a  y contiguously..
-0000a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a910: 2320 2d20 6170 706c 7920 7370 6c69 742d  # - apply split-
-0000a920: 6164 6a75 7374 6d65 6e74 0a20 2020 2020  adjustment.     
-0000a930: 2020 2020 2020 2020 2020 204f 484c 4320             OHLC 
-0000a940: 3d20 5b27 4f70 656e 272c 2027 4869 6768  = ['Open', 'High
-0000a950: 272c 2027 4c6f 7727 2c20 2743 6c6f 7365  ', 'Low', 'Close
-0000a960: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-0000a970: 2020 2063 7366 203d 2073 656c 662e 685b     csf = self.h[
-0000a980: 2743 5346 275d 2e74 6f5f 6e75 6d70 7928  'CSF'].to_numpy(
-0000a990: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a9a0: 2020 666f 7220 6320 696e 204f 484c 433a    for c in OHLC:
-0000a9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a9c0: 2020 2020 2073 656c 662e 685b 635d 202a       self.h[c] *
-0000a9d0: 3d20 6373 660a 2020 2020 2020 2020 2020  = csf.          
-0000a9e0: 2020 2020 2020 7365 6c66 2e68 203d 2073        self.h = s
-0000a9f0: 656c 662e 5f72 6570 6169 7255 6e69 744d  elf._repairUnitM
-0000aa00: 6978 7570 7328 7365 6c66 2e68 290a 2020  ixups(self.h).  
-0000aa10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000aa20: 416c 736f 2072 6570 6169 7220 7370 6c69  Also repair spli
-0000aa30: 7420 6572 726f 7273 3a0a 2020 2020 2020  t errors:.      
-0000aa40: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-0000aa50: 203d 2073 656c 662e 5f66 6978 4261 6453   = self._fixBadS
-0000aa60: 746f 636b 5370 6c69 7428 7365 6c66 2e68  tockSplit(self.h
-0000aa70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000aa80: 2020 2320 2d20 7265 7665 7273 6520 7370    # - reverse sp
-0000aa90: 6c69 742d 6164 6a75 7374 6d65 6e74 0a20  lit-adjustment. 
-0000aaa0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000aab0: 7366 5f72 6370 203d 2031 2e30 2f73 656c  sf_rcp = 1.0/sel
-0000aac0: 662e 685b 2743 5346 275d 2e74 6f5f 6e75  f.h['CSF'].to_nu
-0000aad0: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-0000aae0: 2020 2020 2020 666f 7220 6320 696e 204f        for c in O
-0000aaf0: 484c 433a 0a20 2020 2020 2020 2020 2020  HLC:.           
-0000ab00: 2020 2020 2020 2020 2073 656c 662e 685b           self.h[
-0000ab10: 635d 202a 3d20 6373 665f 7263 700a 2020  c] *= csf_rcp.  
-0000ab20: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-0000ab30: 203d 2073 656c 662e 685b 665f 6e6f 745f   = self.h[f_not_
-0000ab40: 6368 6563 6b65 645d 2e63 6f70 7928 290a  checked].copy().
-0000ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab60: 6862 203d 2073 656c 662e 685b 7e66 5f6e  hb = self.h[~f_n
-0000ab70: 6f74 5f63 6865 636b 6564 5d0a 2020 2020  ot_checked].    
-0000ab80: 2020 2020 2020 2020 2020 2020 6861 203d              ha =
-0000ab90: 2073 656c 662e 5f72 6570 6169 725a 6572   self._repairZer
-0000aba0: 6f50 7269 6365 7328 6861 2c20 7369 6c65  oPrices(ha, sile
-0000abb0: 6e74 3d54 7275 6529 0a20 2020 2020 2020  nt=True).       
-0000abc0: 2020 2020 2020 2020 2068 615b 2243 2d43           ha["C-C
-0000abd0: 6865 636b 3f22 5d20 3d20 5472 7565 0a20  heck?"] = True. 
-0000abe0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000abf0: 6620 6e6f 7420 6862 2e65 6d70 7479 3a0a  f not hb.empty:.
-0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac10: 2020 2020 7365 6c66 2e68 203d 2070 642e      self.h = pd.
-0000ac20: 636f 6e63 6174 285b 6861 2c20 6862 5d2c  concat([ha, hb],
-0000ac30: 2073 6f72 743d 5472 7565 290a 2020 2020   sort=True).    
-0000ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac50: 7365 6c66 2e68 2e69 6e64 6578 203d 2070  self.h.index = p
-0000ac60: 642e 746f 5f64 6174 6574 696d 6528 7365  d.to_datetime(se
-0000ac70: 6c66 2e68 2e69 6e64 6578 2c20 7574 633d  lf.h.index, utc=
-0000ac80: 5472 7565 292e 747a 5f63 6f6e 7665 7274  True).tz_convert
-0000ac90: 2874 7a5f 6578 6368 616e 6765 290a 2020  (tz_exchange).  
-0000aca0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000acb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000acc0: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
-0000acd0: 2068 610a 2020 2020 2020 2020 2020 2020   ha.            
-0000ace0: 2020 2020 7365 6c66 2e68 203d 2073 656c      self.h = sel
-0000acf0: 662e 682e 736f 7274 5f69 6e64 6578 2829  f.h.sort_index()
-0000ad00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ad10: 2073 656c 662e 5f75 7064 6174 6564 4361   self._updatedCa
-0000ad20: 6368 6564 5072 6963 6573 2873 656c 662e  chedPrices(self.
-0000ad30: 6829 0a0a 2020 2020 2020 2020 2320 4e6f  h)..        # No
-0000ad40: 7720 7072 6963 6573 2068 6176 6520 6265  w prices have be
-0000ad50: 656e 2072 6570 6169 7265 642c 2063 616e  en repaired, can
-0000ad60: 2073 656e 6420 6f75 7420 6469 7669 6465   send out divide
-0000ad70: 6e64 730a 2020 2020 2020 2020 6361 6368  nds.        cach
-0000ad80: 6564 5f6e 6577 5f64 6976 7320 3d20 7966  ed_new_divs = yf
-0000ad90: 636d 2e52 6561 6443 6163 6865 4461 7475  cm.ReadCacheDatu
-0000ada0: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
-0000adb0: 6e65 775f 6469 7673 2229 0a20 2020 2020  new_divs").     
-0000adc0: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-0000add0: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-0000ade0: 7276 616c 2e44 6179 7331 2061 6e64 2063  rval.Days1 and c
-0000adf0: 6163 6865 645f 6e65 775f 6469 7673 2069  ached_new_divs i
-0000ae00: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206e  s not None and n
-0000ae10: 6f74 2063 6163 6865 645f 6e65 775f 6469  ot cached_new_di
-0000ae20: 7673 2e65 6d70 7479 3a0a 2020 2020 2020  vs.empty:.      
-0000ae30: 2020 2020 2020 6361 6368 6564 5f6e 6577        cached_new
-0000ae40: 5f64 6976 735f 6c6f 636b 6564 203d 2079  _divs_locked = y
-0000ae50: 6663 6d2e 5265 6164 4361 6368 654d 6574  fcm.ReadCacheMet
-0000ae60: 6164 6174 6128 7365 6c66 2e74 6963 6b65  adata(self.ticke
-0000ae70: 722c 2022 6e65 775f 6469 7673 222c 2022  r, "new_divs", "
-0000ae80: 6c6f 636b 6564 2229 0a20 2020 2020 2020  locked").       
-0000ae90: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
-0000aea0: 7269 6e74 2866 2263 6163 6865 645f 6e65  rint(f"cached_ne
-0000aeb0: 775f 6469 7673 5f6c 6f63 6b65 6420 3d20  w_divs_locked = 
-0000aec0: 7b63 6163 6865 645f 6e65 775f 6469 7673  {cached_new_divs
-0000aed0: 5f6c 6f63 6b65 647d 2229 0a20 2020 2020  _locked}").     
-0000aee0: 2020 2020 2020 2069 6620 6361 6368 6564         if cached
-0000aef0: 5f6e 6577 5f64 6976 735f 6c6f 636b 6564  _new_divs_locked
-0000af00: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000af10: 2020 2020 2020 2020 2020 665f 6475 7073            f_dups
-0000af20: 203d 2063 6163 6865 645f 6e65 775f 6469   = cached_new_di
-0000af30: 7673 2e69 6e64 6578 2e64 7570 6c69 6361  vs.index.duplica
-0000af40: 7465 6428 290a 2020 2020 2020 2020 2020  ted().          
-0000af50: 2020 2020 2020 6966 2066 5f64 7570 732e        if f_dups.
-0000af60: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-0000af70: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000af80: 2863 6163 6865 645f 6e65 775f 6469 7673  (cached_new_divs
-0000af90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000afa0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0000afb0: 7074 696f 6e28 2764 7570 6c69 6361 7465  ption('duplicate
-0000afc0: 7320 6465 7465 6374 6564 2069 6e20 6361  s detected in ca
-0000afd0: 6368 6564 5f6e 6577 5f64 6976 7327 290a  ched_new_divs').
+00009e50: 7072 696e 7428 222d 2063 6170 7069 6e67  print("- capping
+00009e60: 206c 6173 7420 7261 6e67 655f 746f 5f66   last range_to_f
+00009e70: 6574 6368 2065 6e64 2074 6f20 645f 6e6f  etch end to d_no
+00009e80: 775f 6578 6368 616e 6765 2229 0a20 2020  w_exchange").   
+00009e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ea0: 2020 2020 2020 2020 2069 6620 6474 5f6e           if dt_n
+00009eb0: 6f77 203c 2073 6368 6564 5b22 6f70 656e  ow < sched["open
+00009ec0: 225d 2e69 6c6f 635b 305d 3a0a 2020 2020  "].iloc[0]:.    
+00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ee0: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
+00009ef0: 6573 5f74 6f5f 6665 7463 685b 695d 203d  es_to_fetch[i] =
+00009f00: 2028 725b 305d 2c20 645f 6e6f 775f 6578   (r[0], d_now_ex
+00009f10: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+00009f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00009f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f50: 2020 2020 2020 2020 2020 7261 6e67 6573            ranges
+00009f60: 5f74 6f5f 6665 7463 685b 695d 203d 2028  _to_fetch[i] = (
+00009f70: 725b 305d 2c20 645f 6e6f 775f 6578 6368  r[0], d_now_exch
+00009f80: 616e 6765 202b 2074 645f 3164 290a 0a20  ange + td_1d).. 
+00009f90: 2020 2020 2020 2020 2020 2023 2049 6d70             # Imp
+00009fa0: 6f72 7461 6e74 2074 6861 7420 7261 6e67  ortant that rang
+00009fb0: 6573 5f74 6f5f 6665 7463 6820 696e 2072  es_to_fetch in r
+00009fc0: 6576 6572 7365 206f 7264 6572 210a 2020  everse order!.  
+00009fd0: 2020 2020 2020 2020 2020 7261 6e67 6573            ranges
+00009fe0: 5f74 6f5f 6665 7463 682e 736f 7274 286b  _to_fetch.sort(k
+00009ff0: 6579 3d6c 616d 6264 6120 783a 2078 5b30  ey=lambda x: x[0
+0000a000: 5d2c 2072 6576 6572 7365 3d54 7275 6529  ], reverse=True)
+0000a010: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000a020: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+0000a030: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000a040: 2822 2d20 7261 6e67 6573 5f74 6f5f 6665  ("- ranges_to_fe
+0000a050: 7463 683a 2229 0a20 2020 2020 2020 2020  tch:").         
+0000a060: 2020 2020 2020 2070 7072 696e 7428 7261         pprint(ra
+0000a070: 6e67 6573 5f74 6f5f 6665 7463 6829 0a0a  nges_to_fetch)..
+0000a080: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0000a090: 656e 2872 616e 6765 735f 746f 5f66 6574  en(ranges_to_fet
+0000a0a0: 6368 2920 3e20 303a 0a20 2020 2020 2020  ch) > 0:.       
+0000a0b0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000a0c0: 7365 6c66 2e68 2e65 6d70 7479 3a0a 2020  self.h.empty:.  
+0000a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0e0: 2020 2320 456e 7375 7265 206f 6e6c 7920    # Ensure only 
+0000a0f0: 6f6e 6520 7261 6e67 6520 6d61 7820 6973  one range max is
+0000a100: 2061 6674 6572 2063 6163 6865 6420 6461   after cached da
+0000a110: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
+0000a120: 2020 2020 2020 2020 685f 6c61 7374 5f64          h_last_d
+0000a130: 7420 3d20 7365 6c66 2e68 2e69 6e64 6578  t = self.h.index
+0000a140: 5b2d 315d 2e74 6f5f 7079 6461 7465 7469  [-1].to_pydateti
+0000a150: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
+0000a160: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000a170: 6973 696e 7374 616e 6365 2872 616e 6765  isinstance(range
+0000a180: 735f 746f 5f66 6574 6368 5b30 5d5b 305d  s_to_fetch[0][0]
+0000a190: 2c20 6461 7465 7469 6d65 293a 0a20 2020  , datetime):.   
+0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1b0: 2020 2020 2068 5f6c 6173 745f 6474 203d       h_last_dt =
+0000a1c0: 2068 5f6c 6173 745f 6474 2e61 7374 696d   h_last_dt.astim
+0000a1d0: 657a 6f6e 6528 747a 5f65 7863 6861 6e67  ezone(tz_exchang
+0000a1e0: 6529 2e64 6174 6528 290a 2020 2020 2020  e).date().      
+0000a1f0: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
+0000a200: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0000a210: 2020 2020 2020 2020 666f 7220 7220 696e          for r in
+0000a220: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+0000a230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a240: 2020 2020 2020 2020 2020 6966 2072 5b30            if r[0
+0000a250: 5d20 3e20 685f 6c61 7374 5f64 743a 0a20  ] > h_last_dt:. 
+0000a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a270: 2020 2020 2020 2020 2020 206e 202b 3d20             n += 
+0000a280: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0000a290: 2020 2020 2020 6966 206e 203e 2031 3a0a        if n > 1:.
+0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2b0: 2020 2020 2020 2020 7072 696e 7428 2272          print("r
+0000a2c0: 616e 6765 735f 746f 5f66 6574 6368 3a22  anges_to_fetch:"
+0000a2d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a2e0: 2020 2020 2020 2020 2020 7070 7269 6e74            pprint
+0000a2f0: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
+0000a300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a310: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000a320: 4578 6365 7074 696f 6e28 2272 616e 6765  Exception("range
+0000a330: 735f 746f 5f66 6574 6368 2063 6f6e 7461  s_to_fetch conta
+0000a340: 696e 7320 7b7d 2072 616e 6765 7320 7468  ins {} ranges th
+0000a350: 6174 206f 6363 7572 2061 6674 6572 2068  at occur after h
+0000a360: 5f6c 6173 745f 6474 3d7b 7d2c 2065 7870  _last_dt={}, exp
+0000a370: 6563 7465 6420 3120 6d61 7822 2e66 6f72  ected 1 max".for
+0000a380: 6d61 7428 6e2c 2068 5f6c 6173 745f 6474  mat(n, h_last_dt
+0000a390: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0000a3a0: 2020 2020 2320 6966 206e 6f74 2071 7569      # if not qui
+0000a3b0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+0000a3c0: 2020 2020 2320 2020 2020 7175 6965 7420      #     quiet 
+0000a3d0: 3d20 7065 7269 6f64 2069 7320 6e6f 7420  = period is not 
+0000a3e0: 4e6f 6e65 2020 2320 5946 4320 6765 6e65  None  # YFC gene
+0000a3f0: 7261 7465 6420 6461 7465 2072 616e 6765  rated date range
+0000a400: 2073 6f20 646f 6e27 7420 7072 696e 7420   so don't print 
+0000a410: 6d65 7373 6167 650a 2020 2020 2020 2020  message.        
+0000a420: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+0000a430: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+0000a440: 2020 2020 2020 2020 2020 7175 6965 7420            quiet 
+0000a450: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0000a460: 2020 2020 2020 2020 2020 2020 2320 7175              # qu
+0000a470: 6965 7420 3d20 6e6f 7420 6465 6275 675f  iet = not debug_
+0000a480: 7966 630a 2020 2020 2020 2020 2020 2020  yfc.            
+0000a490: 2020 2020 2320 6966 2073 656c 662e 696e      # if self.in
+0000a4a0: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0000a4b0: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
+0000a4c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000a4d0: 6620 7365 6c66 2e63 6f6e 7469 6775 6f75  f self.contiguou
+0000a4e0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000a4f0: 2020 2020 2020 2073 656c 662e 5f66 6574         self._fet
+0000a500: 6368 416e 6441 6464 5261 6e67 6573 5f63  chAndAddRanges_c
+0000a510: 6f6e 7469 6775 6f75 7328 7261 6e67 6573  ontiguous(ranges
+0000a520: 5f74 6f5f 6665 7463 682c 2070 7265 706f  _to_fetch, prepo
+0000a530: 7374 2c20 6465 6275 675f 7966 2c20 7175  st, debug_yf, qu
+0000a540: 6965 743d 7175 6965 7429 0a20 2020 2020  iet=quiet).     
+0000a550: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000a560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a570: 2020 2020 2073 656c 662e 5f66 6574 6368       self._fetch
+0000a580: 416e 6441 6464 5261 6e67 6573 5f73 7061  AndAddRanges_spa
+0000a590: 7273 6528 7261 6e67 6573 5f74 6f5f 6665  rse(ranges_to_fe
+0000a5a0: 7463 682c 2070 7265 706f 7374 2c20 6465  tch, prepost, de
+0000a5b0: 6275 675f 7966 2c20 7175 6965 743d 7175  bug_yf, quiet=qu
+0000a5c0: 6965 7429 0a0a 2020 2020 2020 2020 2320  iet)..        # 
+0000a5d0: 7265 7061 6972 2061 6674 6572 2061 6c6c  repair after all
+0000a5e0: 2066 6574 6368 6573 2063 6f6d 706c 6574   fetches complet
+0000a5f0: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
+0000a600: 662e 7265 7061 6972 2061 6e64 2072 6570  f.repair and rep
+0000a610: 6169 723a 0a20 2020 2020 2020 2020 2020  air:.           
+0000a620: 2066 5f63 6865 636b 6564 203d 2073 656c   f_checked = sel
+0000a630: 662e 685b 2243 2d43 6865 636b 3f22 5d2e  f.h["C-Check?"].
+0000a640: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
+0000a650: 2020 2020 2020 2066 5f6e 6f74 5f63 6865         f_not_che
+0000a660: 636b 6564 203d 207e 665f 6368 6563 6b65  cked = ~f_checke
+0000a670: 640a 2020 2020 2020 2020 2020 2020 6966  d.            if
+0000a680: 2066 5f6e 6f74 5f63 6865 636b 6564 2e61   f_not_checked.a
+0000a690: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+0000a6a0: 2020 2020 2020 2320 4368 6563 6b20 666f        # Check fo
+0000a6b0: 7220 3130 3078 2065 7272 6f72 7320 6163  r 100x errors ac
+0000a6c0: 726f 7373 2045 4e54 4952 4520 7461 626c  ross ENTIRE tabl
+0000a6d0: 6520 7769 7468 2073 706c 6974 2d61 646a  e with split-adj
+0000a6e0: 7573 746d 656e 7420 6170 706c 6965 6420  ustment applied 
+0000a6f0: 7465 6d70 6f72 6172 696c 792e 0a20 2020  temporarily..   
+0000a700: 2020 2020 2020 2020 2020 2020 2023 2050               # P
+0000a710: 6f74 656e 7469 616c 2070 726f 626c 656d  otential problem
+0000a720: 2077 6974 6820 7665 7279 2073 7061 7273   with very spars
+0000a730: 6520 6461 7461 2c20 6275 7420 6173 7375  e data, but assu
+0000a740: 6d65 206d 6f73 7420 7573 6572 7320 7769  me most users wi
+0000a750: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+0000a760: 2020 2023 2066 6574 6368 2022 7370 6172     # fetch "spar
+0000a770: 7365 2220 6661 6972 6c79 2063 6f6e 7469  se" fairly conti
+0000a780: 6775 6f75 736c 792e 0a20 2020 2020 2020  guously..       
+0000a790: 2020 2020 2020 2020 2023 202d 2061 7070           # - app
+0000a7a0: 6c79 2073 706c 6974 2d61 646a 7573 746d  ly split-adjustm
+0000a7b0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0000a7c0: 2020 2020 4f48 4c43 203d 205b 274f 7065      OHLC = ['Ope
+0000a7d0: 6e27 2c20 2748 6967 6827 2c20 274c 6f77  n', 'High', 'Low
+0000a7e0: 272c 2027 436c 6f73 6527 5d0a 2020 2020  ', 'Close'].    
+0000a7f0: 2020 2020 2020 2020 2020 2020 6373 6620              csf 
+0000a800: 3d20 7365 6c66 2e68 5b27 4353 4627 5d2e  = self.h['CSF'].
+0000a810: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
+0000a820: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+0000a830: 2069 6e20 4f48 4c43 3a0a 2020 2020 2020   in OHLC:.      
+0000a840: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a850: 6c66 2e68 5b63 5d20 2a3d 2063 7366 0a20  lf.h[c] *= csf. 
+0000a860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000a870: 656c 662e 6820 3d20 7365 6c66 2e5f 7265  elf.h = self._re
+0000a880: 7061 6972 556e 6974 4d69 7875 7073 2873  pairUnitMixups(s
+0000a890: 656c 662e 6829 0a20 2020 2020 2020 2020  elf.h).         
+0000a8a0: 2020 2020 2020 2023 2041 6c73 6f20 7265         # Also re
+0000a8b0: 7061 6972 2073 706c 6974 2065 7272 6f72  pair split error
+0000a8c0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000a8d0: 2020 2073 656c 662e 6820 3d20 7365 6c66     self.h = self
+0000a8e0: 2e5f 6669 7842 6164 5374 6f63 6b53 706c  ._fixBadStockSpl
+0000a8f0: 6974 7328 7365 6c66 2e68 290a 2020 2020  its(self.h).    
+0000a900: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
+0000a910: 7265 7665 7273 6520 7370 6c69 742d 6164  reverse split-ad
+0000a920: 6a75 7374 6d65 6e74 0a20 2020 2020 2020  justment.       
+0000a930: 2020 2020 2020 2020 2063 7366 5f72 6370           csf_rcp
+0000a940: 203d 2031 2e30 2f73 656c 662e 685b 2743   = 1.0/self.h['C
+0000a950: 5346 275d 2e74 6f5f 6e75 6d70 7928 290a  SF'].to_numpy().
+0000a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a970: 666f 7220 6320 696e 204f 484c 433a 0a20  for c in OHLC:. 
+0000a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a990: 2020 2073 656c 662e 685b 635d 202a 3d20     self.h[c] *= 
+0000a9a0: 6373 665f 7263 700a 2020 2020 2020 2020  csf_rcp.        
+0000a9b0: 2020 2020 2020 2020 6861 203d 2073 656c          ha = sel
+0000a9c0: 662e 685b 665f 6e6f 745f 6368 6563 6b65  f.h[f_not_checke
+0000a9d0: 645d 2e63 6f70 7928 290a 2020 2020 2020  d].copy().      
+0000a9e0: 2020 2020 2020 2020 2020 6862 203d 2073            hb = s
+0000a9f0: 656c 662e 685b 7e66 5f6e 6f74 5f63 6865  elf.h[~f_not_che
+0000aa00: 636b 6564 5d0a 2020 2020 2020 2020 2020  cked].          
+0000aa10: 2020 2020 2020 6861 203d 2073 656c 662e        ha = self.
+0000aa20: 5f72 6570 6169 725a 6572 6f50 7269 6365  _repairZeroPrice
+0000aa30: 7328 6861 2c20 7369 6c65 6e74 3d54 7275  s(ha, silent=Tru
+0000aa40: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0000aa50: 2020 2068 615b 2243 2d43 6865 636b 3f22     ha["C-Check?"
+0000aa60: 5d20 3d20 5472 7565 0a20 2020 2020 2020  ] = True.       
+0000aa70: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000aa80: 6862 2e65 6d70 7479 3a0a 2020 2020 2020  hb.empty:.      
+0000aa90: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000aaa0: 6c66 2e68 203d 2070 642e 636f 6e63 6174  lf.h = pd.concat
+0000aab0: 285b 6861 2c20 6862 5b68 612e 636f 6c75  ([ha, hb[ha.colu
+0000aac0: 6d6e 735d 5d29 0a20 2020 2020 2020 2020  mns]]).         
+0000aad0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000aae0: 682e 696e 6465 7820 3d20 7064 2e74 6f5f  h.index = pd.to_
+0000aaf0: 6461 7465 7469 6d65 2873 656c 662e 682e  datetime(self.h.
+0000ab00: 696e 6465 782c 2075 7463 3d54 7275 6529  index, utc=True)
+0000ab10: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
+0000ab20: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
+0000ab30: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab50: 2020 2073 656c 662e 6820 3d20 6861 0a20     self.h = ha. 
+0000ab60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000ab70: 656c 662e 6820 3d20 7365 6c66 2e68 2e73  elf.h = self.h.s
+0000ab80: 6f72 745f 696e 6465 7828 290a 2020 2020  ort_index().    
+0000ab90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000aba0: 2e5f 7570 6461 7465 6443 6163 6865 6450  ._updatedCachedP
+0000abb0: 7269 6365 7328 7365 6c66 2e68 290a 0a20  rices(self.h).. 
+0000abc0: 2020 2020 2020 2023 204e 6f77 2070 7269         # Now pri
+0000abd0: 6365 7320 6861 7665 2062 6565 6e20 7265  ces have been re
+0000abe0: 7061 6972 6564 2c20 6361 6e20 7365 6e64  paired, can send
+0000abf0: 206f 7574 2064 6976 6964 656e 6473 0a20   out dividends. 
+0000ac00: 2020 2020 2020 2063 6163 6865 645f 6e65         cached_ne
+0000ac10: 775f 6469 7673 203d 2079 6663 6d2e 5265  w_divs = yfcm.Re
+0000ac20: 6164 4361 6368 6544 6174 756d 2873 656c  adCacheDatum(sel
+0000ac30: 662e 7469 636b 6572 2c20 226e 6577 5f64  f.ticker, "new_d
+0000ac40: 6976 7322 290a 2020 2020 2020 2020 6966  ivs").        if
+0000ac50: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
+0000ac60: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0000ac70: 4461 7973 3120 616e 6420 6361 6368 6564  Days1 and cached
+0000ac80: 5f6e 6577 5f64 6976 7320 6973 206e 6f74  _new_divs is not
+0000ac90: 204e 6f6e 6520 616e 6420 6e6f 7420 6361   None and not ca
+0000aca0: 6368 6564 5f6e 6577 5f64 6976 732e 656d  ched_new_divs.em
+0000acb0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+0000acc0: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
+0000acd0: 5f6c 6f63 6b65 6420 3d20 7966 636d 2e52  _locked = yfcm.R
+0000ace0: 6561 6443 6163 6865 4d65 7461 6461 7461  eadCacheMetadata
+0000acf0: 2873 656c 662e 7469 636b 6572 2c20 226e  (self.ticker, "n
+0000ad00: 6577 5f64 6976 7322 2c20 226c 6f63 6b65  ew_divs", "locke
+0000ad10: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
+0000ad20: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+0000ad30: 6622 6361 6368 6564 5f6e 6577 5f64 6976  f"cached_new_div
+0000ad40: 735f 6c6f 636b 6564 203d 207b 6361 6368  s_locked = {cach
+0000ad50: 6564 5f6e 6577 5f64 6976 735f 6c6f 636b  ed_new_divs_lock
+0000ad60: 6564 7d22 290a 2020 2020 2020 2020 2020  ed}").          
+0000ad70: 2020 6966 2063 6163 6865 645f 6e65 775f    if cached_new_
+0000ad80: 6469 7673 5f6c 6f63 6b65 6420 6973 204e  divs_locked is N
+0000ad90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000ada0: 2020 2020 2066 5f64 7570 7320 3d20 6361       f_dups = ca
+0000adb0: 6368 6564 5f6e 6577 5f64 6976 732e 696e  ched_new_divs.in
+0000adc0: 6465 782e 6475 706c 6963 6174 6564 2829  dex.duplicated()
+0000add0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ade0: 2069 6620 665f 6475 7073 2e61 6e79 2829   if f_dups.any()
+0000adf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ae00: 2020 2020 2020 7072 696e 7428 6361 6368        print(cach
+0000ae10: 6564 5f6e 6577 5f64 6976 7329 0a20 2020  ed_new_divs).   
+0000ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae30: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0000ae40: 2827 6475 706c 6963 6174 6573 2064 6574  ('duplicates det
+0000ae50: 6563 7465 6420 696e 2063 6163 6865 645f  ected in cached_
+0000ae60: 6e65 775f 6469 7673 2729 0a20 2020 2020  new_divs').     
+0000ae70: 2020 2020 2020 2020 2020 2079 6663 6d2e             yfcm.
+0000ae80: 5772 6974 6543 6163 6865 4d65 7461 6461  WriteCacheMetada
+0000ae90: 7461 2873 656c 662e 7469 636b 6572 2c20  ta(self.ticker, 
+0000aea0: 226e 6577 5f64 6976 7322 2c20 226c 6f63  "new_divs", "loc
+0000aeb0: 6b65 6422 2c20 3129 0a20 2020 2020 2020  ked", 1).       
+0000aec0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
+0000aed0: 6163 6550 7269 6e74 2822 7365 6e64 696e  acePrint("sendin
+0000aee0: 6720 6f75 7420 6e65 7720 6469 7669 6465  g out new divide
+0000aef0: 6e64 7320 2e2e 2e22 290a 2020 2020 2020  nds ...").      
+0000af00: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0000af10: 3a20 7265 6d6f 7665 2064 7570 6c69 6361  : remove duplica
+0000af20: 7465 7320 6672 6f6d 205f 6e65 7744 6976  tes from _newDiv
+0000af30: 7320 2870 6f73 7369 626c 6520 7768 656e  s (possible when
+0000af40: 2072 6573 746f 7269 6e67 2066 696c 6520   restoring file 
+0000af50: 6669 6c65 290a 2020 2020 2020 2020 2020  file).          
+0000af60: 2020 2020 2020 6469 7673 5f64 6620 3d20        divs_df = 
+0000af70: 6361 6368 6564 5f6e 6577 5f64 6976 730a  cached_new_divs.
+0000af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af90: 6469 7673 5f64 665b 2243 6c6f 7365 2064  divs_df["Close d
+0000afa0: 6179 2062 6566 6f72 6522 5d20 3d20 6e70  ay before"] = np
+0000afb0: 2e6e 616e 0a20 2020 2020 2020 2020 2020  .nan.           
+0000afc0: 2020 2020 2066 6f72 2064 7420 696e 2064       for dt in d
+0000afd0: 6976 735f 6466 2e69 6e64 6578 3a0a 2020  ivs_df.index:.  
 0000afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aff0: 7966 636d 2e57 7269 7465 4361 6368 654d  yfcm.WriteCacheM
-0000b000: 6574 6164 6174 6128 7365 6c66 2e74 6963  etadata(self.tic
-0000b010: 6b65 722c 2022 6e65 775f 6469 7673 222c  ker, "new_divs",
-0000b020: 2022 6c6f 636b 6564 222c 2031 290a 2020   "locked", 1).  
-0000b030: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-0000b040: 636c 2e54 7261 6365 5072 696e 7428 2273  cl.TracePrint("s
-0000b050: 656e 6469 6e67 206f 7574 206e 6577 2064  ending out new d
-0000b060: 6976 6964 656e 6473 202e 2e2e 2229 0a20  ividends ..."). 
-0000b070: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b080: 2054 4f44 4f3a 2072 656d 6f76 6520 6475   TODO: remove du
-0000b090: 706c 6963 6174 6573 2066 726f 6d20 5f6e  plicates from _n
-0000b0a0: 6577 4469 7673 2028 706f 7373 6962 6c65  ewDivs (possible
-0000b0b0: 2077 6865 6e20 7265 7374 6f72 696e 6720   when restoring 
-0000b0c0: 6669 6c65 2066 696c 6529 0a20 2020 2020  file file).     
-0000b0d0: 2020 2020 2020 2020 2020 2064 6976 735f             divs_
-0000b0e0: 6466 203d 2063 6163 6865 645f 6e65 775f  df = cached_new_
-0000b0f0: 6469 7673 0a20 2020 2020 2020 2020 2020  divs.           
-0000b100: 2020 2020 2064 6976 735f 6466 5b22 436c       divs_df["Cl
-0000b110: 6f73 6520 6461 7920 6265 666f 7265 225d  ose day before"]
-0000b120: 203d 206e 702e 6e61 6e0a 2020 2020 2020   = np.nan.      
-0000b130: 2020 2020 2020 2020 2020 666f 7220 6474            for dt
-0000b140: 2069 6e20 6469 7673 5f64 662e 696e 6465   in divs_df.inde
-0000b150: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-0000b160: 2020 2020 2020 2069 6620 6474 203d 3d20         if dt == 
-0000b170: 7365 6c66 2e68 2e69 6e64 6578 5b30 5d3a  self.h.index[0]:
-0000b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b190: 2020 2020 2020 2020 2068 6973 745f 6265           hist_be
-0000b1a0: 666f 7265 203d 2073 656c 662e 6d61 6e61  fore = self.mana
-0000b1b0: 6765 722e 4765 7448 6973 746f 7279 2879  ger.GetHistory(y
-0000b1c0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-0000b1d0: 7331 292e 6765 7428 7374 6172 743d 6474  s1).get(start=dt
-0000b1e0: 2e64 6174 6528 292d 7469 6d65 6465 6c74  .date()-timedelt
-0000b1f0: 6128 6461 7973 3d37 292c 2065 6e64 3d64  a(days=7), end=d
-0000b200: 742e 6461 7465 2829 2c20 6164 6a75 7374  t.date(), adjust
-0000b210: 5f73 706c 6974 733d 4661 6c73 652c 2061  _splits=False, a
-0000b220: 646a 7573 745f 6469 7673 3d46 616c 7365  djust_divs=False
-0000b230: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000b240: 2020 2020 2020 2020 2020 636c 6f73 655f            close_
-0000b250: 6461 795f 6265 666f 7265 203d 2068 6973  day_before = his
-0000b260: 745f 6265 666f 7265 5b22 436c 6f73 6522  t_before["Close"
-0000b270: 5d2e 696c 6f63 5b2d 315d 0a20 2020 2020  ].iloc[-1].     
-0000b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b290: 2020 2069 6620 6e70 2e69 736e 616e 2863     if np.isnan(c
-0000b2a0: 6c6f 7365 5f64 6179 5f62 6566 6f72 6529  lose_day_before)
-0000b2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000b2d0: 6973 6520 4578 6365 7074 696f 6e28 2227  ise Exception("'
-0000b2e0: 636c 6f73 655f 6461 795f 6265 666f 7265  close_day_before
-0000b2f0: 2720 6973 204e 614e 2229 0a20 2020 2020  ' is NaN").     
-0000b300: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000b310: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b320: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-0000b330: 203d 2073 656c 662e 682e 696e 6465 782e   = self.h.index.
-0000b340: 6765 745f 6c6f 6328 6474 290a 2020 2020  get_loc(dt).    
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 2020 2020 636c 6f73 655f 6461 795f 6265      close_day_be
-0000b370: 666f 7265 203d 2073 656c 662e 685b 2243  fore = self.h["C
-0000b380: 6c6f 7365 225d 2e69 6c6f 635b 6964 782d  lose"].iloc[idx-
-0000b390: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0000b3a0: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
-0000b3b0: 2e69 736e 616e 2863 6c6f 7365 5f64 6179  .isnan(close_day
-0000b3c0: 5f62 6566 6f72 6529 3a0a 2020 2020 2020  _before):.      
+0000aff0: 2020 6966 2064 7420 3d3d 2073 656c 662e    if dt == self.
+0000b000: 682e 696e 6465 785b 305d 3a0a 2020 2020  h.index[0]:.    
+0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b020: 2020 2020 6869 7374 5f62 6566 6f72 6520      hist_before 
+0000b030: 3d20 7365 6c66 2e6d 616e 6167 6572 2e47  = self.manager.G
+0000b040: 6574 4869 7374 6f72 7928 7966 6364 2e49  etHistory(yfcd.I
+0000b050: 6e74 6572 7661 6c2e 4461 7973 3129 2e67  nterval.Days1).g
+0000b060: 6574 2873 7461 7274 3d64 742e 6461 7465  et(start=dt.date
+0000b070: 2829 2d74 696d 6564 656c 7461 2864 6179  ()-timedelta(day
+0000b080: 733d 3729 2c20 656e 643d 6474 2e64 6174  s=7), end=dt.dat
+0000b090: 6528 292c 2061 646a 7573 745f 7370 6c69  e(), adjust_spli
+0000b0a0: 7473 3d46 616c 7365 2c20 6164 6a75 7374  ts=False, adjust
+0000b0b0: 5f64 6976 733d 4661 6c73 6529 0a20 2020  _divs=False).   
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0d0: 2020 2020 2063 6c6f 7365 5f64 6179 5f62       close_day_b
+0000b0e0: 6566 6f72 6520 3d20 6869 7374 5f62 6566  efore = hist_bef
+0000b0f0: 6f72 655b 2243 6c6f 7365 225d 2e69 6c6f  ore["Close"].ilo
+0000b100: 635b 2d31 5d0a 2020 2020 2020 2020 2020  c[-1].          
+0000b110: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b120: 206e 702e 6973 6e61 6e28 636c 6f73 655f   np.isnan(close_
+0000b130: 6461 795f 6265 666f 7265 293a 0a20 2020  day_before):.   
+0000b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b150: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+0000b160: 7863 6570 7469 6f6e 2822 2763 6c6f 7365  xception("'close
+0000b170: 5f64 6179 5f62 6566 6f72 6527 2069 7320  _day_before' is 
+0000b180: 4e61 4e22 290a 2020 2020 2020 2020 2020  NaN").          
+0000b190: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b1b0: 2020 2020 2020 2020 6964 7820 3d20 7365          idx = se
+0000b1c0: 6c66 2e68 2e69 6e64 6578 2e67 6574 5f6c  lf.h.index.get_l
+0000b1d0: 6f63 2864 7429 0a20 2020 2020 2020 2020  oc(dt).         
+0000b1e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000b1f0: 6c6f 7365 5f64 6179 5f62 6566 6f72 6520  lose_day_before 
+0000b200: 3d20 7365 6c66 2e68 5b22 436c 6f73 6522  = self.h["Close"
+0000b210: 5d2e 696c 6f63 5b69 6478 2d31 5d0a 2020  ].iloc[idx-1].  
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2020 2020 2020 6966 206e 702e 6973 6e61        if np.isna
+0000b240: 6e28 636c 6f73 655f 6461 795f 6265 666f  n(close_day_befo
+0000b250: 7265 293a 0a20 2020 2020 2020 2020 2020  re):.           
+0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b270: 2066 6f72 2069 6478 2069 6e20 7261 6e67   for idx in rang
+0000b280: 6528 6964 782d 312c 2069 6478 2d39 2c20  e(idx-1, idx-9, 
+0000b290: 2d31 293a 0a20 2020 2020 2020 2020 2020  -1):.           
+0000b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2b0: 2020 2020 2063 6c6f 7365 5f64 6179 5f62       close_day_b
+0000b2c0: 6566 6f72 6520 3d20 7365 6c66 2e68 5b22  efore = self.h["
+0000b2d0: 436c 6f73 6522 5d2e 696c 6f63 5b69 6478  Close"].iloc[idx
+0000b2e0: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+0000b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b300: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
+0000b310: 6e61 6e28 636c 6f73 655f 6461 795f 6265  nan(close_day_be
+0000b320: 666f 7265 293a 0a20 2020 2020 2020 2020  fore):.         
+0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b340: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0000b350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b360: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b370: 6e70 2e69 736e 616e 2863 6c6f 7365 5f64  np.isnan(close_d
+0000b380: 6179 5f62 6566 6f72 6529 3a0a 2020 2020  ay_before):.    
+0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000b3b0: 7428 6622 2d20 6964 783d 7b69 6478 7d20  t(f"- idx={idx} 
+0000b3c0: 6474 3d7b 6474 7d22 290a 2020 2020 2020  dt={dt}").      
 0000b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3e0: 2020 2020 2020 666f 7220 6964 7820 696e        for idx in
-0000b3f0: 2072 616e 6765 2869 6478 2d31 2c20 6964   range(idx-1, id
-0000b400: 782d 392c 202d 3129 3a0a 2020 2020 2020  x-9, -1):.      
-0000b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b420: 2020 2020 2020 2020 2020 636c 6f73 655f            close_
-0000b430: 6461 795f 6265 666f 7265 203d 2073 656c  day_before = sel
-0000b440: 662e 685b 2243 6c6f 7365 225d 2e69 6c6f  f.h["Close"].ilo
-0000b450: 635b 6964 782d 315d 0a20 2020 2020 2020  c[idx-1].       
-0000b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b470: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000b480: 6e70 2e69 736e 616e 2863 6c6f 7365 5f64  np.isnan(close_d
-0000b490: 6179 5f62 6566 6f72 6529 3a0a 2020 2020  ay_before):.    
-0000b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4c0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4e0: 2020 6966 206e 702e 6973 6e61 6e28 636c    if np.isnan(cl
-0000b4f0: 6f73 655f 6461 795f 6265 666f 7265 293a  ose_day_before):
-0000b500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b520: 2070 7269 6e74 2866 222d 2069 6478 3d7b   print(f"- idx={
-0000b530: 6964 787d 2064 743d 7b64 747d 2229 0a20  idx} dt={dt}"). 
-0000b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b550: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b560: 7269 6e74 2873 656c 662e 682e 696c 6f63  rint(self.h.iloc
-0000b570: 5b69 6478 2d32 3a69 6478 2b33 5d5b 5b22  [idx-2:idx+3][["
-0000b580: 436c 6f73 6522 2c20 2246 6574 6368 4461  Close", "FetchDa
-0000b590: 7465 225d 5d29 0a20 2020 2020 2020 2020  te"]]).         
-0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0000b5c0: 6570 7469 6f6e 2822 2763 6c6f 7365 5f64  eption("'close_d
-0000b5d0: 6179 5f62 6566 6f72 6527 2069 7320 4e61  ay_before' is Na
-0000b5e0: 4e22 290a 2020 2020 2020 2020 2020 2020  N").            
-0000b5f0: 2020 2020 2020 2020 2020 2020 636c 6f73              clos
-0000b600: 655f 6461 795f 6265 666f 7265 202a 3d20  e_day_before *= 
-0000b610: 7365 6c66 2e68 5b27 4353 4627 5d2e 696c  self.h['CSF'].il
-0000b620: 6f63 5b69 6478 2d31 5d20 2023 2073 706c  oc[idx-1]  # spl
-0000b630: 6974 2d61 646a 7573 740a 2020 2020 2020  it-adjust.      
-0000b640: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0000b650: 7673 5f64 662e 6c6f 635b 6474 2c20 2243  vs_df.loc[dt, "C
-0000b660: 6c6f 7365 2064 6179 2062 6566 6f72 6522  lose day before"
-0000b670: 5d20 3d20 636c 6f73 655f 6461 795f 6265  ] = close_day_be
-0000b680: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
-0000b690: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
-0000b6a0: 722e 4765 7448 6973 746f 7279 2822 4576  r.GetHistory("Ev
-0000b6b0: 656e 7473 2229 2e55 7064 6174 6544 6976  ents").UpdateDiv
-0000b6c0: 6964 656e 6473 2864 6976 735f 6466 290a  idends(divs_df).
-0000b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6e0: 7365 6c66 2e5f 6170 706c 794e 6577 4576  self._applyNewEv
-0000b6f0: 656e 7473 2829 0a20 2020 2020 2020 2020  ents().         
-0000b700: 2020 2020 2020 2069 6620 6361 6368 6564         if cached
-0000b710: 5f6e 6577 5f64 6976 7320 6973 206e 6f74  _new_divs is not
-0000b720: 204e 6f6e 6520 616e 6420 6e6f 7420 6361   None and not ca
-0000b730: 6368 6564 5f6e 6577 5f64 6976 735f 6c6f  ched_new_divs_lo
-0000b740: 636b 6564 3a0a 2020 2020 2020 2020 2020  cked:.          
-0000b750: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-0000b760: 7261 6365 5072 696e 7428 2272 656c 6561  racePrint("relea
-0000b770: 7369 6e67 206c 6f63 6b20 6f6e 2063 6163  sing lock on cac
-0000b780: 6865 645f 6e65 775f 6469 7673 2229 0a20  hed_new_divs"). 
-0000b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7a0: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-0000b7b0: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-0000b7c0: 6b65 722c 2022 6e65 775f 6469 7673 222c  ker, "new_divs",
-0000b7d0: 204e 6f6e 6529 2020 2320 6465 6c65 7465   None)  # delete
-0000b7e0: 0a0a 2020 2020 2020 2020 6966 2022 4164  ..        if "Ad
-0000b7f0: 6a20 436c 6f73 6522 2069 6e20 7365 6c66  j Close" in self
-0000b800: 2e68 2e63 6f6c 756d 6e73 3a0a 2020 2020  .h.columns:.    
-0000b810: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0000b820: 6365 7074 696f 6e28 2241 646a 2043 6c6f  ception("Adj Clo
-0000b830: 7365 2069 6e20 7365 6c66 2e68 2229 0a0a  se in self.h")..
-0000b840: 2020 2020 2020 2020 6966 2028 7374 6172          if (star
-0000b850: 7420 6973 206e 6f74 204e 6f6e 6529 2061  t is not None) a
-0000b860: 6e64 2028 656e 6420 6973 206e 6f74 204e  nd (end is not N
-0000b870: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
-0000b880: 2020 685f 636f 7079 203d 2073 656c 662e    h_copy = self.
-0000b890: 682e 6c6f 635b 7374 6172 745f 6474 3a65  h.loc[start_dt:e
-0000b8a0: 6e64 5f64 742d 7469 6d65 6465 6c74 6128  nd_dt-timedelta(
-0000b8b0: 6d69 6c6c 6973 6563 6f6e 6473 3d31 295d  milliseconds=1)]
-0000b8c0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-0000b8d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000b8e0: 2020 685f 636f 7079 203d 2073 656c 662e    h_copy = self.
-0000b8f0: 682e 636f 7079 2829 0a0a 2020 2020 2020  h.copy()..      
-0000b900: 2020 6966 2061 646a 7573 745f 7370 6c69    if adjust_spli
-0000b910: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000b920: 666f 7220 6320 696e 205b 224f 7065 6e22  for c in ["Open"
-0000b930: 2c20 2248 6967 6822 2c20 224c 6f77 222c  , "High", "Low",
-0000b940: 2022 436c 6f73 6522 2c20 2244 6976 6964   "Close", "Divid
-0000b950: 656e 6473 225d 3a0a 2020 2020 2020 2020  ends"]:.        
-0000b960: 2020 2020 2020 2020 685f 636f 7079 5b63          h_copy[c
-0000b970: 5d20 2a3d 2068 5f63 6f70 795b 2243 5346  ] *= h_copy["CSF
-0000b980: 225d 0a20 2020 2020 2020 2020 2020 2068  "].            h
-0000b990: 5f63 6f70 795b 2256 6f6c 756d 6522 5d20  _copy["Volume"] 
-0000b9a0: 3d20 2868 5f63 6f70 795b 2256 6f6c 756d  = (h_copy["Volum
-0000b9b0: 6522 5d2f 685f 636f 7079 5b22 4353 4622  e"]/h_copy["CSF"
-0000b9c0: 5d29 2e72 6f75 6e64 2830 292e 6173 7479  ]).round(0).asty
-0000b9d0: 7065 2827 696e 7427 290a 2020 2020 2020  pe('int').      
-0000b9e0: 2020 2020 2020 685f 636f 7079 203d 2068        h_copy = h
-0000b9f0: 5f63 6f70 792e 6472 6f70 2822 4353 4622  _copy.drop("CSF"
-0000ba00: 2c20 6178 6973 3d31 290a 2020 2020 2020  , axis=1).      
-0000ba10: 2020 6966 2061 646a 7573 745f 6469 7673    if adjust_divs
-0000ba20: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-0000ba30: 7220 6320 696e 205b 224f 7065 6e22 2c20  r c in ["Open", 
-0000ba40: 2248 6967 6822 2c20 224c 6f77 222c 2022  "High", "Low", "
-0000ba50: 436c 6f73 6522 5d3a 0a20 2020 2020 2020  Close"]:.       
-0000ba60: 2020 2020 2020 2020 2068 5f63 6f70 795b           h_copy[
-0000ba70: 635d 202a 3d20 685f 636f 7079 5b22 4344  c] *= h_copy["CD
-0000ba80: 4622 5d0a 2020 2020 2020 2020 2020 2020  F"].            
-0000ba90: 685f 636f 7079 203d 2068 5f63 6f70 792e  h_copy = h_copy.
-0000baa0: 6472 6f70 2822 4344 4622 2c20 6178 6973  drop("CDF", axis
-0000bab0: 3d31 290a 0a20 2020 2020 2020 206c 6f67  =1)..        log
-0000bac0: 5f6d 7367 203d 2066 2250 7269 6365 4869  _msg = f"PriceHi
-0000bad0: 7374 6f72 792d 7b73 656c 662e 6973 7472  story-{self.istr
-0000bae0: 7d2e 6765 7428 2920 7265 7475 726e 696e  }.get() returnin
-0000baf0: 6722 0a20 2020 2020 2020 2069 6620 685f  g".        if h_
-0000bb00: 636f 7079 2e65 6d70 7479 3a0a 2020 2020  copy.empty:.    
-0000bb10: 2020 2020 2020 2020 6c6f 675f 6d73 6720          log_msg 
-0000bb20: 2b3d 2022 2065 6d70 7479 2064 6622 0a20  += " empty df". 
-0000bb30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000bb40: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
-0000bb50: 202b 3d20 6622 2044 4620 7b68 5f63 6f70   += f" DF {h_cop
-0000bb60: 792e 696e 6465 785b 305d 7d20 2d3e 207b  y.index[0]} -> {
-0000bb70: 685f 636f 7079 2e69 6e64 6578 5b2d 315d  h_copy.index[-1]
-0000bb80: 7d22 0a20 2020 2020 2020 2069 6620 7966  }".        if yf
-0000bb90: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-0000bba0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-0000bbb0: 2020 2079 6663 6c2e 5472 6163 6545 7869     yfcl.TraceExi
-0000bbc0: 7428 6c6f 675f 6d73 6729 0a20 2020 2020  t(log_msg).     
-0000bbd0: 2020 2065 6c69 6620 6465 6275 675f 7966     elif debug_yf
-0000bbe0: 633a 0a20 2020 2020 2020 2020 2020 2070  c:.            p
-0000bbf0: 7269 6e74 286c 6f67 5f6d 7367 290a 0a20  rint(log_msg).. 
-0000bc00: 2020 2020 2020 2072 6574 7572 6e20 685f         return h_
-0000bc10: 636f 7079 0a0a 2020 2020 6465 6620 5f66  copy..    def _f
-0000bc20: 6574 6368 416e 6441 6464 5261 6e67 6573  etchAndAddRanges
-0000bc30: 5f63 6f6e 7469 6775 6f75 7328 7365 6c66  _contiguous(self
-0000bc40: 2c20 7073 7472 2c20 7261 6e67 6573 5f74  , pstr, ranges_t
-0000bc50: 6f5f 6665 7463 682c 2070 7265 706f 7374  o_fetch, prepost
-0000bc60: 2c20 6465 6275 672c 2071 7569 6574 3d46  , debug, quiet=F
-0000bc70: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
-0000bc80: 6620 7073 7472 2069 7320 6e6f 7420 4e6f  f pstr is not No
-0000bc90: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000bca0: 7966 6375 2e54 7970 6543 6865 636b 5374  yfcu.TypeCheckSt
-0000bcb0: 7228 7073 7472 2c20 2270 7374 7222 290a  r(pstr, "pstr").
-0000bcc0: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-0000bcd0: 6543 6865 636b 4974 6572 6162 6c65 2872  eCheckIterable(r
-0000bce0: 616e 6765 735f 746f 5f66 6574 6368 2c20  anges_to_fetch, 
-0000bcf0: 2272 616e 6765 735f 746f 5f66 6574 6368  "ranges_to_fetch
-0000bd00: 2229 0a20 2020 2020 2020 2079 6663 752e  ").        yfcu.
-0000bd10: 5479 7065 4368 6563 6b42 6f6f 6c28 7072  TypeCheckBool(pr
-0000bd20: 6570 6f73 742c 2022 7072 6570 6f73 7422  epost, "prepost"
-0000bd30: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
-0000bd40: 7970 6543 6865 636b 426f 6f6c 2864 6562  ypeCheckBool(deb
-0000bd50: 7567 2c20 2264 6562 7567 2229 0a20 2020  ug, "debug").   
-0000bd60: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-0000bd70: 6563 6b42 6f6f 6c28 7175 6965 742c 2022  eckBool(quiet, "
-0000bd80: 7175 6965 7422 290a 0a20 2020 2020 2020  quiet")..       
-0000bd90: 2023 2046 6574 6368 2065 6163 6820 7261   # Fetch each ra
-0000bda0: 6e67 652c 2061 7070 656e 6469 6e67 2f70  nge, appending/p
-0000bdb0: 7265 7065 6e64 696e 6720 746f 2063 6163  repending to cac
-0000bdc0: 6865 6420 6461 7461 0a20 2020 2020 2020  hed data.       
-0000bdd0: 2069 6620 2872 616e 6765 735f 746f 5f66   if (ranges_to_f
-0000bde0: 6574 6368 2069 7320 4e6f 6e65 2920 6f72  etch is None) or
-0000bdf0: 206c 656e 2872 616e 6765 735f 746f 5f66   len(ranges_to_f
-0000be00: 6574 6368 2920 3d3d 2030 3a0a 2020 2020  etch) == 0:.    
-0000be10: 2020 2020 2020 2020 2320 7265 7475 726e          # return
-0000be20: 2068 0a20 2020 2020 2020 2020 2020 2072   h.            r
-0000be30: 6574 7572 6e0a 0a20 2020 2020 2020 2064  eturn..        d
-0000be40: 6562 7567 5f79 6663 203d 2073 656c 662e  ebug_yfc = self.
-0000be50: 5f64 6562 7567 0a20 2020 2020 2020 2023  _debug.        #
-0000be60: 2064 6562 7567 5f79 6663 203d 2054 7275   debug_yfc = Tru
-0000be70: 650a 0a20 2020 2020 2020 206c 6f67 5f6d  e..        log_m
-0000be80: 7367 203d 2066 225f 6665 7463 6841 6e64  sg = f"_fetchAnd
-0000be90: 4164 6452 616e 6765 735f 636f 6e74 6967  AddRanges_contig
-0000bea0: 756f 7573 2d7b 7365 6c66 2e69 7374 727d  uous-{self.istr}
-0000beb0: 286e 3d7b 6c65 6e28 7261 6e67 6573 5f74  (n={len(ranges_t
-0000bec0: 6f5f 6665 7463 6829 7d20 7072 6570 6f73  o_fetch)} prepos
-0000bed0: 743d 7b70 7265 706f 7374 7d29 2922 0a20  t={prepost}))". 
-0000bee0: 2020 2020 2020 2069 6620 7966 636c 2e49         if yfcl.I
-0000bef0: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
-0000bf00: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
-0000bf10: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
-0000bf20: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
-0000bf30: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
-0000bf40: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000bf50: 7428 6c6f 675f 6d73 6729 0a20 2020 2020  t(log_msg).     
-0000bf60: 2020 2020 2020 2070 7269 6e74 2822 2d20         print("- 
-0000bf70: 7261 6e67 6573 5f74 6f5f 6665 7463 683a  ranges_to_fetch:
-0000bf80: 2229 0a20 2020 2020 2020 2020 2020 2070  ").            p
-0000bf90: 7072 696e 7428 7261 6e67 6573 5f74 6f5f  print(ranges_to_
-0000bfa0: 6665 7463 6829 0a0a 2020 2020 2020 2020  fetch)..        
-0000bfb0: 747a 5f65 7863 6861 6e67 6520 3d20 5a6f  tz_exchange = Zo
-0000bfc0: 6e65 496e 666f 2873 656c 662e 747a 4e61  neInfo(self.tzNa
-0000bfd0: 6d65 290a 2020 2020 2020 2020 7966 6374  me).        yfct
-0000bfe0: 2e53 6574 4578 6368 616e 6765 547a 4e61  .SetExchangeTzNa
-0000bff0: 6d65 2873 656c 662e 6578 6368 616e 6765  me(self.exchange
-0000c000: 2c20 7365 6c66 2e74 7a4e 616d 6529 0a0a  , self.tzName)..
-0000c010: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000c020: 6820 6973 204e 6f6e 6520 6f72 2073 656c  h is None or sel
-0000c030: 662e 682e 656d 7074 793a 0a20 2020 2020  f.h.empty:.     
-0000c040: 2020 2020 2020 2068 5f66 6972 7374 5f64         h_first_d
-0000c050: 7420 3d20 4e6f 6e65 203b 2068 5f6c 6173  t = None ; h_las
-0000c060: 745f 6474 203d 204e 6f6e 650a 2020 2020  t_dt = None.    
-0000c070: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000c080: 2020 2020 2020 685f 6669 7273 745f 6474        h_first_dt
-0000c090: 203d 2073 656c 662e 682e 696e 6465 785b   = self.h.index[
-0000c0a0: 305d 2e74 6f5f 7079 6461 7465 7469 6d65  0].to_pydatetime
-0000c0b0: 2829 0a20 2020 2020 2020 2020 2020 2068  ().            h
-0000c0c0: 5f6c 6173 745f 6474 203d 2073 656c 662e  _last_dt = self.
-0000c0d0: 682e 696e 6465 785b 2d31 5d2e 746f 5f70  h.index[-1].to_p
-0000c0e0: 7964 6174 6574 696d 6528 290a 2020 2020  ydatetime().    
-0000c0f0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000c100: 7369 6e73 7461 6e63 6528 7261 6e67 6573  sinstance(ranges
-0000c110: 5f74 6f5f 6665 7463 685b 305d 5b30 5d2c  _to_fetch[0][0],
-0000c120: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
-0000c130: 2020 2020 2020 2020 2020 2020 685f 6669              h_fi
-0000c140: 7273 745f 6474 203d 2068 5f66 6972 7374  rst_dt = h_first
-0000c150: 5f64 742e 6173 7469 6d65 7a6f 6e65 2874  _dt.astimezone(t
-0000c160: 7a5f 6578 6368 616e 6765 292e 6461 7465  z_exchange).date
-0000c170: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0000c180: 2020 2068 5f6c 6173 745f 6474 203d 2068     h_last_dt = h
-0000c190: 5f6c 6173 745f 6474 2e61 7374 696d 657a  _last_dt.astimez
-0000c1a0: 6f6e 6528 747a 5f65 7863 6861 6e67 6529  one(tz_exchange)
-0000c1b0: 2e64 6174 6528 290a 2020 2020 2020 2020  .date().        
-0000c1c0: 7464 5f31 6420 3d20 7469 6d65 6465 6c74  td_1d = timedelt
-0000c1d0: 6128 6461 7973 3d31 290a 0a20 2020 2020  a(days=1)..     
-0000c1e0: 2020 2023 2042 6563 6175 7365 2064 6174     # Because dat
-0000c1f0: 6120 7368 6f75 6c64 2062 6520 636f 6e74  a should be cont
-0000c200: 6967 756f 7573 2c20 7468 656e 2072 616e  iguous, then ran
-0000c210: 6765 7320 7368 6f75 6c64 206d 6565 7420  ges should meet 
-0000c220: 736f 6d65 2063 6f6e 6469 7469 6f6e 733a  some conditions:
-0000c230: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0000c240: 7261 6e67 6573 5f74 6f5f 6665 7463 6829  ranges_to_fetch)
-0000c250: 203e 2032 3a0a 2020 2020 2020 2020 2020   > 2:.          
-0000c260: 2020 7070 7269 6e74 2872 616e 6765 735f    pprint(ranges_
-0000c270: 746f 5f66 6574 6368 290a 2020 2020 2020  to_fetch).      
-0000c280: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0000c290: 7074 696f 6e28 2246 6f72 2063 6f6e 7469  ption("For conti
-0000c2a0: 6775 6f75 7320 6461 7461 2067 656e 6572  guous data gener
-0000c2b0: 6174 6564 207b 7d3e 3220 7261 6e67 6573  ated {}>2 ranges
-0000c2c0: 222e 666f 726d 6174 286c 656e 2872 616e  ".format(len(ran
-0000c2d0: 6765 735f 746f 5f66 6574 6368 2929 290a  ges_to_fetch))).
-0000c2e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000c2f0: 682e 656d 7074 7920 616e 6420 6c65 6e28  h.empty and len(
-0000c300: 7261 6e67 6573 5f74 6f5f 6665 7463 6829  ranges_to_fetch)
-0000c310: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-0000c320: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-0000c330: 6e28 2246 6f72 2063 6f6e 7469 6775 6f75  n("For contiguou
-0000c340: 7320 6461 7461 2067 656e 6572 6174 6564  s data generated
-0000c350: 207b 7d20 7261 6e67 6573 2c20 6275 7420   {} ranges, but 
-0000c360: 6820 6973 2065 6d70 7479 222e 666f 726d  h is empty".form
-0000c370: 6174 286c 656e 2872 616e 6765 735f 746f  at(len(ranges_to
-0000c380: 5f66 6574 6368 2929 290a 2020 2020 2020  _fetch))).      
-0000c390: 2020 7261 6e67 655f 7072 6520 3d20 4e6f    range_pre = No
-0000c3a0: 6e65 203b 2072 616e 6765 5f70 6f73 7420  ne ; range_post 
-0000c3b0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-0000c3c0: 6620 7365 6c66 2e68 2e65 6d70 7479 2061  f self.h.empty a
-0000c3d0: 6e64 206c 656e 2872 616e 6765 735f 746f  nd len(ranges_to
-0000c3e0: 5f66 6574 6368 2920 3d3d 2031 3a0a 2020  _fetch) == 1:.  
-0000c3f0: 2020 2020 2020 2020 2020 7261 6e67 655f            range_
-0000c400: 7072 6520 3d20 7261 6e67 6573 5f74 6f5f  pre = ranges_to_
-0000c410: 6665 7463 685b 305d 0a20 2020 2020 2020  fetch[0].       
-0000c420: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000c430: 2020 206e 5f70 7265 203d 2030 203b 206e     n_pre = 0 ; n
-0000c440: 5f70 6f73 7420 3d20 300a 2020 2020 2020  _post = 0.      
-0000c450: 2020 2020 2020 666f 7220 7220 696e 2072        for r in r
-0000c460: 616e 6765 735f 746f 5f66 6574 6368 3a0a  anges_to_fetch:.
-0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c480: 6966 2072 5b30 5d20 3e20 685f 6c61 7374  if r[0] > h_last
-0000c490: 5f64 743a 0a20 2020 2020 2020 2020 2020  _dt:.           
-0000c4a0: 2020 2020 2020 2020 206e 5f70 6f73 7420           n_post 
-0000c4b0: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0000c4c0: 2020 2020 2020 2020 2072 616e 6765 5f70           range_p
-0000c4d0: 6f73 7420 3d20 720a 2020 2020 2020 2020  ost = r.        
-0000c4e0: 2020 2020 2020 2020 656c 6966 2072 5b30          elif r[0
-0000c4f0: 5d20 3c20 685f 6669 7273 745f 6474 3a0a  ] < h_first_dt:.
-0000c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c510: 2020 2020 6e5f 7072 6520 2b3d 2031 0a20      n_pre += 1. 
-0000c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c530: 2020 2072 616e 6765 5f70 7265 203d 2072     range_pre = r
-0000c540: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c550: 6e5f 7072 6520 3e20 313a 0a20 2020 2020  n_pre > 1:.     
-0000c560: 2020 2020 2020 2020 2020 2070 7072 696e             pprin
-0000c570: 7428 7261 6e67 6573 5f74 6f5f 6665 7463  t(ranges_to_fetc
-0000c580: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0000c590: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0000c5a0: 6f6e 2822 466f 7220 636f 6e74 6967 756f  on("For contiguo
-0000c5b0: 7573 2064 6174 6120 6765 6e65 7261 7465  us data generate
-0000c5c0: 6420 7b7d 3e31 2072 616e 6765 7320 6265  d {}>1 ranges be
-0000c5d0: 666f 7265 2068 5f66 6972 7374 5f64 7422  fore h_first_dt"
-0000c5e0: 2e66 6f72 6d61 7428 6e5f 7072 6529 290a  .format(n_pre)).
-0000c5f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000c600: 5f70 6f73 7420 3e20 313a 0a20 2020 2020  _post > 1:.     
-0000c610: 2020 2020 2020 2020 2020 2070 7072 696e             pprin
-0000c620: 7428 7261 6e67 6573 5f74 6f5f 6665 7463  t(ranges_to_fetc
-0000c630: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0000c640: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0000c650: 6f6e 2822 466f 7220 636f 6e74 6967 756f  on("For contiguo
-0000c660: 7573 2064 6174 6120 6765 6e65 7261 7465  us data generate
-0000c670: 6420 7b7d 3e31 2072 616e 6765 7320 6166  d {}>1 ranges af
-0000c680: 7465 7220 685f 6c61 7374 5f64 7422 2e66  ter h_last_dt".f
-0000c690: 6f72 6d61 7428 6e5f 706f 7374 2929 0a0a  ormat(n_post))..
-0000c6a0: 2020 2020 2020 2020 2320 4665 7463 6820          # Fetch 
-0000c6b0: 7261 6e67 6573 0a20 2020 2020 2020 2068  ranges.        h
-0000c6c0: 325f 7072 6520 3d20 4e6f 6e65 203b 2068  2_pre = None ; h
-0000c6d0: 325f 706f 7374 203d 204e 6f6e 650a 2020  2_post = None.  
-0000c6e0: 2020 2020 2020 6966 2072 616e 6765 5f70        if range_p
-0000c6f0: 7265 2069 7320 6e6f 7420 4e6f 6e65 3a0a  re is not None:.
-0000c700: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-0000c710: 7261 6e67 655f 7072 650a 2020 2020 2020  range_pre.      
-0000c720: 2020 2020 2020 2320 6368 6563 6b5f 666f        # check_fo
-0000c730: 725f 6c69 7374 696e 6720 3d20 4661 6c73  r_listing = Fals
-0000c740: 650a 2020 2020 2020 2020 2020 2020 7472  e.            tr
-0000c750: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000c760: 2020 2068 325f 7072 6520 3d20 7365 6c66     h2_pre = self
-0000c770: 2e5f 6665 7463 6859 6648 6973 746f 7279  ._fetchYfHistory
-0000c780: 2870 7374 722c 2072 5b30 5d2c 2072 5b31  (pstr, r[0], r[1
-0000c790: 5d2c 2070 7265 706f 7374 2c20 6465 6275  ], prepost, debu
-0000c7a0: 6729 0a20 2020 2020 2020 2020 2020 2065  g).            e
-0000c7b0: 7863 6570 7420 7966 6364 2e4e 6f50 7269  xcept yfcd.NoPri
-0000c7c0: 6365 4461 7461 496e 5261 6e67 6545 7863  ceDataInRangeExc
-0000c7d0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000c7e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000c7f0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0000c800: 2e49 6e74 6572 7661 6c2e 4461 7973 3120  .Interval.Days1 
-0000c810: 616e 6420 725b 315d 202d 2072 5b30 5d20  and r[1] - r[0] 
-0000c820: 3d3d 2074 645f 3164 3a0a 2020 2020 2020  == td_1d:.      
-0000c830: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000c840: 4966 206f 6e6c 7920 7472 7969 6e67 2074  If only trying t
-0000c850: 6f20 6665 7463 6820 3120 6461 7920 6f66  o fetch 1 day of
-0000c860: 2031 6420 6461 7461 2c20 7468 656e 2070   1d data, then p
-0000c870: 7269 6e74 2077 6172 6e69 6e67 2069 6e73  rint warning ins
-0000c880: 7465 6164 206f 6620 6578 6365 7074 696f  tead of exceptio
-0000c890: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-0000c8a0: 2020 2020 2020 2023 2043 6f75 6c64 2061         # Could a
-0000c8b0: 6464 2061 6464 6974 696f 6e61 6c20 636f  dd additional co
-0000c8c0: 6e64 6974 696f 6e20 6f66 2064 6976 6964  ndition of divid
-0000c8d0: 656e 6420 7072 6576 696f 7573 2064 6179  end previous day
-0000c8e0: 2028 7365 656d 7320 746f 206d 6573 7320   (seems to mess 
-0000c8f0: 7570 2074 6162 6c65 292e 0a20 2020 2020  up table)..     
-0000c900: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c910: 6620 6e6f 7420 7175 6965 743a 0a20 2020  f not quiet:.   
-0000c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c930: 2020 2020 2023 2070 7269 6e74 2822 5741       # print("WA
-0000c940: 524e 494e 473a 204e 6f20 7b7d 2d70 7269  RNING: No {}-pri
-0000c950: 6365 2064 6174 6120 6665 7463 6865 6420  ce data fetched 
-0000c960: 666f 7220 7469 636b 6572 207b 7d20 6265  for ticker {} be
-0000c970: 7477 6565 6e20 6461 7465 7320 7b7d 202d  tween dates {} -
-0000c980: 3e20 7b7d 222e 666f 726d 6174 2879 6663  > {}".format(yfc
-0000c990: 642e 696e 7465 7276 616c 546f 5374 7269  d.intervalToStri
-0000c9a0: 6e67 5b73 656c 662e 696e 7465 7276 616c  ng[self.interval
-0000c9b0: 5d2c 2073 656c 662e 7469 636b 6572 2c20  ], self.ticker, 
-0000c9c0: 725b 305d 2c20 725b 315d 2929 0a20 2020  r[0], r[1])).   
-0000c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9e0: 2020 2020 2070 7269 6e74 2866 2257 4152       print(f"WAR
-0000c9f0: 4e49 4e47 3a20 7b73 656c 662e 7469 636b  NING: {self.tick
-0000ca00: 6572 7d3a 204e 6f20 7b79 6663 642e 696e  er}: No {yfcd.in
-0000ca10: 7465 7276 616c 546f 5374 7269 6e67 5b73  tervalToString[s
-0000ca20: 656c 662e 696e 7465 7276 616c 5d7d 2d70  elf.interval]}-p
-0000ca30: 7269 6365 2064 6174 6120 6665 7463 6865  rice data fetche
-0000ca40: 6420 666f 7220 7b72 5b30 5d7d 202d 3e20  d for {r[0]} -> 
-0000ca50: 7b72 5b31 5d7d 2229 0a20 2020 2020 2020  {r[1]}").       
-0000ca60: 2020 2020 2020 2020 2020 2020 2068 325f               h2_
-0000ca70: 7072 6520 3d20 4e6f 6e65 0a20 2020 2020  pre = None.     
-0000ca80: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000ca90: 2872 616e 6765 5f70 6f73 7420 6973 204e  (range_post is N
-0000caa0: 6f6e 6529 2061 6e64 2028 725b 315d 2d72  one) and (r[1]-r
-0000cab0: 5b30 5d20 3c20 7464 5f31 642a 3729 2061  [0] < td_1d*7) a
-0000cac0: 6e64 2028 725b 315d 2d72 5b30 5d20 3e20  nd (r[1]-r[0] > 
-0000cad0: 7464 5f31 642a 3329 3a0a 2020 2020 2020  td_1d*3):.      
-0000cae0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000caf0: 536d 616c 6c20 6461 7465 2072 616e 6765  Small date range
-0000cb00: 2c20 706f 7465 6e74 6961 6c6c 7920 7472  , potentially tr
-0000cb10: 7969 6e67 2074 6f20 6665 7463 6820 6265  ying to fetch be
-0000cb20: 666f 7265 206c 6973 7469 6e67 2064 6174  fore listing dat
-0000cb30: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-0000cb40: 2020 2020 2020 2320 6368 6563 6b5f 666f        # check_fo
-0000cb50: 725f 6c69 7374 696e 6720 3d20 5472 7565  r_listing = True
-0000cb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cb70: 2020 2020 2068 325f 7072 6520 3d20 4e6f       h2_pre = No
-0000cb80: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-0000cb90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000cba0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000cbb0: 7365 0a20 2020 2020 2020 2020 2020 2023  se.            #
-0000cbc0: 2069 6620 6368 6563 6b5f 666f 725f 6c69   if check_for_li
-0000cbd0: 7374 696e 673a 0a20 2020 2020 2020 2020  sting:.         
-0000cbe0: 2020 2023 2020 2020 2064 6620 3d20 4e6f     #     df = No
-0000cbf0: 6e65 0a20 2020 2020 2020 2020 2020 2023  ne.            #
-0000cc00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000cc10: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0000cc20: 6466 203d 2073 656c 662e 5f66 6574 6368  df = self._fetch
-0000cc30: 5966 4869 7374 6f72 7928 7073 7472 2c20  YfHistory(pstr, 
-0000cc40: 725b 305d 2c20 725b 315d 2b74 645f 3164  r[0], r[1]+td_1d
-0000cc50: 2a37 2c20 7072 6570 6f73 742c 2064 6562  *7, prepost, deb
-0000cc60: 7567 290a 2020 2020 2020 2020 2020 2020  ug).            
-0000cc70: 2320 2020 2020 6578 6365 7074 2045 7863  #     except Exc
-0000cc80: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000cc90: 2020 2020 2320 2020 2020 2020 2020 2320      #         # 
-0000cca0: 4469 7363 6172 640a 2020 2020 2020 2020  Discard.        
-0000ccb0: 2020 2020 2320 2020 2020 2020 2020 7061      #         pa
-0000ccc0: 7373 0a20 2020 2020 2020 2020 2020 2023  ss.            #
-0000ccd0: 2020 2020 2069 6620 6466 2069 7320 6e6f       if df is no
-0000cce0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000ccf0: 2020 2020 2320 2020 2020 2020 2020 2320      #         # 
-0000cd00: 5468 656e 2074 6865 2065 7863 6570 7469  Then the excepti
-0000cd10: 6f6e 2061 626f 7665 206f 6363 7572 7265  on above occurre
-0000cd20: 6420 6265 6361 7573 6520 7472 7969 6e67  d because trying
-0000cd30: 2074 6f20 6665 7463 6820 6265 666f 7265   to fetch before
-0000cd40: 206c 6973 7469 6e67 2064 6174 6564 210a   listing dated!.
-0000cd50: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000cd60: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-0000cd70: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-0000cd80: 7469 636b 6572 2c20 226c 6973 7469 6e67  ticker, "listing
-0000cd90: 5f64 6174 6522 2c20 7365 6c66 2e68 2e69  _date", self.h.i
-0000cda0: 6e64 6578 5b30 5d2e 6461 7465 2829 290a  ndex[0].date()).
-0000cdb0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000cdc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000cdd0: 2020 2020 2320 2020 2020 2020 2020 2320      #         # 
-0000cde0: 5468 656e 2074 6865 2065 7863 6570 7469  Then the excepti
-0000cdf0: 6f6e 2061 626f 7665 2077 6173 2067 656e  on above was gen
-0000ce00: 7569 6e65 2061 6e64 206e 6565 6473 2074  uine and needs t
-0000ce10: 6f20 6265 2070 726f 7061 6761 7465 640a  o be propagated.
-0000ce20: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000ce30: 2020 2020 2020 7261 6973 6520 7966 6364        raise yfcd
-0000ce40: 2e4e 6f50 7269 6365 4461 7461 496e 5261  .NoPriceDataInRa
-0000ce50: 6e67 6545 7863 6570 7469 6f6e 2873 656c  ngeException(sel
-0000ce60: 662e 7469 636b 6572 2c20 7365 6c66 2e69  f.ticker, self.i
-0000ce70: 7374 722c 2072 5b30 5d2c 2072 5b31 5d29  str, r[0], r[1])
-0000ce80: 0a0a 2020 2020 2020 2020 6966 2072 616e  ..        if ran
-0000ce90: 6765 5f70 6f73 7420 6973 206e 6f74 204e  ge_post is not N
-0000cea0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000ceb0: 2072 203d 2072 616e 6765 5f70 6f73 740a   r = range_post.
-0000cec0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000ced0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cee0: 2068 325f 706f 7374 203d 2073 656c 662e   h2_post = self.
-0000cef0: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
-0000cf00: 7073 7472 2c20 725b 305d 2c20 725b 315d  pstr, r[0], r[1]
-0000cf10: 2c20 7072 6570 6f73 742c 2064 6562 7567  , prepost, debug
-0000cf20: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-0000cf30: 6365 7074 2079 6663 642e 4e6f 5072 6963  cept yfcd.NoPric
-0000cf40: 6544 6174 6149 6e52 616e 6765 4578 6365  eDataInRangeExce
-0000cf50: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-0000cf60: 2020 2020 2020 2023 2049 6620 6f6e 6c79         # If only
-0000cf70: 2074 7279 696e 6720 746f 2066 6574 6368   trying to fetch
-0000cf80: 2031 2064 6179 206f 6620 3164 2064 6174   1 day of 1d dat
-0000cf90: 612c 2074 6865 6e20 7072 696e 7420 7761  a, then print wa
-0000cfa0: 726e 696e 6720 696e 7374 6561 6420 6f66  rning instead of
-0000cfb0: 2065 7863 6570 7469 6f6e 2e0a 2020 2020   exception..    
-0000cfc0: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
-0000cfd0: 756c 6420 6164 6420 6164 6469 7469 6f6e  uld add addition
-0000cfe0: 616c 2063 6f6e 6469 7469 6f6e 206f 6620  al condition of 
-0000cff0: 6469 7669 6465 6e64 2070 7265 7669 6f75  dividend previou
-0000d000: 7320 6461 7920 2873 6565 6d73 2074 6f20  s day (seems to 
-0000d010: 6d65 7373 2075 7020 7461 626c 6529 2e0a  mess up table)..
-0000d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d030: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
-0000d040: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
-0000d050: 6c2e 4461 7973 3120 616e 6420 725b 315d  l.Days1 and r[1]
-0000d060: 202d 2072 5b30 5d20 3d3d 2074 645f 3164   - r[0] == td_1d
-0000d070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d080: 2020 2020 2020 6966 206e 6f74 2071 7569        if not qui
-0000d090: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-0000d0a0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0000d0b0: 696e 7428 2257 4152 4e49 4e47 3a20 4e6f  int("WARNING: No
-0000d0c0: 207b 7d2d 7072 6963 6520 6461 7461 2066   {}-price data f
-0000d0d0: 6574 6368 6564 2066 6f72 2074 6963 6b65  etched for ticke
-0000d0e0: 7220 7b7d 2062 6574 7765 656e 2064 6174  r {} between dat
-0000d0f0: 6573 207b 7d20 2d3e 207b 7d22 2e66 6f72  es {} -> {}".for
-0000d100: 6d61 7428 7966 6364 2e69 6e74 6572 7661  mat(yfcd.interva
-0000d110: 6c54 6f53 7472 696e 675b 7365 6c66 2e69  lToString[self.i
-0000d120: 6e74 6572 7661 6c5d 2c20 7365 6c66 2e74  nterval], self.t
-0000d130: 6963 6b65 722c 2072 5b30 5d2c 2072 5b31  icker, r[0], r[1
-0000d140: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-0000d150: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000d160: 7428 6622 5741 524e 494e 473a 207b 7365  t(f"WARNING: {se
-0000d170: 6c66 2e74 6963 6b65 727d 3a20 4e6f 207b  lf.ticker}: No {
-0000d180: 7966 6364 2e69 6e74 6572 7661 6c54 6f53  yfcd.intervalToS
-0000d190: 7472 696e 675b 7365 6c66 2e69 6e74 6572  tring[self.inter
-0000d1a0: 7661 6c5d 7d2d 7072 6963 6520 6461 7461  val]}-price data
-0000d1b0: 2066 6574 6368 6564 2066 6f72 207b 725b   fetched for {r[
-0000d1c0: 305d 7d20 2d3e 207b 725b 315d 7d22 290a  0]} -> {r[1]}").
-0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1e0: 2020 2020 6832 5f70 6f73 7420 3d20 4e6f      h2_post = No
-0000d1f0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-0000d200: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000d210: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000d220: 7365 0a0a 2020 2020 2020 2020 6c69 7374  se..        list
-0000d230: 696e 675f 6461 7465 203d 2079 6663 6d2e  ing_date = yfcm.
-0000d240: 5265 6164 4361 6368 6544 6174 756d 2873  ReadCacheDatum(s
-0000d250: 656c 662e 7469 636b 6572 2c20 226c 6973  elf.ticker, "lis
-0000d260: 7469 6e67 5f64 6174 6522 290a 2020 2020  ting_date").    
-0000d270: 2020 2020 6966 206c 6973 7469 6e67 5f64      if listing_d
-0000d280: 6174 6520 6973 204e 6f6e 653a 0a20 2020  ate is None:.   
-0000d290: 2020 2020 2020 2020 206c 6973 7469 6e67           listing
-0000d2a0: 5f64 6174 6520 3d20 7365 6c66 2e64 6174  _date = self.dat
-0000d2b0: 2e68 6973 746f 7279 5f6d 6574 6164 6174  .history_metadat
-0000d2c0: 615b 2266 6972 7374 5472 6164 6544 6174  a["firstTradeDat
-0000d2d0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-0000d2e0: 6966 2069 7369 6e73 7461 6e63 6528 6c69  if isinstance(li
-0000d2f0: 7374 696e 675f 6461 7465 2c20 696e 7429  sting_date, int)
-0000d300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d310: 2020 6c69 7374 696e 675f 6461 7465 203d    listing_date =
-0000d320: 2070 642e 746f 5f64 6174 6574 696d 6528   pd.to_datetime(
-0000d330: 6c69 7374 696e 675f 6461 7465 2c20 756e  listing_date, un
-0000d340: 6974 3d27 7327 2c20 7574 633d 5472 7565  it='s', utc=True
-0000d350: 292e 747a 5f63 6f6e 7665 7274 2874 7a5f  ).tz_convert(tz_
-0000d360: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
-0000d370: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-0000d380: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-0000d390: 7469 636b 6572 2c20 226c 6973 7469 6e67  ticker, "listing
-0000d3a0: 5f64 6174 6522 2c20 6c69 7374 696e 675f  _date", listing_
-0000d3b0: 6461 7465 2e64 6174 6528 2929 0a0a 2020  date.date())..  
-0000d3c0: 2020 2020 2020 6966 2068 325f 706f 7374        if h2_post
-0000d3d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000d3e0: 2020 2020 2020 2020 2020 2320 4465 2d61            # De-a
-0000d3f0: 646a 7573 7420 7468 6520 6e65 7720 6461  djust the new da
-0000d400: 7461 2c20 616e 6420 6261 636b 706f 7274  ta, and backport
-0000d410: 2061 6e79 206e 6577 2065 7665 6e74 7320   any new events 
-0000d420: 696e 2063 6163 6865 6420 6461 7461 0a20  in cached data. 
-0000d430: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-0000d440: 653a 2059 6168 6f6f 2061 6c77 6179 7320  e: Yahoo always 
-0000d450: 7265 7475 726e 7320 7370 6c69 742d 6164  returns split-ad
-0000d460: 6a75 7374 6564 2070 7269 6365 2c20 736f  justed price, so
-0000d470: 2072 6576 6572 7365 2069 740a 0a20 2020   reverse it..   
-0000d480: 2020 2020 2020 2020 2023 2053 696d 706c           # Simpl
-0000d490: 6520 6170 7065 6e64 2074 6f20 626f 7474  e append to bott
-0000d4a0: 6f6d 206f 6620 7461 626c 650a 2020 2020  om of table.    
-0000d4b0: 2020 2020 2020 2020 2320 3129 2061 646a          # 1) adj
-0000d4c0: 7573 7420 6832 5f70 6f73 740a 2020 2020  ust h2_post.    
-0000d4d0: 2020 2020 2020 2020 6832 5f70 6f73 7420          h2_post 
-0000d4e0: 3d20 7365 6c66 2e5f 7265 7665 7273 6559  = self._reverseY
-0000d4f0: 6168 6f6f 4164 6a75 7374 2868 325f 706f  ahooAdjust(h2_po
-0000d500: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0000d510: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-0000d520: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000d530: 696e 7428 222d 2068 325f 706f 7374 3a22  int("- h2_post:"
-0000d540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000d550: 2020 7072 696e 7428 6832 5f70 6f73 7429    print(h2_post)
-0000d560: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000d570: 544f 444f 3a20 5072 6f62 6c65 6d3a 2064  TODO: Problem: d
-0000d580: 6976 6964 656e 6473 206e 6565 6420 636f  ividends need co
-0000d590: 7272 6563 7420 636c 6f73 650a 2020 2020  rrect close.    
-0000d5a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000d5b0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0000d5c0: 2e49 6e74 6572 7661 6c2e 4461 7973 313a  .Interval.Days1:
-0000d5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d5e0: 2068 325f 706f 7374 5f73 706c 6974 7320   h2_post_splits 
-0000d5f0: 3d20 6832 5f70 6f73 745b 6832 5f70 6f73  = h2_post[h2_pos
-0000d600: 745b 2253 746f 636b 2053 706c 6974 7322  t["Stock Splits"
-0000d610: 5d20 213d 2030 5d5b 5b22 5374 6f63 6b20  ] != 0][["Stock 
-0000d620: 5370 6c69 7473 222c 2022 4665 7463 6844  Splits", "FetchD
-0000d630: 6174 6522 5d5d 2e63 6f70 7928 290a 2020  ate"]].copy().  
-0000d640: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000d650: 206e 6f74 2068 325f 706f 7374 5f73 706c   not h2_post_spl
-0000d660: 6974 732e 656d 7074 793a 0a20 2020 2020  its.empty:.     
-0000d670: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d680: 656c 662e 6d61 6e61 6765 722e 4765 7448  elf.manager.GetH
-0000d690: 6973 746f 7279 2822 4576 656e 7473 2229  istory("Events")
-0000d6a0: 2e55 7064 6174 6553 706c 6974 7328 6832  .UpdateSplits(h2
-0000d6b0: 5f70 6f73 745f 7370 6c69 7473 290a 2020  _post_splits).  
-0000d6c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000d6d0: 5570 6461 7465 3a20 6d6f 7669 6e67 2055  Update: moving U
-0000d6e0: 7064 6174 6544 6976 6964 656e 6473 2829  pdateDividends()
-0000d6f0: 2074 6f20 6166 7465 7220 7265 7061 6972   to after repair
-0000d700: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000d710: 4261 636b 706f 7274 206e 6577 2065 7665  Backport new eve
-0000d720: 6e74 7320 6163 726f 7373 2065 6e74 6972  nts across entir
-0000d730: 6520 6820 7461 626c 650a 2020 2020 2020  e h table.      
-0000d740: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
-0000d750: 794e 6577 4576 656e 7473 2829 0a0a 2020  yNewEvents()..  
-0000d760: 2020 2020 2020 2020 2020 6966 2068 325f            if h2_
-0000d770: 706f 7374 2069 7320 6e6f 7420 4e6f 6e65  post is not None
-0000d780: 2061 6e64 206e 6f74 2069 7369 6e73 7461   and not isinsta
-0000d790: 6e63 6528 6832 5f70 6f73 742e 696e 6465  nce(h2_post.inde
-0000d7a0: 782c 2070 642e 4461 7465 7469 6d65 496e  x, pd.DatetimeIn
-0000d7b0: 6465 7829 3a0a 2020 2020 2020 2020 2020  dex):.          
-0000d7c0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0000d7d0: 7074 696f 6e28 2268 325f 706f 7374 2e69  ption("h2_post.i
-0000d7e0: 6e64 6578 206e 6f74 2044 6174 6574 696d  ndex not Datetim
-0000d7f0: 6549 6e64 6578 2229 0a0a 2020 2020 2020  eIndex")..      
-0000d800: 2020 2020 2020 6966 2022 4164 6a20 436c        if "Adj Cl
-0000d810: 6f73 6522 2069 6e20 6832 5f70 6f73 742e  ose" in h2_post.
-0000d820: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0000d830: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-0000d840: 7863 6570 7469 6f6e 2822 4164 6a20 436c  xception("Adj Cl
-0000d850: 6f73 6520 696e 2068 325f 706f 7374 2229  ose in h2_post")
-0000d860: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000d870: 662e 6820 3d20 7064 2e63 6f6e 6361 7428  f.h = pd.concat(
-0000d880: 5b73 656c 662e 682c 2068 325f 706f 7374  [self.h, h2_post
-0000d890: 5d2c 2073 6f72 743d 5472 7565 290a 2020  ], sort=True).  
-0000d8a0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-0000d8b0: 2e69 6e64 6578 203d 2070 642e 746f 5f64  .index = pd.to_d
-0000d8c0: 6174 6574 696d 6528 7365 6c66 2e68 2e69  atetime(self.h.i
-0000d8d0: 6e64 6578 2c20 7574 633d 5472 7565 292e  ndex, utc=True).
-0000d8e0: 747a 5f63 6f6e 7665 7274 2874 7a5f 6578  tz_convert(tz_ex
-0000d8f0: 6368 616e 6765 290a 0a20 2020 2020 2020  change)..       
-0000d900: 2069 6620 6832 5f70 7265 2069 7320 6e6f   if h2_pre is no
-0000d910: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000d920: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-0000d930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d940: 2020 7072 696e 7428 222d 2070 7265 7065    print("- prepe
-0000d950: 6e64 696e 6720 6e65 7720 6461 7461 2229  nding new data")
-0000d960: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0000d970: 696d 706c 6520 7072 6570 656e 6420 746f  imple prepend to
-0000d980: 2074 6f70 206f 6620 7461 626c 650a 0a20   top of table.. 
-0000d990: 2020 2020 2020 2020 2020 2068 325f 7072             h2_pr
-0000d9a0: 6520 3d20 7365 6c66 2e5f 7265 7665 7273  e = self._revers
-0000d9b0: 6559 6168 6f6f 4164 6a75 7374 2868 325f  eYahooAdjust(h2_
-0000d9c0: 7072 6529 0a0a 2020 2020 2020 2020 2020  pre)..          
-0000d9d0: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
-0000d9e0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-0000d9f0: 7661 6c2e 4461 7973 313a 0a20 2020 2020  val.Days1:.     
-0000da00: 2020 2020 2020 2020 2020 2068 325f 7072             h2_pr
-0000da10: 655f 7370 6c69 7473 203d 2068 325f 7072  e_splits = h2_pr
-0000da20: 655b 6832 5f70 7265 5b22 5374 6f63 6b20  e[h2_pre["Stock 
-0000da30: 5370 6c69 7473 225d 2021 3d20 305d 5b5b  Splits"] != 0][[
-0000da40: 2253 746f 636b 2053 706c 6974 7322 2c20  "Stock Splits", 
-0000da50: 2246 6574 6368 4461 7465 225d 5d2e 636f  "FetchDate"]].co
-0000da60: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-0000da70: 2020 2020 2069 6620 6e6f 7420 6832 5f70       if not h2_p
-0000da80: 7265 5f73 706c 6974 732e 656d 7074 793a  re_splits.empty:
-0000da90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000daa0: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
-0000dab0: 722e 4765 7448 6973 746f 7279 2822 4576  r.GetHistory("Ev
-0000dac0: 656e 7473 2229 2e55 7064 6174 6553 706c  ents").UpdateSpl
-0000dad0: 6974 7328 6832 5f70 7265 5f73 706c 6974  its(h2_pre_split
-0000dae0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0000daf0: 2320 6832 5f70 7265 203d 2068 325f 7072  # h2_pre = h2_pr
-0000db00: 652e 6472 6f70 285b 2244 6976 6964 656e  e.drop(["Dividen
-0000db10: 6473 222c 2022 5374 6f63 6b20 5370 6c69  ds", "Stock Spli
-0000db20: 7473 225d 2c20 6178 6973 3d31 290a 2020  ts"], axis=1).  
-0000db30: 2020 2020 2020 2020 2020 6966 2022 4164            if "Ad
-0000db40: 6a20 436c 6f73 6522 2069 6e20 6832 5f70  j Close" in h2_p
-0000db50: 7265 2e63 6f6c 756d 6e73 3a0a 2020 2020  re.columns:.    
-0000db60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000db70: 6520 4578 6365 7074 696f 6e28 2241 646a  e Exception("Adj
-0000db80: 2043 6c6f 7365 2069 6e20 6832 5f70 7265   Close in h2_pre
-0000db90: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
-0000dba0: 656c 662e 6820 3d20 7064 2e63 6f6e 6361  elf.h = pd.conca
-0000dbb0: 7428 5b73 656c 662e 682c 2068 325f 7072  t([self.h, h2_pr
-0000dbc0: 655d 2c20 736f 7274 3d54 7275 6529 0a20  e], sort=True). 
-0000dbd0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000dbe0: 682e 696e 6465 7820 3d20 7064 2e74 6f5f  h.index = pd.to_
-0000dbf0: 6461 7465 7469 6d65 2873 656c 662e 682e  datetime(self.h.
-0000dc00: 696e 6465 782c 2075 7463 3d54 7275 6529  index, utc=True)
-0000dc10: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
-0000dc20: 7863 6861 6e67 6529 0a0a 2020 2020 2020  xchange)..      
-0000dc30: 2020 7365 6c66 2e68 203d 2073 656c 662e    self.h = self.
-0000dc40: 682e 736f 7274 5f69 6e64 6578 2829 0a20  h.sort_index(). 
-0000dc50: 2020 2020 2020 2073 656c 662e 5f75 7064         self._upd
-0000dc60: 6174 6564 4361 6368 6564 5072 6963 6573  atedCachedPrices
-0000dc70: 2873 656c 662e 6829 0a0a 2020 2020 2020  (self.h)..      
-0000dc80: 2020 6c6f 675f 6d73 6720 3d20 225f 6665    log_msg = "_fe
-0000dc90: 7463 6841 6e64 4164 6452 616e 6765 735f  tchAndAddRanges_
-0000dca0: 636f 6e74 6967 756f 7573 2829 2072 6574  contiguous() ret
-0000dcb0: 7572 6e69 6e67 220a 2020 2020 2020 2020  urning".        
-0000dcc0: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
-0000dcd0: 6745 6e61 626c 6564 2829 3a0a 2020 2020  gEnabled():.    
-0000dce0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-0000dcf0: 6365 4578 6974 286c 6f67 5f6d 7367 290a  ceExit(log_msg).
-0000dd00: 2020 2020 2020 2020 656c 6966 2064 6562          elif deb
-0000dd10: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
-0000dd20: 2020 2020 7072 696e 7428 222d 2068 3a22      print("- h:"
-0000dd30: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-0000dd40: 696e 7428 7365 6c66 2e68 290a 2020 2020  int(self.h).    
-0000dd50: 2020 2020 2020 2020 7072 696e 7428 6c6f          print(lo
-0000dd60: 675f 6d73 6729 0a0a 2020 2020 6465 6620  g_msg)..    def 
-0000dd70: 5f66 6574 6368 416e 6441 6464 5261 6e67  _fetchAndAddRang
-0000dd80: 6573 5f73 7061 7273 6528 7365 6c66 2c20  es_sparse(self, 
-0000dd90: 7073 7472 2c20 7261 6e67 6573 5f74 6f5f  pstr, ranges_to_
-0000dda0: 6665 7463 682c 2070 7265 706f 7374 2c20  fetch, prepost, 
-0000ddb0: 6465 6275 672c 2071 7569 6574 3d46 616c  debug, quiet=Fal
-0000ddc0: 7365 293a 0a20 2020 2020 2020 2069 6620  se):.        if 
-0000ddd0: 7073 7472 2069 7320 6e6f 7420 4e6f 6e65  pstr is not None
-0000dde0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-0000ddf0: 6375 2e54 7970 6543 6865 636b 5374 7228  cu.TypeCheckStr(
-0000de00: 7073 7472 2c20 2270 7374 7222 290a 2020  pstr, "pstr").  
-0000de10: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-0000de20: 6865 636b 4974 6572 6162 6c65 2872 616e  heckIterable(ran
-0000de30: 6765 735f 746f 5f66 6574 6368 2c20 2272  ges_to_fetch, "r
-0000de40: 616e 6765 735f 746f 5f66 6574 6368 2229  anges_to_fetch")
-0000de50: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
-0000de60: 7065 4368 6563 6b42 6f6f 6c28 7072 6570  peCheckBool(prep
-0000de70: 6f73 742c 2022 7072 6570 6f73 7422 290a  ost, "prepost").
-0000de80: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-0000de90: 6543 6865 636b 426f 6f6c 2864 6562 7567  eCheckBool(debug
-0000dea0: 2c20 2264 6562 7567 2229 0a20 2020 2020  , "debug").     
-0000deb0: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
-0000dec0: 6b42 6f6f 6c28 7175 6965 742c 2022 7175  kBool(quiet, "qu
-0000ded0: 6965 7422 290a 0a20 2020 2020 2020 2023  iet")..        #
-0000dee0: 2046 6574 6368 2065 6163 6820 7261 6e67   Fetch each rang
-0000def0: 652c 2062 7574 2063 616e 2062 6520 6361  e, but can be ca
-0000df00: 7265 6c65 7373 2072 6567 6172 6469 6e67  reless regarding
-0000df10: 2064 652d 6164 6a75 7374 2062 6563 6175   de-adjust becau
-0000df20: 7365 0a20 2020 2020 2020 2023 2067 6574  se.        # get
-0000df30: 7469 6e67 2065 7665 6e74 7320 6672 6f6d  ting events from
-0000df40: 2074 6865 2063 6172 6566 756c 6c79 2d6d   the carefully-m
-0000df50: 616e 6167 6564 2064 6169 6c79 2064 6174  anaged daily dat
-0000df60: 610a 2020 2020 2020 2020 6966 2028 7261  a.        if (ra
-0000df70: 6e67 6573 5f74 6f5f 6665 7463 6820 6973  nges_to_fetch is
-0000df80: 204e 6f6e 6529 206f 7220 6c65 6e28 7261   None) or len(ra
-0000df90: 6e67 6573 5f74 6f5f 6665 7463 6829 203d  nges_to_fetch) =
-0000dfa0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0000dfb0: 2023 2072 6574 7572 6e20 680a 2020 2020   # return h.    
-0000dfc0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0000dfd0: 2020 2020 2020 2020 6465 6275 675f 7966          debug_yf
-0000dfe0: 6320 3d20 7365 6c66 2e5f 6465 6275 670a  c = self._debug.
-0000dff0: 2020 2020 2020 2020 2320 6465 6275 675f          # debug_
-0000e000: 7966 6320 3d20 5472 7565 0a0a 2020 2020  yfc = True..    
-0000e010: 2020 2020 6c6f 675f 6d73 6720 3d20 6622      log_msg = f"
-0000e020: 5f66 6574 6368 416e 6441 6464 5261 6e67  _fetchAndAddRang
-0000e030: 6573 5f73 7061 7273 6528 7072 6570 6f73  es_sparse(prepos
-0000e040: 743d 7b70 7265 706f 7374 7d29 220a 2020  t={prepost})".  
-0000e050: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
-0000e060: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-0000e070: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-0000e080: 636c 2e54 7261 6365 456e 7465 7228 6c6f  cl.TraceEnter(lo
-0000e090: 675f 6d73 6729 0a20 2020 2020 2020 2065  g_msg).        e
-0000e0a0: 6c69 6620 6465 6275 675f 7966 633a 0a20  lif debug_yfc:. 
-0000e0b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000e0c0: 286c 6f67 5f6d 7367 290a 0a20 2020 2020  (log_msg)..     
-0000e0d0: 2020 2074 7a5f 6578 6368 616e 6765 203d     tz_exchange =
-0000e0e0: 2073 656c 662e 747a 0a20 2020 2020 2020   self.tz.       
-0000e0f0: 2074 645f 3164 203d 2074 696d 6564 656c   td_1d = timedel
-0000e100: 7461 2864 6179 733d 3129 0a20 2020 2020  ta(days=1).     
-0000e110: 2020 2064 746e 6f77 203d 2070 642e 5469     dtnow = pd.Ti
-0000e120: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
-0000e130: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
-0000e140: 7863 6861 6e67 6529 0a0a 2020 2020 2020  xchange)..      
-0000e150: 2020 2320 4261 636b 706f 7274 2065 7665    # Backport eve
-0000e160: 6e74 7320 7468 6174 206f 6363 7572 7265  nts that occurre
-0000e170: 6420 7369 6e63 6520 6c61 7374 2061 646a  d since last adj
-0000e180: 7573 746d 656e 743a 0a20 2020 2020 2020  ustment:.       
-0000e190: 2073 656c 662e 5f61 7070 6c79 4e65 7745   self._applyNewE
-0000e1a0: 7665 6e74 7328 290a 0a20 2020 2020 2020  vents()..       
-0000e1b0: 2023 2045 6e73 7572 6520 6861 7665 2064   # Ensure have d
-0000e1c0: 6169 6c79 2064 6174 6120 636f 7665 7269  aily data coveri
-0000e1d0: 6e67 2061 6c6c 2072 616e 6765 735f 746f  ng all ranges_to
-0000e1e0: 5f66 6574 6368 2c20 736f 2074 6865 7920  _fetch, so they 
-0000e1f0: 6361 6e20 6265 2064 652d 7370 6c69 7474  can be de-splitt
-0000e200: 6564 0a20 2020 2020 2020 2072 5f73 7461  ed.        r_sta
-0000e210: 7274 5f65 6172 6c69 6573 7420 3d20 7261  rt_earliest = ra
-0000e220: 6e67 6573 5f74 6f5f 6665 7463 685b 305d  nges_to_fetch[0]
-0000e230: 5b30 5d0a 2020 2020 2020 2020 666f 7220  [0].        for 
-0000e240: 7273 7461 7274 2c20 7265 6e64 2069 6e20  rstart, rend in 
-0000e250: 7261 6e67 6573 5f74 6f5f 6665 7463 683a  ranges_to_fetch:
-0000e260: 0a20 2020 2020 2020 2020 2020 2072 5f73  .            r_s
-0000e270: 7461 7274 5f65 6172 6c69 6573 7420 3d20  tart_earliest = 
-0000e280: 6d69 6e28 7273 7461 7274 2c20 725f 7374  min(rstart, r_st
-0000e290: 6172 745f 6561 726c 6965 7374 290a 2020  art_earliest).  
-0000e2a0: 2020 2020 2020 725f 7374 6172 745f 6561        r_start_ea
-0000e2b0: 726c 6965 7374 5f64 203d 2072 5f73 7461  rliest_d = r_sta
-0000e2c0: 7274 5f65 6172 6c69 6573 742e 6461 7465  rt_earliest.date
-0000e2d0: 2829 2069 6620 6973 696e 7374 616e 6365  () if isinstance
-0000e2e0: 2872 5f73 7461 7274 5f65 6172 6c69 6573  (r_start_earlies
-0000e2f0: 742c 2064 6174 6574 696d 6529 2065 6c73  t, datetime) els
-0000e300: 6520 725f 7374 6172 745f 6561 726c 6965  e r_start_earlie
-0000e310: 7374 0a20 2020 2020 2020 2069 6620 6465  st.        if de
-0000e320: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-0000e330: 2020 2020 2070 7269 6e74 2822 2d20 725f       print("- r_
-0000e340: 7374 6172 745f 6561 726c 6965 7374 203d  start_earliest =
-0000e350: 207b 7d22 2e66 6f72 6d61 7428 725f 7374   {}".format(r_st
-0000e360: 6172 745f 6561 726c 6965 7374 2929 0a20  art_earliest)). 
-0000e370: 2020 2020 2020 2023 2054 7269 6767 6572         # Trigger
-0000e380: 2070 7269 6365 2073 796e 633a 0a20 2020   price sync:.   
-0000e390: 2020 2020 2068 6973 7444 6169 6c79 203d       histDaily =
-0000e3a0: 2073 656c 662e 6d61 6e61 6765 722e 4765   self.manager.Ge
-0000e3b0: 7448 6973 746f 7279 2879 6663 642e 496e  tHistory(yfcd.In
-0000e3c0: 7465 7276 616c 2e44 6179 7331 290a 2020  terval.Days1).  
-0000e3d0: 2020 2020 2020 2320 6869 7374 4461 696c        # histDail
-0000e3e0: 792e 6765 7428 7374 6172 743d 725f 7374  y.get(start=r_st
-0000e3f0: 6172 745f 6561 726c 6965 7374 5f64 2c20  art_earliest_d, 
-0000e400: 6d61 785f 6167 653d 7464 5f31 6429 0a20  max_age=td_1d). 
-0000e410: 2020 2020 2020 2068 6973 7444 6169 6c79         histDaily
-0000e420: 2e67 6574 2873 7461 7274 3d72 5f73 7461  .get(start=r_sta
-0000e430: 7274 5f65 6172 6c69 6573 745f 642c 206d  rt_earliest_d, m
-0000e440: 6178 5f61 6765 3d74 645f 3164 2c20 7265  ax_age=td_1d, re
-0000e450: 7061 6972 3d46 616c 7365 290a 0a20 2020  pair=False)..   
-0000e460: 2020 2020 2023 2046 6574 6368 2065 6163       # Fetch eac
-0000e470: 6820 7261 6e67 652c 2061 6e64 2061 646a  h range, and adj
-0000e480: 7573 7420 666f 7220 7370 6c69 7473 2074  ust for splits t
-0000e490: 6861 7420 6f63 6375 7272 6564 2061 6674  hat occurred aft
-0000e4a0: 6572 0a20 2020 2020 2020 2066 6f72 2072  er.        for r
-0000e4b0: 7374 6172 742c 2072 656e 6420 696e 2072  start, rend in r
-0000e4c0: 616e 6765 735f 746f 5f66 6574 6368 3a0a  anges_to_fetch:.
-0000e4d0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
-0000e4e0: 685f 7374 6172 7420 3d20 7273 7461 7274  h_start = rstart
-0000e4f0: 0a20 2020 2020 2020 2020 2020 2066 6574  .            fet
-0000e500: 6368 5f65 6e64 203d 2072 656e 640a 2020  ch_end = rend.  
-0000e510: 2020 2020 2020 2020 2020 2320 6966 206e            # if n
-0000e520: 6f74 2073 656c 662e 696e 7465 7264 6179  ot self.interday
-0000e530: 3a20 2023 2061 6e64 2066 6574 6368 5f73  :  # and fetch_s
-0000e540: 7461 7274 2e64 6174 6528 2920 3d3d 2066  tart.date() == f
-0000e550: 6574 6368 5f65 6e64 2e64 6174 6528 293a  etch_end.date():
-0000e560: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000e570: 2020 2023 2049 6e74 7261 6461 7920 6665     # Intraday fe
-0000e580: 7463 6865 7320 6265 6861 7665 2062 6574  tches behave bet
-0000e590: 7465 7220 7768 656e 2074 696d 6520 3d20  ter when time = 
-0000e5a0: 6d69 646e 6967 6874 0a20 2020 2020 2020  midnight.       
-0000e5b0: 2020 2020 2023 2020 2020 2066 6574 6368       #     fetch
-0000e5c0: 5f73 7461 7274 203d 2066 6574 6368 5f73  _start = fetch_s
-0000e5d0: 7461 7274 2e66 6c6f 6f72 2822 3144 2229  tart.floor("1D")
-0000e5e0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000e5f0: 2020 2066 6574 6368 5f65 6e64 203d 2066     fetch_end = f
-0000e600: 6574 6368 5f65 6e64 2e63 6569 6c28 2231  etch_end.ceil("1
-0000e610: 4422 290a 2020 2020 2020 2020 2020 2020  D").            
-0000e620: 2320 5570 6461 7465 3a20 6461 7461 2072  # Update: data r
-0000e630: 656c 6961 6269 6c69 7479 206e 6f77 2066  eliability now f
-0000e640: 6978 6564 2062 7920 4368 756e 6b44 6174  ixed by ChunkDat
-0000e650: 6573 496e 746f 5966 4665 7463 6865 7328  esIntoYfFetches(
-0000e660: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000e670: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
-0000e680: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000e690: 7428 222d 2066 6574 6368 696e 6720 7b7d  t("- fetching {}
-0000e6a0: 202d 3e20 7b7d 222e 666f 726d 6174 2866   -> {}".format(f
-0000e6b0: 6574 6368 5f73 7461 7274 2c20 6665 7463  etch_start, fetc
-0000e6c0: 685f 656e 6429 290a 2020 2020 2020 2020  h_end)).        
-0000e6d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000e6e0: 2020 2020 2020 2020 2068 3220 3d20 7365           h2 = se
-0000e6f0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
-0000e700: 7279 2870 7374 722c 2066 6574 6368 5f73  ry(pstr, fetch_s
-0000e710: 7461 7274 2c20 6665 7463 685f 656e 642c  tart, fetch_end,
-0000e720: 2070 7265 706f 7374 2c20 6465 6275 6729   prepost, debug)
-0000e730: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000e740: 6570 7420 7966 6364 2e4e 6f50 7269 6365  ept yfcd.NoPrice
-0000e750: 4461 7461 496e 5261 6e67 6545 7863 6570  DataInRangeExcep
-0000e760: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-0000e770: 2020 2020 2020 2320 4966 206f 6e6c 7920        # If only 
-0000e780: 7472 7969 6e67 2074 6f20 6665 7463 6820  trying to fetch 
-0000e790: 3120 6461 7920 6f66 2031 6420 6461 7461  1 day of 1d data
-0000e7a0: 2c20 7468 656e 2070 7269 6e74 2077 6172  , then print war
-0000e7b0: 6e69 6e67 2069 6e73 7465 6164 206f 6620  ning instead of 
-0000e7c0: 6578 6365 7074 696f 6e2e 0a20 2020 2020  exception..     
-0000e7d0: 2020 2020 2020 2020 2020 2023 2043 6f75             # Cou
-0000e7e0: 6c64 2061 6464 2061 6464 6974 696f 6e61  ld add additiona
-0000e7f0: 6c20 636f 6e64 6974 696f 6e20 6f66 2064  l condition of d
-0000e800: 6976 6964 656e 6420 7072 6576 696f 7573  ividend previous
-0000e810: 2064 6179 2028 7365 656d 7320 746f 206d   day (seems to m
-0000e820: 6573 7320 7570 2074 6162 6c65 292e 0a20  ess up table).. 
-0000e830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000e840: 676e 6f72 6520 3d20 4661 6c73 650a 2020  gnore = False.  
-0000e850: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e860: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-0000e870: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-0000e880: 4461 7973 3120 616e 6420 6665 7463 685f  Days1 and fetch_
-0000e890: 656e 6420 2d20 6665 7463 685f 7374 6172  end - fetch_star
-0000e8a0: 7420 3d3d 2074 645f 3164 3a0a 2020 2020  t == td_1d:.    
-0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8c0: 6967 6e6f 7265 203d 2054 7275 650a 2020  ignore = True.  
-0000e8d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000e8e0: 6966 2073 656c 662e 696e 7472 6164 6179  if self.intraday
-0000e8f0: 2061 6e64 2066 6574 6368 5f73 7461 7274   and fetch_start
-0000e900: 2e64 6174 6528 2920 3d3d 2064 746e 6f77  .date() == dtnow
-0000e910: 2e64 6174 6528 293a 0a20 2020 2020 2020  .date():.       
-0000e920: 2020 2020 2020 2020 2020 2020 2069 676e               ign
-0000e930: 6f72 6520 3d20 5472 7565 0a20 2020 2020  ore = True.     
-0000e940: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000e950: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
-0000e960: 2079 6663 642e 496e 7465 7276 616c 2e4d   yfcd.Interval.M
-0000e970: 696e 7331 2061 6e64 2066 6574 6368 5f65  ins1 and fetch_e
-0000e980: 6e64 202d 2066 6574 6368 5f73 7461 7274  nd - fetch_start
-0000e990: 203c 3d20 7469 6d65 6465 6c74 6128 6d69   <= timedelta(mi
-0000e9a0: 6e75 7465 733d 3130 293a 0a20 2020 2020  nutes=10):.     
-0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000e9c0: 676e 6f72 6520 3d20 5472 7565 0a20 2020  gnore = True.   
-0000e9d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000e9e0: 6967 6e6f 7265 3a0a 2020 2020 2020 2020  ignore:.        
-0000e9f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000ea00: 6f74 2071 7569 6574 3a0a 2020 2020 2020  ot quiet:.      
-0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea20: 2020 2320 7072 696e 7428 2257 4152 4e49    # print("WARNI
-0000ea30: 4e47 3a20 4e6f 207b 7d2d 7072 6963 6520  NG: No {}-price 
-0000ea40: 6461 7461 2066 6574 6368 6564 2066 6f72  data fetched for
-0000ea50: 2074 6963 6b65 7220 7b7d 2062 6574 7765   ticker {} betwe
-0000ea60: 656e 2064 6174 6573 207b 7d20 2d3e 207b  en dates {} -> {
-0000ea70: 7d22 2e66 6f72 6d61 7428 7966 6364 2e69  }".format(yfcd.i
-0000ea80: 6e74 6572 7661 6c54 6f53 7472 696e 675b  ntervalToString[
-0000ea90: 7365 6c66 2e69 6e74 6572 7661 6c5d 2c20  self.interval], 
-0000eaa0: 7365 6c66 2e74 6963 6b65 722c 2072 7374  self.ticker, rst
-0000eab0: 6172 742c 2072 656e 6429 290a 2020 2020  art, rend)).    
-0000eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ead0: 2020 2020 7072 696e 7428 6622 5741 524e      print(f"WARN
-0000eae0: 494e 473a 207b 7365 6c66 2e74 6963 6b65  ING: {self.ticke
-0000eaf0: 727d 3a20 4e6f 207b 7966 6364 2e69 6e74  r}: No {yfcd.int
-0000eb00: 6572 7661 6c54 6f53 7472 696e 675b 7365  ervalToString[se
-0000eb10: 6c66 2e69 6e74 6572 7661 6c5d 7d2d 7072  lf.interval]}-pr
-0000eb20: 6963 6520 6461 7461 2066 6574 6368 6564  ice data fetched
-0000eb30: 2066 6f72 207b 7273 7461 7274 7d20 2d3e   for {rstart} ->
-0000eb40: 207b 7265 6e64 7d22 290a 2020 2020 2020   {rend}").      
-0000eb50: 2020 2020 2020 2020 2020 2020 2020 6832                h2
-0000eb60: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000eb70: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000eb80: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-0000eb90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000eba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ebb0: 6169 7365 0a0a 2020 2020 2020 2020 2020  aise..          
-0000ebc0: 2020 6966 2068 3220 6973 204e 6f6e 653a    if h2 is None:
-0000ebd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ebe0: 2023 2072 6169 7365 2045 7863 6570 7469   # raise Excepti
-0000ebf0: 6f6e 2822 5946 2072 6574 7572 6e65 6420  on("YF returned 
-0000ec00: 4e6f 6e65 2066 6f72 3a20 746b 723d 7b7d  None for: tkr={}
-0000ec10: 2c20 696e 7465 7276 616c 3d7b 7d2c 2073  , interval={}, s
-0000ec20: 7461 7274 3d7b 7d2c 2065 6e64 3d7b 7d22  tart={}, end={}"
-0000ec30: 2e66 6f72 6d61 7428 7365 6c66 2e74 6963  .format(self.tic
-0000ec40: 6b65 722c 2073 656c 662e 696e 7465 7276  ker, self.interv
-0000ec50: 616c 2c20 7273 7461 7274 2c20 7265 6e64  al, rstart, rend
-0000ec60: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0000ec70: 2020 2023 2072 6169 7365 2045 7863 6570     # raise Excep
-0000ec80: 7469 6f6e 2866 2279 6669 6e61 6e63 652e  tion(f"yfinance.
-0000ec90: 6869 7374 6f72 7928 2920 7265 7475 726e  history() return
-0000eca0: 6564 204e 6f6e 6520 287b 7365 6c66 2e74  ed None ({self.t
-0000ecb0: 6963 6b65 727d 207b 7365 6c66 2e69 7374  icker} {self.ist
-0000ecc0: 727d 207b 7273 7461 7274 7d2d 3e7b 7265  r} {rstart}->{re
-0000ecd0: 6e64 7d29 2229 0a20 2020 2020 2020 2020  nd})").         
-0000ece0: 2020 2020 2020 2072 6169 7365 2079 6663         raise yfc
-0000ecf0: 642e 4e6f 5072 6963 6544 6174 6149 6e52  d.NoPriceDataInR
-0000ed00: 616e 6765 4578 6365 7074 696f 6e28 7365  angeException(se
-0000ed10: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-0000ed20: 6973 7472 2c20 7273 7461 7274 2c20 7265  istr, rstart, re
-0000ed30: 6e64 290a 2020 2020 2020 2020 2020 2020  nd).            
-0000ed40: 2020 2020 2320 7261 6973 6520 4578 6365      # raise Exce
-0000ed50: 7074 696f 6e28 6622 7966 696e 616e 6365  ption(f"yfinance
-0000ed60: 2e68 6973 746f 7279 2829 2072 6574 7572  .history() retur
-0000ed70: 6e65 6420 4e6f 6e65 2028 7b73 656c 662e  ned None ({self.
-0000ed80: 7469 636b 6572 7d20 7b73 656c 662e 6973  ticker} {self.is
-0000ed90: 7472 7d20 7b66 6574 6368 5f73 7461 7274  tr} {fetch_start
-0000eda0: 7d2d 3e7b 6665 7463 685f 656e 647d 2922  }->{fetch_end})"
-0000edb0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0000edc0: 2045 6e73 7572 6520 6832 2069 7320 7370   Ensure h2 is sp
-0000edd0: 6c69 742d 6164 6a75 7374 6564 2e20 536f  lit-adjusted. So
-0000ede0: 6d65 7469 6d65 7320 5961 686f 6f20 7265  metimes Yahoo re
-0000edf0: 7475 726e 7320 756e 6164 6a75 7374 6564  turns unadjusted
-0000ee00: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-0000ee10: 2020 6832 203d 2073 656c 662e 5f72 6576    h2 = self._rev
-0000ee20: 6572 7365 5961 686f 6f41 646a 7573 7428  erseYahooAdjust(
-0000ee30: 6832 290a 2020 2020 2020 2020 2020 2020  h2).            
-0000ee40: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-0000ee50: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000ee60: 696e 7428 222d 2068 3220 6164 6a75 7374  int("- h2 adjust
-0000ee70: 6564 3a22 290a 2020 2020 2020 2020 2020  ed:").          
-0000ee80: 2020 2020 2020 7072 696e 7428 6832 5b5b        print(h2[[
-0000ee90: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
-0000eea0: 6e64 7322 2c20 2256 6f6c 756d 6522 2c20  nds", "Volume", 
-0000eeb0: 2243 5346 222c 2022 4344 4622 5d5d 290a  "CSF", "CDF"]]).
-0000eec0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000eed0: 6665 7463 685f 7374 6172 7420 213d 2072  fetch_start != r
-0000eee0: 7374 6172 743a 0a20 2020 2020 2020 2020  start:.         
-0000eef0: 2020 2020 2020 2068 3220 3d20 6832 5b68         h2 = h2[h
-0000ef00: 322e 696e 6465 7820 3e3d 2072 7374 6172  2.index >= rstar
-0000ef10: 745d 0a20 2020 2020 2020 2020 2020 2069  t].            i
-0000ef20: 6620 6665 7463 685f 656e 6420 213d 2072  f fetch_end != r
-0000ef30: 656e 643a 0a20 2020 2020 2020 2020 2020  end:.           
-0000ef40: 2020 2020 2068 3220 3d20 6832 5b68 322e       h2 = h2[h2.
-0000ef50: 696e 6465 7820 3c20 7265 6e64 2b73 656c  index < rend+sel
-0000ef60: 662e 6974 645d 0a0a 2020 2020 2020 2020  f.itd]..        
-0000ef70: 2020 2020 6966 2022 4164 6a20 436c 6f73      if "Adj Clos
-0000ef80: 6522 2069 6e20 6832 2e63 6f6c 756d 6e73  e" in h2.columns
-0000ef90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000efa0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-0000efb0: 6e28 2241 646a 2043 6c6f 7365 2069 6e20  n("Adj Close in 
-0000efc0: 6832 2229 0a20 2020 2020 2020 2020 2020  h2").           
-0000efd0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000efe0: 2020 2020 2020 7365 6c66 2e68 203d 2073        self.h = s
-0000eff0: 656c 662e 685b 7966 6375 2e6e 705f 6973  elf.h[yfcu.np_is
-0000f000: 696e 5f6f 7074 696d 6973 6564 2873 656c  in_optimised(sel
-0000f010: 662e 682e 696e 6465 782c 2068 322e 696e  f.h.index, h2.in
-0000f020: 6465 782c 2069 6e76 6572 743d 5472 7565  dex, invert=True
-0000f030: 295d 0a20 2020 2020 2020 2020 2020 2065  )].            e
-0000f040: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0000f050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f060: 2070 7269 6e74 2822 7365 6c66 2e68 2e73   print("self.h.s
-0000f070: 6861 7065 3a22 2c20 7365 6c66 2e68 2e73  hape:", self.h.s
-0000f080: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
-0000f090: 2020 2020 2020 7072 696e 7428 2268 322e        print("h2.
-0000f0a0: 7368 6170 653a 222c 2068 322e 7368 6170  shape:", h2.shap
-0000f0b0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0000f0c0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-0000f0d0: 2020 2020 2073 656c 662e 6820 3d20 7064       self.h = pd
-0000f0e0: 2e63 6f6e 6361 7428 5b73 656c 662e 682c  .concat([self.h,
-0000f0f0: 2068 325d 2c20 736f 7274 3d54 7275 6529   h2], sort=True)
-0000f100: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000f110: 662e 682e 696e 6465 7820 3d20 7064 2e74  f.h.index = pd.t
-0000f120: 6f5f 6461 7465 7469 6d65 2873 656c 662e  o_datetime(self.
-0000f130: 682e 696e 6465 782c 2075 7463 3d54 7275  h.index, utc=Tru
-0000f140: 6529 2e74 7a5f 636f 6e76 6572 7428 747a  e).tz_convert(tz
-0000f150: 5f65 7863 6861 6e67 6529 0a0a 2020 2020  _exchange)..    
-0000f160: 2020 2020 2020 2020 665f 6475 7073 203d          f_dups =
-0000f170: 2073 656c 662e 682e 696e 6465 782e 6475   self.h.index.du
-0000f180: 706c 6963 6174 6564 2829 0a20 2020 2020  plicated().     
-0000f190: 2020 2020 2020 2069 6620 665f 6475 7073         if f_dups
-0000f1a0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-0000f1b0: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0000f1c0: 6365 7074 696f 6e28 6622 7b73 656c 662e  ception(f"{self.
-0000f1d0: 7469 636b 6572 7d3a 2041 6464 696e 6720  ticker}: Adding 
-0000f1e0: 7261 6e67 6520 7b72 7374 6172 747d 2d3e  range {rstart}->
-0000f1f0: 7b72 656e 647d 2068 6173 2061 6464 6564  {rend} has added
-0000f200: 2064 7570 6c69 6361 7465 2074 696d 6570   duplicate timep
-0000f210: 6f69 6e74 7320 6861 7665 2062 6565 6e20  oints have been 
-0000f220: 6475 706c 6963 6174 6564 3a20 7b73 656c  duplicated: {sel
-0000f230: 662e 682e 696e 6465 785b 665f 6475 7073  f.h.index[f_dups
-0000f240: 5d7d 2229 0a0a 2020 2020 2020 2020 7365  ]}")..        se
-0000f250: 6c66 2e68 203d 2073 656c 662e 682e 736f  lf.h = self.h.so
-0000f260: 7274 5f69 6e64 6578 2829 0a20 2020 2020  rt_index().     
-0000f270: 2020 2073 656c 662e 5f75 7064 6174 6564     self._updated
-0000f280: 4361 6368 6564 5072 6963 6573 2873 656c  CachedPrices(sel
-0000f290: 662e 6829 0a0a 2020 2020 2020 2020 6c6f  f.h)..        lo
-0000f2a0: 675f 6d73 6720 3d20 225f 6665 7463 6841  g_msg = "_fetchA
-0000f2b0: 6e64 4164 6452 616e 6765 735f 7370 6172  ndAddRanges_spar
-0000f2c0: 7365 2829 2072 6574 7572 6e69 6e67 220a  se() returning".
-0000f2d0: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
-0000f2e0: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0000f2f0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000f300: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-0000f310: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
-0000f320: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
-0000f330: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000f340: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
-0000f350: 6465 6620 5f76 6572 6966 7943 6163 6865  def _verifyCache
-0000f360: 6450 7269 6365 7328 7365 6c66 2c20 7274  dPrices(self, rt
-0000f370: 6f6c 3d30 2e30 3030 312c 2076 6f6c 5f72  ol=0.0001, vol_r
-0000f380: 746f 6c3d 302e 3030 342c 2063 6f72 7265  tol=0.004, corre
-0000f390: 6374 3d46 616c 7365 2c20 6469 7363 6172  ct=False, discar
-0000f3a0: 645f 6f6c 643d 4661 6c73 652c 2071 7569  d_old=False, qui
-0000f3b0: 6574 3d54 7275 652c 2064 6562 7567 3d46  et=True, debug=F
-0000f3c0: 616c 7365 293a 0a20 2020 2020 2020 2079  alse):.        y
-0000f3d0: 6663 752e 5479 7065 4368 6563 6b42 6f6f  fcu.TypeCheckBoo
-0000f3e0: 6c28 636f 7272 6563 742c 2022 636f 7272  l(correct, "corr
-0000f3f0: 6563 7422 290a 2020 2020 2020 2020 7966  ect").        yf
-0000f400: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
-0000f410: 2864 6973 6361 7264 5f6f 6c64 2c20 2264  (discard_old, "d
-0000f420: 6973 6361 7264 5f6f 6c64 2229 0a20 2020  iscard_old").   
-0000f430: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-0000f440: 6563 6b42 6f6f 6c28 7175 6965 742c 2022  eckBool(quiet, "
-0000f450: 7175 6965 7422 290a 2020 2020 2020 2020  quiet").        
-0000f460: 7966 6375 2e54 7970 6543 6865 636b 426f  yfcu.TypeCheckBo
-0000f470: 6f6c 2864 6562 7567 2c20 2264 6562 7567  ol(debug, "debug
-0000f480: 2229 0a0a 2020 2020 2020 2020 6966 2073  ")..        if s
-0000f490: 656c 662e 6820 6973 204e 6f6e 6520 6f72  elf.h is None or
-0000f4a0: 2073 656c 662e 682e 656d 7074 793a 0a20   self.h.empty:. 
-0000f4b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f4c0: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-0000f4d0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-0000f4e0: 2020 2020 2020 7175 6965 7420 3d20 4661        quiet = Fa
-0000f4f0: 6c73 650a 0a20 2020 2020 2020 2079 6663  lse..        yfc
-0000f500: 6c2e 5472 6163 6545 6e74 6572 2866 2250  l.TraceEnter(f"P
-0000f510: 4d3a 3a5f 7665 7269 6679 4361 6368 6564  M::_verifyCached
-0000f520: 5072 6963 6573 2d7b 7365 6c66 2e69 7374  Prices-{self.ist
-0000f530: 727d 2863 6f72 7265 6374 3d7b 636f 7272  r}(correct={corr
-0000f540: 6563 747d 2c20 6465 6275 673d 7b64 6562  ect}, debug={deb
-0000f550: 7567 7d29 2229 0a0a 2020 2020 2020 2020  ug})")..        
-0000f560: 2320 4e65 7720 636f 6465 3a20 686f 7065  # New code: hope
-0000f570: 6675 6c6c 7920 7468 6973 2077 696c 6c20  fully this will 
-0000f580: 636f 7272 6563 7420 6261 6420 4344 4620  correct bad CDF 
-0000f590: 696e 2031 776b 2065 7463 0a20 2020 2020  in 1wk etc.     
-0000f5a0: 2020 2073 656c 662e 5f61 7070 6c79 4e65     self._applyNe
-0000f5b0: 7745 7665 6e74 7328 290a 0a20 2020 2020  wEvents()..     
-0000f5c0: 2020 2068 203d 2073 656c 662e 682e 636f     h = self.h.co
-0000f5d0: 7079 2829 2020 2320 776f 726b 696e 6720  py()  # working 
-0000f5e0: 636f 7079 2066 6f72 2063 6f6d 7061 7269  copy for compari
-0000f5f0: 736f 6e20 7769 7468 2059 460a 2020 2020  son with YF.    
-0000f600: 2020 2020 685f 6d6f 6469 6669 6564 203d      h_modified =
-0000f610: 2046 616c 7365 0a20 2020 2020 2020 2068   False.        h
-0000f620: 5f6e 6577 203d 2073 656c 662e 682e 636f  _new = self.h.co
-0000f630: 7079 2829 2020 2320 636f 7079 2066 6f72  py()  # copy for
-0000f640: 2073 746f 7269 6e67 2063 6861 6e67 6573   storing changes
-0000f650: 0a20 2020 2020 2020 2023 204b 6565 7020  .        # Keep 
-0000f660: 7472 6163 6b20 6f66 2070 726f 626c 656d  track of problem
-0000f670: 733a 0a20 2020 2020 2020 2066 5f64 6966  s:.        f_dif
-0000f680: 665f 616c 6c20 3d20 7064 2e53 6572 6965  f_all = pd.Serie
-0000f690: 7328 6e70 2e66 756c 6c28 682e 7368 6170  s(np.full(h.shap
-0000f6a0: 655b 305d 2c20 4661 6c73 6529 2c20 682e  e[0], False), h.
-0000f6b0: 696e 6465 782c 206e 616d 653d 224e 6f6e  index, name="Non
-0000f6c0: 6522 290a 2020 2020 2020 2020 6e20 3d20  e").        n = 
-0000f6d0: 682e 7368 6170 655b 305d 0a0a 2020 2020  h.shape[0]..    
-0000f6e0: 2020 2020 2320 4967 6e6f 7265 206e 6f6e      # Ignore non
-0000f6f0: 2d66 696e 616c 2064 6174 6120 6265 6361  -final data beca
-0000f700: 7573 6520 7769 6c6c 2064 6966 6665 7220  use will differ 
-0000f710: 746f 2059 6168 6f6f 0a20 2020 2020 2020  to Yahoo.       
-0000f720: 2068 5f6c 6173 7452 6f77 203d 2068 2e69   h_lastRow = h.i
-0000f730: 6c6f 635b 2d31 5d0a 0a20 2020 2020 2020  loc[-1]..       
-0000f740: 2023 2041 7070 6c79 2073 746f 636b 2d73   # Apply stock-s
-0000f750: 706c 6974 2061 646a 7573 746d 656e 7420  plit adjustment 
-0000f760: 746f 206d 6174 6368 2059 460a 2020 2020  to match YF.    
-0000f770: 2020 2020 666f 7220 6320 696e 205b 224f      for c in ["O
-0000f780: 7065 6e22 2c20 2243 6c6f 7365 222c 2022  pen", "Close", "
-0000f790: 4c6f 7722 2c20 2248 6967 6822 2c20 2244  Low", "High", "D
-0000f7a0: 6976 6964 656e 6473 225d 3a0a 2020 2020  ividends"]:.    
-0000f7b0: 2020 2020 2020 2020 685b 635d 203d 2068          h[c] = h
-0000f7c0: 5b63 5d2e 746f 5f6e 756d 7079 2829 202a  [c].to_numpy() *
-0000f7d0: 2068 5b22 4353 4622 5d2e 746f 5f6e 756d   h["CSF"].to_num
-0000f7e0: 7079 2829 0a20 2020 2020 2020 2068 5b22  py().        h["
-0000f7f0: 566f 6c75 6d65 225d 203d 2028 685b 2256  Volume"] = (h["V
-0000f800: 6f6c 756d 6522 5d2e 746f 5f6e 756d 7079  olume"].to_numpy
-0000f810: 2829 202f 2068 5b22 4353 4622 5d2e 746f  () / h["CSF"].to
-0000f820: 5f6e 756d 7079 2829 292e 726f 756e 6428  _numpy()).round(
-0000f830: 292e 6173 7479 7065 2827 696e 7427 290a  ).astype('int').
-0000f840: 0a20 2020 2020 2020 2074 645f 3164 203d  .        td_1d =
-0000f850: 2070 642e 5469 6d65 6465 6c74 6128 2231   pd.Timedelta("1
-0000f860: 4422 290a 2020 2020 2020 2020 6474 5f6e  D").        dt_n
-0000f870: 6f77 203d 2070 642e 5469 6d65 7374 616d  ow = pd.Timestam
-0000f880: 702e 7574 636e 6f77 2829 2e74 7a5f 636f  p.utcnow().tz_co
-0000f890: 6e76 6572 7428 5a6f 6e65 496e 666f 2822  nvert(ZoneInfo("
-0000f8a0: 5554 4322 2929 0a0a 2020 2020 2020 2020  UTC"))..        
-0000f8b0: 6465 6620 5f61 6767 7265 6761 7465 5f79  def _aggregate_y
-0000f8c0: 6664 665f 6461 696c 7928 6466 293a 0a20  fdf_daily(df):. 
-0000f8d0: 2020 2020 2020 2020 2020 2064 6632 203d             df2 =
-0000f8e0: 2064 662e 636f 7079 2829 0a20 2020 2020   df.copy().     
-0000f8f0: 2020 2020 2020 2064 6632 5b22 5f64 6174         df2["_dat
-0000f900: 6522 5d20 3d20 6466 322e 696e 6465 782e  e"] = df2.index.
-0000f910: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
-0000f920: 2064 6632 2e6c 6f63 5b64 6632 5b22 5374   df2.loc[df2["St
-0000f930: 6f63 6b20 5370 6c69 7473 225d 203d 3d20  ock Splits"] == 
-0000f940: 302c 2022 5374 6f63 6b20 5370 6c69 7473  0, "Stock Splits
-0000f950: 225d 203d 2031 0a20 2020 2020 2020 2020  "] = 1.         
-0000f960: 2020 2069 6620 2243 4446 2220 696e 2064     if "CDF" in d
-0000f970: 662e 636f 6c75 6d6e 733a 0a20 2020 2020  f.columns:.     
-0000f980: 2020 2020 2020 2020 2020 2064 6632 203d             df2 =
-0000f990: 2064 6632 2e67 726f 7570 6279 2822 5f64   df2.groupby("_d
-0000f9a0: 6174 6522 292e 6167 6728 0a20 2020 2020  ate").agg(.     
-0000f9b0: 2020 2020 2020 2020 2020 2020 2020 204f                 O
-0000f9c0: 7065 6e3d 2822 4f70 656e 222c 2022 6669  pen=("Open", "fi
-0000f9d0: 7273 7422 292c 0a20 2020 2020 2020 2020  rst"),.         
-0000f9e0: 2020 2020 2020 2020 2020 2043 6c6f 7365             Close
-0000f9f0: 3d28 2243 6c6f 7365 222c 2022 6c61 7374  =("Close", "last
-0000fa00: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000fa10: 2020 2020 2020 2020 4c6f 773d 2822 4c6f          Low=("Lo
-0000fa20: 7722 2c20 226d 696e 2229 2c0a 2020 2020  w", "min"),.    
-0000fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa40: 4869 6768 3d28 2248 6967 6822 2c20 226d  High=("High", "m
-0000fa50: 6178 2229 2c0a 2020 2020 2020 2020 2020  ax"),.          
-0000fa60: 2020 2020 2020 2020 2020 566f 6c75 6d65            Volume
-0000fa70: 3d28 2256 6f6c 756d 6522 2c20 2273 756d  =("Volume", "sum
-0000fa80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000fa90: 2020 2020 2020 2020 4469 7669 6465 6e64          Dividend
-0000faa0: 733d 2822 4469 7669 6465 6e64 7322 2c20  s=("Dividends", 
-0000fab0: 2273 756d 2229 2c0a 2020 2020 2020 2020  "sum"),.        
-0000fac0: 2020 2020 2020 2020 2020 2020 5374 6f63              Stoc
-0000fad0: 6b53 706c 6974 733d 2822 5374 6f63 6b20  kSplits=("Stock 
-0000fae0: 5370 6c69 7473 222c 2022 7072 6f64 2229  Splits", "prod")
-0000faf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fb00: 2020 2020 2020 4344 463d 2822 4344 4622        CDF=("CDF"
-0000fb10: 2c20 2270 726f 6422 292c 0a20 2020 2020  , "prod"),.     
-0000fb20: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-0000fb30: 5346 3d28 2243 5346 222c 2022 7072 6f64  SF=("CSF", "prod
-0000fb40: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000fb50: 2020 2020 2020 2020 4665 7463 6844 6174          FetchDat
-0000fb60: 653d 2822 4665 7463 6844 6174 6522 2c20  e=("FetchDate", 
-0000fb70: 2266 6972 7374 2229 292e 7265 6e61 6d65  "first")).rename
-0000fb80: 2863 6f6c 756d 6e73 3d7b 2253 746f 636b  (columns={"Stock
-0000fb90: 5370 6c69 7473 223a 2022 5374 6f63 6b20  Splits": "Stock 
-0000fba0: 5370 6c69 7473 227d 290a 2020 2020 2020  Splits"}).      
-0000fbb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000fbc0: 2020 2020 2020 2020 2020 2020 6466 3220              df2 
-0000fbd0: 3d20 6466 322e 6772 6f75 7062 7928 225f  = df2.groupby("_
-0000fbe0: 6461 7465 2229 2e61 6767 280a 2020 2020  date").agg(.    
-0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc00: 4f70 656e 3d28 224f 7065 6e22 2c20 2266  Open=("Open", "f
-0000fc10: 6972 7374 2229 2c0a 2020 2020 2020 2020  irst"),.        
-0000fc20: 2020 2020 2020 2020 2020 2020 436c 6f73              Clos
-0000fc30: 653d 2822 436c 6f73 6522 2c20 226c 6173  e=("Close", "las
-0000fc40: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
-0000fc50: 2020 2020 2020 2020 2041 646a 436c 6f73           AdjClos
-0000fc60: 653d 2822 4164 6a20 436c 6f73 6522 2c20  e=("Adj Close", 
-0000fc70: 226c 6173 7422 292c 0a20 2020 2020 2020  "last"),.       
-0000fc80: 2020 2020 2020 2020 2020 2020 204c 6f77               Low
-0000fc90: 3d28 224c 6f77 222c 2022 6d69 6e22 292c  =("Low", "min"),
-0000fca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fcb0: 2020 2020 2048 6967 683d 2822 4869 6768       High=("High
-0000fcc0: 222c 2022 6d61 7822 292c 0a20 2020 2020  ", "max"),.     
-0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2056                 V
-0000fce0: 6f6c 756d 653d 2822 566f 6c75 6d65 222c  olume=("Volume",
-0000fcf0: 2022 7375 6d22 292c 0a20 2020 2020 2020   "sum"),.       
-0000fd00: 2020 2020 2020 2020 2020 2020 2044 6976               Div
-0000fd10: 6964 656e 6473 3d28 2244 6976 6964 656e  idends=("Dividen
-0000fd20: 6473 222c 2022 7375 6d22 292c 0a20 2020  ds", "sum"),.   
-0000fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd40: 2053 746f 636b 5370 6c69 7473 3d28 2253   StockSplits=("S
-0000fd50: 746f 636b 2053 706c 6974 7322 2c20 2270  tock Splits", "p
-0000fd60: 726f 6422 2929 2e72 656e 616d 6528 636f  rod")).rename(co
-0000fd70: 6c75 6d6e 733d 7b22 5374 6f63 6b53 706c  lumns={"StockSpl
-0000fd80: 6974 7322 3a20 2253 746f 636b 2053 706c  its": "Stock Spl
-0000fd90: 6974 7322 2c20 2241 646a 436c 6f73 6522  its", "AdjClose"
-0000fda0: 3a20 2241 646a 2043 6c6f 7365 227d 290a  : "Adj Close"}).
-0000fdb0: 2020 2020 2020 2020 2020 2020 6466 322e              df2.
-0000fdc0: 6c6f 635b 6466 325b 2253 746f 636b 2053  loc[df2["Stock S
-0000fdd0: 706c 6974 7322 5d20 3d3d 2031 2c20 2253  plits"] == 1, "S
-0000fde0: 746f 636b 2053 706c 6974 7322 5d20 3d20  tock Splits"] = 
-0000fdf0: 300a 2020 2020 2020 2020 2020 2020 6466  0.            df
-0000fe00: 322e 696e 6465 782e 6e61 6d65 203d 2064  2.index.name = d
-0000fe10: 662e 696e 6465 782e 6e61 6d65 0a20 2020  f.index.name.   
-0000fe20: 2020 2020 2020 2020 2064 6632 2e69 6e64           df2.ind
-0000fe30: 6578 203d 2070 642e 746f 5f64 6174 6574  ex = pd.to_datet
-0000fe40: 696d 6528 6466 322e 696e 6465 7829 2e74  ime(df2.index).t
-0000fe50: 7a5f 6c6f 6361 6c69 7a65 2864 662e 696e  z_localize(df.in
-0000fe60: 6465 782e 747a 290a 2020 2020 2020 2020  dex.tz).        
-0000fe70: 2020 2020 7265 7475 726e 2064 6632 0a0a      return df2..
-0000fe80: 2020 2020 2020 2020 2320 466f 7220 696e          # For in
-0000fe90: 7472 6164 6179 2064 6174 6120 6f6c 6465  traday data olde
-0000fea0: 7220 7468 616e 2059 6168 6f6f 206c 696d  r than Yahoo lim
-0000feb0: 6974 2c20 636f 6d70 6172 6520 6167 6772  it, compare aggr
-0000fec0: 6567 6174 6564 2061 6761 696e 7374 2031  egated against 1
-0000fed0: 640a 2020 2020 2020 2020 6966 2073 656c  d.        if sel
-0000fee0: 662e 696e 7472 6164 6179 3a0a 2020 2020  f.intraday:.    
-0000fef0: 2020 2020 2020 2020 6474 5f6e 6f77 5f6c          dt_now_l
-0000ff00: 6f63 616c 203d 2064 745f 6e6f 772e 747a  ocal = dt_now.tz
-0000ff10: 5f63 6f6e 7665 7274 2873 656c 662e 747a  _convert(self.tz
-0000ff20: 4e61 6d65 290a 2020 2020 2020 2020 2020  Name).          
-0000ff30: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
-0000ff40: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-0000ff50: 7661 6c2e 486f 7572 7331 3a0a 2020 2020  val.Hours1:.    
-0000ff60: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-0000ff70: 6c6f 6f6b 6261 636b 5f64 6179 7320 3d20  lookback_days = 
-0000ff80: 3336 352a 320a 2020 2020 2020 2020 2020  365*2.          
-0000ff90: 2020 656c 6966 2073 656c 662e 696e 7465    elif self.inte
-0000ffa0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0000ffb0: 6572 7661 6c2e 4d69 6e73 313a 0a20 2020  erval.Mins1:.   
-0000ffc0: 2020 2020 2020 2020 2020 2020 2023 206d               # m
-0000ffd0: 6178 5f6c 6f6f 6b62 6163 6b5f 6461 7973  ax_lookback_days
-0000ffe0: 203d 2037 0a20 2020 2020 2020 2020 2020   = 7.           
-0000fff0: 2020 2020 206d 6178 5f6c 6f6f 6b62 6163       max_lookbac
-00010000: 6b5f 6461 7973 203d 2033 300a 2020 2020  k_days = 30.    
-00010010: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00010020: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00010030: 785f 6c6f 6f6b 6261 636b 5f64 6179 7320  x_lookback_days 
-00010040: 3d20 3630 0a20 2020 2020 2020 2020 2020  = 60.           
-00010050: 206d 6178 5f6c 6f6f 6b62 6163 6b20 3d20   max_lookback = 
-00010060: 7469 6d65 6465 6c74 6128 6461 7973 3d6d  timedelta(days=m
-00010070: 6178 5f6c 6f6f 6b62 6163 6b5f 6461 7973  ax_lookback_days
-00010080: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
-00010090: 785f 6c6f 6f6b 6261 636b 202d 3d20 7469  x_lookback -= ti
-000100a0: 6d65 6465 6c74 6128 6d69 6e75 7465 733d  medelta(minutes=
-000100b0: 3529 2020 2320 616c 6c6f 7720 7469 6d65  5)  # allow time
-000100c0: 2066 6f72 2073 6572 7665 7220 7072 6f63   for server proc
-000100d0: 6573 7369 6e67 0a20 2020 2020 2020 2020  essing.         
-000100e0: 2020 2066 6574 6368 5f73 7461 7274 5f6d     fetch_start_m
-000100f0: 696e 203d 2064 745f 6e6f 775f 6c6f 6361  in = dt_now_loca
-00010100: 6c20 2d20 6d61 785f 6c6f 6f6b 6261 636b  l - max_lookback
-00010110: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00010120: 7365 6c66 2e69 6e74 7261 6461 793a 0a20  self.intraday:. 
-00010130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010140: 6574 6368 5f73 7461 7274 5f6d 696e 203d  etch_start_min =
-00010150: 2066 6574 6368 5f73 7461 7274 5f6d 696e   fetch_start_min
-00010160: 2e63 6569 6c28 2231 4422 290a 2020 2020  .ceil("1D").    
-00010170: 2020 2020 2020 2020 6966 2068 2e69 6e64          if h.ind
-00010180: 6578 5b30 5d20 3c20 6665 7463 685f 7374  ex[0] < fetch_st
-00010190: 6172 745f 6d69 6e3a 0a20 2020 2020 2020  art_min:.       
-000101a0: 2020 2020 2020 2020 2023 2068 5f6f 6c64           # h_old
-000101b0: 203d 2068 2e6c 6f63 5b3a 6665 7463 685f   = h.loc[:fetch_
-000101c0: 7374 6172 745f 6d69 6e2d 7469 6d65 6465  start_min-timede
-000101d0: 6c74 6128 7365 636f 6e64 733d 3129 5d0a  lta(seconds=1)].
+0000b3e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000b3f0: 7365 6c66 2e68 2e69 6c6f 635b 6964 782d  self.h.iloc[idx-
+0000b400: 323a 6964 782b 335d 5b5b 2243 6c6f 7365  2:idx+3][["Close
+0000b410: 222c 2022 4665 7463 6844 6174 6522 5d5d  ", "FetchDate"]]
+0000b420: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b440: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+0000b450: 6e28 2227 636c 6f73 655f 6461 795f 6265  n("'close_day_be
+0000b460: 666f 7265 2720 6973 204e 614e 2229 0a20  fore' is NaN"). 
+0000b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b480: 2020 2064 6976 735f 6466 2e6c 6f63 5b64     divs_df.loc[d
+0000b490: 742c 2022 436c 6f73 6520 6461 7920 6265  t, "Close day be
+0000b4a0: 666f 7265 225d 203d 2063 6c6f 7365 5f64  fore"] = close_d
+0000b4b0: 6179 5f62 6566 6f72 650a 2020 2020 2020  ay_before.      
+0000b4c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000b4d0: 4465 2d73 706c 6974 2064 6976 3a0a 2020  De-split div:.  
+0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4f0: 2020 6966 206e 6f74 2064 6976 735f 6466    if not divs_df
+0000b500: 2e6c 6f63 5b64 742c 2027 4465 7370 6c69  .loc[dt, 'Despli
+0000b510: 7474 6564 3f27 5d3a 0a20 2020 2020 2020  tted?']:.       
+0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b530: 2073 706c 6974 735f 706f 7374 203d 2073   splits_post = s
+0000b540: 656c 662e 6d61 6e61 6765 722e 4765 7448  elf.manager.GetH
+0000b550: 6973 746f 7279 2827 4576 656e 7473 2729  istory('Events')
+0000b560: 2e47 6574 5370 6c69 7473 2864 742e 6461  .GetSplits(dt.da
+0000b570: 7465 2829 290a 2020 2020 2020 2020 2020  te()).          
+0000b580: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b590: 2073 706c 6974 735f 706f 7374 2069 7320   splits_post is 
+0000b5a0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5c0: 2020 2020 2020 706f 7374 5f63 7366 203d        post_csf =
+0000b5d0: 2031 2e30 2f73 706c 6974 735f 706f 7374   1.0/splits_post
+0000b5e0: 5b22 5374 6f63 6b20 5370 6c69 7473 225d  ["Stock Splits"]
+0000b5f0: 2e70 726f 6428 290a 2020 2020 2020 2020  .prod().        
+0000b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b610: 2020 2020 6469 7673 5f64 662e 6c6f 635b      divs_df.loc[
+0000b620: 6474 2c20 2744 6976 6964 656e 6473 275d  dt, 'Dividends']
+0000b630: 202f 3d20 706f 7374 5f63 7366 0a20 2020   /= post_csf.   
+0000b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b650: 2020 2020 2064 6976 735f 6466 2e6c 6f63       divs_df.loc
+0000b660: 5b64 742c 2027 4465 7370 6c69 7474 6564  [dt, 'Desplitted
+0000b670: 3f27 5d20 3d20 5472 7565 0a20 2020 2020  ?'] = True.     
+0000b680: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000b690: 6d61 6e61 6765 722e 4765 7448 6973 746f  manager.GetHisto
+0000b6a0: 7279 2822 4576 656e 7473 2229 2e55 7064  ry("Events").Upd
+0000b6b0: 6174 6544 6976 6964 656e 6473 2864 6976  ateDividends(div
+0000b6c0: 735f 6466 290a 2020 2020 2020 2020 2020  s_df).          
+0000b6d0: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
+0000b6e0: 794e 6577 4576 656e 7473 2829 0a20 2020  yNewEvents().   
+0000b6f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b700: 6361 6368 6564 5f6e 6577 5f64 6976 7320  cached_new_divs 
+0000b710: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0000b720: 6e6f 7420 6361 6368 6564 5f6e 6577 5f64  not cached_new_d
+0000b730: 6976 735f 6c6f 636b 6564 3a0a 2020 2020  ivs_locked:.    
+0000b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b750: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+0000b760: 2272 656c 6561 7369 6e67 206c 6f63 6b20  "releasing lock 
+0000b770: 6f6e 2063 6163 6865 645f 6e65 775f 6469  on cached_new_di
+0000b780: 7673 2229 0a20 2020 2020 2020 2020 2020  vs").           
+0000b790: 2020 2020 2020 2020 2079 6663 6d2e 5374           yfcm.St
+0000b7a0: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
+0000b7b0: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
+0000b7c0: 6469 7673 222c 204e 6f6e 6529 2020 2320  divs", None)  # 
+0000b7d0: 6465 6c65 7465 0a0a 2020 2020 2020 2020  delete..        
+0000b7e0: 6966 2022 4164 6a20 436c 6f73 6522 2069  if "Adj Close" i
+0000b7f0: 6e20 7365 6c66 2e68 2e63 6f6c 756d 6e73  n self.h.columns
+0000b800: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000b810: 6973 6520 4578 6365 7074 696f 6e28 2241  ise Exception("A
+0000b820: 646a 2043 6c6f 7365 2069 6e20 7365 6c66  dj Close in self
+0000b830: 2e68 2229 0a0a 2020 2020 2020 2020 6966  .h")..        if
+0000b840: 2028 7374 6172 7420 6973 206e 6f74 204e   (start is not N
+0000b850: 6f6e 6529 2061 6e64 2028 656e 6420 6973  one) and (end is
+0000b860: 206e 6f74 204e 6f6e 6529 3a0a 2020 2020   not None):.    
+0000b870: 2020 2020 2020 2020 685f 636f 7079 203d          h_copy =
+0000b880: 2073 656c 662e 682e 6c6f 635b 7374 6172   self.h.loc[star
+0000b890: 745f 6474 3a65 6e64 5f64 742d 7469 6d65  t_dt:end_dt-time
+0000b8a0: 6465 6c74 6128 6d69 6c6c 6973 6563 6f6e  delta(millisecon
+0000b8b0: 6473 3d31 295d 2e63 6f70 7928 290a 2020  ds=1)].copy().  
+0000b8c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000b8d0: 2020 2020 2020 2020 685f 636f 7079 203d          h_copy =
+0000b8e0: 2073 656c 662e 682e 636f 7079 2829 0a0a   self.h.copy()..
+0000b8f0: 2020 2020 2020 2020 6966 2061 646a 7573          if adjus
+0000b900: 745f 7370 6c69 7473 3a0a 2020 2020 2020  t_splits:.      
+0000b910: 2020 2020 2020 666f 7220 6320 696e 205b        for c in [
+0000b920: 224f 7065 6e22 2c20 2248 6967 6822 2c20  "Open", "High", 
+0000b930: 224c 6f77 222c 2022 436c 6f73 6522 2c20  "Low", "Close", 
+0000b940: 2244 6976 6964 656e 6473 225d 3a0a 2020  "Dividends"]:.  
+0000b950: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+0000b960: 636f 7079 5b63 5d20 2a3d 2068 5f63 6f70  copy[c] *= h_cop
+0000b970: 795b 2243 5346 225d 0a20 2020 2020 2020  y["CSF"].       
+0000b980: 2020 2020 2068 5f63 6f70 795b 2256 6f6c       h_copy["Vol
+0000b990: 756d 6522 5d20 3d20 2868 5f63 6f70 795b  ume"] = (h_copy[
+0000b9a0: 2256 6f6c 756d 6522 5d2f 685f 636f 7079  "Volume"]/h_copy
+0000b9b0: 5b22 4353 4622 5d29 2e72 6f75 6e64 2830  ["CSF"]).round(0
+0000b9c0: 292e 6173 7479 7065 2827 696e 7427 290a  ).astype('int').
+0000b9d0: 2020 2020 2020 2020 2020 2020 685f 636f              h_co
+0000b9e0: 7079 203d 2068 5f63 6f70 792e 6472 6f70  py = h_copy.drop
+0000b9f0: 2822 4353 4622 2c20 6178 6973 3d31 290a  ("CSF", axis=1).
+0000ba00: 2020 2020 2020 2020 6966 2061 646a 7573          if adjus
+0000ba10: 745f 6469 7673 3a0a 2020 2020 2020 2020  t_divs:.        
+0000ba20: 2020 2020 666f 7220 6320 696e 205b 224f      for c in ["O
+0000ba30: 7065 6e22 2c20 2248 6967 6822 2c20 224c  pen", "High", "L
+0000ba40: 6f77 222c 2022 436c 6f73 6522 5d3a 0a20  ow", "Close"]:. 
+0000ba50: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000ba60: 5f63 6f70 795b 635d 202a 3d20 685f 636f  _copy[c] *= h_co
+0000ba70: 7079 5b22 4344 4622 5d0a 2020 2020 2020  py["CDF"].      
+0000ba80: 2020 2020 2020 685f 636f 7079 203d 2068        h_copy = h
+0000ba90: 5f63 6f70 792e 6472 6f70 2822 4344 4622  _copy.drop("CDF"
+0000baa0: 2c20 6178 6973 3d31 290a 0a20 2020 2020  , axis=1)..     
+0000bab0: 2020 206c 6f67 5f6d 7367 203d 2066 2250     log_msg = f"P
+0000bac0: 7269 6365 4869 7374 6f72 792d 7b73 656c  riceHistory-{sel
+0000bad0: 662e 6973 7472 7d2e 6765 7428 2920 7265  f.istr}.get() re
+0000bae0: 7475 726e 696e 6722 0a20 2020 2020 2020  turning".       
+0000baf0: 2069 6620 685f 636f 7079 2e65 6d70 7479   if h_copy.empty
+0000bb00: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+0000bb10: 675f 6d73 6720 2b3d 2022 2065 6d70 7479  g_msg += " empty
+0000bb20: 2064 6622 0a20 2020 2020 2020 2065 6c73   df".        els
+0000bb30: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+0000bb40: 6f67 5f6d 7367 202b 3d20 6622 2044 4620  og_msg += f" DF 
+0000bb50: 7b68 5f63 6f70 792e 696e 6465 785b 305d  {h_copy.index[0]
+0000bb60: 7d20 2d3e 207b 685f 636f 7079 2e69 6e64  } -> {h_copy.ind
+0000bb70: 6578 5b2d 315d 7d22 0a20 2020 2020 2020  ex[-1]}".       
+0000bb80: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+0000bb90: 6e67 456e 6162 6c65 6428 293a 0a20 2020  ngEnabled():.   
+0000bba0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
+0000bbb0: 6163 6545 7869 7428 6c6f 675f 6d73 6729  aceExit(log_msg)
+0000bbc0: 0a20 2020 2020 2020 2065 6c69 6620 6465  .        elif de
+0000bbd0: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
+0000bbe0: 2020 2020 2070 7269 6e74 286c 6f67 5f6d       print(log_m
+0000bbf0: 7367 290a 0a20 2020 2020 2020 2072 6574  sg)..        ret
+0000bc00: 7572 6e20 685f 636f 7079 0a0a 2020 2020  urn h_copy..    
+0000bc10: 6465 6620 5f66 6574 6368 416e 6441 6464  def _fetchAndAdd
+0000bc20: 5261 6e67 6573 5f63 6f6e 7469 6775 6f75  Ranges_contiguou
+0000bc30: 7328 7365 6c66 2c20 7261 6e67 6573 5f74  s(self, ranges_t
+0000bc40: 6f5f 6665 7463 682c 2070 7265 706f 7374  o_fetch, prepost
+0000bc50: 2c20 6465 6275 672c 2071 7569 6574 3d46  , debug, quiet=F
+0000bc60: 616c 7365 293a 0a20 2020 2020 2020 2079  alse):.        y
+0000bc70: 6663 752e 5479 7065 4368 6563 6b49 7465  fcu.TypeCheckIte
+0000bc80: 7261 626c 6528 7261 6e67 6573 5f74 6f5f  rable(ranges_to_
+0000bc90: 6665 7463 682c 2022 7261 6e67 6573 5f74  fetch, "ranges_t
+0000bca0: 6f5f 6665 7463 6822 290a 2020 2020 2020  o_fetch").      
+0000bcb0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+0000bcc0: 426f 6f6c 2870 7265 706f 7374 2c20 2270  Bool(prepost, "p
+0000bcd0: 7265 706f 7374 2229 0a20 2020 2020 2020  repost").       
+0000bce0: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
+0000bcf0: 6f6f 6c28 6465 6275 672c 2022 6465 6275  ool(debug, "debu
+0000bd00: 6722 290a 2020 2020 2020 2020 7966 6375  g").        yfcu
+0000bd10: 2e54 7970 6543 6865 636b 426f 6f6c 2871  .TypeCheckBool(q
+0000bd20: 7569 6574 2c20 2271 7569 6574 2229 0a0a  uiet, "quiet")..
+0000bd30: 2020 2020 2020 2020 2320 4665 7463 6820          # Fetch 
+0000bd40: 6561 6368 2072 616e 6765 2c20 6170 7065  each range, appe
+0000bd50: 6e64 696e 672f 7072 6570 656e 6469 6e67  nding/prepending
+0000bd60: 2074 6f20 6361 6368 6564 2064 6174 610a   to cached data.
+0000bd70: 2020 2020 2020 2020 6966 2028 7261 6e67          if (rang
+0000bd80: 6573 5f74 6f5f 6665 7463 6820 6973 204e  es_to_fetch is N
+0000bd90: 6f6e 6529 206f 7220 6c65 6e28 7261 6e67  one) or len(rang
+0000bda0: 6573 5f74 6f5f 6665 7463 6829 203d 3d20  es_to_fetch) == 
+0000bdb0: 303a 0a20 2020 2020 2020 2020 2020 2023  0:.            #
+0000bdc0: 2072 6574 7572 6e20 680a 2020 2020 2020   return h.      
+0000bdd0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0000bde0: 2020 2020 2020 6465 6275 675f 7966 6320        debug_yfc 
+0000bdf0: 3d20 7365 6c66 2e5f 6465 6275 670a 2020  = self._debug.  
+0000be00: 2020 2020 2020 2320 6465 6275 675f 7966        # debug_yf
+0000be10: 6320 3d20 5472 7565 0a0a 2020 2020 2020  c = True..      
+0000be20: 2020 6c6f 675f 6d73 6720 3d20 6622 5f66    log_msg = f"_f
+0000be30: 6574 6368 416e 6441 6464 5261 6e67 6573  etchAndAddRanges
+0000be40: 5f63 6f6e 7469 6775 6f75 732d 7b73 656c  _contiguous-{sel
+0000be50: 662e 6973 7472 7d28 6e3d 7b6c 656e 2872  f.istr}(n={len(r
+0000be60: 616e 6765 735f 746f 5f66 6574 6368 297d  anges_to_fetch)}
+0000be70: 2070 7265 706f 7374 3d7b 7072 6570 6f73   prepost={prepos
+0000be80: 747d 2929 220a 2020 2020 2020 2020 6966  t}))".        if
+0000be90: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
+0000bea0: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
+0000beb0: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+0000bec0: 456e 7465 7228 6c6f 675f 6d73 6729 0a20  Enter(log_msg). 
+0000bed0: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
+0000bee0: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
+0000bef0: 2020 2070 7269 6e74 286c 6f67 5f6d 7367     print(log_msg
+0000bf00: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0000bf10: 696e 7428 222d 2072 616e 6765 735f 746f  int("- ranges_to
+0000bf20: 5f66 6574 6368 3a22 290a 2020 2020 2020  _fetch:").      
+0000bf30: 2020 2020 2020 7070 7269 6e74 2872 616e        pprint(ran
+0000bf40: 6765 735f 746f 5f66 6574 6368 290a 0a20  ges_to_fetch).. 
+0000bf50: 2020 2020 2020 2074 7a5f 6578 6368 616e         tz_exchan
+0000bf60: 6765 203d 205a 6f6e 6549 6e66 6f28 7365  ge = ZoneInfo(se
+0000bf70: 6c66 2e74 7a4e 616d 6529 0a20 2020 2020  lf.tzName).     
+0000bf80: 2020 2079 6663 742e 5365 7445 7863 6861     yfct.SetExcha
+0000bf90: 6e67 6554 7a4e 616d 6528 7365 6c66 2e65  ngeTzName(self.e
+0000bfa0: 7863 6861 6e67 652c 2073 656c 662e 747a  xchange, self.tz
+0000bfb0: 4e61 6d65 290a 0a20 2020 2020 2020 2069  Name)..        i
+0000bfc0: 6620 7365 6c66 2e68 2069 7320 4e6f 6e65  f self.h is None
+0000bfd0: 206f 7220 7365 6c66 2e68 2e65 6d70 7479   or self.h.empty
+0000bfe0: 3a0a 2020 2020 2020 2020 2020 2020 685f  :.            h_
+0000bff0: 6669 7273 745f 6474 203d 204e 6f6e 6520  first_dt = None 
+0000c000: 3b20 685f 6c61 7374 5f64 7420 3d20 4e6f  ; h_last_dt = No
+0000c010: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
+0000c020: 0a20 2020 2020 2020 2020 2020 2068 5f66  .            h_f
+0000c030: 6972 7374 5f64 7420 3d20 7365 6c66 2e68  irst_dt = self.h
+0000c040: 2e69 6e64 6578 5b30 5d2e 746f 5f70 7964  .index[0].to_pyd
+0000c050: 6174 6574 696d 6528 290a 2020 2020 2020  atetime().      
+0000c060: 2020 2020 2020 685f 6c61 7374 5f64 7420        h_last_dt 
+0000c070: 3d20 7365 6c66 2e68 2e69 6e64 6578 5b2d  = self.h.index[-
+0000c080: 315d 2e74 6f5f 7079 6461 7465 7469 6d65  1].to_pydatetime
+0000c090: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0000c0a0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0000c0b0: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
+0000c0c0: 5b30 5d5b 305d 2c20 6461 7465 7469 6d65  [0][0], datetime
+0000c0d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c0e0: 2020 2068 5f66 6972 7374 5f64 7420 3d20     h_first_dt = 
+0000c0f0: 685f 6669 7273 745f 6474 2e61 7374 696d  h_first_dt.astim
+0000c100: 657a 6f6e 6528 747a 5f65 7863 6861 6e67  ezone(tz_exchang
+0000c110: 6529 2e64 6174 6528 290a 2020 2020 2020  e).date().      
+0000c120: 2020 2020 2020 2020 2020 685f 6c61 7374            h_last
+0000c130: 5f64 7420 3d20 685f 6c61 7374 5f64 742e  _dt = h_last_dt.
+0000c140: 6173 7469 6d65 7a6f 6e65 2874 7a5f 6578  astimezone(tz_ex
+0000c150: 6368 616e 6765 292e 6461 7465 2829 0a20  change).date(). 
+0000c160: 2020 2020 2020 2074 645f 3164 203d 2074         td_1d = t
+0000c170: 696d 6564 656c 7461 2864 6179 733d 3129  imedelta(days=1)
+0000c180: 0a0a 2020 2020 2020 2020 2320 4265 6361  ..        # Beca
+0000c190: 7573 6520 6461 7461 2073 686f 756c 6420  use data should 
+0000c1a0: 6265 2063 6f6e 7469 6775 6f75 732c 2074  be contiguous, t
+0000c1b0: 6865 6e20 7261 6e67 6573 2073 686f 756c  hen ranges shoul
+0000c1c0: 6420 6d65 6574 2073 6f6d 6520 636f 6e64  d meet some cond
+0000c1d0: 6974 696f 6e73 3a0a 2020 2020 2020 2020  itions:.        
+0000c1e0: 6966 206c 656e 2872 616e 6765 735f 746f  if len(ranges_to
+0000c1f0: 5f66 6574 6368 2920 3e20 323a 0a20 2020  _fetch) > 2:.   
+0000c200: 2020 2020 2020 2020 2070 7072 696e 7428           pprint(
+0000c210: 7261 6e67 6573 5f74 6f5f 6665 7463 6829  ranges_to_fetch)
+0000c220: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000c230: 7365 2045 7863 6570 7469 6f6e 2822 466f  se Exception("Fo
+0000c240: 7220 636f 6e74 6967 756f 7573 2064 6174  r contiguous dat
+0000c250: 6120 6765 6e65 7261 7465 6420 7b7d 3e32  a generated {}>2
+0000c260: 2072 616e 6765 7322 2e66 6f72 6d61 7428   ranges".format(
+0000c270: 6c65 6e28 7261 6e67 6573 5f74 6f5f 6665  len(ranges_to_fe
+0000c280: 7463 6829 2929 0a20 2020 2020 2020 2069  tch))).        i
+0000c290: 6620 7365 6c66 2e68 2e65 6d70 7479 2061  f self.h.empty a
+0000c2a0: 6e64 206c 656e 2872 616e 6765 735f 746f  nd len(ranges_to
+0000c2b0: 5f66 6574 6368 2920 3e20 313a 0a20 2020  _fetch) > 1:.   
+0000c2c0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+0000c2d0: 7863 6570 7469 6f6e 2822 466f 7220 636f  xception("For co
+0000c2e0: 6e74 6967 756f 7573 2064 6174 6120 6765  ntiguous data ge
+0000c2f0: 6e65 7261 7465 6420 7b7d 2072 616e 6765  nerated {} range
+0000c300: 732c 2062 7574 2068 2069 7320 656d 7074  s, but h is empt
+0000c310: 7922 2e66 6f72 6d61 7428 6c65 6e28 7261  y".format(len(ra
+0000c320: 6e67 6573 5f74 6f5f 6665 7463 6829 2929  nges_to_fetch)))
+0000c330: 0a20 2020 2020 2020 2072 616e 6765 5f70  .        range_p
+0000c340: 7265 203d 204e 6f6e 6520 3b20 7261 6e67  re = None ; rang
+0000c350: 655f 706f 7374 203d 204e 6f6e 650a 2020  e_post = None.  
+0000c360: 2020 2020 2020 6966 2073 656c 662e 682e        if self.h.
+0000c370: 656d 7074 7920 616e 6420 6c65 6e28 7261  empty and len(ra
+0000c380: 6e67 6573 5f74 6f5f 6665 7463 6829 203d  nges_to_fetch) =
+0000c390: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+0000c3a0: 2072 616e 6765 5f70 7265 203d 2072 616e   range_pre = ran
+0000c3b0: 6765 735f 746f 5f66 6574 6368 5b30 5d0a  ges_to_fetch[0].
+0000c3c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000c3d0: 2020 2020 2020 2020 2020 6e5f 7072 6520            n_pre 
+0000c3e0: 3d20 3020 3b20 6e5f 706f 7374 203d 2030  = 0 ; n_post = 0
+0000c3f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000c400: 2072 2069 6e20 7261 6e67 6573 5f74 6f5f   r in ranges_to_
+0000c410: 6665 7463 683a 0a20 2020 2020 2020 2020  fetch:.         
+0000c420: 2020 2020 2020 2069 6620 725b 305d 203e         if r[0] >
+0000c430: 2068 5f6c 6173 745f 6474 3a0a 2020 2020   h_last_dt:.    
+0000c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c450: 6e5f 706f 7374 202b 3d20 310a 2020 2020  n_post += 1.    
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c470: 7261 6e67 655f 706f 7374 203d 2072 0a20  range_post = r. 
+0000c480: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000c490: 6c69 6620 725b 305d 203c 2068 5f66 6972  lif r[0] < h_fir
+0000c4a0: 7374 5f64 743a 0a20 2020 2020 2020 2020  st_dt:.         
+0000c4b0: 2020 2020 2020 2020 2020 206e 5f70 7265             n_pre
+0000c4c0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0000c4d0: 2020 2020 2020 2020 2020 7261 6e67 655f            range_
+0000c4e0: 7072 6520 3d20 720a 2020 2020 2020 2020  pre = r.        
+0000c4f0: 2020 2020 6966 206e 5f70 7265 203e 2031      if n_pre > 1
+0000c500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c510: 2020 7070 7269 6e74 2872 616e 6765 735f    pprint(ranges_
+0000c520: 746f 5f66 6574 6368 290a 2020 2020 2020  to_fetch).      
+0000c530: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000c540: 4578 6365 7074 696f 6e28 2246 6f72 2063  Exception("For c
+0000c550: 6f6e 7469 6775 6f75 7320 6461 7461 2067  ontiguous data g
+0000c560: 656e 6572 6174 6564 207b 7d3e 3120 7261  enerated {}>1 ra
+0000c570: 6e67 6573 2062 6566 6f72 6520 685f 6669  nges before h_fi
+0000c580: 7273 745f 6474 222e 666f 726d 6174 286e  rst_dt".format(n
+0000c590: 5f70 7265 2929 0a20 2020 2020 2020 2020  _pre)).         
+0000c5a0: 2020 2069 6620 6e5f 706f 7374 203e 2031     if n_post > 1
+0000c5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c5c0: 2020 7070 7269 6e74 2872 616e 6765 735f    pprint(ranges_
+0000c5d0: 746f 5f66 6574 6368 290a 2020 2020 2020  to_fetch).      
+0000c5e0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000c5f0: 4578 6365 7074 696f 6e28 2246 6f72 2063  Exception("For c
+0000c600: 6f6e 7469 6775 6f75 7320 6461 7461 2067  ontiguous data g
+0000c610: 656e 6572 6174 6564 207b 7d3e 3120 7261  enerated {}>1 ra
+0000c620: 6e67 6573 2061 6674 6572 2068 5f6c 6173  nges after h_las
+0000c630: 745f 6474 222e 666f 726d 6174 286e 5f70  t_dt".format(n_p
+0000c640: 6f73 7429 290a 0a20 2020 2020 2020 2023  ost))..        #
+0000c650: 2046 6574 6368 2072 616e 6765 730a 2020   Fetch ranges.  
+0000c660: 2020 2020 2020 6832 5f70 7265 203d 204e        h2_pre = N
+0000c670: 6f6e 6520 3b20 6832 5f70 6f73 7420 3d20  one ; h2_post = 
+0000c680: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
+0000c690: 7261 6e67 655f 7072 6520 6973 206e 6f74  range_pre is not
+0000c6a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000c6b0: 2020 2072 203d 2072 616e 6765 5f70 7265     r = range_pre
+0000c6c0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+0000c6d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c6e0: 2020 6832 5f70 7265 203d 2073 656c 662e    h2_pre = self.
+0000c6f0: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
+0000c700: 725b 305d 2c20 725b 315d 2c20 7072 6570  r[0], r[1], prep
+0000c710: 6f73 742c 2064 6562 7567 290a 2020 2020  ost, debug).    
+0000c720: 2020 2020 2020 2020 6578 6365 7074 2079          except y
+0000c730: 6663 642e 4e6f 5072 6963 6544 6174 6149  fcd.NoPriceDataI
+0000c740: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
+0000c750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c760: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
+0000c770: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
+0000c780: 616c 2e44 6179 7331 2061 6e64 2072 5b31  al.Days1 and r[1
+0000c790: 5d20 2d20 725b 305d 203d 3d20 7464 5f31  ] - r[0] == td_1
+0000c7a0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+0000c7b0: 2020 2020 2020 2023 2049 6620 6f6e 6c79         # If only
+0000c7c0: 2074 7279 696e 6720 746f 2066 6574 6368   trying to fetch
+0000c7d0: 2031 2064 6179 206f 6620 3164 2064 6174   1 day of 1d dat
+0000c7e0: 612c 2074 6865 6e20 7072 696e 7420 7761  a, then print wa
+0000c7f0: 726e 696e 6720 696e 7374 6561 6420 6f66  rning instead of
+0000c800: 2065 7863 6570 7469 6f6e 2e0a 2020 2020   exception..    
+0000c810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c820: 2320 436f 756c 6420 6164 6420 6164 6469  # Could add addi
+0000c830: 7469 6f6e 616c 2063 6f6e 6469 7469 6f6e  tional condition
+0000c840: 206f 6620 6469 7669 6465 6e64 2070 7265   of dividend pre
+0000c850: 7669 6f75 7320 6461 7920 2873 6565 6d73  vious day (seems
+0000c860: 2074 6f20 6d65 7373 2075 7020 7461 626c   to mess up tabl
+0000c870: 6529 2e0a 2020 2020 2020 2020 2020 2020  e)..            
+0000c880: 2020 2020 2020 2020 6966 206e 6f74 2071          if not q
+0000c890: 7569 6574 3a0a 2020 2020 2020 2020 2020  uiet:.          
+0000c8a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000c8b0: 696e 7428 6622 5741 524e 494e 473a 207b  int(f"WARNING: {
+0000c8c0: 7365 6c66 2e74 6963 6b65 727d 3a20 4e6f  self.ticker}: No
+0000c8d0: 207b 7966 6364 2e69 6e74 6572 7661 6c54   {yfcd.intervalT
+0000c8e0: 6f53 7472 696e 675b 7365 6c66 2e69 6e74  oString[self.int
+0000c8f0: 6572 7661 6c5d 7d2d 7072 6963 6520 6461  erval]}-price da
+0000c900: 7461 2066 6574 6368 6564 2066 6f72 207b  ta fetched for {
+0000c910: 725b 305d 7d20 2d3e 207b 725b 315d 7d22  r[0]} -> {r[1]}"
+0000c920: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c930: 2020 2020 2020 6832 5f70 7265 203d 204e        h2_pre = N
+0000c940: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000c950: 2020 2020 656c 6966 2028 7261 6e67 655f      elif (range_
+0000c960: 706f 7374 2069 7320 4e6f 6e65 2920 616e  post is None) an
+0000c970: 6420 2872 5b31 5d2d 725b 305d 203c 2074  d (r[1]-r[0] < t
+0000c980: 645f 3164 2a37 2920 616e 6420 2872 5b31  d_1d*7) and (r[1
+0000c990: 5d2d 725b 305d 203e 2074 645f 3164 2a33  ]-r[0] > td_1d*3
+0000c9a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c9b0: 2020 2020 2020 2023 2053 6d61 6c6c 2064         # Small d
+0000c9c0: 6174 6520 7261 6e67 652c 2070 6f74 656e  ate range, poten
+0000c9d0: 7469 616c 6c79 2074 7279 696e 6720 746f  tially trying to
+0000c9e0: 2066 6574 6368 2062 6566 6f72 6520 6c69   fetch before li
+0000c9f0: 7374 696e 6720 6461 7461 0a20 2020 2020  sting data.     
+0000ca00: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000ca10: 325f 7072 6520 3d20 4e6f 6e65 0a20 2020  2_pre = None.   
+0000ca20: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000ca30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000ca40: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+0000ca50: 2020 2020 2020 6966 2072 616e 6765 5f70        if range_p
+0000ca60: 6f73 7420 6973 206e 6f74 204e 6f6e 653a  ost is not None:
+0000ca70: 0a20 2020 2020 2020 2020 2020 2072 203d  .            r =
+0000ca80: 2072 616e 6765 5f70 6f73 740a 2020 2020   range_post.    
+0000ca90: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000caa0: 2020 2020 2020 2020 2020 2020 2068 325f               h2_
+0000cab0: 706f 7374 203d 2073 656c 662e 5f66 6574  post = self._fet
+0000cac0: 6368 5966 4869 7374 6f72 7928 725b 305d  chYfHistory(r[0]
+0000cad0: 2c20 725b 315d 2c20 7072 6570 6f73 742c  , r[1], prepost,
+0000cae0: 2064 6562 7567 290a 2020 2020 2020 2020   debug).        
+0000caf0: 2020 2020 6578 6365 7074 2079 6663 642e      except yfcd.
+0000cb00: 4e6f 5072 6963 6544 6174 6149 6e52 616e  NoPriceDataInRan
+0000cb10: 6765 4578 6365 7074 696f 6e3a 0a20 2020  geException:.   
+0000cb20: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000cb30: 6620 6f6e 6c79 2074 7279 696e 6720 746f  f only trying to
+0000cb40: 2066 6574 6368 2031 2064 6179 206f 6620   fetch 1 day of 
+0000cb50: 3164 2064 6174 612c 2074 6865 6e20 7072  1d data, then pr
+0000cb60: 696e 7420 7761 726e 696e 6720 696e 7374  int warning inst
+0000cb70: 6561 6420 6f66 2065 7863 6570 7469 6f6e  ead of exception
+0000cb80: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000cb90: 2020 2320 436f 756c 6420 6164 6420 6164    # Could add ad
+0000cba0: 6469 7469 6f6e 616c 2063 6f6e 6469 7469  ditional conditi
+0000cbb0: 6f6e 206f 6620 6469 7669 6465 6e64 2070  on of dividend p
+0000cbc0: 7265 7669 6f75 7320 6461 7920 2873 6565  revious day (see
+0000cbd0: 6d73 2074 6f20 6d65 7373 2075 7020 7461  ms to mess up ta
+0000cbe0: 626c 6529 2e0a 2020 2020 2020 2020 2020  ble)..          
+0000cbf0: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+0000cc00: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0000cc10: 6e74 6572 7661 6c2e 4461 7973 3120 616e  nterval.Days1 an
+0000cc20: 6420 725b 315d 202d 2072 5b30 5d20 3d3d  d r[1] - r[0] ==
+0000cc30: 2074 645f 3164 3a0a 2020 2020 2020 2020   td_1d:.        
+0000cc40: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000cc50: 6f74 2071 7569 6574 3a0a 2020 2020 2020  ot quiet:.      
+0000cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc70: 2020 7072 696e 7428 6622 5741 524e 494e    print(f"WARNIN
+0000cc80: 473a 207b 7365 6c66 2e74 6963 6b65 727d  G: {self.ticker}
+0000cc90: 3a20 4e6f 207b 7966 6364 2e69 6e74 6572  : No {yfcd.inter
+0000cca0: 7661 6c54 6f53 7472 696e 675b 7365 6c66  valToString[self
+0000ccb0: 2e69 6e74 6572 7661 6c5d 7d2d 7072 6963  .interval]}-pric
+0000ccc0: 6520 6461 7461 2066 6574 6368 6564 2066  e data fetched f
+0000ccd0: 6f72 207b 725b 305d 7d20 2d3e 207b 725b  or {r[0]} -> {r[
+0000cce0: 315d 7d22 290a 2020 2020 2020 2020 2020  1]}").          
+0000ccf0: 2020 2020 2020 2020 2020 6832 5f70 6f73            h2_pos
+0000cd00: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+0000cd10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd30: 2020 2072 6169 7365 0a0a 2020 2020 2020     raise..      
+0000cd40: 2020 6c69 7374 696e 675f 6461 7465 203d    listing_date =
+0000cd50: 2079 6663 6d2e 5265 6164 4361 6368 6544   yfcm.ReadCacheD
+0000cd60: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
+0000cd70: 2c20 226c 6973 7469 6e67 5f64 6174 6522  , "listing_date"
+0000cd80: 290a 2020 2020 2020 2020 6966 206c 6973  ).        if lis
+0000cd90: 7469 6e67 5f64 6174 6520 6973 204e 6f6e  ting_date is Non
+0000cda0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+0000cdb0: 6973 7469 6e67 5f64 6174 6520 3d20 7365  isting_date = se
+0000cdc0: 6c66 2e64 6174 2e68 6973 746f 7279 5f6d  lf.dat.history_m
+0000cdd0: 6574 6164 6174 615b 2266 6972 7374 5472  etadata["firstTr
+0000cde0: 6164 6544 6174 6522 5d0a 2020 2020 2020  adeDate"].      
+0000cdf0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0000ce00: 6e63 6528 6c69 7374 696e 675f 6461 7465  nce(listing_date
+0000ce10: 2c20 696e 7429 3a0a 2020 2020 2020 2020  , int):.        
+0000ce20: 2020 2020 2020 2020 6c69 7374 696e 675f          listing_
+0000ce30: 6461 7465 203d 2070 642e 746f 5f64 6174  date = pd.to_dat
+0000ce40: 6574 696d 6528 6c69 7374 696e 675f 6461  etime(listing_da
+0000ce50: 7465 2c20 756e 6974 3d27 7327 2c20 7574  te, unit='s', ut
+0000ce60: 633d 5472 7565 292e 747a 5f63 6f6e 7665  c=True).tz_conve
+0000ce70: 7274 2874 7a5f 6578 6368 616e 6765 290a  rt(tz_exchange).
+0000ce80: 2020 2020 2020 2020 2020 2020 7966 636d              yfcm
+0000ce90: 2e53 746f 7265 4361 6368 6544 6174 756d  .StoreCacheDatum
+0000cea0: 2873 656c 662e 7469 636b 6572 2c20 226c  (self.ticker, "l
+0000ceb0: 6973 7469 6e67 5f64 6174 6522 2c20 6c69  isting_date", li
+0000cec0: 7374 696e 675f 6461 7465 2e64 6174 6528  sting_date.date(
+0000ced0: 2929 0a0a 2020 2020 2020 2020 6966 2068  ))..        if h
+0000cee0: 325f 706f 7374 2069 7320 6e6f 7420 4e6f  2_post is not No
+0000cef0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000cf00: 2320 4465 2d61 646a 7573 7420 7468 6520  # De-adjust the 
+0000cf10: 6e65 7720 6461 7461 2c20 616e 6420 6261  new data, and ba
+0000cf20: 636b 706f 7274 2061 6e79 206e 6577 2065  ckport any new e
+0000cf30: 7665 6e74 7320 696e 2063 6163 6865 6420  vents in cached 
+0000cf40: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0000cf50: 2023 204e 6f74 653a 2059 6168 6f6f 2061   # Note: Yahoo a
+0000cf60: 6c77 6179 7320 7265 7475 726e 7320 7370  lways returns sp
+0000cf70: 6c69 742d 6164 6a75 7374 6564 2070 7269  lit-adjusted pri
+0000cf80: 6365 2c20 736f 2072 6576 6572 7365 2069  ce, so reverse i
+0000cf90: 740a 0a20 2020 2020 2020 2020 2020 2023  t..            #
+0000cfa0: 2053 696d 706c 6520 6170 7065 6e64 2074   Simple append t
+0000cfb0: 6f20 626f 7474 6f6d 206f 6620 7461 626c  o bottom of tabl
+0000cfc0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+0000cfd0: 3129 2061 646a 7573 7420 6832 5f70 6f73  1) adjust h2_pos
+0000cfe0: 740a 2020 2020 2020 2020 2020 2020 6832  t.            h2
+0000cff0: 5f70 6f73 7420 3d20 7365 6c66 2e5f 7265  _post = self._re
+0000d000: 7665 7273 6559 6168 6f6f 4164 6a75 7374  verseYahooAdjust
+0000d010: 2868 325f 706f 7374 290a 2020 2020 2020  (h2_post).      
+0000d020: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+0000d030: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+0000d040: 2020 2020 7072 696e 7428 222d 2068 325f      print("- h2_
+0000d050: 706f 7374 3a22 290a 2020 2020 2020 2020  post:").        
+0000d060: 2020 2020 2020 2020 7072 696e 7428 6832          print(h2
+0000d070: 5f70 6f73 7429 0a0a 2020 2020 2020 2020  _post)..        
+0000d080: 2020 2020 2320 544f 444f 3a20 5072 6f62      # TODO: Prob
+0000d090: 6c65 6d3a 2064 6976 6964 656e 6473 206e  lem: dividends n
+0000d0a0: 6565 6420 636f 7272 6563 7420 636c 6f73  eed correct clos
+0000d0b0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+0000d0c0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
+0000d0d0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0000d0e0: 4461 7973 313a 0a20 2020 2020 2020 2020  Days1:.         
+0000d0f0: 2020 2020 2020 2068 325f 706f 7374 5f73         h2_post_s
+0000d100: 706c 6974 7320 3d20 6832 5f70 6f73 745b  plits = h2_post[
+0000d110: 6832 5f70 6f73 745b 2253 746f 636b 2053  h2_post["Stock S
+0000d120: 706c 6974 7322 5d20 213d 2030 5d5b 5b22  plits"] != 0][["
+0000d130: 5374 6f63 6b20 5370 6c69 7473 222c 2022  Stock Splits", "
+0000d140: 4665 7463 6844 6174 6522 5d5d 2e63 6f70  FetchDate"]].cop
+0000d150: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0000d160: 2020 2020 6966 206e 6f74 2068 325f 706f      if not h2_po
+0000d170: 7374 5f73 706c 6974 732e 656d 7074 793a  st_splits.empty:
+0000d180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d190: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
+0000d1a0: 722e 4765 7448 6973 746f 7279 2822 4576  r.GetHistory("Ev
+0000d1b0: 656e 7473 2229 2e55 7064 6174 6553 706c  ents").UpdateSpl
+0000d1c0: 6974 7328 6832 5f70 6f73 745f 7370 6c69  its(h2_post_spli
+0000d1d0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+0000d1e0: 2020 2020 2320 5570 6461 7465 3a20 6d6f      # Update: mo
+0000d1f0: 7669 6e67 2055 7064 6174 6544 6976 6964  ving UpdateDivid
+0000d200: 656e 6473 2829 2074 6f20 6166 7465 7220  ends() to after 
+0000d210: 7265 7061 6972 0a0a 2020 2020 2020 2020  repair..        
+0000d220: 2020 2020 2320 4261 636b 706f 7274 206e      # Backport n
+0000d230: 6577 2065 7665 6e74 7320 6163 726f 7373  ew events across
+0000d240: 2065 6e74 6972 6520 6820 7461 626c 650a   entire h table.
+0000d250: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000d260: 2e5f 6170 706c 794e 6577 4576 656e 7473  ._applyNewEvents
+0000d270: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+0000d280: 6966 2068 325f 706f 7374 2069 7320 6e6f  if h2_post is no
+0000d290: 7420 4e6f 6e65 2061 6e64 206e 6f74 2069  t None and not i
+0000d2a0: 7369 6e73 7461 6e63 6528 6832 5f70 6f73  sinstance(h2_pos
+0000d2b0: 742e 696e 6465 782c 2070 642e 4461 7465  t.index, pd.Date
+0000d2c0: 7469 6d65 496e 6465 7829 3a0a 2020 2020  timeIndex):.    
+0000d2d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000d2e0: 6520 4578 6365 7074 696f 6e28 2268 325f  e Exception("h2_
+0000d2f0: 706f 7374 2e69 6e64 6578 206e 6f74 2044  post.index not D
+0000d300: 6174 6574 696d 6549 6e64 6578 2229 0a0a  atetimeIndex")..
+0000d310: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+0000d320: 4164 6a20 436c 6f73 6522 2069 6e20 6832  Adj Close" in h2
+0000d330: 5f70 6f73 742e 636f 6c75 6d6e 733a 0a20  _post.columns:. 
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000d350: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+0000d360: 4164 6a20 436c 6f73 6520 696e 2068 325f  Adj Close in h2_
+0000d370: 706f 7374 2229 0a20 2020 2020 2020 2020  post").         
+0000d380: 2020 2073 656c 662e 6820 3d20 7064 2e63     self.h = pd.c
+0000d390: 6f6e 6361 7428 5b73 656c 662e 682c 2068  oncat([self.h, h
+0000d3a0: 325f 706f 7374 5b73 656c 662e 682e 636f  2_post[self.h.co
+0000d3b0: 6c75 6d6e 735d 5d29 0a20 2020 2020 2020  lumns]]).       
+0000d3c0: 2020 2020 2073 656c 662e 682e 696e 6465       self.h.inde
+0000d3d0: 7820 3d20 7064 2e74 6f5f 6461 7465 7469  x = pd.to_dateti
+0000d3e0: 6d65 2873 656c 662e 682e 696e 6465 782c  me(self.h.index,
+0000d3f0: 2075 7463 3d54 7275 6529 2e74 7a5f 636f   utc=True).tz_co
+0000d400: 6e76 6572 7428 747a 5f65 7863 6861 6e67  nvert(tz_exchang
+0000d410: 6529 0a0a 2020 2020 2020 2020 6966 2068  e)..        if h
+0000d420: 325f 7072 6520 6973 206e 6f74 204e 6f6e  2_pre is not Non
+0000d430: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0000d440: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
+0000d450: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000d460: 6e74 2822 2d20 7072 6570 656e 6469 6e67  nt("- prepending
+0000d470: 206e 6577 2064 6174 6122 290a 2020 2020   new data").    
+0000d480: 2020 2020 2020 2020 2320 5369 6d70 6c65          # Simple
+0000d490: 2070 7265 7065 6e64 2074 6f20 746f 7020   prepend to top 
+0000d4a0: 6f66 2074 6162 6c65 0a0a 2020 2020 2020  of table..      
+0000d4b0: 2020 2020 2020 6832 5f70 7265 203d 2073        h2_pre = s
+0000d4c0: 656c 662e 5f72 6576 6572 7365 5961 686f  elf._reverseYaho
+0000d4d0: 6f41 646a 7573 7428 6832 5f70 7265 290a  oAdjust(h2_pre).
+0000d4e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000d4f0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+0000d500: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+0000d510: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
+0000d520: 2020 2020 2020 6832 5f70 7265 5f73 706c        h2_pre_spl
+0000d530: 6974 7320 3d20 6832 5f70 7265 5b68 325f  its = h2_pre[h2_
+0000d540: 7072 655b 2253 746f 636b 2053 706c 6974  pre["Stock Split
+0000d550: 7322 5d20 213d 2030 5d5b 5b22 5374 6f63  s"] != 0][["Stoc
+0000d560: 6b20 5370 6c69 7473 222c 2022 4665 7463  k Splits", "Fetc
+0000d570: 6844 6174 6522 5d5d 2e63 6f70 7928 290a  hDate"]].copy().
+0000d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d590: 6966 206e 6f74 2068 325f 7072 655f 7370  if not h2_pre_sp
+0000d5a0: 6c69 7473 2e65 6d70 7479 3a0a 2020 2020  lits.empty:.    
+0000d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5c0: 7365 6c66 2e6d 616e 6167 6572 2e47 6574  self.manager.Get
+0000d5d0: 4869 7374 6f72 7928 2245 7665 6e74 7322  History("Events"
+0000d5e0: 292e 5570 6461 7465 5370 6c69 7473 2868  ).UpdateSplits(h
+0000d5f0: 325f 7072 655f 7370 6c69 7473 290a 0a20  2_pre_splits).. 
+0000d600: 2020 2020 2020 2020 2020 2023 2068 325f             # h2_
+0000d610: 7072 6520 3d20 6832 5f70 7265 2e64 726f  pre = h2_pre.dro
+0000d620: 7028 5b22 4469 7669 6465 6e64 7322 2c20  p(["Dividends", 
+0000d630: 2253 746f 636b 2053 706c 6974 7322 5d2c  "Stock Splits"],
+0000d640: 2061 7869 733d 3129 0a20 2020 2020 2020   axis=1).       
+0000d650: 2020 2020 2069 6620 2241 646a 2043 6c6f       if "Adj Clo
+0000d660: 7365 2220 696e 2068 325f 7072 652e 636f  se" in h2_pre.co
+0000d670: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+0000d680: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+0000d690: 6570 7469 6f6e 2822 4164 6a20 436c 6f73  eption("Adj Clos
+0000d6a0: 6520 696e 2068 325f 7072 6522 290a 2020  e in h2_pre").  
+0000d6b0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+0000d6c0: 203d 2070 642e 636f 6e63 6174 285b 7365   = pd.concat([se
+0000d6d0: 6c66 2e68 2c20 6832 5f70 7265 5b73 656c  lf.h, h2_pre[sel
+0000d6e0: 662e 682e 636f 6c75 6d6e 735d 5d29 0a20  f.h.columns]]). 
+0000d6f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d700: 682e 696e 6465 7820 3d20 7064 2e74 6f5f  h.index = pd.to_
+0000d710: 6461 7465 7469 6d65 2873 656c 662e 682e  datetime(self.h.
+0000d720: 696e 6465 782c 2075 7463 3d54 7275 6529  index, utc=True)
+0000d730: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
+0000d740: 7863 6861 6e67 6529 0a0a 2020 2020 2020  xchange)..      
+0000d750: 2020 7365 6c66 2e68 203d 2073 656c 662e    self.h = self.
+0000d760: 682e 736f 7274 5f69 6e64 6578 2829 0a20  h.sort_index(). 
+0000d770: 2020 2020 2020 2073 656c 662e 5f75 7064         self._upd
+0000d780: 6174 6564 4361 6368 6564 5072 6963 6573  atedCachedPrices
+0000d790: 2873 656c 662e 6829 0a0a 2020 2020 2020  (self.h)..      
+0000d7a0: 2020 6c6f 675f 6d73 6720 3d20 225f 6665    log_msg = "_fe
+0000d7b0: 7463 6841 6e64 4164 6452 616e 6765 735f  tchAndAddRanges_
+0000d7c0: 636f 6e74 6967 756f 7573 2829 2072 6574  contiguous() ret
+0000d7d0: 7572 6e69 6e67 220a 2020 2020 2020 2020  urning".        
+0000d7e0: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+0000d7f0: 6745 6e61 626c 6564 2829 3a0a 2020 2020  gEnabled():.    
+0000d800: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+0000d810: 6365 4578 6974 286c 6f67 5f6d 7367 290a  ceExit(log_msg).
+0000d820: 2020 2020 2020 2020 656c 6966 2064 6562          elif deb
+0000d830: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+0000d840: 2020 2020 7072 696e 7428 222d 2068 3a22      print("- h:"
+0000d850: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0000d860: 696e 7428 7365 6c66 2e68 290a 2020 2020  int(self.h).    
+0000d870: 2020 2020 2020 2020 7072 696e 7428 6c6f          print(lo
+0000d880: 675f 6d73 6729 0a0a 2020 2020 6465 6620  g_msg)..    def 
+0000d890: 5f66 6574 6368 416e 6441 6464 5261 6e67  _fetchAndAddRang
+0000d8a0: 6573 5f73 7061 7273 6528 7365 6c66 2c20  es_sparse(self, 
+0000d8b0: 7261 6e67 6573 5f74 6f5f 6665 7463 682c  ranges_to_fetch,
+0000d8c0: 2070 7265 706f 7374 2c20 6465 6275 672c   prepost, debug,
+0000d8d0: 2071 7569 6574 3d46 616c 7365 293a 0a20   quiet=False):. 
+0000d8e0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+0000d8f0: 4368 6563 6b49 7465 7261 626c 6528 7261  CheckIterable(ra
+0000d900: 6e67 6573 5f74 6f5f 6665 7463 682c 2022  nges_to_fetch, "
+0000d910: 7261 6e67 6573 5f74 6f5f 6665 7463 6822  ranges_to_fetch"
+0000d920: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+0000d930: 7970 6543 6865 636b 426f 6f6c 2870 7265  ypeCheckBool(pre
+0000d940: 706f 7374 2c20 2270 7265 706f 7374 2229  post, "prepost")
+0000d950: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
+0000d960: 7065 4368 6563 6b42 6f6f 6c28 6465 6275  peCheckBool(debu
+0000d970: 672c 2022 6465 6275 6722 290a 2020 2020  g, "debug").    
+0000d980: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
+0000d990: 636b 426f 6f6c 2871 7569 6574 2c20 2271  ckBool(quiet, "q
+0000d9a0: 7569 6574 2229 0a0a 2020 2020 2020 2020  uiet")..        
+0000d9b0: 2320 4665 7463 6820 6561 6368 2072 616e  # Fetch each ran
+0000d9c0: 6765 2c20 6275 7420 6361 6e20 6265 2063  ge, but can be c
+0000d9d0: 6172 656c 6573 7320 7265 6761 7264 696e  areless regardin
+0000d9e0: 6720 6465 2d61 646a 7573 7420 6265 6361  g de-adjust beca
+0000d9f0: 7573 650a 2020 2020 2020 2020 2320 6765  use.        # ge
+0000da00: 7474 696e 6720 6576 656e 7473 2066 726f  tting events fro
+0000da10: 6d20 7468 6520 6361 7265 6675 6c6c 792d  m the carefully-
+0000da20: 6d61 6e61 6765 6420 6461 696c 7920 6461  managed daily da
+0000da30: 7461 0a20 2020 2020 2020 2069 6620 2872  ta.        if (r
+0000da40: 616e 6765 735f 746f 5f66 6574 6368 2069  anges_to_fetch i
+0000da50: 7320 4e6f 6e65 2920 6f72 206c 656e 2872  s None) or len(r
+0000da60: 616e 6765 735f 746f 5f66 6574 6368 2920  anges_to_fetch) 
+0000da70: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0000da80: 2020 2320 7265 7475 726e 2068 0a20 2020    # return h.   
+0000da90: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000daa0: 0a20 2020 2020 2020 2064 6562 7567 5f79  .        debug_y
+0000dab0: 6663 203d 2073 656c 662e 5f64 6562 7567  fc = self._debug
+0000dac0: 0a20 2020 2020 2020 2023 2064 6562 7567  .        # debug
+0000dad0: 5f79 6663 203d 2054 7275 650a 0a20 2020  _yfc = True..   
+0000dae0: 2020 2020 206c 6f67 5f6d 7367 203d 2066       log_msg = f
+0000daf0: 225f 6665 7463 6841 6e64 4164 6452 616e  "_fetchAndAddRan
+0000db00: 6765 735f 7370 6172 7365 2870 7265 706f  ges_sparse(prepo
+0000db10: 7374 3d7b 7072 6570 6f73 747d 2922 0a20  st={prepost})". 
+0000db20: 2020 2020 2020 2069 6620 7966 636c 2e49         if yfcl.I
+0000db30: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+0000db40: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+0000db50: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
+0000db60: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
+0000db70: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
+0000db80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000db90: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
+0000dba0: 2020 2020 747a 5f65 7863 6861 6e67 6520      tz_exchange 
+0000dbb0: 3d20 7365 6c66 2e74 7a0a 2020 2020 2020  = self.tz.      
+0000dbc0: 2020 7464 5f31 6420 3d20 7469 6d65 6465    td_1d = timede
+0000dbd0: 6c74 6128 6461 7973 3d31 290a 2020 2020  lta(days=1).    
+0000dbe0: 2020 2020 6474 6e6f 7720 3d20 7064 2e54      dtnow = pd.T
+0000dbf0: 696d 6573 7461 6d70 2e75 7463 6e6f 7728  imestamp.utcnow(
+0000dc00: 292e 747a 5f63 6f6e 7665 7274 2874 7a5f  ).tz_convert(tz_
+0000dc10: 6578 6368 616e 6765 290a 0a20 2020 2020  exchange)..     
+0000dc20: 2020 2023 2042 6163 6b70 6f72 7420 6576     # Backport ev
+0000dc30: 656e 7473 2074 6861 7420 6f63 6375 7272  ents that occurr
+0000dc40: 6564 2073 696e 6365 206c 6173 7420 6164  ed since last ad
+0000dc50: 6a75 7374 6d65 6e74 3a0a 2020 2020 2020  justment:.      
+0000dc60: 2020 7365 6c66 2e5f 6170 706c 794e 6577    self._applyNew
+0000dc70: 4576 656e 7473 2829 0a0a 2020 2020 2020  Events()..      
+0000dc80: 2020 2320 456e 7375 7265 2068 6176 6520    # Ensure have 
+0000dc90: 6461 696c 7920 6461 7461 2063 6f76 6572  daily data cover
+0000dca0: 696e 6720 616c 6c20 7261 6e67 6573 5f74  ing all ranges_t
+0000dcb0: 6f5f 6665 7463 682c 2073 6f20 7468 6579  o_fetch, so they
+0000dcc0: 2063 616e 2062 6520 6465 2d73 706c 6974   can be de-split
+0000dcd0: 7465 640a 2020 2020 2020 2020 725f 7374  ted.        r_st
+0000dce0: 6172 745f 6561 726c 6965 7374 203d 2072  art_earliest = r
+0000dcf0: 616e 6765 735f 746f 5f66 6574 6368 5b30  anges_to_fetch[0
+0000dd00: 5d5b 305d 0a20 2020 2020 2020 2066 6f72  ][0].        for
+0000dd10: 2072 7374 6172 742c 2072 656e 6420 696e   rstart, rend in
+0000dd20: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+0000dd30: 3a0a 2020 2020 2020 2020 2020 2020 725f  :.            r_
+0000dd40: 7374 6172 745f 6561 726c 6965 7374 203d  start_earliest =
+0000dd50: 206d 696e 2872 7374 6172 742c 2072 5f73   min(rstart, r_s
+0000dd60: 7461 7274 5f65 6172 6c69 6573 7429 0a20  tart_earliest). 
+0000dd70: 2020 2020 2020 2072 5f73 7461 7274 5f65         r_start_e
+0000dd80: 6172 6c69 6573 745f 6420 3d20 725f 7374  arliest_d = r_st
+0000dd90: 6172 745f 6561 726c 6965 7374 2e64 6174  art_earliest.dat
+0000dda0: 6528 2920 6966 2069 7369 6e73 7461 6e63  e() if isinstanc
+0000ddb0: 6528 725f 7374 6172 745f 6561 726c 6965  e(r_start_earlie
+0000ddc0: 7374 2c20 6461 7465 7469 6d65 2920 656c  st, datetime) el
+0000ddd0: 7365 2072 5f73 7461 7274 5f65 6172 6c69  se r_start_earli
+0000dde0: 6573 740a 2020 2020 2020 2020 6966 2064  est.        if d
+0000ddf0: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
+0000de00: 2020 2020 2020 7072 696e 7428 222d 2072        print("- r
+0000de10: 5f73 7461 7274 5f65 6172 6c69 6573 7420  _start_earliest 
+0000de20: 3d20 7b7d 222e 666f 726d 6174 2872 5f73  = {}".format(r_s
+0000de30: 7461 7274 5f65 6172 6c69 6573 7429 290a  tart_earliest)).
+0000de40: 2020 2020 2020 2020 2320 5472 6967 6765          # Trigge
+0000de50: 7220 7072 6963 6520 7379 6e63 3a0a 2020  r price sync:.  
+0000de60: 2020 2020 2020 6869 7374 4461 696c 7920        histDaily 
+0000de70: 3d20 7365 6c66 2e6d 616e 6167 6572 2e47  = self.manager.G
+0000de80: 6574 4869 7374 6f72 7928 7966 6364 2e49  etHistory(yfcd.I
+0000de90: 6e74 6572 7661 6c2e 4461 7973 3129 0a20  nterval.Days1). 
+0000dea0: 2020 2020 2020 2023 2068 6973 7444 6169         # histDai
+0000deb0: 6c79 2e67 6574 2873 7461 7274 3d72 5f73  ly.get(start=r_s
+0000dec0: 7461 7274 5f65 6172 6c69 6573 745f 642c  tart_earliest_d,
+0000ded0: 206d 6178 5f61 6765 3d74 645f 3164 290a   max_age=td_1d).
+0000dee0: 2020 2020 2020 2020 6869 7374 4461 696c          histDail
+0000def0: 792e 6765 7428 7374 6172 743d 725f 7374  y.get(start=r_st
+0000df00: 6172 745f 6561 726c 6965 7374 5f64 2c20  art_earliest_d, 
+0000df10: 6d61 785f 6167 653d 7464 5f31 642c 2072  max_age=td_1d, r
+0000df20: 6570 6169 723d 4661 6c73 6529 0a0a 2020  epair=False)..  
+0000df30: 2020 2020 2020 2320 4665 7463 6820 6561        # Fetch ea
+0000df40: 6368 2072 616e 6765 2c20 616e 6420 6164  ch range, and ad
+0000df50: 6a75 7374 2066 6f72 2073 706c 6974 7320  just for splits 
+0000df60: 7468 6174 206f 6363 7572 7265 6420 6166  that occurred af
+0000df70: 7465 720a 2020 2020 2020 2020 666f 7220  ter.        for 
+0000df80: 7273 7461 7274 2c20 7265 6e64 2069 6e20  rstart, rend in 
+0000df90: 7261 6e67 6573 5f74 6f5f 6665 7463 683a  ranges_to_fetch:
+0000dfa0: 0a20 2020 2020 2020 2020 2020 2066 6574  .            fet
+0000dfb0: 6368 5f73 7461 7274 203d 2072 7374 6172  ch_start = rstar
+0000dfc0: 740a 2020 2020 2020 2020 2020 2020 6665  t.            fe
+0000dfd0: 7463 685f 656e 6420 3d20 7265 6e64 0a20  tch_end = rend. 
+0000dfe0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+0000dff0: 6e6f 7420 7365 6c66 2e69 6e74 6572 6461  not self.interda
+0000e000: 793a 2020 2320 616e 6420 6665 7463 685f  y:  # and fetch_
+0000e010: 7374 6172 742e 6461 7465 2829 203d 3d20  start.date() == 
+0000e020: 6665 7463 685f 656e 642e 6461 7465 2829  fetch_end.date()
+0000e030: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000e040: 2020 2020 2320 496e 7472 6164 6179 2066      # Intraday f
+0000e050: 6574 6368 6573 2062 6568 6176 6520 6265  etches behave be
+0000e060: 7474 6572 2077 6865 6e20 7469 6d65 203d  tter when time =
+0000e070: 206d 6964 6e69 6768 740a 2020 2020 2020   midnight.      
+0000e080: 2020 2020 2020 2320 2020 2020 6665 7463        #     fetc
+0000e090: 685f 7374 6172 7420 3d20 6665 7463 685f  h_start = fetch_
+0000e0a0: 7374 6172 742e 666c 6f6f 7228 2231 4422  start.floor("1D"
+0000e0b0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0000e0c0: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
+0000e0d0: 6665 7463 685f 656e 642e 6365 696c 2822  fetch_end.ceil("
+0000e0e0: 3144 2229 0a20 2020 2020 2020 2020 2020  1D").           
+0000e0f0: 2023 2055 7064 6174 653a 2064 6174 6120   # Update: data 
+0000e100: 7265 6c69 6162 696c 6974 7920 6e6f 7720  reliability now 
+0000e110: 6669 7865 6420 6279 2043 6875 6e6b 4461  fixed by ChunkDa
+0000e120: 7465 7349 6e74 6f59 6646 6574 6368 6573  tesIntoYfFetches
+0000e130: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0000e140: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
+0000e150: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000e160: 6e74 2822 2d20 6665 7463 6869 6e67 207b  nt("- fetching {
+0000e170: 7d20 2d3e 207b 7d22 2e66 6f72 6d61 7428  } -> {}".format(
+0000e180: 6665 7463 685f 7374 6172 742c 2066 6574  fetch_start, fet
+0000e190: 6368 5f65 6e64 2929 0a20 2020 2020 2020  ch_end)).       
+0000e1a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000e1b0: 2020 2020 2020 2020 2020 6832 203d 2073            h2 = s
+0000e1c0: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
+0000e1d0: 6f72 7928 6665 7463 685f 7374 6172 742c  ory(fetch_start,
+0000e1e0: 2066 6574 6368 5f65 6e64 2c20 7072 6570   fetch_end, prep
+0000e1f0: 6f73 742c 2064 6562 7567 290a 2020 2020  ost, debug).    
+0000e200: 2020 2020 2020 2020 6578 6365 7074 2079          except y
+0000e210: 6663 642e 4e6f 5072 6963 6544 6174 6149  fcd.NoPriceDataI
+0000e220: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
+0000e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e240: 2023 2049 6620 6f6e 6c79 2074 7279 696e   # If only tryin
+0000e250: 6720 746f 2066 6574 6368 2031 2064 6179  g to fetch 1 day
+0000e260: 206f 6620 3164 2064 6174 612c 2074 6865   of 1d data, the
+0000e270: 6e20 7072 696e 7420 7761 726e 696e 6720  n print warning 
+0000e280: 696e 7374 6561 6420 6f66 2065 7863 6570  instead of excep
+0000e290: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
+0000e2a0: 2020 2020 2020 2320 436f 756c 6420 6164        # Could ad
+0000e2b0: 6420 6164 6469 7469 6f6e 616c 2063 6f6e  d additional con
+0000e2c0: 6469 7469 6f6e 206f 6620 6469 7669 6465  dition of divide
+0000e2d0: 6e64 2070 7265 7669 6f75 7320 6461 7920  nd previous day 
+0000e2e0: 2873 6565 6d73 2074 6f20 6d65 7373 2075  (seems to mess u
+0000e2f0: 7020 7461 626c 6529 2e0a 2020 2020 2020  p table)..      
+0000e300: 2020 2020 2020 2020 2020 6967 6e6f 7265            ignore
+0000e310: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0000e320: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0000e330: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0000e340: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
+0000e350: 2061 6e64 2066 6574 6368 5f65 6e64 202d   and fetch_end -
+0000e360: 2066 6574 6368 5f73 7461 7274 203d 3d20   fetch_start == 
+0000e370: 7464 5f31 643a 0a20 2020 2020 2020 2020  td_1d:.         
+0000e380: 2020 2020 2020 2020 2020 2069 676e 6f72             ignor
+0000e390: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
+0000e3a0: 2020 2020 2020 2020 2065 6c69 6620 7365           elif se
+0000e3b0: 6c66 2e69 6e74 7261 6461 7920 616e 6420  lf.intraday and 
+0000e3c0: 6665 7463 685f 7374 6172 742e 6461 7465  fetch_start.date
+0000e3d0: 2829 203d 3d20 6474 6e6f 772e 6461 7465  () == dtnow.date
+0000e3e0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000e3f0: 2020 2020 2020 2020 6967 6e6f 7265 203d          ignore =
+0000e400: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0000e410: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+0000e420: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0000e430: 2e49 6e74 6572 7661 6c2e 4d69 6e73 3120  .Interval.Mins1 
+0000e440: 616e 6420 6665 7463 685f 656e 6420 2d20  and fetch_end - 
+0000e450: 6665 7463 685f 7374 6172 7420 3c3d 2074  fetch_start <= t
+0000e460: 696d 6564 656c 7461 286d 696e 7574 6573  imedelta(minutes
+0000e470: 3d31 3029 3a0a 2020 2020 2020 2020 2020  =10):.          
+0000e480: 2020 2020 2020 2020 2020 6967 6e6f 7265            ignore
+0000e490: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0000e4a0: 2020 2020 2020 2020 6966 2069 676e 6f72          if ignor
+0000e4b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e4c0: 2020 2020 2020 2069 6620 6e6f 7420 7175         if not qu
+0000e4d0: 6965 743a 0a20 2020 2020 2020 2020 2020  iet:.           
+0000e4e0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0000e4f0: 7269 6e74 2822 5741 524e 494e 473a 204e  rint("WARNING: N
+0000e500: 6f20 7b7d 2d70 7269 6365 2064 6174 6120  o {}-price data 
+0000e510: 6665 7463 6865 6420 666f 7220 7469 636b  fetched for tick
+0000e520: 6572 207b 7d20 6265 7477 6565 6e20 6461  er {} between da
+0000e530: 7465 7320 7b7d 202d 3e20 7b7d 222e 666f  tes {} -> {}".fo
+0000e540: 726d 6174 2879 6663 642e 696e 7465 7276  rmat(yfcd.interv
+0000e550: 616c 546f 5374 7269 6e67 5b73 656c 662e  alToString[self.
+0000e560: 696e 7465 7276 616c 5d2c 2073 656c 662e  interval], self.
+0000e570: 7469 636b 6572 2c20 7273 7461 7274 2c20  ticker, rstart, 
+0000e580: 7265 6e64 2929 0a20 2020 2020 2020 2020  rend)).         
+0000e590: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000e5a0: 7269 6e74 2866 2257 4152 4e49 4e47 3a20  rint(f"WARNING: 
+0000e5b0: 7b73 656c 662e 7469 636b 6572 7d3a 204e  {self.ticker}: N
+0000e5c0: 6f20 7b79 6663 642e 696e 7465 7276 616c  o {yfcd.interval
+0000e5d0: 546f 5374 7269 6e67 5b73 656c 662e 696e  ToString[self.in
+0000e5e0: 7465 7276 616c 5d7d 2d70 7269 6365 2064  terval]}-price d
+0000e5f0: 6174 6120 6665 7463 6865 6420 666f 7220  ata fetched for 
+0000e600: 7b72 7374 6172 747d 202d 3e20 7b72 656e  {rstart} -> {ren
+0000e610: 647d 2229 0a20 2020 2020 2020 2020 2020  d}").           
+0000e620: 2020 2020 2020 2020 2068 3220 3d20 4e6f           h2 = No
+0000e630: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+0000e640: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0000e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e660: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000e670: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+0000e680: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000e690: 6832 2069 7320 4e6f 6e65 3a0a 2020 2020  h2 is None:.    
+0000e6a0: 2020 2020 2020 2020 2020 2020 2320 7261              # ra
+0000e6b0: 6973 6520 4578 6365 7074 696f 6e28 2259  ise Exception("Y
+0000e6c0: 4620 7265 7475 726e 6564 204e 6f6e 6520  F returned None 
+0000e6d0: 666f 723a 2074 6b72 3d7b 7d2c 2069 6e74  for: tkr={}, int
+0000e6e0: 6572 7661 6c3d 7b7d 2c20 7374 6172 743d  erval={}, start=
+0000e6f0: 7b7d 2c20 656e 643d 7b7d 222e 666f 726d  {}, end={}".form
+0000e700: 6174 2873 656c 662e 7469 636b 6572 2c20  at(self.ticker, 
+0000e710: 7365 6c66 2e69 6e74 6572 7661 6c2c 2072  self.interval, r
+0000e720: 7374 6172 742c 2072 656e 6429 290a 2020  start, rend)).  
+0000e730: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000e740: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0000e750: 6622 7966 696e 616e 6365 2e68 6973 746f  f"yfinance.histo
+0000e760: 7279 2829 2072 6574 7572 6e65 6420 4e6f  ry() returned No
+0000e770: 6e65 2028 7b73 656c 662e 7469 636b 6572  ne ({self.ticker
+0000e780: 7d20 7b73 656c 662e 6973 7472 7d20 7b72  } {self.istr} {r
+0000e790: 7374 6172 747d 2d3e 7b72 656e 647d 2922  start}->{rend})"
+0000e7a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e7b0: 2020 7261 6973 6520 7966 6364 2e4e 6f50    raise yfcd.NoP
+0000e7c0: 7269 6365 4461 7461 496e 5261 6e67 6545  riceDataInRangeE
+0000e7d0: 7863 6570 7469 6f6e 2873 656c 662e 7469  xception(self.ti
+0000e7e0: 636b 6572 2c20 7365 6c66 2e69 7374 722c  cker, self.istr,
+0000e7f0: 2072 7374 6172 742c 2072 656e 6429 0a20   rstart, rend). 
+0000e800: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000e810: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0000e820: 2866 2279 6669 6e61 6e63 652e 6869 7374  (f"yfinance.hist
+0000e830: 6f72 7928 2920 7265 7475 726e 6564 204e  ory() returned N
+0000e840: 6f6e 6520 287b 7365 6c66 2e74 6963 6b65  one ({self.ticke
+0000e850: 727d 207b 7365 6c66 2e69 7374 727d 207b  r} {self.istr} {
+0000e860: 6665 7463 685f 7374 6172 747d 2d3e 7b66  fetch_start}->{f
+0000e870: 6574 6368 5f65 6e64 7d29 2229 0a0a 2020  etch_end})")..  
+0000e880: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+0000e890: 7265 2068 3220 6973 2073 706c 6974 2d61  re h2 is split-a
+0000e8a0: 646a 7573 7465 642e 2053 6f6d 6574 696d  djusted. Sometim
+0000e8b0: 6573 2059 6168 6f6f 2072 6574 7572 6e73  es Yahoo returns
+0000e8c0: 2075 6e61 646a 7573 7465 6420 6461 7461   unadjusted data
+0000e8d0: 0a20 2020 2020 2020 2020 2020 2068 3220  .            h2 
+0000e8e0: 3d20 7365 6c66 2e5f 7265 7665 7273 6559  = self._reverseY
+0000e8f0: 6168 6f6f 4164 6a75 7374 2868 3229 0a20  ahooAdjust(h2). 
+0000e900: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+0000e910: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
+0000e920: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0000e930: 2d20 6832 2061 646a 7573 7465 643a 2229  - h2 adjusted:")
+0000e940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e950: 2070 7269 6e74 2868 325b 5b22 436c 6f73   print(h2[["Clos
+0000e960: 6522 2c20 2244 6976 6964 656e 6473 222c  e", "Dividends",
+0000e970: 2022 566f 6c75 6d65 222c 2022 4353 4622   "Volume", "CSF"
+0000e980: 2c20 2243 4446 225d 5d29 0a0a 2020 2020  , "CDF"]])..    
+0000e990: 2020 2020 2020 2020 6966 2066 6574 6368          if fetch
+0000e9a0: 5f73 7461 7274 2021 3d20 7273 7461 7274  _start != rstart
+0000e9b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e9c0: 2020 6832 203d 2068 325b 6832 2e69 6e64    h2 = h2[h2.ind
+0000e9d0: 6578 203e 3d20 7273 7461 7274 5d0a 2020  ex >= rstart].  
+0000e9e0: 2020 2020 2020 2020 2020 6966 2066 6574            if fet
+0000e9f0: 6368 5f65 6e64 2021 3d20 7265 6e64 3a0a  ch_end != rend:.
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea10: 6832 203d 2068 325b 6832 2e69 6e64 6578  h2 = h2[h2.index
+0000ea20: 203c 2072 656e 642b 7365 6c66 2e69 7464   < rend+self.itd
+0000ea30: 5d0a 0a20 2020 2020 2020 2020 2020 2069  ]..            i
+0000ea40: 6620 2241 646a 2043 6c6f 7365 2220 696e  f "Adj Close" in
+0000ea50: 2068 322e 636f 6c75 6d6e 733a 0a20 2020   h2.columns:.   
+0000ea60: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000ea70: 7365 2045 7863 6570 7469 6f6e 2822 4164  se Exception("Ad
+0000ea80: 6a20 436c 6f73 6520 696e 2068 3222 290a  j Close in h2").
+0000ea90: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000eaa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eab0: 2073 656c 662e 6820 3d20 7365 6c66 2e68   self.h = self.h
+0000eac0: 5b79 6663 752e 6e70 5f69 7369 6e5f 6f70  [yfcu.np_isin_op
+0000ead0: 7469 6d69 7365 6428 7365 6c66 2e68 2e69  timised(self.h.i
+0000eae0: 6e64 6578 2c20 6832 2e69 6e64 6578 2c20  ndex, h2.index, 
+0000eaf0: 696e 7665 7274 3d54 7275 6529 5d0a 2020  invert=True)].  
+0000eb00: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000eb10: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+0000eb20: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000eb30: 7428 2273 656c 662e 682e 7368 6170 653a  t("self.h.shape:
+0000eb40: 222c 2073 656c 662e 682e 7368 6170 6529  ", self.h.shape)
+0000eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eb60: 2070 7269 6e74 2822 6832 2e73 6861 7065   print("h2.shape
+0000eb70: 3a22 2c20 6832 2e73 6861 7065 290a 2020  :", h2.shape).  
+0000eb80: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000eb90: 6973 650a 2020 2020 2020 2020 2020 2020  ise.            
+0000eba0: 7365 6c66 2e68 203d 2070 642e 636f 6e63  self.h = pd.conc
+0000ebb0: 6174 285b 7365 6c66 2e68 2c20 6832 5b73  at([self.h, h2[s
+0000ebc0: 656c 662e 682e 636f 6c75 6d6e 735d 5d29  elf.h.columns]])
+0000ebd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000ebe0: 662e 682e 696e 6465 7820 3d20 7064 2e74  f.h.index = pd.t
+0000ebf0: 6f5f 6461 7465 7469 6d65 2873 656c 662e  o_datetime(self.
+0000ec00: 682e 696e 6465 782c 2075 7463 3d54 7275  h.index, utc=Tru
+0000ec10: 6529 2e74 7a5f 636f 6e76 6572 7428 747a  e).tz_convert(tz
+0000ec20: 5f65 7863 6861 6e67 6529 0a0a 2020 2020  _exchange)..    
+0000ec30: 2020 2020 2020 2020 665f 6475 7073 203d          f_dups =
+0000ec40: 2073 656c 662e 682e 696e 6465 782e 6475   self.h.index.du
+0000ec50: 706c 6963 6174 6564 2829 0a20 2020 2020  plicated().     
+0000ec60: 2020 2020 2020 2069 6620 665f 6475 7073         if f_dups
+0000ec70: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+0000ec80: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0000ec90: 6365 7074 696f 6e28 6622 7b73 656c 662e  ception(f"{self.
+0000eca0: 7469 636b 6572 7d3a 2041 6464 696e 6720  ticker}: Adding 
+0000ecb0: 7261 6e67 6520 7b72 7374 6172 747d 2d3e  range {rstart}->
+0000ecc0: 7b72 656e 647d 2068 6173 2061 6464 6564  {rend} has added
+0000ecd0: 2064 7570 6c69 6361 7465 2074 696d 6570   duplicate timep
+0000ece0: 6f69 6e74 7320 6861 7665 2062 6565 6e20  oints have been 
+0000ecf0: 6475 706c 6963 6174 6564 3a20 7b73 656c  duplicated: {sel
+0000ed00: 662e 682e 696e 6465 785b 665f 6475 7073  f.h.index[f_dups
+0000ed10: 5d7d 2229 0a0a 2020 2020 2020 2020 7365  ]}")..        se
+0000ed20: 6c66 2e68 203d 2073 656c 662e 682e 736f  lf.h = self.h.so
+0000ed30: 7274 5f69 6e64 6578 2829 0a20 2020 2020  rt_index().     
+0000ed40: 2020 2073 656c 662e 5f75 7064 6174 6564     self._updated
+0000ed50: 4361 6368 6564 5072 6963 6573 2873 656c  CachedPrices(sel
+0000ed60: 662e 6829 0a0a 2020 2020 2020 2020 6c6f  f.h)..        lo
+0000ed70: 675f 6d73 6720 3d20 225f 6665 7463 6841  g_msg = "_fetchA
+0000ed80: 6e64 4164 6452 616e 6765 735f 7370 6172  ndAddRanges_spar
+0000ed90: 7365 2829 2072 6574 7572 6e69 6e67 220a  se() returning".
+0000eda0: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
+0000edb0: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+0000edc0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000edd0: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
+0000ede0: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
+0000edf0: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
+0000ee00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000ee10: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
+0000ee20: 6465 6620 5f76 6572 6966 7943 6163 6865  def _verifyCache
+0000ee30: 6450 7269 6365 7328 7365 6c66 2c20 7274  dPrices(self, rt
+0000ee40: 6f6c 3d30 2e30 3030 312c 2076 6f6c 5f72  ol=0.0001, vol_r
+0000ee50: 746f 6c3d 302e 3030 342c 2063 6f72 7265  tol=0.004, corre
+0000ee60: 6374 3d46 616c 7365 2c20 6469 7363 6172  ct=False, discar
+0000ee70: 645f 6f6c 643d 4661 6c73 652c 2071 7569  d_old=False, qui
+0000ee80: 6574 3d54 7275 652c 2064 6562 7567 3d46  et=True, debug=F
+0000ee90: 616c 7365 293a 0a20 2020 2020 2020 2063  alse):.        c
+0000eea0: 6f72 7265 6374 5f76 616c 7565 7320 3d20  orrect_values = 
+0000eeb0: 5b46 616c 7365 2c20 276f 6e65 272c 2027  [False, 'one', '
+0000eec0: 616c 6c27 5d0a 2020 2020 2020 2020 6966  all'].        if
+0000eed0: 2063 6f72 7265 6374 206e 6f74 2069 6e20   correct not in 
+0000eee0: 636f 7272 6563 745f 7661 6c75 6573 3a0a  correct_values:.
+0000eef0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000ef00: 6520 5479 7065 4572 726f 7228 6622 2763  e TypeError(f"'c
+0000ef10: 6f72 7265 6374 2720 6d75 7374 2062 6520  orrect' must be 
+0000ef20: 6f6e 6520 6f66 3a20 7b63 6f72 7265 6374  one of: {correct
+0000ef30: 5f76 616c 7565 737d 2229 0a20 2020 2020  _values}").     
+0000ef40: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+0000ef50: 6b42 6f6f 6c28 6469 7363 6172 645f 6f6c  kBool(discard_ol
+0000ef60: 642c 2022 6469 7363 6172 645f 6f6c 6422  d, "discard_old"
+0000ef70: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+0000ef80: 7970 6543 6865 636b 426f 6f6c 2871 7569  ypeCheckBool(qui
+0000ef90: 6574 2c20 2271 7569 6574 2229 0a20 2020  et, "quiet").   
+0000efa0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+0000efb0: 6563 6b42 6f6f 6c28 6465 6275 672c 2022  eckBool(debug, "
+0000efc0: 6465 6275 6722 290a 0a20 2020 2020 2020  debug")..       
+0000efd0: 2069 6620 7365 6c66 2e68 2069 7320 4e6f   if self.h is No
+0000efe0: 6e65 206f 7220 7365 6c66 2e68 2e65 6d70  ne or self.h.emp
+0000eff0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+0000f000: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0000f010: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
+0000f020: 2020 2020 2020 2020 2020 2071 7569 6574             quiet
+0000f030: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000f040: 2020 7966 636c 2e54 7261 6365 456e 7465    yfcl.TraceEnte
+0000f050: 7228 6622 504d 3a3a 5f76 6572 6966 7943  r(f"PM::_verifyC
+0000f060: 6163 6865 6450 7269 6365 732d 7b73 656c  achedPrices-{sel
+0000f070: 662e 6973 7472 7d28 636f 7272 6563 743d  f.istr}(correct=
+0000f080: 7b63 6f72 7265 6374 7d2c 2064 6562 7567  {correct}, debug
+0000f090: 3d7b 6465 6275 677d 2922 290a 0a20 2020  ={debug})")..   
+0000f0a0: 2020 2020 2023 204e 6577 2063 6f64 653a       # New code:
+0000f0b0: 2068 6f70 6566 756c 6c79 2074 6869 7320   hopefully this 
+0000f0c0: 7769 6c6c 2063 6f72 7265 6374 2062 6164  will correct bad
+0000f0d0: 2043 4446 2069 6e20 3177 6b20 6574 630a   CDF in 1wk etc.
+0000f0e0: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
+0000f0f0: 706c 794e 6577 4576 656e 7473 2829 0a0a  plyNewEvents()..
+0000f100: 2020 2020 2020 2020 6820 3d20 7365 6c66          h = self
+0000f110: 2e68 2e63 6f70 7928 2920 2023 2077 6f72  .h.copy()  # wor
+0000f120: 6b69 6e67 2063 6f70 7920 666f 7220 636f  king copy for co
+0000f130: 6d70 6172 6973 6f6e 2077 6974 6820 5946  mparison with YF
+0000f140: 0a20 2020 2020 2020 2068 5f6d 6f64 6966  .        h_modif
+0000f150: 6965 6420 3d20 4661 6c73 650a 2020 2020  ied = False.    
+0000f160: 2020 2020 685f 6e65 7720 3d20 7365 6c66      h_new = self
+0000f170: 2e68 2e63 6f70 7928 2920 2023 2063 6f70  .h.copy()  # cop
+0000f180: 7920 666f 7220 7374 6f72 696e 6720 6368  y for storing ch
+0000f190: 616e 6765 730a 2020 2020 2020 2020 2320  anges.        # 
+0000f1a0: 4b65 6570 2074 7261 636b 206f 6620 7072  Keep track of pr
+0000f1b0: 6f62 6c65 6d73 3a0a 2020 2020 2020 2020  oblems:.        
+0000f1c0: 665f 6469 6666 5f61 6c6c 203d 2070 642e  f_diff_all = pd.
+0000f1d0: 5365 7269 6573 286e 702e 6675 6c6c 2868  Series(np.full(h
+0000f1e0: 2e73 6861 7065 5b30 5d2c 2046 616c 7365  .shape[0], False
+0000f1f0: 292c 2068 2e69 6e64 6578 2c20 6e61 6d65  ), h.index, name
+0000f200: 3d22 4e6f 6e65 2229 0a20 2020 2020 2020  ="None").       
+0000f210: 206e 203d 2068 2e73 6861 7065 5b30 5d0a   n = h.shape[0].
+0000f220: 0a20 2020 2020 2020 2023 2049 676e 6f72  .        # Ignor
+0000f230: 6520 6e6f 6e2d 6669 6e61 6c20 6461 7461  e non-final data
+0000f240: 2062 6563 6175 7365 2077 696c 6c20 6469   because will di
+0000f250: 6666 6572 2074 6f20 5961 686f 6f0a 2020  ffer to Yahoo.  
+0000f260: 2020 2020 2020 685f 6c61 7374 526f 7720        h_lastRow 
+0000f270: 3d20 682e 696c 6f63 5b2d 315d 0a0a 2020  = h.iloc[-1]..  
+0000f280: 2020 2020 2020 2320 4170 706c 7920 7374        # Apply st
+0000f290: 6f63 6b2d 7370 6c69 7420 6164 6a75 7374  ock-split adjust
+0000f2a0: 6d65 6e74 2074 6f20 6d61 7463 6820 5946  ment to match YF
+0000f2b0: 0a20 2020 2020 2020 2066 6f72 2063 2069  .        for c i
+0000f2c0: 6e20 5b22 4f70 656e 222c 2022 436c 6f73  n ["Open", "Clos
+0000f2d0: 6522 2c20 224c 6f77 222c 2022 4869 6768  e", "Low", "High
+0000f2e0: 222c 2022 4469 7669 6465 6e64 7322 5d3a  ", "Dividends"]:
+0000f2f0: 0a20 2020 2020 2020 2020 2020 2068 5b63  .            h[c
+0000f300: 5d20 3d20 685b 635d 2e74 6f5f 6e75 6d70  ] = h[c].to_nump
+0000f310: 7928 2920 2a20 685b 2243 5346 225d 2e74  y() * h["CSF"].t
+0000f320: 6f5f 6e75 6d70 7928 290a 2020 2020 2020  o_numpy().      
+0000f330: 2020 685b 2256 6f6c 756d 6522 5d20 3d20    h["Volume"] = 
+0000f340: 2868 5b22 566f 6c75 6d65 225d 2e74 6f5f  (h["Volume"].to_
+0000f350: 6e75 6d70 7928 2920 2f20 685b 2243 5346  numpy() / h["CSF
+0000f360: 225d 2e74 6f5f 6e75 6d70 7928 2929 2e72  "].to_numpy()).r
+0000f370: 6f75 6e64 2829 2e61 7374 7970 6528 2769  ound().astype('i
+0000f380: 6e74 2729 0a0a 2020 2020 2020 2020 7464  nt')..        td
+0000f390: 5f31 6420 3d20 7064 2e54 696d 6564 656c  _1d = pd.Timedel
+0000f3a0: 7461 2822 3144 2229 0a20 2020 2020 2020  ta("1D").       
+0000f3b0: 2064 745f 6e6f 7720 3d20 7064 2e54 696d   dt_now = pd.Tim
+0000f3c0: 6573 7461 6d70 2e75 7463 6e6f 7728 292e  estamp.utcnow().
+0000f3d0: 747a 5f63 6f6e 7665 7274 285a 6f6e 6549  tz_convert(ZoneI
+0000f3e0: 6e66 6f28 2255 5443 2229 290a 0a20 2020  nfo("UTC"))..   
+0000f3f0: 2020 2020 2064 6566 205f 6167 6772 6567       def _aggreg
+0000f400: 6174 655f 7966 6466 5f64 6169 6c79 2864  ate_yfdf_daily(d
+0000f410: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
+0000f420: 6466 3220 3d20 6466 2e63 6f70 7928 290a  df2 = df.copy().
+0000f430: 2020 2020 2020 2020 2020 2020 6466 325b              df2[
+0000f440: 225f 6461 7465 225d 203d 2064 6632 2e69  "_date"] = df2.i
+0000f450: 6e64 6578 2e64 6174 650a 2020 2020 2020  ndex.date.      
+0000f460: 2020 2020 2020 6466 322e 6c6f 635b 6466        df2.loc[df
+0000f470: 325b 2253 746f 636b 2053 706c 6974 7322  2["Stock Splits"
+0000f480: 5d20 3d3d 2030 2c20 2253 746f 636b 2053  ] == 0, "Stock S
+0000f490: 706c 6974 7322 5d20 3d20 310a 2020 2020  plits"] = 1.    
+0000f4a0: 2020 2020 2020 2020 6966 2022 4344 4622          if "CDF"
+0000f4b0: 2069 6e20 6466 2e63 6f6c 756d 6e73 3a0a   in df.columns:.
+0000f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4d0: 6466 3220 3d20 6466 322e 6772 6f75 7062  df2 = df2.groupb
+0000f4e0: 7928 225f 6461 7465 2229 2e61 6767 280a  y("_date").agg(.
+0000f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f500: 2020 2020 4f70 656e 3d28 224f 7065 6e22      Open=("Open"
+0000f510: 2c20 2266 6972 7374 2229 2c0a 2020 2020  , "first"),.    
+0000f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f530: 436c 6f73 653d 2822 436c 6f73 6522 2c20  Close=("Close", 
+0000f540: 226c 6173 7422 292c 0a20 2020 2020 2020  "last"),.       
+0000f550: 2020 2020 2020 2020 2020 2020 204c 6f77               Low
+0000f560: 3d28 224c 6f77 222c 2022 6d69 6e22 292c  =("Low", "min"),
+0000f570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f580: 2020 2020 2048 6967 683d 2822 4869 6768       High=("High
+0000f590: 222c 2022 6d61 7822 292c 0a20 2020 2020  ", "max"),.     
+0000f5a0: 2020 2020 2020 2020 2020 2020 2020 2056                 V
+0000f5b0: 6f6c 756d 653d 2822 566f 6c75 6d65 222c  olume=("Volume",
+0000f5c0: 2022 7375 6d22 292c 0a20 2020 2020 2020   "sum"),.       
+0000f5d0: 2020 2020 2020 2020 2020 2020 2044 6976               Div
+0000f5e0: 6964 656e 6473 3d28 2244 6976 6964 656e  idends=("Dividen
+0000f5f0: 6473 222c 2022 7375 6d22 292c 0a20 2020  ds", "sum"),.   
+0000f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f610: 2053 746f 636b 5370 6c69 7473 3d28 2253   StockSplits=("S
+0000f620: 746f 636b 2053 706c 6974 7322 2c20 2270  tock Splits", "p
+0000f630: 726f 6422 292c 0a20 2020 2020 2020 2020  rod"),.         
+0000f640: 2020 2020 2020 2020 2020 2043 4446 3d28             CDF=(
+0000f650: 2243 4446 222c 2022 7072 6f64 2229 2c0a  "CDF", "prod"),.
+0000f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f670: 2020 2020 4353 463d 2822 4353 4622 2c20      CSF=("CSF", 
+0000f680: 2270 726f 6422 292c 0a20 2020 2020 2020  "prod"),.       
+0000f690: 2020 2020 2020 2020 2020 2020 2046 6574               Fet
+0000f6a0: 6368 4461 7465 3d28 2246 6574 6368 4461  chDate=("FetchDa
+0000f6b0: 7465 222c 2022 6669 7273 7422 2929 2e72  te", "first")).r
+0000f6c0: 656e 616d 6528 636f 6c75 6d6e 733d 7b22  ename(columns={"
+0000f6d0: 5374 6f63 6b53 706c 6974 7322 3a20 2253  StockSplits": "S
+0000f6e0: 746f 636b 2053 706c 6974 7322 7d29 0a20  tock Splits"}). 
+0000f6f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000f700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f710: 2064 6632 203d 2064 6632 2e67 726f 7570   df2 = df2.group
+0000f720: 6279 2822 5f64 6174 6522 292e 6167 6728  by("_date").agg(
+0000f730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f740: 2020 2020 204f 7065 6e3d 2822 4f70 656e       Open=("Open
+0000f750: 222c 2022 6669 7273 7422 292c 0a20 2020  ", "first"),.   
+0000f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f770: 2043 6c6f 7365 3d28 2243 6c6f 7365 222c   Close=("Close",
+0000f780: 2022 6c61 7374 2229 2c0a 2020 2020 2020   "last"),.      
+0000f790: 2020 2020 2020 2020 2020 2020 2020 4164                Ad
+0000f7a0: 6a43 6c6f 7365 3d28 2241 646a 2043 6c6f  jClose=("Adj Clo
+0000f7b0: 7365 222c 2022 6c61 7374 2229 2c0a 2020  se", "last"),.  
+0000f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f7d0: 2020 4c6f 773d 2822 4c6f 7722 2c20 226d    Low=("Low", "m
+0000f7e0: 696e 2229 2c0a 2020 2020 2020 2020 2020  in"),.          
+0000f7f0: 2020 2020 2020 2020 2020 4869 6768 3d28            High=(
+0000f800: 2248 6967 6822 2c20 226d 6178 2229 2c0a  "High", "max"),.
+0000f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f820: 2020 2020 566f 6c75 6d65 3d28 2256 6f6c      Volume=("Vol
+0000f830: 756d 6522 2c20 2273 756d 2229 2c0a 2020  ume", "sum"),.  
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f850: 2020 4469 7669 6465 6e64 733d 2822 4469    Dividends=("Di
+0000f860: 7669 6465 6e64 7322 2c20 2273 756d 2229  vidends", "sum")
+0000f870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f880: 2020 2020 2020 5374 6f63 6b53 706c 6974        StockSplit
+0000f890: 733d 2822 5374 6f63 6b20 5370 6c69 7473  s=("Stock Splits
+0000f8a0: 222c 2022 7072 6f64 2229 292e 7265 6e61  ", "prod")).rena
+0000f8b0: 6d65 2863 6f6c 756d 6e73 3d7b 2253 746f  me(columns={"Sto
+0000f8c0: 636b 5370 6c69 7473 223a 2022 5374 6f63  ckSplits": "Stoc
+0000f8d0: 6b20 5370 6c69 7473 222c 2022 4164 6a43  k Splits", "AdjC
+0000f8e0: 6c6f 7365 223a 2022 4164 6a20 436c 6f73  lose": "Adj Clos
+0000f8f0: 6522 7d29 0a20 2020 2020 2020 2020 2020  e"}).           
+0000f900: 2064 6632 2e6c 6f63 5b64 6632 5b22 5374   df2.loc[df2["St
+0000f910: 6f63 6b20 5370 6c69 7473 225d 203d 3d20  ock Splits"] == 
+0000f920: 312c 2022 5374 6f63 6b20 5370 6c69 7473  1, "Stock Splits
+0000f930: 225d 203d 2030 0a20 2020 2020 2020 2020  "] = 0.         
+0000f940: 2020 2064 6632 2e69 6e64 6578 2e6e 616d     df2.index.nam
+0000f950: 6520 3d20 6466 2e69 6e64 6578 2e6e 616d  e = df.index.nam
+0000f960: 650a 2020 2020 2020 2020 2020 2020 6466  e.            df
+0000f970: 322e 696e 6465 7820 3d20 7064 2e74 6f5f  2.index = pd.to_
+0000f980: 6461 7465 7469 6d65 2864 6632 2e69 6e64  datetime(df2.ind
+0000f990: 6578 292e 747a 5f6c 6f63 616c 697a 6528  ex).tz_localize(
+0000f9a0: 6466 2e69 6e64 6578 2e74 7a29 0a20 2020  df.index.tz).   
+0000f9b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000f9c0: 6466 320a 0a20 2020 2020 2020 2023 2046  df2..        # F
+0000f9d0: 6f72 2069 6e74 7261 6461 7920 6461 7461  or intraday data
+0000f9e0: 206f 6c64 6572 2074 6861 6e20 5961 686f   older than Yaho
+0000f9f0: 6f20 6c69 6d69 742c 2063 6f6d 7061 7265  o limit, compare
+0000fa00: 2061 6767 7265 6761 7465 6420 6167 6169   aggregated agai
+0000fa10: 6e73 7420 3164 0a20 2020 2020 2020 2069  nst 1d.        i
+0000fa20: 6620 7365 6c66 2e69 6e74 7261 6461 793a  f self.intraday:
+0000fa30: 0a20 2020 2020 2020 2020 2020 2064 745f  .            dt_
+0000fa40: 6e6f 775f 6c6f 6361 6c20 3d20 6474 5f6e  now_local = dt_n
+0000fa50: 6f77 2e74 7a5f 636f 6e76 6572 7428 7365  ow.tz_convert(se
+0000fa60: 6c66 2e74 7a4e 616d 6529 0a20 2020 2020  lf.tzName).     
+0000fa70: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+0000fa80: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
+0000fa90: 496e 7465 7276 616c 2e48 6f75 7273 313a  Interval.Hours1:
+0000faa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fab0: 206d 6178 5f6c 6f6f 6b62 6163 6b5f 6461   max_lookback_da
+0000fac0: 7973 203d 2033 3635 2a32 0a20 2020 2020  ys = 365*2.     
+0000fad0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+0000fae0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0000faf0: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
+0000fb00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fb10: 2020 2320 6d61 785f 6c6f 6f6b 6261 636b    # max_lookback
+0000fb20: 5f64 6179 7320 3d20 370a 2020 2020 2020  _days = 7.      
+0000fb30: 2020 2020 2020 2020 2020 6d61 785f 6c6f            max_lo
+0000fb40: 6f6b 6261 636b 5f64 6179 7320 3d20 3330  okback_days = 30
+0000fb50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000fb60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000fb70: 2020 206d 6178 5f6c 6f6f 6b62 6163 6b5f     max_lookback_
+0000fb80: 6461 7973 203d 2036 300a 2020 2020 2020  days = 60.      
+0000fb90: 2020 2020 2020 6d61 785f 6c6f 6f6b 6261        max_lookba
+0000fba0: 636b 203d 2074 696d 6564 656c 7461 2864  ck = timedelta(d
+0000fbb0: 6179 733d 6d61 785f 6c6f 6f6b 6261 636b  ays=max_lookback
+0000fbc0: 5f64 6179 7329 0a20 2020 2020 2020 2020  _days).         
+0000fbd0: 2020 206d 6178 5f6c 6f6f 6b62 6163 6b20     max_lookback 
+0000fbe0: 2d3d 2074 696d 6564 656c 7461 286d 696e  -= timedelta(min
+0000fbf0: 7574 6573 3d35 2920 2023 2061 6c6c 6f77  utes=5)  # allow
+0000fc00: 2074 696d 6520 666f 7220 7365 7276 6572   time for server
+0000fc10: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
+0000fc20: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+0000fc30: 6172 745f 6d69 6e20 3d20 6474 5f6e 6f77  art_min = dt_now
+0000fc40: 5f6c 6f63 616c 202d 206d 6178 5f6c 6f6f  _local - max_loo
+0000fc50: 6b62 6163 6b0a 2020 2020 2020 2020 2020  kback.          
+0000fc60: 2020 6966 2073 656c 662e 696e 7472 6164    if self.intrad
+0000fc70: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+0000fc80: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+0000fc90: 6d69 6e20 3d20 6665 7463 685f 7374 6172  min = fetch_star
+0000fca0: 745f 6d69 6e2e 6365 696c 2822 3144 2229  t_min.ceil("1D")
+0000fcb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000fcc0: 682e 696e 6465 785b 305d 203c 2066 6574  h.index[0] < fet
+0000fcd0: 6368 5f73 7461 7274 5f6d 696e 3a0a 2020  ch_start_min:.  
+0000fce0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000fcf0: 685f 6f6c 6420 3d20 682e 6c6f 635b 3a66  h_old = h.loc[:f
+0000fd00: 6574 6368 5f73 7461 7274 5f6d 696e 2d74  etch_start_min-t
+0000fd10: 696d 6564 656c 7461 2873 6563 6f6e 6473  imedelta(seconds
+0000fd20: 3d31 295d 0a20 2020 2020 2020 2020 2020  =1)].           
+0000fd30: 2020 2020 2023 2068 5f6f 6c64 5f31 6420       # h_old_1d 
+0000fd40: 3d20 5f61 6767 7265 6761 7465 5f79 6664  = _aggregate_yfd
+0000fd50: 665f 6461 696c 7928 685f 6f6c 642e 6472  f_daily(h_old.dr
+0000fd60: 6f70 285b 2246 696e 616c 3f22 2c20 2243  op(["Final?", "C
+0000fd70: 2d43 6865 636b 3f22 2c20 224c 6173 7444  -Check?", "LastD
+0000fd80: 6976 4164 6a75 7374 4474 222c 2022 4c61  ivAdjustDt", "La
+0000fd90: 7374 5370 6c69 7441 646a 7573 7444 7422  stSplitAdjustDt"
+0000fda0: 5d2c 2061 7869 733d 3129 290a 0a20 2020  ], axis=1))..   
+0000fdb0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+0000fdc0: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+0000fdd0: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+0000fde0: 2e48 6f75 7273 313a 0a20 2020 2020 2020  .Hours1:.       
+0000fdf0: 2020 2020 2020 2020 2023 2020 2020 2064           #     d
+0000fe00: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
+0000fe10: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
+0000fe20: 3d22 3164 222c 2073 7461 7274 3d68 5f6f  ="1d", start=h_o
+0000fe30: 6c64 2e69 6e64 6578 5b30 5d2e 6461 7465  ld.index[0].date
+0000fe40: 2829 2c20 656e 643d 685f 6f6c 642e 696e  (), end=h_old.in
+0000fe50: 6465 785b 2d31 5d2e 6461 7465 2829 2b74  dex[-1].date()+t
+0000fe60: 645f 3164 2c20 6175 746f 5f61 646a 7573  d_1d, auto_adjus
+0000fe70: 743d 4661 6c73 652c 2072 6570 6169 723d  t=False, repair=
+0000fe80: 2273 696c 656e 7422 290a 2020 2020 2020  "silent").      
+0000fe90: 2020 2020 2020 2020 2020 2320 656c 7365            # else
+0000fea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000feb0: 2020 2320 2020 2020 6466 5f79 6620 3d20    #     df_yf = 
+0000fec0: 7365 6c66 2e64 6174 2e68 6973 746f 7279  self.dat.history
+0000fed0: 2869 6e74 6572 7661 6c3d 2231 6822 2c20  (interval="1h", 
+0000fee0: 7374 6172 743d 685f 6f6c 642e 696e 6465  start=h_old.inde
+0000fef0: 785b 305d 2e64 6174 6528 292c 2065 6e64  x[0].date(), end
+0000ff00: 3d68 5f6f 6c64 2e69 6e64 6578 5b2d 315d  =h_old.index[-1]
+0000ff10: 2e64 6174 6528 292b 7464 5f31 642c 2061  .date()+td_1d, a
+0000ff20: 7574 6f5f 6164 6a75 7374 3d46 616c 7365  uto_adjust=False
+0000ff30: 2c20 7265 7061 6972 3d22 7369 6c65 6e74  , repair="silent
+0000ff40: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0000ff50: 2020 2023 2020 2020 2064 665f 7966 203d     #     df_yf =
+0000ff60: 205f 6167 6772 6567 6174 655f 7966 6466   _aggregate_yfdf
+0000ff70: 5f64 6169 6c79 2864 665f 7966 290a 0a20  _daily(df_yf).. 
+0000ff80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000ff90: 2023 2041 6767 7265 6761 7465 6420 6461   # Aggregated da
+0000ffa0: 7461 2077 696c 6c20 616c 6d6f 7374 2061  ta will almost a
+0000ffb0: 6c77 6179 7320 6469 6666 6572 2066 726f  lways differ fro
+0000ffc0: 6d20 6163 7475 616c 2064 6169 6c79 2c20  m actual daily, 
+0000ffd0: 736f 206f 6e6c 790a 2020 2020 2020 2020  so only.        
+0000ffe0: 2020 2020 2020 2020 2320 2320 6c6f 6f6b          # # look
+0000fff0: 2066 6f72 2062 6967 2065 7272 6f72 730a   for big errors.
+00010000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010010: 2320 665f 6f6c 645f 6469 6666 203d 2079  # f_old_diff = y
+00010020: 6663 752e 5665 7269 6679 5072 6963 6573  fcu.VerifyPrices
+00010030: 4466 2868 5f6f 6c64 5f31 642c 2064 665f  Df(h_old_1d, df_
+00010040: 7966 2c20 7365 6c66 2e69 6e74 6572 7661  yf, self.interva
+00010050: 6c2c 2072 746f 6c3d 302e 322c 2064 6562  l, rtol=0.2, deb
+00010060: 7567 3d54 7275 6529 0a20 2020 2020 2020  ug=True).       
+00010070: 2020 2020 2020 2020 2023 2072 6169 7365           # raise
+00010080: 2045 7863 6570 7469 6f6e 2822 2d20 696e   Exception("- in
+00010090: 7665 7374 6967 6174 6522 290a 2020 2020  vestigate").    
+000100a0: 2020 2020 2020 2020 2020 2020 2320 665f              # f_
+000100b0: 6f6c 645f 6469 6666 203d 2079 6663 752e  old_diff = yfcu.
+000100c0: 5665 7269 6679 5072 6963 6573 4466 2868  VerifyPricesDf(h
+000100d0: 5f6f 6c64 5f31 642c 2064 665f 7966 2c20  _old_1d, df_yf, 
+000100e0: 7365 6c66 2e69 6e74 6572 7661 6c2c 2072  self.interval, r
+000100f0: 746f 6c3d 302e 3229 0a20 2020 2020 2020  tol=0.2).       
+00010100: 2020 2020 2020 2020 2023 2069 6620 665f           # if f_
+00010110: 6f6c 645f 6469 6666 2e61 6e79 2829 3a0a  old_diff.any():.
+00010120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010130: 2320 2020 2020 6d73 6720 3d20 6622 5369  #     msg = f"Si
+00010140: 676e 6966 6963 616e 7420 6469 6666 6572  gnificant differ
+00010150: 656e 6365 7320 6465 7465 6374 6564 2062  ences detected b
+00010160: 6574 7765 656e 206f 6c64 207b 7365 6c66  etween old {self
+00010170: 2e69 7374 727d 2064 6174 6120 616e 6420  .istr} data and 
+00010180: 3164 2e22 0a20 2020 2020 2020 2020 2020  1d.".           
+00010190: 2020 2020 2023 2020 2020 2070 7269 6e74       #     print
+000101a0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000101b0: 2020 2023 2020 2020 2023 2066 5f64 6966     #     # f_dif
+000101c0: 665f 616c 6c20 3d20 665f 6469 6666 5f61  f_all = f_diff_a
+000101d0: 6c6c 207c 2066 5f6f 6c64 5f64 6966 660a  ll | f_old_diff.
 000101e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101f0: 2320 685f 6f6c 645f 3164 203d 205f 6167  # h_old_1d = _ag
-00010200: 6772 6567 6174 655f 7966 6466 5f64 6169  gregate_yfdf_dai
-00010210: 6c79 2868 5f6f 6c64 2e64 726f 7028 5b22  ly(h_old.drop(["
-00010220: 4669 6e61 6c3f 222c 2022 432d 4368 6563  Final?", "C-Chec
-00010230: 6b3f 222c 2022 4c61 7374 4469 7641 646a  k?", "LastDivAdj
-00010240: 7573 7444 7422 2c20 224c 6173 7453 706c  ustDt", "LastSpl
-00010250: 6974 4164 6a75 7374 4474 225d 2c20 6178  itAdjustDt"], ax
-00010260: 6973 3d31 2929 0a0a 2020 2020 2020 2020  is=1))..        
-00010270: 2020 2020 2020 2020 2320 6966 2073 656c          # if sel
-00010280: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-00010290: 6364 2e49 6e74 6572 7661 6c2e 486f 7572  cd.Interval.Hour
-000102a0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-000102b0: 2020 2020 2320 2020 2020 6466 5f79 6620      #     df_yf 
-000102c0: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
-000102d0: 7279 2869 6e74 6572 7661 6c3d 2231 6422  ry(interval="1d"
-000102e0: 2c20 7374 6172 743d 685f 6f6c 642e 696e  , start=h_old.in
-000102f0: 6465 785b 305d 2e64 6174 6528 292c 2065  dex[0].date(), e
-00010300: 6e64 3d68 5f6f 6c64 2e69 6e64 6578 5b2d  nd=h_old.index[-
-00010310: 315d 2e64 6174 6528 292b 7464 5f31 642c  1].date()+td_1d,
-00010320: 2061 7574 6f5f 6164 6a75 7374 3d46 616c   auto_adjust=Fal
-00010330: 7365 2c20 7265 7061 6972 3d22 7369 6c65  se, repair="sile
-00010340: 6e74 2229 0a20 2020 2020 2020 2020 2020  nt").           
-00010350: 2020 2020 2023 2065 6c73 653a 0a20 2020       # else:.   
-00010360: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00010370: 2020 2064 665f 7966 203d 2073 656c 662e     df_yf = self.
-00010380: 6461 742e 6869 7374 6f72 7928 696e 7465  dat.history(inte
-00010390: 7276 616c 3d22 3168 222c 2073 7461 7274  rval="1h", start
-000103a0: 3d68 5f6f 6c64 2e69 6e64 6578 5b30 5d2e  =h_old.index[0].
-000103b0: 6461 7465 2829 2c20 656e 643d 685f 6f6c  date(), end=h_ol
-000103c0: 642e 696e 6465 785b 2d31 5d2e 6461 7465  d.index[-1].date
-000103d0: 2829 2b74 645f 3164 2c20 6175 746f 5f61  ()+td_1d, auto_a
-000103e0: 646a 7573 743d 4661 6c73 652c 2072 6570  djust=False, rep
-000103f0: 6169 723d 2273 696c 656e 7422 290a 2020  air="silent").  
-00010400: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010410: 2020 2020 6466 5f79 6620 3d20 5f61 6767      df_yf = _agg
-00010420: 7265 6761 7465 5f79 6664 665f 6461 696c  regate_yfdf_dail
-00010430: 7928 6466 5f79 6629 0a0a 2020 2020 2020  y(df_yf)..      
-00010440: 2020 2020 2020 2020 2020 2320 2320 4167            # # Ag
-00010450: 6772 6567 6174 6564 2064 6174 6120 7769  gregated data wi
-00010460: 6c6c 2061 6c6d 6f73 7420 616c 7761 7973  ll almost always
-00010470: 2064 6966 6665 7220 6672 6f6d 2061 6374   differ from act
-00010480: 7561 6c20 6461 696c 792c 2073 6f20 6f6e  ual daily, so on
-00010490: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
-000104a0: 2020 2023 2023 206c 6f6f 6b20 666f 7220     # # look for 
-000104b0: 6269 6720 6572 726f 7273 0a20 2020 2020  big errors.     
-000104c0: 2020 2020 2020 2020 2020 2023 2066 5f6f             # f_o
-000104d0: 6c64 5f64 6966 6620 3d20 7966 6375 2e56  ld_diff = yfcu.V
-000104e0: 6572 6966 7950 7269 6365 7344 6628 685f  erifyPricesDf(h_
-000104f0: 6f6c 645f 3164 2c20 6466 5f79 662c 2073  old_1d, df_yf, s
-00010500: 656c 662e 696e 7465 7276 616c 2c20 7274  elf.interval, rt
-00010510: 6f6c 3d30 2e32 2c20 6465 6275 673d 5472  ol=0.2, debug=Tr
-00010520: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00010530: 2020 2020 2320 7261 6973 6520 4578 6365      # raise Exce
-00010540: 7074 696f 6e28 222d 2069 6e76 6573 7469  ption("- investi
-00010550: 6761 7465 2229 0a20 2020 2020 2020 2020  gate").         
-00010560: 2020 2020 2020 2023 2066 5f6f 6c64 5f64         # f_old_d
-00010570: 6966 6620 3d20 7966 6375 2e56 6572 6966  iff = yfcu.Verif
-00010580: 7950 7269 6365 7344 6628 685f 6f6c 645f  yPricesDf(h_old_
-00010590: 3164 2c20 6466 5f79 662c 2073 656c 662e  1d, df_yf, self.
-000105a0: 696e 7465 7276 616c 2c20 7274 6f6c 3d30  interval, rtol=0
-000105b0: 2e32 290a 2020 2020 2020 2020 2020 2020  .2).            
-000105c0: 2020 2020 2320 6966 2066 5f6f 6c64 5f64      # if f_old_d
-000105d0: 6966 662e 616e 7928 293a 0a20 2020 2020  iff.any():.     
-000105e0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-000105f0: 206d 7367 203d 2066 2253 6967 6e69 6669   msg = f"Signifi
-00010600: 6361 6e74 2064 6966 6665 7265 6e63 6573  cant differences
-00010610: 2064 6574 6563 7465 6420 6265 7477 6565   detected betwee
-00010620: 6e20 6f6c 6420 7b73 656c 662e 6973 7472  n old {self.istr
-00010630: 7d20 6461 7461 2061 6e64 2031 642e 220a  } data and 1d.".
-00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010650: 2320 2020 2020 7072 696e 7428 290a 2020  #     print().  
-00010660: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010670: 2020 2020 2320 665f 6469 6666 5f61 6c6c      # f_diff_all
-00010680: 203d 2066 5f64 6966 665f 616c 6c20 7c20   = f_diff_all | 
-00010690: 665f 6f6c 645f 6469 6666 0a20 2020 2020  f_old_diff.     
-000106a0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-000106b0: 2062 6164 5f64 6174 6573 203d 2066 5f6f   bad_dates = f_o
-000106c0: 6c64 5f64 6966 662e 696e 6465 782e 6461  ld_diff.index.da
-000106d0: 7465 5b66 5f6f 6c64 5f64 6966 665d 0a20  te[f_old_diff]. 
-000106e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000106f0: 2020 2020 2066 5f64 6966 665f 616c 6c5b       f_diff_all[
-00010700: 6e70 2e69 7369 6e28 665f 6469 6666 5f61  np.isin(f_diff_a
-00010710: 6c6c 2e69 6e64 6578 2e64 6174 652c 2062  ll.index.date, b
-00010720: 6164 5f64 6174 6573 295d 203d 2054 7275  ad_dates)] = Tru
-00010730: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-00010740: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-00010750: 616e 6365 2864 6973 6361 7264 5f6f 6c64  ance(discard_old
-00010760: 2c20 626f 6f6c 293a 0a20 2020 2020 2020  , bool):.       
-00010770: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00010780: 203d 2066 227b 7365 6c66 2e74 6963 6b65   = f"{self.ticke
-00010790: 727d 3a20 536f 6d65 207b 7365 6c66 2e69  r}: Some {self.i
-000107a0: 7374 727d 2064 6174 6120 6973 206e 6f77  str} data is now
-000107b0: 206f 6c64 6572 2074 6861 6e20 7b6d 6178   older than {max
-000107c0: 5f6c 6f6f 6b62 6163 6b5f 6461 7973 7d20  _lookback_days} 
-000107d0: 6461 7973 2220 2b5c 0a20 2020 2020 2020  days" +\.       
+000101f0: 2320 2020 2020 6261 645f 6461 7465 7320  #     bad_dates 
+00010200: 3d20 665f 6f6c 645f 6469 6666 2e69 6e64  = f_old_diff.ind
+00010210: 6578 2e64 6174 655b 665f 6f6c 645f 6469  ex.date[f_old_di
+00010220: 6666 5d0a 2020 2020 2020 2020 2020 2020  ff].            
+00010230: 2020 2020 2320 2020 2020 665f 6469 6666      #     f_diff
+00010240: 5f61 6c6c 5b6e 702e 6973 696e 2866 5f64  _all[np.isin(f_d
+00010250: 6966 665f 616c 6c2e 696e 6465 782e 6461  iff_all.index.da
+00010260: 7465 2c20 6261 645f 6461 7465 7329 5d20  te, bad_dates)] 
+00010270: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
+00010280: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00010290: 7369 6e73 7461 6e63 6528 6469 7363 6172  sinstance(discar
+000102a0: 645f 6f6c 642c 2062 6f6f 6c29 3a0a 2020  d_old, bool):.  
+000102b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102c0: 2020 6d73 6720 3d20 6622 7b73 656c 662e    msg = f"{self.
+000102d0: 7469 636b 6572 7d3a 2053 6f6d 6520 7b73  ticker}: Some {s
+000102e0: 656c 662e 6973 7472 7d20 6461 7461 2069  elf.istr} data i
+000102f0: 7320 6e6f 7720 6f6c 6465 7220 7468 616e  s now older than
+00010300: 207b 6d61 785f 6c6f 6f6b 6261 636b 5f64   {max_lookback_d
+00010310: 6179 737d 2064 6179 7322 202b 5c0a 2020  ays} days" +\.  
+00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010330: 2020 2020 2020 2020 2020 2220 736f 2063            " so c
+00010340: 616e 6e6f 7420 636f 6d70 6172 6520 746f  annot compare to
+00010350: 2059 6168 6f6f 2e20 4469 7363 6172 6420   Yahoo. Discard 
+00010360: 6f6c 6420 6461 7461 3f22 0a20 2020 2020  old data?".     
+00010370: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00010380: 6973 6361 7264 5f6f 6c64 203d 2063 6c69  iscard_old = cli
+00010390: 636b 2e63 6f6e 6669 726d 286d 7367 2c20  ck.confirm(msg, 
+000103a0: 6465 6661 756c 743d 4661 6c73 6529 0a20  default=False). 
+000103b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000103c0: 6620 6469 7363 6172 645f 6f6c 643a 0a20  f discard_old:. 
+000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103e0: 2020 2066 5f64 6973 6361 7264 203d 2070     f_discard = p
+000103f0: 642e 5365 7269 6573 2868 2e69 6e64 6578  d.Series(h.index
+00010400: 203c 2066 6574 6368 5f73 7461 7274 5f6d   < fetch_start_m
+00010410: 696e 2c20 682e 696e 6465 7829 0a20 2020  in, h.index).   
+00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010430: 2069 6620 665f 6469 7363 6172 642e 616e   if f_discard.an
+00010440: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+00010450: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00010460: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
+00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010480: 2020 2070 7269 6e74 2866 2244 6973 6361     print(f"Disca
+00010490: 7264 696e 6720 7b6e 702e 7375 6d28 665f  rding {np.sum(f_
+000104a0: 6469 7363 6172 6429 7d2f 7b6e 7d20 6f6c  discard)}/{n} ol
+000104b0: 6420 726f 7773 2062 6563 6175 7365 2063  d rows because c
+000104c0: 616e 2774 2076 6572 6966 7920 2866 6574  an't verify (fet
+000104d0: 6368 5f73 7461 7274 5f6d 696e 3d7b 6665  ch_start_min={fe
+000104e0: 7463 685f 7374 6172 745f 6d69 6e7d 2922  tch_start_min})"
+000104f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010500: 2020 2020 2020 2020 2020 665f 6469 6666            f_diff
+00010510: 5f61 6c6c 203d 2066 5f64 6966 665f 616c  _all = f_diff_al
+00010520: 6c20 7c20 665f 6469 7363 6172 640a 2020  l | f_discard.  
+00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010540: 2020 2020 2020 665f 6469 6666 5f61 6c6c        f_diff_all
+00010550: 203d 2066 5f64 6966 665f 616c 6c2e 7265   = f_diff_all.re
+00010560: 6e61 6d65 2822 4469 7363 6172 6422 290a  name("Discard").
+00010570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010580: 2068 203d 2068 2e6c 6f63 5b66 6574 6368   h = h.loc[fetch
+00010590: 5f73 7461 7274 5f6d 696e 3a5d 0a0a 2020  _start_min:]..  
+000105a0: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+000105b0: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+000105c0: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
+000105d0: 2020 2020 2020 2020 2020 2023 2041 6c73             # Als
+000105e0: 6f20 7665 7269 6679 2064 6976 6964 656e  o verify dividen
+000105f0: 6473 0a20 2020 2020 2020 2020 2020 2064  ds.            d
+00010600: 6976 735f 6466 203d 2073 656c 662e 6d61  ivs_df = self.ma
+00010610: 6e61 6765 722e 4765 7448 6973 746f 7279  nager.GetHistory
+00010620: 2822 4576 656e 7473 2229 2e47 6574 4469  ("Events").GetDi
+00010630: 7673 2829 0a20 2020 2020 2020 2020 2020  vs().           
+00010640: 2069 6620 6469 7673 5f64 6620 6973 206e   if divs_df is n
+00010650: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00010660: 2020 2020 2020 2020 2064 6976 735f 6466           divs_df
+00010670: 203d 2064 6976 735f 6466 5b28 6469 7673   = divs_df[(divs
+00010680: 5f64 665b 2744 6976 6964 656e 6473 275d  _df['Dividends']
+00010690: 213d 302e 3029 2e74 6f5f 6e75 6d70 7928  !=0.0).to_numpy(
+000106a0: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
+000106b0: 2020 2069 6620 6469 7673 5f64 662e 656d     if divs_df.em
+000106c0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+000106d0: 2020 2020 2020 2020 2064 6976 735f 6466           divs_df
+000106e0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+000106f0: 2069 6620 6e6f 7420 682e 656d 7074 793a   if not h.empty:
+00010700: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00010710: 6574 6368 2059 4620 6461 7461 0a20 2020  etch YF data.   
+00010720: 2020 2020 2020 2020 2073 7461 7274 5f64           start_d
+00010730: 7420 3d20 682e 696e 6465 785b 305d 0a20  t = h.index[0]. 
+00010740: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+00010750: 6474 203d 2068 2e69 6e64 6578 5b2d 315d  dt = h.index[-1]
+00010760: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+00010770: 5f64 7420 3d20 6c61 7374 5f64 7420 2b20  _dt = last_dt + 
+00010780: 7365 6c66 2e69 7464 0a20 2020 2020 2020  self.itd.       
+00010790: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
+000107a0: 203d 2073 7461 7274 5f64 742e 6461 7465   = start_dt.date
+000107b0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+000107c0: 6620 7365 6c66 2e69 7464 203e 2074 696d  f self.itd > tim
+000107d0: 6564 656c 7461 2864 6179 733d 3129 3a0a  edelta(days=1):.
 000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107f0: 2020 2020 2022 2073 6f20 6361 6e6e 6f74       " so cannot
-00010800: 2063 6f6d 7061 7265 2074 6f20 5961 686f   compare to Yaho
-00010810: 6f2e 2044 6973 6361 7264 206f 6c64 2064  o. Discard old d
-00010820: 6174 613f 220a 2020 2020 2020 2020 2020  ata?".          
-00010830: 2020 2020 2020 2020 2020 6469 7363 6172            discar
-00010840: 645f 6f6c 6420 3d20 636c 6963 6b2e 636f  d_old = click.co
-00010850: 6e66 6972 6d28 6d73 672c 2064 6566 6175  nfirm(msg, defau
-00010860: 6c74 3d46 616c 7365 290a 2020 2020 2020  lt=False).      
-00010870: 2020 2020 2020 2020 2020 6966 2064 6973            if dis
-00010880: 6361 7264 5f6f 6c64 3a0a 2020 2020 2020  card_old:.      
-00010890: 2020 2020 2020 2020 2020 2020 2020 665f                f_
-000108a0: 6469 7363 6172 6420 3d20 7064 2e53 6572  discard = pd.Ser
-000108b0: 6965 7328 682e 696e 6465 7820 3c20 6665  ies(h.index < fe
-000108c0: 7463 685f 7374 6172 745f 6d69 6e2c 2068  tch_start_min, h
-000108d0: 2e69 6e64 6578 290a 2020 2020 2020 2020  .index).        
-000108e0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000108f0: 5f64 6973 6361 7264 2e61 6e79 2829 3a0a  _discard.any():.
-00010900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010910: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-00010920: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010930: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00010940: 696e 7428 6622 4469 7363 6172 6469 6e67  int(f"Discarding
-00010950: 207b 6e70 2e73 756d 2866 5f64 6973 6361   {np.sum(f_disca
-00010960: 7264 297d 2f7b 6e7d 206f 6c64 2072 6f77  rd)}/{n} old row
-00010970: 7320 6265 6361 7573 6520 6361 6e27 7420  s because can't 
-00010980: 7665 7269 6679 2028 6665 7463 685f 7374  verify (fetch_st
-00010990: 6172 745f 6d69 6e3d 7b66 6574 6368 5f73  art_min={fetch_s
-000109a0: 7461 7274 5f6d 696e 7d29 2229 0a20 2020  tart_min})").   
-000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109c0: 2020 2020 2066 5f64 6966 665f 616c 6c20       f_diff_all 
-000109d0: 3d20 665f 6469 6666 5f61 6c6c 207c 2066  = f_diff_all | f
-000109e0: 5f64 6973 6361 7264 0a20 2020 2020 2020  _discard.       
-000109f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a00: 2066 5f64 6966 665f 616c 6c20 3d20 665f   f_diff_all = f_
-00010a10: 6469 6666 5f61 6c6c 2e72 656e 616d 6528  diff_all.rename(
-00010a20: 2244 6973 6361 7264 2229 0a0a 2020 2020  "Discard")..    
-00010a30: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
-00010a40: 682e 6c6f 635b 6665 7463 685f 7374 6172  h.loc[fetch_star
-00010a50: 745f 6d69 6e3a 5d0a 0a20 2020 2020 2020  t_min:]..       
-00010a60: 2069 6620 6e6f 7420 682e 656d 7074 793a   if not h.empty:
-00010a70: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00010a80: 6574 6368 2059 4620 6461 7461 0a20 2020  etch YF data.   
-00010a90: 2020 2020 2020 2020 2073 7461 7274 5f64           start_d
-00010aa0: 7420 3d20 682e 696e 6465 785b 305d 0a20  t = h.index[0]. 
-00010ab0: 2020 2020 2020 2020 2020 206c 6173 745f             last_
-00010ac0: 6474 203d 2068 2e69 6e64 6578 5b2d 315d  dt = h.index[-1]
-00010ad0: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-00010ae0: 5f64 7420 3d20 6c61 7374 5f64 7420 2b20  _dt = last_dt + 
-00010af0: 7365 6c66 2e69 7464 0a20 2020 2020 2020  self.itd.       
-00010b00: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
-00010b10: 203d 2073 7461 7274 5f64 742e 6461 7465   = start_dt.date
-00010b20: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-00010b30: 6620 7365 6c66 2e69 7464 203e 2074 696d  f self.itd > tim
-00010b40: 6564 656c 7461 2864 6179 733d 3129 3a0a  edelta(days=1):.
-00010b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b60: 6665 7463 685f 656e 6420 3d20 6c61 7374  fetch_end = last
-00010b70: 5f64 742e 6461 7465 2829 2b79 6663 642e  _dt.date()+yfcd.
-00010b80: 696e 7465 7276 616c 546f 5469 6d65 6465  intervalToTimede
-00010b90: 6c74 615b 7365 6c66 2e69 6e74 6572 7661  lta[self.interva
-00010ba0: 6c5d 0a20 2020 2020 2020 2020 2020 2065  l].            e
-00010bb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00010bc0: 2020 2020 2066 6574 6368 5f65 6e64 203d       fetch_end =
-00010bd0: 206c 6173 745f 6474 2e64 6174 6528 292b   last_dt.date()+
-00010be0: 7464 5f31 640a 2020 2020 2020 2020 2020  td_1d.          
-00010bf0: 2020 2320 536f 6d65 7469 6d65 7320 5961    # Sometimes Ya
-00010c00: 686f 6f20 646f 6573 6e27 7420 7265 7475  hoo doesn't retu
-00010c10: 726e 2066 756c 6c20 7472 6164 696e 6720  rn full trading 
-00010c20: 6461 7461 2066 6f72 206c 6173 7420 6461  data for last da
-00010c30: 7920 6966 2065 6e64 203d 2064 6179 2061  y if end = day a
-00010c40: 6674 6572 2e0a 2020 2020 2020 2020 2020  fter..          
-00010c50: 2020 2320 4164 6420 736f 6d65 206d 6f72    # Add some mor
-00010c60: 6520 6461 7973 2074 6f20 6176 6f69 6420  e days to avoid 
-00010c70: 7072 6f62 6c65 6d2e 0a20 2020 2020 2020  problem..       
-00010c80: 2020 2020 2066 6574 6368 5f65 6e64 202b       fetch_end +
-00010c90: 3d20 332a 7464 5f31 640a 2020 2020 2020  = 3*td_1d.      
-00010ca0: 2020 2020 2020 6665 7463 685f 656e 6420        fetch_end 
-00010cb0: 3d20 6d69 6e28 6665 7463 685f 656e 642c  = min(fetch_end,
-00010cc0: 2064 745f 6e6f 772e 747a 5f63 6f6e 7665   dt_now.tz_conve
-00010cd0: 7274 2873 656c 662e 747a 4e61 6d65 292e  rt(self.tzName).
-00010ce0: 6365 696c 2822 4422 292e 6461 7465 2829  ceil("D").date()
-00010cf0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00010d00: 7061 6972 203d 2054 7275 650a 2020 2020  pair = True.    
-00010d10: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00010d20: 696e 7472 6164 6179 3a0a 2020 2020 2020  intraday:.      
-00010d30: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00010d40: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-00010d50: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
-00010d60: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00010d70: 2020 2020 2020 2023 2046 6574 6368 2069         # Fetch i
-00010d80: 6e20 372d 6461 7920 6261 7463 6865 730a  n 7-day batches.
-00010d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010da0: 2020 2020 6466 5f79 6620 3d20 4e6f 6e65      df_yf = None
-00010db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010dc0: 2020 2020 2074 645f 3764 203d 2074 696d       td_7d = tim
-00010dd0: 6564 656c 7461 2864 6179 733d 3729 0a20  edelta(days=7). 
-00010de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010df0: 2020 2066 6574 6368 5f65 6e64 5f62 6174     fetch_end_bat
-00010e00: 6368 203d 2066 6574 6368 5f65 6e64 0a20  ch = fetch_end. 
-00010e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e20: 2020 2066 6574 6368 5f73 7461 7274 5f62     fetch_start_b
-00010e30: 6174 6368 203d 2066 6574 6368 5f65 6e64  atch = fetch_end
-00010e40: 202d 2074 645f 3764 0a20 2020 2020 2020   - td_7d.       
-00010e50: 2020 2020 2020 2020 2020 2020 2077 6869               whi
-00010e60: 6c65 2066 6574 6368 5f65 6e64 5f62 6174  le fetch_end_bat
-00010e70: 6368 203e 2066 6574 6368 5f73 7461 7274  ch > fetch_start
-00010e80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010e90: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
-00010ea0: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
-00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ec0: 6d73 6720 3d20 6622 7265 7175 6573 7469  msg = f"requesti
-00010ed0: 6e67 2059 4620 6665 7463 683a 207b 7365  ng YF fetch: {se
-00010ee0: 6c66 2e69 7374 727d 207b 6665 7463 685f  lf.istr} {fetch_
-00010ef0: 7374 6172 745f 6261 7463 687d 202d 3e20  start_batch} -> 
-00010f00: 7b66 6574 6368 5f65 6e64 5f62 6174 6368  {fetch_end_batch
-00010f10: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00010f20: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00010f30: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-00010f40: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-00010f50: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-00010f60: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
-00010f70: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-00010f80: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-00010f90: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
-00010fa0: 665f 6261 7463 6820 3d20 7365 6c66 2e64  f_batch = self.d
-00010fb0: 6174 2e68 6973 746f 7279 2869 6e74 6572  at.history(inter
-00010fc0: 7661 6c3d 7365 6c66 2e69 7374 722c 2073  val=self.istr, s
-00010fd0: 7461 7274 3d66 6574 6368 5f73 7461 7274  tart=fetch_start
-00010fe0: 5f62 6174 6368 2c20 656e 643d 6665 7463  _batch, end=fetc
-00010ff0: 685f 656e 645f 6261 7463 682c 2061 7574  h_end_batch, aut
-00011000: 6f5f 6164 6a75 7374 3d46 616c 7365 2c20  o_adjust=False, 
-00011010: 7265 7061 6972 3d72 6570 6169 722c 206b  repair=repair, k
-00011020: 6565 706e 613d 5472 7565 290a 2020 2020  eepna=True).    
-00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011040: 2020 2020 6966 2022 5265 7061 6972 6564      if "Repaired
-00011050: 3f22 206e 6f74 2069 6e20 6466 5f79 665f  ?" not in df_yf_
-00011060: 6261 7463 682e 636f 6c75 6d6e 733a 0a20  batch.columns:. 
-00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011080: 2020 2020 2020 2020 2020 2064 665f 7966             df_yf
-00011090: 5f62 6174 6368 5b22 5265 7061 6972 6564  _batch["Repaired
-000110a0: 3f22 5d20 3d20 4661 6c73 650a 2020 2020  ?"] = False.    
-000110b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110c0: 2020 2020 6966 2064 665f 7966 2069 7320      if df_yf is 
-000110d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110f0: 2020 6466 5f79 6620 3d20 6466 5f79 665f    df_yf = df_yf_
-00011100: 6261 7463 680a 2020 2020 2020 2020 2020  batch.          
-00011110: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00011120: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011140: 6466 5f79 6620 3d20 7064 2e63 6f6e 6361  df_yf = pd.conca
-00011150: 7428 5b64 665f 7966 2c20 6466 5f79 665f  t([df_yf, df_yf_
-00011160: 6261 7463 685d 2c20 6178 6973 3d30 290a  batch], axis=0).
-00011170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011180: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00011190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111a0: 2020 6665 7463 685f 656e 645f 6261 7463    fetch_end_batc
-000111b0: 6820 2d3d 2074 645f 3764 0a20 2020 2020  h -= td_7d.     
-000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111d0: 2020 2066 6574 6368 5f73 7461 7274 5f62     fetch_start_b
-000111e0: 6174 6368 202d 3d20 7464 5f37 640a 2020  atch -= td_7d.  
-000111f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011200: 2020 2020 2020 6665 7463 685f 7374 6172        fetch_star
-00011210: 745f 6261 7463 6820 3d20 6d61 7828 6665  t_batch = max(fe
-00011220: 7463 685f 7374 6172 745f 6261 7463 682c  tch_start_batch,
-00011230: 2066 6574 6368 5f73 7461 7274 290a 2020   fetch_start).  
-00011240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011250: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
-00011260: 2020 2020 2020 2020 6466 5f79 6620 3d20          df_yf = 
-00011270: 6466 5f79 662e 736f 7274 5f69 6e64 6578  df_yf.sort_index
-00011280: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00011290: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000112a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000112b0: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-000112c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000112d0: 7367 203d 2066 2272 6571 7565 7374 696e  sg = f"requestin
-000112e0: 6720 5946 2066 6574 6368 3a20 7b73 656c  g YF fetch: {sel
-000112f0: 662e 6973 7472 7d20 7b66 6574 6368 5f73  f.istr} {fetch_s
-00011300: 7461 7274 7d20 2d3e 207b 6665 7463 685f  tart} -> {fetch_
-00011310: 656e 647d 220a 2020 2020 2020 2020 2020  end}".          
-00011320: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00011330: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-00011340: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-00011350: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-00011360: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-00011370: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-00011380: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00011390: 2020 2020 2020 2064 665f 7966 203d 2073         df_yf = s
-000113a0: 656c 662e 6461 742e 6869 7374 6f72 7928  elf.dat.history(
-000113b0: 696e 7465 7276 616c 3d73 656c 662e 6973  interval=self.is
-000113c0: 7472 2c20 7374 6172 743d 6665 7463 685f  tr, start=fetch_
-000113d0: 7374 6172 742c 2065 6e64 3d66 6574 6368  start, end=fetch
-000113e0: 5f65 6e64 2c20 6175 746f 5f61 646a 7573  _end, auto_adjus
-000113f0: 743d 4661 6c73 652c 2072 6570 6169 723d  t=False, repair=
-00011400: 7265 7061 6972 2c20 6b65 6570 6e61 3d54  repair, keepna=T
-00011410: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00011420: 2020 2020 2020 2020 2069 6620 2252 6570           if "Rep
-00011430: 6169 7265 643f 2220 6e6f 7420 696e 2064  aired?" not in d
-00011440: 665f 7966 2e63 6f6c 756d 6e73 3a0a 2020  f_yf.columns:.  
-00011450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011460: 2020 2020 2020 6466 5f79 665b 2252 6570        df_yf["Rep
-00011470: 6169 7265 643f 225d 203d 2046 616c 7365  aired?"] = False
-00011480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011490: 2020 2020 2064 665f 7966 203d 2064 665f       df_yf = df_
-000114a0: 7966 2e6c 6f63 5b73 7461 7274 5f64 743a  yf.loc[start_dt:
-000114b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000114c0: 2020 2020 2020 6466 5f79 6620 3d20 6466        df_yf = df
-000114d0: 5f79 665b 6466 5f79 662e 696e 6465 7820  _yf[df_yf.index 
-000114e0: 3c20 656e 645f 6474 5d0a 0a20 2020 2020  < end_dt]..     
-000114f0: 2020 2020 2020 2020 2020 2023 2059 6168             # Yah
-00011500: 6f6f 2064 6f65 736e 2774 2064 6976 2d61  oo doesn't div-a
-00011510: 646a 7573 7420 696e 7472 6164 6179 0a20  djust intraday. 
-00011520: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00011530: 665f 7966 5f31 6420 3d20 7365 6c66 2e64  f_yf_1d = self.d
-00011540: 6174 2e68 6973 746f 7279 2869 6e74 6572  at.history(inter
-00011550: 7661 6c3d 2231 6422 2c20 7374 6172 743d  val="1d", start=
-00011560: 6466 5f79 662e 696e 6465 785b 305d 2e64  df_yf.index[0].d
-00011570: 6174 6528 292c 2065 6e64 3d64 665f 7966  ate(), end=df_yf
-00011580: 2e69 6e64 6578 5b2d 315d 2e64 6174 6528  .index[-1].date(
-00011590: 292b 7464 5f31 642c 2061 7574 6f5f 6164  )+td_1d, auto_ad
-000115a0: 6a75 7374 3d46 616c 7365 290a 2020 2020  just=False).    
-000115b0: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-000115c0: 5265 7061 6972 6564 3f22 206e 6f74 2069  Repaired?" not i
-000115d0: 6e20 6466 5f79 665f 3164 2e63 6f6c 756d  n df_yf_1d.colum
-000115e0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000115f0: 2020 2020 2020 2020 6466 5f79 665f 3164          df_yf_1d
-00011600: 5b22 5265 7061 6972 6564 3f22 5d20 3d20  ["Repaired?"] = 
-00011610: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00011620: 2020 2020 2020 6466 5f79 665b 225f 696e        df_yf["_in
-00011630: 6465 7842 6163 6b75 7022 5d20 3d20 6466  dexBackup"] = df
-00011640: 5f79 662e 696e 6465 780a 2020 2020 2020  _yf.index.      
-00011650: 2020 2020 2020 2020 2020 6466 5f79 665b            df_yf[
-00011660: 225f 6461 7465 225d 203d 2064 665f 7966  "_date"] = df_yf
-00011670: 2e69 6e64 6578 2e64 6174 650a 2020 2020  .index.date.    
-00011680: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
-00011690: 665f 3164 5b22 5f64 6174 6522 5d20 3d20  f_1d["_date"] = 
-000116a0: 6466 5f79 665f 3164 2e69 6e64 6578 2e64  df_yf_1d.index.d
-000116b0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000116c0: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
-000116d0: 2020 2020 2020 6466 5f79 665f 3164 5b22        df_yf_1d["
-000116e0: 4164 6a22 5d20 3d20 6466 5f79 665f 3164  Adj"] = df_yf_1d
-000116f0: 5b22 4164 6a20 436c 6f73 6522 5d2e 746f  ["Adj Close"].to
-00011700: 5f6e 756d 7079 2829 202f 2064 665f 7966  _numpy() / df_yf
-00011710: 5f31 645b 2243 6c6f 7365 225d 2e74 6f5f  _1d["Close"].to_
-00011720: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-00011730: 2020 2020 2020 2020 6466 5f79 6620 3d20          df_yf = 
-00011740: 6466 5f79 662e 6d65 7267 6528 6466 5f79  df_yf.merge(df_y
-00011750: 665f 3164 5b5b 2241 646a 222c 2022 5f64  f_1d[["Adj", "_d
-00011760: 6174 6522 5d5d 2c20 686f 773d 226c 6566  ate"]], how="lef
-00011770: 7422 2c20 6f6e 3d22 5f64 6174 6522 290a  t", on="_date").
-00011780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011790: 6466 5f79 665b 2241 646a 2043 6c6f 7365  df_yf["Adj Close
-000117a0: 225d 203d 2064 665f 7966 5b22 436c 6f73  "] = df_yf["Clos
-000117b0: 6522 5d2e 746f 5f6e 756d 7079 2829 202a  e"].to_numpy() *
-000117c0: 2064 665f 7966 5b22 4164 6a22 5d2e 746f   df_yf["Adj"].to
-000117d0: 5f6e 756d 7079 2829 0a20 2020 2020 2020  _numpy().       
-000117e0: 2020 2020 2020 2020 2064 665f 7966 203d           df_yf =
-000117f0: 2064 665f 7966 2e64 726f 7028 2241 646a   df_yf.drop("Adj
-00011800: 222c 2061 7869 733d 3129 0a20 2020 2020  ", axis=1).     
-00011810: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
-00011820: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00011830: 7966 2e69 6e64 6578 203d 2064 665f 7966  yf.index = df_yf
-00011840: 5b22 5f69 6e64 6578 4261 636b 7570 225d  ["_indexBackup"]
-00011850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011860: 2064 665f 7966 203d 2064 665f 7966 2e64   df_yf = df_yf.d
-00011870: 726f 7028 5b22 5f69 6e64 6578 4261 636b  rop(["_indexBack
-00011880: 7570 222c 2022 5f64 6174 6522 5d2c 2061  up", "_date"], a
-00011890: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
-000118a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000118b0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-000118c0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-000118d0: 2020 2020 2020 206d 7367 203d 2066 2272         msg = f"r
-000118e0: 6571 7565 7374 696e 6720 5946 2066 6574  equesting YF fet
-000118f0: 6368 3a20 7b73 656c 662e 6973 7472 7d20  ch: {self.istr} 
-00011900: 7b66 6574 6368 5f73 7461 7274 7d20 2d3e  {fetch_start} ->
-00011910: 207b 6665 7463 685f 656e 647d 220a 2020   {fetch_end}".  
+000107f0: 6665 7463 685f 656e 6420 3d20 6c61 7374  fetch_end = last
+00010800: 5f64 742e 6461 7465 2829 2b79 6663 642e  _dt.date()+yfcd.
+00010810: 696e 7465 7276 616c 546f 5469 6d65 6465  intervalToTimede
+00010820: 6c74 615b 7365 6c66 2e69 6e74 6572 7661  lta[self.interva
+00010830: 6c5d 0a20 2020 2020 2020 2020 2020 2065  l].            e
+00010840: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00010850: 2020 2020 2066 6574 6368 5f65 6e64 203d       fetch_end =
+00010860: 206c 6173 745f 6474 2e64 6174 6528 292b   last_dt.date()+
+00010870: 7464 5f31 640a 2020 2020 2020 2020 2020  td_1d.          
+00010880: 2020 2320 536f 6d65 7469 6d65 7320 5961    # Sometimes Ya
+00010890: 686f 6f20 646f 6573 6e27 7420 7265 7475  hoo doesn't retu
+000108a0: 726e 2066 756c 6c20 7472 6164 696e 6720  rn full trading 
+000108b0: 6461 7461 2066 6f72 206c 6173 7420 6461  data for last da
+000108c0: 7920 6966 2065 6e64 203d 2064 6179 2061  y if end = day a
+000108d0: 6674 6572 2e0a 2020 2020 2020 2020 2020  fter..          
+000108e0: 2020 2320 4164 6420 736f 6d65 206d 6f72    # Add some mor
+000108f0: 6520 6461 7973 2074 6f20 6176 6f69 6420  e days to avoid 
+00010900: 7072 6f62 6c65 6d2e 0a20 2020 2020 2020  problem..       
+00010910: 2020 2020 2066 6574 6368 5f65 6e64 202b       fetch_end +
+00010920: 3d20 332a 7464 5f31 640a 2020 2020 2020  = 3*td_1d.      
+00010930: 2020 2020 2020 6665 7463 685f 656e 6420        fetch_end 
+00010940: 3d20 6d69 6e28 6665 7463 685f 656e 642c  = min(fetch_end,
+00010950: 2064 745f 6e6f 772e 747a 5f63 6f6e 7665   dt_now.tz_conve
+00010960: 7274 2873 656c 662e 747a 4e61 6d65 292e  rt(self.tzName).
+00010970: 6365 696c 2822 4422 292e 6461 7465 2829  ceil("D").date()
+00010980: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00010990: 7061 6972 203d 2054 7275 650a 2020 2020  pair = True.    
+000109a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000109b0: 696e 7472 6164 6179 3a0a 2020 2020 2020  intraday:.      
+000109c0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000109d0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+000109e0: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+000109f0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00010a00: 2020 2020 2020 2023 2046 6574 6368 2069         # Fetch i
+00010a10: 6e20 372d 6461 7920 6261 7463 6865 730a  n 7-day batches.
+00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a30: 2020 2020 6466 5f79 6620 3d20 4e6f 6e65      df_yf = None
+00010a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010a50: 2020 2020 2074 645f 3764 203d 2074 696d       td_7d = tim
+00010a60: 6564 656c 7461 2864 6179 733d 3729 0a20  edelta(days=7). 
+00010a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a80: 2020 2066 6574 6368 5f65 6e64 5f62 6174     fetch_end_bat
+00010a90: 6368 203d 2066 6574 6368 5f65 6e64 0a20  ch = fetch_end. 
+00010aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ab0: 2020 2066 6574 6368 5f73 7461 7274 5f62     fetch_start_b
+00010ac0: 6174 6368 203d 2066 6574 6368 5f65 6e64  atch = fetch_end
+00010ad0: 202d 2074 645f 3764 0a20 2020 2020 2020   - td_7d.       
+00010ae0: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+00010af0: 6c65 2066 6574 6368 5f65 6e64 5f62 6174  le fetch_end_bat
+00010b00: 6368 203e 2066 6574 6368 5f73 7461 7274  ch > fetch_start
+00010b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010b20: 2020 2020 2020 2020 2020 6466 5f79 665f            df_yf_
+00010b30: 6261 7463 6820 3d20 7365 6c66 2e64 6174  batch = self.dat
+00010b40: 2e68 6973 746f 7279 2869 6e74 6572 7661  .history(interva
+00010b50: 6c3d 7365 6c66 2e69 7374 722c 2073 7461  l=self.istr, sta
+00010b60: 7274 3d66 6574 6368 5f73 7461 7274 5f62  rt=fetch_start_b
+00010b70: 6174 6368 2c20 656e 643d 6665 7463 685f  atch, end=fetch_
+00010b80: 656e 645f 6261 7463 682c 2061 7574 6f5f  end_batch, auto_
+00010b90: 6164 6a75 7374 3d46 616c 7365 2c20 7265  adjust=False, re
+00010ba0: 7061 6972 3d72 6570 6169 722c 206b 6565  pair=repair, kee
+00010bb0: 706e 613d 5472 7565 290a 2020 2020 2020  pna=True).      
+00010bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bd0: 2020 6966 2022 5265 7061 6972 6564 3f22    if "Repaired?"
+00010be0: 206e 6f74 2069 6e20 6466 5f79 665f 6261   not in df_yf_ba
+00010bf0: 7463 682e 636f 6c75 6d6e 733a 0a20 2020  tch.columns:.   
+00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c10: 2020 2020 2020 2020 2064 665f 7966 5f62           df_yf_b
+00010c20: 6174 6368 5b22 5265 7061 6972 6564 3f22  atch["Repaired?"
+00010c30: 5d20 3d20 4661 6c73 650a 2020 2020 2020  ] = False.      
+00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c50: 2020 6966 2064 665f 7966 2069 7320 4e6f    if df_yf is No
+00010c60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c80: 6466 5f79 6620 3d20 6466 5f79 665f 6261  df_yf = df_yf_ba
+00010c90: 7463 680a 2020 2020 2020 2020 2020 2020  tch.            
+00010ca0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00010cb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00010cd0: 5f79 6620 3d20 7064 2e63 6f6e 6361 7428  _yf = pd.concat(
+00010ce0: 5b64 665f 7966 2c20 6466 5f79 665f 6261  [df_yf, df_yf_ba
+00010cf0: 7463 685d 2c20 6178 6973 3d30 290a 2020  tch], axis=0).  
+00010d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d10: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d30: 6665 7463 685f 656e 645f 6261 7463 6820  fetch_end_batch 
+00010d40: 2d3d 2074 645f 3764 0a20 2020 2020 2020  -= td_7d.       
+00010d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d60: 2066 6574 6368 5f73 7461 7274 5f62 6174   fetch_start_bat
+00010d70: 6368 202d 3d20 7464 5f37 640a 2020 2020  ch -= td_7d.    
+00010d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d90: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+00010da0: 6261 7463 6820 3d20 6d61 7828 6665 7463  batch = max(fetc
+00010db0: 685f 7374 6172 745f 6261 7463 682c 2066  h_start_batch, f
+00010dc0: 6574 6368 5f73 7461 7274 290a 2020 2020  etch_start).    
+00010dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010de0: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
+00010df0: 2020 2020 2020 6466 5f79 6620 3d20 6466        df_yf = df
+00010e00: 5f79 662e 736f 7274 5f69 6e64 6578 2829  _yf.sort_index()
+00010e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00010e30: 2020 2020 2020 2020 2020 2064 665f 7966             df_yf
+00010e40: 203d 2073 656c 662e 6461 742e 6869 7374   = self.dat.hist
+00010e50: 6f72 7928 696e 7465 7276 616c 3d73 656c  ory(interval=sel
+00010e60: 662e 6973 7472 2c20 7374 6172 743d 6665  f.istr, start=fe
+00010e70: 7463 685f 7374 6172 742c 2065 6e64 3d66  tch_start, end=f
+00010e80: 6574 6368 5f65 6e64 2c20 6175 746f 5f61  etch_end, auto_a
+00010e90: 646a 7573 743d 4661 6c73 652c 2072 6570  djust=False, rep
+00010ea0: 6169 723d 7265 7061 6972 2c20 6b65 6570  air=repair, keep
+00010eb0: 6e61 3d54 7275 6529 0a20 2020 2020 2020  na=True).       
+00010ec0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00010ed0: 2252 6570 6169 7265 643f 2220 6e6f 7420  "Repaired?" not 
+00010ee0: 696e 2064 665f 7966 2e63 6f6c 756d 6e73  in df_yf.columns
+00010ef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010f00: 2020 2020 2020 2020 2020 6466 5f79 665b            df_yf[
+00010f10: 2252 6570 6169 7265 643f 225d 203d 2046  "Repaired?"] = F
+00010f20: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00010f30: 2020 2020 2020 2020 2064 665f 7966 203d           df_yf =
+00010f40: 2064 665f 7966 2e6c 6f63 5b73 7461 7274   df_yf.loc[start
+00010f50: 5f64 743a 5d0a 2020 2020 2020 2020 2020  _dt:].          
+00010f60: 2020 2020 2020 2020 2020 6466 5f79 6620            df_yf 
+00010f70: 3d20 6466 5f79 665b 6466 5f79 662e 696e  = df_yf[df_yf.in
+00010f80: 6465 7820 3c20 656e 645f 6474 5d0a 0a20  dex < end_dt].. 
+00010f90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010fa0: 2059 6168 6f6f 2064 6f65 736e 2774 2064   Yahoo doesn't d
+00010fb0: 6976 2d61 646a 7573 7420 696e 7472 6164  iv-adjust intrad
+00010fc0: 6179 0a20 2020 2020 2020 2020 2020 2020  ay.             
+00010fd0: 2020 2064 665f 7966 5f31 6420 3d20 7365     df_yf_1d = se
+00010fe0: 6c66 2e64 6174 2e68 6973 746f 7279 2869  lf.dat.history(i
+00010ff0: 6e74 6572 7661 6c3d 2231 6422 2c20 7374  nterval="1d", st
+00011000: 6172 743d 6466 5f79 662e 696e 6465 785b  art=df_yf.index[
+00011010: 305d 2e64 6174 6528 292c 2065 6e64 3d64  0].date(), end=d
+00011020: 665f 7966 2e69 6e64 6578 5b2d 315d 2e64  f_yf.index[-1].d
+00011030: 6174 6528 292b 7464 5f31 642c 2061 7574  ate()+td_1d, aut
+00011040: 6f5f 6164 6a75 7374 3d46 616c 7365 290a  o_adjust=False).
+00011050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011060: 6966 2022 5265 7061 6972 6564 3f22 206e  if "Repaired?" n
+00011070: 6f74 2069 6e20 6466 5f79 665f 3164 2e63  ot in df_yf_1d.c
+00011080: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+00011090: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+000110a0: 665f 3164 5b22 5265 7061 6972 6564 3f22  f_1d["Repaired?"
+000110b0: 5d20 3d20 4661 6c73 650a 2020 2020 2020  ] = False.      
+000110c0: 2020 2020 2020 2020 2020 6466 5f79 665b            df_yf[
+000110d0: 225f 696e 6465 7842 6163 6b75 7022 5d20  "_indexBackup"] 
+000110e0: 3d20 6466 5f79 662e 696e 6465 780a 2020  = df_yf.index.  
+000110f0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00011100: 5f79 665b 225f 6461 7465 225d 203d 2064  _yf["_date"] = d
+00011110: 665f 7966 2e69 6e64 6578 2e64 6174 650a  f_yf.index.date.
+00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011130: 6466 5f79 665f 3164 5b22 5f64 6174 6522  df_yf_1d["_date"
+00011140: 5d20 3d20 6466 5f79 665f 3164 2e69 6e64  ] = df_yf_1d.ind
+00011150: 6578 2e64 6174 650a 2020 2020 2020 2020  ex.date.        
+00011160: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00011170: 2020 2020 2020 2020 2020 6466 5f79 665f            df_yf_
+00011180: 3164 5b22 4164 6a22 5d20 3d20 6466 5f79  1d["Adj"] = df_y
+00011190: 665f 3164 5b22 4164 6a20 436c 6f73 6522  f_1d["Adj Close"
+000111a0: 5d2e 746f 5f6e 756d 7079 2829 202f 2064  ].to_numpy() / d
+000111b0: 665f 7966 5f31 645b 2243 6c6f 7365 225d  f_yf_1d["Close"]
+000111c0: 2e74 6f5f 6e75 6d70 7928 290a 2020 2020  .to_numpy().    
+000111d0: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+000111e0: 6620 3d20 6466 5f79 662e 6d65 7267 6528  f = df_yf.merge(
+000111f0: 6466 5f79 665f 3164 5b5b 2241 646a 222c  df_yf_1d[["Adj",
+00011200: 2022 5f64 6174 6522 5d5d 2c20 686f 773d   "_date"]], how=
+00011210: 226c 6566 7422 2c20 6f6e 3d22 5f64 6174  "left", on="_dat
+00011220: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00011230: 2020 2020 6466 5f79 665b 2241 646a 2043      df_yf["Adj C
+00011240: 6c6f 7365 225d 203d 2064 665f 7966 5b22  lose"] = df_yf["
+00011250: 436c 6f73 6522 5d2e 746f 5f6e 756d 7079  Close"].to_numpy
+00011260: 2829 202a 2064 665f 7966 5b22 4164 6a22  () * df_yf["Adj"
+00011270: 5d2e 746f 5f6e 756d 7079 2829 0a20 2020  ].to_numpy().   
+00011280: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00011290: 7966 203d 2064 665f 7966 2e64 726f 7028  yf = df_yf.drop(
+000112a0: 2241 646a 222c 2061 7869 733d 3129 0a20  "Adj", axis=1). 
+000112b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000112c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000112d0: 2064 665f 7966 2e69 6e64 6578 203d 2064   df_yf.index = d
+000112e0: 665f 7966 5b22 5f69 6e64 6578 4261 636b  f_yf["_indexBack
+000112f0: 7570 225d 0a20 2020 2020 2020 2020 2020  up"].           
+00011300: 2020 2020 2064 665f 7966 203d 2064 665f       df_yf = df_
+00011310: 7966 2e64 726f 7028 5b22 5f69 6e64 6578  yf.drop(["_index
+00011320: 4261 636b 7570 222c 2022 5f64 6174 6522  Backup", "_date"
+00011330: 5d2c 2061 7869 733d 3129 0a20 2020 2020  ], axis=1).     
+00011340: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00011350: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00011360: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+00011370: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+00011380: 6179 7331 2061 6e64 2064 6976 735f 6466  ays1 and divs_df
+00011390: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000113a0: 206e 6f74 2064 6976 735f 6466 2e65 6d70   not divs_df.emp
+000113b0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+000113c0: 2020 2020 2020 2020 2320 416c 736f 2075          # Also u
+000113d0: 7365 2059 4620 6461 7461 2074 6f20 7665  se YF data to ve
+000113e0: 7269 6679 2064 6976 6964 656e 6473 2e0a  rify dividends..
+000113f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011400: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
+00011410: 3d20 6d69 6e28 6665 7463 685f 7374 6172  = min(fetch_star
+00011420: 742c 2064 6976 735f 6466 2e69 6e64 6578  t, divs_df.index
+00011430: 5b30 5d2e 6461 7465 2829 290a 2020 2020  [0].date()).    
+00011440: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+00011450: 6620 3d20 7365 6c66 2e64 6174 2e68 6973  f = self.dat.his
+00011460: 746f 7279 2869 6e74 6572 7661 6c3d 7365  tory(interval=se
+00011470: 6c66 2e69 7374 722c 2073 7461 7274 3d66  lf.istr, start=f
+00011480: 6574 6368 5f73 7461 7274 2c20 656e 643d  etch_start, end=
+00011490: 6665 7463 685f 656e 642c 2061 7574 6f5f  fetch_end, auto_
+000114a0: 6164 6a75 7374 3d46 616c 7365 2c20 7265  adjust=False, re
+000114b0: 7061 6972 3d72 6570 6169 722c 206b 6565  pair=repair, kee
+000114c0: 706e 613d 5472 7565 290a 2020 2020 2020  pna=True).      
+000114d0: 2020 2020 2020 2020 2020 6966 2022 5265            if "Re
+000114e0: 7061 6972 6564 3f22 206e 6f74 2069 6e20  paired?" not in 
+000114f0: 6466 5f79 662e 636f 6c75 6d6e 733a 0a20  df_yf.columns:. 
+00011500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011510: 2020 2064 665f 7966 5b22 5265 7061 6972     df_yf["Repair
+00011520: 6564 3f22 5d20 3d20 4661 6c73 650a 2020  ed?"] = False.  
+00011530: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011540: 2064 665f 7966 2e65 6d70 7479 3a0a 2020   df_yf.empty:.  
+00011550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011560: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00011570: 6e28 6622 7b73 656c 662e 7469 636b 6572  n(f"{self.ticker
+00011580: 7d3a 2059 4620 6665 7463 6820 6661 696c  }: YF fetch fail
+00011590: 6564 2066 6f72 207b 7365 6c66 2e69 7374  ed for {self.ist
+000115a0: 727d 207b 6665 7463 685f 7374 6172 747d  r} {fetch_start}
+000115b0: 202d 3e20 7b66 6574 6368 5f65 6e64 7d22   -> {fetch_end}"
+000115c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000115d0: 2020 2320 4d61 6b65 2073 7065 6369 616c    # Make special
+000115e0: 2061 646a 7573 746d 656e 7473 2066 6f72   adjustments for
+000115f0: 2064 6976 6964 656e 6473 202f 2073 746f   dividends / sto
+00011600: 636b 2073 706c 6974 7320 7265 6c65 6173  ck splits releas
+00011610: 6564 2054 4f44 4159 0a20 2020 2020 2020  ed TODAY.       
+00011620: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00011630: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+00011640: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
+00011650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011660: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
+00011670: 6973 6e61 6e28 6466 5f79 665b 2244 6976  isnan(df_yf["Div
+00011680: 6964 656e 6473 225d 2e69 6c6f 635b 2d31  idends"].iloc[-1
+00011690: 5d29 2061 6e64 2064 665f 7966 5b22 4469  ]) and df_yf["Di
+000116a0: 7669 6465 6e64 7322 5d2e 696c 6f63 5b2d  vidends"].iloc[-
+000116b0: 315d 203e 2030 3a0a 2020 2020 2020 2020  1] > 0:.        
+000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116d0: 6578 7065 6374 5f6e 6577 5f64 6976 5f6d  expect_new_div_m
+000116e0: 6973 7369 6e67 203d 2046 616c 7365 0a20  issing = False. 
+000116f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011700: 2020 2020 2020 2069 6620 6e70 2e69 736e         if np.isn
+00011710: 616e 2864 665f 7966 5b22 436c 6f73 6522  an(df_yf["Close"
+00011720: 5d2e 696c 6f63 5b2d 315d 293a 0a20 2020  ].iloc[-1]):.   
+00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011740: 2020 2020 2020 2020 2065 7870 6563 745f           expect_
+00011750: 6e65 775f 6469 765f 6d69 7373 696e 6720  new_div_missing 
+00011760: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+00011770: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011780: 6c69 6620 685f 6c61 7374 526f 772e 6e61  lif h_lastRow.na
+00011790: 6d65 203d 3d20 6466 5f79 662e 696e 6465  me == df_yf.inde
+000117a0: 785b 2d31 5d20 616e 6420 685f 6c61 7374  x[-1] and h_last
+000117b0: 526f 775b 2244 6976 6964 656e 6473 225d  Row["Dividends"]
+000117c0: 203d 3d20 302e 303a 0a20 2020 2020 2020   == 0.0:.       
+000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117e0: 2020 2020 2065 7870 6563 745f 6e65 775f       expect_new_
+000117f0: 6469 765f 6d69 7373 696e 6720 3d20 5472  div_missing = Tr
+00011800: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00011810: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00011820: 7065 6374 5f6e 6577 5f64 6976 5f6d 6973  pect_new_div_mis
+00011830: 7369 6e67 3a0a 2020 2020 2020 2020 2020  sing:.          
+00011840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011850: 2020 2320 5946 4320 776f 6e27 7420 6861    # YFC won't ha
+00011860: 7665 2072 6563 6f72 6420 6f66 2074 6869  ve record of thi
+00011870: 7320 6469 7669 6465 6e64 2062 6563 6175  s dividend becau
+00011880: 7365 206f 6363 7572 7320 746f 6e69 6768  se occurs tonigh
+00011890: 742f 746f 6d6f 7272 6f77 2c20 736f 2072  t/tomorrow, so r
+000118a0: 656d 6f76 6520 6974 2773 2061 646a 7573  emove it's adjus
+000118b0: 746d 656e 7420 6672 6f6d 2070 7269 6365  tment from price
+000118c0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000118d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000118e0: 765f 6164 6a20 3d20 6466 5f79 665b 2243  v_adj = df_yf["C
+000118f0: 6c6f 7365 225d 2e69 6c6f 635b 2d32 5d20  lose"].iloc[-2] 
+00011900: 2f20 6466 5f79 665b 2241 646a 2043 6c6f  / df_yf["Adj Clo
+00011910: 7365 225d 2e69 6c6f 635b 2d32 5d0a 2020  se"].iloc[-2].  
 00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011930: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
-00011940: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
-00011950: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
-00011960: 2920 656c 7365 2070 7269 6e74 2866 227b  ) else print(f"{
-00011970: 7365 6c66 2e74 6963 6b65 727d 3a20 2220  self.ticker}: " 
-00011980: 2b20 6d73 6729 0a20 2020 2020 2020 2020  + msg).         
-00011990: 2020 2020 2020 2064 665f 7966 203d 2073         df_yf = s
-000119a0: 656c 662e 6461 742e 6869 7374 6f72 7928  elf.dat.history(
-000119b0: 696e 7465 7276 616c 3d73 656c 662e 6973  interval=self.is
-000119c0: 7472 2c20 7374 6172 743d 6665 7463 685f  tr, start=fetch_
-000119d0: 7374 6172 742c 2065 6e64 3d66 6574 6368  start, end=fetch
-000119e0: 5f65 6e64 2c20 6175 746f 5f61 646a 7573  _end, auto_adjus
-000119f0: 743d 4661 6c73 652c 2072 6570 6169 723d  t=False, repair=
-00011a00: 7265 7061 6972 2c20 6b65 6570 6e61 3d54  repair, keepna=T
-00011a10: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00011a20: 2020 2020 2069 6620 2252 6570 6169 7265       if "Repaire
-00011a30: 643f 2220 6e6f 7420 696e 2064 665f 7966  d?" not in df_yf
-00011a40: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
-00011a50: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00011a60: 5f79 665b 2252 6570 6169 7265 643f 225d  _yf["Repaired?"]
-00011a70: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00011a80: 2020 2020 2020 2020 2069 6620 6466 5f79           if df_y
-00011a90: 662e 656d 7074 793a 0a20 2020 2020 2020  f.empty:.       
-00011aa0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00011ab0: 7365 2045 7863 6570 7469 6f6e 2866 227b  se Exception(f"{
-00011ac0: 7365 6c66 2e74 6963 6b65 727d 3a20 5946  self.ticker}: YF
-00011ad0: 2066 6574 6368 2066 6169 6c65 6420 666f   fetch failed fo
-00011ae0: 7220 7b73 656c 662e 6973 7472 7d20 7b66  r {self.istr} {f
-00011af0: 6574 6368 5f73 7461 7274 7d20 2d3e 207b  etch_start} -> {
-00011b00: 6665 7463 685f 656e 647d 2229 0a20 2020  fetch_end}").   
-00011b10: 2020 2020 2020 2020 2020 2020 2023 204d               # M
-00011b20: 616b 6520 7370 6563 6961 6c20 6164 6a75  ake special adju
-00011b30: 7374 6d65 6e74 7320 666f 7220 6469 7669  stments for divi
-00011b40: 6465 6e64 7320 2f20 7374 6f63 6b20 7370  dends / stock sp
-00011b50: 6c69 7473 2072 656c 6561 7365 6420 544f  lits released TO
-00011b60: 4441 590a 2020 2020 2020 2020 2020 2020  DAY.            
-00011b70: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-00011b80: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-00011b90: 6572 7661 6c2e 4461 7973 313a 0a20 2020  erval.Days1:.   
-00011ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011bb0: 2069 6620 6e6f 7420 6e70 2e69 736e 616e   if not np.isnan
-00011bc0: 2864 665f 7966 5b22 4469 7669 6465 6e64  (df_yf["Dividend
-00011bd0: 7322 5d2e 696c 6f63 5b2d 315d 2920 616e  s"].iloc[-1]) an
-00011be0: 6420 6466 5f79 665b 2244 6976 6964 656e  d df_yf["Dividen
-00011bf0: 6473 225d 2e69 6c6f 635b 2d31 5d20 3e20  ds"].iloc[-1] > 
-00011c00: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00011c10: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-00011c20: 745f 6e65 775f 6469 765f 6d69 7373 696e  t_new_div_missin
-00011c30: 6720 3d20 4661 6c73 650a 2020 2020 2020  g = False.      
-00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c50: 2020 6966 206e 702e 6973 6e61 6e28 6466    if np.isnan(df
-00011c60: 5f79 665b 2243 6c6f 7365 225d 2e69 6c6f  _yf["Close"].ilo
-00011c70: 635b 2d31 5d29 3a0a 2020 2020 2020 2020  c[-1]):.        
-00011c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c90: 2020 2020 6578 7065 6374 5f6e 6577 5f64      expect_new_d
-00011ca0: 6976 5f6d 6973 7369 6e67 203d 2054 7275  iv_missing = Tru
-00011cb0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00011cc0: 2020 2020 2020 2020 2020 656c 6966 2068            elif h
-00011cd0: 5f6c 6173 7452 6f77 2e6e 616d 6520 3d3d  _lastRow.name ==
-00011ce0: 2064 665f 7966 2e69 6e64 6578 5b2d 315d   df_yf.index[-1]
-00011cf0: 2061 6e64 2068 5f6c 6173 7452 6f77 5b22   and h_lastRow["
-00011d00: 4469 7669 6465 6e64 7322 5d20 3d3d 2030  Dividends"] == 0
-00011d10: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
-00011d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d30: 6578 7065 6374 5f6e 6577 5f64 6976 5f6d  expect_new_div_m
-00011d40: 6973 7369 6e67 203d 2054 7275 650a 2020  issing = True.  
-00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d60: 2020 2020 2020 6966 2065 7870 6563 745f        if expect_
-00011d70: 6e65 775f 6469 765f 6d69 7373 696e 673a  new_div_missing:
-00011d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011d90: 2020 2020 2020 2020 2020 2020 2023 2059               # Y
-00011da0: 4643 2077 6f6e 2774 2068 6176 6520 7265  FC won't have re
-00011db0: 636f 7264 206f 6620 7468 6973 2064 6976  cord of this div
-00011dc0: 6964 656e 6420 6265 6361 7573 6520 6f63  idend because oc
-00011dd0: 6375 7273 2074 6f6e 6967 6874 2f74 6f6d  curs tonight/tom
-00011de0: 6f72 726f 772c 2073 6f20 7265 6d6f 7665  orrow, so remove
-00011df0: 2069 7427 7320 6164 6a75 7374 6d65 6e74   it's adjustment
-00011e00: 2066 726f 6d20 7072 6963 6573 0a20 2020   from prices.   
-00011e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e20: 2020 2020 2020 2020 2072 6576 5f61 646a           rev_adj
-00011e30: 203d 2064 665f 7966 5b22 436c 6f73 6522   = df_yf["Close"
-00011e40: 5d2e 696c 6f63 5b2d 325d 202f 2064 665f  ].iloc[-2] / df_
-00011e50: 7966 5b22 4164 6a20 436c 6f73 6522 5d2e  yf["Adj Close"].
-00011e60: 696c 6f63 5b2d 325d 0a20 2020 2020 2020  iloc[-2].       
-00011e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e80: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
-00011e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ea0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00011eb0: 7367 203d 2066 222d 2072 656d 6f76 696e  sg = f"- removin
-00011ec0: 6720 6469 7669 6465 6e64 2066 726f 6d20  g dividend from 
-00011ed0: 6466 5f79 662d 7b73 656c 662e 6973 7472  df_yf-{self.istr
-00011ee0: 7d3a 207b 6466 5f79 662e 696e 6465 785b  }: {df_yf.index[
-00011ef0: 2d31 5d7d 2061 646a 3d7b 312e 302f 7265  -1]} adj={1.0/re
-00011f00: 765f 6164 6a3a 2e34 667d 220a 2020 2020  v_adj:.4f}".    
-00011f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f20: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
-00011f30: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
-00011f40: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-00011f50: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
-00011f60: 2070 7269 6e74 2866 227b 7365 6c66 2e74   print(f"{self.t
-00011f70: 6963 6b65 727d 3a20 2220 2b20 6d73 6729  icker}: " + msg)
-00011f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011f90: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00011fa0: 7966 5b22 4164 6a20 436c 6f73 6522 5d20  yf["Adj Close"] 
-00011fb0: 2a3d 2072 6576 5f61 646a 0a20 2020 2020  *= rev_adj.     
-00011fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011fd0: 2020 2020 2020 2064 665f 7966 203d 2064         df_yf = d
-00011fe0: 665f 7966 2e64 726f 7028 6466 5f79 662e  f_yf.drop(df_yf.
-00011ff0: 696e 6465 785b 2d31 5d29 0a20 2020 2020  index[-1]).     
-00012000: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012010: 6620 6466 5f79 662e 696e 6465 785b 2d31  f df_yf.index[-1
-00012020: 5d20 3d3d 2068 5f6c 6173 7452 6f77 2e6e  ] == h_lastRow.n
-00012030: 616d 6520 616e 6420 6466 5f79 665b 2253  ame and df_yf["S
-00012040: 746f 636b 2053 706c 6974 7322 5d2e 696c  tock Splits"].il
-00012050: 6f63 5b2d 315d 2021 3d20 3020 616e 6420  oc[-1] != 0 and 
-00012060: 685f 6c61 7374 526f 775b 2253 746f 636b  h_lastRow["Stock
-00012070: 2053 706c 6974 7322 5d20 3d3d 2030 3a0a   Splits"] == 0:.
-00012080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012090: 2020 2020 2020 2020 2320 5946 4320 646f          # YFC do
-000120a0: 6573 6e27 7420 6861 7665 2072 6563 6f72  esn't have recor
-000120b0: 6420 6f66 2074 6f64 6179 2773 2073 706c  d of today's spl
-000120c0: 6974 2079 6574 2073 6f20 7265 6d6f 7665  it yet so remove
-000120d0: 2065 6666 6563 740a 2020 2020 2020 2020   effect.        
-000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120f0: 7265 765f 6164 6a20 3d20 6466 5f79 665b  rev_adj = df_yf[
-00012100: 2253 746f 636b 2053 706c 6974 7322 5d2e  "Stock Splits"].
-00012110: 696c 6f63 5b2d 315d 0a20 2020 2020 2020  iloc[-1].       
-00012120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012130: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
-00012140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012150: 2020 2020 2020 206d 7367 203d 2066 222d         msg = f"-
-00012160: 2072 656d 6f76 696e 6720 7370 6c69 7420   removing split 
-00012170: 6672 6f6d 2064 665f 7966 2d7b 7365 6c66  from df_yf-{self
-00012180: 2e69 7374 727d 3a20 7b64 665f 7966 2e69  .istr}: {df_yf.i
-00012190: 6e64 6578 5b2d 315d 7d20 6164 6a3d 7b31  ndex[-1]} adj={1
-000121a0: 2e30 2f72 6576 5f61 646a 7d22 0a20 2020  .0/rev_adj}".   
-000121b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121c0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-000121d0: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-000121e0: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-000121f0: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-00012200: 696e 7428 6622 7b73 656c 662e 7469 636b  int(f"{self.tick
-00012210: 6572 7d3a 2022 202b 206d 7367 290a 2020  er}: " + msg).  
-00012220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012230: 2020 2020 2020 666f 7220 6320 696e 205b        for c in [
-00012240: 224f 7065 6e22 2c20 2248 6967 6822 2c20  "Open", "High", 
-00012250: 224c 6f77 222c 2022 436c 6f73 6522 2c20  "Low", "Close", 
-00012260: 2241 646a 2043 6c6f 7365 225d 3a0a 2020  "Adj Close"]:.  
-00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012280: 2020 2020 2020 2020 2020 6466 5f79 665b            df_yf[
-00012290: 635d 202a 3d20 7265 765f 6164 6a0a 2020  c] *= rev_adj.  
-000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122b0: 2020 2020 2020 6466 5f79 665b 2256 6f6c        df_yf["Vol
-000122c0: 756d 6522 5d20 2f3d 2072 6576 5f61 646a  ume"] /= rev_adj
-000122d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000122e0: 2020 2020 2020 2020 2064 665f 7966 2e6c           df_yf.l
-000122f0: 6f63 5b64 665f 7966 2e69 6e64 6578 5b2d  oc[df_yf.index[-
-00012300: 315d 2c20 2253 746f 636b 2053 706c 6974  1], "Stock Split
-00012310: 7322 5d20 3d20 302e 300a 0a20 2020 2020  s"] = 0.0..     
-00012320: 2020 2020 2020 2069 6620 6466 5f79 6620         if df_yf 
-00012330: 6973 204e 6f6e 6520 6f72 2064 665f 7966  is None or df_yf
-00012340: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
-00012350: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-00012360: 6365 7074 696f 6e28 6622 4665 7463 6869  ception(f"Fetchi
-00012370: 6e67 2072 6566 6572 656e 6365 2079 6669  ng reference yfi
-00012380: 6e61 6e63 6520 6461 7461 2066 6169 6c65  nance data faile
-00012390: 6420 2869 6e74 6572 7661 6c3d 7b73 656c  d (interval={sel
-000123a0: 662e 6973 7472 7d2c 2073 7461 7274 5f64  f.istr}, start_d
-000123b0: 743d 7b73 7461 7274 5f64 747d 2c20 6c61  t={start_dt}, la
-000123c0: 7374 5f64 743d 7b6c 6173 745f 6474 7d29  st_dt={last_dt})
-000123d0: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-000123e0: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
-000123f0: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
-00012400: 2e57 6565 6b3a 0a20 2020 2020 2020 2020  .Week:.         
-00012410: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00012420: 6461 7461 2061 6c69 676e 6564 2074 6f20  data aligned to 
-00012430: 4d6f 6e64 6179 3a0a 2020 2020 2020 2020  Monday:.        
-00012440: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-00012450: 665f 7966 2e69 6e64 6578 5b30 5d2e 7765  f_yf.index[0].we
-00012460: 656b 6461 7928 2920 3d3d 2030 3a0a 2020  ekday() == 0:.  
-00012470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012480: 2020 6e20 3d20 300a 2020 2020 2020 2020    n = 0.        
-00012490: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-000124a0: 6520 6e20 3c20 333a 0a20 2020 2020 2020  e n < 3:.       
-000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124c0: 2066 6574 6368 5f73 7461 7274 202d 3d20   fetch_start -= 
-000124d0: 7469 6d65 6465 6c74 6128 6461 7973 3d32  timedelta(days=2
-000124e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000124f0: 2020 2020 2020 2020 2020 6466 5f79 6620            df_yf 
-00012500: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
-00012510: 7279 2869 6e74 6572 7661 6c3d 7365 6c66  ry(interval=self
-00012520: 2e69 7374 722c 2073 7461 7274 3d66 6574  .istr, start=fet
-00012530: 6368 5f73 7461 7274 2c20 656e 643d 6665  ch_start, end=fe
-00012540: 7463 685f 656e 642c 2061 7574 6f5f 6164  tch_end, auto_ad
-00012550: 6a75 7374 3d46 616c 7365 2c20 7265 7061  just=False, repa
-00012560: 6972 3d72 6570 6169 7229 0a20 2020 2020  ir=repair).     
-00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012580: 2020 2069 6620 2252 6570 6169 7265 643f     if "Repaired?
-00012590: 2220 6e6f 7420 696e 2064 665f 7966 2e63  " not in df_yf.c
-000125a0: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
-000125b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125c0: 2020 2020 6466 5f79 665b 2252 6570 6169      df_yf["Repai
-000125d0: 7265 643f 225d 203d 2046 616c 7365 0a20  red?"] = False. 
-000125e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125f0: 2020 2020 2020 206e 202b 3d20 310a 2020         n += 1.  
-00012600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012610: 2020 2020 2020 6966 2064 665f 7966 2e69        if df_yf.i
-00012620: 6e64 6578 5b30 5d2e 7765 656b 6461 7928  ndex[0].weekday(
-00012630: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00012640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012650: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00012660: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00012670: 206e 6f74 2064 665f 7966 2e69 6e64 6578   not df_yf.index
-00012680: 5b30 5d2e 7765 656b 6461 7928 2920 3d3d  [0].weekday() ==
-00012690: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000126a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000126b0: 6520 4578 6365 7074 696f 6e28 2246 6169  e Exception("Fai
-000126c0: 6c65 6420 746f 2067 6574 204d 6f6e 6461  led to get Monda
-000126d0: 792d 616c 6967 6e65 6420 7765 656b 6c79  y-aligned weekly
-000126e0: 2064 6174 6120 6672 6f6d 2059 4622 290a   data from YF").
-000126f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012700: 2020 2020 6466 5f79 6620 3d20 6466 5f79      df_yf = df_y
-00012710: 662e 6c6f 635b 682e 696e 6465 785b 305d  f.loc[h.index[0]
-00012720: 3a5d 0a0a 2020 2020 2020 2020 2020 2020  :]..            
-00012730: 6966 206e 6f74 2073 656c 662e 696e 7465  if not self.inte
-00012740: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
-00012750: 2020 2020 2020 2320 566f 6c75 6d65 206e        # Volume n
-00012760: 6f74 2073 706c 6974 2d61 646a 7573 7465  ot split-adjuste
-00012770: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00012780: 2020 7373 203d 2064 665f 7966 5b22 5374    ss = df_yf["St
-00012790: 6f63 6b20 5370 6c69 7473 225d 2e63 6f70  ock Splits"].cop
-000127a0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-000127b0: 2020 2020 7373 5b28 7373 203d 3d20 302e      ss[(ss == 0.
-000127c0: 3029 207c 2073 732e 6973 6e61 2829 5d20  0) | ss.isna()] 
-000127d0: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
-000127e0: 2020 2020 2020 7373 5f72 6370 203d 2031        ss_rcp = 1
-000127f0: 2e30 202f 2073 730a 2020 2020 2020 2020  .0 / ss.        
-00012800: 2020 2020 2020 2020 6373 6620 3d20 7373          csf = ss
-00012810: 5f72 6370 2e73 6f72 745f 696e 6465 7828  _rcp.sort_index(
-00012820: 6173 6365 6e64 696e 673d 4661 6c73 6529  ascending=False)
-00012830: 2e63 756d 7072 6f64 2829 2e73 6f72 745f  .cumprod().sort_
-00012840: 696e 6465 7828 6173 6365 6e64 696e 673d  index(ascending=
-00012850: 5472 7565 292e 7368 6966 7428 2d31 2c20  True).shift(-1, 
-00012860: 6669 6c6c 5f76 616c 7565 3d31 2e30 290a  fill_value=1.0).
-00012870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012880: 6466 5f79 665b 2256 6f6c 756d 6522 5d20  df_yf["Volume"] 
-00012890: 3d20 6466 5f79 665b 2256 6f6c 756d 6522  = df_yf["Volume"
-000128a0: 5d2e 746f 5f6e 756d 7079 2829 202f 2063  ].to_numpy() / c
-000128b0: 7366 0a0a 2020 2020 2020 2020 2020 2020  sf..            
-000128c0: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
-000128d0: 2021 3d20 7966 6364 2e49 6e74 6572 7661   != yfcd.Interva
-000128e0: 6c2e 4461 7973 3120 616e 6420 636f 7272  l.Days1 and corr
-000128f0: 6563 743a 0a20 2020 2020 2020 2020 2020  ect:.           
-00012900: 2020 2020 2023 2043 6f70 7920 6f76 6572       # Copy over
-00012910: 2061 6e79 206d 6973 7369 6e67 2064 6976   any missing div
-00012920: 6964 656e 6473 0a20 2020 2020 2020 2020  idends.         
-00012930: 2020 2020 2020 2063 203d 2022 4469 7669         c = "Divi
-00012940: 6465 6e64 7322 0a20 2020 2020 2020 2020  dends".         
-00012950: 2020 2020 2020 2068 5f64 6976 7320 3d20         h_divs = 
-00012960: 682e 6c6f 635b 685b 635d 2021 3d20 302e  h.loc[h[c] != 0.
-00012970: 302c 2063 5d2e 636f 7079 2829 2e64 726f  0, c].copy().dro
-00012980: 706e 6128 290a 2020 2020 2020 2020 2020  pna().          
-00012990: 2020 2020 2020 7966 5f64 6976 7320 3d20        yf_divs = 
-000129a0: 6466 5f79 662e 6c6f 635b 6466 5f79 665b  df_yf.loc[df_yf[
-000129b0: 635d 2021 3d20 302e 302c 2063 5d0a 2020  c] != 0.0, c].  
-000129c0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-000129d0: 735f 6d69 7373 696e 675f 6672 6f6d 5f63  s_missing_from_c
-000129e0: 6163 6865 203d 2079 665f 6469 7673 2e69  ache = yf_divs.i
-000129f0: 6e64 6578 5b7e 7966 5f64 6976 732e 696e  ndex[~yf_divs.in
-00012a00: 6465 782e 6973 696e 2868 5f64 6976 732e  dex.isin(h_divs.
-00012a10: 696e 6465 7829 5d0a 2020 2020 2020 2020  index)].        
-00012a20: 2020 2020 2020 2020 6474 735f 6d69 7373          dts_miss
-00012a30: 696e 675f 6672 6f6d 5f63 6163 6865 203d  ing_from_cache =
-00012a40: 205b 6474 2066 6f72 2064 7420 696e 2064   [dt for dt in d
-00012a50: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
-00012a60: 6361 6368 6520 6966 2064 7420 696e 2068  cache if dt in h
-00012a70: 2e69 6e64 6578 5d0a 2020 2020 2020 2020  .index].        
-00012a80: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-00012a90: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
-00012aa0: 6361 6368 6529 203e 2030 3a0a 2020 2020  cache) > 0:.    
-00012ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ac0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+00011930: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00011940: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
+00011950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011960: 2020 2020 6d73 6720 3d20 6622 2d20 7265      msg = f"- re
+00011970: 6d6f 7669 6e67 2064 6976 6964 656e 6420  moving dividend 
+00011980: 6672 6f6d 2064 665f 7966 2d7b 7365 6c66  from df_yf-{self
+00011990: 2e69 7374 727d 3a20 7b64 665f 7966 2e69  .istr}: {df_yf.i
+000119a0: 6e64 6578 5b2d 315d 7d20 6164 6a3d 7b31  ndex[-1]} adj={1
+000119b0: 2e30 2f72 6576 5f61 646a 3a2e 3466 7d22  .0/rev_adj:.4f}"
+000119c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000119d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119e0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+000119f0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+00011a00: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+00011a10: 2065 6c73 6520 7072 696e 7428 6622 7b73   else print(f"{s
+00011a20: 656c 662e 7469 636b 6572 7d3a 2022 202b  elf.ticker}: " +
+00011a30: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
+00011a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a50: 2020 6466 5f79 665b 2241 646a 2043 6c6f    df_yf["Adj Clo
+00011a60: 7365 225d 202a 3d20 7265 765f 6164 6a0a  se"] *= rev_adj.
+00011a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a80: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+00011a90: 6620 3d20 6466 5f79 662e 6472 6f70 2864  f = df_yf.drop(d
+00011aa0: 665f 7966 2e69 6e64 6578 5b2d 315d 290a  f_yf.index[-1]).
+00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ac0: 2020 2020 6966 2064 665f 7966 2e69 6e64      if df_yf.ind
+00011ad0: 6578 5b2d 315d 203d 3d20 685f 6c61 7374  ex[-1] == h_last
+00011ae0: 526f 772e 6e61 6d65 2061 6e64 2064 665f  Row.name and df_
+00011af0: 7966 5b22 5374 6f63 6b20 5370 6c69 7473  yf["Stock Splits
+00011b00: 225d 2e69 6c6f 635b 2d31 5d20 213d 2030  "].iloc[-1] != 0
+00011b10: 2061 6e64 2068 5f6c 6173 7452 6f77 5b22   and h_lastRow["
+00011b20: 5374 6f63 6b20 5370 6c69 7473 225d 203d  Stock Splits"] =
+00011b30: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00011b40: 2020 2020 2020 2020 2020 2020 2023 2059               # Y
+00011b50: 4643 2064 6f65 736e 2774 2068 6176 6520  FC doesn't have 
+00011b60: 7265 636f 7264 206f 6620 746f 6461 7927  record of today'
+00011b70: 7320 7370 6c69 7420 7965 7420 736f 2072  s split yet so r
+00011b80: 656d 6f76 6520 6566 6665 6374 0a20 2020  emove effect.   
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ba0: 2020 2020 2072 6576 5f61 646a 203d 2064       rev_adj = d
+00011bb0: 665f 7966 5b22 5374 6f63 6b20 5370 6c69  f_yf["Stock Spli
+00011bc0: 7473 225d 2e69 6c6f 635b 2d31 5d0a 2020  ts"].iloc[-1].  
+00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011be0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+00011bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c00: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00011c10: 3d20 6622 2d20 7265 6d6f 7669 6e67 2073  = f"- removing s
+00011c20: 706c 6974 2066 726f 6d20 6466 5f79 662d  plit from df_yf-
+00011c30: 7b73 656c 662e 6973 7472 7d3a 207b 6466  {self.istr}: {df
+00011c40: 5f79 662e 696e 6465 785b 2d31 5d7d 2061  _yf.index[-1]} a
+00011c50: 646a 3d7b 312e 302f 7265 765f 6164 6a7d  dj={1.0/rev_adj}
+00011c60: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00011c70: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+00011c80: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
+00011c90: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
+00011ca0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
+00011cb0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
+00011cc0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
+00011cd0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+00011ce0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00011cf0: 2069 6e20 5b22 4f70 656e 222c 2022 4869   in ["Open", "Hi
+00011d00: 6768 222c 2022 4c6f 7722 2c20 2243 6c6f  gh", "Low", "Clo
+00011d10: 7365 222c 2022 4164 6a20 436c 6f73 6522  se", "Adj Close"
+00011d20: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00011d30: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011d40: 665f 7966 5b63 5d20 2a3d 2072 6576 5f61  f_yf[c] *= rev_a
+00011d50: 646a 0a20 2020 2020 2020 2020 2020 2020  dj.             
+00011d60: 2020 2020 2020 2020 2020 2064 665f 7966             df_yf
+00011d70: 5b22 566f 6c75 6d65 225d 202f 3d20 7265  ["Volume"] /= re
+00011d80: 765f 6164 6a0a 2020 2020 2020 2020 2020  v_adj.          
+00011d90: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00011da0: 5f79 662e 6c6f 635b 6466 5f79 662e 696e  _yf.loc[df_yf.in
+00011db0: 6465 785b 2d31 5d2c 2022 5374 6f63 6b20  dex[-1], "Stock 
+00011dc0: 5370 6c69 7473 225d 203d 2030 2e30 0a0a  Splits"] = 0.0..
+00011dd0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00011de0: 665f 7966 2069 7320 4e6f 6e65 206f 7220  f_yf is None or 
+00011df0: 6466 5f79 662e 656d 7074 793a 0a20 2020  df_yf.empty:.   
+00011e00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00011e10: 7365 2045 7863 6570 7469 6f6e 2866 2246  se Exception(f"F
+00011e20: 6574 6368 696e 6720 7265 6665 7265 6e63  etching referenc
+00011e30: 6520 7966 696e 616e 6365 2064 6174 6120  e yfinance data 
+00011e40: 6661 696c 6564 2028 696e 7465 7276 616c  failed (interval
+00011e50: 3d7b 7365 6c66 2e69 7374 727d 2c20 7374  ={self.istr}, st
+00011e60: 6172 745f 6474 3d7b 7374 6172 745f 6474  art_dt={start_dt
+00011e70: 7d2c 206c 6173 745f 6474 3d7b 6c61 7374  }, last_dt={last
+00011e80: 5f64 747d 2922 290a 2020 2020 2020 2020  _dt})").        
+00011e90: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00011ea0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+00011eb0: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
+00011ec0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00011ed0: 7375 7265 2064 6174 6120 616c 6967 6e65  sure data aligne
+00011ee0: 6420 746f 204d 6f6e 6461 793a 0a20 2020  d to Monday:.   
+00011ef0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00011f00: 6e6f 7420 6466 5f79 662e 696e 6465 785b  not df_yf.index[
+00011f10: 305d 2e77 6565 6b64 6179 2829 203d 3d20  0].weekday() == 
+00011f20: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00011f30: 2020 2020 2020 206e 203d 2030 0a20 2020         n = 0.   
+00011f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f50: 2077 6869 6c65 206e 203c 2033 3a0a 2020   while n < 3:.  
+00011f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f70: 2020 2020 2020 6665 7463 685f 7374 6172        fetch_star
+00011f80: 7420 2d3d 2074 696d 6564 656c 7461 2864  t -= timedelta(d
+00011f90: 6179 733d 3229 0a20 2020 2020 2020 2020  ays=2).         
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011fb0: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
+00011fc0: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
+00011fd0: 3d73 656c 662e 6973 7472 2c20 7374 6172  =self.istr, star
+00011fe0: 743d 6665 7463 685f 7374 6172 742c 2065  t=fetch_start, e
+00011ff0: 6e64 3d66 6574 6368 5f65 6e64 2c20 6175  nd=fetch_end, au
+00012000: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
+00012010: 2072 6570 6169 723d 7265 7061 6972 290a   repair=repair).
+00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012030: 2020 2020 2020 2020 6966 2022 5265 7061          if "Repa
+00012040: 6972 6564 3f22 206e 6f74 2069 6e20 6466  ired?" not in df
+00012050: 5f79 662e 636f 6c75 6d6e 733a 0a20 2020  _yf.columns:.   
+00012060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012070: 2020 2020 2020 2020 2064 665f 7966 5b22           df_yf["
+00012080: 5265 7061 6972 6564 3f22 5d20 3d20 4661  Repaired?"] = Fa
+00012090: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000120a0: 2020 2020 2020 2020 2020 2020 6e20 2b3d              n +=
+000120b0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+000120c0: 2020 2020 2020 2020 2020 2069 6620 6466             if df
+000120d0: 5f79 662e 696e 6465 785b 305d 2e77 6565  _yf.index[0].wee
+000120e0: 6b64 6179 2829 203d 3d20 303a 0a20 2020  kday() == 0:.   
+000120f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012100: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+00012110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012120: 2020 2069 6620 6e6f 7420 6466 5f79 662e     if not df_yf.
+00012130: 696e 6465 785b 305d 2e77 6565 6b64 6179  index[0].weekday
+00012140: 2829 203d 3d20 303a 0a20 2020 2020 2020  () == 0:.       
+00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012160: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+00012170: 2822 4661 696c 6564 2074 6f20 6765 7420  ("Failed to get 
+00012180: 4d6f 6e64 6179 2d61 6c69 676e 6564 2077  Monday-aligned w
+00012190: 6565 6b6c 7920 6461 7461 2066 726f 6d20  eekly data from 
+000121a0: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
+000121b0: 2020 2020 2020 2020 2064 665f 7966 203d           df_yf =
+000121c0: 2064 665f 7966 2e6c 6f63 5b68 2e69 6e64   df_yf.loc[h.ind
+000121d0: 6578 5b30 5d3a 5d0a 0a20 2020 2020 2020  ex[0]:]..       
+000121e0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+000121f0: 2e69 6e74 6572 6461 793a 0a20 2020 2020  .interday:.     
+00012200: 2020 2020 2020 2020 2020 2023 2056 6f6c             # Vol
+00012210: 756d 6520 6e6f 7420 7370 6c69 742d 6164  ume not split-ad
+00012220: 6a75 7374 6564 0a20 2020 2020 2020 2020  justed.         
+00012230: 2020 2020 2020 2073 7320 3d20 6466 5f79         ss = df_y
+00012240: 665b 2253 746f 636b 2053 706c 6974 7322  f["Stock Splits"
+00012250: 5d2e 636f 7079 2829 0a20 2020 2020 2020  ].copy().       
+00012260: 2020 2020 2020 2020 2073 735b 2873 7320           ss[(ss 
+00012270: 3d3d 2030 2e30 2920 7c20 7373 2e69 736e  == 0.0) | ss.isn
+00012280: 6128 295d 203d 2031 2e30 0a20 2020 2020  a()] = 1.0.     
+00012290: 2020 2020 2020 2020 2020 2073 735f 7263             ss_rc
+000122a0: 7020 3d20 312e 3020 2f20 7373 0a20 2020  p = 1.0 / ss.   
+000122b0: 2020 2020 2020 2020 2020 2020 2063 7366               csf
+000122c0: 203d 2073 735f 7263 702e 736f 7274 5f69   = ss_rcp.sort_i
+000122d0: 6e64 6578 2861 7363 656e 6469 6e67 3d46  ndex(ascending=F
+000122e0: 616c 7365 292e 6375 6d70 726f 6428 292e  alse).cumprod().
+000122f0: 736f 7274 5f69 6e64 6578 2861 7363 656e  sort_index(ascen
+00012300: 6469 6e67 3d54 7275 6529 2e73 6869 6674  ding=True).shift
+00012310: 282d 312c 2066 696c 6c5f 7661 6c75 653d  (-1, fill_value=
+00012320: 312e 3029 0a20 2020 2020 2020 2020 2020  1.0).           
+00012330: 2020 2020 2064 665f 7966 5b22 566f 6c75       df_yf["Volu
+00012340: 6d65 225d 203d 2064 665f 7966 5b22 566f  me"] = df_yf["Vo
+00012350: 6c75 6d65 225d 2e74 6f5f 6e75 6d70 7928  lume"].to_numpy(
+00012360: 2920 2f20 6373 660a 0a20 2020 2020 2020  ) / csf..       
+00012370: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00012380: 6572 7661 6c20 213d 2079 6663 642e 496e  erval != yfcd.In
+00012390: 7465 7276 616c 2e44 6179 7331 2061 6e64  terval.Days1 and
+000123a0: 2063 6f72 7265 6374 2069 6e20 5b27 6f6e   correct in ['on
+000123b0: 6527 2c20 2761 6c6c 275d 3a0a 2020 2020  e', 'all']:.    
+000123c0: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+000123d0: 7079 206f 7665 7220 616e 7920 6d69 7373  py over any miss
+000123e0: 696e 6720 6469 7669 6465 6e64 730a 2020  ing dividends.  
+000123f0: 2020 2020 2020 2020 2020 2020 2020 6320                c 
+00012400: 3d20 2244 6976 6964 656e 6473 220a 2020  = "Dividends".  
+00012410: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+00012420: 6469 7673 203d 2068 2e6c 6f63 5b68 5b63  divs = h.loc[h[c
+00012430: 5d20 213d 2030 2e30 2c20 635d 2e63 6f70  ] != 0.0, c].cop
+00012440: 7928 292e 6472 6f70 6e61 2829 0a20 2020  y().dropna().   
+00012450: 2020 2020 2020 2020 2020 2020 2079 665f               yf_
+00012460: 6469 7673 203d 2064 665f 7966 2e6c 6f63  divs = df_yf.loc
+00012470: 5b64 665f 7966 5b63 5d20 213d 2030 2e30  [df_yf[c] != 0.0
+00012480: 2c20 635d 0a20 2020 2020 2020 2020 2020  , c].           
+00012490: 2020 2020 2064 7473 5f6d 6973 7369 6e67       dts_missing
+000124a0: 5f66 726f 6d5f 6361 6368 6520 3d20 7966  _from_cache = yf
+000124b0: 5f64 6976 732e 696e 6465 785b 7e79 665f  _divs.index[~yf_
+000124c0: 6469 7673 2e69 6e64 6578 2e69 7369 6e28  divs.index.isin(
+000124d0: 685f 6469 7673 2e69 6e64 6578 295d 0a20  h_divs.index)]. 
+000124e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000124f0: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
+00012500: 6361 6368 6520 3d20 5b64 7420 666f 7220  cache = [dt for 
+00012510: 6474 2069 6e20 6474 735f 6d69 7373 696e  dt in dts_missin
+00012520: 675f 6672 6f6d 5f63 6163 6865 2069 6620  g_from_cache if 
+00012530: 6474 2069 6e20 682e 696e 6465 785d 0a20  dt in h.index]. 
+00012540: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012550: 6620 6c65 6e28 6474 735f 6d69 7373 696e  f len(dts_missin
+00012560: 675f 6672 6f6d 5f63 6163 6865 2920 3e20  g_from_cache) > 
+00012570: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00012580: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
+00012590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125a0: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+000125b0: 2243 4f52 5245 4354 494e 473a 2043 6163  "CORRECTING: Cac
+000125c0: 6865 206d 6973 7369 6e67 2074 6865 7365  he missing these
+000125d0: 2064 6976 6964 656e 6473 3a20 7b64 7473   dividends: {dts
+000125e0: 5f6d 6973 7369 6e67 5f66 726f 6d5f 6361  _missing_from_ca
+000125f0: 6368 657d 220a 2020 2020 2020 2020 2020  che}".          
+00012600: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+00012610: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
+00012620: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
+00012630: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
+00012640: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
+00012650: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
+00012660: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+00012670: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+00012680: 2064 7473 5f6d 6973 7369 6e67 5f66 726f   dts_missing_fro
+00012690: 6d5f 6361 6368 653a 0a20 2020 2020 2020  m_cache:.       
+000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126b0: 2023 2043 6f72 7265 6374 2068 6572 650a   # Correct here.
+000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126d0: 2020 2020 2020 2020 682e 6c6f 635b 6474          h.loc[dt
+000126e0: 2c20 635d 203d 2079 665f 6469 7673 2e6c  , c] = yf_divs.l
+000126f0: 6f63 5b64 745d 0a20 2020 2020 2020 2020  oc[dt].         
+00012700: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00012710: 5f6e 6577 2e6c 6f63 5b64 742c 2063 5d20  _new.loc[dt, c] 
+00012720: 3d20 7966 5f64 6976 732e 6c6f 635b 6474  = yf_divs.loc[dt
+00012730: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00012740: 2020 2020 2020 2020 2020 685f 6d6f 6469            h_modi
+00012750: 6669 6564 203d 2054 7275 650a 0a20 2020  fied = True..   
+00012760: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+00012770: 6f70 7920 6f76 6572 2061 6e79 206d 6973  opy over any mis
+00012780: 7369 6e67 2073 746f 636b 2073 706c 6974  sing stock split
+00012790: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000127a0: 2020 6320 3d20 2253 746f 636b 2053 706c    c = "Stock Spl
+000127b0: 6974 7322 0a20 2020 2020 2020 2020 2020  its".           
+000127c0: 2020 2020 2068 5f73 7320 3d20 682e 6c6f       h_ss = h.lo
+000127d0: 635b 685b 635d 2021 3d20 302e 302c 2063  c[h[c] != 0.0, c
+000127e0: 5d2e 636f 7079 2829 2e64 726f 706e 6128  ].copy().dropna(
+000127f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012800: 2020 7966 5f73 7320 3d20 6466 5f79 662e    yf_ss = df_yf.
+00012810: 6c6f 635b 6466 5f79 665b 635d 2021 3d20  loc[df_yf[c] != 
+00012820: 302e 302c 2063 5d0a 2020 2020 2020 2020  0.0, c].        
+00012830: 2020 2020 2020 2020 6474 735f 6d69 7373          dts_miss
+00012840: 696e 675f 6672 6f6d 5f63 6163 6865 203d  ing_from_cache =
+00012850: 2079 665f 7373 2e69 6e64 6578 5b7e 7966   yf_ss.index[~yf
+00012860: 5f73 732e 696e 6465 782e 6973 696e 2868  _ss.index.isin(h
+00012870: 5f73 732e 696e 6465 7829 5d0a 2020 2020  _ss.index)].    
+00012880: 2020 2020 2020 2020 2020 2020 6474 735f              dts_
+00012890: 6d69 7373 696e 675f 6672 6f6d 5f63 6163  missing_from_cac
+000128a0: 6865 203d 205b 6474 2066 6f72 2064 7420  he = [dt for dt 
+000128b0: 696e 2064 7473 5f6d 6973 7369 6e67 5f66  in dts_missing_f
+000128c0: 726f 6d5f 6361 6368 6520 6966 2064 7420  rom_cache if dt 
+000128d0: 696e 2068 2e69 6e64 6578 5d0a 2020 2020  in h.index].    
+000128e0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000128f0: 656e 2864 7473 5f6d 6973 7369 6e67 5f66  en(dts_missing_f
+00012900: 726f 6d5f 6361 6368 6529 203e 2030 3a0a  rom_cache) > 0:.
+00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012920: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012940: 2020 2020 2020 6d73 6720 3d20 6622 434f        msg = f"CO
+00012950: 5252 4543 5449 4e47 3a20 4361 6368 6520  RRECTING: Cache 
+00012960: 6d69 7373 696e 6720 7468 6573 6520 7374  missing these st
+00012970: 6f63 6b20 7370 6c69 7473 3a20 7b64 7473  ock splits: {dts
+00012980: 5f6d 6973 7369 6e67 5f66 726f 6d5f 6361  _missing_from_ca
+00012990: 6368 657d 220a 2020 2020 2020 2020 2020  che}".          
+000129a0: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+000129b0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
+000129c0: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
+000129d0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
+000129e0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
+000129f0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
+00012a00: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+00012a10: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+00012a20: 2064 7473 5f6d 6973 7369 6e67 5f66 726f   dts_missing_fro
+00012a30: 6d5f 6361 6368 653a 0a20 2020 2020 2020  m_cache:.       
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2023 2043 6f72 7265 6374 2068 6572 650a   # Correct here.
+00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a70: 2020 2020 2020 2020 682e 6c6f 635b 6474          h.loc[dt
+00012a80: 2c20 635d 203d 2079 665f 7373 2e6c 6f63  , c] = yf_ss.loc
+00012a90: 5b64 745d 0a20 2020 2020 2020 2020 2020  [dt].           
+00012aa0: 2020 2020 2020 2020 2020 2020 2068 5f6e               h_n
+00012ab0: 6577 2e6c 6f63 5b64 742c 2063 5d20 3d20  ew.loc[dt, c] = 
+00012ac0: 7966 5f73 732e 6c6f 635b 6474 5d0a 2020  yf_ss.loc[dt].  
 00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ae0: 2020 6d73 6720 3d20 6622 434f 5252 4543    msg = f"CORREC
-00012af0: 5449 4e47 3a20 4361 6368 6520 6d69 7373  TING: Cache miss
-00012b00: 696e 6720 7468 6573 6520 6469 7669 6465  ing these divide
-00012b10: 6e64 733a 207b 6474 735f 6d69 7373 696e  nds: {dts_missin
-00012b20: 675f 6672 6f6d 5f63 6163 6865 7d22 0a20  g_from_cache}". 
-00012b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b40: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00012b50: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00012b60: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00012b70: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-00012b80: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
-00012b90: 7d3a 2022 202b 206d 7367 290a 2020 2020  }: " + msg).    
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012bb0: 666f 7220 6474 2069 6e20 6474 735f 6d69  for dt in dts_mi
-00012bc0: 7373 696e 675f 6672 6f6d 5f63 6163 6865  ssing_from_cache
-00012bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012be0: 2020 2020 2020 2020 2020 2320 436f 7272            # Corr
-00012bf0: 6563 7420 6865 7265 0a20 2020 2020 2020  ect here.       
-00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c10: 2068 2e6c 6f63 5b64 742c 2063 5d20 3d20   h.loc[dt, c] = 
-00012c20: 7966 5f64 6976 732e 6c6f 635b 6474 5d0a  yf_divs.loc[dt].
-00012c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c40: 2020 2020 2020 2020 685f 6e65 772e 6c6f          h_new.lo
-00012c50: 635b 6474 2c20 635d 203d 2079 665f 6469  c[dt, c] = yf_di
-00012c60: 7673 2e6c 6f63 5b64 745d 0a20 2020 2020  vs.loc[dt].     
-00012c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c80: 2020 2068 5f6d 6f64 6966 6965 6420 3d20     h_modified = 
-00012c90: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
-00012ca0: 2020 2020 2020 2320 436f 7079 206f 7665        # Copy ove
-00012cb0: 7220 616e 7920 6d69 7373 696e 6720 7374  r any missing st
-00012cc0: 6f63 6b20 7370 6c69 7473 0a20 2020 2020  ock splits.     
-00012cd0: 2020 2020 2020 2020 2020 2063 203d 2022             c = "
-00012ce0: 5374 6f63 6b20 5370 6c69 7473 220a 2020  Stock Splits".  
-00012cf0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00012d00: 7373 203d 2068 2e6c 6f63 5b68 5b63 5d20  ss = h.loc[h[c] 
-00012d10: 213d 2030 2e30 2c20 635d 2e63 6f70 7928  != 0.0, c].copy(
-00012d20: 292e 6472 6f70 6e61 2829 0a20 2020 2020  ).dropna().     
-00012d30: 2020 2020 2020 2020 2020 2079 665f 7373             yf_ss
-00012d40: 203d 2064 665f 7966 2e6c 6f63 5b64 665f   = df_yf.loc[df_
-00012d50: 7966 5b63 5d20 213d 2030 2e30 2c20 635d  yf[c] != 0.0, c]
-00012d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d70: 2064 7473 5f6d 6973 7369 6e67 5f66 726f   dts_missing_fro
-00012d80: 6d5f 6361 6368 6520 3d20 7966 5f73 732e  m_cache = yf_ss.
-00012d90: 696e 6465 785b 7e79 665f 7373 2e69 6e64  index[~yf_ss.ind
-00012da0: 6578 2e69 7369 6e28 685f 7373 2e69 6e64  ex.isin(h_ss.ind
-00012db0: 6578 295d 0a20 2020 2020 2020 2020 2020  ex)].           
-00012dc0: 2020 2020 2064 7473 5f6d 6973 7369 6e67       dts_missing
-00012dd0: 5f66 726f 6d5f 6361 6368 6520 3d20 5b64  _from_cache = [d
-00012de0: 7420 666f 7220 6474 2069 6e20 6474 735f  t for dt in dts_
-00012df0: 6d69 7373 696e 675f 6672 6f6d 5f63 6163  missing_from_cac
-00012e00: 6865 2069 6620 6474 2069 6e20 682e 696e  he if dt in h.in
-00012e10: 6465 785d 0a20 2020 2020 2020 2020 2020  dex].           
-00012e20: 2020 2020 2069 6620 6c65 6e28 6474 735f       if len(dts_
-00012e30: 6d69 7373 696e 675f 6672 6f6d 5f63 6163  missing_from_cac
-00012e40: 6865 2920 3e20 303a 0a20 2020 2020 2020  he) > 0:.       
-00012e50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00012e60: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-00012e70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00012e80: 7367 203d 2066 2243 4f52 5245 4354 494e  sg = f"CORRECTIN
-00012e90: 473a 2043 6163 6865 206d 6973 7369 6e67  G: Cache missing
-00012ea0: 2074 6865 7365 2073 746f 636b 2073 706c   these stock spl
-00012eb0: 6974 733a 207b 6474 735f 6d69 7373 696e  its: {dts_missin
-00012ec0: 675f 6672 6f6d 5f63 6163 6865 7d22 0a20  g_from_cache}". 
-00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ee0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00012ef0: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00012f00: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00012f10: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-00012f20: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
-00012f30: 7d3a 2022 202b 206d 7367 290a 2020 2020  }: " + msg).    
-00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f50: 666f 7220 6474 2069 6e20 6474 735f 6d69  for dt in dts_mi
-00012f60: 7373 696e 675f 6672 6f6d 5f63 6163 6865  ssing_from_cache
-00012f70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012f80: 2020 2020 2020 2020 2020 2320 436f 7272            # Corr
-00012f90: 6563 7420 6865 7265 0a20 2020 2020 2020  ect here.       
-00012fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fb0: 2068 2e6c 6f63 5b64 742c 2063 5d20 3d20   h.loc[dt, c] = 
-00012fc0: 7966 5f73 732e 6c6f 635b 6474 5d0a 2020  yf_ss.loc[dt].  
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 2020 2020 685f 6e65 772e 6c6f 635b        h_new.loc[
-00012ff0: 6474 2c20 635d 203d 2079 665f 7373 2e6c  dt, c] = yf_ss.l
-00013000: 6f63 5b64 745d 0a20 2020 2020 2020 2020  oc[dt].         
-00013010: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00013020: 5f6d 6f64 6966 6965 6420 3d20 5472 7565  _modified = True
-00013030: 0a0a 2020 2020 2020 2020 2020 2020 665f  ..            f_
-00013040: 6469 6666 203d 2079 6663 752e 5665 7269  diff = yfcu.Veri
-00013050: 6679 5072 6963 6573 4466 2868 2c20 6466  fyPricesDf(h, df
-00013060: 5f79 662c 2073 656c 662e 696e 7465 7276  _yf, self.interv
-00013070: 616c 2c20 7274 6f6c 3d72 746f 6c2c 2076  al, rtol=rtol, v
-00013080: 6f6c 5f72 746f 6c3d 766f 6c5f 7274 6f6c  ol_rtol=vol_rtol
-00013090: 2c20 7175 6965 743d 7175 6965 742c 2064  , quiet=quiet, d
-000130a0: 6562 7567 3d64 6562 7567 290a 2020 2020  ebug=debug).    
-000130b0: 2020 2020 2020 2020 6966 2066 5f64 6966          if f_dif
-000130c0: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
-000130d0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-000130e0: 665f 6469 6666 5f61 6c6c 2e61 6e79 2829  f_diff_all.any()
-000130f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013100: 2020 2020 2020 665f 6469 6666 5f61 6c6c        f_diff_all
-00013110: 203d 2028 665f 6469 6666 5f61 6c6c 207c   = (f_diff_all |
-00013120: 2066 5f64 6966 6629 2e72 656e 616d 6528   f_diff).rename(
-00013130: 665f 6469 6666 2e6e 616d 6529 0a20 2020  f_diff.name).   
-00013140: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00013150: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00013160: 2020 2020 2020 2066 5f64 6966 665f 616c         f_diff_al
-00013170: 6c20 3d20 665f 6469 6666 5f61 6c6c 207c  l = f_diff_all |
-00013180: 2066 5f64 6966 660a 0a20 2020 2020 2020   f_diff..       
-00013190: 2069 6620 6e6f 7420 665f 6469 6666 5f61   if not f_diff_a
-000131a0: 6c6c 2e61 6e79 2829 3a0a 2020 2020 2020  ll.any():.      
-000131b0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
-000131c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131d0: 6d73 6720 3d20 224e 6f20 6469 6666 6572  msg = "No differ
-000131e0: 656e 6365 7322 0a20 2020 2020 2020 2020  ences".         
-000131f0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00013200: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00013210: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00013220: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-00013230: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
-00013240: 7d3a 2022 202b 206d 7367 290a 0a20 2020  }: " + msg)..   
-00013250: 2020 2020 2020 2020 2069 6620 685f 6d6f           if h_mo
-00013260: 6469 6669 6564 3a0a 2020 2020 2020 2020  dified:.        
-00013270: 2020 2020 2020 2020 2320 7966 636d 2e53          # yfcm.S
-00013280: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
-00013290: 656c 662e 7469 636b 6572 2c20 7365 6c66  elf.ticker, self
-000132a0: 2e63 6163 6865 5f6b 6579 2c20 6829 0a20  .cache_key, h). 
-000132b0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-000132c0: 6663 6d2e 5374 6f72 6543 6163 6865 4461  fcm.StoreCacheDa
-000132d0: 7475 6d28 7365 6c66 2e74 6963 6b65 722c  tum(self.ticker,
-000132e0: 2073 656c 662e 6361 6368 655f 6b65 792c   self.cache_key,
-000132f0: 2068 5f6e 6577 290a 2020 2020 2020 2020   h_new).        
-00013300: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
-00013310: 2073 656c 662e 5f67 6574 4361 6368 6564   self._getCached
-00013320: 5072 6963 6573 2829 0a0a 2020 2020 2020  Prices()..      
-00013330: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-00013340: 4578 6974 2866 2250 4d3a 3a5f 7665 7269  Exit(f"PM::_veri
-00013350: 6679 4361 6368 6564 5072 6963 6573 2d7b  fyCachedPrices-{
-00013360: 7365 6c66 2e69 7374 727d 2829 2072 6574  self.istr}() ret
-00013370: 7572 6e69 6e67 2054 7275 6522 290a 2020  urning True").  
-00013380: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013390: 2054 7275 650a 0a20 2020 2020 2020 2068   True..        h
-000133a0: 203d 2068 5f6e 6577 0a20 2020 2020 2020   = h_new.       
-000133b0: 2069 6620 636f 7272 6563 743a 0a20 2020   if correct:.   
-000133c0: 2020 2020 2020 2020 2064 726f 705f 6474           drop_dt
-000133d0: 7320 3d20 665f 6469 6666 5f61 6c6c 2e69  s = f_diff_all.i
-000133e0: 6e64 6578 5b66 5f64 6966 665f 616c 6c5d  ndex[f_diff_all]
-000133f0: 0a20 2020 2020 2020 2020 2020 2064 726f  .            dro
-00013400: 705f 6474 735f 6167 6573 203d 2064 745f  p_dts_ages = dt_
-00013410: 6e6f 7720 2d20 6472 6f70 5f64 7473 0a20  now - drop_dts. 
-00013420: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00013430: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-00013440: 6663 642e 496e 7465 7276 616c 2e57 6565  fcd.Interval.Wee
-00013450: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+00012ae0: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
+00012af0: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+00012b00: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00012b10: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+00012b20: 7465 7276 616c 2e44 6179 7331 2061 6e64  terval.Days1 and
+00012b30: 2064 6976 735f 6466 2069 7320 6e6f 7420   divs_df is not 
+00012b40: 4e6f 6e65 2061 6e64 206e 6f74 2064 6976  None and not div
+00012b50: 735f 6466 2e65 6d70 7479 3a0a 2020 2020  s_df.empty:.    
+00012b60: 2020 2020 2020 2020 2020 2020 2320 5665              # Ve
+00012b70: 7269 6679 2064 6976 6964 656e 6473 0a20  rify dividends. 
+00012b80: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00012b90: 665f 6469 7673 203d 2064 665f 7966 5b27  f_divs = df_yf['
+00012ba0: 4469 7669 6465 6e64 7327 5d5b 6466 5f79  Dividends'][df_y
+00012bb0: 665b 2744 6976 6964 656e 6473 275d 213d  f['Dividends']!=
+00012bc0: 302e 305d 0a20 2020 2020 2020 2020 2020  0.0].           
+00012bd0: 2020 2020 2066 5f6f 7270 6861 6e20 3d20       f_orphan = 
+00012be0: 6e70 2e66 756c 6c28 6469 7673 5f64 662e  np.full(divs_df.
+00012bf0: 7368 6170 655b 305d 2c20 4661 6c73 6529  shape[0], False)
+00012c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c10: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00012c20: 6469 7673 5f64 662e 7368 6170 655b 305d  divs_df.shape[0]
+00012c30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00012c40: 2020 2020 2020 2064 6976 5f64 7420 3d20         div_dt = 
+00012c50: 6469 7673 5f64 662e 696e 6465 785b 695d  divs_df.index[i]
+00012c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c70: 2020 2020 2069 6620 6469 765f 6474 206e       if div_dt n
+00012c80: 6f74 2069 6e20 7966 5f64 6976 732e 696e  ot in yf_divs.in
+00012c90: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
+00012ca0: 2020 2020 2020 2020 2020 2020 2066 5f6f               f_o
+00012cb0: 7270 6861 6e5b 695d 203d 2054 7275 650a  rphan[i] = True.
+00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cd0: 6966 2066 5f6f 7270 6861 6e2e 616e 7928  if f_orphan.any(
+00012ce0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00012cf0: 2020 2020 2020 2069 6620 636f 7272 6563         if correc
+00012d00: 7420 696e 205b 276f 6e65 272c 2027 616c  t in ['one', 'al
+00012d10: 6c27 5d3a 0a20 2020 2020 2020 2020 2020  l']:.           
+00012d20: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00012d30: 6e74 2866 2744 726f 7070 696e 6720 7468  nt(f'Dropping th
+00012d40: 6573 6520 6f72 7068 616e 2064 6976 6964  ese orphan divid
+00012d50: 656e 6473 3a20 7b64 6976 735f 6466 2e69  ends: {divs_df.i
+00012d60: 6e64 6578 2e64 6174 655b 665f 6f72 7068  ndex.date[f_orph
+00012d70: 616e 5d7d 2729 0a20 2020 2020 2020 2020  an]}').         
+00012d80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00012d90: 7270 6861 6e5f 6469 7673 203d 2064 6976  rphan_divs = div
+00012da0: 735f 6466 5b66 5f6f 7270 6861 6e5d 2e63  s_df[f_orphan].c
+00012db0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+00012dc0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00012dd0: 7068 616e 5f64 6976 735b 2744 6976 6964  phan_divs['Divid
+00012de0: 656e 6473 275d 203d 2030 2e30 0a20 2020  ends'] = 0.0.   
+00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e00: 2020 2020 206f 7270 6861 6e5f 6469 7673       orphan_divs
+00012e10: 5b27 436c 6f73 6520 6461 7920 6265 666f  ['Close day befo
+00012e20: 7265 275d 203d 2031 2e30 0a20 2020 2020  re'] = 1.0.     
+00012e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e40: 2020 2023 2070 7269 6e74 2822 2d20 6469     # print("- di
+00012e50: 7673 5f64 663a 2229 203b 2070 7269 6e74  vs_df:") ; print
+00012e60: 2864 6976 735f 6466 5b5b 2744 6976 6964  (divs_df[['Divid
+00012e70: 656e 6473 272c 2027 5375 7065 7273 6564  ends', 'Supersed
+00012e80: 6564 2064 6976 275d 5d29 0a20 2020 2020  ed div']]).     
+00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ea0: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
+00012eb0: 4765 7448 6973 746f 7279 2822 4576 656e  GetHistory("Even
+00012ec0: 7473 2229 2e55 7064 6174 6544 6976 6964  ts").UpdateDivid
+00012ed0: 656e 6473 286f 7270 6861 6e5f 6469 7673  ends(orphan_divs
+00012ee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012ef0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f10: 2020 2020 6966 206e 6f74 2071 7569 6574      if not quiet
+00012f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012f30: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00012f40: 7673 5f6f 7270 6861 6e20 3d20 6469 7673  vs_orphan = divs
+00012f50: 5f64 665b 665f 6f72 7068 616e 5d5b 5b27  _df[f_orphan][['
+00012f60: 4469 7669 6465 6e64 7327 5d5d 0a20 2020  Dividends']].   
+00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f80: 2020 2020 2020 2020 2064 6976 735f 6f72           divs_or
+00012f90: 7068 616e 2e69 6e64 6578 203d 2064 6976  phan.index = div
+00012fa0: 735f 6f72 7068 616e 2e69 6e64 6578 2e64  s_orphan.index.d
+00012fb0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+00012fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fd0: 7072 696e 7428 272d 2064 6574 6563 7465  print('- detecte
+00012fe0: 6420 6f72 7068 616e 2064 6976 6964 656e  d orphan dividen
+00012ff0: 6473 3a27 2c20 6469 7673 5f6f 7270 6861  ds:', divs_orpha
+00013000: 6e2e 746f 5f64 6963 7428 2929 0a20 2020  n.to_dict()).   
+00013010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013020: 2020 2020 2066 6f72 2064 7420 696e 2064       for dt in d
+00013030: 6976 735f 6466 2e69 6e64 6578 5b66 5f6f  ivs_df.index[f_o
+00013040: 7270 6861 6e5d 3a0a 2020 2020 2020 2020  rphan]:.        
+00013050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013060: 2020 2020 665f 6469 6666 5f61 6c6c 5b64      f_diff_all[d
+00013070: 745d 203d 2054 7275 650a 0a20 2020 2020  t] = True..     
+00013080: 2020 2020 2020 2066 5f64 6966 6620 3d20         f_diff = 
+00013090: 7966 6375 2e56 6572 6966 7950 7269 6365  yfcu.VerifyPrice
+000130a0: 7344 6628 682c 2064 665f 7966 2c20 7365  sDf(h, df_yf, se
+000130b0: 6c66 2e69 6e74 6572 7661 6c2c 2072 746f  lf.interval, rto
+000130c0: 6c3d 7274 6f6c 2c20 766f 6c5f 7274 6f6c  l=rtol, vol_rtol
+000130d0: 3d76 6f6c 5f72 746f 6c2c 2071 7569 6574  =vol_rtol, quiet
+000130e0: 3d71 7569 6574 2c20 6465 6275 673d 6465  =quiet, debug=de
+000130f0: 6275 6729 0a20 2020 2020 2020 2020 2020  bug).           
+00013100: 2069 6620 665f 6469 6666 2e61 6e79 2829   if f_diff.any()
+00013110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013120: 2020 6966 206e 6f74 2066 5f64 6966 665f    if not f_diff_
+00013130: 616c 6c2e 616e 7928 293a 0a20 2020 2020  all.any():.     
+00013140: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00013150: 5f64 6966 665f 616c 6c20 3d20 2866 5f64  _diff_all = (f_d
+00013160: 6966 665f 616c 6c20 7c20 665f 6469 6666  iff_all | f_diff
+00013170: 292e 7265 6e61 6d65 2866 5f64 6966 662e  ).rename(f_diff.
+00013180: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00013190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 665f 6469 6666 5f61 6c6c 203d 2066 5f64  f_diff_all = f_d
+000131c0: 6966 665f 616c 6c20 7c20 665f 6469 6666  iff_all | f_diff
+000131d0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+000131e0: 2066 5f64 6966 665f 616c 6c2e 616e 7928   f_diff_all.any(
+000131f0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00013200: 6620 685f 6d6f 6469 6669 6564 3a0a 2020  f h_modified:.  
+00013210: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013220: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
+00013230: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
+00013240: 2c20 7365 6c66 2e63 6163 6865 5f6b 6579  , self.cache_key
+00013250: 2c20 6829 0a20 2020 2020 2020 2020 2020  , h).           
+00013260: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
+00013270: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
+00013280: 6963 6b65 722c 2073 656c 662e 6361 6368  icker, self.cach
+00013290: 655f 6b65 792c 2068 5f6e 6577 290a 2020  e_key, h_new).  
+000132a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000132b0: 6c66 2e68 203d 2073 656c 662e 5f67 6574  lf.h = self._get
+000132c0: 4361 6368 6564 5072 6963 6573 2829 0a0a  CachedPrices()..
+000132d0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+000132e0: 2e54 7261 6365 4578 6974 2866 2250 4d3a  .TraceExit(f"PM:
+000132f0: 3a5f 7665 7269 6679 4361 6368 6564 5072  :_verifyCachedPr
+00013300: 6963 6573 2d7b 7365 6c66 2e69 7374 727d  ices-{self.istr}
+00013310: 2829 2072 6574 7572 6e69 6e67 2054 7275  () returning Tru
+00013320: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00013330: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+00013340: 2020 2020 2068 203d 2068 5f6e 6577 0a20       h = h_new. 
+00013350: 2020 2020 2020 2069 6620 636f 7272 6563         if correc
+00013360: 7420 696e 205b 276f 6e65 272c 2027 616c  t in ['one', 'al
+00013370: 6c27 5d3a 0a20 2020 2020 2020 2020 2020  l']:.           
+00013380: 2064 726f 705f 6474 7320 3d20 665f 6469   drop_dts = f_di
+00013390: 6666 5f61 6c6c 2e69 6e64 6578 5b66 5f64  ff_all.index[f_d
+000133a0: 6966 665f 616c 6c5d 0a20 2020 2020 2020  iff_all].       
+000133b0: 2020 2020 2064 726f 705f 6474 735f 6167       drop_dts_ag
+000133c0: 6573 203d 2064 745f 6e6f 7720 2d20 6472  es = dt_now - dr
+000133d0: 6f70 5f64 7473 0a20 2020 2020 2020 2020  op_dts.         
+000133e0: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+000133f0: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+00013400: 7276 616c 2e57 6565 6b3a 0a20 2020 2020  rval.Week:.     
+00013410: 2020 2020 2020 2020 2020 2066 203d 2064             f = d
+00013420: 726f 705f 6474 735f 6167 6573 203e 2074  rop_dts_ages > t
+00013430: 696d 6564 656c 7461 2864 6179 733d 3829  imedelta(days=8)
+00013440: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00013450: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
 00013460: 2020 2066 203d 2064 726f 705f 6474 735f     f = drop_dts_
 00013470: 6167 6573 203e 2074 696d 6564 656c 7461  ages > timedelta
-00013480: 2864 6179 733d 3829 0a20 2020 2020 2020  (days=8).       
-00013490: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000134a0: 2020 2020 2020 2020 2020 2066 203d 2064             f = d
-000134b0: 726f 705f 6474 735f 6167 6573 203e 2074  rop_dts_ages > t
-000134c0: 696d 6564 656c 7461 2864 6179 733d 3429  imedelta(days=4)
-000134d0: 2020 2320 616c 6c6f 7720 666f 7220 7765    # allow for we
-000134e0: 656b 656e 640a 2020 2020 2020 2020 2020  ekend.          
-000134f0: 2020 6472 6f70 5f64 7473 5f6e 6f74 5f72    drop_dts_not_r
-00013500: 6563 656e 7420 3d20 6472 6f70 5f64 7473  ecent = drop_dts
-00013510: 5b66 5d0a 2020 2020 2020 2020 2020 2020  [f].            
-00013520: 6472 6f70 5f64 7473 5f61 6765 7320 3d20  drop_dts_ages = 
-00013530: 6472 6f70 5f64 7473 5f61 6765 735b 665d  drop_dts_ages[f]
-00013540: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-00013550: 203d 2066 227b 7365 6c66 2e74 6963 6b65   = f"{self.ticke
-00013560: 727d 3a20 7b73 656c 662e 6973 7472 7d2d  r}: {self.istr}-
-00013570: 7072 6963 6573 2070 726f 626c 656d 7322  prices problems"
-00013580: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013590: 7365 6c66 2e63 6f6e 7469 6775 6f75 733a  self.contiguous:
-000135a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000135b0: 2023 2044 6169 6c79 206d 7573 7420 616c   # Daily must al
-000135c0: 7761 7973 2062 6520 636f 6e74 6967 756f  ways be contiguo
-000135d0: 7573 2c20 736f 2064 726f 7020 6576 6572  us, so drop ever
-000135e0: 7974 6869 6e67 2066 726f 6d20 6669 7273  ything from firs
-000135f0: 7420 6469 6666 0a20 2020 2020 2020 2020  t diff.         
-00013600: 2020 2020 2020 2069 6620 6c65 6e28 6472         if len(dr
-00013610: 6f70 5f64 7473 5f6e 6f74 5f72 6563 656e  op_dts_not_recen
-00013620: 7429 203e 2030 3a0a 2020 2020 2020 2020  t) > 0:.        
-00013630: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00013640: 656e 2864 726f 705f 6474 735f 6e6f 745f  en(drop_dts_not_
-00013650: 7265 6365 6e74 2920 3d3d 2031 3a0a 2020  recent) == 1:.  
-00013660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013670: 2020 2020 2020 6d73 6720 2b3d 2066 223a        msg += f":
-00013680: 2064 726f 7070 696e 6720 7b64 726f 705f   dropping {drop_
-00013690: 6474 735f 6e6f 745f 7265 6365 6e74 5b30  dts_not_recent[0
-000136a0: 5d2e 6461 7465 2829 7d22 0a20 2020 2020  ].date()}".     
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000136c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000136d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000136e0: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-000136f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013700: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
-00013710: 3d20 6622 3a20 6472 6f70 7069 6e67 2061  = f": dropping a
-00013720: 6c6c 2072 6f77 7320 6672 6f6d 207b 6472  ll rows from {dr
-00013730: 6f70 5f64 7473 5f6e 6f74 5f72 6563 656e  op_dts_not_recen
-00013740: 745b 305d 2e64 6174 6528 297d 220a 2020  t[0].date()}".  
-00013750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013760: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00013770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013780: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
-00013790: 223a 2064 726f 7070 696e 6720 616c 6c20  ": dropping all 
-000137a0: 726f 7773 2066 726f 6d20 7b64 726f 705f  rows from {drop_
-000137b0: 6474 735f 6e6f 745f 7265 6365 6e74 5b30  dts_not_recent[0
-000137c0: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
-000137d0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-000137e0: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
-000137f0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-00013800: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
-00013810: 6e74 2866 227b 7365 6c66 2e74 6963 6b65  nt(f"{self.ticke
-00013820: 727d 3a20 2220 2b20 6d73 6729 0a20 2020  r}: " + msg).   
-00013830: 2020 2020 2020 2020 2020 2020 2068 203d               h =
-00013840: 2068 5b68 2e69 6e64 6578 203c 2064 726f   h[h.index < dro
-00013850: 705f 6474 735b 305d 5d0a 2020 2020 2020  p_dts[0]].      
-00013860: 2020 2020 2020 2020 2020 685f 6d6f 6469            h_modi
-00013870: 6669 6564 203d 2054 7275 650a 2020 2020  fied = True.    
-00013880: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00013890: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
-000138a0: 3d20 7365 6c66 2e68 2e73 6861 7065 5b30  = self.h.shape[0
-000138b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000138c0: 2020 6e5f 6472 6f70 203d 206e 702e 7375    n_drop = np.su
-000138d0: 6d28 665f 6469 6666 5f61 6c6c 290a 2020  m(f_diff_all).  
-000138e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000138f0: 206c 656e 2864 726f 705f 6474 735f 6e6f   len(drop_dts_no
-00013900: 745f 7265 6365 6e74 2920 3e20 303a 0a20  t_recent) > 0:. 
-00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013920: 2020 2069 6620 6c65 6e28 6472 6f70 5f64     if len(drop_d
-00013930: 7473 5f6e 6f74 5f72 6563 656e 7429 203c  ts_not_recent) <
-00013940: 2031 303a 0a20 2020 2020 2020 2020 2020   10:.           
-00013950: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00013960: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-00013970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013980: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
-00013990: 3d20 6622 3a20 6472 6f70 7069 6e67 207b  = f": dropping {
-000139a0: 6472 6f70 5f64 7473 5f6e 6f74 5f72 6563  drop_dts_not_rec
-000139b0: 656e 742e 6461 7465 2e61 7374 7970 6528  ent.date.astype(
-000139c0: 7374 7229 7d22 0a20 2020 2020 2020 2020  str)}".         
-000139d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000139e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000139f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a00: 206d 7367 202b 3d20 6622 3a20 6472 6f70   msg += f": drop
-00013a10: 7069 6e67 207b 6472 6f70 5f64 7473 5f6e  ping {drop_dts_n
-00013a20: 6f74 5f72 6563 656e 742e 747a 5f6c 6f63  ot_recent.tz_loc
-00013a30: 616c 697a 6528 4e6f 6e65 297d 220a 2020  alize(None)}".  
-00013a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00013a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a70: 6d73 6720 2b3d 2066 223a 2064 726f 7070  msg += f": dropp
-00013a80: 696e 6720 7b6e 5f64 726f 707d 2f7b 6e7d  ing {n_drop}/{n}
-00013a90: 2072 6f77 7322 0a20 2020 2020 2020 2020   rows".         
-00013aa0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
-00013ab0: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
-00013ac0: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
-00013ad0: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
-00013ae0: 7072 696e 7428 6622 7b73 656c 662e 7469  print(f"{self.ti
-00013af0: 636b 6572 7d3a 2022 202b 206d 7367 290a  cker}: " + msg).
-00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 6832 203d 2068 2e64 726f 7028 6472 6f70  h2 = h.drop(drop
-00013b20: 5f64 7473 290a 2020 2020 2020 2020 2020  _dts).          
-00013b30: 2020 2020 2020 6966 2068 2e73 6861 7065        if h.shape
-00013b40: 5b30 5d2d 6832 2e73 6861 7065 5b30 5d20  [0]-h2.shape[0] 
-00013b50: 213d 206e 5f64 726f 703a 0a20 2020 2020  != n_drop:.     
-00013b60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013b70: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
-00013b80: 6865 7265 2229 0a20 2020 2020 2020 2020  here").         
-00013b90: 2020 2020 2020 2068 203d 2068 320a 2020         h = h2.  
-00013ba0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00013bb0: 6d6f 6469 6669 6564 203d 2054 7275 650a  modified = True.
-00013bc0: 2020 2020 2020 2020 2020 2020 6966 2068              if h
-00013bd0: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
-00013be0: 2020 2020 2020 2020 6820 3d20 4e6f 6e65          h = None
-00013bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013c00: 2068 5f6d 6f64 6966 6965 6420 3d20 5472   h_modified = Tr
-00013c10: 7565 0a0a 2020 2020 2020 2020 656c 7365  ue..        else
-00013c20: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00013c30: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-00013c40: 2020 2020 2020 2020 6e20 3d20 6e70 2e73          n = np.s
-00013c50: 756d 2866 5f64 6966 665f 616c 6c29 0a20  um(f_diff_all). 
-00013c60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00013c70: 6620 6e20 3c20 353a 0a20 2020 2020 2020  f n < 5:.       
-00013c80: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00013c90: 203d 2022 6469 6666 6572 656e 6365 7320   = "differences 
-00013ca0: 666f 756e 6420 6275 7420 6e6f 7420 636f  found but not co
-00013cb0: 7272 6563 7469 6e67 3a20 220a 2020 2020  rrecting: ".    
-00013cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cd0: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
-00013ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013cf0: 2020 2020 2020 2020 2020 6d73 6720 2b3d            msg +=
-00013d00: 2066 227b 665f 6469 6666 5f61 6c6c 2e69   f"{f_diff_all.i
-00013d10: 6e64 6578 5b66 5f64 6966 665f 616c 6c5d  ndex[f_diff_all]
-00013d20: 2e64 6174 657d 220a 2020 2020 2020 2020  .date}".        
-00013d30: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00013d40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013d50: 2020 2020 2020 2020 2020 6d73 6720 2b3d            msg +=
-00013d60: 2066 227b 665f 6469 6666 5f61 6c6c 2e69   f"{f_diff_all.i
-00013d70: 6e64 6578 5b66 5f64 6966 665f 616c 6c5d  ndex[f_diff_all]
-00013d80: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00013d90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013da0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00013db0: 203d 2066 227b 6e70 2e73 756d 2866 5f64   = f"{np.sum(f_d
-00013dc0: 6966 665f 616c 6c29 7d20 6469 6666 6572  iff_all)} differ
-00013dd0: 656e 6365 7320 666f 756e 6420 6275 7420  ences found but 
-00013de0: 6e6f 7420 636f 7272 6563 7469 6e67 220a  not correcting".
-00013df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e00: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00013e10: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00013e20: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-00013e30: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
-00013e40: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
-00013e50: 6d73 6729 0a0a 2020 2020 2020 2020 6966  msg)..        if
-00013e60: 2063 6f72 7265 6374 2061 6e64 2066 5f64   correct and f_d
-00013e70: 6966 665f 616c 6c2e 6e61 6d65 203d 3d20  iff_all.name == 
-00013e80: 2244 6976 2d41 646a 7573 7422 2061 6e64  "Div-Adjust" and
-00013e90: 2073 656c 662e 696e 7465 7276 616c 2021   self.interval !
-00013ea0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-00013eb0: 4461 7973 313a 0a20 2020 2020 2020 2020  Days1:.         
-00013ec0: 2020 2023 2041 6c6c 2064 6966 6665 7265     # All differe
-00013ed0: 6e63 6573 2063 6175 7365 6420 6279 2062  nces caused by b
-00013ee0: 6164 2064 6976 6964 656e 6420 6461 7461  ad dividend data
-00013ef0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00013f00: 546f 2066 6978 2c20 6e65 6564 2074 6f20  To fix, need to 
-00013f10: 666f 7263 6520 6120 7265 2d66 6574 6368  force a re-fetch
-00013f20: 206f 6620 3164 2064 6174 612e 0a20 2020   of 1d data..   
-00013f30: 2020 2020 2020 2020 2068 6973 7431 6420           hist1d 
-00013f40: 3d20 7365 6c66 2e6d 616e 6167 6572 2e47  = self.manager.G
-00013f50: 6574 4869 7374 6f72 7928 7966 6364 2e49  etHistory(yfcd.I
-00013f60: 6e74 6572 7661 6c2e 4461 7973 3129 0a20  nterval.Days1). 
-00013f70: 2020 2020 2020 2020 2020 2068 3164 203d             h1d =
-00013f80: 2068 6973 7431 642e 5f67 6574 4361 6368   hist1d._getCach
-00013f90: 6564 5072 6963 6573 2829 0a20 2020 2020  edPrices().     
-00013fa0: 2020 2020 2020 2065 6e64 5f64 203d 2066         end_d = f
-00013fb0: 5f64 6966 665f 616c 6c2e 696e 6465 785b  _diff_all.index[
-00013fc0: 2d31 5d2e 6461 7465 2829 0a20 2020 2020  -1].date().     
-00013fd0: 2020 2020 2020 2023 2042 7574 206f 6e6c         # But onl
-00013fe0: 7920 6966 206f 6620 3164 2064 6174 6120  y if of 1d data 
-00013ff0: 6665 7463 6865 6420 6174 206c 6561 7374  fetched at least
-00014000: 2032 3420 686f 7572 7320 6167 6f2c 2062   24 hours ago, b
-00014010: 6563 6175 7365 206d 6179 6265 0a20 2020  ecause maybe.   
-00014020: 2020 2020 2020 2020 2023 2077 6520 6a75           # we ju
-00014030: 7374 2066 6978 6564 2074 6865 2031 6420  st fixed the 1d 
-00014040: 6461 7461 2e0a 2020 2020 2020 2020 2020  data..          
-00014050: 2020 665f 6665 7463 6865 645f 7265 6365    f_fetched_rece
-00014060: 6e74 6c79 203d 2068 3164 5b27 4665 7463  ntly = h1d['Fetc
-00014070: 6844 6174 6527 5d20 3e20 2864 745f 6e6f  hDate'] > (dt_no
-00014080: 7720 2d20 7469 6d65 6465 6c74 6128 6461  w - timedelta(da
-00014090: 7973 3d31 2929 0a20 2020 2020 2020 2020  ys=1)).         
-000140a0: 2020 2066 5f66 6574 6368 6564 5f72 6563     f_fetched_rec
-000140b0: 656e 746c 795f 6e6f 7420 3d20 7e66 5f66  ently_not = ~f_f
-000140c0: 6574 6368 6564 5f72 6563 656e 746c 790a  etched_recently.
-000140d0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000140e0: 5f66 6574 6368 6564 5f72 6563 656e 746c  _fetched_recentl
-000140f0: 795f 6e6f 742e 616e 7928 293a 0a20 2020  y_not.any():.   
-00014100: 2020 2020 2020 2020 2020 2020 2066 5f66               f_f
-00014110: 6574 6368 6564 5f72 6563 656e 746c 795f  etched_recently_
-00014120: 6e6f 745f 6c61 7374 5f69 6478 203d 206e  not_last_idx = n
-00014130: 702e 7768 6572 6528 665f 6665 7463 6865  p.where(f_fetche
-00014140: 645f 7265 6365 6e74 6c79 5f6e 6f74 295b  d_recently_not)[
-00014150: 305d 5b2d 315d 0a20 2020 2020 2020 2020  0][-1].         
-00014160: 2020 2020 2020 2065 6e64 5f64 203d 2068         end_d = h
-00014170: 3164 2e69 6e64 6578 5b66 5f66 6574 6368  1d.index[f_fetch
-00014180: 6564 5f72 6563 656e 746c 795f 6e6f 745f  ed_recently_not_
-00014190: 6c61 7374 5f69 6478 5d0a 2020 2020 2020  last_idx].      
-000141a0: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-000141b0: 6622 6869 7374 2d7b 7365 6c66 2e69 7374  f"hist-{self.ist
-000141c0: 727d 2069 7320 6469 7363 6172 6469 6e67  r} is discarding
-000141d0: 2031 6420 6461 7461 2062 6566 6f72 6520   1d data before 
-000141e0: 7b65 6e64 5f64 7d20 746f 2066 6f72 6365  {end_d} to force
-000141f0: 2072 652d 6665 7463 6820 6f66 2064 6976   re-fetch of div
-00014200: 6964 656e 6473 220a 2020 2020 2020 2020  idends".        
-00014210: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-00014220: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
-00014230: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-00014240: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
-00014250: 6e74 2866 227b 7365 6c66 2e74 6963 6b65  nt(f"{self.ticke
-00014260: 727d 3a20 2220 2b20 6d73 6729 0a20 2020  r}: " + msg).   
-00014270: 2020 2020 2020 2020 2020 2020 2068 3164               h1d
-00014280: 203d 2068 3164 5b73 7472 2865 6e64 5f64   = h1d[str(end_d
-00014290: 293a 5d0a 0a20 2020 2020 2020 2020 2020  ):]..           
-000142a0: 2068 6973 7431 642e 5f75 7064 6174 6564   hist1d._updated
-000142b0: 4361 6368 6564 5072 6963 6573 2868 3164  CachedPrices(h1d
-000142c0: 290a 0a20 2020 2020 2020 2069 6620 685f  )..        if h_
-000142d0: 6d6f 6469 6669 6564 3a0a 2020 2020 2020  modified:.      
-000142e0: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-000142f0: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-00014300: 7469 636b 6572 2c20 7365 6c66 2e63 6163  ticker, self.cac
-00014310: 6865 5f6b 6579 2c20 6829 0a20 2020 2020  he_key, h).     
-00014320: 2020 2020 2020 2073 656c 662e 6820 3d20         self.h = 
-00014330: 7365 6c66 2e5f 6765 7443 6163 6865 6450  self._getCachedP
-00014340: 7269 6365 7328 290a 0a20 2020 2020 2020  rices()..       
-00014350: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
-00014360: 6622 504d 3a3a 5f76 6572 6966 7943 6163  f"PM::_verifyCac
-00014370: 6865 6450 7269 6365 732d 7b73 656c 662e  hedPrices-{self.
-00014380: 6973 7472 7d28 2920 7265 7475 726e 696e  istr}() returnin
-00014390: 6720 4661 6c73 6522 290a 2020 2020 2020  g False").      
-000143a0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-000143b0: 2020 2020 6465 6620 5f66 6574 6368 5966      def _fetchYf
-000143c0: 4869 7374 6f72 7928 7365 6c66 2c20 7073  History(self, ps
-000143d0: 7472 2c20 7374 6172 742c 2065 6e64 2c20  tr, start, end, 
-000143e0: 7072 6570 6f73 742c 2064 6562 7567 2c20  prepost, debug, 
-000143f0: 7665 7269 6679 5f69 6e74 6572 7661 6c73  verify_intervals
-00014400: 3d54 7275 652c 2064 6973 6162 6c65 5f79  =True, disable_y
-00014410: 6663 5f6d 6574 6164 6174 613d 4661 6c73  fc_metadata=Fals
-00014420: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
-00014430: 7461 7274 2069 7320 4e6f 6e65 2061 6e64  tart is None and
-00014440: 2065 6e64 2069 7320 4e6f 6e65 2061 6e64   end is None and
-00014450: 2070 7374 7220 6973 204e 6f6e 653a 0a20   pstr is None:. 
-00014460: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00014470: 2056 616c 7565 4572 726f 7228 224d 7573   ValueError("Mus
-00014480: 7420 7072 6f76 6964 6520 7661 6c75 6520  t provide value 
-00014490: 666f 7220 6f6e 6520 6f66 3a20 2773 7461  for one of: 'sta
-000144a0: 7274 272c 2027 656e 6427 2c20 2770 7374  rt', 'end', 'pst
-000144b0: 7227 2229 0a20 2020 2020 2020 2069 6620  r'").        if 
-000144c0: 7073 7472 2069 7320 6e6f 7420 4e6f 6e65  pstr is not None
-000144d0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-000144e0: 6375 2e54 7970 6543 6865 636b 5374 7228  cu.TypeCheckStr(
-000144f0: 7073 7472 2c20 2270 7374 7222 290a 2020  pstr, "pstr").  
-00014500: 2020 2020 2020 6966 2073 7461 7274 2069        if start i
-00014510: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00014520: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00014530: 6543 6865 636b 496e 7465 7276 616c 4474  eCheckIntervalDt
-00014540: 2873 7461 7274 2c20 7365 6c66 2e69 6e74  (start, self.int
-00014550: 6572 7661 6c2c 2022 7374 6172 7422 290a  erval, "start").
-00014560: 2020 2020 2020 2020 6966 2065 6e64 2069          if end i
-00014570: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00014580: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00014590: 6543 6865 636b 496e 7465 7276 616c 4474  eCheckIntervalDt
-000145a0: 2865 6e64 2c20 7365 6c66 2e69 6e74 6572  (end, self.inter
-000145b0: 7661 6c2c 2022 656e 6422 290a 2020 2020  val, "end").    
-000145c0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-000145d0: 636b 426f 6f6c 2870 7265 706f 7374 2c20  ckBool(prepost, 
-000145e0: 2270 7265 706f 7374 2229 0a20 2020 2020  "prepost").     
-000145f0: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
-00014600: 6b42 6f6f 6c28 6465 6275 672c 2022 6465  kBool(debug, "de
-00014610: 6275 6722 290a 0a20 2020 2020 2020 2064  bug")..        d
-00014620: 6562 7567 5f79 6663 203d 2046 616c 7365  ebug_yfc = False
-00014630: 0a20 2020 2020 2020 2023 2064 6562 7567  .        # debug
-00014640: 5f79 6663 203d 2054 7275 650a 0a20 2020  _yfc = True..   
-00014650: 2020 2020 206c 6f67 5f6d 7367 203d 2066       log_msg = f
-00014660: 2250 4d3a 3a5f 6665 7463 6859 6648 6973  "PM::_fetchYfHis
-00014670: 746f 7279 2d7b 7365 6c66 2e69 7374 727d  tory-{self.istr}
-00014680: 2870 7374 723d 7b70 7374 727d 202c 207b  (pstr={pstr} , {
-00014690: 7374 6172 747d 2d3e 7b65 6e64 7d2c 2070  start}->{end}, p
-000146a0: 7265 706f 7374 3d7b 7072 6570 6f73 747d  repost={prepost}
-000146b0: 2922 0a20 2020 2020 2020 2069 6620 7966  )".        if yf
-000146c0: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-000146d0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-000146e0: 2020 2079 6663 6c2e 5472 6163 6545 6e74     yfcl.TraceEnt
-000146f0: 6572 286c 6f67 5f6d 7367 290a 2020 2020  er(log_msg).    
-00014700: 2020 2020 656c 6966 2064 6562 7567 5f79      elif debug_y
-00014710: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-00014720: 7072 696e 7428 2222 290a 2020 2020 2020  print("").      
-00014730: 2020 2020 2020 7072 696e 7428 6c6f 675f        print(log_
-00014740: 6d73 6729 0a0a 2020 2020 2020 2020 6966  msg)..        if
-00014750: 2070 7374 7220 6973 206e 6f74 204e 6f6e   pstr is not Non
-00014760: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00014770: 6620 2873 7461 7274 2069 7320 6e6f 7420  f (start is not 
-00014780: 4e6f 6e65 2920 616e 6420 2865 6e64 2069  None) and (end i
-00014790: 7320 6e6f 7420 4e6f 6e65 293a 0a20 2020  s not None):.   
-000147a0: 2020 2020 2020 2020 2020 2020 2023 2073               # s
-000147b0: 7461 7274 2f65 6e64 2074 616b 6520 7072  tart/end take pr
-000147c0: 6563 6564 656e 6365 206f 7665 7220 7073  ecedence over ps
-000147d0: 7472 0a20 2020 2020 2020 2020 2020 2020  tr.             
-000147e0: 2020 2070 7374 7220 3d20 4e6f 6e65 0a0a     pstr = None..
-000147f0: 2020 2020 2020 2020 747a 5f65 7863 6861          tz_excha
-00014800: 6e67 6520 3d20 7365 6c66 2e74 7a0a 2020  nge = self.tz.  
-00014810: 2020 2020 2020 7464 5f31 6420 3d20 7469        td_1d = ti
-00014820: 6d65 6465 6c74 6128 6461 7973 3d31 290a  medelta(days=1).
-00014830: 2020 2020 2020 2020 6474 5f6e 6f77 203d          dt_now =
-00014840: 2070 642e 5469 6d65 7374 616d 702e 7574   pd.Timestamp.ut
-00014850: 636e 6f77 2829 2e74 7a5f 636f 6e76 6572  cnow().tz_conver
-00014860: 7428 5a6f 6e65 496e 666f 2822 5554 4322  t(ZoneInfo("UTC"
-00014870: 2929 0a0a 2020 2020 2020 2020 6966 2070  ))..        if p
-00014880: 7374 7220 6973 206e 6f74 204e 6f6e 653a  str is not None:
-00014890: 0a20 2020 2020 2020 2020 2020 2064 6620  .            df 
-000148a0: 3d20 7365 6c66 2e5f 6665 7463 6859 6648  = self._fetchYfH
-000148b0: 6973 746f 7279 5f70 6572 696f 6428 7073  istory_period(ps
-000148c0: 7472 2c20 7072 6570 6f73 742c 2064 6562  tr, prepost, deb
-000148d0: 7567 290a 2020 2020 2020 2020 2020 2020  ug).            
-000148e0: 6669 7273 745f 6665 7463 685f 6661 696c  first_fetch_fail
-000148f0: 6564 203d 2064 6620 6973 204e 6f6e 6520  ed = df is None 
-00014900: 6f72 2064 662e 656d 7074 790a 0a20 2020  or df.empty..   
-00014910: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014920: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00014930: 6e74 7261 6461 793a 0a20 2020 2020 2020  ntraday:.       
-00014940: 2020 2020 2020 2020 206d 6178 4c6f 6f6b           maxLook
-00014950: 6261 636b 203d 2079 6663 642e 7966 4d61  back = yfcd.yfMa
-00014960: 7846 6574 6368 4c6f 6f6b 6261 636b 5b73  xFetchLookback[s
-00014970: 656c 662e 696e 7465 7276 616c 5d20 2d20  elf.interval] - 
-00014980: 7469 6d65 6465 6c74 6128 7365 636f 6e64  timedelta(second
-00014990: 733d 3130 290a 2020 2020 2020 2020 2020  s=10).          
-000149a0: 2020 2020 2020 6966 206d 6178 4c6f 6f6b        if maxLook
-000149b0: 6261 636b 2069 7320 6e6f 7420 4e6f 6e65  back is not None
-000149c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000149d0: 2020 2020 2020 7374 6172 7420 3d20 6d61        start = ma
-000149e0: 7828 7374 6172 742c 2064 745f 6e6f 7720  x(start, dt_now 
-000149f0: 2d20 6d61 784c 6f6f 6b62 6163 6b29 0a20  - maxLookback). 
-00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a10: 2020 2069 6620 7374 6172 7420 3e3d 2065     if start >= e
-00014a20: 6e64 3a0a 2020 2020 2020 2020 2020 2020  nd:.            
-00014a30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00014a40: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
-00014a50: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
-00014a60: 203d 2073 7461 7274 0a20 2020 2020 2020   = start.       
-00014a70: 2020 2020 2066 6574 6368 5f65 6e64 203d       fetch_end =
-00014a80: 2065 6e64 0a0a 2020 2020 2020 2020 2020   end..          
-00014a90: 2020 6966 2065 6e64 2069 7320 6e6f 7420    if end is not 
-00014aa0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00014ab0: 2020 2020 2020 2320 4966 2027 6665 7463        # If 'fetc
-00014ac0: 685f 656e 6427 2069 6e20 6675 7475 7265  h_end' in future
-00014ad0: 2074 6865 6e20 6361 7020 746f 2065 7863   then cap to exc
-00014ae0: 6861 6e67 6520 6d69 646e 6967 6874 0a20  hange midnight. 
-00014af0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00014b00: 746e 6f77 5f65 7863 6861 6e67 6520 3d20  tnow_exchange = 
-00014b10: 6474 5f6e 6f77 2e74 7a5f 636f 6e76 6572  dt_now.tz_conver
-00014b20: 7428 747a 5f65 7863 6861 6e67 6529 0a20  t(tz_exchange). 
-00014b30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014b40: 6620 6973 696e 7374 616e 6365 2865 6e64  f isinstance(end
-00014b50: 2c20 6461 7465 7469 6d65 293a 0a20 2020  , datetime):.   
-00014b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b70: 2065 6e64 5f64 7420 3d20 656e 640a 2020   end_dt = end.  
-00014b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b90: 2020 2320 656e 645f 6420 3d20 656e 642e    # end_d = end.
-00014ba0: 6173 7469 6d65 7a6f 6e65 2874 7a5f 6578  astimezone(tz_ex
-00014bb0: 6368 616e 6765 292e 6461 7465 2829 0a20  change).date(). 
-00014bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bd0: 2020 2065 6e64 5f64 203d 204e 6f6e 650a     end_d = None.
-00014be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bf0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014c00: 2020 2020 2020 2020 2020 656e 645f 6420            end_d 
-00014c10: 3d20 656e 640a 2020 2020 2020 2020 2020  = end.          
-00014c20: 2020 2020 2020 2020 2020 656e 645f 6474            end_dt
-00014c30: 203d 2064 6174 6574 696d 652e 636f 6d62   = datetime.comb
-00014c40: 696e 6528 656e 642c 2074 696d 6528 3029  ine(end, time(0)
-00014c50: 2c20 747a 5f65 7863 6861 6e67 6529 0a20  , tz_exchange). 
-00014c60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00014c70: 6620 656e 645f 6474 203e 2064 745f 6e6f  f end_dt > dt_no
-00014c80: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
-00014c90: 2020 2020 2020 2065 7863 6861 6e67 655f         exchange_
-00014ca0: 6d69 646e 6967 6874 5f64 7420 3d20 6461  midnight_dt = da
-00014cb0: 7465 7469 6d65 2e63 6f6d 6269 6e65 2864  tetime.combine(d
-00014cc0: 746e 6f77 5f65 7863 6861 6e67 652e 6461  tnow_exchange.da
-00014cd0: 7465 2829 2b74 645f 3164 2c20 7469 6d65  te()+td_1d, time
-00014ce0: 2830 292c 2074 7a5f 6578 6368 616e 6765  (0), tz_exchange
-00014cf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014d00: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00014d10: 6e63 6528 656e 642c 2064 6174 6574 696d  nce(end, datetim
-00014d20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00014d30: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
-00014d40: 685f 656e 6420 3d20 6578 6368 616e 6765  h_end = exchange
-00014d50: 5f6d 6964 6e69 6768 745f 6474 0a20 2020  _midnight_dt.   
-00014d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00014d80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014d90: 6574 6368 5f65 6e64 203d 2065 7863 6861  etch_end = excha
-00014da0: 6e67 655f 6d69 646e 6967 6874 5f64 742e  nge_midnight_dt.
-00014db0: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
-00014dc0: 2020 2069 6620 7374 6172 7420 6973 206e     if start is n
-00014dd0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00014de0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00014df0: 7374 616e 6365 2873 7461 7274 2c20 6461  stance(start, da
-00014e00: 7465 7469 6d65 293a 0a20 2020 2020 2020  tetime):.       
-00014e10: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00014e20: 7274 5f64 7420 3d20 7374 6172 740a 2020  rt_dt = start.  
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e40: 2020 2320 7374 6172 745f 6420 3d20 7374    # start_d = st
-00014e50: 6172 742e 6173 7469 6d65 7a6f 6e65 2874  art.astimezone(t
-00014e60: 7a5f 6578 6368 616e 6765 292e 6461 7465  z_exchange).date
-00014e70: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00014e80: 2020 2020 2020 2073 7461 7274 5f64 203d         start_d =
-00014e90: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00014ea0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ec0: 7374 6172 745f 6420 3d20 7374 6172 740a  start_d = start.
-00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ee0: 2020 2020 7374 6172 745f 6474 203d 2064      start_dt = d
-00014ef0: 6174 6574 696d 652e 636f 6d62 696e 6528  atetime.combine(
-00014f00: 7374 6172 742c 2074 696d 6528 3029 2c20  start, time(0), 
-00014f10: 747a 5f65 7863 6861 6e67 6529 0a0a 2020  tz_exchange)..  
-00014f20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014f30: 2028 6665 7463 685f 7374 6172 7420 6973   (fetch_start is
-00014f40: 206e 6f74 204e 6f6e 6529 2061 6e64 2028   not None) and (
-00014f50: 6665 7463 685f 656e 6420 3c3d 2066 6574  fetch_end <= fet
-00014f60: 6368 5f73 7461 7274 293a 0a20 2020 2020  ch_start):.     
-00014f70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00014f80: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00014f90: 2020 2020 2020 2020 6966 2066 6574 6368          if fetch
-00014fa0: 5f73 7461 7274 2069 7320 6e6f 7420 4e6f  _start is not No
-00014fb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00014fc0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00014fd0: 7461 6e63 6528 6665 7463 685f 7374 6172  tance(fetch_star
-00014fe0: 742c 2028 6461 7465 7469 6d65 2c20 7064  t, (datetime, pd
-00014ff0: 2e54 696d 6573 7461 6d70 2929 3a0a 2020  .Timestamp)):.  
-00015000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015010: 2020 6665 7463 685f 7374 6172 745f 6474    fetch_start_dt
-00015020: 203d 2064 6174 6574 696d 652e 636f 6d62   = datetime.comb
-00015030: 696e 6528 6665 7463 685f 7374 6172 742c  ine(fetch_start,
-00015040: 2074 696d 6528 3029 2c20 7365 6c66 2e74   time(0), self.t
-00015050: 7a29 0a20 2020 2020 2020 2020 2020 2020  z).             
-00015060: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00015070: 2020 2020 2020 2020 2020 2020 2066 6574               fet
-00015080: 6368 5f73 7461 7274 5f64 7420 3d20 6665  ch_start_dt = fe
-00015090: 7463 685f 7374 6172 740a 2020 2020 2020  tch_start.      
-000150a0: 2020 2020 2020 6966 2066 6574 6368 5f65        if fetch_e
-000150b0: 6e64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nd is not None:.
-000150c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150d0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-000150e0: 6528 6665 7463 685f 656e 642c 2028 6461  e(fetch_end, (da
-000150f0: 7465 7469 6d65 2c20 7064 2e54 696d 6573  tetime, pd.Times
-00015100: 7461 6d70 2929 3a0a 2020 2020 2020 2020  tamp)):.        
-00015110: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
-00015120: 685f 656e 645f 6474 203d 2064 6174 6574  h_end_dt = datet
-00015130: 696d 652e 636f 6d62 696e 6528 6665 7463  ime.combine(fetc
-00015140: 685f 656e 642c 2074 696d 6528 3029 2c20  h_end, time(0), 
-00015150: 747a 5f65 7863 6861 6e67 6529 0a20 2020  tz_exchange).   
-00015160: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00015170: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015180: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
-00015190: 5f64 7420 3d20 6665 7463 685f 656e 640a  _dt = fetch_end.
-000151a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000151b0: 6665 7463 685f 7374 6172 7420 6973 206e  fetch_start is n
-000151c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000151d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000151e0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000151f0: 642e 496e 7465 7276 616c 2e57 6565 6b3a  d.Interval.Week:
-00015200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015210: 2020 2020 2023 2045 6e73 7572 6520 616c       # Ensure al
-00015220: 6967 6e65 6420 746f 2077 6565 6b20 7374  igned to week st
-00015230: 6172 743a 0a20 2020 2020 2020 2020 2020  art:.           
-00015240: 2020 2020 2020 2020 2066 6574 6368 5f73           fetch_s
-00015250: 7461 7274 202d 3d20 7469 6d65 6465 6c74  tart -= timedelt
-00015260: 6128 6461 7973 3d66 6574 6368 5f73 7461  a(days=fetch_sta
-00015270: 7274 2e77 6565 6b64 6179 2829 290a 0a20  rt.weekday()).. 
-00015280: 2020 2020 2020 2020 2020 2074 645f 3164             td_1d
-00015290: 203d 2074 696d 6564 656c 7461 2864 6179   = timedelta(day
-000152a0: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
-000152b0: 2074 645f 3134 6420 3d20 7469 6d65 6465   td_14d = timede
-000152c0: 6c74 6128 6461 7973 3d31 3429 0a20 2020  lta(days=14).   
-000152d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000152e0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000152f0: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
-00015300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015310: 2020 2320 4164 6420 7061 6464 696e 6720    # Add padding 
-00015320: 6461 7973 2074 6f20 656e 7375 7265 2059  days to ensure Y
-00015330: 6168 6f6f 2072 6574 7572 6e73 2063 6f72  ahoo returns cor
-00015340: 7265 6374 2056 6f6c 756d 650a 2020 2020  rect Volume.    
-00015350: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-00015360: 7966 6374 2e47 6574 4578 6368 616e 6765  yfct.GetExchange
-00015370: 5363 6865 6475 6c65 2873 656c 662e 6578  Schedule(self.ex
-00015380: 6368 616e 6765 2c20 6665 7463 685f 7374  change, fetch_st
-00015390: 6172 7420 2d20 7464 5f31 3464 2c20 6665  art - td_14d, fe
-000153a0: 7463 685f 656e 6420 2b20 7464 5f31 3464  tch_end + td_14d
-000153b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000153c0: 2020 6665 7463 685f 7374 6172 745f 7061    fetch_start_pa
-000153d0: 6420 3d20 732e 696c 6f63 5b73 2e69 6e64  d = s.iloc[s.ind
-000153e0: 6578 2e67 6574 5f69 6e64 6578 6572 285b  ex.get_indexer([
-000153f0: 7374 7228 6665 7463 685f 7374 6172 7429  str(fetch_start)
-00015400: 5d2c 206d 6574 686f 643d 2266 6669 6c6c  ], method="ffill
-00015410: 2229 5b30 5d2d 315d 2e6e 616d 652e 6461  ")[0]-1].name.da
-00015420: 7465 2829 0a0a 2020 2020 2020 2020 2020  te()..          
-00015430: 2020 2020 2020 6669 7273 745f 6665 7463        first_fetc
-00015440: 685f 6661 696c 6564 203d 2046 616c 7365  h_failed = False
-00015450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015460: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00015470: 2020 2020 2020 2020 2020 6466 203d 2073            df = s
-00015480: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
-00015490: 6f72 795f 6461 7465 5261 6e67 6528 6665  ory_dateRange(fe
-000154a0: 7463 685f 7374 6172 745f 7061 642c 2066  tch_start_pad, f
-000154b0: 6574 6368 5f65 6e64 2c20 7072 6570 6f73  etch_end, prepos
-000154c0: 742c 2064 6562 7567 290a 2020 2020 2020  t, debug).      
-000154d0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000154e0: 203d 2064 662e 6c6f 635b 7374 7228 6665   = df.loc[str(fe
-000154f0: 7463 685f 7374 6172 7429 3a5d 2e63 6f70  tch_start):].cop
-00015500: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00015510: 2020 2020 6578 6365 7074 2079 6663 642e      except yfcd.
-00015520: 4e6f 5072 6963 6544 6174 6149 6e52 616e  NoPriceDataInRan
-00015530: 6765 4578 6365 7074 696f 6e20 6173 2065  geException as e
-00015540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015550: 2020 2020 2020 6669 7273 745f 6665 7463        first_fetc
-00015560: 685f 6661 696c 6564 203d 2054 7275 650a  h_failed = True.
-00015570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015580: 2020 2020 6578 203d 2065 0a0a 2020 2020      ex = e..    
-00015590: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000155a0: 6972 7374 5f66 6574 6368 5f66 6169 6c65  irst_fetch_faile
-000155b0: 6420 616e 6420 6665 7463 685f 656e 6420  d and fetch_end 
-000155c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00013480: 2864 6179 733d 3429 2020 2320 616c 6c6f  (days=4)  # allo
+00013490: 7720 666f 7220 7765 656b 656e 640a 2020  w for weekend.  
+000134a0: 2020 2020 2020 2020 2020 6472 6f70 5f64            drop_d
+000134b0: 7473 5f6e 6f74 5f72 6563 656e 7420 3d20  ts_not_recent = 
+000134c0: 6472 6f70 5f64 7473 5b66 5d0a 2020 2020  drop_dts[f].    
+000134d0: 2020 2020 2020 2020 6472 6f70 5f64 7473          drop_dts
+000134e0: 5f61 6765 7320 3d20 6472 6f70 5f64 7473  _ages = drop_dts
+000134f0: 5f61 6765 735b 665d 0a20 2020 2020 2020  _ages[f].       
+00013500: 2020 2020 206d 7367 203d 2066 227b 7365       msg = f"{se
+00013510: 6c66 2e74 6963 6b65 727d 3a20 7b73 656c  lf.ticker}: {sel
+00013520: 662e 6973 7472 7d2d 7072 6963 6573 2070  f.istr}-prices p
+00013530: 726f 626c 656d 7322 0a20 2020 2020 2020  roblems".       
+00013540: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
+00013550: 7469 6775 6f75 733a 0a20 2020 2020 2020  tiguous:.       
+00013560: 2020 2020 2020 2020 2023 2044 6169 6c79           # Daily
+00013570: 206d 7573 7420 616c 7761 7973 2062 6520   must always be 
+00013580: 636f 6e74 6967 756f 7573 2c20 736f 2064  contiguous, so d
+00013590: 726f 7020 6576 6572 7974 6869 6e67 2066  rop everything f
+000135a0: 726f 6d20 6669 7273 7420 6469 6666 0a20  rom first diff. 
+000135b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000135c0: 6620 6c65 6e28 6472 6f70 5f64 7473 5f6e  f len(drop_dts_n
+000135d0: 6f74 5f72 6563 656e 7429 203e 2030 3a0a  ot_recent) > 0:.
+000135e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135f0: 2020 2020 6966 206c 656e 2864 726f 705f      if len(drop_
+00013600: 6474 735f 6e6f 745f 7265 6365 6e74 2920  dts_not_recent) 
+00013610: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00013620: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00013630: 6720 2b3d 2066 223a 2064 726f 7070 696e  g += f": droppin
+00013640: 6720 7b64 726f 705f 6474 735f 6e6f 745f  g {drop_dts_not_
+00013650: 7265 6365 6e74 5b30 5d2e 6461 7465 2829  recent[0].date()
+00013660: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00013670: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013690: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+000136a0: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136c0: 2020 206d 7367 202b 3d20 6622 3a20 6472     msg += f": dr
+000136d0: 6f70 7069 6e67 2061 6c6c 2072 6f77 7320  opping all rows 
+000136e0: 6672 6f6d 207b 6472 6f70 5f64 7473 5f6e  from {drop_dts_n
+000136f0: 6f74 5f72 6563 656e 745b 305d 2e64 6174  ot_recent[0].dat
+00013700: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
+00013710: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00013720: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013740: 6d73 6720 2b3d 2066 223a 2064 726f 7070  msg += f": dropp
+00013750: 696e 6720 616c 6c20 726f 7773 2066 726f  ing all rows fro
+00013760: 6d20 7b64 726f 705f 6474 735f 6e6f 745f  m {drop_dts_not_
+00013770: 7265 6365 6e74 5b30 5d7d 220a 2020 2020  recent[0]}".    
+00013780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013790: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+000137a0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
+000137b0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
+000137c0: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
+000137d0: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
+000137e0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+000137f0: 2020 2020 2068 203d 2068 5b68 2e69 6e64       h = h[h.ind
+00013800: 6578 203c 2064 726f 705f 6474 735b 305d  ex < drop_dts[0]
+00013810: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00013820: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
+00013830: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00013840: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00013850: 2020 2020 2020 6e20 3d20 7365 6c66 2e68        n = self.h
+00013860: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+00013870: 2020 2020 2020 2020 2020 6e5f 6472 6f70            n_drop
+00013880: 203d 206e 702e 7375 6d28 665f 6469 6666   = np.sum(f_diff
+00013890: 5f61 6c6c 290a 2020 2020 2020 2020 2020  _all).          
+000138a0: 2020 2020 2020 6966 206c 656e 2864 726f        if len(dro
+000138b0: 705f 6474 735f 6e6f 745f 7265 6365 6e74  p_dts_not_recent
+000138c0: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+000138d0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+000138e0: 6e28 6472 6f70 5f64 7473 5f6e 6f74 5f72  n(drop_dts_not_r
+000138f0: 6563 656e 7429 203c 2031 303a 0a20 2020  ecent) < 10:.   
+00013900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013910: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00013920: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+00013930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013940: 2020 206d 7367 202b 3d20 6622 3a20 6472     msg += f": dr
+00013950: 6f70 7069 6e67 207b 6472 6f70 5f64 7473  opping {drop_dts
+00013960: 5f6e 6f74 5f72 6563 656e 742e 6461 7465  _not_recent.date
+00013970: 2e61 7374 7970 6528 7374 7229 7d22 0a20  .astype(str)}". 
+00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013990: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000139a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139b0: 2020 2020 2020 2020 206d 7367 202b 3d20           msg += 
+000139c0: 6622 3a20 6472 6f70 7069 6e67 207b 6472  f": dropping {dr
+000139d0: 6f70 5f64 7473 5f6e 6f74 5f72 6563 656e  op_dts_not_recen
+000139e0: 742e 747a 5f6c 6f63 616c 697a 6528 4e6f  t.tz_localize(No
+000139f0: 6e65 297d 220a 2020 2020 2020 2020 2020  ne)}".          
+00013a00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00013a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a20: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
+00013a30: 223a 2064 726f 7070 696e 6720 7b6e 5f64  ": dropping {n_d
+00013a40: 726f 707d 2f7b 6e7d 2072 6f77 7322 0a20  rop}/{n} rows". 
+00013a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a60: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
+00013a70: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
+00013a80: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+00013a90: 2829 2065 6c73 6520 7072 696e 7428 6622  () else print(f"
+00013aa0: 7b73 656c 662e 7469 636b 6572 7d3a 2022  {self.ticker}: "
+00013ab0: 202b 206d 7367 290a 2020 2020 2020 2020   + msg).        
+00013ac0: 2020 2020 2020 2020 6832 203d 2068 2e64          h2 = h.d
+00013ad0: 726f 7028 6472 6f70 5f64 7473 290a 2020  rop(drop_dts).  
+00013ae0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00013af0: 2068 2e73 6861 7065 5b30 5d2d 6832 2e73   h.shape[0]-h2.s
+00013b00: 6861 7065 5b30 5d20 213d 206e 5f64 726f  hape[0] != n_dro
+00013b10: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
+00013b20: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+00013b30: 6570 7469 6f6e 2822 6865 7265 2229 0a20  eption("here"). 
+00013b40: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00013b50: 203d 2068 320a 2020 2020 2020 2020 2020   = h2.          
+00013b60: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
+00013b70: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00013b80: 2020 2020 6966 2068 2e65 6d70 7479 3a0a      if h.empty:.
+00013b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ba0: 6820 3d20 4e6f 6e65 0a20 2020 2020 2020  h = None.       
+00013bb0: 2020 2020 2020 2020 2068 5f6d 6f64 6966           h_modif
+00013bc0: 6965 6420 3d20 5472 7565 0a0a 2020 2020  ied = True..    
+00013bd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013be0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+00013bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c00: 6e20 3d20 6e70 2e73 756d 2866 5f64 6966  n = np.sum(f_dif
+00013c10: 665f 616c 6c29 0a20 2020 2020 2020 2020  f_all).         
+00013c20: 2020 2020 2020 2069 6620 6e20 3c20 353a         if n < 5:
+00013c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013c40: 2020 2020 206d 7367 203d 2022 6469 6666       msg = "diff
+00013c50: 6572 656e 6365 7320 666f 756e 6420 6275  erences found bu
+00013c60: 7420 6e6f 7420 636f 7272 6563 7469 6e67  t not correcting
+00013c70: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00013c80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00013c90: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
+00013ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cb0: 2020 6d73 6720 2b3d 2066 227b 665f 6469    msg += f"{f_di
+00013cc0: 6666 5f61 6c6c 2e69 6e64 6578 5b66 5f64  ff_all.index[f_d
+00013cd0: 6966 665f 616c 6c5d 2e64 6174 657d 220a  iff_all].date}".
+00013ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cf0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d10: 2020 6d73 6720 2b3d 2066 227b 665f 6469    msg += f"{f_di
+00013d20: 6666 5f61 6c6c 2e69 6e64 6578 5b66 5f64  ff_all.index[f_d
+00013d30: 6966 665f 616c 6c5d 7d22 0a20 2020 2020  iff_all]}".     
+00013d40: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00013d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013d60: 2020 2020 206d 7367 203d 2066 227b 6e70       msg = f"{np
+00013d70: 2e73 756d 2866 5f64 6966 665f 616c 6c29  .sum(f_diff_all)
+00013d80: 7d20 6469 6666 6572 656e 6365 7320 666f  } differences fo
+00013d90: 756e 6420 6275 7420 6e6f 7420 636f 7272  und but not corr
+00013da0: 6563 7469 6e67 220a 2020 2020 2020 2020  ecting".        
+00013db0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00013dc0: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+00013dd0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00013de0: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00013df0: 6e74 2866 227b 7365 6c66 2e74 6963 6b65  nt(f"{self.ticke
+00013e00: 727d 3a20 2220 2b20 6d73 6729 0a0a 2020  r}: " + msg)..  
+00013e10: 2020 2020 2020 6966 2063 6f72 7265 6374        if correct
+00013e20: 2069 6e20 5b27 6f6e 6527 2c20 2761 6c6c   in ['one', 'all
+00013e30: 275d 2061 6e64 2066 5f64 6966 665f 616c  '] and f_diff_al
+00013e40: 6c2e 6e61 6d65 203d 3d20 2244 6976 2d41  l.name == "Div-A
+00013e50: 646a 7573 7422 2061 6e64 2073 656c 662e  djust" and self.
+00013e60: 696e 7465 7276 616c 2021 3d20 7966 6364  interval != yfcd
+00013e70: 2e49 6e74 6572 7661 6c2e 4461 7973 313a  .Interval.Days1:
+00013e80: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
+00013e90: 6c6c 2064 6966 6665 7265 6e63 6573 2063  ll differences c
+00013ea0: 6175 7365 6420 6279 2062 6164 2064 6976  aused by bad div
+00013eb0: 6964 656e 6420 6461 7461 2e0a 2020 2020  idend data..    
+00013ec0: 2020 2020 2020 2020 2320 546f 2066 6978          # To fix
+00013ed0: 2c20 6e65 6564 2074 6f20 666f 7263 6520  , need to force 
+00013ee0: 6120 7265 2d66 6574 6368 206f 6620 3164  a re-fetch of 1d
+00013ef0: 2064 6174 612e 0a20 2020 2020 2020 2020   data..         
+00013f00: 2020 2068 6973 7431 6420 3d20 7365 6c66     hist1d = self
+00013f10: 2e6d 616e 6167 6572 2e47 6574 4869 7374  .manager.GetHist
+00013f20: 6f72 7928 7966 6364 2e49 6e74 6572 7661  ory(yfcd.Interva
+00013f30: 6c2e 4461 7973 3129 0a20 2020 2020 2020  l.Days1).       
+00013f40: 2020 2020 2068 3164 203d 2068 6973 7431       h1d = hist1
+00013f50: 642e 5f67 6574 4361 6368 6564 5072 6963  d._getCachedPric
+00013f60: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+00013f70: 2065 6e64 5f64 203d 2066 5f64 6966 665f   end_d = f_diff_
+00013f80: 616c 6c2e 696e 6465 785b 2d31 5d2e 6461  all.index[-1].da
+00013f90: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
+00013fa0: 2023 2042 7574 206f 6e6c 7920 6966 206f   # But only if o
+00013fb0: 6620 3164 2064 6174 6120 6665 7463 6865  f 1d data fetche
+00013fc0: 6420 6174 206c 6561 7374 2032 3420 686f  d at least 24 ho
+00013fd0: 7572 7320 6167 6f2c 2062 6563 6175 7365  urs ago, because
+00013fe0: 206d 6179 6265 0a20 2020 2020 2020 2020   maybe.         
+00013ff0: 2020 2023 2077 6520 6a75 7374 2066 6978     # we just fix
+00014000: 6564 2074 6865 2031 6420 6461 7461 2e0a  ed the 1d data..
+00014010: 2020 2020 2020 2020 2020 2020 665f 6665              f_fe
+00014020: 7463 6865 645f 7265 6365 6e74 6c79 203d  tched_recently =
+00014030: 2068 3164 5b27 4665 7463 6844 6174 6527   h1d['FetchDate'
+00014040: 5d20 3e20 2864 745f 6e6f 7720 2d20 7469  ] > (dt_now - ti
+00014050: 6d65 6465 6c74 6128 6461 7973 3d31 2929  medelta(days=1))
+00014060: 0a20 2020 2020 2020 2020 2020 2066 5f66  .            f_f
+00014070: 6574 6368 6564 5f72 6563 656e 746c 795f  etched_recently_
+00014080: 6e6f 7420 3d20 7e66 5f66 6574 6368 6564  not = ~f_fetched
+00014090: 5f72 6563 656e 746c 790a 2020 2020 2020  _recently.      
+000140a0: 2020 2020 2020 6966 2066 5f66 6574 6368        if f_fetch
+000140b0: 6564 5f72 6563 656e 746c 795f 6e6f 742e  ed_recently_not.
+000140c0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+000140d0: 2020 2020 2020 2066 5f66 6574 6368 6564         f_fetched
+000140e0: 5f72 6563 656e 746c 795f 6e6f 745f 6c61  _recently_not_la
+000140f0: 7374 5f69 6478 203d 206e 702e 7768 6572  st_idx = np.wher
+00014100: 6528 665f 6665 7463 6865 645f 7265 6365  e(f_fetched_rece
+00014110: 6e74 6c79 5f6e 6f74 295b 305d 5b2d 315d  ntly_not)[0][-1]
+00014120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014130: 2065 6e64 5f64 203d 2068 3164 2e69 6e64   end_d = h1d.ind
+00014140: 6578 5b66 5f66 6574 6368 6564 5f72 6563  ex[f_fetched_rec
+00014150: 656e 746c 795f 6e6f 745f 6c61 7374 5f69  ently_not_last_i
+00014160: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
+00014170: 2020 2020 6d73 6720 3d20 6622 6869 7374      msg = f"hist
+00014180: 2d7b 7365 6c66 2e69 7374 727d 2069 7320  -{self.istr} is 
+00014190: 6469 7363 6172 6469 6e67 2031 6420 6461  discarding 1d da
+000141a0: 7461 2062 6566 6f72 6520 7b65 6e64 5f64  ta before {end_d
+000141b0: 7d20 746f 2066 6f72 6365 2072 652d 6665  } to force re-fe
+000141c0: 7463 6820 6f66 2064 6976 6964 656e 6473  tch of dividends
+000141d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000141e0: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+000141f0: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
+00014200: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+00014210: 2920 656c 7365 2070 7269 6e74 2866 227b  ) else print(f"{
+00014220: 7365 6c66 2e74 6963 6b65 727d 3a20 2220  self.ticker}: " 
+00014230: 2b20 6d73 6729 0a20 2020 2020 2020 2020  + msg).         
+00014240: 2020 2020 2020 2068 3164 203d 2068 3164         h1d = h1d
+00014250: 5b73 7472 2865 6e64 5f64 293a 5d0a 0a20  [str(end_d):].. 
+00014260: 2020 2020 2020 2020 2020 2068 6973 7431             hist1
+00014270: 642e 5f75 7064 6174 6564 4361 6368 6564  d._updatedCached
+00014280: 5072 6963 6573 2868 3164 290a 0a20 2020  Prices(h1d)..   
+00014290: 2020 2020 2069 6620 685f 6d6f 6469 6669       if h_modifi
+000142a0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+000142b0: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
+000142c0: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
+000142d0: 2c20 7365 6c66 2e63 6163 6865 5f6b 6579  , self.cache_key
+000142e0: 2c20 6829 0a20 2020 2020 2020 2020 2020  , h).           
+000142f0: 2073 656c 662e 6820 3d20 7365 6c66 2e5f   self.h = self._
+00014300: 6765 7443 6163 6865 6450 7269 6365 7328  getCachedPrices(
+00014310: 290a 0a20 2020 2020 2020 2079 6663 6c2e  )..        yfcl.
+00014320: 5472 6163 6545 7869 7428 6622 504d 3a3a  TraceExit(f"PM::
+00014330: 5f76 6572 6966 7943 6163 6865 6450 7269  _verifyCachedPri
+00014340: 6365 732d 7b73 656c 662e 6973 7472 7d28  ces-{self.istr}(
+00014350: 2920 7265 7475 726e 696e 6720 4661 6c73  ) returning Fals
+00014360: 6522 290a 2020 2020 2020 2020 7265 7475  e").        retu
+00014370: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
+00014380: 6620 5f66 6574 6368 5966 4869 7374 6f72  f _fetchYfHistor
+00014390: 7928 7365 6c66 2c20 7374 6172 742c 2065  y(self, start, e
+000143a0: 6e64 2c20 7072 6570 6f73 742c 2064 6562  nd, prepost, deb
+000143b0: 7567 2c20 7665 7269 6679 5f69 6e74 6572  ug, verify_inter
+000143c0: 7661 6c73 3d54 7275 652c 2064 6973 6162  vals=True, disab
+000143d0: 6c65 5f79 6663 5f6d 6574 6164 6174 613d  le_yfc_metadata=
+000143e0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+000143f0: 6966 2073 7461 7274 2069 7320 4e6f 6e65  if start is None
+00014400: 2061 6e64 2065 6e64 2069 7320 4e6f 6e65   and end is None
+00014410: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00014420: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00014430: 4d75 7374 2070 726f 7669 6465 2076 616c  Must provide val
+00014440: 7565 2066 6f72 206f 6e65 206f 663a 2027  ue for one of: '
+00014450: 7374 6172 7427 2c20 2765 6e64 2722 290a  start', 'end'").
+00014460: 2020 2020 2020 2020 6966 2073 7461 7274          if start
+00014470: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00014480: 2020 2020 2020 2020 2020 7966 6375 2e54            yfcu.T
+00014490: 7970 6543 6865 636b 496e 7465 7276 616c  ypeCheckInterval
+000144a0: 4474 2873 7461 7274 2c20 7365 6c66 2e69  Dt(start, self.i
+000144b0: 6e74 6572 7661 6c2c 2022 7374 6172 7422  nterval, "start"
+000144c0: 290a 2020 2020 2020 2020 6966 2065 6e64  ).        if end
+000144d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000144e0: 2020 2020 2020 2020 2020 7966 6375 2e54            yfcu.T
+000144f0: 7970 6543 6865 636b 496e 7465 7276 616c  ypeCheckInterval
+00014500: 4474 2865 6e64 2c20 7365 6c66 2e69 6e74  Dt(end, self.int
+00014510: 6572 7661 6c2c 2022 656e 6422 290a 2020  erval, "end").  
+00014520: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
+00014530: 6865 636b 426f 6f6c 2870 7265 706f 7374  heckBool(prepost
+00014540: 2c20 2270 7265 706f 7374 2229 0a20 2020  , "prepost").   
+00014550: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00014560: 6563 6b42 6f6f 6c28 6465 6275 672c 2022  eckBool(debug, "
+00014570: 6465 6275 6722 290a 0a20 2020 2020 2020  debug")..       
+00014580: 2064 6562 7567 5f79 6663 203d 2046 616c   debug_yfc = Fal
+00014590: 7365 0a20 2020 2020 2020 2023 2064 6562  se.        # deb
+000145a0: 7567 5f79 6663 203d 2054 7275 650a 0a20  ug_yfc = True.. 
+000145b0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
+000145c0: 2066 2250 4d3a 3a5f 6665 7463 6859 6648   f"PM::_fetchYfH
+000145d0: 6973 746f 7279 2d7b 7365 6c66 2e69 7374  istory-{self.ist
+000145e0: 727d 287b 7374 6172 747d 2d3e 7b65 6e64  r}({start}->{end
+000145f0: 7d2c 2070 7265 706f 7374 3d7b 7072 6570  }, prepost={prep
+00014600: 6f73 747d 2922 0a20 2020 2020 2020 2069  ost})".        i
+00014610: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+00014620: 456e 6162 6c65 6428 293a 0a20 2020 2020  Enabled():.     
+00014630: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00014640: 6545 6e74 6572 286c 6f67 5f6d 7367 290a  eEnter(log_msg).
+00014650: 2020 2020 2020 2020 656c 6966 2064 6562          elif deb
+00014660: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00014670: 2020 2020 7072 696e 7428 2222 290a 2020      print("").  
+00014680: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00014690: 6c6f 675f 6d73 6729 0a0a 2020 2020 2020  log_msg)..      
+000146a0: 2020 747a 5f65 7863 6861 6e67 6520 3d20    tz_exchange = 
+000146b0: 7365 6c66 2e74 7a0a 2020 2020 2020 2020  self.tz.        
+000146c0: 7464 5f31 6420 3d20 7469 6d65 6465 6c74  td_1d = timedelt
+000146d0: 6128 6461 7973 3d31 290a 2020 2020 2020  a(days=1).      
+000146e0: 2020 6474 5f6e 6f77 203d 2070 642e 5469    dt_now = pd.Ti
+000146f0: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
+00014700: 2e74 7a5f 636f 6e76 6572 7428 5a6f 6e65  .tz_convert(Zone
+00014710: 496e 666f 2822 5554 4322 2929 0a0a 2020  Info("UTC"))..  
+00014720: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+00014730: 7472 6164 6179 3a0a 2020 2020 2020 2020  traday:.        
+00014740: 2020 2020 6d61 784c 6f6f 6b62 6163 6b20      maxLookback 
+00014750: 3d20 7966 6364 2e79 664d 6178 4665 7463  = yfcd.yfMaxFetc
+00014760: 684c 6f6f 6b62 6163 6b5b 7365 6c66 2e69  hLookback[self.i
+00014770: 6e74 6572 7661 6c5d 202d 2074 696d 6564  nterval] - timed
+00014780: 656c 7461 2873 6563 6f6e 6473 3d31 3029  elta(seconds=10)
+00014790: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000147a0: 6d61 784c 6f6f 6b62 6163 6b20 6973 206e  maxLookback is n
+000147b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000147c0: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+000147d0: 206d 6178 2873 7461 7274 2c20 6474 5f6e   max(start, dt_n
+000147e0: 6f77 202d 206d 6178 4c6f 6f6b 6261 636b  ow - maxLookback
+000147f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014800: 2020 6966 2073 7461 7274 203e 3d20 656e    if start >= en
+00014810: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00014820: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+00014830: 6e65 0a0a 2020 2020 2020 2020 6665 7463  ne..        fetc
+00014840: 685f 7374 6172 7420 3d20 7374 6172 740a  h_start = start.
+00014850: 2020 2020 2020 2020 6665 7463 685f 656e          fetch_en
+00014860: 6420 3d20 656e 640a 0a20 2020 2020 2020  d = end..       
+00014870: 2069 6620 656e 6420 6973 206e 6f74 204e   if end is not N
+00014880: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00014890: 2023 2049 6620 2766 6574 6368 5f65 6e64   # If 'fetch_end
+000148a0: 2720 696e 2066 7574 7572 6520 7468 656e  ' in future then
+000148b0: 2063 6170 2074 6f20 6578 6368 616e 6765   cap to exchange
+000148c0: 206d 6964 6e69 6768 740a 2020 2020 2020   midnight.      
+000148d0: 2020 2020 2020 6474 6e6f 775f 6578 6368        dtnow_exch
+000148e0: 616e 6765 203d 2064 745f 6e6f 772e 747a  ange = dt_now.tz
+000148f0: 5f63 6f6e 7665 7274 2874 7a5f 6578 6368  _convert(tz_exch
+00014900: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+00014910: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00014920: 656e 642c 2064 6174 6574 696d 6529 3a0a  end, datetime):.
+00014930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014940: 656e 645f 6474 203d 2065 6e64 0a20 2020  end_dt = end.   
+00014950: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+00014960: 6e64 5f64 203d 2065 6e64 2e61 7374 696d  nd_d = end.astim
+00014970: 657a 6f6e 6528 747a 5f65 7863 6861 6e67  ezone(tz_exchang
+00014980: 6529 2e64 6174 6528 290a 2020 2020 2020  e).date().      
+00014990: 2020 2020 2020 2020 2020 656e 645f 6420            end_d 
+000149a0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+000149b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000149c0: 2020 2020 2020 2020 2065 6e64 5f64 203d           end_d =
+000149d0: 2065 6e64 0a20 2020 2020 2020 2020 2020   end.           
+000149e0: 2020 2020 2065 6e64 5f64 7420 3d20 6461       end_dt = da
+000149f0: 7465 7469 6d65 2e63 6f6d 6269 6e65 2865  tetime.combine(e
+00014a00: 6e64 2c20 7469 6d65 2830 292c 2074 7a5f  nd, time(0), tz_
+00014a10: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
+00014a20: 2020 2020 2020 6966 2065 6e64 5f64 7420        if end_dt 
+00014a30: 3e20 6474 5f6e 6f77 3a0a 2020 2020 2020  > dt_now:.      
+00014a40: 2020 2020 2020 2020 2020 6578 6368 616e            exchan
+00014a50: 6765 5f6d 6964 6e69 6768 745f 6474 203d  ge_midnight_dt =
+00014a60: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00014a70: 6528 6474 6e6f 775f 6578 6368 616e 6765  e(dtnow_exchange
+00014a80: 2e64 6174 6528 292b 7464 5f31 642c 2074  .date()+td_1d, t
+00014a90: 696d 6528 3029 2c20 747a 5f65 7863 6861  ime(0), tz_excha
+00014aa0: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
+00014ab0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00014ac0: 6365 2865 6e64 2c20 6461 7465 7469 6d65  ce(end, datetime
+00014ad0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00014ae0: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
+00014af0: 203d 2065 7863 6861 6e67 655f 6d69 646e   = exchange_midn
+00014b00: 6967 6874 5f64 740a 2020 2020 2020 2020  ight_dt.        
+00014b10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00014b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b30: 2020 6665 7463 685f 656e 6420 3d20 6578    fetch_end = ex
+00014b40: 6368 616e 6765 5f6d 6964 6e69 6768 745f  change_midnight_
+00014b50: 6474 2e64 6174 6528 290a 2020 2020 2020  dt.date().      
+00014b60: 2020 6966 2073 7461 7274 2069 7320 6e6f    if start is no
+00014b70: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014b80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00014b90: 6528 7374 6172 742c 2064 6174 6574 696d  e(start, datetim
+00014ba0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00014bb0: 2020 2020 7374 6172 745f 6474 203d 2073      start_dt = s
+00014bc0: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
+00014bd0: 2020 2020 2023 2073 7461 7274 5f64 203d       # start_d =
+00014be0: 2073 7461 7274 2e61 7374 696d 657a 6f6e   start.astimezon
+00014bf0: 6528 747a 5f65 7863 6861 6e67 6529 2e64  e(tz_exchange).d
+00014c00: 6174 6528 290a 2020 2020 2020 2020 2020  ate().          
+00014c10: 2020 2020 2020 7374 6172 745f 6420 3d20        start_d = 
+00014c20: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00014c30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014c40: 2020 2020 2020 2073 7461 7274 5f64 203d         start_d =
+00014c50: 2073 7461 7274 0a20 2020 2020 2020 2020   start.         
+00014c60: 2020 2020 2020 2073 7461 7274 5f64 7420         start_dt 
+00014c70: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+00014c80: 6e65 2873 7461 7274 2c20 7469 6d65 2830  ne(start, time(0
+00014c90: 292c 2074 7a5f 6578 6368 616e 6765 290a  ), tz_exchange).
+00014ca0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014cb0: 2866 6574 6368 5f73 7461 7274 2069 7320  (fetch_start is 
+00014cc0: 6e6f 7420 4e6f 6e65 2920 616e 6420 2866  not None) and (f
+00014cd0: 6574 6368 5f65 6e64 203c 3d20 6665 7463  etch_end <= fetc
+00014ce0: 685f 7374 6172 7429 3a0a 2020 2020 2020  h_start):.      
+00014cf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00014d00: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+00014d10: 6620 6665 7463 685f 7374 6172 7420 6973  f fetch_start is
+00014d20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00014d30: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00014d40: 696e 7374 616e 6365 2866 6574 6368 5f73  instance(fetch_s
+00014d50: 7461 7274 2c20 2864 6174 6574 696d 652c  tart, (datetime,
+00014d60: 2070 642e 5469 6d65 7374 616d 7029 293a   pd.Timestamp)):
+00014d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014d80: 2066 6574 6368 5f73 7461 7274 5f64 7420   fetch_start_dt 
+00014d90: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+00014da0: 6e65 2866 6574 6368 5f73 7461 7274 2c20  ne(fetch_start, 
+00014db0: 7469 6d65 2830 292c 2073 656c 662e 747a  time(0), self.tz
+00014dc0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00014dd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014de0: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+00014df0: 6474 203d 2066 6574 6368 5f73 7461 7274  dt = fetch_start
+00014e00: 0a20 2020 2020 2020 2069 6620 6665 7463  .        if fetc
+00014e10: 685f 656e 6420 6973 206e 6f74 204e 6f6e  h_end is not Non
+00014e20: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00014e30: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00014e40: 2866 6574 6368 5f65 6e64 2c20 2864 6174  (fetch_end, (dat
+00014e50: 6574 696d 652c 2070 642e 5469 6d65 7374  etime, pd.Timest
+00014e60: 616d 7029 293a 0a20 2020 2020 2020 2020  amp)):.         
+00014e70: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
+00014e80: 5f64 7420 3d20 6461 7465 7469 6d65 2e63  _dt = datetime.c
+00014e90: 6f6d 6269 6e65 2866 6574 6368 5f65 6e64  ombine(fetch_end
+00014ea0: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
+00014eb0: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+00014ec0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014ed0: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
+00014ee0: 656e 645f 6474 203d 2066 6574 6368 5f65  end_dt = fetch_e
+00014ef0: 6e64 0a0a 2020 2020 2020 2020 6966 2066  nd..        if f
+00014f00: 6574 6368 5f73 7461 7274 2069 7320 6e6f  etch_start is no
+00014f10: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014f20: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00014f30: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+00014f40: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
+00014f50: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00014f60: 7375 7265 2061 6c69 676e 6564 2074 6f20  sure aligned to 
+00014f70: 7765 656b 2073 7461 7274 3a0a 2020 2020  week start:.    
+00014f80: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00014f90: 685f 7374 6172 7420 2d3d 2074 696d 6564  h_start -= timed
+00014fa0: 656c 7461 2864 6179 733d 6665 7463 685f  elta(days=fetch_
+00014fb0: 7374 6172 742e 7765 656b 6461 7928 2929  start.weekday())
+00014fc0: 0a0a 2020 2020 2020 2020 7464 5f31 6420  ..        td_1d 
+00014fd0: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
+00014fe0: 3d31 290a 2020 2020 2020 2020 7464 5f31  =1).        td_1
+00014ff0: 3464 203d 2074 696d 6564 656c 7461 2864  4d = timedelta(d
+00015000: 6179 733d 3134 290a 2020 2020 2020 2020  ays=14).        
+00015010: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+00015020: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+00015030: 6c2e 4461 7973 313a 0a20 2020 2020 2020  l.Days1:.       
+00015040: 2020 2020 2023 2041 6464 2070 6164 6469       # Add paddi
+00015050: 6e67 2064 6179 7320 746f 2065 6e73 7572  ng days to ensur
+00015060: 6520 5961 686f 6f20 7265 7475 726e 7320  e Yahoo returns 
+00015070: 636f 7272 6563 7420 566f 6c75 6d65 0a20  correct Volume. 
+00015080: 2020 2020 2020 2020 2020 2073 203d 2079             s = y
+00015090: 6663 742e 4765 7445 7863 6861 6e67 6553  fct.GetExchangeS
+000150a0: 6368 6564 756c 6528 7365 6c66 2e65 7863  chedule(self.exc
+000150b0: 6861 6e67 652c 2066 6574 6368 5f73 7461  hange, fetch_sta
+000150c0: 7274 202d 2074 645f 3134 642c 2066 6574  rt - td_14d, fet
+000150d0: 6368 5f65 6e64 202b 2074 645f 3134 6429  ch_end + td_14d)
+000150e0: 0a20 2020 2020 2020 2020 2020 2066 6574  .            fet
+000150f0: 6368 5f73 7461 7274 5f70 6164 203d 2073  ch_start_pad = s
+00015100: 2e69 6c6f 635b 732e 696e 6465 782e 6765  .iloc[s.index.ge
+00015110: 745f 696e 6465 7865 7228 5b73 7472 2866  t_indexer([str(f
+00015120: 6574 6368 5f73 7461 7274 295d 2c20 6d65  etch_start)], me
+00015130: 7468 6f64 3d22 6666 696c 6c22 295b 305d  thod="ffill")[0]
+00015140: 2d31 5d2e 6e61 6d65 2e64 6174 6528 290a  -1].name.date().
+00015150: 0a20 2020 2020 2020 2020 2020 2066 6972  .            fir
+00015160: 7374 5f66 6574 6368 5f66 6169 6c65 6420  st_fetch_failed 
+00015170: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00015180: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015190: 2020 2020 2020 2020 2064 6620 3d20 7365           df = se
+000151a0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
+000151b0: 7279 5f64 6174 6552 616e 6765 2866 6574  ry_dateRange(fet
+000151c0: 6368 5f73 7461 7274 5f70 6164 2c20 6665  ch_start_pad, fe
+000151d0: 7463 685f 656e 642c 2070 7265 706f 7374  tch_end, prepost
+000151e0: 2c20 6465 6275 6729 0a20 2020 2020 2020  , debug).       
+000151f0: 2020 2020 2020 2020 2064 6620 3d20 6466           df = df
+00015200: 2e6c 6f63 5b73 7472 2866 6574 6368 5f73  .loc[str(fetch_s
+00015210: 7461 7274 293a 5d2e 636f 7079 2829 0a20  tart):].copy(). 
+00015220: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00015230: 7420 7966 6364 2e4e 6f50 7269 6365 4461  t yfcd.NoPriceDa
+00015240: 7461 496e 5261 6e67 6545 7863 6570 7469  taInRangeExcepti
+00015250: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00015260: 2020 2020 2020 2020 2066 6972 7374 5f66           first_f
+00015270: 6574 6368 5f66 6169 6c65 6420 3d20 5472  etch_failed = Tr
+00015280: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00015290: 2020 2065 7820 3d20 650a 0a20 2020 2020     ex = e..     
+000152a0: 2020 2020 2020 2069 6620 6669 7273 745f         if first_
+000152b0: 6665 7463 685f 6661 696c 6564 2061 6e64  fetch_failed and
+000152c0: 2066 6574 6368 5f65 6e64 2069 7320 6e6f   fetch_end is no
+000152d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000152e0: 2020 2020 2020 2020 2320 5472 7920 7769          # Try wi
+000152f0: 7468 2077 6964 6572 2064 6174 6520 7261  th wider date ra
+00015300: 6e67 652c 206d 6179 6265 2065 6e74 6972  nge, maybe entir
+00015310: 6520 7261 6e67 6520 6973 206a 7573 7420  e range is just 
+00015320: 6265 666f 7265 206c 6973 7469 6e67 2064  before listing d
+00015330: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+00015340: 2020 2020 7365 636f 6e64 5f66 6574 6368      second_fetch
+00015350: 5f66 6169 6c65 6420 3d20 4661 6c73 650a  _failed = False.
+00015360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015370: 6466 5f77 6964 6572 203d 204e 6f6e 650a  df_wider = None.
+00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015390: 6c69 7374 696e 675f 6461 7465 5f63 6865  listing_date_che
+000153a0: 636b 5f74 6f6c 203d 2079 6663 642e 6c69  ck_tol = yfcd.li
+000153b0: 7374 696e 675f 6461 7465 5f63 6865 636b  sting_date_check
+000153c0: 5f74 6f6c 735b 7365 6c66 2e69 6e74 6572  _tols[self.inter
+000153d0: 7661 6c5d 0a20 2020 2020 2020 2020 2020  val].           
+000153e0: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
+000153f0: 202d 3d20 322a 6c69 7374 696e 675f 6461   -= 2*listing_da
+00015400: 7465 5f63 6865 636b 5f74 6f6c 0a20 2020  te_check_tol.   
+00015410: 2020 2020 2020 2020 2020 2020 2066 6574               fet
+00015420: 6368 5f65 6e64 202b 3d20 322a 6c69 7374  ch_end += 2*list
+00015430: 696e 675f 6461 7465 5f63 6865 636b 5f74  ing_date_check_t
+00015440: 6f6c 0a20 2020 2020 2020 2020 2020 2020  ol.             
+00015450: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+00015460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015470: 2020 2020 206d 7367 203d 2022 2d20 6669       msg = "- fi
+00015480: 7273 7420 6665 7463 6820 6661 696c 6564  rst fetch failed
+00015490: 2c20 7472 7969 6e67 2061 6761 696e 2077  , trying again w
+000154a0: 6974 6820 7769 6465 7220 7261 6e67 653a  ith wider range:
+000154b0: 207b 7d20 2d3e 207b 7d22 2e66 6f72 6d61   {} -> {}".forma
+000154c0: 7428 6665 7463 685f 7374 6172 742c 2066  t(fetch_start, f
+000154d0: 6574 6368 5f65 6e64 290a 2020 2020 2020  etch_end).      
+000154e0: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+000154f0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
+00015500: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
+00015510: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
+00015520: 7365 2070 7269 6e74 286d 7367 290a 2020  se print(msg).  
+00015530: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00015540: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00015550: 2020 2020 2020 2064 665f 7769 6465 7220         df_wider 
+00015560: 3d20 7365 6c66 2e5f 6665 7463 6859 6648  = self._fetchYfH
+00015570: 6973 746f 7279 5f64 6174 6552 616e 6765  istory_dateRange
+00015580: 2866 6574 6368 5f73 7461 7274 2c20 6665  (fetch_start, fe
+00015590: 7463 685f 656e 642c 2070 7265 706f 7374  tch_end, prepost
+000155a0: 2c20 6465 6275 6729 0a20 2020 2020 2020  , debug).       
+000155b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000155c0: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
 000155d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155e0: 2023 2054 7279 2077 6974 6820 7769 6465   # Try with wide
-000155f0: 7220 6461 7465 2072 616e 6765 2c20 6d61  r date range, ma
-00015600: 7962 6520 656e 7469 7265 2072 616e 6765  ybe entire range
-00015610: 2069 7320 6a75 7374 2062 6566 6f72 6520   is just before 
-00015620: 6c69 7374 696e 6720 6461 7465 0a20 2020  listing date.   
-00015630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015640: 2073 6563 6f6e 645f 6665 7463 685f 6661   second_fetch_fa
-00015650: 696c 6564 203d 2046 616c 7365 0a20 2020  iled = False.   
+000155e0: 2020 206d 7367 203d 2022 2d20 7365 636f     msg = "- seco
+000155f0: 6e64 2066 6574 6368 2072 6574 7572 6e65  nd fetch returne
+00015600: 643a 220a 2020 2020 2020 2020 2020 2020  d:".            
+00015610: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+00015620: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
+00015630: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+00015640: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
+00015650: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
 00015660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015670: 2064 665f 7769 6465 7220 3d20 4e6f 6e65   df_wider = None
-00015680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015690: 2020 2020 206c 6973 7469 6e67 5f64 6174       listing_dat
-000156a0: 655f 6368 6563 6b5f 746f 6c20 3d20 7966  e_check_tol = yf
-000156b0: 6364 2e6c 6973 7469 6e67 5f64 6174 655f  cd.listing_date_
-000156c0: 6368 6563 6b5f 746f 6c73 5b73 656c 662e  check_tols[self.
-000156d0: 696e 7465 7276 616c 5d0a 2020 2020 2020  interval].      
-000156e0: 2020 2020 2020 2020 2020 2020 2020 6665                fe
-000156f0: 7463 685f 7374 6172 7420 2d3d 2032 2a6c  tch_start -= 2*l
-00015700: 6973 7469 6e67 5f64 6174 655f 6368 6563  isting_date_chec
-00015710: 6b5f 746f 6c0a 2020 2020 2020 2020 2020  k_tol.          
-00015720: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
-00015730: 656e 6420 2b3d 2032 2a6c 6973 7469 6e67  end += 2*listing
-00015740: 5f64 6174 655f 6368 6563 6b5f 746f 6c0a  _date_check_tol.
-00015750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015760: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-00015770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015780: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-00015790: 222d 2066 6972 7374 2066 6574 6368 2066  "- first fetch f
-000157a0: 6169 6c65 642c 2074 7279 696e 6720 6167  ailed, trying ag
-000157b0: 6169 6e20 7769 7468 2077 6964 6572 2072  ain with wider r
-000157c0: 616e 6765 3a20 7b7d 202d 3e20 7b7d 222e  ange: {} -> {}".
-000157d0: 666f 726d 6174 2866 6574 6368 5f73 7461  format(fetch_sta
-000157e0: 7274 2c20 6665 7463 685f 656e 6429 0a20  rt, fetch_end). 
-000157f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015800: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00015810: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00015820: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00015830: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-00015840: 7428 6d73 6729 0a20 2020 2020 2020 2020  t(msg).         
-00015850: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00015860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015870: 2020 2020 2020 2020 6466 5f77 6964 6572          df_wider
-00015880: 203d 2073 656c 662e 5f66 6574 6368 5966   = self._fetchYf
-00015890: 4869 7374 6f72 795f 6461 7465 5261 6e67  History_dateRang
-000158a0: 6528 6665 7463 685f 7374 6172 742c 2066  e(fetch_start, f
-000158b0: 6574 6368 5f65 6e64 2c20 7072 6570 6f73  etch_end, prepos
-000158c0: 742c 2064 6562 7567 290a 2020 2020 2020  t, debug).      
-000158d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158e0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
-000158f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015900: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00015910: 3d20 222d 2073 6563 6f6e 6420 6665 7463  = "- second fetc
-00015920: 6820 7265 7475 726e 6564 3a22 0a20 2020  h returned:".   
+00015670: 2020 2020 7072 696e 7428 6466 5f77 6964      print(df_wid
+00015680: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00015690: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000156a0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+000156b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000156c0: 6620 2244 6174 6120 646f 6573 6e27 7420  f "Data doesn't 
+000156d0: 6578 6973 7420 666f 7220 7374 6172 7444  exist for startD
+000156e0: 6174 6522 2069 6e20 7374 7228 6529 3a0a  ate" in str(e):.
+000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015700: 2020 2020 2020 2020 7365 636f 6e64 5f66          second_f
+00015710: 6574 6368 5f66 6169 6c65 6420 3d20 5472  etch_failed = Tr
+00015720: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00015730: 2020 2020 2020 2065 6c69 6620 224e 6f20         elif "No 
+00015740: 6461 7461 2066 6f75 6e64 2066 6f72 2074  data found for t
+00015750: 6869 7320 6461 7465 2072 616e 6765 2220  his date range" 
+00015760: 696e 2073 7472 2865 293a 0a20 2020 2020  in str(e):.     
+00015770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015780: 2020 2073 6563 6f6e 645f 6665 7463 685f     second_fetch_
+00015790: 6661 696c 6564 203d 2054 7275 650a 2020  failed = True.  
+000157a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000157c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157d0: 7261 6973 6520 650a 0a20 2020 2020 2020  raise e..       
+000157e0: 2020 2020 2020 2020 2069 6620 6466 5f77           if df_w
+000157f0: 6964 6572 2069 7320 6e6f 7420 4e6f 6e65  ider is not None
+00015800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015810: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+00015820: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00015830: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00015840: 7428 222d 2064 6574 6563 7465 6420 6c69  t("- detected li
+00015850: 7374 696e 6720 6461 7465 203d 222c 2064  sting date =", d
+00015860: 665f 7769 6465 722e 696e 6465 785b 305d  f_wider.index[0]
+00015870: 2e64 6174 6528 2929 0a20 2020 2020 2020  .date()).       
+00015880: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00015890: 6d2e 5374 6f72 6543 6163 6865 4461 7475  m.StoreCacheDatu
+000158a0: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
+000158b0: 6c69 7374 696e 675f 6461 7465 222c 2064  listing_date", d
+000158c0: 665f 7769 6465 722e 696e 6465 785b 305d  f_wider.index[0]
+000158d0: 2e64 6174 6528 2929 0a20 2020 2020 2020  .date()).       
+000158e0: 2020 2020 2020 2020 2020 2020 2064 6620               df 
+000158f0: 3d20 6466 5f77 6964 6572 0a20 2020 2020  = df_wider.     
+00015900: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00015910: 6620 6665 7463 685f 7374 6172 7420 6973  f fetch_start is
+00015920: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
 00015930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015940: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-00015950: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-00015960: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-00015970: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-00015980: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
+00015940: 2020 2064 6620 3d20 6466 2e6c 6f63 5b66     df = df.loc[f
+00015950: 6574 6368 5f73 7461 7274 5f64 743a 5d0a  etch_start_dt:].
+00015960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015970: 2020 2020 6966 2066 6574 6368 5f65 6e64      if fetch_end
+00015980: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
 00015990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159a0: 2020 2020 2070 7269 6e74 2864 665f 7769       print(df_wi
-000159b0: 6465 7229 0a20 2020 2020 2020 2020 2020  der).           
-000159c0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-000159d0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159f0: 2020 2020 2020 2020 6966 2022 4461 7461          if "Data
-00015a00: 2064 6f65 736e 2774 2065 7869 7374 2066   doesn't exist f
-00015a10: 6f72 2073 7461 7274 4461 7465 2220 696e  or startDate" in
-00015a20: 2073 7472 2865 293a 0a20 2020 2020 2020   str(e):.       
-00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a40: 2020 2020 2073 6563 6f6e 645f 6665 7463       second_fetc
-00015a50: 685f 6661 696c 6564 203d 2054 7275 650a  h_failed = True.
+000159a0: 2020 2020 2020 6466 203d 2064 662e 6c6f        df = df.lo
+000159b0: 635b 3a66 6574 6368 5f65 6e64 5f64 742d  c[:fetch_end_dt-
+000159c0: 7469 6d65 6465 6c74 6128 6d69 6c6c 6973  timedelta(millis
+000159d0: 6563 6f6e 6473 3d31 295d 0a0a 2020 2020  econds=1)]..    
+000159e0: 2020 2020 2020 2020 6966 2066 6972 7374          if first
+000159f0: 5f66 6574 6368 5f66 6169 6c65 643a 0a20  _fetch_failed:. 
+00015a00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00015a10: 6620 7365 636f 6e64 5f66 6574 6368 5f66  f second_fetch_f
+00015a20: 6169 6c65 643a 0a20 2020 2020 2020 2020  ailed:.         
+00015a30: 2020 2020 2020 2020 2020 2023 2048 6f70             # Hop
+00015a40: 6566 756c 6c79 2063 6f64 6520 6e65 7665  efully code neve
+00015a50: 7220 636f 6d65 7320 6865 7265 0a20 2020  r comes here.   
 00015a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a70: 2020 2020 2020 2020 656c 6966 2022 4e6f          elif "No
-00015a80: 2064 6174 6120 666f 756e 6420 666f 7220   data found for 
-00015a90: 7468 6973 2064 6174 6520 7261 6e67 6522  this date range"
-00015aa0: 2069 6e20 7374 7228 6529 3a0a 2020 2020   in str(e):.    
-00015ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ac0: 2020 2020 2020 2020 7365 636f 6e64 5f66          second_f
-00015ad0: 6574 6368 5f66 6169 6c65 6420 3d20 5472  etch_failed = Tr
-00015ae0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00015af0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00015b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b10: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00015b20: 7365 2065 0a0a 2020 2020 2020 2020 2020  se e..          
-00015b30: 2020 2020 2020 2020 2020 6966 2064 665f            if df_
-00015b40: 7769 6465 7220 6973 206e 6f74 204e 6f6e  wider is not Non
-00015b50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00015b60: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00015b70: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-00015b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b90: 2020 2020 2070 7269 6e74 2822 2d20 6465       print("- de
-00015ba0: 7465 6374 6564 206c 6973 7469 6e67 2064  tected listing d
-00015bb0: 6174 6520 3d22 2c20 6466 5f77 6964 6572  ate =", df_wider
-00015bc0: 2e69 6e64 6578 5b30 5d2e 6461 7465 2829  .index[0].date()
-00015bd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015be0: 2020 2020 2020 2020 2020 7966 636d 2e53            yfcm.S
-00015bf0: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
-00015c00: 656c 662e 7469 636b 6572 2c20 226c 6973  elf.ticker, "lis
-00015c10: 7469 6e67 5f64 6174 6522 2c20 6466 5f77  ting_date", df_w
-00015c20: 6964 6572 2e69 6e64 6578 5b30 5d2e 6461  ider.index[0].da
-00015c30: 7465 2829 290a 2020 2020 2020 2020 2020  te()).          
-00015c40: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00015c50: 203d 2064 665f 7769 6465 720a 2020 2020   = df_wider.    
-00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c70: 2020 2020 6966 2066 6574 6368 5f73 7461      if fetch_sta
-00015c80: 7274 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rt is not None:.
-00015c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ca0: 2020 2020 2020 2020 2020 2020 6466 203d              df =
-00015cb0: 2064 662e 6c6f 635b 6665 7463 685f 7374   df.loc[fetch_st
-00015cc0: 6172 745f 6474 3a5d 0a20 2020 2020 2020  art_dt:].       
-00015cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ce0: 2069 6620 6665 7463 685f 656e 6420 6973   if fetch_end is
-00015cf0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d10: 2020 2020 2020 2064 6620 3d20 6466 2e6c         df = df.l
-00015d20: 6f63 5b3a 6665 7463 685f 656e 645f 6474  oc[:fetch_end_dt
-00015d30: 2d74 696d 6564 656c 7461 286d 696c 6c69  -timedelta(milli
-00015d40: 7365 636f 6e64 733d 3129 5d0a 0a20 2020  seconds=1)]..   
-00015d50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00015d60: 6669 7273 745f 6665 7463 685f 6661 696c  first_fetch_fail
-00015d70: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-00015d80: 2020 2020 2020 2020 6966 2073 6563 6f6e          if secon
-00015d90: 645f 6665 7463 685f 6661 696c 6564 3a0a  d_fetch_failed:.
-00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 2020 2020 2020 2020 2320 486f 7065 6675          # Hopefu
-00015dc0: 6c6c 7920 636f 6465 206e 6576 6572 2063  lly code never c
-00015dd0: 6f6d 6573 2068 6572 650a 2020 2020 2020  omes here.      
-00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015df0: 2020 7261 6973 6520 6578 0a20 2020 2020    raise ex.     
-00015e00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00015e10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00015e20: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-00015e30: 6571 7565 7374 6564 2064 6174 6520 7261  equested date ra
-00015e40: 6e67 6520 7761 7320 6a75 7374 2062 6566  nge was just bef
-00015e50: 6f72 6520 7374 6f63 6b20 6c69 7374 696e  ore stock listin
-00015e60: 6720 6461 7465 2c0a 2020 2020 2020 2020  g date,.        
-00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e80: 2320 6275 7420 7769 6465 7220 7261 6e67  # but wider rang
-00015e90: 6520 6372 6f73 7365 7320 6f76 6572 2073  e crosses over s
-00015ea0: 6f20 6361 6e20 636f 6e74 696e 7565 0a20  o can continue. 
-00015eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ec0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00015ed0: 2020 2020 2020 2020 2065 6c69 6620 7365           elif se
-00015ee0: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-00015ef0: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-00015f00: 6464 2070 6164 6469 6e67 2064 6179 7320  dd padding days 
-00015f10: 746f 2065 6e73 7572 6520 5961 686f 6f20  to ensure Yahoo 
-00015f20: 7265 7475 726e 7320 636f 7272 6563 7420  returns correct 
-00015f30: 566f 6c75 6d65 0a20 2020 2020 2020 2020  Volume.         
-00015f40: 2020 2020 2020 2073 203d 2079 6663 742e         s = yfct.
-00015f50: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
-00015f60: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
-00015f70: 652c 2066 6574 6368 5f73 7461 7274 202d  e, fetch_start -
-00015f80: 2032 2a73 656c 662e 6974 642c 2066 6574   2*self.itd, fet
-00015f90: 6368 5f65 6e64 202b 2032 2a73 656c 662e  ch_end + 2*self.
-00015fa0: 6974 6429 0a20 2020 2020 2020 2020 2020  itd).           
-00015fb0: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
-00015fc0: 5f70 6164 203d 2073 2e69 6c6f 635b 732e  _pad = s.iloc[s.
-00015fd0: 696e 6465 782e 6765 745f 696e 6465 7865  index.get_indexe
-00015fe0: 7228 5b73 7472 2866 6574 6368 5f73 7461  r([str(fetch_sta
-00015ff0: 7274 295d 2c20 6d65 7468 6f64 3d22 6666  rt)], method="ff
-00016000: 696c 6c22 295b 305d 2d31 5d2e 6e61 6d65  ill")[0]-1].name
-00016010: 2e64 6174 6528 290a 2020 2020 2020 2020  .date().        
-00016020: 2020 2020 2020 2020 6665 7463 685f 656e          fetch_en
-00016030: 645f 7061 6420 2020 3d20 732e 696c 6f63  d_pad   = s.iloc
-00016040: 5b73 2e69 6e64 6578 2e67 6574 5f69 6e64  [s.index.get_ind
-00016050: 6578 6572 285b 7374 7228 6665 7463 685f  exer([str(fetch_
-00016060: 656e 6429 5d2c 206d 6574 686f 643d 2262  end)], method="b
-00016070: 6669 6c6c 2229 5b30 5d2b 315d 2e6e 616d  fill")[0]+1].nam
-00016080: 652e 6461 7465 2829 0a0a 2020 2020 2020  e.date()..      
-00016090: 2020 2020 2020 2020 2020 6466 203d 2073            df = s
-000160a0: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
-000160b0: 6f72 795f 6461 7465 5261 6e67 6528 6665  ory_dateRange(fe
-000160c0: 7463 685f 7374 6172 745f 7061 642c 2066  tch_start_pad, f
-000160d0: 6574 6368 5f65 6e64 5f70 6164 2c20 7072  etch_end_pad, pr
-000160e0: 6570 6f73 742c 2064 6562 7567 290a 2020  epost, debug).  
-000160f0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00016100: 203d 2064 662e 6c6f 635b 7374 7228 6665   = df.loc[str(fe
-00016110: 7463 685f 7374 6172 7429 203a 2073 7472  tch_start) : str
-00016120: 2866 6574 6368 5f65 6e64 2d74 645f 3164  (fetch_end-td_1d
-00016130: 295d 2e63 6f70 7928 290a 0a20 2020 2020  )].copy()..     
-00016140: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00016150: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00016160: 6e74 7261 6461 790a 2020 2020 2020 2020  ntraday.        
-00016170: 2020 2020 2020 2020 6665 7463 685f 7261          fetch_ra
-00016180: 6e67 6573 203d 205b 2866 6574 6368 5f73  nges = [(fetch_s
-00016190: 7461 7274 2c20 6665 7463 685f 656e 6429  tart, fetch_end)
-000161a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000161b0: 2020 6966 2073 656c 662e 696e 7472 6164    if self.intrad
-000161c0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-000161d0: 2020 2020 2020 2020 2320 4164 6420 7061          # Add pa
-000161e0: 6464 696e 6720 6461 7973 2074 6f20 656e  dding days to en
-000161f0: 7375 7265 2059 6168 6f6f 2072 6574 7572  sure Yahoo retur
-00016200: 6e73 2063 6f72 7265 6374 2056 6f6c 756d  ns correct Volum
-00016210: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00016220: 2020 2020 2020 6d61 7852 616e 6765 203d        maxRange =
-00016230: 2079 6663 642e 7966 4d61 7846 6574 6368   yfcd.yfMaxFetch
-00016240: 5261 6e67 655b 7365 6c66 2e69 6e74 6572  Range[self.inter
-00016250: 7661 6c5d 0a20 2020 2020 2020 2020 2020  val].           
-00016260: 2020 2020 2020 2020 2069 6620 6d61 7852           if maxR
-00016270: 616e 6765 2069 7320 6e6f 7420 4e6f 6e65  ange is not None
-00016280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016290: 2020 2020 2020 2020 2020 7320 3d20 7966            s = yf
-000162a0: 6374 2e47 6574 4578 6368 616e 6765 5363  ct.GetExchangeSc
-000162b0: 6865 6475 6c65 2873 656c 662e 6578 6368  hedule(self.exch
-000162c0: 616e 6765 2c20 7374 6172 745f 6474 2e64  ange, start_dt.d
-000162d0: 6174 6528 2920 2d20 7464 5f31 3464 2c20  ate() - td_14d, 
-000162e0: 656e 645f 6474 2e64 6174 6528 2920 2b20  end_dt.date() + 
-000162f0: 7464 5f31 3464 290a 2020 2020 2020 2020  td_14d).        
-00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016310: 7320 3d20 732e 696c 6f63 5b73 2e69 6e64  s = s.iloc[s.ind
-00016320: 6578 2e67 6574 5f69 6e64 6578 6572 285b  ex.get_indexer([
-00016330: 7374 7228 7374 6172 745f 6474 2e64 6174  str(start_dt.dat
-00016340: 6528 2929 5d2c 206d 6574 686f 643d 2266  e())], method="f
-00016350: 6669 6c6c 2229 5b30 5d2d 313a 5d0a 2020  fill")[0]-1:].  
-00016360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016370: 2020 2020 2020 7320 3d20 732e 696c 6f63        s = s.iloc
-00016380: 5b3a 732e 696e 6465 782e 6765 745f 696e  [:s.index.get_in
-00016390: 6465 7865 7228 5b73 7472 2865 6e64 5f64  dexer([str(end_d
-000163a0: 742e 6461 7465 2829 295d 2c20 6d65 7468  t.date())], meth
-000163b0: 6f64 3d22 6266 696c 6c22 295b 305d 2b31  od="bfill")[0]+1
-000163c0: 2b31 5d0a 2020 2020 2020 2020 2020 2020  +1].            
-000163d0: 2020 2020 2020 2020 2020 2020 6c61 6720              lag 
-000163e0: 3d20 7966 6364 2e65 7863 6861 6e67 6554  = yfcd.exchangeT
-000163f0: 6f59 664c 6167 5b73 656c 662e 6578 6368  oYfLag[self.exch
-00016400: 616e 6765 5d0a 2020 2020 2020 2020 2020  ange].          
-00016410: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00016420: 2073 7461 7274 5f64 7420 3e20 735b 2263   start_dt > s["c
-00016430: 6c6f 7365 225d 2e69 6c6f 635b 315d 2b6c  lose"].iloc[1]+l
-00016440: 6167 3a0a 2020 2020 2020 2020 2020 2020  ag:.            
-00016450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016460: 7320 3d20 732e 6472 6f70 2873 2e69 6e64  s = s.drop(s.ind
-00016470: 6578 5b30 5d29 0a20 2020 2020 2020 2020  ex[0]).         
-00016480: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016490: 6620 656e 645f 6474 203c 2073 5b22 6f70  f end_dt < s["op
-000164a0: 656e 225d 2e69 6c6f 635b 2d32 5d2b 6c61  en"].iloc[-2]+la
-000164b0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000164d0: 203d 2073 2e64 726f 7028 732e 696e 6465   = s.drop(s.inde
-000164e0: 785b 2d31 5d29 0a20 2020 2020 2020 2020  x[-1]).         
-000164f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00016500: 2066 6574 6368 5f72 616e 6765 7320 3d20   fetch_ranges = 
-00016510: 7966 6375 2e43 6875 6e6b 4461 7465 7349  yfcu.ChunkDatesI
-00016520: 6e74 6f59 6646 6574 6368 6573 2873 7461  ntoYfFetches(sta
-00016530: 7274 5f64 2c20 656e 645f 642c 2073 2c20  rt_d, end_d, s, 
-00016540: 6d61 7852 616e 6765 2e64 6179 732c 206f  maxRange.days, o
-00016550: 7665 726c 6170 4461 7973 3d32 290a 2020  verlapDays=2).  
-00016560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016570: 2020 2020 2020 6665 7463 685f 7261 6e67        fetch_rang
-00016580: 6573 203d 2079 6663 752e 4368 756e 6b44  es = yfcu.ChunkD
-00016590: 6174 6573 496e 746f 5966 4665 7463 6865  atesIntoYfFetche
-000165a0: 7328 732c 206d 6178 5261 6e67 652e 6461  s(s, maxRange.da
-000165b0: 7973 2c20 6f76 6572 6c61 7044 6179 733d  ys, overlapDays=
-000165c0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000165d0: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-000165e0: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-000165f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016600: 2020 2020 2070 7269 6e74 2822 2d20 6665       print("- fe
-00016610: 7463 685f 7261 6e67 6573 3a22 290a 2020  tch_ranges:").  
-00016620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016630: 2020 2020 2020 2020 2020 7070 7269 6e74            pprint
-00016640: 2866 6574 6368 5f72 616e 6765 7329 0a20  (fetch_ranges). 
-00016650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016660: 2020 2020 2020 2023 2044 6f6e 2774 206e         # Don't n
-00016670: 6565 6420 746f 2066 6574 6368 2061 6c6c  eed to fetch all
-00016680: 206f 6620 7061 6464 696e 6720 6461 7973   of padding days
-00016690: 2c20 6a75 7374 2074 6865 2065 6e64 2f73  , just the end/s
-000166a0: 7461 7274 206f 6620 7365 7373 696f 6e0a  tart of session.
+00015a70: 2072 6169 7365 2065 780a 2020 2020 2020   raise ex.      
+00015a80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00015a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015aa0: 2020 2020 2320 5265 7175 6573 7465 6420      # Requested 
+00015ab0: 6461 7465 2072 616e 6765 2077 6173 206a  date range was j
+00015ac0: 7573 7420 6265 666f 7265 2073 746f 636b  ust before stock
+00015ad0: 206c 6973 7469 6e67 2064 6174 652c 0a20   listing date,. 
+00015ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015af0: 2020 2023 2062 7574 2077 6964 6572 2072     # but wider r
+00015b00: 616e 6765 2063 726f 7373 6573 206f 7665  ange crosses ove
+00015b10: 7220 736f 2063 616e 2063 6f6e 7469 6e75  r so can continu
+00015b20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00015b30: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00015b40: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
+00015b50: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
+00015b60: 2020 2020 2320 4164 6420 7061 6464 696e      # Add paddin
+00015b70: 6720 6461 7973 2074 6f20 656e 7375 7265  g days to ensure
+00015b80: 2059 6168 6f6f 2072 6574 7572 6e73 2063   Yahoo returns c
+00015b90: 6f72 7265 6374 2056 6f6c 756d 650a 2020  orrect Volume.  
+00015ba0: 2020 2020 2020 2020 2020 7320 3d20 7966            s = yf
+00015bb0: 6374 2e47 6574 4578 6368 616e 6765 5363  ct.GetExchangeSc
+00015bc0: 6865 6475 6c65 2873 656c 662e 6578 6368  hedule(self.exch
+00015bd0: 616e 6765 2c20 6665 7463 685f 7374 6172  ange, fetch_star
+00015be0: 7420 2d20 322a 7365 6c66 2e69 7464 2c20  t - 2*self.itd, 
+00015bf0: 6665 7463 685f 656e 6420 2b20 322a 7365  fetch_end + 2*se
+00015c00: 6c66 2e69 7464 290a 2020 2020 2020 2020  lf.itd).        
+00015c10: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+00015c20: 7061 6420 3d20 732e 696c 6f63 5b73 2e69  pad = s.iloc[s.i
+00015c30: 6e64 6578 2e67 6574 5f69 6e64 6578 6572  ndex.get_indexer
+00015c40: 285b 7374 7228 6665 7463 685f 7374 6172  ([str(fetch_star
+00015c50: 7429 5d2c 206d 6574 686f 643d 2266 6669  t)], method="ffi
+00015c60: 6c6c 2229 5b30 5d2d 315d 2e6e 616d 652e  ll")[0]-1].name.
+00015c70: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
+00015c80: 2020 2066 6574 6368 5f65 6e64 5f70 6164     fetch_end_pad
+00015c90: 2020 203d 2073 2e69 6c6f 635b 732e 696e     = s.iloc[s.in
+00015ca0: 6465 782e 6765 745f 696e 6465 7865 7228  dex.get_indexer(
+00015cb0: 5b73 7472 2866 6574 6368 5f65 6e64 295d  [str(fetch_end)]
+00015cc0: 2c20 6d65 7468 6f64 3d22 6266 696c 6c22  , method="bfill"
+00015cd0: 295b 305d 2b31 5d2e 6e61 6d65 2e64 6174  )[0]+1].name.dat
+00015ce0: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
+00015cf0: 2064 6620 3d20 7365 6c66 2e5f 6665 7463   df = self._fetc
+00015d00: 6859 6648 6973 746f 7279 5f64 6174 6552  hYfHistory_dateR
+00015d10: 616e 6765 2866 6574 6368 5f73 7461 7274  ange(fetch_start
+00015d20: 5f70 6164 2c20 6665 7463 685f 656e 645f  _pad, fetch_end_
+00015d30: 7061 642c 2070 7265 706f 7374 2c20 6465  pad, prepost, de
+00015d40: 6275 6729 0a20 2020 2020 2020 2020 2020  bug).           
+00015d50: 2064 6620 3d20 6466 2e6c 6f63 5b73 7472   df = df.loc[str
+00015d60: 2866 6574 6368 5f73 7461 7274 2920 3a20  (fetch_start) : 
+00015d70: 7374 7228 6665 7463 685f 656e 642d 7464  str(fetch_end-td
+00015d80: 5f31 6429 5d2e 636f 7079 2829 0a0a 2020  _1d)].copy()..  
+00015d90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00015da0: 2020 2020 2020 2020 2320 496e 7472 6164          # Intrad
+00015db0: 6179 0a20 2020 2020 2020 2020 2020 2066  ay.            f
+00015dc0: 6574 6368 5f72 616e 6765 7320 3d20 5b28  etch_ranges = [(
+00015dd0: 6665 7463 685f 7374 6172 742c 2066 6574  fetch_start, fet
+00015de0: 6368 5f65 6e64 295d 0a20 2020 2020 2020  ch_end)].       
+00015df0: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00015e00: 7261 6461 793a 0a20 2020 2020 2020 2020  raday:.         
+00015e10: 2020 2020 2020 2023 2041 6464 2070 6164         # Add pad
+00015e20: 6469 6e67 2064 6179 7320 746f 2065 6e73  ding days to ens
+00015e30: 7572 6520 5961 686f 6f20 7265 7475 726e  ure Yahoo return
+00015e40: 7320 636f 7272 6563 7420 566f 6c75 6d65  s correct Volume
+00015e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015e60: 206d 6178 5261 6e67 6520 3d20 7966 6364   maxRange = yfcd
+00015e70: 2e79 664d 6178 4665 7463 6852 616e 6765  .yfMaxFetchRange
+00015e80: 5b73 656c 662e 696e 7465 7276 616c 5d0a  [self.interval].
+00015e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ea0: 6966 206d 6178 5261 6e67 6520 6973 206e  if maxRange is n
+00015eb0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00015ec0: 2020 2020 2020 2020 2020 2020 2073 203d               s =
+00015ed0: 2079 6663 742e 4765 7445 7863 6861 6e67   yfct.GetExchang
+00015ee0: 6553 6368 6564 756c 6528 7365 6c66 2e65  eSchedule(self.e
+00015ef0: 7863 6861 6e67 652c 2073 7461 7274 5f64  xchange, start_d
+00015f00: 742e 6461 7465 2829 202d 2074 645f 3134  t.date() - td_14
+00015f10: 642c 2065 6e64 5f64 742e 6461 7465 2829  d, end_dt.date()
+00015f20: 202b 2074 645f 3134 6429 0a20 2020 2020   + td_14d).     
+00015f30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015f40: 203d 2073 2e69 6c6f 635b 732e 696e 6465   = s.iloc[s.inde
+00015f50: 782e 6765 745f 696e 6465 7865 7228 5b73  x.get_indexer([s
+00015f60: 7472 2873 7461 7274 5f64 742e 6461 7465  tr(start_dt.date
+00015f70: 2829 295d 2c20 6d65 7468 6f64 3d22 6666  ())], method="ff
+00015f80: 696c 6c22 295b 305d 2d31 3a5d 0a20 2020  ill")[0]-1:].   
+00015f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fa0: 2073 203d 2073 2e69 6c6f 635b 3a73 2e69   s = s.iloc[:s.i
+00015fb0: 6e64 6578 2e67 6574 5f69 6e64 6578 6572  ndex.get_indexer
+00015fc0: 285b 7374 7228 656e 645f 6474 2e64 6174  ([str(end_dt.dat
+00015fd0: 6528 2929 5d2c 206d 6574 686f 643d 2262  e())], method="b
+00015fe0: 6669 6c6c 2229 5b30 5d2b 312b 315d 0a20  fill")[0]+1+1]. 
+00015ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016000: 2020 206c 6167 203d 2079 6663 642e 6578     lag = yfcd.ex
+00016010: 6368 616e 6765 546f 5966 4c61 675b 7365  changeToYfLag[se
+00016020: 6c66 2e65 7863 6861 6e67 655d 0a20 2020  lf.exchange].   
+00016030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016040: 2069 6620 7374 6172 745f 6474 203e 2073   if start_dt > s
+00016050: 5b22 636c 6f73 6522 5d2e 696c 6f63 5b31  ["close"].iloc[1
+00016060: 5d2b 6c61 673a 0a20 2020 2020 2020 2020  ]+lag:.         
+00016070: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016080: 203d 2073 2e64 726f 7028 732e 696e 6465   = s.drop(s.inde
+00016090: 785b 305d 290a 2020 2020 2020 2020 2020  x[0]).          
+000160a0: 2020 2020 2020 2020 2020 6966 2065 6e64            if end
+000160b0: 5f64 7420 3c20 735b 226f 7065 6e22 5d2e  _dt < s["open"].
+000160c0: 696c 6f63 5b2d 325d 2b6c 6167 3a0a 2020  iloc[-2]+lag:.  
+000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160e0: 2020 2020 2020 7320 3d20 732e 6472 6f70        s = s.drop
+000160f0: 2873 2e69 6e64 6578 5b2d 315d 290a 2020  (s.index[-1]).  
+00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016110: 2020 2320 6665 7463 685f 7261 6e67 6573    # fetch_ranges
+00016120: 203d 2079 6663 752e 4368 756e 6b44 6174   = yfcu.ChunkDat
+00016130: 6573 496e 746f 5966 4665 7463 6865 7328  esIntoYfFetches(
+00016140: 7374 6172 745f 642c 2065 6e64 5f64 2c20  start_d, end_d, 
+00016150: 732c 206d 6178 5261 6e67 652e 6461 7973  s, maxRange.days
+00016160: 2c20 6f76 6572 6c61 7044 6179 733d 3229  , overlapDays=2)
+00016170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016180: 2020 2020 2066 6574 6368 5f72 616e 6765       fetch_range
+00016190: 7320 3d20 7966 6375 2e43 6875 6e6b 4461  s = yfcu.ChunkDa
+000161a0: 7465 7349 6e74 6f59 6646 6574 6368 6573  tesIntoYfFetches
+000161b0: 2873 2c20 6d61 7852 616e 6765 2e64 6179  (s, maxRange.day
+000161c0: 732c 206f 7665 726c 6170 4461 7973 3d32  s, overlapDays=2
+000161d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000161e0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+000161f0: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00016200: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00016210: 7428 222d 2066 6574 6368 5f72 616e 6765  t("- fetch_range
+00016220: 733a 2229 0a20 2020 2020 2020 2020 2020  s:").           
+00016230: 2020 2020 2020 2020 2020 2020 2070 7072               ppr
+00016240: 696e 7428 6665 7463 685f 7261 6e67 6573  int(fetch_ranges
+00016250: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016260: 2020 2020 2020 2320 446f 6e27 7420 6e65        # Don't ne
+00016270: 6564 2074 6f20 6665 7463 6820 616c 6c20  ed to fetch all 
+00016280: 6f66 2070 6164 6469 6e67 2064 6179 732c  of padding days,
+00016290: 206a 7573 7420 7468 6520 656e 642f 7374   just the end/st
+000162a0: 6172 7420 6f66 2073 6573 7369 6f6e 0a20  art of session. 
+000162b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162c0: 2020 2023 2066 6574 6368 5f72 616e 6765     # fetch_range
+000162d0: 735b 305d 5b30 5d20 3d20 735b 2263 6c6f  s[0][0] = s["clo
+000162e0: 7365 225d 2e69 6c6f 635b 305d 202d 2074  se"].iloc[0] - t
+000162f0: 696d 6564 656c 7461 2868 6f75 7273 3d32  imedelta(hours=2
+00016300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016310: 2020 2020 2020 2320 6665 7463 685f 7261        # fetch_ra
+00016320: 6e67 6573 5b2d 315d 5b31 5d20 3d20 735b  nges[-1][1] = s[
+00016330: 226f 7065 6e22 5d2e 696c 6f63 5b2d 315d  "open"].iloc[-1]
+00016340: 202b 2074 696d 6564 656c 7461 2868 6f75   + timedelta(hou
+00016350: 7273 3d32 290a 2020 2020 2020 2020 2020  rs=2).          
+00016360: 2020 2020 2020 2020 2020 2320 6665 7463            # fetc
+00016370: 685f 7261 6e67 6573 5b30 5d5b 2266 6574  h_ranges[0]["fet
+00016380: 6368 2073 7461 7274 225d 203d 2073 5b22  ch start"] = s["
+00016390: 636c 6f73 6522 5d2e 696c 6f63 5b30 5d20  close"].iloc[0] 
+000163a0: 2d20 7469 6d65 6465 6c74 6128 686f 7572  - timedelta(hour
+000163b0: 733d 3229 0a20 2020 2020 2020 2020 2020  s=2).           
+000163c0: 2020 2020 2020 2020 2023 2055 7064 6174           # Updat
+000163d0: 653a 206e 6565 6420 7374 6172 7420 6675  e: need start fu
+000163e0: 7274 6865 7220 6261 636b 2066 6f72 206c  rther back for l
+000163f0: 6f77 2d76 6f6c 756d 6520 7469 636b 6572  ow-volume ticker
+00016400: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00016410: 2020 2020 2020 6665 7463 685f 7261 6e67        fetch_rang
+00016420: 6573 5b30 5d5b 2266 6574 6368 2073 7461  es[0]["fetch sta
+00016430: 7274 225d 203d 2073 5b22 6f70 656e 225d  rt"] = s["open"]
+00016440: 2e69 6c6f 635b 305d 0a20 2020 2020 2020  .iloc[0].       
+00016450: 2020 2020 2020 2020 2020 2020 2066 6574               fet
+00016460: 6368 5f72 616e 6765 735b 2d31 5d5b 2266  ch_ranges[-1]["f
+00016470: 6574 6368 2065 6e64 225d 203d 2073 5b22  etch end"] = s["
+00016480: 6f70 656e 225d 2e69 6c6f 635b 2d31 5d20  open"].iloc[-1] 
+00016490: 2b20 7469 6d65 6465 6c74 6128 686f 7572  + timedelta(hour
+000164a0: 733d 3229 0a20 2020 2020 2020 2020 2020  s=2).           
+000164b0: 2020 2020 2020 2020 206d 6178 4c6f 6f6b           maxLook
+000164c0: 6261 636b 203d 2079 6663 642e 7966 4d61  back = yfcd.yfMa
+000164d0: 7846 6574 6368 4c6f 6f6b 6261 636b 5b73  xFetchLookback[s
+000164e0: 656c 662e 696e 7465 7276 616c 5d20 2d20  elf.interval] - 
+000164f0: 7469 6d65 6465 6c74 6128 7365 636f 6e64  timedelta(second
+00016500: 733d 3130 290a 2020 2020 2020 2020 2020  s=10).          
+00016510: 2020 2020 2020 2020 2020 6966 206d 6178            if max
+00016520: 4c6f 6f6b 6261 636b 2069 7320 6e6f 7420  Lookback is not 
+00016530: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00016540: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00016550: 784c 6f6f 6b62 6163 6b5f 6474 203d 2028  xLookback_dt = (
+00016560: 6474 5f6e 6f77 202d 206d 6178 4c6f 6f6b  dt_now - maxLook
+00016570: 6261 636b 292e 747a 5f63 6f6e 7665 7274  back).tz_convert
+00016580: 2874 7a5f 6578 6368 616e 6765 290a 2020  (tz_exchange).  
+00016590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165a0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+000165b0: 616e 6765 286c 656e 2866 6574 6368 5f72  ange(len(fetch_r
+000165c0: 616e 6765 7329 2d31 2c20 2d31 2c20 2d31  anges)-1, -1, -1
+000165d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000165e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000165f0: 6620 6665 7463 685f 7261 6e67 6573 5b69  f fetch_ranges[i
+00016600: 5d5b 2266 6574 6368 2073 7461 7274 225d  ]["fetch start"]
+00016610: 203c 206d 6178 4c6f 6f6b 6261 636b 5f64   < maxLookback_d
+00016620: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00016630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016640: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+00016650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016670: 2020 2020 2070 7269 6e74 2822 2d20 6361       print("- ca
+00016680: 7070 696e 6720 7374 6172 7420 746f 206d  pping start to m
+00016690: 6178 4c6f 6f6b 6261 636b 5f64 7422 290a  axLookback_dt").
+000166a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166c0: 2020 2020 2020 2020 2320 6665 7463 685f          # fetch_
-000166d0: 7261 6e67 6573 5b30 5d5b 305d 203d 2073  ranges[0][0] = s
-000166e0: 5b22 636c 6f73 6522 5d2e 696c 6f63 5b30  ["close"].iloc[0
-000166f0: 5d20 2d20 7469 6d65 6465 6c74 6128 686f  ] - timedelta(ho
-00016700: 7572 733d 3229 0a20 2020 2020 2020 2020  urs=2).         
-00016710: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00016720: 2066 6574 6368 5f72 616e 6765 735b 2d31   fetch_ranges[-1
-00016730: 5d5b 315d 203d 2073 5b22 6f70 656e 225d  ][1] = s["open"]
-00016740: 2e69 6c6f 635b 2d31 5d20 2b20 7469 6d65  .iloc[-1] + time
-00016750: 6465 6c74 6128 686f 7572 733d 3229 0a20  delta(hours=2). 
-00016760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016770: 2020 2020 2020 2023 2066 6574 6368 5f72         # fetch_r
-00016780: 616e 6765 735b 305d 5b22 6665 7463 6820  anges[0]["fetch 
-00016790: 7374 6172 7422 5d20 3d20 735b 2263 6c6f  start"] = s["clo
-000167a0: 7365 225d 2e69 6c6f 635b 305d 202d 2074  se"].iloc[0] - t
-000167b0: 696d 6564 656c 7461 2868 6f75 7273 3d32  imedelta(hours=2
-000167c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000167d0: 2020 2020 2020 2020 2020 2320 5570 6461            # Upda
-000167e0: 7465 3a20 6e65 6564 2073 7461 7274 2066  te: need start f
-000167f0: 7572 7468 6572 2062 6163 6b20 666f 7220  urther back for 
-00016800: 6c6f 772d 766f 6c75 6d65 2074 6963 6b65  low-volume ticke
-00016810: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
-00016820: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
-00016830: 5f72 616e 6765 735b 305d 5b22 6665 7463  _ranges[0]["fetc
-00016840: 6820 7374 6172 7422 5d20 3d20 735b 226f  h start"] = s["o
-00016850: 7065 6e22 5d2e 696c 6f63 5b30 5d0a 2020  pen"].iloc[0].  
-00016860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016870: 2020 2020 2020 6665 7463 685f 7261 6e67        fetch_rang
-00016880: 6573 5b2d 315d 5b22 6665 7463 6820 656e  es[-1]["fetch en
-00016890: 6422 5d20 3d20 735b 226f 7065 6e22 5d2e  d"] = s["open"].
-000168a0: 696c 6f63 5b2d 315d 202b 2074 696d 6564  iloc[-1] + timed
-000168b0: 656c 7461 2868 6f75 7273 3d32 290a 2020  elta(hours=2).  
-000168c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168d0: 2020 2020 2020 2320 7072 696e 7428 222d        # print("-
-000168e0: 2066 6574 6368 5f72 616e 6765 733a 2229   fetch_ranges:")
-000168f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016900: 2020 2020 2020 2020 2023 2070 7072 696e           # pprin
-00016910: 7428 6665 7463 685f 7261 6e67 6573 290a  t(fetch_ranges).
-00016920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016930: 2020 2020 2020 2020 6d61 784c 6f6f 6b62          maxLookb
-00016940: 6163 6b20 3d20 7966 6364 2e79 664d 6178  ack = yfcd.yfMax
-00016950: 4665 7463 684c 6f6f 6b62 6163 6b5b 7365  FetchLookback[se
-00016960: 6c66 2e69 6e74 6572 7661 6c5d 202d 2074  lf.interval] - t
-00016970: 696d 6564 656c 7461 2873 6563 6f6e 6473  imedelta(seconds
-00016980: 3d31 3029 0a20 2020 2020 2020 2020 2020  =10).           
-00016990: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000169a0: 6d61 784c 6f6f 6b62 6163 6b20 6973 206e  maxLookback is n
-000169b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000169c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169d0: 2020 2020 206d 6178 4c6f 6f6b 6261 636b       maxLookback
-000169e0: 5f64 7420 3d20 2864 745f 6e6f 7720 2d20  _dt = (dt_now - 
-000169f0: 6d61 784c 6f6f 6b62 6163 6b29 2e74 7a5f  maxLookback).tz_
-00016a00: 636f 6e76 6572 7428 747a 5f65 7863 6861  convert(tz_excha
-00016a10: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
-00016a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a30: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00016a40: 6c65 6e28 6665 7463 685f 7261 6e67 6573  len(fetch_ranges
-00016a50: 292d 312c 202d 312c 202d 3129 3a0a 2020  )-1, -1, -1):.  
-00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a70: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00016a80: 2066 6574 6368 5f72 616e 6765 735b 695d   fetch_ranges[i]
-00016a90: 5b22 6665 7463 6820 7374 6172 7422 5d20  ["fetch start"] 
-00016aa0: 3c20 6d61 784c 6f6f 6b62 6163 6b5f 6474  < maxLookback_dt
-00016ab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ad0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
-00016ae0: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-00016af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00016b10: 7428 222d 2063 6170 7069 6e67 2073 7461  t("- capping sta
-00016b20: 7274 2074 6f20 6d61 784c 6f6f 6b62 6163  rt to maxLookbac
-00016b30: 6b5f 6474 2229 0a20 2020 2020 2020 2020  k_dt").         
-00016b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b50: 2020 2020 2020 2020 2020 2023 2066 6574             # fet
-00016b60: 6368 5f72 616e 6765 735b 695d 5b22 6665  ch_ranges[i]["fe
-00016b70: 7463 6820 7374 6172 7422 5d20 3d20 6d61  tch start"] = ma
-00016b80: 784c 6f6f 6b62 6163 6b5f 6474 0a20 2020  xLookback_dt.   
-00016b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bb0: 2066 6574 6368 5f72 616e 6765 735b 695d   fetch_ranges[i]
-00016bc0: 5b22 6665 7463 6820 7374 6172 7422 5d20  ["fetch start"] 
-00016bd0: 3d20 6d61 784c 6f6f 6b62 6163 6b5f 6474  = maxLookback_dt
-00016be0: 2e63 6569 6c28 2244 2229 0a20 2020 2020  .ceil("D").     
-00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00016c10: 6574 6368 5f72 616e 6765 735b 695d 5b22  etch_ranges[i]["
-00016c20: 636f 7265 2073 7461 7274 225d 203d 2066  core start"] = f
-00016c30: 6574 6368 5f72 616e 6765 735b 695d 5b22  etch_ranges[i]["
-00016c40: 6665 7463 6820 7374 6172 7422 5d20 2b20  fetch start"] + 
-00016c50: 7464 5f31 640a 2020 2020 2020 2020 2020  td_1d.          
-00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c70: 2020 2020 2020 2020 2020 6966 2066 6574            if fet
-00016c80: 6368 5f72 616e 6765 735b 695d 5b22 6665  ch_ranges[i]["fe
-00016c90: 7463 6820 7374 6172 7422 5d20 3e3d 2066  tch start"] >= f
-00016ca0: 6574 6368 5f72 616e 6765 735b 695d 5b22  etch_ranges[i]["
-00016cb0: 6665 7463 6820 656e 6422 5d3a 0a20 2020  fetch end"]:.   
-00016cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ce0: 2020 2020 2064 656c 2066 6574 6368 5f72       del fetch_r
-00016cf0: 616e 6765 735b 695d 0a0a 2020 2020 2020  anges[i]..      
-00016d00: 2020 2020 2020 2020 2020 6466 203d 204e            df = N
-00016d10: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00016d20: 2020 2020 666f 7220 7220 696e 2066 6574      for r in fet
-00016d30: 6368 5f72 616e 6765 733a 0a20 2020 2020  ch_ranges:.     
-00016d40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016d50: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
-00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d70: 2020 2020 2070 7269 6e74 2822 2d20 6665       print("- fe
-00016d80: 7463 6869 6e67 3a22 290a 2020 2020 2020  tching:").      
-00016d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016da0: 2020 7072 696e 7428 7229 0a20 2020 2020    print(r).     
-00016db0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00016dc0: 6574 6368 5f73 7461 7274 203d 2072 5b22  etch_start = r["
-00016dd0: 6665 7463 6820 7374 6172 7422 5d0a 2020  fetch start"].  
+000166c0: 2320 6665 7463 685f 7261 6e67 6573 5b69  # fetch_ranges[i
+000166d0: 5d5b 2266 6574 6368 2073 7461 7274 225d  ]["fetch start"]
+000166e0: 203d 206d 6178 4c6f 6f6b 6261 636b 5f64   = maxLookback_d
+000166f0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00016700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016710: 2020 6665 7463 685f 7261 6e67 6573 5b69    fetch_ranges[i
+00016720: 5d5b 2266 6574 6368 2073 7461 7274 225d  ]["fetch start"]
+00016730: 203d 206d 6178 4c6f 6f6b 6261 636b 5f64   = maxLookback_d
+00016740: 742e 6365 696c 2822 4422 290a 2020 2020  t.ceil("D").    
+00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016760: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00016770: 685f 7261 6e67 6573 5b69 5d5b 2263 6f72  h_ranges[i]["cor
+00016780: 6520 7374 6172 7422 5d20 3d20 6665 7463  e start"] = fetc
+00016790: 685f 7261 6e67 6573 5b69 5d5b 2266 6574  h_ranges[i]["fet
+000167a0: 6368 2073 7461 7274 225d 202b 2074 645f  ch start"] + td_
+000167b0: 3164 0a20 2020 2020 2020 2020 2020 2020  1d.             
+000167c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167d0: 2020 2069 6620 6665 7463 685f 7261 6e67     if fetch_rang
+000167e0: 6573 5b69 5d5b 2266 6574 6368 2073 7461  es[i]["fetch sta
+000167f0: 7274 225d 203e 3d20 6665 7463 685f 7261  rt"] >= fetch_ra
+00016800: 6e67 6573 5b69 5d5b 2266 6574 6368 2065  nges[i]["fetch e
+00016810: 6e64 225d 3a0a 2020 2020 2020 2020 2020  nd"]:.          
+00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016830: 2020 2020 2020 2020 2020 6465 6c20 6665            del fe
+00016840: 7463 685f 7261 6e67 6573 5b69 5d0a 0a20  tch_ranges[i].. 
+00016850: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+00016860: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00016870: 2066 6f72 2072 2069 6e20 6665 7463 685f   for r in fetch_
+00016880: 7261 6e67 6573 3a0a 2020 2020 2020 2020  ranges:.        
+00016890: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+000168a0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+000168b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000168c0: 222d 2066 6574 6368 696e 673a 2229 0a20  "- fetching:"). 
+000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168e0: 2020 2070 7269 6e74 2872 290a 2020 2020     print(r).    
+000168f0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00016900: 685f 7374 6172 7420 3d20 725b 2266 6574  h_start = r["fet
+00016910: 6368 2073 7461 7274 225d 0a20 2020 2020  ch start"].     
+00016920: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+00016930: 5f65 6e64 203d 2072 5b22 6665 7463 6820  _end = r["fetch 
+00016940: 656e 6422 5d0a 2020 2020 2020 2020 2020  end"].          
+00016950: 2020 2020 2020 6466 7220 3d20 7365 6c66        dfr = self
+00016960: 2e5f 6665 7463 6859 6648 6973 746f 7279  ._fetchYfHistory
+00016970: 5f64 6174 6552 616e 6765 2866 6574 6368  _dateRange(fetch
+00016980: 5f73 7461 7274 2c20 6665 7463 685f 656e  _start, fetch_en
+00016990: 642c 2070 7265 706f 7374 2c20 6465 6275  d, prepost, debu
+000169a0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+000169b0: 2020 2023 2044 6973 6361 7264 2070 6164     # Discard pad
+000169c0: 6469 6e67 2064 6179 733a 0a20 2020 2020  ding days:.     
+000169d0: 2020 2020 2020 2020 2020 2064 6672 203d             dfr =
+000169e0: 2064 6672 2e6c 6f63 5b72 5b22 636f 7265   dfr.loc[r["core
+000169f0: 2073 7461 7274 225d 3a20 725b 2263 6f72   start"]: r["cor
+00016a00: 6520 656e 6422 5d20 2d20 7469 6d65 6465  e end"] - timede
+00016a10: 6c74 6128 6d69 6c6c 6973 6563 6f6e 6473  lta(milliseconds
+00016a20: 3d31 295d 0a20 2020 2020 2020 2020 2020  =1)].           
+00016a30: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
+00016a40: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+00016a50: 2020 2020 2020 2070 7269 6e74 2822 2d20         print("- 
+00016a60: 6466 7220 6166 7465 7220 6469 7363 6172  dfr after discar
+00016a70: 6469 6e67 2070 6164 6469 6e67 2064 6179  ding padding day
+00016a80: 733a 2229 0a20 2020 2020 2020 2020 2020  s:").           
+00016a90: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
+00016aa0: 6672 5b5b 6320 666f 7220 6320 696e 205b  fr[[c for c in [
+00016ab0: 224f 7065 6e22 2c20 224c 6f77 222c 2022  "Open", "Low", "
+00016ac0: 4869 6768 222c 2022 436c 6f73 6522 2c20  High", "Close", 
+00016ad0: 2244 6976 6964 656e 6473 222c 2022 566f  "Dividends", "Vo
+00016ae0: 6c75 6d65 225d 2069 6620 6320 696e 2064  lume"] if c in d
+00016af0: 6672 2e63 6f6c 756d 6e73 5d5d 290a 2020  fr.columns]]).  
+00016b00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00016b10: 2064 6620 6973 204e 6f6e 653a 0a20 2020   df is None:.   
+00016b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b30: 2064 6620 3d20 6466 720a 2020 2020 2020   df = dfr.      
+00016b40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b60: 2020 2020 6466 203d 2070 642e 636f 6e63      df = pd.conc
+00016b70: 6174 285b 6466 2c20 6466 725b 6466 2e63  at([df, dfr[df.c
+00016b80: 6f6c 756d 6e73 5d5d 290a 2020 2020 2020  olumns]]).      
+00016b90: 2020 2020 2020 2020 2020 6966 2064 662e            if df.
+00016ba0: 696e 6465 782e 6475 706c 6963 6174 6564  index.duplicated
+00016bb0: 2829 2e61 6e79 2829 3a0a 2020 2020 2020  ().any():.      
+00016bc0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00016bd0: 6973 6520 4578 6365 7074 696f 6e28 2264  ise Exception("d
+00016be0: 6620 636f 6e74 6169 6e73 2064 7570 6c69  f contains dupli
+00016bf0: 6361 7465 6420 6461 7465 7322 290a 0a20  cated dates").. 
+00016c00: 2020 2020 2020 2066 6574 6368 5f64 745f         fetch_dt_
+00016c10: 7574 6320 3d20 7064 2e54 696d 6573 7461  utc = pd.Timesta
+00016c20: 6d70 2e75 7463 6e6f 7728 292e 747a 5f63  mp.utcnow().tz_c
+00016c30: 6f6e 7665 7274 285a 6f6e 6549 6e66 6f28  onvert(ZoneInfo(
+00016c40: 2255 5443 2229 290a 0a20 2020 2020 2020  "UTC"))..       
+00016c50: 2069 6620 2864 6620 6973 206e 6f74 204e   if (df is not N
+00016c60: 6f6e 6529 2061 6e64 2028 6466 2e69 6e64  one) and (df.ind
+00016c70: 6578 2e74 7a20 6973 206e 6f74 204e 6f6e  ex.tz is not Non
+00016c80: 6529 2061 6e64 2028 6e6f 7420 6973 696e  e) and (not isin
+00016c90: 7374 616e 6365 2864 662e 696e 6465 782e  stance(df.index.
+00016ca0: 747a 2c20 5a6f 6e65 496e 666f 2929 3a0a  tz, ZoneInfo)):.
+00016cb0: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+00016cc0: 6e76 6572 7420 746f 205a 6f6e 6549 6e66  nvert to ZoneInf
+00016cd0: 6f0a 2020 2020 2020 2020 2020 2020 6466  o.            df
+00016ce0: 2e69 6e64 6578 203d 2064 662e 696e 6465  .index = df.inde
+00016cf0: 782e 747a 5f63 6f6e 7665 7274 2874 7a5f  x.tz_convert(tz_
+00016d00: 6578 6368 616e 6765 290a 0a20 2020 2020  exchange)..     
+00016d10: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+00016d20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00016d30: 6466 2069 7320 4e6f 6e65 3a0a 2020 2020  df is None:.    
+00016d40: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00016d50: 3d20 222d 2059 4620 7265 7475 726e 6564  = "- YF returned
+00016d60: 204e 6f6e 6522 0a20 2020 2020 2020 2020   None".         
+00016d70: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00016d80: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+00016d90: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+00016da0: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+00016db0: 7428 6d73 6729 0a20 2020 2020 2020 2020  t(msg).         
+00016dc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00016dd0: 2020 2020 2020 2020 2023 2070 6173 730a           # pass.
 00016de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016df0: 2020 6665 7463 685f 656e 6420 3d20 725b    fetch_end = r[
-00016e00: 2266 6574 6368 2065 6e64 225d 0a20 2020  "fetch end"].   
-00016e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e20: 2064 6672 203d 2073 656c 662e 5f66 6574   dfr = self._fet
-00016e30: 6368 5966 4869 7374 6f72 795f 6461 7465  chYfHistory_date
-00016e40: 5261 6e67 6528 6665 7463 685f 7374 6172  Range(fetch_star
-00016e50: 742c 2066 6574 6368 5f65 6e64 2c20 7072  t, fetch_end, pr
-00016e60: 6570 6f73 742c 2064 6562 7567 290a 2020  epost, debug).  
-00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e80: 2020 2320 4469 7363 6172 6420 7061 6464    # Discard padd
-00016e90: 696e 6720 6461 7973 3a0a 2020 2020 2020  ing days:.      
-00016ea0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00016eb0: 7220 3d20 6466 722e 6c6f 635b 725b 2263  r = dfr.loc[r["c
-00016ec0: 6f72 6520 7374 6172 7422 5d3a 2072 5b22  ore start"]: r["
-00016ed0: 636f 7265 2065 6e64 225d 202d 2074 696d  core end"] - tim
-00016ee0: 6564 656c 7461 286d 696c 6c69 7365 636f  edelta(milliseco
-00016ef0: 6e64 733d 3129 5d0a 2020 2020 2020 2020  nds=1)].        
-00016f00: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00016f10: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
-00016f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f30: 2020 7072 696e 7428 222d 2064 6672 2061    print("- dfr a
-00016f40: 6674 6572 2064 6973 6361 7264 696e 6720  fter discarding 
-00016f50: 7061 6464 696e 6720 6461 7973 3a22 290a  padding days:").
-00016f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f70: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
-00016f80: 725b 5b63 2066 6f72 2063 2069 6e20 5b22  r[[c for c in ["
-00016f90: 4f70 656e 222c 2022 4c6f 7722 2c20 2248  Open", "Low", "H
-00016fa0: 6967 6822 2c20 2243 6c6f 7365 222c 2022  igh", "Close", "
-00016fb0: 4469 7669 6465 6e64 7322 2c20 2256 6f6c  Dividends", "Vol
-00016fc0: 756d 6522 5d20 6966 2063 2069 6e20 6466  ume"] if c in df
-00016fd0: 722e 636f 6c75 6d6e 735d 5d29 0a20 2020  r.columns]]).   
-00016fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ff0: 2069 6620 6466 2069 7320 4e6f 6e65 3a0a   if df is None:.
-00017000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017010: 2020 2020 2020 2020 6466 203d 2064 6672          df = dfr
-00017020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017030: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017050: 2020 2064 6620 3d20 7064 2e63 6f6e 6361     df = pd.conca
-00017060: 7428 5b64 662c 2064 6672 5d2c 2073 6f72  t([df, dfr], sor
-00017070: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
-00017080: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00017090: 662e 696e 6465 782e 6475 706c 6963 6174  f.index.duplicat
-000170a0: 6564 2829 2e61 6e79 2829 3a0a 2020 2020  ed().any():.    
-000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170c0: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-000170d0: 696f 6e28 2264 6620 636f 6e74 6169 6e73  ion("df contains
-000170e0: 2064 7570 6c69 6361 7465 6420 6461 7465   duplicated date
-000170f0: 7322 290a 0a20 2020 2020 2020 2066 6574  s")..        fet
-00017100: 6368 5f64 745f 7574 6320 3d20 7064 2e54  ch_dt_utc = pd.T
-00017110: 696d 6573 7461 6d70 2e75 7463 6e6f 7728  imestamp.utcnow(
-00017120: 292e 747a 5f63 6f6e 7665 7274 285a 6f6e  ).tz_convert(Zon
-00017130: 6549 6e66 6f28 2255 5443 2229 290a 0a20  eInfo("UTC")).. 
-00017140: 2020 2020 2020 2069 6620 2864 6620 6973         if (df is
-00017150: 206e 6f74 204e 6f6e 6529 2061 6e64 2028   not None) and (
-00017160: 6466 2e69 6e64 6578 2e74 7a20 6973 206e  df.index.tz is n
-00017170: 6f74 204e 6f6e 6529 2061 6e64 2028 6e6f  ot None) and (no
-00017180: 7420 6973 696e 7374 616e 6365 2864 662e  t isinstance(df.
-00017190: 696e 6465 782e 747a 2c20 5a6f 6e65 496e  index.tz, ZoneIn
-000171a0: 666f 2929 3a0a 2020 2020 2020 2020 2020  fo)):.          
-000171b0: 2020 2320 436f 6e76 6572 7420 746f 205a    # Convert to Z
-000171c0: 6f6e 6549 6e66 6f0a 2020 2020 2020 2020  oneInfo.        
-000171d0: 2020 2020 6466 2e69 6e64 6578 203d 2064      df.index = d
-000171e0: 662e 696e 6465 782e 747a 5f63 6f6e 7665  f.index.tz_conve
-000171f0: 7274 2874 7a5f 6578 6368 616e 6765 290a  rt(tz_exchange).
-00017200: 0a20 2020 2020 2020 2069 6620 6465 6275  .        if debu
-00017210: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-00017220: 2020 2069 6620 6466 2069 7320 4e6f 6e65     if df is None
-00017230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017240: 2020 6d73 6720 3d20 222d 2059 4620 7265    msg = "- YF re
-00017250: 7475 726e 6564 204e 6f6e 6522 0a20 2020  turned None".   
-00017260: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00017270: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-00017280: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-00017290: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-000172a0: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
-000172b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000172c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000172d0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-000172e0: 2020 2020 2020 6d73 6720 3d20 222d 2059        msg = "- Y
-000172f0: 4620 7265 7475 726e 6564 2074 6162 6c65  F returned table
-00017300: 3a22 0a20 2020 2020 2020 2020 2020 2020  :".             
-00017310: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-00017320: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
-00017330: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-00017340: 2829 2065 6c73 6520 7072 696e 7428 6d73  () else print(ms
-00017350: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00017360: 2020 2070 7269 6e74 2864 665b 5b63 2066     print(df[[c f
-00017370: 6f72 2063 2069 6e20 5b22 4f70 656e 222c  or c in ["Open",
-00017380: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
-00017390: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
-000173a0: 6e64 7322 2c20 2256 6f6c 756d 6522 5d20  nds", "Volume"] 
-000173b0: 6966 2063 2069 6e20 6466 2e63 6f6c 756d  if c in df.colum
-000173c0: 6e73 5d5d 290a 0a20 2020 2020 2020 2023  ns]])..        #
-000173d0: 2044 6574 6563 7420 6c69 7374 696e 6720   Detect listing 
-000173e0: 6461 790a 2020 2020 2020 2020 6c69 7374  day.        list
-000173f0: 696e 675f 6461 7920 3d20 7966 636d 2e52  ing_day = yfcm.R
-00017400: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
-00017410: 6c66 2e74 6963 6b65 722c 2022 6c69 7374  lf.ticker, "list
-00017420: 696e 675f 6461 7465 2229 0a20 2020 2020  ing_date").     
-00017430: 2020 2069 6620 6c69 7374 696e 675f 6461     if listing_da
-00017440: 7920 6973 204e 6f6e 653a 0a20 2020 2020  y is None:.     
-00017450: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00017460: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
-00017470: 496e 7465 7276 616c 2e44 6179 7331 3a0a  Interval.Days1:.
-00017480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017490: 666f 756e 645f 6c69 7374 696e 675f 6461  found_listing_da
-000174a0: 7920 3d20 4661 6c73 650a 2020 2020 2020  y = False.      
-000174b0: 2020 2020 2020 2020 2020 6c69 7374 696e            listin
-000174c0: 675f 6461 7920 3d20 4e6f 6e65 0a20 2020  g_day = None.   
-000174d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000174e0: 6466 2069 7320 6e6f 7420 4e6f 6e65 2061  df is not None a
-000174f0: 6e64 206e 6f74 2064 662e 656d 7074 793a  nd not df.empty:
-00017500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017510: 2020 2020 2069 6620 7073 7472 203d 3d20       if pstr == 
-00017520: 226d 6178 223a 0a20 2020 2020 2020 2020  "max":.         
-00017530: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017540: 6f75 6e64 5f6c 6973 7469 6e67 5f64 6179  ound_listing_day
-00017550: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00017560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017570: 6c69 7374 696e 675f 6461 7920 3d20 6466  listing_day = df
-00017580: 2e69 6e64 6578 5b30 5d0a 2020 2020 2020  .index[0].      
-00017590: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000175a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000175b0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-000175c0: 7374 7220 6973 206e 6f74 204e 6f6e 653a  str is not None:
-000175d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000175e0: 2020 2020 2020 2020 2020 2020 2066 6574               fet
-000175f0: 6368 5f73 7461 7274 2c20 6665 7463 685f  ch_start, fetch_
-00017600: 656e 645f 6420 3d20 7966 6374 2e4d 6170  end_d = yfct.Map
-00017610: 5065 7269 6f64 546f 4461 7465 7328 7365  PeriodToDates(se
-00017620: 6c66 2e65 7863 6861 6e67 652c 2079 6663  lf.exchange, yfc
-00017630: 642e 7065 7269 6f64 5374 7254 6f45 6e75  d.periodStrToEnu
-00017640: 6d5b 7073 7472 5d2c 2073 656c 662e 696e  m[pstr], self.in
-00017650: 7465 7276 616c 290a 2020 2020 2020 2020  terval).        
-00017660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017670: 746f 6c20 3d20 7966 6364 2e6c 6973 7469  tol = yfcd.listi
-00017680: 6e67 5f64 6174 655f 6368 6563 6b5f 746f  ng_date_check_to
-00017690: 6c73 5b73 656c 662e 696e 7465 7276 616c  ls[self.interval
-000176a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000176b0: 2020 2020 2020 2020 2020 6966 2066 6574            if fet
-000176c0: 6368 5f73 7461 7274 2069 7320 6e6f 7420  ch_start is not 
-000176d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000176e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176f0: 2020 6665 7463 685f 7374 6172 745f 6420    fetch_start_d 
-00017700: 3d20 6665 7463 685f 7374 6172 742e 6461  = fetch_start.da
-00017710: 7465 2829 2069 6620 6973 696e 7374 616e  te() if isinstan
-00017720: 6365 2866 6574 6368 5f73 7461 7274 2c20  ce(fetch_start, 
-00017730: 6461 7465 7469 6d65 2920 656c 7365 2066  datetime) else f
-00017740: 6574 6368 5f73 7461 7274 0a20 2020 2020  etch_start.     
-00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017760: 2020 2020 2020 2069 6620 2864 662e 696e         if (df.in
-00017770: 6465 785b 305d 2e64 6174 6528 2920 2d20  dex[0].date() - 
-00017780: 6665 7463 685f 7374 6172 745f 6429 203e  fetch_start_d) >
-00017790: 2074 6f6c 3a0a 2020 2020 2020 2020 2020   tol:.          
-000177a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177b0: 2020 2020 2020 2320 5961 686f 6f20 7265        # Yahoo re
-000177c0: 7475 726e 6564 2064 6174 6120 7374 6172  turned data star
-000177d0: 7469 6e67 2073 6967 6e69 6669 6361 6e74  ting significant
-000177e0: 6c79 2061 6674 6572 2072 6571 7565 7374  ly after request
-000177f0: 6564 2073 7461 7274 2064 6174 652c 2069  ed start date, i
-00017800: 6e64 6963 6174 6573 0a20 2020 2020 2020  ndicates.       
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 2020 2020 2020 2020 2023 2072 6571 7565           # reque
-00017830: 7374 2069 7320 6265 666f 7265 2073 746f  st is before sto
-00017840: 636b 206c 6973 7465 6420 6f6e 2065 7863  ck listed on exc
-00017850: 6861 6e67 650a 2020 2020 2020 2020 2020  hange.          
-00017860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017870: 2020 2020 2020 666f 756e 645f 6c69 7374        found_list
-00017880: 696e 675f 6461 7920 3d20 5472 7565 0a20  ing_day = True. 
-00017890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178c0: 2020 2020 2020 2020 2073 7461 7274 5f65           start_e
-000178d0: 7870 6563 7465 6420 3d20 7966 6374 2e44  xpected = yfct.D
-000178e0: 7453 7562 7472 6163 7450 6572 696f 6428  tSubtractPeriod(
-000178f0: 6665 7463 685f 6474 5f75 7463 2e64 6174  fetch_dt_utc.dat
-00017900: 6528 292b 7464 5f31 642c 2079 6663 642e  e()+td_1d, yfcd.
-00017910: 7065 7269 6f64 5374 7254 6f45 6e75 6d5b  periodStrToEnum[
-00017920: 7073 7472 5d29 0a20 2020 2020 2020 2020  pstr]).         
-00017930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017940: 2020 2023 2069 6620 7365 6c66 2e69 6e74     # if self.int
-00017950: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00017960: 7465 7276 616c 2e57 6565 6b3a 0a20 2020  terval.Week:.   
-00017970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017980: 2020 2020 2020 2020 2023 2020 2020 2073           #     s
-00017990: 7461 7274 5f65 7870 6563 7465 6420 2d3d  tart_expected -=
-000179a0: 2074 696d 6564 656c 7461 2864 6179 733d   timedelta(days=
-000179b0: 7374 6172 745f 6578 7065 6374 6564 2e77  start_expected.w
-000179c0: 6565 6b64 6179 2829 290a 2020 2020 2020  eekday()).      
-000179d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179e0: 2020 2020 2020 6966 2028 6466 2e69 6e64        if (df.ind
-000179f0: 6578 5b30 5d2e 6461 7465 2829 202d 2073  ex[0].date() - s
-00017a00: 7461 7274 5f65 7870 6563 7465 6429 203e  tart_expected) >
-00017a10: 2074 6f6c 3a0a 2020 2020 2020 2020 2020   tol:.          
-00017a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a30: 2020 2020 2020 666f 756e 645f 6c69 7374        found_list
-00017a40: 696e 675f 6461 7920 3d20 5472 7565 0a20  ing_day = True. 
-00017a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a60: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-00017a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a80: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-00017a90: 2d20 666f 756e 645f 6c69 7374 696e 675f  - found_listing_
-00017aa0: 6461 7920 3d20 7b7d 222e 666f 726d 6174  day = {}".format
-00017ab0: 2866 6f75 6e64 5f6c 6973 7469 6e67 5f64  (found_listing_d
-00017ac0: 6179 290a 2020 2020 2020 2020 2020 2020  ay).            
-00017ad0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
-00017ae0: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
-00017af0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-00017b00: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
-00017b10: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
-00017b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b30: 6966 2066 6f75 6e64 5f6c 6973 7469 6e67  if found_listing
-00017b40: 5f64 6179 3a0a 2020 2020 2020 2020 2020  _day:.          
-00017b50: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00017b60: 7374 696e 675f 6461 7920 3d20 6466 2e69  sting_day = df.i
-00017b70: 6e64 6578 5b30 5d2e 6461 7465 2829 0a20  ndex[0].date(). 
-00017b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b90: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
-00017ba0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-00017bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bc0: 206d 7367 203d 2022 5946 433a 2069 6e66   msg = "YFC: inf
-00017bd0: 6572 7265 6420 6c69 7374 696e 675f 6461  erred listing_da
-00017be0: 7465 203d 207b 7d22 2e66 6f72 6d61 7428  te = {}".format(
-00017bf0: 6c69 7374 696e 675f 6461 7929 0a20 2020  listing_day).   
-00017c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c10: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-00017c20: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-00017c30: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-00017c40: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-00017c50: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
-00017c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c70: 2079 6663 6d2e 5374 6f72 6543 6163 6865   yfcm.StoreCache
-00017c80: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
-00017c90: 722c 2022 6c69 7374 696e 675f 6461 7465  r, "listing_date
-00017ca0: 222c 206c 6973 7469 6e67 5f64 6179 290a  ", listing_day).
-00017cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017cc0: 2020 2020 2069 6620 286c 6973 7469 6e67       if (listing
-00017cd0: 5f64 6179 2069 7320 6e6f 7420 4e6f 6e65  _day is not None
-00017ce0: 2920 616e 6420 6669 7273 745f 6665 7463  ) and first_fetc
-00017cf0: 685f 6661 696c 6564 3a0a 2020 2020 2020  h_failed:.      
-00017d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d10: 2020 6966 2065 6e64 203c 3d20 6c69 7374    if end <= list
-00017d20: 696e 675f 6461 793a 0a20 2020 2020 2020  ing_day:.       
-00017d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d40: 2020 2020 2023 2041 6861 2120 5265 7175       # Aha! Requ
-00017d50: 6573 7465 6420 6461 7465 2072 616e 6765  ested date range
-00017d60: 2077 6173 2065 6e74 6972 656c 7920 6265   was entirely be
-00017d70: 666f 7265 206c 6973 7469 6e67 0a20 2020  fore listing.   
-00017d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d90: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-00017da0: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-00017db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017dc0: 2020 2020 2020 206d 7367 203d 2022 2d20         msg = "- 
-00017dd0: 7265 7175 6573 7465 6420 6461 7465 2072  requested date r
-00017de0: 616e 6765 2077 6173 2062 6566 6f72 6520  ange was before 
-00017df0: 6c69 7374 696e 6720 6461 7465 220a 2020  listing date".  
-00017e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e10: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00017e20: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-00017e30: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-00017e40: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-00017e50: 7365 2070 7269 6e74 286d 7367 290a 2020  se print(msg).  
-00017e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017e80: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00017e90: 2020 2020 2020 6966 2066 6f75 6e64 5f6c        if found_l
-00017ea0: 6973 7469 6e67 5f64 6179 2061 6e64 2073  isting_day and s
-00017eb0: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
-00017ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017ed0: 2020 2020 2020 2320 4170 706c 7920 746f        # Apply to
-00017ee0: 2066 6574 6368 2073 7461 7274 0a20 2020   fetch start.   
-00017ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f00: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-00017f10: 7461 7274 2c20 6461 7465 7469 6d65 293a  tart, datetime):
-00017f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017f30: 2020 2020 2020 2020 206c 6973 7469 6e67           listing
-00017f40: 5f64 6174 6520 3d20 6461 7465 7469 6d65  _date = datetime
-00017f50: 2e63 6f6d 6269 6e65 286c 6973 7469 6e67  .combine(listing
-00017f60: 5f64 6179 2c20 7469 6d65 2830 292c 2073  _day, time(0), s
-00017f70: 656c 662e 747a 290a 2020 2020 2020 2020  elf.tz).        
-00017f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f90: 7374 6172 7420 3d20 6d61 7828 7374 6172  start = max(star
-00017fa0: 742c 206c 6973 7469 6e67 5f64 6174 6529  t, listing_date)
-00017fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fe0: 2020 2073 7461 7274 203d 206d 6178 2873     start = max(s
-00017ff0: 7461 7274 2c20 6c69 7374 696e 675f 6461  tart, listing_da
-00018000: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-00018010: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00018020: 5f64 203d 2073 7461 7274 0a0a 2020 2020  _d = start..    
-00018030: 2020 2020 6966 2070 7374 7220 6973 204e      if pstr is N
-00018040: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00018050: 2069 6620 6466 2069 7320 4e6f 6e65 3a0a   if df is None:.
-00018060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018070: 7265 6365 6976 6564 5f69 6e74 6572 7661  received_interva
-00018080: 6c5f 7374 6172 7473 203d 204e 6f6e 650a  l_starts = None.
-00018090: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000180a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000180b0: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
-000180c0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-000180d0: 2020 2020 2020 2020 7265 6365 6976 6564          received
-000180e0: 5f69 6e74 6572 7661 6c5f 7374 6172 7473  _interval_starts
-000180f0: 203d 2064 662e 696e 6465 782e 6461 7465   = df.index.date
-00018100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018110: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00018120: 2020 2020 2020 2020 2020 2072 6563 6569             recei
-00018130: 7665 645f 696e 7465 7276 616c 5f73 7461  ved_interval_sta
-00018140: 7274 7320 3d20 6466 2e69 6e64 6578 2e74  rts = df.index.t
-00018150: 6f5f 7079 6461 7465 7469 6d65 2829 0a20  o_pydatetime(). 
-00018160: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018180: 696e 7465 7276 616c 735f 6d69 7373 696e  intervals_missin
-00018190: 675f 6466 203d 2079 6663 742e 4964 656e  g_df = yfct.Iden
-000181a0: 7469 6679 4d69 7373 696e 6749 6e74 6572  tifyMissingInter
-000181b0: 7661 6c73 2873 656c 662e 6578 6368 616e  vals(self.exchan
-000181c0: 6765 2c20 7374 6172 742c 2065 6e64 2c20  ge, start, end, 
-000181d0: 7365 6c66 2e69 6e74 6572 7661 6c2c 2072  self.interval, r
-000181e0: 6563 6569 7665 645f 696e 7465 7276 616c  eceived_interval
-000181f0: 5f73 7461 7274 732c 2069 676e 6f72 655f  _starts, ignore_
-00018200: 6272 6561 6b73 3d54 7275 6529 0a20 2020  breaks=True).   
-00018210: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00018220: 7966 6364 2e4e 6f49 6e74 6572 7661 6c73  yfcd.NoIntervals
-00018230: 496e 5261 6e67 6545 7863 6570 7469 6f6e  InRangeException
-00018240: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018250: 2020 696e 7465 7276 616c 735f 6d69 7373    intervals_miss
-00018260: 696e 675f 6466 203d 204e 6f6e 650a 2020  ing_df = None.  
-00018270: 2020 2020 2020 2020 2020 6966 2028 696e            if (in
-00018280: 7465 7276 616c 735f 6d69 7373 696e 675f  tervals_missing_
-00018290: 6466 2069 7320 6e6f 7420 4e6f 6e65 2920  df is not None) 
-000182a0: 616e 6420 286e 6f74 2069 6e74 6572 7661  and (not interva
-000182b0: 6c73 5f6d 6973 7369 6e67 5f64 662e 656d  ls_missing_df.em
-000182c0: 7074 7929 3a0a 2020 2020 2020 2020 2020  pty):.          
-000182d0: 2020 2020 2020 2320 4669 7273 742c 2069        # First, i
-000182e0: 676e 6f72 6520 616e 7920 6d69 7373 696e  gnore any missin
-000182f0: 6720 696e 7465 7276 616c 7320 746f 6461  g intervals toda
-00018300: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00018310: 2020 2320 466f 7220 6d69 7373 696e 6720    # For missing 
-00018320: 696e 7465 7276 616c 7320 6475 7269 6e67  intervals during
-00018330: 206c 6173 7420 3220 7765 656b 732c 2069   last 2 weeks, i
-00018340: 6620 6665 7720 696e 206e 756d 6265 722c  f few in number,
-00018350: 2074 6865 6e20 6669 6c6c 2077 6974 6820   then fill with 
-00018360: 4e61 4e73 0a20 2020 2020 2020 2020 2020  NaNs.           
-00018370: 2020 2020 2023 2046 6f72 206d 6973 7369       # For missi
-00018380: 6e67 2069 6e74 6572 7661 6c73 206f 6c64  ng intervals old
-00018390: 6572 2074 6861 6e20 3220 7765 656b 732c  er than 2 weeks,
-000183a0: 2066 696c 6c20 616c 6c20 7769 7468 204e   fill all with N
-000183b0: 614e 730a 0a20 2020 2020 2020 2020 2020  aNs..           
-000183c0: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
-000183d0: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-000183e0: 2020 2020 2020 206e 203d 2069 6e74 6572         n = inter
-000183f0: 7661 6c73 5f6d 6973 7369 6e67 5f64 662e  vals_missing_df.
-00018400: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-00018410: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018420: 6e20 3c3d 2033 3a0a 2020 2020 2020 2020  n <= 3:.        
-00018430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018440: 6d73 6720 3d20 6622 5946 2064 6174 6120  msg = f"YF data 
-00018450: 6d69 7373 696e 6720 7b6e 7d20 696e 7465  missing {n} inte
-00018460: 7276 616c 733a 207b 696e 7465 7276 616c  rvals: {interval
-00018470: 735f 6d69 7373 696e 675f 6466 5b27 6f70  s_missing_df['op
-00018480: 656e 275d 2e74 6f5f 6e75 6d70 7928 297d  en'].to_numpy()}
-00018490: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000184a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000184b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184c0: 2020 2020 6d73 6720 3d20 6622 5946 2064      msg = f"YF d
-000184d0: 6174 6120 6d69 7373 696e 6720 7b6e 7d20  ata missing {n} 
-000184e0: 696e 7465 7276 616c 7322 0a20 2020 2020  intervals".     
-000184f0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00018500: 6663 6c2e 5472 6163 6550 7269 6e74 2827  fcl.TracePrint('
-00018510: 2d20 2720 2b20 6d73 6729 2069 6620 7966  - ' + msg) if yf
-00018520: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00018530: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
-00018540: 2827 2d20 2720 2b20 6d73 6729 0a0a 2020  ('- ' + msg)..  
-00018550: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00018560: 746f 6666 5f64 203d 2064 6174 652e 746f  toff_d = date.to
-00018570: 6461 7928 2920 2d20 7469 6d65 6465 6c74  day() - timedelt
-00018580: 6128 6461 7973 3d31 3429 0a20 2020 2020  a(days=14).     
-00018590: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000185a0: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-000185b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000185c0: 2066 5f72 6563 656e 7420 3d20 696e 7465   f_recent = inte
-000185d0: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
-000185e0: 5b22 6f70 656e 225d 2e74 6f5f 6e75 6d70  ["open"].to_nump
-000185f0: 7928 2920 3e20 6375 746f 6666 5f64 0a20  y() > cutoff_d. 
-00018600: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00018610: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018620: 2020 2020 2020 2020 2066 5f72 6563 656e           f_recen
-00018630: 7420 3d20 696e 7465 7276 616c 735f 6d69  t = intervals_mi
-00018640: 7373 696e 675f 6466 5b22 6f70 656e 225d  ssing_df["open"]
-00018650: 2e64 742e 6461 7465 203e 2063 7574 6f66  .dt.date > cutof
-00018660: 665f 640a 2020 2020 2020 2020 2020 2020  f_d.            
-00018670: 2020 2020 696e 7465 7276 616c 735f 6d69      intervals_mi
-00018680: 7373 696e 675f 6466 5f72 6563 656e 7420  ssing_df_recent 
-00018690: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
-000186a0: 696e 675f 6466 5b66 5f72 6563 656e 745d  ing_df[f_recent]
-000186b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000186c0: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
-000186d0: 6e67 5f64 665f 6f6c 6420 3d20 696e 7465  ng_df_old = inte
-000186e0: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
-000186f0: 5b7e 665f 7265 6365 6e74 5d0a 2020 2020  [~f_recent].    
-00018700: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
-00018710: 696e 675f 696e 7465 7276 616c 735f 746f  ing_intervals_to
-00018720: 5f61 6464 203d 204e 6f6e 650a 2020 2020  _add = None.    
-00018730: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00018740: 6f74 2069 6e74 6572 7661 6c73 5f6d 6973  ot intervals_mis
-00018750: 7369 6e67 5f64 665f 6f6c 642e 656d 7074  sing_df_old.empt
-00018760: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00018770: 2020 2020 2020 206d 6973 7369 6e67 5f69         missing_i
-00018780: 6e74 6572 7661 6c73 5f74 6f5f 6164 6420  ntervals_to_add 
-00018790: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
-000187a0: 696e 675f 6466 5f6f 6c64 5b22 6f70 656e  ing_df_old["open
-000187b0: 225d 2e74 6f5f 6e75 6d70 7928 290a 0a20  "].to_numpy().. 
-000187c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000187d0: 6620 6e6f 7420 696e 7465 7276 616c 735f  f not intervals_
-000187e0: 6d69 7373 696e 675f 6466 5f72 6563 656e  missing_df_recen
-000187f0: 742e 656d 7074 793a 0a20 2020 2020 2020  t.empty:.       
-00018800: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00018810: 6620 7665 7279 2066 6577 2069 6e74 6572  f very few inter
-00018820: 7661 6c73 2061 6e64 206e 6f74 2074 6f64  vals and not tod
-00018830: 6179 2028 736f 2059 6168 6f6f 2073 686f  ay (so Yahoo sho
-00018840: 756c 6420 6861 7665 2064 6174 6129 2c0a  uld have data),.
-00018850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018860: 2020 2020 2320 7468 656e 2061 7373 756d      # then assum
-00018870: 6520 6e6f 2074 7261 6469 6e67 206f 6363  e no trading occ
-00018880: 7572 7265 6420 616e 6420 696e 7365 7274  urred and insert
-00018890: 204e 614e 2072 6f77 732e 0a20 2020 2020   NaN rows..     
-000188a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000188b0: 204e 6f72 6d61 6c6c 7920 5961 686f 6f20   Normally Yahoo 
-000188c0: 6861 7320 616c 7265 6164 7920 6669 6c6c  has already fill
-000188d0: 6564 2077 6974 6820 4e61 4e73 2062 7574  ed with NaNs but
-000188e0: 2073 6f6d 6574 696d 6573 2074 6865 7920   sometimes they 
-000188f0: 666f 7267 6574 2f61 7265 206c 6174 650a  forget/are late.
-00018900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018910: 2020 2020 6e6d 203d 2069 6e74 6572 7661      nm = interva
-00018920: 6c73 5f6d 6973 7369 6e67 5f64 665f 7265  ls_missing_df_re
-00018930: 6365 6e74 2e73 6861 7065 5b30 5d0a 2020  cent.shape[0].  
-00018940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018950: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
-00018960: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-00018970: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-00018980: 7368 6f6c 6420 3d20 310a 2020 2020 2020  shold = 1.      
-00018990: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000189a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000189b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000189c0: 656c 662e 6974 6420 3c3d 2074 696d 6564  elf.itd <= timed
-000189d0: 656c 7461 286d 696e 7574 6573 3d32 293a  elta(minutes=2):
-000189e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000189f0: 2020 2020 2020 2020 2020 2020 2074 6872               thr
-00018a00: 6573 686f 6c64 203d 2031 300a 2020 2020  eshold = 10.    
-00018a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a20: 2020 2020 656c 6966 2073 656c 662e 6974      elif self.it
-00018a30: 6420 3c3d 2074 696d 6564 656c 7461 286d  d <= timedelta(m
-00018a40: 696e 7574 6573 3d35 293a 0a20 2020 2020  inutes=5):.     
-00018a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a60: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
-00018a70: 203d 2033 0a20 2020 2020 2020 2020 2020   = 3.           
-00018a80: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00018a90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00018aa0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00018ab0: 6872 6573 686f 6c64 203d 2032 0a20 2020  hreshold = 2.   
-00018ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ad0: 2069 6620 6e6d 203c 3d20 7468 7265 7368   if nm <= thresh
-00018ae0: 6f6c 643a 0a20 2020 2020 2020 2020 2020  old:.           
-00018af0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018b00: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
-00018b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b20: 2020 2020 2020 206d 7367 203d 2022 2d20         msg = "- 
-00018b30: 666f 756e 6420 6d69 7373 696e 6720 696e  found missing in
-00018b40: 7465 7276 616c 732c 2069 6e73 6572 7469  tervals, inserti
-00018b50: 6e67 206e 616e 733a 220a 2020 2020 2020  ng nans:".      
-00018b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b70: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-00018b80: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
-00018b90: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00018ba0: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
-00018bb0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
-00018bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bd0: 2020 7072 696e 7428 696e 7465 7276 616c    print(interval
-00018be0: 735f 6d69 7373 696e 675f 6466 5f72 6563  s_missing_df_rec
-00018bf0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-00018c00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018c10: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
-00018c20: 735f 746f 5f61 6464 2069 7320 4e6f 6e65  s_to_add is None
-00018c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018c40: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-00018c50: 7373 696e 675f 696e 7465 7276 616c 735f  ssing_intervals_
-00018c60: 746f 5f61 6464 203d 2069 6e74 6572 7661  to_add = interva
-00018c70: 6c73 5f6d 6973 7369 6e67 5f64 665f 7265  ls_missing_df_re
-00018c80: 6365 6e74 5b22 6f70 656e 225d 2e74 6f5f  cent["open"].to_
-00018c90: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-00018ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00018cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cd0: 2020 6d69 7373 696e 675f 696e 7465 7276    missing_interv
-00018ce0: 616c 735f 746f 5f61 6464 203d 206e 702e  als_to_add = np.
-00018cf0: 6170 7065 6e64 286d 6973 7369 6e67 5f69  append(missing_i
-00018d00: 6e74 6572 7661 6c73 5f74 6f5f 6164 642c  ntervals_to_add,
-00018d10: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
-00018d20: 6e67 5f64 665f 7265 6365 6e74 5b22 6f70  ng_df_recent["op
-00018d30: 656e 225d 2e74 6f5f 6e75 6d70 7928 2929  en"].to_numpy())
-00018d40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00018d50: 2020 6966 206d 6973 7369 6e67 5f69 6e74    if missing_int
-00018d60: 6572 7661 6c73 5f74 6f5f 6164 6420 6973  ervals_to_add is
-00018d70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00018d80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00018d90: 203d 206d 6973 7369 6e67 5f69 6e74 6572   = missing_inter
-00018da0: 7661 6c73 5f74 6f5f 6164 642e 7368 6170  vals_to_add.shap
-00018db0: 655b 305d 0a20 2020 2020 2020 2020 2020  e[0].           
-00018dc0: 2020 2020 2020 2020 2069 6620 6e20 3c3d           if n <=
-00018dd0: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
-00018de0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00018df0: 3d20 6622 696e 7365 7274 696e 6773 204e  = f"insertings N
-00018e00: 614e 7320 666f 7220 7b6e 7d20 6d69 7373  aNs for {n} miss
-00018e10: 696e 6720 696e 7465 7276 616c 733a 207b  ing intervals: {
-00018e20: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
-00018e30: 735f 746f 5f61 6464 7d22 0a20 2020 2020  s_to_add}".     
-00018e40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00018e50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018e60: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00018e70: 203d 2066 2269 6e73 6572 7469 6e67 7320   = f"insertings 
-00018e80: 4e61 4e73 2066 6f72 207b 6e7d 206d 6973  NaNs for {n} mis
-00018e90: 7369 6e67 2069 6e74 6572 7661 6c73 220a  sing intervals".
-00018ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018eb0: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-00018ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018ed0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00018ee0: 7261 6365 5072 696e 7428 272d 2027 202b  racePrint('- ' +
-00018ef0: 206d 7367 2920 6966 2079 6663 6c2e 4973   msg) if yfcl.Is
-00018f00: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-00018f10: 2065 6c73 6520 7072 696e 7428 272d 2027   else print('- '
-00018f20: 202b 206d 7367 290a 2020 2020 2020 2020   + msg).        
-00018f30: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00018f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018f50: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00018f60: 616e 6167 6572 2e4c 6f67 4576 656e 7428  anager.LogEvent(
-00018f70: 2269 6e66 6f22 2c20 2250 7269 6365 4d61  "info", "PriceMa
-00018f80: 6e61 6765 7222 2c20 6d73 6729 0a0a 2020  nager", msg)..  
-00018f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018fa0: 2020 6e6d 203d 206d 6973 7369 6e67 5f69    nm = missing_i
-00018fb0: 6e74 6572 7661 6c73 5f74 6f5f 6164 642e  ntervals_to_add.
-00018fc0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-00018fd0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00018fe0: 6d69 7373 696e 6720 3d20 7064 2e44 6174  missing = pd.Dat
-00018ff0: 6146 7261 6d65 2864 6174 613d 7b6b 3a20  aFrame(data={k: 
-00019000: 5b6e 702e 6e61 6e5d 2a6e 6d20 666f 7220  [np.nan]*nm for 
-00019010: 6b20 696e 2079 6663 642e 7966 5f64 6174  k in yfcd.yf_dat
-00019020: 615f 636f 6c73 7d2c 2069 6e64 6578 3d6d  a_cols}, index=m
-00019030: 6973 7369 6e67 5f69 6e74 6572 7661 6c73  issing_intervals
-00019040: 5f74 6f5f 6164 6429 0a20 2020 2020 2020  _to_add).       
-00019050: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00019060: 6d69 7373 696e 675b 2756 6f6c 756d 6527  missing['Volume'
-00019070: 5d20 3d20 3020 2320 4e65 6564 7320 746f  ] = 0 # Needs to
-00019080: 2062 6520 696e 7420 7479 7065 0a20 2020   be int type.   
-00019090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190a0: 2069 6620 2252 6570 6169 7265 643f 2220   if "Repaired?" 
-000190b0: 696e 2064 662e 636f 6c75 6d6e 733a 0a20  in df.columns:. 
-000190c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190d0: 2020 2020 2020 2064 665f 6d69 7373 696e         df_missin
-000190e0: 675b 2252 6570 6169 7265 643f 225d 203d  g["Repaired?"] =
-000190f0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-00019100: 2020 2020 2020 2020 2020 2064 665f 6d69             df_mi
-00019110: 7373 696e 672e 696e 6465 7820 3d20 7064  ssing.index = pd
-00019120: 2e74 6f5f 6461 7465 7469 6d65 2864 665f  .to_datetime(df_
-00019130: 6d69 7373 696e 672e 696e 6465 7829 0a20  missing.index). 
-00019140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019150: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-00019160: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
-00019170: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00019180: 6d69 7373 696e 672e 696e 6465 7820 3d20  missing.index = 
-00019190: 6466 5f6d 6973 7369 6e67 2e69 6e64 6578  df_missing.index
-000191a0: 2e74 7a5f 6c6f 6361 6c69 7a65 2874 7a5f  .tz_localize(tz_
-000191b0: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
-000191c0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000191d0: 7220 6320 696e 205b 2256 6f6c 756d 6522  r c in ["Volume"
-000191e0: 2c20 2244 6976 6964 656e 6473 222c 2022  , "Dividends", "
-000191f0: 5374 6f63 6b20 5370 6c69 7473 225d 3a0a  Stock Splits"]:.
-00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019210: 2020 2020 2020 2020 6466 5f6d 6973 7369          df_missi
-00019220: 6e67 5b63 5d20 3d20 300a 2020 2020 2020  ng[c] = 0.      
-00019230: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00019240: 2064 6620 6973 204e 6f6e 653a 0a20 2020   df is None:.   
-00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019260: 2020 2020 2064 6620 3d20 6466 5f6d 6973       df = df_mis
-00019270: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
-00019280: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00019290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192a0: 2020 2020 2020 2064 6620 3d20 7064 2e63         df = pd.c
-000192b0: 6f6e 6361 7428 5b64 662c 2064 665f 6d69  oncat([df, df_mi
-000192c0: 7373 696e 675d 2c20 736f 7274 3d54 7275  ssing], sort=Tru
-000192d0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000192e0: 2020 2020 2020 2020 2020 2064 662e 696e             df.in
-000192f0: 6465 7820 3d20 7064 2e74 6f5f 6461 7465  dex = pd.to_date
-00019300: 7469 6d65 2864 662e 696e 6465 782c 2075  time(df.index, u
-00019310: 7463 3d54 7275 6529 2e74 7a5f 636f 6e76  tc=True).tz_conv
-00019320: 6572 7428 747a 5f65 7863 6861 6e67 6529  ert(tz_exchange)
-00019330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019340: 2020 2020 2020 2020 2064 6620 3d20 6466           df = df
-00019350: 2e73 6f72 745f 696e 6465 7828 290a 0a20  .sort_index().. 
-00019360: 2020 2020 2020 2023 2049 6d70 726f 7665         # Improve
-00019370: 2074 6f6c 6572 616e 6365 2074 6f20 6361   tolerance to ca
-00019380: 6c65 6e64 6172 206d 6973 7369 6e67 2061  lendar missing a
-00019390: 2072 6563 656e 7420 6e65 7720 686f 6c69   recent new holi
-000193a0: 6461 793a 0a20 2020 2020 2020 2069 6620  day:.        if 
-000193b0: 2864 6620 6973 204e 6f6e 6529 206f 7220  (df is None) or 
-000193c0: 6466 2e65 6d70 7479 3a0a 2020 2020 2020  df.empty:.      
-000193d0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000193e0: 650a 0a20 2020 2020 2020 206e 203d 2064  e..        n = d
-000193f0: 662e 7368 6170 655b 305d 0a0a 2020 2020  f.shape[0]..    
-00019400: 2020 2020 6665 7463 685f 6474 203d 2066      fetch_dt = f
-00019410: 6574 6368 5f64 745f 7574 632e 7265 706c  etch_dt_utc.repl
-00019420: 6163 6528 747a 696e 666f 3d5a 6f6e 6549  ace(tzinfo=ZoneI
-00019430: 6e66 6f28 2255 5443 2229 290a 0a20 2020  nfo("UTC"))..   
-00019440: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00019450: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00019460: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
-00019470: 2020 2020 2020 2020 2020 2320 5570 6461            # Upda
-00019480: 7465 3a20 6d6f 7665 2063 6865 636b 696e  te: move checkin
-00019490: 6720 666f 7220 6e65 7720 6469 7669 6465  g for new divide
-000194a0: 6e64 7320 746f 2068 6572 652c 2062 6566  nds to here, bef
-000194b0: 6f72 6520 6469 7363 6172 6469 6e67 206f  ore discarding o
-000194c0: 7574 2d6f 662d 7261 6e67 6520 6461 7461  ut-of-range data
-000194d0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-000194e0: 6469 7673 203d 2064 665b 6466 5b22 4469  divs = df[df["Di
-000194f0: 7669 6465 6e64 7322 5d20 213d 2030 5d5b  vidends"] != 0][
-00019500: 5b22 4469 7669 6465 6e64 7322 5d5d 2e63  ["Dividends"]].c
-00019510: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-00019520: 2020 665f 6475 7073 203d 2064 665f 6469    f_dups = df_di
-00019530: 7673 2e69 6e64 6578 2e64 7570 6c69 6361  vs.index.duplica
-00019540: 7465 6428 290a 2020 2020 2020 2020 2020  ted().          
-00019550: 2020 6966 2066 5f64 7570 732e 616e 7928    if f_dups.any(
-00019560: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00019570: 2020 2070 7269 6e74 2864 665f 6469 7673     print(df_divs
-00019580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019590: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-000195a0: 6e28 2244 7570 6c69 6361 7465 7320 6465  n("Duplicates de
-000195b0: 7465 6374 6564 2069 6e20 6466 5f64 6976  tected in df_div
-000195c0: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
-000195d0: 6466 5f64 6976 735b 2746 6574 6368 4461  df_divs['FetchDa
-000195e0: 7465 275d 203d 2066 6574 6368 5f64 745f  te'] = fetch_dt_
-000195f0: 7574 630a 2020 2020 2020 2020 2020 2020  utc.            
-00019600: 6966 206e 6f74 2064 665f 6469 7673 2e65  if not df_divs.e
-00019610: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-00019620: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
-00019630: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-00019640: 2020 2020 2020 2020 7072 696e 7428 222d          print("-
-00019650: 2064 665f 6469 7673 3a22 290a 2020 2020   df_divs:").    
-00019660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019670: 7072 696e 7428 6466 5f64 6976 7329 0a20  print(df_divs). 
-00019680: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019690: 6163 6865 645f 6e65 775f 6469 7673 203d  ached_new_divs =
-000196a0: 2079 6663 6d2e 5265 6164 4361 6368 6544   yfcm.ReadCacheD
-000196b0: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
-000196c0: 2c20 226e 6577 5f64 6976 7322 290a 2020  , "new_divs").  
-000196d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000196e0: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
-000196f0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00019700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019710: 2020 6466 5f64 6976 7320 3d20 6466 5f64    df_divs = df_d
-00019720: 6976 735b 7e64 665f 6469 7673 2e69 6e64  ivs[~df_divs.ind
-00019730: 6578 2e69 7369 6e28 6361 6368 6564 5f6e  ex.isin(cached_n
-00019740: 6577 5f64 6976 732e 696e 6465 7829 5d0a  ew_divs.index)].
-00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019760: 2020 2020 6966 206e 6f74 2064 665f 6469      if not df_di
-00019770: 7673 2e65 6d70 7479 3a0a 2020 2020 2020  vs.empty:.      
-00019780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019790: 2020 6966 2079 6663 6d2e 5265 6164 4361    if yfcm.ReadCa
-000197a0: 6368 654d 6574 6164 6174 6128 7365 6c66  cheMetadata(self
-000197b0: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
-000197c0: 7673 222c 2022 6c6f 636b 6564 2229 2069  vs", "locked") i
-000197d0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000197e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197f0: 2020 2020 2020 2020 2320 6c6f 636b 6564          # locked
-00019800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019810: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00019820: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00019830: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00019840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019850: 2020 2020 2020 2020 2020 2020 6361 6368              cach
-00019860: 6564 5f6e 6577 5f64 6976 7320 3d20 7064  ed_new_divs = pd
-00019870: 2e63 6f6e 6361 7428 5b63 6163 6865 645f  .concat([cached_
-00019880: 6e65 775f 6469 7673 2c20 6466 5f64 6976  new_divs, df_div
-00019890: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
-000198a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198b0: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
-000198c0: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
-000198d0: 2c20 226e 6577 5f64 6976 7322 2c20 6361  , "new_divs", ca
-000198e0: 6368 6564 5f6e 6577 5f64 6976 7329 0a20  ched_new_divs). 
-000198f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00019900: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019910: 2020 2020 2020 2020 2079 6663 6d2e 5374           yfcm.St
-00019920: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
-00019930: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
-00019940: 6469 7673 222c 2064 665f 6469 7673 290a  divs", df_divs).
-00019950: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-00019960: 6520 616e 7920 6f75 742d 6f66 2d72 616e  e any out-of-ran
-00019970: 6765 2064 6174 613a 0a20 2020 2020 2020  ge data:.       
-00019980: 2069 6620 286e 203e 2030 2920 616e 6420   if (n > 0) and 
-00019990: 2870 7374 7220 6973 204e 6f6e 6529 3a0a  (pstr is None):.
-000199a0: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-000199b0: 5445 3a20 5946 2068 6173 2061 2062 7567  TE: YF has a bug
-000199c0: 2d66 6978 2070 656e 6469 6e67 206d 6572  -fix pending mer
-000199d0: 6765 3a20 6874 7470 733a 2f2f 6769 7468  ge: https://gith
-000199e0: 7562 2e63 6f6d 2f72 616e 6172 6f75 7373  ub.com/ranarouss
-000199f0: 692f 7966 696e 616e 6365 2f70 756c 6c2f  i/yfinance/pull/
-00019a00: 3130 3132 0a20 2020 2020 2020 2020 2020  1012.           
-00019a10: 2069 6620 656e 6420 6973 206e 6f74 204e   if end is not N
-00019a20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00019a30: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00019a40: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
-00019a50: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
-00019a60: 6466 5b64 662e 696e 6465 782e 6461 7465  df[df.index.date
-00019a70: 203c 2065 6e64 5f64 5d0a 2020 2020 2020   < end_d].      
-00019a80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019aa0: 2020 2020 6466 203d 2064 665b 6466 2e69      df = df[df.i
-00019ab0: 6e64 6578 203c 2065 6e64 5f64 745d 0a20  ndex < end_dt]. 
-00019ac0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00019ad0: 203d 2064 662e 7368 6170 655b 305d 0a20   = df.shape[0]. 
-00019ae0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
-00019af0: 2020 2020 2020 2020 2023 2041 6e64 2061           # And a
-00019b00: 6761 696e 2066 6f72 2070 7265 2d73 7461  gain for pre-sta
-00019b10: 7274 2064 6174 613a 0a20 2020 2020 2020  rt data:.       
-00019b20: 2020 2020 2069 6620 7374 6172 7420 6973       if start is
-00019b30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00019b40: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00019b50: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-00019b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b70: 2064 6620 3d20 6466 5b64 662e 696e 6465   df = df[df.inde
-00019b80: 782e 6461 7465 203e 3d20 7374 6172 745f  x.date >= start_
-00019b90: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-00019ba0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00019bb0: 2020 2020 2020 2020 2020 2020 2064 6620               df 
-00019bc0: 3d20 6466 5b64 662e 696e 6465 7820 3e3d  = df[df.index >=
-00019bd0: 2073 7461 7274 5f64 745d 0a20 2020 2020   start_dt].     
-00019be0: 2020 2020 2020 2020 2020 206e 203d 2064             n = d
-00019bf0: 662e 7368 6170 655b 305d 0a0a 2020 2020  f.shape[0]..    
-00019c00: 2020 2020 2320 5665 7269 6679 2074 6861      # Verify tha
-00019c10: 7420 616c 6c20 6461 7465 7469 6d65 7320  t all datetimes 
-00019c20: 6d61 7463 6820 7570 2077 6974 6820 6163  match up with ac
-00019c30: 7475 616c 2069 6e74 6572 7661 6c73 3a0a  tual intervals:.
-00019c40: 2020 2020 2020 2020 6966 206e 203d 3d20          if n == 
-00019c50: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-00019c60: 6169 7365 2079 6663 642e 4e6f 5072 6963  aise yfcd.NoPric
-00019c70: 6544 6174 6149 6e52 616e 6765 4578 6365  eDataInRangeExce
-00019c80: 7074 696f 6e28 7365 6c66 2e74 6963 6b65  ption(self.ticke
-00019c90: 722c 2073 656c 662e 6973 7472 2c20 7374  r, self.istr, st
-00019ca0: 6172 742c 2065 6e64 290a 2020 2020 2020  art, end).      
-00019cb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00019cc0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-00019cd0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
-00019ce0: 2020 2020 2020 6620 3d20 6466 2e69 6e64        f = df.ind
-00019cf0: 6578 2e74 696d 6520 213d 2074 696d 6528  ex.time != time(
-00019d00: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00019d10: 2020 2069 6620 662e 616e 7928 293a 0a20     if f.any():. 
-00019d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d30: 2020 2070 7269 6e74 2864 665b 665d 290a     print(df[f]).
-00019d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d50: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-00019d60: 696f 6e28 2249 6e74 6572 6461 7920 6461  ion("Interday da
-00019d70: 7461 2063 6f6e 7461 696e 7320 7469 6d65  ta contains time
-00019d80: 7320 696e 2069 6e64 6578 2229 0a20 2020  s in index").   
-00019d90: 2020 2020 2020 2020 2020 2020 2079 6649               yfI
-00019da0: 6e74 6572 7661 6c53 7461 7274 7320 3d20  ntervalStarts = 
-00019db0: 6466 2e69 6e64 6578 2e64 6174 650a 2020  df.index.date.  
-00019dc0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019de0: 7966 496e 7465 7276 616c 5374 6172 7473  yfIntervalStarts
-00019df0: 203d 2064 662e 696e 6465 782e 746f 5f70   = df.index.to_p
-00019e00: 7964 6174 6574 696d 6528 290a 2020 2020  ydatetime().    
-00019e10: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00019e20: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
-00019e30: 7472 6164 6179 2061 6e64 2028 7365 6c66  traday and (self
-00019e40: 2e65 7863 6861 6e67 6520 696e 2079 6663  .exchange in yfc
-00019e50: 642e 6578 6368 616e 6765 7357 6974 6842  d.exchangesWithB
-00019e60: 7265 616b 7329 3a0a 2020 2020 2020 2020  reaks):.        
-00019e70: 2020 2020 2020 2020 2320 4469 7363 6172          # Discar
-00019e80: 6420 616e 7920 696e 7465 7276 616c 7320  d any intervals 
-00019e90: 6675 6c6c 7920 7769 7468 696e 2061 2062  fully within a b
-00019ea0: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-00019eb0: 2020 2020 2066 5f69 6e5f 6272 6561 6b20       f_in_break 
-00019ec0: 3d20 7966 6374 2e54 696d 6573 7461 6d70  = yfct.Timestamp
-00019ed0: 496e 4272 6561 6b5f 6261 7463 6828 7365  InBreak_batch(se
-00019ee0: 6c66 2e65 7863 6861 6e67 652c 2079 6649  lf.exchange, yfI
-00019ef0: 6e74 6572 7661 6c53 7461 7274 732c 2073  ntervalStarts, s
-00019f00: 656c 662e 696e 7465 7276 616c 290a 2020  elf.interval).  
-00019f10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00019f20: 2066 5f69 6e5f 6272 6561 6b2e 616e 7928   f_in_break.any(
-00019f30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00019f40: 2020 2020 2020 2023 2044 6973 6361 7264         # Discard
-00019f50: 2074 6865 7365 0a20 2020 2020 2020 2020   these.         
-00019f60: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00019f70: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-00019f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f90: 206d 7367 203d 2022 2d20 6472 6f70 7069   msg = "- droppi
-00019fa0: 6e67 2072 6f77 7320 696e 2062 7265 616b  ng rows in break
-00019fb0: 2074 696d 6573 220a 2020 2020 2020 2020   times".        
-00019fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fd0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00019fe0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00019ff0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-0001a000: 656c 7365 2070 7269 6e74 286d 7367 290a  else print(msg).
-0001a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a020: 2020 2020 7966 496e 7465 7276 616c 5374      yfIntervalSt
-0001a030: 6172 7473 203d 2079 6649 6e74 6572 7661  arts = yfInterva
-0001a040: 6c53 7461 7274 735b 7e66 5f69 6e5f 6272  lStarts[~f_in_br
-0001a050: 6561 6b5d 0a20 2020 2020 2020 2020 2020  eak].           
-0001a060: 2020 2020 2020 2020 2064 6620 3d20 6466           df = df
-0001a070: 5b7e 665f 696e 5f62 7265 616b 5d0a 2020  [~f_in_break].  
-0001a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a090: 2020 6e20 3d20 6466 2e73 6861 7065 5b30    n = df.shape[0
-0001a0a0: 5d0a 2020 2020 2020 2020 2020 2020 230a  ].            #.
-0001a0b0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-0001a0c0: 7276 616c 7320 3d20 7966 6374 2e47 6574  rvals = yfct.Get
-0001a0d0: 5469 6d65 7374 616d 7043 7572 7265 6e74  TimestampCurrent
-0001a0e0: 496e 7465 7276 616c 5f62 6174 6368 2873  Interval_batch(s
-0001a0f0: 656c 662e 6578 6368 616e 6765 2c20 7966  elf.exchange, yf
-0001a100: 496e 7465 7276 616c 5374 6172 7473 2c20  IntervalStarts, 
-0001a110: 7365 6c66 2e69 6e74 6572 7661 6c2c 2064  self.interval, d
-0001a120: 6973 6361 7264 5469 6d65 733d 7365 6c66  iscardTimes=self
-0001a130: 2e69 6e74 6572 6461 792c 2069 676e 6f72  .interday, ignor
-0001a140: 655f 6272 6561 6b73 3d54 7275 6529 0a0a  e_breaks=True)..
-0001a150: 2020 2020 2020 2020 2020 2020 665f 6e61              f_na
-0001a160: 203d 2069 6e74 6572 7661 6c73 5b22 696e   = intervals["in
-0001a170: 7465 7276 616c 5f6f 7065 6e22 5d2e 6973  terval_open"].is
-0001a180: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
-0001a190: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0001a1a0: 6572 6966 795f 696e 7465 7276 616c 7320  erify_intervals 
-0001a1b0: 616e 6420 665f 6e61 2e61 6e79 2829 3a0a  and f_na.any():.
-0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1d0: 7473 203d 2069 6e74 6572 7661 6c73 5b22  ts = intervals["
-0001a1e0: 696e 7465 7276 616c 5f6f 7065 6e22 5d0a  interval_open"].
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a200: 6966 206c 656e 2874 7329 2021 3d20 6c65  if len(ts) != le
-0001a210: 6e28 7365 7428 7473 2929 3a0a 2020 2020  n(set(ts)):.    
-0001a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a230: 6475 7073 203d 2074 735b 7473 2e64 7570  dups = ts[ts.dup
-0001a240: 6c69 6361 7465 6428 6b65 6570 3d46 616c  licated(keep=Fal
-0001a250: 7365 295d 0a20 2020 2020 2020 2020 2020  se)].           
-0001a260: 2020 2020 2020 2020 2023 2044 726f 7020           # Drop 
-0001a270: 726f 7773 2074 6861 7420 6d61 7020 746f  rows that map to
-0001a280: 2064 7570 6c69 6361 7465 2069 6e74 6572   duplicate inter
-0001a290: 7661 6c73 2069 6620 6e6f 2074 7261 6469  vals if no tradi
-0001a2a0: 6e67 206f 6363 7572 7265 642e 0a20 2020  ng occurred..   
-0001a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2c0: 2066 5f6e 6f5f 7472 6164 6573 203d 2028   f_no_trades = (
-0001a2d0: 6466 5b22 566f 6c75 6d65 225d 203d 3d20  df["Volume"] == 
-0001a2e0: 3029 2026 2028 2864 665b 224c 6f77 225d  0) & ((df["Low"]
-0001a2f0: 203d 3d20 6466 5b22 4869 6768 225d 2920   == df["High"]) 
-0001a300: 7c20 6466 5b22 436c 6f73 6522 5d2e 6973  | df["Close"].is
-0001a310: 6e61 2829 290a 2020 2020 2020 2020 2020  na()).          
-0001a320: 2020 2020 2020 2020 2020 6472 6f70 5f64            drop_d
-0001a330: 7473 203d 204e 6f6e 650a 2020 2020 2020  ts = None.      
-0001a340: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001a350: 7220 6920 696e 2064 7570 733a 0a20 2020  r i in dups:.   
+00016df0: 6d73 6720 3d20 222d 2059 4620 7265 7475  msg = "- YF retu
+00016e00: 726e 6564 2074 6162 6c65 3a22 0a20 2020  rned table:".   
+00016e10: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00016e20: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00016e30: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00016e40: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00016e50: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
+00016e60: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00016e70: 6e74 2864 665b 5b63 2066 6f72 2063 2069  nt(df[[c for c i
+00016e80: 6e20 5b22 4f70 656e 222c 2022 4c6f 7722  n ["Open", "Low"
+00016e90: 2c20 2248 6967 6822 2c20 2243 6c6f 7365  , "High", "Close
+00016ea0: 222c 2022 4469 7669 6465 6e64 7322 2c20  ", "Dividends", 
+00016eb0: 2256 6f6c 756d 6522 5d20 6966 2063 2069  "Volume"] if c i
+00016ec0: 6e20 6466 2e63 6f6c 756d 6e73 5d5d 290a  n df.columns]]).
+00016ed0: 0a20 2020 2020 2020 2023 2044 6574 6563  .        # Detec
+00016ee0: 7420 6c69 7374 696e 6720 6461 790a 2020  t listing day.  
+00016ef0: 2020 2020 2020 6c69 7374 696e 675f 6461        listing_da
+00016f00: 7920 3d20 7966 636d 2e52 6561 6443 6163  y = yfcm.ReadCac
+00016f10: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
+00016f20: 6b65 722c 2022 6c69 7374 696e 675f 6461  ker, "listing_da
+00016f30: 7465 2229 0a20 2020 2020 2020 2069 6620  te").        if 
+00016f40: 6c69 7374 696e 675f 6461 7920 6973 204e  listing_day is N
+00016f50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00016f60: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
+00016f70: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
+00016f80: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
+00016f90: 2020 2020 2020 2020 2020 666f 756e 645f            found_
+00016fa0: 6c69 7374 696e 675f 6461 7920 3d20 4661  listing_day = Fa
+00016fb0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00016fc0: 2020 2020 6c69 7374 696e 675f 6461 7920      listing_day 
+00016fd0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00016fe0: 2020 2020 2020 2069 6620 6466 2069 7320         if df is 
+00016ff0: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
+00017000: 2064 662e 656d 7074 793a 0a20 2020 2020   df.empty:.     
+00017010: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00017020: 6f6c 203d 2079 6663 642e 6c69 7374 696e  ol = yfcd.listin
+00017030: 675f 6461 7465 5f63 6865 636b 5f74 6f6c  g_date_check_tol
+00017040: 735b 7365 6c66 2e69 6e74 6572 7661 6c5d  s[self.interval]
+00017050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017060: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
+00017070: 5f64 203d 2066 6574 6368 5f73 7461 7274  _d = fetch_start
+00017080: 2e64 6174 6528 2920 6966 2069 7369 6e73  .date() if isins
+00017090: 7461 6e63 6528 6665 7463 685f 7374 6172  tance(fetch_star
+000170a0: 742c 2064 6174 6574 696d 6529 2065 6c73  t, datetime) els
+000170b0: 6520 6665 7463 685f 7374 6172 740a 2020  e fetch_start.  
+000170c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170d0: 2020 6966 2028 6466 2e69 6e64 6578 5b30    if (df.index[0
+000170e0: 5d2e 6461 7465 2829 202d 2066 6574 6368  ].date() - fetch
+000170f0: 5f73 7461 7274 5f64 2920 3e20 746f 6c3a  _start_d) > tol:
+00017100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017110: 2020 2020 2020 2020 2023 2059 6168 6f6f           # Yahoo
+00017120: 2072 6574 7572 6e65 6420 6461 7461 2073   returned data s
+00017130: 7461 7274 696e 6720 7369 676e 6966 6963  tarting signific
+00017140: 616e 746c 7920 6166 7465 7220 7265 7175  antly after requ
+00017150: 6573 7465 6420 7374 6172 7420 6461 7465  ested start date
+00017160: 2c20 696e 6469 6361 7465 730a 2020 2020  , indicates.    
+00017170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017180: 2020 2020 2320 7265 7175 6573 7420 6973      # request is
+00017190: 2062 6566 6f72 6520 7374 6f63 6b20 6c69   before stock li
+000171a0: 7374 6564 206f 6e20 6578 6368 616e 6765  sted on exchange
+000171b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000171c0: 2020 2020 2020 2020 2066 6f75 6e64 5f6c           found_l
+000171d0: 6973 7469 6e67 5f64 6179 203d 2054 7275  isting_day = Tru
+000171e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000171f0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+00017200: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00017210: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00017220: 3d20 222d 2066 6f75 6e64 5f6c 6973 7469  = "- found_listi
+00017230: 6e67 5f64 6179 203d 207b 7d22 2e66 6f72  ng_day = {}".for
+00017240: 6d61 7428 666f 756e 645f 6c69 7374 696e  mat(found_listin
+00017250: 675f 6461 7929 0a20 2020 2020 2020 2020  g_day).         
+00017260: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00017270: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
+00017280: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
+00017290: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
+000172a0: 6c73 6520 7072 696e 7428 6d73 6729 0a20  lse print(msg). 
+000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172c0: 2020 2069 6620 666f 756e 645f 6c69 7374     if found_list
+000172d0: 696e 675f 6461 793a 0a20 2020 2020 2020  ing_day:.       
+000172e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172f0: 206c 6973 7469 6e67 5f64 6179 203d 2064   listing_day = d
+00017300: 662e 696e 6465 785b 305d 2e64 6174 6528  f.index[0].date(
+00017310: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017320: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00017330: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00017340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017350: 2020 2020 6d73 6720 3d20 2259 4643 3a20      msg = "YFC: 
+00017360: 696e 6665 7272 6564 206c 6973 7469 6e67  inferred listing
+00017370: 5f64 6174 6520 3d20 7b7d 222e 666f 726d  _date = {}".form
+00017380: 6174 286c 6973 7469 6e67 5f64 6179 290a  at(listing_day).
+00017390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173a0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+000173b0: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
+000173c0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+000173d0: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
+000173e0: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
+000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017400: 2020 2020 7966 636d 2e53 746f 7265 4361      yfcm.StoreCa
+00017410: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
+00017420: 636b 6572 2c20 226c 6973 7469 6e67 5f64  cker, "listing_d
+00017430: 6174 6522 2c20 6c69 7374 696e 675f 6461  ate", listing_da
+00017440: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00017450: 2020 2020 2020 2020 6966 2028 6c69 7374          if (list
+00017460: 696e 675f 6461 7920 6973 206e 6f74 204e  ing_day is not N
+00017470: 6f6e 6529 2061 6e64 2066 6972 7374 5f66  one) and first_f
+00017480: 6574 6368 5f66 6169 6c65 643a 0a20 2020  etch_failed:.   
+00017490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174a0: 2020 2020 2069 6620 656e 6420 3c3d 206c       if end <= l
+000174b0: 6973 7469 6e67 5f64 6179 3a0a 2020 2020  isting_day:.    
+000174c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174d0: 2020 2020 2020 2020 2320 4168 6121 2052          # Aha! R
+000174e0: 6571 7565 7374 6564 2064 6174 6520 7261  equested date ra
+000174f0: 6e67 6520 7761 7320 656e 7469 7265 6c79  nge was entirely
+00017500: 2062 6566 6f72 6520 6c69 7374 696e 670a   before listing.
+00017510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017520: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00017530: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
+00017540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017550: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00017560: 222d 2072 6571 7565 7374 6564 2064 6174  "- requested dat
+00017570: 6520 7261 6e67 6520 7761 7320 6265 666f  e range was befo
+00017580: 7265 206c 6973 7469 6e67 2064 6174 6522  re listing date"
+00017590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000175a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175b0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+000175c0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+000175d0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+000175e0: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
+000175f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017600: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00017610: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+00017620: 2020 2020 2020 2020 2069 6620 666f 756e           if foun
+00017630: 645f 6c69 7374 696e 675f 6461 7920 616e  d_listing_day an
+00017640: 6420 7374 6172 7420 6973 206e 6f74 204e  d start is not N
+00017650: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00017660: 2020 2020 2020 2020 2023 2041 7070 6c79           # Apply
+00017670: 2074 6f20 6665 7463 6820 7374 6172 740a   to fetch start.
+00017680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017690: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000176a0: 6528 7374 6172 742c 2064 6174 6574 696d  e(start, datetim
+000176b0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+000176c0: 2020 2020 2020 2020 2020 2020 6c69 7374              list
+000176d0: 696e 675f 6461 7465 203d 2064 6174 6574  ing_date = datet
+000176e0: 696d 652e 636f 6d62 696e 6528 6c69 7374  ime.combine(list
+000176f0: 696e 675f 6461 792c 2074 696d 6528 3029  ing_day, time(0)
+00017700: 2c20 7365 6c66 2e74 7a29 0a20 2020 2020  , self.tz).     
+00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017720: 2020 2073 7461 7274 203d 206d 6178 2873     start = max(s
+00017730: 7461 7274 2c20 6c69 7374 696e 675f 6461  tart, listing_da
+00017740: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
+00017750: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017770: 2020 2020 2020 7374 6172 7420 3d20 6d61        start = ma
+00017780: 7828 7374 6172 742c 206c 6973 7469 6e67  x(start, listing
+00017790: 5f64 6179 290a 2020 2020 2020 2020 2020  _day).          
+000177a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000177b0: 6172 745f 6420 3d20 7374 6172 740a 0a20  art_d = start.. 
+000177c0: 2020 2020 2020 2069 6620 6466 2069 7320         if df is 
+000177d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000177e0: 2020 7265 6365 6976 6564 5f69 6e74 6572    received_inter
+000177f0: 7661 6c5f 7374 6172 7473 203d 204e 6f6e  val_starts = Non
+00017800: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00017810: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00017820: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
+00017830: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00017840: 6365 6976 6564 5f69 6e74 6572 7661 6c5f  ceived_interval_
+00017850: 7374 6172 7473 203d 2064 662e 696e 6465  starts = df.inde
+00017860: 782e 6461 7465 0a20 2020 2020 2020 2020  x.date.         
+00017870: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00017880: 2020 2020 2020 2020 2072 6563 6569 7665           receive
+00017890: 645f 696e 7465 7276 616c 5f73 7461 7274  d_interval_start
+000178a0: 7320 3d20 6466 2e69 6e64 6578 2e74 6f5f  s = df.index.to_
+000178b0: 7079 6461 7465 7469 6d65 2829 0a20 2020  pydatetime().   
+000178c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000178d0: 2020 2020 2020 696e 7465 7276 616c 735f        intervals_
+000178e0: 6d69 7373 696e 675f 6466 203d 2079 6663  missing_df = yfc
+000178f0: 742e 4964 656e 7469 6679 4d69 7373 696e  t.IdentifyMissin
+00017900: 6749 6e74 6572 7661 6c73 2873 656c 662e  gIntervals(self.
+00017910: 6578 6368 616e 6765 2c20 7374 6172 742c  exchange, start,
+00017920: 2065 6e64 2c20 7365 6c66 2e69 6e74 6572   end, self.inter
+00017930: 7661 6c2c 2072 6563 6569 7665 645f 696e  val, received_in
+00017940: 7465 7276 616c 5f73 7461 7274 732c 2069  terval_starts, i
+00017950: 676e 6f72 655f 6272 6561 6b73 3d54 7275  gnore_breaks=Tru
+00017960: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+00017970: 7420 7966 6364 2e4e 6f49 6e74 6572 7661  t yfcd.NoInterva
+00017980: 6c73 496e 5261 6e67 6545 7863 6570 7469  lsInRangeExcepti
+00017990: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+000179a0: 696e 7465 7276 616c 735f 6d69 7373 696e  intervals_missin
+000179b0: 675f 6466 203d 204e 6f6e 650a 2020 2020  g_df = None.    
+000179c0: 2020 2020 6966 2028 696e 7465 7276 616c      if (interval
+000179d0: 735f 6d69 7373 696e 675f 6466 2069 7320  s_missing_df is 
+000179e0: 6e6f 7420 4e6f 6e65 2920 616e 6420 286e  not None) and (n
+000179f0: 6f74 2069 6e74 6572 7661 6c73 5f6d 6973  ot intervals_mis
+00017a00: 7369 6e67 5f64 662e 656d 7074 7929 3a0a  sing_df.empty):.
+00017a10: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+00017a20: 7273 742c 2069 676e 6f72 6520 616e 7920  rst, ignore any 
+00017a30: 6d69 7373 696e 6720 696e 7465 7276 616c  missing interval
+00017a40: 7320 746f 6461 790a 2020 2020 2020 2020  s today.        
+00017a50: 2020 2020 2320 466f 7220 6d69 7373 696e      # For missin
+00017a60: 6720 696e 7465 7276 616c 7320 6475 7269  g intervals duri
+00017a70: 6e67 206c 6173 7420 3220 7765 656b 732c  ng last 2 weeks,
+00017a80: 2069 6620 6665 7720 696e 206e 756d 6265   if few in numbe
+00017a90: 722c 2074 6865 6e20 6669 6c6c 2077 6974  r, then fill wit
+00017aa0: 6820 4e61 4e73 0a20 2020 2020 2020 2020  h NaNs.         
+00017ab0: 2020 2023 2046 6f72 206d 6973 7369 6e67     # For missing
+00017ac0: 2069 6e74 6572 7661 6c73 206f 6c64 6572   intervals older
+00017ad0: 2074 6861 6e20 3220 7765 656b 732c 2066   than 2 weeks, f
+00017ae0: 696c 6c20 616c 6c20 7769 7468 204e 614e  ill all with NaN
+00017af0: 730a 0a20 2020 2020 2020 2020 2020 2069  s..            i
+00017b00: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
+00017b10: 2020 2020 2020 2020 2020 2020 206e 203d               n =
+00017b20: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
+00017b30: 6e67 5f64 662e 7368 6170 655b 305d 0a20  ng_df.shape[0]. 
+00017b40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017b50: 6620 6e20 3c3d 2033 3a0a 2020 2020 2020  f n <= 3:.      
+00017b60: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00017b70: 6720 3d20 6622 5946 2064 6174 6120 6d69  g = f"YF data mi
+00017b80: 7373 696e 6720 7b6e 7d20 696e 7465 7276  ssing {n} interv
+00017b90: 616c 733a 207b 696e 7465 7276 616c 735f  als: {intervals_
+00017ba0: 6d69 7373 696e 675f 6466 5b27 6f70 656e  missing_df['open
+00017bb0: 275d 2e74 6f5f 6e75 6d70 7928 297d 220a  '].to_numpy()}".
+00017bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017bd0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017be0: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00017bf0: 6622 5946 2064 6174 6120 6d69 7373 696e  f"YF data missin
+00017c00: 6720 7b6e 7d20 696e 7465 7276 616c 7322  g {n} intervals"
+00017c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017c20: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+00017c30: 2827 2d20 2720 2b20 6d73 6729 2069 6620  ('- ' + msg) if 
+00017c40: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00017c50: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00017c60: 6e74 2827 2d20 2720 2b20 6d73 6729 0a0a  nt('- ' + msg)..
+00017c70: 2020 2020 2020 2020 2020 2020 6375 746f              cuto
+00017c80: 6666 5f64 203d 2064 6174 652e 746f 6461  ff_d = date.toda
+00017c90: 7928 2920 2d20 7469 6d65 6465 6c74 6128  y() - timedelta(
+00017ca0: 6461 7973 3d31 3429 0a20 2020 2020 2020  days=14).       
+00017cb0: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00017cc0: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+00017cd0: 2020 2020 2020 2066 5f72 6563 656e 7420         f_recent 
+00017ce0: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
+00017cf0: 696e 675f 6466 5b22 6f70 656e 225d 2e74  ing_df["open"].t
+00017d00: 6f5f 6e75 6d70 7928 2920 3e20 6375 746f  o_numpy() > cuto
+00017d10: 6666 5f64 0a20 2020 2020 2020 2020 2020  ff_d.           
+00017d20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017d30: 2020 2020 2020 2066 5f72 6563 656e 7420         f_recent 
+00017d40: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
+00017d50: 696e 675f 6466 5b22 6f70 656e 225d 2e64  ing_df["open"].d
+00017d60: 742e 6461 7465 203e 2063 7574 6f66 665f  t.date > cutoff_
+00017d70: 640a 2020 2020 2020 2020 2020 2020 696e  d.            in
+00017d80: 7465 7276 616c 735f 6d69 7373 696e 675f  tervals_missing_
+00017d90: 6466 5f72 6563 656e 7420 3d20 696e 7465  df_recent = inte
+00017da0: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
+00017db0: 5b66 5f72 6563 656e 745d 0a20 2020 2020  [f_recent].     
+00017dc0: 2020 2020 2020 2069 6e74 6572 7661 6c73         intervals
+00017dd0: 5f6d 6973 7369 6e67 5f64 665f 6f6c 6420  _missing_df_old 
+00017de0: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
+00017df0: 696e 675f 6466 5b7e 665f 7265 6365 6e74  ing_df[~f_recent
+00017e00: 5d0a 2020 2020 2020 2020 2020 2020 6d69  ].            mi
+00017e10: 7373 696e 675f 696e 7465 7276 616c 735f  ssing_intervals_
+00017e20: 746f 5f61 6464 203d 204e 6f6e 650a 2020  to_add = None.  
+00017e30: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00017e40: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
+00017e50: 6e67 5f64 665f 6f6c 642e 656d 7074 793a  ng_df_old.empty:
+00017e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017e70: 206d 6973 7369 6e67 5f69 6e74 6572 7661   missing_interva
+00017e80: 6c73 5f74 6f5f 6164 6420 3d20 696e 7465  ls_to_add = inte
+00017e90: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
+00017ea0: 5f6f 6c64 5b22 6f70 656e 225d 2e74 6f5f  _old["open"].to_
+00017eb0: 6e75 6d70 7928 290a 0a20 2020 2020 2020  numpy()..       
+00017ec0: 2020 2020 2069 6620 6e6f 7420 696e 7465       if not inte
+00017ed0: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
+00017ee0: 5f72 6563 656e 742e 656d 7074 793a 0a20  _recent.empty:. 
+00017ef0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017f00: 2049 6620 7665 7279 2066 6577 2069 6e74   If very few int
+00017f10: 6572 7661 6c73 2061 6e64 206e 6f74 2074  ervals and not t
+00017f20: 6f64 6179 2028 736f 2059 6168 6f6f 2073  oday (so Yahoo s
+00017f30: 686f 756c 6420 6861 7665 2064 6174 6129  hould have data)
+00017f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017f50: 2020 2320 7468 656e 2061 7373 756d 6520    # then assume 
+00017f60: 6e6f 2074 7261 6469 6e67 206f 6363 7572  no trading occur
+00017f70: 7265 6420 616e 6420 696e 7365 7274 204e  red and insert N
+00017f80: 614e 2072 6f77 732e 0a20 2020 2020 2020  aN rows..       
+00017f90: 2020 2020 2020 2020 2023 204e 6f72 6d61           # Norma
+00017fa0: 6c6c 7920 5961 686f 6f20 6861 7320 616c  lly Yahoo has al
+00017fb0: 7265 6164 7920 6669 6c6c 6564 2077 6974  ready filled wit
+00017fc0: 6820 4e61 4e73 2062 7574 2073 6f6d 6574  h NaNs but somet
+00017fd0: 696d 6573 2074 6865 7920 666f 7267 6574  imes they forget
+00017fe0: 2f61 7265 206c 6174 650a 2020 2020 2020  /are late.      
+00017ff0: 2020 2020 2020 2020 2020 6e6d 203d 2069            nm = i
+00018000: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
+00018010: 5f64 665f 7265 6365 6e74 2e73 6861 7065  _df_recent.shape
+00018020: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00018030: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00018040: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00018050: 2020 2020 2020 2020 2020 7468 7265 7368            thresh
+00018060: 6f6c 6420 3d20 310a 2020 2020 2020 2020  old = 1.        
+00018070: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00018080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018090: 2020 6966 2073 656c 662e 6974 6420 3c3d    if self.itd <=
+000180a0: 2074 696d 6564 656c 7461 286d 696e 7574   timedelta(minut
+000180b0: 6573 3d32 293a 0a20 2020 2020 2020 2020  es=2):.         
+000180c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000180d0: 6872 6573 686f 6c64 203d 2031 300a 2020  hreshold = 10.  
+000180e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180f0: 2020 656c 6966 2073 656c 662e 6974 6420    elif self.itd 
+00018100: 3c3d 2074 696d 6564 656c 7461 286d 696e  <= timedelta(min
+00018110: 7574 6573 3d35 293a 0a20 2020 2020 2020  utes=5):.       
+00018120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018130: 2074 6872 6573 686f 6c64 203d 2033 0a20   threshold = 3. 
+00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018150: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018170: 2074 6872 6573 686f 6c64 203d 2032 0a20   threshold = 2. 
+00018180: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018190: 6620 6e6d 203c 3d20 7468 7265 7368 6f6c  f nm <= threshol
+000181a0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+000181b0: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
+000181c0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+000181d0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000181e0: 203d 2022 2d20 666f 756e 6420 6d69 7373   = "- found miss
+000181f0: 696e 6720 696e 7465 7276 616c 732c 2069  ing intervals, i
+00018200: 6e73 6572 7469 6e67 206e 616e 733a 220a  nserting nans:".
+00018210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018220: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00018230: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+00018240: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00018250: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00018260: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+00018270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018280: 7072 696e 7428 696e 7465 7276 616c 735f  print(intervals_
+00018290: 6d69 7373 696e 675f 6466 5f72 6563 656e  missing_df_recen
+000182a0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+000182b0: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
+000182c0: 675f 696e 7465 7276 616c 735f 746f 5f61  g_intervals_to_a
+000182d0: 6464 2069 7320 4e6f 6e65 3a0a 2020 2020  dd is None:.    
+000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182f0: 2020 2020 6d69 7373 696e 675f 696e 7465      missing_inte
+00018300: 7276 616c 735f 746f 5f61 6464 203d 2069  rvals_to_add = i
+00018310: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
+00018320: 5f64 665f 7265 6365 6e74 5b22 6f70 656e  _df_recent["open
+00018330: 225d 2e74 6f5f 6e75 6d70 7928 290a 2020  "].to_numpy().  
+00018340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018350: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018370: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
+00018380: 735f 746f 5f61 6464 203d 206e 702e 6170  s_to_add = np.ap
+00018390: 7065 6e64 286d 6973 7369 6e67 5f69 6e74  pend(missing_int
+000183a0: 6572 7661 6c73 5f74 6f5f 6164 642c 2069  ervals_to_add, i
+000183b0: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
+000183c0: 5f64 665f 7265 6365 6e74 5b22 6f70 656e  _df_recent["open
+000183d0: 225d 2e74 6f5f 6e75 6d70 7928 2929 0a0a  "].to_numpy())..
+000183e0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+000183f0: 6973 7369 6e67 5f69 6e74 6572 7661 6c73  issing_intervals
+00018400: 5f74 6f5f 6164 6420 6973 206e 6f74 204e  _to_add is not N
+00018410: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00018420: 2020 2020 206e 203d 206d 6973 7369 6e67       n = missing
+00018430: 5f69 6e74 6572 7661 6c73 5f74 6f5f 6164  _intervals_to_ad
+00018440: 642e 7368 6170 655b 305d 0a20 2020 2020  d.shape[0].     
+00018450: 2020 2020 2020 2020 2020 2069 6620 6e20             if n 
+00018460: 3c3d 2033 3a0a 2020 2020 2020 2020 2020  <= 3:.          
+00018470: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+00018480: 6622 696e 7365 7274 696e 6773 204e 614e  f"insertings NaN
+00018490: 7320 666f 7220 7b6e 7d20 6d69 7373 696e  s for {n} missin
+000184a0: 6720 696e 7465 7276 616c 733a 207b 6d69  g intervals: {mi
+000184b0: 7373 696e 675f 696e 7465 7276 616c 735f  ssing_intervals_
+000184c0: 746f 5f61 6464 7d22 0a20 2020 2020 2020  to_add}".       
+000184d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000184e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184f0: 2020 206d 7367 203d 2066 2269 6e73 6572     msg = f"inser
+00018500: 7469 6e67 7320 4e61 4e73 2066 6f72 207b  tings NaNs for {
+00018510: 6e7d 206d 6973 7369 6e67 2069 6e74 6572  n} missing inter
+00018520: 7661 6c73 220a 2020 2020 2020 2020 2020  vals".          
+00018530: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+00018540: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00018550: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00018560: 6365 5072 696e 7428 272d 2027 202b 206d  cePrint('- ' + m
+00018570: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
+00018580: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
+00018590: 6c73 6520 7072 696e 7428 272d 2027 202b  lse print('- ' +
+000185a0: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
+000185b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185d0: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
+000185e0: 4576 656e 7428 2269 6e66 6f22 2c20 2250  Event("info", "P
+000185f0: 7269 6365 4d61 6e61 6765 7222 2c20 6d73  riceManager", ms
+00018600: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
+00018610: 2020 2020 6e6d 203d 206d 6973 7369 6e67      nm = missing
+00018620: 5f69 6e74 6572 7661 6c73 5f74 6f5f 6164  _intervals_to_ad
+00018630: 642e 7368 6170 655b 305d 0a20 2020 2020  d.shape[0].     
+00018640: 2020 2020 2020 2020 2020 2064 665f 6d69             df_mi
+00018650: 7373 696e 6720 3d20 7064 2e44 6174 6146  ssing = pd.DataF
+00018660: 7261 6d65 2864 6174 613d 7b6b 3a20 5b6e  rame(data={k: [n
+00018670: 702e 6e61 6e5d 2a6e 6d20 666f 7220 6b20  p.nan]*nm for k 
+00018680: 696e 2079 6663 642e 7966 5f64 6174 615f  in yfcd.yf_data_
+00018690: 636f 6c73 7d2c 2069 6e64 6578 3d6d 6973  cols}, index=mis
+000186a0: 7369 6e67 5f69 6e74 6572 7661 6c73 5f74  sing_intervals_t
+000186b0: 6f5f 6164 6429 0a20 2020 2020 2020 2020  o_add).         
+000186c0: 2020 2020 2020 2064 665f 6d69 7373 696e         df_missin
+000186d0: 675b 2756 6f6c 756d 6527 5d20 3d20 3020  g['Volume'] = 0 
+000186e0: 2320 4e65 6564 7320 746f 2062 6520 696e  # Needs to be in
+000186f0: 7420 7479 7065 0a20 2020 2020 2020 2020  t type.         
+00018700: 2020 2020 2020 2069 6620 2252 6570 6169         if "Repai
+00018710: 7265 643f 2220 696e 2064 662e 636f 6c75  red?" in df.colu
+00018720: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
+00018730: 2020 2020 2020 2020 2064 665f 6d69 7373           df_miss
+00018740: 696e 675b 2252 6570 6169 7265 643f 225d  ing["Repaired?"]
+00018750: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00018760: 2020 2020 2020 2020 2064 665f 6d69 7373           df_miss
+00018770: 696e 672e 696e 6465 7820 3d20 7064 2e74  ing.index = pd.t
+00018780: 6f5f 6461 7465 7469 6d65 2864 665f 6d69  o_datetime(df_mi
+00018790: 7373 696e 672e 696e 6465 7829 0a20 2020  ssing.index).   
+000187a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000187b0: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
+000187c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187d0: 2020 2064 665f 6d69 7373 696e 672e 696e     df_missing.in
+000187e0: 6465 7820 3d20 6466 5f6d 6973 7369 6e67  dex = df_missing
+000187f0: 2e69 6e64 6578 2e74 7a5f 6c6f 6361 6c69  .index.tz_locali
+00018800: 7a65 2874 7a5f 6578 6368 616e 6765 290a  ze(tz_exchange).
+00018810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018820: 666f 7220 6320 696e 205b 2256 6f6c 756d  for c in ["Volum
+00018830: 6522 2c20 2244 6976 6964 656e 6473 222c  e", "Dividends",
+00018840: 2022 5374 6f63 6b20 5370 6c69 7473 222c   "Stock Splits",
+00018850: 2022 4361 7069 7461 6c20 4761 696e 7322   "Capital Gains"
+00018860: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00018870: 2020 2020 2020 2064 665f 6d69 7373 696e         df_missin
+00018880: 675b 635d 203d 2030 0a20 2020 2020 2020  g[c] = 0.       
+00018890: 2020 2020 2020 2020 2069 6620 6466 2069           if df i
+000188a0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000188b0: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+000188c0: 2064 665f 6d69 7373 696e 670a 2020 2020   df_missing.    
+000188d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000188e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000188f0: 2020 2020 2020 6466 203d 2070 642e 636f        df = pd.co
+00018900: 6e63 6174 285b 6466 2c20 6466 5f6d 6973  ncat([df, df_mis
+00018910: 7369 6e67 5b64 662e 636f 6c75 6d6e 735d  sing[df.columns]
+00018920: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00018930: 2020 2020 2020 2064 662e 696e 6465 7820         df.index 
+00018940: 3d20 7064 2e74 6f5f 6461 7465 7469 6d65  = pd.to_datetime
+00018950: 2864 662e 696e 6465 782c 2075 7463 3d54  (df.index, utc=T
+00018960: 7275 6529 2e74 7a5f 636f 6e76 6572 7428  rue).tz_convert(
+00018970: 747a 5f65 7863 6861 6e67 6529 0a20 2020  tz_exchange).   
+00018980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018990: 2064 6620 3d20 6466 2e73 6f72 745f 696e   df = df.sort_in
+000189a0: 6465 7828 290a 0a20 2020 2020 2020 2023  dex()..        #
+000189b0: 2049 6d70 726f 7665 2074 6f6c 6572 616e   Improve toleran
+000189c0: 6365 2074 6f20 6361 6c65 6e64 6172 206d  ce to calendar m
+000189d0: 6973 7369 6e67 2061 2072 6563 656e 7420  issing a recent 
+000189e0: 6e65 7720 686f 6c69 6461 793a 0a20 2020  new holiday:.   
+000189f0: 2020 2020 2069 6620 2864 6620 6973 204e       if (df is N
+00018a00: 6f6e 6529 206f 7220 6466 2e65 6d70 7479  one) or df.empty
+00018a10: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00018a20: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+00018a30: 2020 206e 203d 2064 662e 7368 6170 655b     n = df.shape[
+00018a40: 305d 0a0a 2020 2020 2020 2020 6665 7463  0]..        fetc
+00018a50: 685f 6474 203d 2066 6574 6368 5f64 745f  h_dt = fetch_dt_
+00018a60: 7574 632e 7265 706c 6163 6528 747a 696e  utc.replace(tzin
+00018a70: 666f 3d5a 6f6e 6549 6e66 6f28 2255 5443  fo=ZoneInfo("UTC
+00018a80: 2229 290a 0a20 2020 2020 2020 2069 6620  "))..        if 
+00018a90: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+00018aa0: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+00018ab0: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
+00018ac0: 2020 2320 5570 6461 7465 3a20 6d6f 7665    # Update: move
+00018ad0: 2063 6865 636b 696e 6720 666f 7220 6e65   checking for ne
+00018ae0: 7720 6469 7669 6465 6e64 7320 746f 2068  w dividends to h
+00018af0: 6572 652c 2062 6566 6f72 6520 6469 7363  ere, before disc
+00018b00: 6172 6469 6e67 206f 7574 2d6f 662d 7261  arding out-of-ra
+00018b10: 6e67 6520 6461 7461 0a20 2020 2020 2020  nge data.       
+00018b20: 2020 2020 2064 665f 6469 7673 203d 2064       df_divs = d
+00018b30: 665b 6466 5b22 4469 7669 6465 6e64 7322  f[df["Dividends"
+00018b40: 5d20 213d 2030 5d5b 5b22 4469 7669 6465  ] != 0][["Divide
+00018b50: 6e64 7322 5d5d 2e63 6f70 7928 290a 2020  nds"]].copy().  
+00018b60: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00018b70: 2064 665f 6469 7673 2e65 6d70 7479 3a0a   df_divs.empty:.
+00018b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b90: 6466 5f64 6976 735b 2746 6574 6368 4461  df_divs['FetchDa
+00018ba0: 7465 275d 203d 2066 6574 6368 5f64 745f  te'] = fetch_dt_
+00018bb0: 7574 630a 2020 2020 2020 2020 2020 2020  utc.            
+00018bc0: 2020 2020 6466 5f64 6976 735b 2744 6573      df_divs['Des
+00018bd0: 706c 6974 7465 643f 275d 203d 2046 616c  plitted?'] = Fal
+00018be0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00018bf0: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+00018c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018c10: 2020 2020 2070 7269 6e74 2822 2d20 6466       print("- df
+00018c20: 5f64 6976 733a 2229 0a20 2020 2020 2020  _divs:").       
+00018c30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00018c40: 6e74 2864 665f 6469 7673 290a 2020 2020  nt(df_divs).    
+00018c50: 2020 2020 2020 2020 2020 2020 6361 6368              cach
+00018c60: 6564 5f6e 6577 5f64 6976 7320 3d20 7966  ed_new_divs = yf
+00018c70: 636d 2e52 6561 6443 6163 6865 4461 7475  cm.ReadCacheDatu
+00018c80: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
+00018c90: 6e65 775f 6469 7673 2229 0a20 2020 2020  new_divs").     
+00018ca0: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
+00018cb0: 6368 6564 5f6e 6577 5f64 6976 7320 6973  ched_new_divs is
+00018cc0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00018cd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018ce0: 6620 2744 6573 706c 6974 7465 643f 2720  f 'Desplitted?' 
+00018cf0: 6e6f 7420 696e 2063 6163 6865 645f 6e65  not in cached_ne
+00018d00: 775f 6469 7673 2e63 6f6c 756d 6e73 3a0a  w_divs.columns:.
+00018d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d20: 2020 2020 2020 2020 6361 6368 6564 5f6e          cached_n
+00018d30: 6577 5f64 6976 735b 2744 6573 706c 6974  ew_divs['Desplit
+00018d40: 7465 643f 275d 203d 2046 616c 7365 0a20  ted?'] = False. 
+00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d60: 2020 2064 665f 6469 7673 203d 2064 665f     df_divs = df_
+00018d70: 6469 7673 5b7e 6466 5f64 6976 732e 696e  divs[~df_divs.in
+00018d80: 6465 782e 6973 696e 2863 6163 6865 645f  dex.isin(cached_
+00018d90: 6e65 775f 6469 7673 2e69 6e64 6578 295d  new_divs.index)]
+00018da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018db0: 2020 2020 2069 6620 6e6f 7420 6466 5f64       if not df_d
+00018dc0: 6976 732e 656d 7074 793a 0a20 2020 2020  ivs.empty:.     
+00018dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018de0: 2020 2064 6976 735f 7072 6574 7479 203d     divs_pretty =
+00018df0: 2064 665f 6469 7673 5b27 4469 7669 6465   df_divs['Divide
+00018e00: 6e64 7327 5d2e 636f 7079 2829 0a20 2020  nds'].copy().   
+00018e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e20: 2020 2020 2064 6976 735f 7072 6574 7479       divs_pretty
+00018e30: 2e69 6e64 6578 203d 2064 6976 735f 7072  .index = divs_pr
+00018e40: 6574 7479 2e69 6e64 6578 2e64 6174 650a  etty.index.date.
+00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e60: 2020 2020 2020 2020 7365 6c66 2e6d 616e          self.man
+00018e70: 6167 6572 2e4c 6f67 4576 656e 7428 2269  ager.LogEvent("i
+00018e80: 6e66 6f22 2c20 2244 6976 6964 656e 644d  nfo", "DividendM
+00018e90: 616e 6167 6572 222c 2066 2264 6574 6563  anager", f"detec
+00018ea0: 7465 6420 7b64 6976 735f 7072 6574 7479  ted {divs_pretty
+00018eb0: 2e73 6861 7065 5b30 5d7d 206e 6577 2064  .shape[0]} new d
+00018ec0: 6976 6964 656e 6473 3a20 7b64 6976 735f  ividends: {divs_
+00018ed0: 7072 6574 7479 7d20 2862 6566 6f72 6520  pretty} (before 
+00018ee0: 7265 7665 7273 696e 6720 6164 6a75 7374  reversing adjust
+00018ef0: 2922 290a 2020 2020 2020 2020 2020 2020  )").            
+00018f00: 2020 2020 2020 2020 2020 2020 6966 2079              if y
+00018f10: 6663 6d2e 5265 6164 4361 6368 654d 6574  fcm.ReadCacheMet
+00018f20: 6164 6174 6128 7365 6c66 2e74 6963 6b65  adata(self.ticke
+00018f30: 722c 2022 6e65 775f 6469 7673 222c 2022  r, "new_divs", "
+00018f40: 6c6f 636b 6564 2229 2069 7320 6e6f 7420  locked") is not 
+00018f50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00018f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f70: 2020 2320 6c6f 636b 6564 0a20 2020 2020    # locked.     
+00018f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f90: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00018fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018fb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018fd0: 2020 2020 2020 6361 6368 6564 5f6e 6577        cached_new
+00018fe0: 5f64 6976 7320 3d20 7064 2e63 6f6e 6361  _divs = pd.conca
+00018ff0: 7428 5b63 6163 6865 645f 6e65 775f 6469  t([cached_new_di
+00019000: 7673 2c20 6466 5f64 6976 735d 290a 2020  vs, df_divs]).  
+00019010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019020: 2020 2020 2020 2020 2020 7966 636d 2e53            yfcm.S
+00019030: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
+00019040: 656c 662e 7469 636b 6572 2c20 226e 6577  elf.ticker, "new
+00019050: 5f64 6976 7322 2c20 6361 6368 6564 5f6e  _divs", cached_n
+00019060: 6577 5f64 6976 7329 0a20 2020 2020 2020  ew_divs).       
+00019070: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00019080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019090: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
+000190a0: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
+000190b0: 6b65 722c 2022 6e65 775f 6469 7673 222c  ker, "new_divs",
+000190c0: 2064 665f 6469 7673 290a 0a20 2020 2020   df_divs)..     
+000190d0: 2020 2023 2052 656d 6f76 6520 616e 7920     # Remove any 
+000190e0: 6f75 742d 6f66 2d72 616e 6765 2064 6174  out-of-range dat
+000190f0: 613a 0a20 2020 2020 2020 2069 6620 286e  a:.        if (n
+00019100: 203e 2030 293a 0a20 2020 2020 2020 2020   > 0):.         
+00019110: 2020 2023 204e 4f54 453a 2059 4620 6861     # NOTE: YF ha
+00019120: 7320 6120 6275 672d 6669 7820 7065 6e64  s a bug-fix pend
+00019130: 696e 6720 6d65 7267 653a 2068 7474 7073  ing merge: https
+00019140: 3a2f 2f67 6974 6875 622e 636f 6d2f 7261  ://github.com/ra
+00019150: 6e61 726f 7573 7369 2f79 6669 6e61 6e63  naroussi/yfinanc
+00019160: 652f 7075 6c6c 2f31 3031 320a 2020 2020  e/pull/1012.    
+00019170: 2020 2020 2020 2020 6966 2065 6e64 2069          if end i
+00019180: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00019190: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000191a0: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
+000191b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191c0: 2020 6466 203d 2064 665b 6466 2e69 6e64    df = df[df.ind
+000191d0: 6578 2e64 6174 6520 3c20 656e 645f 645d  ex.date < end_d]
+000191e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000191f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019200: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+00019210: 6466 5b64 662e 696e 6465 7820 3c20 656e  df[df.index < en
+00019220: 645f 6474 5d0a 2020 2020 2020 2020 2020  d_dt].          
+00019230: 2020 2020 2020 6e20 3d20 6466 2e73 6861        n = df.sha
+00019240: 7065 5b30 5d0a 2020 2020 2020 2020 2020  pe[0].          
+00019250: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
+00019260: 2320 416e 6420 6167 6169 6e20 666f 7220  # And again for 
+00019270: 7072 652d 7374 6172 7420 6461 7461 3a0a  pre-start data:.
+00019280: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00019290: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
+000192a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000192b0: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+000192c0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+000192d0: 2020 2020 2020 2020 6466 203d 2064 665b          df = df[
+000192e0: 6466 2e69 6e64 6578 2e64 6174 6520 3e3d  df.index.date >=
+000192f0: 2073 7461 7274 5f64 5d0a 2020 2020 2020   start_d].      
+00019300: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019320: 2020 2020 6466 203d 2064 665b 6466 2e69      df = df[df.i
+00019330: 6e64 6578 203e 3d20 7374 6172 745f 6474  ndex >= start_dt
+00019340: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00019350: 2020 6e20 3d20 6466 2e73 6861 7065 5b30    n = df.shape[0
+00019360: 5d0a 0a20 2020 2020 2020 2023 2056 6572  ]..        # Ver
+00019370: 6966 7920 7468 6174 2061 6c6c 2064 6174  ify that all dat
+00019380: 6574 696d 6573 206d 6174 6368 2075 7020  etimes match up 
+00019390: 7769 7468 2061 6374 7561 6c20 696e 7465  with actual inte
+000193a0: 7276 616c 733a 0a20 2020 2020 2020 2069  rvals:.        i
+000193b0: 6620 6e20 3d3d 2030 3a0a 2020 2020 2020  f n == 0:.      
+000193c0: 2020 2020 2020 7261 6973 6520 7966 6364        raise yfcd
+000193d0: 2e4e 6f50 7269 6365 4461 7461 496e 5261  .NoPriceDataInRa
+000193e0: 6e67 6545 7863 6570 7469 6f6e 2873 656c  ngeException(sel
+000193f0: 662e 7469 636b 6572 2c20 7365 6c66 2e69  f.ticker, self.i
+00019400: 7374 722c 2073 7461 7274 2c20 656e 6429  str, start, end)
+00019410: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00019420: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00019430: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
+00019440: 2020 2020 2020 2020 2020 2020 2066 203d               f =
+00019450: 2064 662e 696e 6465 782e 7469 6d65 2021   df.index.time !
+00019460: 3d20 7469 6d65 2830 290a 2020 2020 2020  = time(0).      
+00019470: 2020 2020 2020 2020 2020 6966 2066 2e61            if f.a
+00019480: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+00019490: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000194a0: 6466 5b66 5d29 0a20 2020 2020 2020 2020  df[f]).         
+000194b0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000194c0: 2045 7863 6570 7469 6f6e 2822 496e 7465   Exception("Inte
+000194d0: 7264 6179 2064 6174 6120 636f 6e74 6169  rday data contai
+000194e0: 6e73 2074 696d 6573 2069 6e20 696e 6465  ns times in inde
+000194f0: 7822 290a 2020 2020 2020 2020 2020 2020  x").            
+00019500: 2020 2020 7966 496e 7465 7276 616c 5374      yfIntervalSt
+00019510: 6172 7473 203d 2064 662e 696e 6465 782e  arts = df.index.
+00019520: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
+00019530: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019540: 2020 2020 2020 2079 6649 6e74 6572 7661         yfInterva
+00019550: 6c53 7461 7274 7320 3d20 6466 2e69 6e64  lStarts = df.ind
+00019560: 6578 2e74 6f5f 7079 6461 7465 7469 6d65  ex.to_pydatetime
+00019570: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
+00019580: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00019590: 7365 6c66 2e69 6e74 7261 6461 7920 616e  self.intraday an
+000195a0: 6420 2873 656c 662e 6578 6368 616e 6765  d (self.exchange
+000195b0: 2069 6e20 7966 6364 2e65 7863 6861 6e67   in yfcd.exchang
+000195c0: 6573 5769 7468 4272 6561 6b73 293a 0a20  esWithBreaks):. 
+000195d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000195e0: 2044 6973 6361 7264 2061 6e79 2069 6e74   Discard any int
+000195f0: 6572 7661 6c73 2066 756c 6c79 2077 6974  ervals fully wit
+00019600: 6869 6e20 6120 6272 6561 6b0a 2020 2020  hin a break.    
+00019610: 2020 2020 2020 2020 2020 2020 665f 696e              f_in
+00019620: 5f62 7265 616b 203d 2079 6663 742e 5469  _break = yfct.Ti
+00019630: 6d65 7374 616d 7049 6e42 7265 616b 5f62  mestampInBreak_b
+00019640: 6174 6368 2873 656c 662e 6578 6368 616e  atch(self.exchan
+00019650: 6765 2c20 7966 496e 7465 7276 616c 5374  ge, yfIntervalSt
+00019660: 6172 7473 2c20 7365 6c66 2e69 6e74 6572  arts, self.inter
+00019670: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
+00019680: 2020 2020 2069 6620 665f 696e 5f62 7265       if f_in_bre
+00019690: 616b 2e61 6e79 2829 3a0a 2020 2020 2020  ak.any():.      
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000196b0: 4469 7363 6172 6420 7468 6573 650a 2020  Discard these.  
+000196c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196d0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196f0: 2020 2020 2020 2020 6d73 6720 3d20 222d          msg = "-
+00019700: 2064 726f 7070 696e 6720 726f 7773 2069   dropping rows i
+00019710: 6e20 6272 6561 6b20 7469 6d65 7322 0a20  n break times". 
+00019720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019730: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00019740: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+00019750: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+00019760: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+00019770: 7428 6d73 6729 0a20 2020 2020 2020 2020  t(msg).         
+00019780: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
+00019790: 6572 7661 6c53 7461 7274 7320 3d20 7966  ervalStarts = yf
+000197a0: 496e 7465 7276 616c 5374 6172 7473 5b7e  IntervalStarts[~
+000197b0: 665f 696e 5f62 7265 616b 5d0a 2020 2020  f_in_break].    
+000197c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000197d0: 6466 203d 2064 665b 7e66 5f69 6e5f 6272  df = df[~f_in_br
+000197e0: 6561 6b5d 0a20 2020 2020 2020 2020 2020  eak].           
+000197f0: 2020 2020 2020 2020 206e 203d 2064 662e           n = df.
+00019800: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+00019810: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+00019820: 2020 2069 6e74 6572 7661 6c73 203d 2079     intervals = y
+00019830: 6663 742e 4765 7454 696d 6573 7461 6d70  fct.GetTimestamp
+00019840: 4375 7272 656e 7449 6e74 6572 7661 6c5f  CurrentInterval_
+00019850: 6261 7463 6828 7365 6c66 2e65 7863 6861  batch(self.excha
+00019860: 6e67 652c 2079 6649 6e74 6572 7661 6c53  nge, yfIntervalS
+00019870: 7461 7274 732c 2073 656c 662e 696e 7465  tarts, self.inte
+00019880: 7276 616c 2c20 6469 7363 6172 6454 696d  rval, discardTim
+00019890: 6573 3d73 656c 662e 696e 7465 7264 6179  es=self.interday
+000198a0: 2c20 6967 6e6f 7265 5f62 7265 616b 733d  , ignore_breaks=
+000198b0: 5472 7565 290a 0a20 2020 2020 2020 2020  True)..         
+000198c0: 2020 2066 5f6e 6120 3d20 696e 7465 7276     f_na = interv
+000198d0: 616c 735b 2269 6e74 6572 7661 6c5f 6f70  als["interval_op
+000198e0: 656e 225d 2e69 736e 6128 292e 746f 5f6e  en"].isna().to_n
+000198f0: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
+00019900: 2020 2069 6620 7665 7269 6679 5f69 6e74     if verify_int
+00019910: 6572 7661 6c73 2061 6e64 2066 5f6e 612e  ervals and f_na.
+00019920: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+00019930: 2020 2020 2020 2074 7320 3d20 696e 7465         ts = inte
+00019940: 7276 616c 735b 2269 6e74 6572 7661 6c5f  rvals["interval_
+00019950: 6f70 656e 225d 0a20 2020 2020 2020 2020  open"].         
+00019960: 2020 2020 2020 2069 6620 6c65 6e28 7473         if len(ts
+00019970: 2920 213d 206c 656e 2873 6574 2874 7329  ) != len(set(ts)
+00019980: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019990: 2020 2020 2020 2064 7570 7320 3d20 7473         dups = ts
+000199a0: 5b74 732e 6475 706c 6963 6174 6564 286b  [ts.duplicated(k
+000199b0: 6565 703d 4661 6c73 6529 5d0a 2020 2020  eep=False)].    
+000199c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199d0: 2320 4472 6f70 2072 6f77 7320 7468 6174  # Drop rows that
+000199e0: 206d 6170 2074 6f20 6475 706c 6963 6174   map to duplicat
+000199f0: 6520 696e 7465 7276 616c 7320 6966 206e  e intervals if n
+00019a00: 6f20 7472 6164 696e 6720 6f63 6375 7272  o trading occurr
+00019a10: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00019a20: 2020 2020 2020 2020 665f 6e6f 5f74 7261          f_no_tra
+00019a30: 6465 7320 3d20 2864 665b 2256 6f6c 756d  des = (df["Volum
+00019a40: 6522 5d20 3d3d 2030 2920 2620 2828 6466  e"] == 0) & ((df
+00019a50: 5b22 4c6f 7722 5d20 3d3d 2064 665b 2248  ["Low"] == df["H
+00019a60: 6967 6822 5d29 207c 2064 665b 2243 6c6f  igh"]) | df["Clo
+00019a70: 7365 225d 2e69 736e 6128 2929 0a20 2020  se"].isna()).   
+00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a90: 2064 726f 705f 6474 7320 3d20 4e6f 6e65   drop_dts = None
+00019aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ab0: 2020 2020 2066 6f72 2069 2069 6e20 6475       for i in du
+00019ac0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00019ad0: 2020 2020 2020 2020 2020 2020 6474 7320              dts 
+00019ae0: 3d20 696e 7465 7276 616c 732e 696e 6465  = intervals.inde
+00019af0: 785b 696e 7465 7276 616c 735b 2269 6e74  x[intervals["int
+00019b00: 6572 7661 6c5f 6f70 656e 225d 203d 3d20  erval_open"] == 
+00019b10: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00019b20: 2020 2020 2020 2020 2020 2064 7473 5f69             dts_i
+00019b30: 735f 6e61 6e20 3d20 6e70 2e61 7272 6179  s_nan = np.array
+00019b40: 285b 665f 6e6f 5f74 7261 6465 735b 6466  ([f_no_trades[df
+00019b50: 2e69 6e64 6578 2e67 6574 5f6c 6f63 2864  .index.get_loc(d
+00019b60: 7429 5d20 666f 7220 6474 2069 6e20 6474  t)] for dt in dt
+00019b70: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
+00019b80: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00019b90: 7473 5f69 735f 6e61 6e2e 616c 6c28 293a  ts_is_nan.all():
+00019ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019bb0: 2020 2020 2020 2020 2020 2020 2023 204b               # K
+00019bc0: 6565 7020 6669 7273 742c 2064 726f 7020  eep first, drop 
+00019bd0: 6f74 6865 7273 0a20 2020 2020 2020 2020  others.         
+00019be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bf0: 2020 2064 726f 705f 6474 735f 7375 6220     drop_dts_sub 
+00019c00: 3d20 6474 735b 313a 5d0a 2020 2020 2020  = dts[1:].      
+00019c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c40: 2020 2020 2320 4b65 6570 206e 6f6e 2d6e      # Keep non-n
+00019c50: 616e 2c20 6472 6f70 206e 616e 730a 2020  an, drop nans.  
+00019c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c70: 2020 2020 2020 2020 2020 6472 6f70 5f64            drop_d
+00019c80: 7473 5f73 7562 203d 2064 7473 5b64 7473  ts_sub = dts[dts
+00019c90: 5f69 735f 6e61 6e5d 0a20 2020 2020 2020  _is_nan].       
+00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cb0: 2064 726f 705f 6474 7320 3d20 6472 6f70   drop_dts = drop
+00019cc0: 5f64 7473 5f73 7562 2069 6620 6472 6f70  _dts_sub if drop
+00019cd0: 5f64 7473 2069 7320 4e6f 6e65 2065 6c73  _dts is None els
+00019ce0: 6520 6e70 2e61 7070 656e 6428 6472 6f70  e np.append(drop
+00019cf0: 5f64 7473 2c20 6472 6f70 5f64 7473 5f73  _dts, drop_dts_s
+00019d00: 7562 290a 2020 2020 2020 2020 2020 2020  ub).            
+00019d10: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00019d20: 2264 726f 7070 696e 673a 222c 2064 726f  "dropping:", dro
+00019d30: 705f 6474 7329 0a20 2020 2020 2020 2020  p_dts).         
+00019d40: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
+00019d50: 6572 7661 6c53 7461 7274 7320 3d20 6e70  ervalStarts = np
+00019d60: 2e64 656c 6574 6528 7966 496e 7465 7276  .delete(yfInterv
+00019d70: 616c 5374 6172 7473 2c20 5b64 662e 696e  alStarts, [df.in
+00019d80: 6465 782e 6765 745f 6c6f 6328 6474 2920  dex.get_loc(dt) 
+00019d90: 666f 7220 6474 2069 6e20 6472 6f70 5f64  for dt in drop_d
+00019da0: 7473 5d29 0a20 2020 2020 2020 2020 2020  ts]).           
+00019db0: 2020 2020 2020 2020 2069 6e74 6572 7661           interva
+00019dc0: 6c73 203d 2069 6e74 6572 7661 6c73 2e64  ls = intervals.d
+00019dd0: 726f 7028 6472 6f70 5f64 7473 290a 2020  rop(drop_dts).  
+00019de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019df0: 2020 6466 203d 2064 662e 6472 6f70 2864    df = df.drop(d
+00019e00: 726f 705f 6474 7329 0a20 2020 2020 2020  rop_dts).       
+00019e10: 2020 2020 2020 2020 2020 2020 206e 203d               n =
+00019e20: 2064 662e 7368 6170 655b 305d 0a20 2020   df.shape[0].   
+00019e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e40: 2066 5f6e 6120 3d20 696e 7465 7276 616c   f_na = interval
+00019e50: 735b 2269 6e74 6572 7661 6c5f 6f70 656e  s["interval_open
+00019e60: 225d 2e69 736e 6128 292e 746f 5f6e 756d  "].isna().to_num
+00019e70: 7079 2829 0a0a 2020 2020 2020 2020 2020  py()..          
+00019e80: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+00019e90: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
+00019ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019eb0: 2320 466f 7220 736f 6d65 2065 7863 6861  # For some excha
+00019ec0: 6e67 6573 2028 652e 672e 204a 5345 2920  nges (e.g. JSE) 
+00019ed0: 5961 686f 6f20 7265 7475 726e 7320 696e  Yahoo returns in
+00019ee0: 7472 6164 6179 2074 696d 6573 7461 6d70  traday timestamp
+00019ef0: 7320 7269 6768 7420 6f6e 206d 6172 6b65  s right on marke
+00019f00: 7420 636c 6f73 652e 0a20 2020 2020 2020  t close..       
+00019f10: 2020 2020 2020 2020 2020 2020 2023 202d               # -
+00019f20: 2072 656d 6f76 6520 6966 2076 6f6c 756d   remove if volum
+00019f30: 6520 300a 2020 2020 2020 2020 2020 2020  e 0.            
+00019f40: 2020 2020 2020 2020 2320 2d20 656c 7365          # - else
+00019f50: 2c20 6d65 7267 6520 7769 7468 2070 7265  , merge with pre
+00019f60: 7669 6f75 7320 696e 7465 7276 616c 0a20  vious interval. 
+00019f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f80: 2020 2064 6632 203d 2064 662e 636f 7079     df2 = df.copy
+00019f90: 2829 203b 2064 6632 5b22 5f64 6174 6522  () ; df2["_date"
+00019fa0: 5d20 3d20 6466 322e 696e 6465 782e 6461  ] = df2.index.da
+00019fb0: 7465 203b 2064 6632 5b22 5f69 6e74 6572  te ; df2["_inter
+00019fc0: 7661 6c53 7461 7274 225d 203d 2064 6632  valStart"] = df2
+00019fd0: 2e69 6e64 6578 0a20 2020 2020 2020 2020  .index.         
+00019fe0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
+00019ff0: 203d 2079 6663 742e 4765 7445 7863 6861   = yfct.GetExcha
+0001a000: 6e67 6553 6368 6564 756c 6528 7365 6c66  ngeSchedule(self
+0001a010: 2e65 7863 6861 6e67 652c 2064 6632 5b22  .exchange, df2["
+0001a020: 5f64 6174 6522 5d2e 6d69 6e28 292c 2064  _date"].min(), d
+0001a030: 6632 5b22 5f64 6174 6522 5d2e 6d61 7828  f2["_date"].max(
+0001a040: 292b 7464 5f31 6429 0a20 2020 2020 2020  )+td_1d).       
+0001a050: 2020 2020 2020 2020 2020 2020 2072 656e               ren
+0001a060: 616d 655f 636f 6c73 203d 207b 226f 7065  ame_cols = {"ope
+0001a070: 6e22 3a20 226d 6172 6b65 745f 6f70 656e  n": "market_open
+0001a080: 222c 2022 636c 6f73 6522 3a20 226d 6172  ", "close": "mar
+0001a090: 6b65 745f 636c 6f73 6522 7d0a 2020 2020  ket_close"}.    
+0001a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a0b0: 7363 6865 642e 636f 6c75 6d6e 7320 3d20  sched.columns = 
+0001a0c0: 5b72 656e 616d 655f 636f 6c73 5b63 5d20  [rename_cols[c] 
+0001a0d0: 6966 2063 2069 6e20 7265 6e61 6d65 5f63  if c in rename_c
+0001a0e0: 6f6c 7320 656c 7365 2063 2066 6f72 2063  ols else c for c
+0001a0f0: 2069 6e20 7363 6865 642e 636f 6c75 6d6e   in sched.column
+0001a100: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+0001a110: 2020 2020 2020 2073 6368 6564 5f64 6620         sched_df 
+0001a120: 3d20 7363 6865 642e 636f 7079 2829 0a20  = sched.copy(). 
+0001a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a140: 2020 2073 6368 6564 5f64 665b 225f 6461     sched_df["_da
+0001a150: 7465 225d 203d 2073 6368 6564 5f64 662e  te"] = sched_df.
+0001a160: 696e 6465 782e 6461 7465 0a20 2020 2020  index.date.     
+0001a170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001a180: 6632 203d 2064 6632 2e6d 6572 6765 2873  f2 = df2.merge(s
+0001a190: 6368 6564 5f64 662c 206f 6e3d 225f 6461  ched_df, on="_da
+0001a1a0: 7465 222c 2068 6f77 3d22 6c65 6674 2229  te", how="left")
+0001a1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a1c0: 2020 2020 2064 6632 2e69 6e64 6578 203d       df2.index =
+0001a1d0: 2064 662e 696e 6465 780a 2020 2020 2020   df.index.      
+0001a1e0: 2020 2020 2020 2020 2020 2020 2020 665f                f_
+0001a1f0: 636c 6f73 6520 3d20 2864 6632 5b22 5f69  close = (df2["_i
+0001a200: 6e74 6572 7661 6c53 7461 7274 225d 203d  ntervalStart"] =
+0001a210: 3d20 6466 325b 226d 6172 6b65 745f 636c  = df2["market_cl
+0001a220: 6f73 6522 5d29 2e74 6f5f 6e75 6d70 7928  ose"]).to_numpy(
+0001a230: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a240: 2020 2020 2020 665f 636c 6f73 6520 3d20        f_close = 
+0001a250: 665f 636c 6f73 6520 2620 665f 6e61 0a20  f_close & f_na. 
+0001a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a270: 2020 2066 5f76 6f6c 3020 3d20 6466 325b     f_vol0 = df2[
+0001a280: 2256 6f6c 756d 6522 5d20 3d3d 2030 0a20  "Volume"] == 0. 
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2066 5f64 726f 7020 3d20 665f 766f     f_drop = f_vo
+0001a2b0: 6c30 2026 2066 5f63 6c6f 7365 0a20 2020  l0 & f_close.   
+0001a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2d0: 2069 6620 665f 6472 6f70 2e61 6e79 2829   if f_drop.any()
+0001a2e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a2f0: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+0001a300: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2020 2020 6d73 6720 3d20 222d 2064 726f      msg = "- dro
+0001a330: 7070 696e 6720 302d 766f 6c75 6d65 2072  pping 0-volume r
+0001a340: 6f77 7320 7374 6172 7469 6e67 2061 7420  ows starting at 
+0001a350: 6d61 726b 6574 2063 6c6f 7365 220a 2020  market close".  
 0001a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a370: 2020 2020 2064 7473 203d 2069 6e74 6572       dts = inter
-0001a380: 7661 6c73 2e69 6e64 6578 5b69 6e74 6572  vals.index[inter
-0001a390: 7661 6c73 5b22 696e 7465 7276 616c 5f6f  vals["interval_o
-0001a3a0: 7065 6e22 5d20 3d3d 2069 5d0a 2020 2020  pen"] == i].    
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a3c0: 2020 2020 6474 735f 6973 5f6e 616e 203d      dts_is_nan =
-0001a3d0: 206e 702e 6172 7261 7928 5b66 5f6e 6f5f   np.array([f_no_
-0001a3e0: 7472 6164 6573 5b64 662e 696e 6465 782e  trades[df.index.
-0001a3f0: 6765 745f 6c6f 6328 6474 295d 2066 6f72  get_loc(dt)] for
-0001a400: 2064 7420 696e 2064 7473 5d29 0a20 2020   dt in dts]).   
-0001a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a420: 2020 2020 2069 6620 6474 735f 6973 5f6e       if dts_is_n
-0001a430: 616e 2e61 6c6c 2829 3a0a 2020 2020 2020  an.all():.      
-0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a450: 2020 2020 2020 2320 4b65 6570 2066 6972        # Keep fir
-0001a460: 7374 2c20 6472 6f70 206f 7468 6572 730a  st, drop others.
-0001a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a480: 2020 2020 2020 2020 2020 2020 6472 6f70              drop
-0001a490: 5f64 7473 5f73 7562 203d 2064 7473 5b31  _dts_sub = dts[1
-0001a4a0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-0001a4b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001a4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a4d0: 2020 2020 2020 2020 2020 2020 2023 204b               # K
-0001a4e0: 6565 7020 6e6f 6e2d 6e61 6e2c 2064 726f  eep non-nan, dro
-0001a4f0: 7020 6e61 6e73 0a20 2020 2020 2020 2020  p nans.         
+0001a370: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+0001a380: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
+0001a390: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+0001a3a0: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
+0001a3b0: 7269 6e74 286d 7367 290a 2020 2020 2020  rint(msg).      
+0001a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3d0: 2020 7966 496e 7465 7276 616c 5374 6172    yfIntervalStar
+0001a3e0: 7473 203d 2079 6649 6e74 6572 7661 6c53  ts = yfIntervalS
+0001a3f0: 7461 7274 735b 7e66 5f64 726f 705d 0a20  tarts[~f_drop]. 
+0001a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a410: 2020 2020 2020 2069 6e74 6572 7661 6c73         intervals
+0001a420: 203d 2069 6e74 6572 7661 6c73 5b7e 665f   = intervals[~f_
+0001a430: 6472 6f70 5d0a 2020 2020 2020 2020 2020  drop].          
+0001a440: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001a450: 203d 2064 665b 7e66 5f64 726f 705d 0a20   = df[~f_drop]. 
+0001a460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a470: 2020 2020 2020 2064 6632 203d 2064 6632         df2 = df2
+0001a480: 5b7e 665f 6472 6f70 5d0a 2020 2020 2020  [~f_drop].      
+0001a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4a0: 2020 6e20 3d20 6466 2e73 6861 7065 5b30    n = df.shape[0
+0001a4b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001a4c0: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
+0001a4d0: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
+0001a4e0: 7276 616c 5f6f 7065 6e22 5d2e 6973 6e61  rval_open"].isna
+0001a4f0: 2829 2e74 6f5f 6e75 6d70 7928 290a 2020  ().to_numpy().  
 0001a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a510: 2020 2064 726f 705f 6474 735f 7375 6220     drop_dts_sub 
-0001a520: 3d20 6474 735b 6474 735f 6973 5f6e 616e  = dts[dts_is_nan
-0001a530: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001a540: 2020 2020 2020 2020 2020 6472 6f70 5f64            drop_d
-0001a550: 7473 203d 2064 726f 705f 6474 735f 7375  ts = drop_dts_su
-0001a560: 6220 6966 2064 726f 705f 6474 7320 6973  b if drop_dts is
-0001a570: 204e 6f6e 6520 656c 7365 206e 702e 6170   None else np.ap
-0001a580: 7065 6e64 2864 726f 705f 6474 732c 2064  pend(drop_dts, d
-0001a590: 726f 705f 6474 735f 7375 6229 0a20 2020  rop_dts_sub).   
-0001a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5b0: 2023 2070 7269 6e74 2822 6472 6f70 7069   # print("droppi
-0001a5c0: 6e67 3a22 2c20 6472 6f70 5f64 7473 290a  ng:", drop_dts).
-0001a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5e0: 2020 2020 7966 496e 7465 7276 616c 5374      yfIntervalSt
-0001a5f0: 6172 7473 203d 206e 702e 6465 6c65 7465  arts = np.delete
-0001a600: 2879 6649 6e74 6572 7661 6c53 7461 7274  (yfIntervalStart
-0001a610: 732c 205b 6466 2e69 6e64 6578 2e67 6574  s, [df.index.get
-0001a620: 5f6c 6f63 2864 7429 2066 6f72 2064 7420  _loc(dt) for dt 
-0001a630: 696e 2064 726f 705f 6474 735d 290a 2020  in drop_dts]).  
-0001a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a650: 2020 696e 7465 7276 616c 7320 3d20 696e    intervals = in
-0001a660: 7465 7276 616c 732e 6472 6f70 2864 726f  tervals.drop(dro
-0001a670: 705f 6474 7329 0a20 2020 2020 2020 2020  p_dts).         
-0001a680: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
-0001a690: 6466 2e64 726f 7028 6472 6f70 5f64 7473  df.drop(drop_dts
-0001a6a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a6b0: 2020 2020 2020 6e20 3d20 6466 2e73 6861        n = df.sha
-0001a6c0: 7065 5b30 5d0a 2020 2020 2020 2020 2020  pe[0].          
-0001a6d0: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
-0001a6e0: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
-0001a6f0: 7276 616c 5f6f 7065 6e22 5d2e 6973 6e61  rval_open"].isna
-0001a700: 2829 2e74 6f5f 6e75 6d70 7928 290a 0a20  ().to_numpy().. 
-0001a710: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a720: 6620 6e6f 7420 7365 6c66 2e69 6e74 6572  f not self.inter
-0001a730: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
-0001a740: 2020 2020 2020 2020 2023 2046 6f72 2073           # For s
-0001a750: 6f6d 6520 6578 6368 616e 6765 7320 2865  ome exchanges (e
-0001a760: 2e67 2e20 4a53 4529 2059 6168 6f6f 2072  .g. JSE) Yahoo r
-0001a770: 6574 7572 6e73 2069 6e74 7261 6461 7920  eturns intraday 
-0001a780: 7469 6d65 7374 616d 7073 2072 6967 6874  timestamps right
-0001a790: 206f 6e20 6d61 726b 6574 2063 6c6f 7365   on market close
-0001a7a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001a7b0: 2020 2020 2020 2320 2d20 7265 6d6f 7665        # - remove
-0001a7c0: 2069 6620 766f 6c75 6d65 2030 0a20 2020   if volume 0.   
+0001a510: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
+0001a520: 2020 2020 2020 2020 665f 636c 6f73 6520          f_close 
+0001a530: 3d20 2864 6632 5b22 5f69 6e74 6572 7661  = (df2["_interva
+0001a540: 6c53 7461 7274 225d 203d 3d20 6466 325b  lStart"] == df2[
+0001a550: 226d 6172 6b65 745f 636c 6f73 6522 5d29  "market_close"])
+0001a560: 2e74 6f5f 6e75 6d70 7928 290a 2020 2020  .to_numpy().    
+0001a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a580: 665f 636c 6f73 6520 3d20 665f 636c 6f73  f_close = f_clos
+0001a590: 6520 2620 665f 6e61 0a20 2020 2020 2020  e & f_na.       
+0001a5a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001a5b0: 665f 636c 6f73 652e 616e 7928 293a 0a20  f_close.any():. 
+0001a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5d0: 2020 2020 2020 2023 204d 7573 7420 6d65         # Must me
+0001a5e0: 7267 6520 7769 7468 2070 7265 7669 6f75  rge with previou
+0001a5f0: 7320 696e 7465 7276 616c 2e20 5472 6963  s interval. Tric
+0001a600: 6b79 210a 2020 2020 2020 2020 2020 2020  ky!.            
+0001a610: 2020 2020 2020 2020 2020 2020 6466 3320              df3 
+0001a620: 3d20 6466 325b 665f 636c 6f73 655d 0a20  = df2[f_close]. 
+0001a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a640: 2020 2020 2020 2064 6633 5f69 6e64 6578         df3_index
+0001a650: 5f72 6576 203d 2073 6f72 7465 6428 6c69  _rev = sorted(li
+0001a660: 7374 2864 6633 2e69 6e64 6578 292c 2072  st(df3.index), r
+0001a670: 6576 6572 7365 3d54 7275 6529 0a20 2020  everse=True).   
+0001a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a690: 2020 2020 2066 6f72 2064 7420 696e 2064       for dt in d
+0001a6a0: 6633 5f69 6e64 6578 5f72 6576 3a0a 2020  f3_index_rev:.  
+0001a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6c0: 2020 2020 2020 2020 2020 6920 3d20 6466            i = df
+0001a6d0: 2e69 6e64 6578 2e67 6574 5f6c 6f63 2864  .index.get_loc(d
+0001a6e0: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+0001a6f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001a700: 6620 6920 3d3d 2030 3a0a 2020 2020 2020  f i == 0:.      
+0001a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a720: 2020 2020 2020 2020 2020 2320 4361 6e27            # Can'
+0001a730: 7420 6669 780a 2020 2020 2020 2020 2020  t fix.          
+0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a750: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0001a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a770: 2020 2020 2020 2020 2020 2064 745f 6265             dt_be
+0001a780: 666f 7265 203d 2064 662e 696e 6465 785b  fore = df.index[
+0001a790: 692d 315d 0a20 2020 2020 2020 2020 2020  i-1].           
+0001a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7b0: 2069 6620 2864 742d 6474 5f62 6566 6f72   if (dt-dt_befor
+0001a7c0: 6529 203c 3d20 7365 6c66 2e69 7464 3a0a  e) <= self.itd:.
 0001a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7e0: 2023 202d 2065 6c73 652c 206d 6572 6765   # - else, merge
-0001a7f0: 2077 6974 6820 7072 6576 696f 7573 2069   with previous i
-0001a800: 6e74 6572 7661 6c0a 2020 2020 2020 2020  nterval.        
-0001a810: 2020 2020 2020 2020 2020 2020 6466 3220              df2 
-0001a820: 3d20 6466 2e63 6f70 7928 2920 3b20 6466  = df.copy() ; df
-0001a830: 325b 225f 6461 7465 225d 203d 2064 6632  2["_date"] = df2
-0001a840: 2e69 6e64 6578 2e64 6174 6520 3b20 6466  .index.date ; df
-0001a850: 325b 225f 696e 7465 7276 616c 5374 6172  2["_intervalStar
-0001a860: 7422 5d20 3d20 6466 322e 696e 6465 780a  t"] = df2.index.
-0001a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a880: 2020 2020 7363 6865 6420 3d20 7966 6374      sched = yfct
-0001a890: 2e47 6574 4578 6368 616e 6765 5363 6865  .GetExchangeSche
-0001a8a0: 6475 6c65 2873 656c 662e 6578 6368 616e  dule(self.exchan
-0001a8b0: 6765 2c20 6466 325b 225f 6461 7465 225d  ge, df2["_date"]
-0001a8c0: 2e6d 696e 2829 2c20 6466 325b 225f 6461  .min(), df2["_da
-0001a8d0: 7465 225d 2e6d 6178 2829 2b74 645f 3164  te"].max()+td_1d
-0001a8e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a8f0: 2020 2020 2020 7265 6e61 6d65 5f63 6f6c        rename_col
-0001a900: 7320 3d20 7b22 6f70 656e 223a 2022 6d61  s = {"open": "ma
-0001a910: 726b 6574 5f6f 7065 6e22 2c20 2263 6c6f  rket_open", "clo
-0001a920: 7365 223a 2022 6d61 726b 6574 5f63 6c6f  se": "market_clo
-0001a930: 7365 227d 0a20 2020 2020 2020 2020 2020  se"}.           
-0001a940: 2020 2020 2020 2020 2073 6368 6564 2e63           sched.c
-0001a950: 6f6c 756d 6e73 203d 205b 7265 6e61 6d65  olumns = [rename
-0001a960: 5f63 6f6c 735b 635d 2069 6620 6320 696e  _cols[c] if c in
-0001a970: 2072 656e 616d 655f 636f 6c73 2065 6c73   rename_cols els
-0001a980: 6520 6320 666f 7220 6320 696e 2073 6368  e c for c in sch
-0001a990: 6564 2e63 6f6c 756d 6e73 5d0a 2020 2020  ed.columns].    
+0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7f0: 2320 4d65 7267 650a 2020 2020 2020 2020  # Merge.        
+0001a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a810: 2020 2020 2020 2020 6466 5f72 6f77 7320          df_rows 
+0001a820: 3d20 6466 2e69 6c6f 635b 692d 313a 692b  = df.iloc[i-1:i+
+0001a830: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a850: 2020 2064 662e 6c6f 635b 6474 5f62 6566     df.loc[dt_bef
+0001a860: 6f72 652c 2022 4c6f 7722 5d20 3d20 6466  ore, "Low"] = df
+0001a870: 5f72 6f77 735b 224c 6f77 225d 2e64 726f  _rows["Low"].dro
+0001a880: 706e 6128 292e 6d69 6e28 290a 2020 2020  pna().min().    
+0001a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8a0: 2020 2020 2020 2020 2020 2020 6466 2e6c              df.l
+0001a8b0: 6f63 5b64 745f 6265 666f 7265 2c20 2248  oc[dt_before, "H
+0001a8c0: 6967 6822 5d20 3d20 6466 5f72 6f77 735b  igh"] = df_rows[
+0001a8d0: 2248 6967 6822 5d2e 6472 6f70 6e61 2829  "High"].dropna()
+0001a8e0: 2e6d 6178 2829 0a20 2020 2020 2020 2020  .max().         
+0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a900: 2020 2020 2020 2064 662e 6c6f 635b 6474         df.loc[dt
+0001a910: 5f62 6566 6f72 652c 2022 4f70 656e 225d  _before, "Open"]
+0001a920: 203d 2064 665f 726f 7773 5b22 4f70 656e   = df_rows["Open
+0001a930: 225d 2e64 726f 706e 6128 295b 305d 0a20  "].dropna()[0]. 
+0001a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a950: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001a960: 662e 6c6f 635b 6474 5f62 6566 6f72 652c  f.loc[dt_before,
+0001a970: 2022 436c 6f73 6522 5d20 3d20 6466 5f72   "Close"] = df_r
+0001a980: 6f77 735b 2243 6c6f 7365 225d 2e64 726f  ows["Close"].dro
+0001a990: 706e 6128 295b 2d31 5d0a 2020 2020 2020  pna()[-1].      
 0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9b0: 7363 6865 645f 6466 203d 2073 6368 6564  sched_df = sched
-0001a9c0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-0001a9d0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-0001a9e0: 645f 6466 5b22 5f64 6174 6522 5d20 3d20  d_df["_date"] = 
-0001a9f0: 7363 6865 645f 6466 2e69 6e64 6578 2e64  sched_df.index.d
-0001aa00: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-0001aa10: 2020 2020 2020 2020 6466 3220 3d20 6466          df2 = df
-0001aa20: 322e 6d65 7267 6528 7363 6865 645f 6466  2.merge(sched_df
-0001aa30: 2c20 6f6e 3d22 5f64 6174 6522 2c20 686f  , on="_date", ho
-0001aa40: 773d 226c 6566 7422 290a 2020 2020 2020  w="left").      
-0001aa50: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0001aa60: 322e 696e 6465 7820 3d20 6466 2e69 6e64  2.index = df.ind
-0001aa70: 6578 0a20 2020 2020 2020 2020 2020 2020  ex.             
-0001aa80: 2020 2020 2020 2066 5f63 6c6f 7365 203d         f_close =
-0001aa90: 2028 6466 325b 225f 696e 7465 7276 616c   (df2["_interval
-0001aaa0: 5374 6172 7422 5d20 3d3d 2064 6632 5b22  Start"] == df2["
-0001aab0: 6d61 726b 6574 5f63 6c6f 7365 225d 292e  market_close"]).
-0001aac0: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-0001aad0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001aae0: 5f63 6c6f 7365 203d 2066 5f63 6c6f 7365  _close = f_close
-0001aaf0: 2026 2066 5f6e 610a 2020 2020 2020 2020   & f_na.        
-0001ab00: 2020 2020 2020 2020 2020 2020 665f 766f              f_vo
-0001ab10: 6c30 203d 2064 6632 5b22 566f 6c75 6d65  l0 = df2["Volume
-0001ab20: 225d 203d 3d20 300a 2020 2020 2020 2020  "] == 0.        
-0001ab30: 2020 2020 2020 2020 2020 2020 665f 6472              f_dr
-0001ab40: 6f70 203d 2066 5f76 6f6c 3020 2620 665f  op = f_vol0 & f_
-0001ab50: 636c 6f73 650a 2020 2020 2020 2020 2020  close.          
-0001ab60: 2020 2020 2020 2020 2020 6966 2066 5f64            if f_d
-0001ab70: 726f 702e 616e 7928 293a 0a20 2020 2020  rop.any():.     
-0001ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab90: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-0001aba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001abb0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-0001abc0: 203d 2022 2d20 6472 6f70 7069 6e67 2030   = "- dropping 0
-0001abd0: 2d76 6f6c 756d 6520 726f 7773 2073 7461  -volume rows sta
-0001abe0: 7274 696e 6720 6174 206d 6172 6b65 7420  rting at market 
-0001abf0: 636c 6f73 6522 0a20 2020 2020 2020 2020  close".         
-0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-0001ac20: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
-0001ac30: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0001ac40: 2829 2065 6c73 6520 7072 696e 7428 6d73  () else print(ms
-0001ac50: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0001ac60: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
-0001ac70: 6572 7661 6c53 7461 7274 7320 3d20 7966  ervalStarts = yf
-0001ac80: 496e 7465 7276 616c 5374 6172 7473 5b7e  IntervalStarts[~
-0001ac90: 665f 6472 6f70 5d0a 2020 2020 2020 2020  f_drop].        
-0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acb0: 696e 7465 7276 616c 7320 3d20 696e 7465  intervals = inte
-0001acc0: 7276 616c 735b 7e66 5f64 726f 705d 0a20  rvals[~f_drop]. 
-0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ace0: 2020 2020 2020 2064 6620 3d20 6466 5b7e         df = df[~
-0001acf0: 665f 6472 6f70 5d0a 2020 2020 2020 2020  f_drop].        
-0001ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad10: 6466 3220 3d20 6466 325b 7e66 5f64 726f  df2 = df2[~f_dro
-0001ad20: 705d 0a20 2020 2020 2020 2020 2020 2020  p].             
-0001ad30: 2020 2020 2020 2020 2020 206e 203d 2064             n = d
-0001ad40: 662e 7368 6170 655b 305d 0a20 2020 2020  f.shape[0].     
-0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad60: 2020 2066 5f6e 6120 3d20 696e 7465 7276     f_na = interv
-0001ad70: 616c 735b 2269 6e74 6572 7661 6c5f 6f70  als["interval_op
-0001ad80: 656e 225d 2e69 736e 6128 292e 746f 5f6e  en"].isna().to_n
-0001ad90: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
-0001ada0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
-0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adc0: 2066 5f63 6c6f 7365 203d 2028 6466 325b   f_close = (df2[
-0001add0: 225f 696e 7465 7276 616c 5374 6172 7422  "_intervalStart"
-0001ade0: 5d20 3d3d 2064 6632 5b22 6d61 726b 6574  ] == df2["market
-0001adf0: 5f63 6c6f 7365 225d 292e 746f 5f6e 756d  _close"]).to_num
-0001ae00: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-0001ae10: 2020 2020 2020 2020 2066 5f63 6c6f 7365           f_close
-0001ae20: 203d 2066 5f63 6c6f 7365 2026 2066 5f6e   = f_close & f_n
-0001ae30: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-0001ae40: 2020 2020 2020 6966 2066 5f63 6c6f 7365        if f_close
-0001ae50: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-0001ae60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae70: 2320 4d75 7374 206d 6572 6765 2077 6974  # Must merge wit
-0001ae80: 6820 7072 6576 696f 7573 2069 6e74 6572  h previous inter
-0001ae90: 7661 6c2e 2054 7269 636b 7921 0a20 2020  val. Tricky!.   
-0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aeb0: 2020 2020 2064 6633 203d 2064 6632 5b66       df3 = df2[f
-0001aec0: 5f63 6c6f 7365 5d0a 2020 2020 2020 2020  _close].        
-0001aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aee0: 6466 335f 696e 6465 785f 7265 7620 3d20  df3_index_rev = 
-0001aef0: 736f 7274 6564 286c 6973 7428 6466 332e  sorted(list(df3.
-0001af00: 696e 6465 7829 2c20 7265 7665 7273 653d  index), reverse=
-0001af10: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0001af20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001af30: 7220 6474 2069 6e20 6466 335f 696e 6465  r dt in df3_inde
-0001af40: 785f 7265 763a 0a20 2020 2020 2020 2020  x_rev:.         
-0001af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af60: 2020 2069 203d 2064 662e 696e 6465 782e     i = df.index.
-0001af70: 6765 745f 6c6f 6328 6474 290a 2020 2020  get_loc(dt).    
-0001af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af90: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
-0001afa0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0001afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001afc0: 2020 2023 2043 616e 2774 2066 6978 0a20     # Can't fix. 
-0001afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001afe0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001aff0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0001b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b010: 2020 2020 6474 5f62 6566 6f72 6520 3d20      dt_before = 
-0001b020: 6466 2e69 6e64 6578 5b69 2d31 5d0a 2020  df.index[i-1].  
-0001b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b040: 2020 2020 2020 2020 2020 6966 2028 6474            if (dt
-0001b050: 2d64 745f 6265 666f 7265 2920 3c3d 2073  -dt_before) <= s
-0001b060: 656c 662e 6974 643a 0a20 2020 2020 2020  elf.itd:.       
-0001b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b080: 2020 2020 2020 2020 2023 204d 6572 6765           # Merge
-0001b090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0b0: 2064 665f 726f 7773 203d 2064 662e 696c   df_rows = df.il
-0001b0c0: 6f63 5b69 2d31 3a69 2b31 5d0a 2020 2020  oc[i-1:i+1].    
-0001b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0e0: 2020 2020 2020 2020 2020 2020 6466 2e6c              df.l
-0001b0f0: 6f63 5b64 745f 6265 666f 7265 2c20 224c  oc[dt_before, "L
-0001b100: 6f77 225d 203d 2064 665f 726f 7773 5b22  ow"] = df_rows["
-0001b110: 4c6f 7722 5d2e 6472 6f70 6e61 2829 2e6d  Low"].dropna().m
-0001b120: 696e 2829 0a20 2020 2020 2020 2020 2020  in().           
-0001b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b140: 2020 2020 2064 662e 6c6f 635b 6474 5f62       df.loc[dt_b
-0001b150: 6566 6f72 652c 2022 4869 6768 225d 203d  efore, "High"] =
-0001b160: 2064 665f 726f 7773 5b22 4869 6768 225d   df_rows["High"]
-0001b170: 2e64 726f 706e 6128 292e 6d61 7828 290a  .dropna().max().
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1a0: 6466 2e6c 6f63 5b64 745f 6265 666f 7265  df.loc[dt_before
-0001b1b0: 2c20 224f 7065 6e22 5d20 3d20 6466 5f72  , "Open"] = df_r
-0001b1c0: 6f77 735b 224f 7065 6e22 5d2e 6472 6f70  ows["Open"].drop
-0001b1d0: 6e61 2829 5b30 5d0a 2020 2020 2020 2020  na()[0].        
-0001b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1f0: 2020 2020 2020 2020 6466 2e6c 6f63 5b64          df.loc[d
-0001b200: 745f 6265 666f 7265 2c20 2243 6c6f 7365  t_before, "Close
-0001b210: 225d 203d 2064 665f 726f 7773 5b22 436c  "] = df_rows["Cl
-0001b220: 6f73 6522 5d2e 6472 6f70 6e61 2829 5b2d  ose"].dropna()[-
-0001b230: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0001b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b250: 2020 2064 662e 6c6f 635b 6474 5f62 6566     df.loc[dt_bef
-0001b260: 6f72 652c 2022 4164 6a20 436c 6f73 6522  ore, "Adj Close"
-0001b270: 5d20 3d20 6466 5f72 6f77 735b 2241 646a  ] = df_rows["Adj
-0001b280: 2043 6c6f 7365 225d 2e64 726f 706e 6128   Close"].dropna(
-0001b290: 295b 2d31 5d0a 2020 2020 2020 2020 2020  )[-1].          
-0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2b0: 2020 2020 2020 6466 2e6c 6f63 5b64 745f        df.loc[dt_
-0001b2c0: 6265 666f 7265 2c20 2256 6f6c 756d 6522  before, "Volume"
-0001b2d0: 5d20 3d20 6466 5f72 6f77 735b 2256 6f6c  ] = df_rows["Vol
-0001b2e0: 756d 6522 5d2e 6472 6f70 6e61 2829 2e73  ume"].dropna().s
-0001b2f0: 756d 2829 0a0a 2020 2020 2020 2020 2020  um()..          
+0001a9b0: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
+0001a9c0: 5b64 745f 6265 666f 7265 2c20 2241 646a  [dt_before, "Adj
+0001a9d0: 2043 6c6f 7365 225d 203d 2064 665f 726f   Close"] = df_ro
+0001a9e0: 7773 5b22 4164 6a20 436c 6f73 6522 5d2e  ws["Adj Close"].
+0001a9f0: 6472 6f70 6e61 2829 5b2d 315d 0a20 2020  dropna()[-1].   
+0001aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa10: 2020 2020 2020 2020 2020 2020 2064 662e               df.
+0001aa20: 6c6f 635b 6474 5f62 6566 6f72 652c 2022  loc[dt_before, "
+0001aa30: 566f 6c75 6d65 225d 203d 2064 665f 726f  Volume"] = df_ro
+0001aa40: 7773 5b22 566f 6c75 6d65 225d 2e64 726f  ws["Volume"].dro
+0001aa50: 706e 6128 292e 7375 6d28 290a 0a20 2020  pna().sum()..   
+0001aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa70: 2020 2020 2020 2020 2020 2020 2079 6649               yfI
+0001aa80: 6e74 6572 7661 6c53 7461 7274 7320 3d20  ntervalStarts = 
+0001aa90: 6e70 2e64 656c 6574 6528 7966 496e 7465  np.delete(yfInte
+0001aaa0: 7276 616c 5374 6172 7473 2c20 6929 0a20  rvalStarts, i). 
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001aad0: 6e74 6572 7661 6c73 203d 2069 6e74 6572  ntervals = inter
+0001aae0: 7661 6c73 2e64 726f 7028 6474 290a 2020  vals.drop(dt).  
+0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab00: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001ab10: 203d 2064 662e 6472 6f70 2864 7429 0a20   = df.drop(dt). 
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab30: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001ab40: 203d 2064 662e 7368 6170 655b 305d 0a20   = df.shape[0]. 
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001ab70: 5f6e 6120 3d20 696e 7465 7276 616c 735b  _na = intervals[
+0001ab80: 2269 6e74 6572 7661 6c5f 6f70 656e 225d  "interval_open"]
+0001ab90: 2e69 736e 6128 292e 746f 5f6e 756d 7079  .isna().to_numpy
+0001aba0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001abb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001abc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abe0: 2020 2020 2023 2050 7265 7669 6f75 7320       # Previous 
+0001abf0: 696e 7465 7276 616c 2074 6f6f 2066 6172  interval too far
+0001ac00: 2c20 6d75 7374 2069 6e73 6572 7420 6120  , must insert a 
+0001ac10: 6e65 7720 696e 7465 7276 616c 0a20 2020  new interval.   
+0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac30: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001ac40: 7365 2045 7863 6570 7469 6f6e 2822 7468  se Exception("th
+0001ac50: 6973 2063 6f64 6520 7061 7468 206e 6f74  is code path not
+0001ac60: 2074 6573 7465 642c 2072 6576 6965 7722   tested, review"
+0001ac70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac90: 2020 6474 5f63 6f72 7265 6374 203d 2064    dt_correct = d
+0001aca0: 745f 6265 666f 7265 202b 2073 656c 662e  t_before + self.
+0001acb0: 6974 640a 2020 2020 2020 2020 2020 2020  itd.            
+0001acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acd0: 2020 2020 6966 2064 745f 636f 7272 6563      if dt_correc
+0001ace0: 7420 3e3d 2064 743a 0a20 2020 2020 2020  t >= dt:.       
+0001acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001ad10: 7365 2045 7863 6570 7469 6f6e 2866 2264  se Exception(f"d
+0001ad20: 745f 636f 7272 6563 743d 7b64 745f 636f  t_correct={dt_co
+0001ad30: 7272 6563 747d 203e 3d20 6474 3d7b 6474  rrect} >= dt={dt
+0001ad40: 7d20 2c20 6578 7065 6374 6564 203c 2229  } , expected <")
+0001ad50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad70: 2069 6620 6474 5f63 6f72 7265 6374 2e64   if dt_correct.d
+0001ad80: 6174 6528 2920 213d 2064 742e 6461 7465  ate() != dt.date
+0001ad90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adb0: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0001adc0: 6365 7074 696f 6e28 6622 6474 5f63 6f72  ception(f"dt_cor
+0001add0: 7265 6374 3d7b 6474 5f63 6f72 7265 6374  rect={dt_correct
+0001ade0: 7d20 2620 6474 3d7b 6474 7d20 2c20 6578  } & dt={dt} , ex
+0001adf0: 7065 6374 6564 2073 616d 6520 6461 7922  pected same day"
+0001ae00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae20: 2020 6466 2e6c 6f63 5b64 745f 636f 7272    df.loc[dt_corr
+0001ae30: 6563 745d 203d 2064 662e 6c6f 635b 6474  ect] = df.loc[dt
+0001ae40: 5d20 3b20 6466 203d 2064 662e 6472 6f70  ] ; df = df.drop
+0001ae50: 2864 7429 2e73 6f72 745f 696e 6465 7828  (dt).sort_index(
+0001ae60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae80: 2020 7966 496e 7465 7276 616c 5374 6172    yfIntervalStar
+0001ae90: 7473 5b69 5d20 3d20 6474 5f63 6f72 7265  ts[i] = dt_corre
+0001aea0: 6374 0a20 2020 2020 2020 2020 2020 2020  ct.             
+0001aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aec0: 2020 2069 6e74 6572 7661 6c73 203d 2069     intervals = i
+0001aed0: 6e74 6572 7661 6c73 2e64 726f 7028 6474  ntervals.drop(dt
+0001aee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af00: 2020 696e 7465 7276 616c 732e 6c6f 635b    intervals.loc[
+0001af10: 6474 5f63 6f72 7265 6374 5d20 3d20 7b22  dt_correct] = {"
+0001af20: 696e 7465 7276 616c 5f6f 7065 6e22 3a20  interval_open": 
+0001af30: 6474 5f63 6f72 7265 6374 2c20 2269 6e74  dt_correct, "int
+0001af40: 6572 7661 6c5f 636c 6f73 6522 3a20 6466  erval_close": df
+0001af50: 322e 6c6f 635b 6474 2c20 226d 6172 6b65  2.loc[dt, "marke
+0001af60: 745f 636c 6f73 6522 5d7d 0a20 2020 2020  t_close"]}.     
+0001af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af80: 2020 2020 2020 2020 2020 2066 5f6e 6120             f_na 
+0001af90: 3d20 696e 7465 7276 616c 735b 2269 6e74  = intervals["int
+0001afa0: 6572 7661 6c5f 6f70 656e 225d 2e69 736e  erval_open"].isn
+0001afb0: 6128 292e 746f 5f6e 756d 7079 2829 0a0a  a().to_numpy()..
+0001afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001afd0: 6966 2066 5f6e 612e 616e 7928 293a 0a20  if f_na.any():. 
+0001afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aff0: 2020 2066 5f6e 6f5f 6469 7673 5f73 706c     f_no_divs_spl
+0001b000: 6974 7320 3d20 2864 665b 2744 6976 6964  its = (df['Divid
+0001b010: 656e 6473 275d 3d3d 3029 2e74 6f5f 6e75  ends']==0).to_nu
+0001b020: 6d70 7928 2920 2620 2864 665b 2753 746f  mpy() & (df['Sto
+0001b030: 636b 2053 706c 6974 7327 5d3d 3d30 292e  ck Splits']==0).
+0001b040: 746f 5f6e 756d 7079 2829 0a0a 2020 2020  to_numpy()..    
+0001b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b060: 2320 466f 7220 736f 6d65 206e 6174 696f  # For some natio
+0001b070: 6e61 6c20 686f 6c69 6461 7973 2077 6865  nal holidays whe
+0001b080: 6e20 6578 6368 616e 6765 2063 6c6f 7365  n exchange close
+0001b090: 642c 2059 6168 6f6f 2066 696c 6c73 2069  d, Yahoo fills i
+0001b0a0: 6e20 726f 772e 2043 6c75 6520 6973 2030  n row. Clue is 0
+0001b0b0: 2076 6f6c 756d 652e 0a20 2020 2020 2020   volume..       
+0001b0c0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+0001b0d0: 6f6c 7574 696f 6e20 3d20 6472 6f70 3a0a  olution = drop:.
+0001b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0f0: 2020 2020 665f 6e61 5f7a 6572 6f56 6f6c      f_na_zeroVol
+0001b100: 203d 2066 5f6e 6120 2620 2864 665b 2256   = f_na & (df["V
+0001b110: 6f6c 756d 6522 5d20 3d3d 2030 292e 746f  olume"] == 0).to
+0001b120: 5f6e 756d 7079 2829 0a20 2020 2020 2020  _numpy().       
+0001b130: 2020 2020 2020 2020 2020 2020 2066 5f6e               f_n
+0001b140: 615f 7a65 726f 566f 6c20 3d20 665f 6e61  a_zeroVol = f_na
+0001b150: 5f7a 6572 6f56 6f6c 2026 2066 5f6e 6f5f  _zeroVol & f_no_
+0001b160: 6469 7673 5f73 706c 6974 730a 2020 2020  divs_splits.    
+0001b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b180: 6966 2066 5f6e 615f 7a65 726f 566f 6c2e  if f_na_zeroVol.
+0001b190: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b1b0: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
+0001b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1d0: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
+0001b1e0: 2d20 6472 6f70 7069 6e67 207b 7d20 302d  - dropping {} 0-
+0001b1f0: 766f 6c75 6d65 2072 6f77 7320 7769 7468  volume rows with
+0001b200: 206e 6f20 6d61 7463 6869 6e67 2069 6e74   no matching int
+0001b210: 6572 7661 6c22 2e66 6f72 6d61 7428 7375  erval".format(su
+0001b220: 6d28 665f 6e61 5f7a 6572 6f56 6f6c 2929  m(f_na_zeroVol))
+0001b230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b240: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+0001b250: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+0001b260: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+0001b270: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+0001b280: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
+0001b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2a0: 2020 2020 2066 5f64 726f 7020 3d20 665f       f_drop = f_
+0001b2b0: 6e61 5f7a 6572 6f56 6f6c 0a20 2020 2020  na_zeroVol.     
+0001b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2d0: 2020 2079 6649 6e74 6572 7661 6c53 7461     yfIntervalSta
+0001b2e0: 7274 7320 3d20 7966 496e 7465 7276 616c  rts = yfInterval
+0001b2f0: 5374 6172 7473 5b7e 665f 6472 6f70 5d0a  Starts[~f_drop].
 0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b310: 2020 2020 2020 7966 496e 7465 7276 616c        yfInterval
-0001b320: 5374 6172 7473 203d 206e 702e 6465 6c65  Starts = np.dele
-0001b330: 7465 2879 6649 6e74 6572 7661 6c53 7461  te(yfIntervalSta
-0001b340: 7274 732c 2069 290a 2020 2020 2020 2020  rts, i).        
-0001b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b360: 2020 2020 2020 2020 696e 7465 7276 616c          interval
-0001b370: 7320 3d20 696e 7465 7276 616c 732e 6472  s = intervals.dr
-0001b380: 6f70 2864 7429 0a20 2020 2020 2020 2020  op(dt).         
+0001b310: 2020 2020 2020 2020 696e 7465 7276 616c          interval
+0001b320: 7320 3d20 696e 7465 7276 616c 735b 7e66  s = intervals[~f
+0001b330: 5f64 726f 705d 0a20 2020 2020 2020 2020  _drop].         
+0001b340: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001b350: 6620 3d20 6466 5b7e 665f 6472 6f70 5d0a  f = df[~f_drop].
+0001b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b370: 2020 2020 2020 2020 6e20 3d20 6466 2e73          n = df.s
+0001b380: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
 0001b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3a0: 2020 2020 2020 2064 6620 3d20 6466 2e64         df = df.d
-0001b3b0: 726f 7028 6474 290a 2020 2020 2020 2020  rop(dt).        
-0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3d0: 2020 2020 2020 2020 6e20 3d20 6466 2e73          n = df.s
-0001b3e0: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b400: 2020 2020 2020 2020 665f 6e61 203d 2069          f_na = i
-0001b410: 6e74 6572 7661 6c73 5b22 696e 7465 7276  ntervals["interv
-0001b420: 616c 5f6f 7065 6e22 5d2e 6973 6e61 2829  al_open"].isna()
-0001b430: 2e74 6f5f 6e75 6d70 7928 290a 2020 2020  .to_numpy().    
-0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b450: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b470: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b480: 5072 6576 696f 7573 2069 6e74 6572 7661  Previous interva
-0001b490: 6c20 746f 6f20 6661 722c 206d 7573 7420  l too far, must 
-0001b4a0: 696e 7365 7274 2061 206e 6577 2069 6e74  insert a new int
-0001b4b0: 6572 7661 6c0a 2020 2020 2020 2020 2020  erval.          
+0001b3a0: 665f 6e61 203d 2069 6e74 6572 7661 6c73  f_na = intervals
+0001b3b0: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
+0001b3c0: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
+0001b3d0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0001b3e0: 2020 2020 2020 2020 2020 2020 665f 6e6f              f_no
+0001b3f0: 5f64 6976 735f 7370 6c69 7473 203d 2028  _divs_splits = (
+0001b400: 6466 5b27 4469 7669 6465 6e64 7327 5d3d  df['Dividends']=
+0001b410: 3d30 292e 746f 5f6e 756d 7079 2829 2026  =0).to_numpy() &
+0001b420: 2028 6466 5b27 5374 6f63 6b20 5370 6c69   (df['Stock Spli
+0001b430: 7473 275d 3d3d 3029 2e74 6f5f 6e75 6d70  ts']==0).to_nump
+0001b440: 7928 290a 0a20 2020 2020 2020 2020 2020  y()..           
+0001b450: 2020 2020 2020 2020 2023 202e 2e2e 2061           # ... a
+0001b460: 6e6f 7468 6572 2063 6c75 6520 6973 2072  nother clue is r
+0001b470: 6f77 2069 7320 6964 656e 7469 6361 6c20  ow is identical 
+0001b480: 746f 2070 7265 7669 6f75 7320 7472 6164  to previous trad
+0001b490: 696e 6720 6461 790a 2020 2020 2020 2020  ing day.        
+0001b4a0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+0001b4b0: 5f6e 612e 616e 7928 293a 0a20 2020 2020  _na.any():.     
 0001b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4d0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0001b4e0: 7074 696f 6e28 2274 6869 7320 636f 6465  ption("this code
-0001b4f0: 2070 6174 6820 6e6f 7420 7465 7374 6564   path not tested
-0001b500: 2c20 7265 7669 6577 2229 0a20 2020 2020  , review").     
-0001b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b520: 2020 2020 2020 2020 2020 2064 745f 636f             dt_co
-0001b530: 7272 6563 7420 3d20 6474 5f62 6566 6f72  rrect = dt_befor
-0001b540: 6520 2b20 7365 6c66 2e69 7464 0a20 2020  e + self.itd.   
+0001b4d0: 2020 2066 5f64 726f 7020 3d20 6e70 2e61     f_drop = np.a
+0001b4e0: 7272 6179 285b 4661 6c73 655d 2a6e 290a  rray([False]*n).
+0001b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b500: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0001b510: 206e 702e 7768 6572 6528 665f 6e61 295b   np.where(f_na)[
+0001b520: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
+0001b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b540: 6966 2069 203e 2030 3a0a 2020 2020 2020  if i > 0:.      
 0001b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b560: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001b570: 6474 5f63 6f72 7265 6374 203e 3d20 6474  dt_correct >= dt
-0001b580: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b5a0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0001b5b0: 7074 696f 6e28 6622 6474 5f63 6f72 7265  ption(f"dt_corre
-0001b5c0: 6374 3d7b 6474 5f63 6f72 7265 6374 7d20  ct={dt_correct} 
-0001b5d0: 3e3d 2064 743d 7b64 747d 202c 2065 7870  >= dt={dt} , exp
-0001b5e0: 6563 7465 6420 3c22 290a 2020 2020 2020  ected <").      
-0001b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b600: 2020 2020 2020 2020 2020 6966 2064 745f            if dt_
-0001b610: 636f 7272 6563 742e 6461 7465 2829 2021  correct.date() !
-0001b620: 3d20 6474 2e64 6174 6528 293a 0a20 2020  = dt.date():.   
+0001b560: 2020 2020 2020 2020 2020 6474 203d 2064            dt = d
+0001b570: 662e 696e 6465 785b 695d 0a20 2020 2020  f.index[i].     
+0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b590: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+0001b5a0: 6474 203d 2064 662e 696e 6465 785b 692d  dt = df.index[i-
+0001b5b0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+0001b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5d0: 2020 2069 6620 2864 662e 6c6f 635b 6474     if (df.loc[dt
+0001b5e0: 2c20 7966 6364 2e79 665f 6461 7461 5f63  , yfcd.yf_data_c
+0001b5f0: 6f6c 735d 203d 3d20 6466 2e6c 6f63 5b6c  ols] == df.loc[l
+0001b600: 6173 745f 6474 2c20 7966 6364 2e79 665f  ast_dt, yfcd.yf_
+0001b610: 6461 7461 5f63 6f6c 735d 292e 616c 6c28  data_cols]).all(
+0001b620: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
 0001b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b650: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0001b660: 2866 2264 745f 636f 7272 6563 743d 7b64  (f"dt_correct={d
-0001b670: 745f 636f 7272 6563 747d 2026 2064 743d  t_correct} & dt=
-0001b680: 7b64 747d 202c 2065 7870 6563 7465 6420  {dt} , expected 
-0001b690: 7361 6d65 2064 6179 2229 0a20 2020 2020  same day").     
-0001b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b6b0: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
-0001b6c0: 635b 6474 5f63 6f72 7265 6374 5d20 3d20  c[dt_correct] = 
-0001b6d0: 6466 2e6c 6f63 5b64 745d 203b 2064 6620  df.loc[dt] ; df 
-0001b6e0: 3d20 6466 2e64 726f 7028 6474 292e 736f  = df.drop(dt).so
-0001b6f0: 7274 5f69 6e64 6578 2829 0a20 2020 2020  rt_index().     
-0001b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b710: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
-0001b720: 6572 7661 6c53 7461 7274 735b 695d 203d  ervalStarts[i] =
-0001b730: 2064 745f 636f 7272 6563 740a 2020 2020   dt_correct.    
-0001b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b750: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-0001b760: 7276 616c 7320 3d20 696e 7465 7276 616c  rvals = interval
-0001b770: 732e 6472 6f70 2864 7429 0a20 2020 2020  s.drop(dt).     
+0001b640: 2020 2020 2020 2066 5f64 726f 705b 695d         f_drop[i]
+0001b650: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b670: 6966 2066 5f64 726f 702e 616e 7928 293a  if f_drop.any():
+0001b680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b690: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b6a0: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+0001b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6c0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+0001b6d0: 2022 2d20 6472 6f70 7069 6e67 2072 6f77   "- dropping row
+0001b6e0: 7320 7769 7468 206e 6f20 696e 7465 7276  s with no interv
+0001b6f0: 616c 2074 6861 7420 6172 6520 6964 656e  al that are iden
+0001b700: 7469 6361 6c20 746f 2070 7265 7669 6f75  tical to previou
+0001b710: 7320 726f 7722 0a20 2020 2020 2020 2020  s row".         
+0001b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b730: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+0001b740: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+0001b750: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+0001b760: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+0001b770: 7428 6d73 6729 0a20 2020 2020 2020 2020  t(msg).         
 0001b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b790: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-0001b7a0: 7661 6c73 2e6c 6f63 5b64 745f 636f 7272  vals.loc[dt_corr
-0001b7b0: 6563 745d 203d 207b 2269 6e74 6572 7661  ect] = {"interva
-0001b7c0: 6c5f 6f70 656e 223a 2064 745f 636f 7272  l_open": dt_corr
-0001b7d0: 6563 742c 2022 696e 7465 7276 616c 5f63  ect, "interval_c
-0001b7e0: 6c6f 7365 223a 2064 6632 2e6c 6f63 5b64  lose": df2.loc[d
-0001b7f0: 742c 2022 6d61 726b 6574 5f63 6c6f 7365  t, "market_close
-0001b800: 225d 7d0a 2020 2020 2020 2020 2020 2020  "]}.            
-0001b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b820: 2020 2020 665f 6e61 203d 2069 6e74 6572      f_na = inter
-0001b830: 7661 6c73 5b22 696e 7465 7276 616c 5f6f  vals["interval_o
-0001b840: 7065 6e22 5d2e 6973 6e61 2829 2e74 6f5f  pen"].isna().to_
-0001b850: 6e75 6d70 7928 290a 0a20 2020 2020 2020  numpy()..       
-0001b860: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
-0001b870: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-0001b880: 2020 2020 2020 2020 2020 2020 665f 6e6f              f_no
-0001b890: 5f64 6976 735f 7370 6c69 7473 203d 2028  _divs_splits = (
-0001b8a0: 6466 5b27 4469 7669 6465 6e64 7327 5d3d  df['Dividends']=
-0001b8b0: 3d30 292e 746f 5f6e 756d 7079 2829 2026  =0).to_numpy() &
-0001b8c0: 2028 6466 5b27 5374 6f63 6b20 5370 6c69   (df['Stock Spli
-0001b8d0: 7473 275d 3d3d 3029 2e74 6f5f 6e75 6d70  ts']==0).to_nump
-0001b8e0: 7928 290a 0a20 2020 2020 2020 2020 2020  y()..           
-0001b8f0: 2020 2020 2020 2020 2023 2046 6f72 2073           # For s
-0001b900: 6f6d 6520 6e61 7469 6f6e 616c 2068 6f6c  ome national hol
-0001b910: 6964 6179 7320 7768 656e 2065 7863 6861  idays when excha
-0001b920: 6e67 6520 636c 6f73 6564 2c20 5961 686f  nge closed, Yaho
-0001b930: 6f20 6669 6c6c 7320 696e 2072 6f77 2e20  o fills in row. 
-0001b940: 436c 7565 2069 7320 3020 766f 6c75 6d65  Clue is 0 volume
-0001b950: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001b960: 2020 2020 2020 2320 536f 6c75 7469 6f6e        # Solution
-0001b970: 203d 2064 726f 703a 0a20 2020 2020 2020   = drop:.       
-0001b980: 2020 2020 2020 2020 2020 2020 2066 5f6e               f_n
-0001b990: 615f 7a65 726f 566f 6c20 3d20 665f 6e61  a_zeroVol = f_na
-0001b9a0: 2026 2028 6466 5b22 566f 6c75 6d65 225d   & (df["Volume"]
-0001b9b0: 203d 3d20 3029 2e74 6f5f 6e75 6d70 7928   == 0).to_numpy(
-0001b9c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001b9d0: 2020 2020 2020 665f 6e61 5f7a 6572 6f56        f_na_zeroV
-0001b9e0: 6f6c 203d 2066 5f6e 615f 7a65 726f 566f  ol = f_na_zeroVo
-0001b9f0: 6c20 2620 665f 6e6f 5f64 6976 735f 7370  l & f_no_divs_sp
-0001ba00: 6c69 7473 0a20 2020 2020 2020 2020 2020  lits.           
-0001ba10: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
-0001ba20: 5f7a 6572 6f56 6f6c 2e61 6e79 2829 3a0a  _zeroVol.any():.
+0001b790: 2020 2079 6649 6e74 6572 7661 6c53 7461     yfIntervalSta
+0001b7a0: 7274 7320 3d20 7966 496e 7465 7276 616c  rts = yfInterval
+0001b7b0: 5374 6172 7473 5b7e 665f 6472 6f70 5d0a  Starts[~f_drop].
+0001b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7d0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+0001b7e0: 7276 616c 7320 3d20 696e 7465 7276 616c  rvals = interval
+0001b7f0: 735b 7e66 5f64 726f 705d 0a20 2020 2020  s[~f_drop].     
+0001b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b810: 2020 2020 2020 2064 6620 3d20 6466 5b7e         df = df[~
+0001b820: 665f 6472 6f70 5d0a 2020 2020 2020 2020  f_drop].        
+0001b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b840: 2020 2020 6e20 3d20 6466 2e73 6861 7065      n = df.shape
+0001b850: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0001b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b870: 665f 6e61 203d 2069 6e74 6572 7661 6c73  f_na = intervals
+0001b880: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
+0001b890: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
+0001b8a0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0001b8b0: 2020 2020 2020 2020 2020 2020 665f 6e6f              f_no
+0001b8c0: 5f64 6976 735f 7370 6c69 7473 203d 2028  _divs_splits = (
+0001b8d0: 6466 5b27 4469 7669 6465 6e64 7327 5d3d  df['Dividends']=
+0001b8e0: 3d30 292e 746f 5f6e 756d 7079 2829 2026  =0).to_numpy() &
+0001b8f0: 2028 6466 5b27 5374 6f63 6b20 5370 6c69   (df['Stock Spli
+0001b900: 7473 275d 3d3d 3029 2e74 6f5f 6e75 6d70  ts']==0).to_nump
+0001b910: 7928 290a 0a20 2020 2020 2020 2020 2020  y()..           
+0001b920: 2020 2020 2020 2020 2023 202e 2e2e 2061           # ... a
+0001b930: 6e64 2061 6e6f 7468 6572 2063 6c75 6520  nd another clue 
+0001b940: 6973 204f 7065 6e3d 4869 6768 3d4c 6f77  is Open=High=Low
+0001b950: 3d30 2e30 0a20 2020 2020 2020 2020 2020  =0.0.           
+0001b960: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
+0001b970: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+0001b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b990: 665f 7a65 726f 203d 2028 6466 5b27 4f70  f_zero = (df['Op
+0001b9a0: 656e 275d 3d3d 3029 2e74 6f5f 6e75 6d70  en']==0).to_nump
+0001b9b0: 7928 2920 2620 2864 665b 274c 6f77 275d  y() & (df['Low']
+0001b9c0: 3d3d 3029 2e74 6f5f 6e75 6d70 7928 2920  ==0).to_numpy() 
+0001b9d0: 2620 2864 665b 2748 6967 6827 5d3d 3d30  & (df['High']==0
+0001b9e0: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
+0001b9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba00: 2020 2020 2066 5f7a 6572 6f20 3d20 665f       f_zero = f_
+0001ba10: 7a65 726f 2026 2066 5f6e 6f5f 6469 7673  zero & f_no_divs
+0001ba20: 5f73 706c 6974 730a 2020 2020 2020 2020  _splits.        
 0001ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba40: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-0001ba50: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+0001ba40: 665f 6e61 5f7a 6572 6f20 3d20 665f 6e61  f_na_zero = f_na
+0001ba50: 2026 2066 5f7a 6572 6f0a 2020 2020 2020   & f_zero.      
 0001ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba70: 2020 6d73 6720 3d20 222d 2064 726f 7070    msg = "- dropp
-0001ba80: 696e 6720 7b7d 2030 2d76 6f6c 756d 6520  ing {} 0-volume 
-0001ba90: 726f 7773 2077 6974 6820 6e6f 206d 6174  rows with no mat
-0001baa0: 6368 696e 6720 696e 7465 7276 616c 222e  ching interval".
-0001bab0: 666f 726d 6174 2873 756d 2866 5f6e 615f  format(sum(f_na_
-0001bac0: 7a65 726f 566f 6c29 290a 2020 2020 2020  zeroVol)).      
-0001bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bae0: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-0001baf0: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
-0001bb00: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-0001bb10: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
-0001bb20: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
-0001bb30: 2020 2020 2020 2020 2020 2020 2020 665f                f_
-0001bb40: 6472 6f70 203d 2066 5f6e 615f 7a65 726f  drop = f_na_zero
-0001bb50: 566f 6c0a 2020 2020 2020 2020 2020 2020  Vol.            
-0001bb60: 2020 2020 2020 2020 2020 2020 7966 496e              yfIn
-0001bb70: 7465 7276 616c 5374 6172 7473 203d 2079  tervalStarts = y
-0001bb80: 6649 6e74 6572 7661 6c53 7461 7274 735b  fIntervalStarts[
-0001bb90: 7e66 5f64 726f 705d 0a20 2020 2020 2020  ~f_drop].       
-0001bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbb0: 2069 6e74 6572 7661 6c73 203d 2069 6e74   intervals = int
-0001bbc0: 6572 7661 6c73 5b7e 665f 6472 6f70 5d0a  ervals[~f_drop].
-0001bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbe0: 2020 2020 2020 2020 6466 203d 2064 665b          df = df[
-0001bbf0: 7e66 5f64 726f 705d 0a20 2020 2020 2020  ~f_drop].       
+0001ba70: 2020 6966 2066 5f6e 615f 7a65 726f 2e61    if f_na_zero.a
+0001ba80: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+0001ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001baa0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+0001bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bad0: 6d73 6720 3d20 222d 2064 726f 7070 696e  msg = "- droppin
+0001bae0: 6720 7b7d 2070 7269 6365 3d30 2072 6f77  g {} price=0 row
+0001baf0: 7320 7769 7468 206e 6f20 6d61 7463 6869  s with no matchi
+0001bb00: 6e67 2069 6e74 6572 7661 6c22 2e66 6f72  ng interval".for
+0001bb10: 6d61 7428 7375 6d28 665f 6e61 5f7a 6572  mat(sum(f_na_zer
+0001bb20: 6f29 290a 2020 2020 2020 2020 2020 2020  o)).            
+0001bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb40: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+0001bb50: 696e 7428 6d73 6729 2069 6620 7966 636c  int(msg) if yfcl
+0001bb60: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+0001bb70: 6428 2920 656c 7365 2070 7269 6e74 286d  d() else print(m
+0001bb80: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
+0001bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bba0: 665f 6472 6f70 203d 2066 5f6e 615f 7a65  f_drop = f_na_ze
+0001bbb0: 726f 0a20 2020 2020 2020 2020 2020 2020  ro.             
+0001bbc0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001bbd0: 6649 6e74 6572 7661 6c53 7461 7274 7320  fIntervalStarts 
+0001bbe0: 3d20 7966 496e 7465 7276 616c 5374 6172  = yfIntervalStar
+0001bbf0: 7473 5b7e 665f 6472 6f70 5d0a 2020 2020  ts[~f_drop].    
 0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 206e 203d 2064 662e 7368 6170 655b 305d   n = df.shape[0]
-0001bc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bc30: 2020 2020 2020 2020 2066 5f6e 6120 3d20           f_na = 
-0001bc40: 696e 7465 7276 616c 735b 2269 6e74 6572  intervals["inter
-0001bc50: 7661 6c5f 6f70 656e 225d 2e69 736e 6128  val_open"].isna(
-0001bc60: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
+0001bc10: 2020 2020 2020 2020 696e 7465 7276 616c          interval
+0001bc20: 7320 3d20 696e 7465 7276 616c 735b 7e66  s = intervals[~f
+0001bc30: 5f64 726f 705d 0a20 2020 2020 2020 2020  _drop].         
+0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc50: 2020 2064 6620 3d20 6466 5b7e 665f 6472     df = df[~f_dr
+0001bc60: 6f70 5d0a 2020 2020 2020 2020 2020 2020  op].            
 0001bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc80: 2020 2020 2066 5f6e 6f5f 6469 7673 5f73       f_no_divs_s
-0001bc90: 706c 6974 7320 3d20 2864 665b 2744 6976  plits = (df['Div
-0001bca0: 6964 656e 6473 275d 3d3d 3029 2e74 6f5f  idends']==0).to_
-0001bcb0: 6e75 6d70 7928 2920 2620 2864 665b 2753  numpy() & (df['S
-0001bcc0: 746f 636b 2053 706c 6974 7327 5d3d 3d30  tock Splits']==0
-0001bcd0: 292e 746f 5f6e 756d 7079 2829 0a0a 2020  ).to_numpy()..  
-0001bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bcf0: 2020 2320 2e2e 2e20 616e 6f74 6865 7220    # ... another 
-0001bd00: 636c 7565 2069 7320 726f 7720 6973 2069  clue is row is i
-0001bd10: 6465 6e74 6963 616c 2074 6f20 7072 6576  dentical to prev
-0001bd20: 696f 7573 2074 7261 6469 6e67 2064 6179  ious trading day
-0001bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bd40: 2020 2020 2069 6620 665f 6e61 2e61 6e79       if f_na.any
-0001bd50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001bd60: 2020 2020 2020 2020 2020 2020 665f 6472              f_dr
-0001bd70: 6f70 203d 206e 702e 6172 7261 7928 5b46  op = np.array([F
-0001bd80: 616c 7365 5d2a 6e29 0a20 2020 2020 2020  alse]*n).       
-0001bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bda0: 2066 6f72 2069 2069 6e20 6e70 2e77 6865   for i in np.whe
-0001bdb0: 7265 2866 5f6e 6129 5b30 5d3a 0a20 2020  re(f_na)[0]:.   
-0001bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bdd0: 2020 2020 2020 2020 2069 6620 6920 3e20           if i > 
-0001bde0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0001bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be00: 2020 2064 7420 3d20 6466 2e69 6e64 6578     dt = df.index
-0001be10: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
+0001bc80: 6e20 3d20 6466 2e73 6861 7065 5b30 5d0a  n = df.shape[0].
+0001bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bca0: 2020 2020 2020 2020 2020 2020 665f 6e61              f_na
+0001bcb0: 203d 2069 6e74 6572 7661 6c73 5b22 696e   = intervals["in
+0001bcc0: 7465 7276 616c 5f6f 7065 6e22 5d2e 6973  terval_open"].is
+0001bcd0: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
+0001bce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bcf0: 2069 6620 665f 6e61 2e61 6e79 2829 2061   if f_na.any() a
+0001bd00: 6e64 2073 656c 662e 696e 7465 7276 616c  nd self.interval
+0001bd10: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+0001bd20: 6c2e 4d69 6e73 313a 0a20 2020 2020 2020  l.Mins1:.       
+0001bd30: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0001bd40: 6620 312d 6d69 6e75 7465 2069 6e74 6572  f 1-minute inter
+0001bd50: 7661 6c20 6174 206d 6172 6b65 7420 636c  val at market cl
+0001bd60: 6f73 652c 2074 6865 6e20 6d65 7267 6520  ose, then merge 
+0001bd70: 7769 7468 2070 7265 7669 6f75 7320 6d69  with previous mi
+0001bd80: 6e75 7465 0a20 2020 2020 2020 2020 2020  nute.           
+0001bd90: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
+0001bda0: 203d 2073 6f72 7465 6428 6e70 2e77 6865   = sorted(np.whe
+0001bdb0: 7265 2866 5f6e 6129 5b30 5d2c 2072 6576  re(f_na)[0], rev
+0001bdc0: 6572 7365 3d54 7275 6529 0a20 2020 2020  erse=True).     
+0001bdd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001bde0: 6f72 2069 6478 2069 6e20 696e 6469 6365  or idx in indice
+0001bdf0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001be00: 2020 2020 2020 2020 2020 2064 7420 3d20             dt = 
+0001be10: 6466 2e69 6e64 6578 5b69 6478 5d0a 2020  df.index[idx].  
 0001be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be30: 2020 2020 6c61 7374 5f64 7420 3d20 6466      last_dt = df
-0001be40: 2e69 6e64 6578 5b69 2d31 5d0a 2020 2020  .index[i-1].    
-0001be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be60: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0001be70: 6466 2e6c 6f63 5b64 742c 2079 6663 642e  df.loc[dt, yfcd.
-0001be80: 7966 5f64 6174 615f 636f 6c73 5d20 3d3d  yf_data_cols] ==
-0001be90: 2064 662e 6c6f 635b 6c61 7374 5f64 742c   df.loc[last_dt,
-0001bea0: 2079 6663 642e 7966 5f64 6174 615f 636f   yfcd.yf_data_co
-0001beb0: 6c73 5d29 2e61 6c6c 2829 3a0a 2020 2020  ls]).all():.    
-0001bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be30: 2020 2020 2020 7363 6865 6420 3d20 7966        sched = yf
+0001be40: 6374 2e47 6574 4578 6368 616e 6765 5363  ct.GetExchangeSc
+0001be50: 6865 6475 6c65 2873 656c 662e 6578 6368  hedule(self.exch
+0001be60: 616e 6765 2c20 6474 2e64 6174 6528 292c  ange, dt.date(),
+0001be70: 2064 742e 6461 7465 2829 2b74 645f 3164   dt.date()+td_1d
+0001be80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001be90: 2020 2020 2020 2020 2020 6966 2064 742e            if dt.
+0001bea0: 7469 6d65 2829 203d 3d20 7363 6865 645b  time() == sched[
+0001beb0: 2263 6c6f 7365 225d 2e69 6c6f 635b 305d  "close"].iloc[0]
+0001bec0: 2e74 696d 6528 293a 0a20 2020 2020 2020  .time():.       
 0001bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bee0: 665f 6472 6f70 5b69 5d20 3d20 5472 7565  f_drop[i] = True
-0001bef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bf00: 2020 2020 2020 2020 2069 6620 665f 6472           if f_dr
-0001bf10: 6f70 2e61 6e79 2829 3a0a 2020 2020 2020  op.any():.      
+0001bee0: 2020 2020 2069 6620 6964 7820 3d3d 2030       if idx == 0
+0001bef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf10: 2020 2320 4469 7363 6172 640a 2020 2020    # Discard.    
 0001bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf30: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
-0001bf40: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+0001bf30: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001bf40: 7428 2264 6973 6361 7264 696e 6722 290a  t("discarding").
 0001bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf60: 2020 2020 6d73 6720 3d20 222d 2064 726f      msg = "- dro
-0001bf70: 7070 696e 6720 726f 7773 2077 6974 6820  pping rows with 
-0001bf80: 6e6f 2069 6e74 6572 7661 6c20 7468 6174  no interval that
-0001bf90: 2061 7265 2069 6465 6e74 6963 616c 2074   are identical t
-0001bfa0: 6f20 7072 6576 696f 7573 2072 6f77 220a  o previous row".
-0001bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfd0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-0001bfe0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-0001bff0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-0001c000: 656c 7365 2070 7269 6e74 286d 7367 290a  else print(msg).
-0001c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c020: 2020 2020 2020 2020 2020 2020 7966 496e              yfIn
-0001c030: 7465 7276 616c 5374 6172 7473 203d 2079  tervalStarts = y
-0001c040: 6649 6e74 6572 7661 6c53 7461 7274 735b  fIntervalStarts[
-0001c050: 7e66 5f64 726f 705d 0a20 2020 2020 2020  ~f_drop].       
-0001c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c070: 2020 2020 2069 6e74 6572 7661 6c73 203d       intervals =
-0001c080: 2069 6e74 6572 7661 6c73 5b7e 665f 6472   intervals[~f_dr
-0001c090: 6f70 5d0a 2020 2020 2020 2020 2020 2020  op].            
-0001c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0b0: 6466 203d 2064 665b 7e66 5f64 726f 705d  df = df[~f_drop]
-0001c0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c0d0: 2020 2020 2020 2020 2020 2020 206e 203d               n =
-0001c0e0: 2064 662e 7368 6170 655b 305d 0a20 2020   df.shape[0].   
-0001c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c100: 2020 2020 2020 2020 2066 5f6e 6120 3d20           f_na = 
-0001c110: 696e 7465 7276 616c 735b 2269 6e74 6572  intervals["inter
-0001c120: 7661 6c5f 6f70 656e 225d 2e69 736e 6128  val_open"].isna(
-0001c130: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
+0001bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf70: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0001bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bfb0: 2020 2020 2020 2070 7269 6e74 2822 6d65         print("me
+0001bfc0: 7267 696e 6722 290a 2020 2020 2020 2020  rging").        
+0001bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bfe0: 2020 2020 2020 2020 2320 4d65 7267 6520          # Merge 
+0001bff0: 7769 7468 2070 7265 7669 6f75 730a 2020  with previous.  
+0001c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c010: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+0001c020: 3120 3d20 6466 2e69 6e64 6578 5b69 6478  1 = df.index[idx
+0001c030: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+0001c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c050: 2020 2020 6466 2e6c 6f63 5b64 7431 2c20      df.loc[dt1, 
+0001c060: 2243 6c6f 7365 225d 203d 2064 665b 2243  "Close"] = df["C
+0001c070: 6c6f 7365 225d 2e69 6c6f 635b 6964 785d  lose"].iloc[idx]
+0001c080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c0a0: 2064 662e 6c6f 635b 6474 312c 2022 4869   df.loc[dt1, "Hi
+0001c0b0: 6768 225d 203d 2064 665b 2248 6967 6822  gh"] = df["High"
+0001c0c0: 5d2e 696c 6f63 5b69 6478 2d31 3a69 6478  ].iloc[idx-1:idx
+0001c0d0: 2b31 5d2e 6d61 7828 290a 2020 2020 2020  +1].max().      
+0001c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c0f0: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
+0001c100: 5b64 7431 2c20 224c 6f77 225d 203d 2064  [dt1, "Low"] = d
+0001c110: 665b 224c 6f77 225d 2e69 6c6f 635b 6964  f["Low"].iloc[id
+0001c120: 782d 313a 6964 782b 315d 2e6d 696e 2829  x-1:idx+1].min()
+0001c130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0001c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c150: 2020 2020 2066 5f6e 6f5f 6469 7673 5f73       f_no_divs_s
-0001c160: 706c 6974 7320 3d20 2864 665b 2744 6976  plits = (df['Div
-0001c170: 6964 656e 6473 275d 3d3d 3029 2e74 6f5f  idends']==0).to_
-0001c180: 6e75 6d70 7928 2920 2620 2864 665b 2753  numpy() & (df['S
-0001c190: 746f 636b 2053 706c 6974 7327 5d3d 3d30  tock Splits']==0
-0001c1a0: 292e 746f 5f6e 756d 7079 2829 0a0a 2020  ).to_numpy()..  
-0001c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1c0: 2020 2320 2e2e 2e20 616e 6420 616e 6f74    # ... and anot
-0001c1d0: 6865 7220 636c 7565 2069 7320 4f70 656e  her clue is Open
-0001c1e0: 3d48 6967 683d 4c6f 773d 302e 300a 2020  =High=Low=0.0.  
-0001c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c200: 2020 6966 2066 5f6e 612e 616e 7928 293a    if f_na.any():
-0001c210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c220: 2020 2020 2020 2020 2066 5f7a 6572 6f20           f_zero 
-0001c230: 3d20 2864 665b 274f 7065 6e27 5d3d 3d30  = (df['Open']==0
-0001c240: 292e 746f 5f6e 756d 7079 2829 2026 2028  ).to_numpy() & (
-0001c250: 6466 5b27 4c6f 7727 5d3d 3d30 292e 746f  df['Low']==0).to
-0001c260: 5f6e 756d 7079 2829 2026 2028 6466 5b27  _numpy() & (df['
-0001c270: 4869 6768 275d 3d3d 3029 2e74 6f5f 6e75  High']==0).to_nu
-0001c280: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-0001c290: 2020 2020 2020 2020 2020 2020 2020 665f                f_
-0001c2a0: 7a65 726f 203d 2066 5f7a 6572 6f20 2620  zero = f_zero & 
-0001c2b0: 665f 6e6f 5f64 6976 735f 7370 6c69 7473  f_no_divs_splits
-0001c2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c2d0: 2020 2020 2020 2020 2066 5f6e 615f 7a65           f_na_ze
-0001c2e0: 726f 203d 2066 5f6e 6120 2620 665f 7a65  ro = f_na & f_ze
-0001c2f0: 726f 0a20 2020 2020 2020 2020 2020 2020  ro.             
-0001c300: 2020 2020 2020 2020 2020 2069 6620 665f             if f_
-0001c310: 6e61 5f7a 6572 6f2e 616e 7928 293a 0a20  na_zero.any():. 
-0001c320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c330: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-0001c340: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-0001c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c360: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-0001c370: 2d20 6472 6f70 7069 6e67 207b 7d20 7072  - dropping {} pr
-0001c380: 6963 653d 3020 726f 7773 2077 6974 6820  ice=0 rows with 
-0001c390: 6e6f 206d 6174 6368 696e 6720 696e 7465  no matching inte
-0001c3a0: 7276 616c 222e 666f 726d 6174 2873 756d  rval".format(sum
-0001c3b0: 2866 5f6e 615f 7a65 726f 2929 0a20 2020  (f_na_zero)).   
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3d0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-0001c3e0: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-0001c3f0: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-0001c400: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-0001c410: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
-0001c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c430: 2020 2020 2020 2020 2066 5f64 726f 7020           f_drop 
-0001c440: 3d20 665f 6e61 5f7a 6572 6f0a 2020 2020  = f_na_zero.    
+0001c150: 2064 662e 6c6f 635b 6474 312c 2022 566f   df.loc[dt1, "Vo
+0001c160: 6c75 6d65 225d 203d 2064 665b 2256 6f6c  lume"] = df["Vol
+0001c170: 756d 6522 5d2e 696c 6f63 5b69 6478 2d31  ume"].iloc[idx-1
+0001c180: 3a69 6478 2b31 5d2e 7375 6d28 290a 2020  :idx+1].sum().  
+0001c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c1a0: 2020 2020 2020 2020 2020 6466 203d 2064            df = d
+0001c1b0: 662e 6472 6f70 2864 7429 0a20 2020 2020  f.drop(dt).     
+0001c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c1d0: 2020 2020 2020 2069 6e74 6572 7661 6c73         intervals
+0001c1e0: 203d 2069 6e74 6572 7661 6c73 2e64 726f   = intervals.dro
+0001c1f0: 7028 6474 290a 2020 2020 2020 2020 2020  p(dt).          
+0001c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c210: 2020 7966 496e 7465 7276 616c 5374 6172    yfIntervalStar
+0001c220: 7473 203d 206e 702e 6465 6c65 7465 2879  ts = np.delete(y
+0001c230: 6649 6e74 6572 7661 6c53 7461 7274 732c  fIntervalStarts,
+0001c240: 2069 6478 290a 2020 2020 2020 2020 2020   idx).          
+0001c250: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
+0001c260: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
+0001c270: 7276 616c 5f6f 7065 6e22 5d2e 6973 6e61  rval_open"].isna
+0001c280: 2829 2e74 6f5f 6e75 6d70 7928 290a 0a20  ().to_numpy().. 
+0001c290: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c2a0: 6620 665f 6e61 2e61 6e79 2829 3a0a 2020  f f_na.any():.  
+0001c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2c0: 2020 6466 5f6e 6120 3d20 6466 5b66 5f6e    df_na = df[f_n
+0001c2d0: 615d 5b5b 2243 6c6f 7365 222c 2022 566f  a][["Close", "Vo
+0001c2e0: 6c75 6d65 222c 2022 4469 7669 6465 6e64  lume", "Dividend
+0001c2f0: 7322 2c20 2253 746f 636b 2053 706c 6974  s", "Stock Split
+0001c300: 7322 5d5d 0a20 2020 2020 2020 2020 2020  s"]].           
+0001c310: 2020 2020 2020 2020 206e 203d 2064 665f           n = df_
+0001c320: 6e61 2e73 6861 7065 5b30 5d0a 2020 2020  na.shape[0].    
+0001c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c340: 7761 726e 696e 675f 6d73 6720 3d20 6622  warning_msg = f"
+0001c350: 4661 696c 6564 2074 6f20 6d61 7020 7468  Failed to map th
+0001c360: 6573 6520 5961 686f 6f20 696e 7465 7276  ese Yahoo interv
+0001c370: 616c 7320 746f 2078 6361 6c3a 2028 746b  als to xcal: (tk
+0001c380: 723d 7b73 656c 662e 7469 636b 6572 7d2c  r={self.ticker},
+0001c390: 2065 7863 6861 6e67 653d 7b73 656c 662e   exchange={self.
+0001c3a0: 6578 6368 616e 6765 7d2c 2078 6361 6c3d  exchange}, xcal=
+0001c3b0: 7b79 6663 642e 6578 6368 616e 6765 546f  {yfcd.exchangeTo
+0001c3c0: 5863 616c 4578 6368 616e 6765 5b73 656c  XcalExchange[sel
+0001c3d0: 662e 6578 6368 616e 6765 5d7d 292e 220a  f.exchange]}).".
+0001c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3f0: 2020 2020 7761 726e 696e 675f 6d73 6720      warning_msg 
+0001c400: 2b3d 2022 204e 6f72 6d61 6c6c 7920 6861  += " Normally ha
+0001c410: 7070 656e 7320 7768 656e 2027 6578 6368  ppens when 'exch
+0001c420: 616e 6765 5f63 616c 656e 6461 7273 2720  ange_calendars' 
+0001c430: 6973 2077 726f 6e67 2073 6f20 696e 666f  is wrong so info
+0001c440: 726d 2064 6576 656c 6f70 6572 732e 220a  rm developers.".
 0001c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c460: 2020 2020 2020 2020 7966 496e 7465 7276          yfInterv
-0001c470: 616c 5374 6172 7473 203d 2079 6649 6e74  alStarts = yfInt
-0001c480: 6572 7661 6c53 7461 7274 735b 7e66 5f64  ervalStarts[~f_d
-0001c490: 726f 705d 0a20 2020 2020 2020 2020 2020  rop].           
-0001c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4b0: 2069 6e74 6572 7661 6c73 203d 2069 6e74   intervals = int
-0001c4c0: 6572 7661 6c73 5b7e 665f 6472 6f70 5d0a  ervals[~f_drop].
-0001c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4e0: 2020 2020 2020 2020 2020 2020 6466 203d              df =
-0001c4f0: 2064 665b 7e66 5f64 726f 705d 0a20 2020   df[~f_drop].   
-0001c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c510: 2020 2020 2020 2020 206e 203d 2064 662e           n = df.
-0001c520: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+0001c460: 2020 2020 7072 696e 7428 2222 290a 2020      print("").  
+0001c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c480: 2020 7072 696e 7428 7761 726e 696e 675f    print(warning_
+0001c490: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0001c4a0: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
+0001c4b0: 665f 6e61 290a 2020 2020 2020 2020 2020  f_na).          
+0001c4c0: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+0001c4d0: 2241 6363 6570 7420 696e 746f 2063 6163  "Accept into cac
+0001c4e0: 6865 2061 6e79 7761 793f 220a 2020 2020  he anyway?".    
+0001c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c500: 6966 2046 616c 7365 3a0a 2020 2020 2020  if False:.      
+0001c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c520: 2020 6163 6365 7074 203d 2054 7275 650a    accept = True.
 0001c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c540: 2020 2020 2066 5f6e 6120 3d20 696e 7465       f_na = inte
-0001c550: 7276 616c 735b 2269 6e74 6572 7661 6c5f  rvals["interval_
-0001c560: 6f70 656e 225d 2e69 736e 6128 292e 746f  open"].isna().to
-0001c570: 5f6e 756d 7079 2829 0a0a 2020 2020 2020  _numpy()..      
-0001c580: 2020 2020 2020 2020 2020 6966 2066 5f6e            if f_n
-0001c590: 612e 616e 7928 2920 616e 6420 7365 6c66  a.any() and self
-0001c5a0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-0001c5b0: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
-0001c5c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c5d0: 2020 2020 2020 2320 4966 2031 2d6d 696e        # If 1-min
-0001c5e0: 7574 6520 696e 7465 7276 616c 2061 7420  ute interval at 
-0001c5f0: 6d61 726b 6574 2063 6c6f 7365 2c20 7468  market close, th
-0001c600: 656e 206d 6572 6765 2077 6974 6820 7072  en merge with pr
-0001c610: 6576 696f 7573 206d 696e 7574 650a 2020  evious minute.  
+0001c540: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c560: 2020 6163 6365 7074 203d 2063 6c69 636b    accept = click
+0001c570: 2e63 6f6e 6669 726d 286d 7367 2c20 6465  .confirm(msg, de
+0001c580: 6661 756c 743d 4661 6c73 6529 0a20 2020  fault=False).   
+0001c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5a0: 2069 6620 6163 6365 7074 3a0a 2020 2020   if accept:.    
+0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5c0: 2020 2020 666f 7220 6964 7820 696e 206e      for idx in n
+0001c5d0: 702e 7768 6572 6528 665f 6e61 295b 305d  p.where(f_na)[0]
+0001c5e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c5f0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+0001c600: 203d 2069 6e74 6572 7661 6c73 2e69 6e64   = intervals.ind
+0001c610: 6578 5b69 6478 5d0a 2020 2020 2020 2020  ex[idx].        
 0001c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c630: 2020 696e 6469 6365 7320 3d20 736f 7274    indices = sort
-0001c640: 6564 286e 702e 7768 6572 6528 665f 6e61  ed(np.where(f_na
-0001c650: 295b 305d 2c20 7265 7665 7273 653d 5472  )[0], reverse=Tr
-0001c660: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0001c670: 2020 2020 2020 2020 666f 7220 6964 7820          for idx 
-0001c680: 696e 2069 6e64 6963 6573 3a0a 2020 2020  in indices:.    
-0001c690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6a0: 2020 2020 6474 203d 2064 662e 696e 6465      dt = df.inde
-0001c6b0: 785b 6964 785d 0a20 2020 2020 2020 2020  x[idx].         
-0001c6c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c6d0: 6368 6564 203d 2079 6663 742e 4765 7445  ched = yfct.GetE
-0001c6e0: 7863 6861 6e67 6553 6368 6564 756c 6528  xchangeSchedule(
-0001c6f0: 7365 6c66 2e65 7863 6861 6e67 652c 2064  self.exchange, d
-0001c700: 742e 6461 7465 2829 2c20 6474 2e64 6174  t.date(), dt.dat
-0001c710: 6528 292b 7464 5f31 6429 0a20 2020 2020  e()+td_1d).     
-0001c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c730: 2020 2069 6620 6474 2e74 696d 6528 2920     if dt.time() 
-0001c740: 3d3d 2073 6368 6564 5b22 636c 6f73 6522  == sched["close"
-0001c750: 5d2e 696c 6f63 5b30 5d2e 7469 6d65 2829  ].iloc[0].time()
-0001c760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c770: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001c780: 2069 6478 203d 3d20 303a 0a20 2020 2020   idx == 0:.     
-0001c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7a0: 2020 2020 2020 2020 2020 2023 2044 6973             # Dis
-0001c7b0: 6361 7264 0a20 2020 2020 2020 2020 2020  card.           
-0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7d0: 2020 2020 2070 7269 6e74 2822 6469 7363       print("disc
-0001c7e0: 6172 6469 6e67 2229 0a20 2020 2020 2020  arding").       
-0001c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c800: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-0001c810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c820: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c850: 7072 696e 7428 226d 6572 6769 6e67 2229  print("merging")
-0001c860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c880: 2023 204d 6572 6765 2077 6974 6820 7072   # Merge with pr
-0001c890: 6576 696f 7573 0a20 2020 2020 2020 2020  evious.         
-0001c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8b0: 2020 2020 2020 2064 7431 203d 2064 662e         dt1 = df.
-0001c8c0: 696e 6465 785b 6964 782d 315d 0a20 2020  index[idx-1].   
-0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8e0: 2020 2020 2020 2020 2020 2020 2064 662e               df.
-0001c8f0: 6c6f 635b 6474 312c 2022 436c 6f73 6522  loc[dt1, "Close"
-0001c900: 5d20 3d20 6466 5b22 436c 6f73 6522 5d2e  ] = df["Close"].
-0001c910: 696c 6f63 5b69 6478 5d0a 2020 2020 2020  iloc[idx].      
-0001c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c930: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
-0001c940: 5b64 7431 2c20 2248 6967 6822 5d20 3d20  [dt1, "High"] = 
-0001c950: 6466 5b22 4869 6768 225d 2e69 6c6f 635b  df["High"].iloc[
-0001c960: 6964 782d 313a 6964 782b 315d 2e6d 6178  idx-1:idx+1].max
-0001c970: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0001c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c990: 2020 2064 662e 6c6f 635b 6474 312c 2022     df.loc[dt1, "
-0001c9a0: 4c6f 7722 5d20 3d20 6466 5b22 4c6f 7722  Low"] = df["Low"
-0001c9b0: 5d2e 696c 6f63 5b69 6478 2d31 3a69 6478  ].iloc[idx-1:idx
-0001c9c0: 2b31 5d2e 6d69 6e28 290a 2020 2020 2020  +1].min().      
-0001c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c9e0: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
-0001c9f0: 5b64 7431 2c20 2256 6f6c 756d 6522 5d20  [dt1, "Volume"] 
-0001ca00: 3d20 6466 5b22 566f 6c75 6d65 225d 2e69  = df["Volume"].i
-0001ca10: 6c6f 635b 6964 782d 313a 6964 782b 315d  loc[idx-1:idx+1]
-0001ca20: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
-0001ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca40: 2020 2064 6620 3d20 6466 2e64 726f 7028     df = df.drop(
-0001ca50: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca70: 696e 7465 7276 616c 7320 3d20 696e 7465  intervals = inte
-0001ca80: 7276 616c 732e 6472 6f70 2864 7429 0a20  rvals.drop(dt). 
-0001ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001caa0: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
-0001cab0: 6572 7661 6c53 7461 7274 7320 3d20 6e70  ervalStarts = np
-0001cac0: 2e64 656c 6574 6528 7966 496e 7465 7276  .delete(yfInterv
-0001cad0: 616c 5374 6172 7473 2c20 6964 7829 0a20  alStarts, idx). 
-0001cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001caf0: 2020 2066 5f6e 6120 3d20 696e 7465 7276     f_na = interv
-0001cb00: 616c 735b 2269 6e74 6572 7661 6c5f 6f70  als["interval_op
-0001cb10: 656e 225d 2e69 736e 6128 292e 746f 5f6e  en"].isna().to_n
-0001cb20: 756d 7079 2829 0a0a 2020 2020 2020 2020  umpy()..        
-0001cb30: 2020 2020 2020 2020 6966 2066 5f6e 612e          if f_na.
-0001cb40: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-0001cb50: 2020 2020 2020 2020 2020 2064 665f 6e61             df_na
-0001cb60: 203d 2064 665b 665f 6e61 5d5b 5b22 436c   = df[f_na][["Cl
-0001cb70: 6f73 6522 2c20 2256 6f6c 756d 6522 2c20  ose", "Volume", 
-0001cb80: 2244 6976 6964 656e 6473 222c 2022 5374  "Dividends", "St
-0001cb90: 6f63 6b20 5370 6c69 7473 225d 5d0a 2020  ock Splits"]].  
-0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbb0: 2020 6e20 3d20 6466 5f6e 612e 7368 6170    n = df_na.shap
-0001cbc0: 655b 305d 0a20 2020 2020 2020 2020 2020  e[0].           
-0001cbd0: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-0001cbe0: 5f6d 7367 203d 2066 2246 6169 6c65 6420  _msg = f"Failed 
-0001cbf0: 746f 206d 6170 2074 6865 7365 2059 6168  to map these Yah
-0001cc00: 6f6f 2069 6e74 6572 7661 6c73 2074 6f20  oo intervals to 
-0001cc10: 7863 616c 3a20 2874 6b72 3d7b 7365 6c66  xcal: (tkr={self
-0001cc20: 2e74 6963 6b65 727d 2c20 6578 6368 616e  .ticker}, exchan
-0001cc30: 6765 3d7b 7365 6c66 2e65 7863 6861 6e67  ge={self.exchang
-0001cc40: 657d 2c20 7863 616c 3d7b 7966 6364 2e65  e}, xcal={yfcd.e
-0001cc50: 7863 6861 6e67 6554 6f58 6361 6c45 7863  xchangeToXcalExc
-0001cc60: 6861 6e67 655b 7365 6c66 2e65 7863 6861  hange[self.excha
-0001cc70: 6e67 655d 7d29 2e22 0a20 2020 2020 2020  nge]}).".       
-0001cc80: 2020 2020 2020 2020 2020 2020 2077 6172               war
-0001cc90: 6e69 6e67 5f6d 7367 202b 3d20 2220 4e6f  ning_msg += " No
-0001cca0: 726d 616c 6c79 2068 6170 7065 6e73 2077  rmally happens w
-0001ccb0: 6865 6e20 2765 7863 6861 6e67 655f 6361  hen 'exchange_ca
-0001ccc0: 6c65 6e64 6172 7327 2069 7320 7772 6f6e  lendars' is wron
-0001ccd0: 6720 736f 2069 6e66 6f72 6d20 6465 7665  g so inform deve
-0001cce0: 6c6f 7065 7273 2e22 0a20 2020 2020 2020  lopers.".       
-0001ccf0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001cd00: 6e74 2822 2229 0a20 2020 2020 2020 2020  nt("").         
-0001cd10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001cd20: 2877 6172 6e69 6e67 5f6d 7367 290a 2020  (warning_msg).  
-0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd40: 2020 7072 696e 7428 6466 5f6e 6129 0a20    print(df_na). 
-0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd60: 2020 206d 7367 203d 2022 4163 6365 7074     msg = "Accept
-0001cd70: 2069 6e74 6f20 6361 6368 6520 616e 7977   into cache anyw
-0001cd80: 6179 3f22 0a20 2020 2020 2020 2020 2020  ay?".           
-0001cd90: 2020 2020 2020 2020 2069 6620 4661 6c73           if Fals
-0001cda0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001cdb0: 2020 2020 2020 2020 2020 2061 6363 6570             accep
-0001cdc0: 7420 3d20 5472 7565 0a20 2020 2020 2020  t = True.       
-0001cdd0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001cde0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001cdf0: 2020 2020 2020 2020 2020 2061 6363 6570             accep
-0001ce00: 7420 3d20 636c 6963 6b2e 636f 6e66 6972  t = click.confir
-0001ce10: 6d28 6d73 672c 2064 6566 6175 6c74 3d46  m(msg, default=F
-0001ce20: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-0001ce30: 2020 2020 2020 2020 2020 6966 2061 6363            if acc
-0001ce40: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0001ce50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001ce60: 2069 6478 2069 6e20 6e70 2e77 6865 7265   idx in np.where
-0001ce70: 2866 5f6e 6129 5b30 5d3a 0a20 2020 2020  (f_na)[0]:.     
-0001ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce90: 2020 2020 2020 2064 7420 3d20 696e 7465         dt = inte
-0001cea0: 7276 616c 732e 696e 6465 785b 6964 785d  rvals.index[idx]
-0001ceb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cec0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001ced0: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-0001cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cef0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001cf00: 6e74 6572 7661 6c73 2e6c 6f63 5b64 742c  ntervals.loc[dt,
-0001cf10: 2022 696e 7465 7276 616c 5f6f 7065 6e22   "interval_open"
-0001cf20: 5d20 3d20 6466 2e69 6e64 6578 5b69 6478  ] = df.index[idx
-0001cf30: 5d2e 6461 7465 2829 0a20 2020 2020 2020  ].date().       
-0001cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf50: 2020 2020 2020 2020 2069 6e74 6572 7661           interva
-0001cf60: 6c73 2e6c 6f63 5b64 742c 2022 696e 7465  ls.loc[dt, "inte
-0001cf70: 7276 616c 5f63 6c6f 7365 225d 203d 2064  rval_close"] = d
-0001cf80: 662e 696e 6465 785b 6964 785d 2e64 6174  f.index[idx].dat
-0001cf90: 6528 2920 2b20 7365 6c66 2e69 7464 0a20  e() + self.itd. 
-0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfb0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001cfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfe0: 2069 6e74 6572 7661 6c73 2e6c 6f63 5b64   intervals.loc[d
-0001cff0: 742c 2022 696e 7465 7276 616c 5f6f 7065  t, "interval_ope
-0001d000: 6e22 5d20 3d20 6466 2e69 6e64 6578 5b69  n"] = df.index[i
-0001d010: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
-0001d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d030: 2020 2020 696e 7465 7276 616c 732e 6c6f      intervals.lo
-0001d040: 635b 6474 2c20 2269 6e74 6572 7661 6c5f  c[dt, "interval_
-0001d050: 636c 6f73 6522 5d20 3d20 6466 2e69 6e64  close"] = df.ind
-0001d060: 6578 5b69 6478 5d20 2b20 7365 6c66 2e69  ex[idx] + self.i
-0001d070: 7464 0a20 2020 2020 2020 2020 2020 2020  td.             
-0001d080: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d0a0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0001d0b0: 7469 6f6e 2822 5072 6f62 6c65 6d20 7769  tion("Problem wi
-0001d0c0: 7468 2064 6174 6573 2072 6574 7572 6e65  th dates returne
-0001d0d0: 6420 6279 2059 6168 6f6f 2c20 7365 6520  d by Yahoo, see 
-0001d0e0: 6162 6f76 6522 290a 0a20 2020 2020 2020  above")..       
-0001d0f0: 2064 6620 3d20 6466 2e63 6f70 7928 290a   df = df.copy().
-0001d100: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001d110: 6469 7361 626c 655f 7966 635f 6d65 7461  disable_yfc_meta
-0001d120: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-0001d130: 2020 6c61 7374 4461 7461 4474 7320 3d20    lastDataDts = 
-0001d140: 7966 6374 2e43 616c 6349 6e74 6572 7661  yfct.CalcInterva
-0001d150: 6c4c 6173 7444 6174 6144 745f 6261 7463  lLastDataDt_batc
-0001d160: 6828 7365 6c66 2e65 7863 6861 6e67 652c  h(self.exchange,
-0001d170: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
-0001d180: 7276 616c 5f6f 7065 6e22 5d2e 746f 5f6e  rval_open"].to_n
-0001d190: 756d 7079 2829 2c20 7365 6c66 2e69 6e74  umpy(), self.int
-0001d1a0: 6572 7661 6c29 0a20 2020 2020 2020 2020  erval).         
-0001d1b0: 2020 2069 6620 665f 6e61 2e61 6e79 2829     if f_na.any()
-0001d1c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d1d0: 2020 2320 4861 636b 7920 736f 6c75 7469    # Hacky soluti
-0001d1e0: 6f6e 2074 6f20 6861 6e64 6c65 2078 6361  on to handle xca
-0001d1f0: 6c20 6861 7669 6e67 2069 6e63 6f72 7265  l having incorre
-0001d200: 6374 2073 6368 6564 756c 652c 2066 6f72  ct schedule, for
-0001d210: 2076 616c 6964 2059 6168 6f6f 2064 6174   valid Yahoo dat
-0001d220: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-0001d230: 2020 6c61 7374 4461 7461 4474 735b 665f    lastDataDts[f_
-0001d240: 6e61 5d20 3d20 696e 7465 7276 616c 732e  na] = intervals.
-0001d250: 696e 6465 785b 665f 6e61 5d20 2b20 7365  index[f_na] + se
-0001d260: 6c66 2e69 7464 0a20 2020 2020 2020 2020  lf.itd.         
-0001d270: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-0001d280: 6e74 7261 6461 793a 0a20 2020 2020 2020  ntraday:.       
-0001d290: 2020 2020 2020 2020 2020 2020 206c 6173               las
-0001d2a0: 7444 6174 6144 7473 5b66 5f6e 615d 202b  tDataDts[f_na] +
-0001d2b0: 3d20 7966 6374 2e47 6574 4578 6368 616e  = yfct.GetExchan
-0001d2c0: 6765 4461 7461 4465 6c61 7928 7365 6c66  geDataDelay(self
-0001d2d0: 2e65 7863 6861 6e67 6529 0a20 2020 2020  .exchange).     
-0001d2e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001d2f0: 2046 6f72 2073 6f6d 6520 6578 6368 616e   For some exchan
-0001d300: 6765 732c 2059 6168 6f6f 2068 6173 2074  ges, Yahoo has t
-0001d310: 7261 6465 7320 7468 6174 206f 6363 7572  rades that occur
-0001d320: 7265 6420 736f 6f6e 2061 6665 7220 6f66  red soon afer of
-0001d330: 6669 6369 616c 206d 6172 6b65 7420 636c  ficial market cl
-0001d340: 6f73 652c 2065 2e67 2e20 4a6f 6861 6e6e  ose, e.g. Johann
-0001d350: 6573 6275 7267 3a0a 2020 2020 2020 2020  esburg:.        
-0001d360: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001d370: 656c 662e 6578 6368 616e 6765 2069 6e20  elf.exchange in 
-0001d380: 5b22 4a4e 4222 5d3a 0a20 2020 2020 2020  ["JNB"]:.       
-0001d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3a0: 206c 6173 7444 6174 6144 7473 5b66 5f6e   lastDataDts[f_n
-0001d3b0: 615d 202b 3d20 7469 6d65 6465 6c74 6128  a] += timedelta(
-0001d3c0: 6d69 6e75 7465 733d 3135 290a 2020 2020  minutes=15).    
-0001d3d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001d3e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d3f0: 2020 2020 2020 2320 4164 6420 7e31 3020        # Add ~10 
-0001d400: 686f 7572 7320 746f 2065 6e73 7572 6520  hours to ensure 
-0001d410: 6869 7420 6e65 7874 206d 6172 6b65 7420  hit next market 
-0001d420: 6f70 656e 0a20 2020 2020 2020 2020 2020  open.           
-0001d430: 2020 2020 2020 2020 206c 6173 7444 6174           lastDat
-0001d440: 6144 7473 5b66 5f6e 615d 202b 3d20 7469  aDts[f_na] += ti
-0001d450: 6d65 6465 6c74 6128 686f 7572 733d 3130  medelta(hours=10
-0001d460: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
-0001d470: 7461 5f66 696e 616c 203d 2066 6574 6368  ta_final = fetch
-0001d480: 5f64 7420 3e3d 206c 6173 7444 6174 6144  _dt >= lastDataD
-0001d490: 7473 0a20 2020 2020 2020 2020 2020 2064  ts.            d
-0001d4a0: 665b 2246 696e 616c 3f22 5d20 3d20 6461  f["Final?"] = da
-0001d4b0: 7461 5f66 696e 616c 0a0a 2020 2020 2020  ta_final..      
-0001d4c0: 2020 2020 2020 2320 6466 5b22 4665 7463        # df["Fetc
-0001d4d0: 6844 6174 6522 5d20 3d20 7064 2e54 696d  hDate"] = pd.Tim
-0001d4e0: 6573 7461 6d70 2866 6574 6368 5f64 745f  estamp(fetch_dt_
-0001d4f0: 7574 6329 2e74 7a5f 6c6f 6361 6c69 7a65  utc).tz_localize
-0001d500: 2822 5554 4322 290a 2020 2020 2020 2020  ("UTC").        
-0001d510: 2020 2020 6466 5b22 4665 7463 6844 6174      df["FetchDat
-0001d520: 6522 5d20 3d20 6665 7463 685f 6474 5f75  e"] = fetch_dt_u
-0001d530: 7463 0a0a 2020 2020 2020 2020 2020 2020  tc..            
-0001d540: 6466 5b22 432d 4368 6563 6b3f 225d 203d  df["C-Check?"] =
-0001d550: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0001d560: 6c6f 675f 6d73 6720 3d20 6622 504d 3a3a  log_msg = f"PM::
-0001d570: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
-0001d580: 2920 7265 7475 726e 696e 6720 4446 207b  ) returning DF {
-0001d590: 6466 2e69 6e64 6578 5b30 5d7d 202d 3e20  df.index[0]} -> 
-0001d5a0: 7b64 662e 696e 6465 785b 2d31 5d7d 220a  {df.index[-1]}".
-0001d5b0: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
-0001d5c0: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0001d5d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001d5e0: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-0001d5f0: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
-0001d600: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
-0001d610: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001d620: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
-0001d630: 2020 2020 2320 6627 4d65 616e 3a7b 732e      # f'Mean:{s.
-0001d640: 6d65 616e 2829 3a2e 3265 7d2c 2053 443a  mean():.2e}, SD:
-0001d650: 7b73 2e73 7464 2829 3a2e 3265 7d0a 2020  {s.std():.2e}.  
-0001d660: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
-0001d670: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
-0001d680: 2020 2020 6d73 6720 3d20 6622 7072 6f63      msg = f"proc
-0001d690: 6573 7365 6420 5946 2072 6573 706f 6e73  essed YF respons
-0001d6a0: 6520 3d20 7b73 656c 662e 6973 7472 7d20  e = {self.istr} 
-0001d6b0: 7b64 662e 696e 6465 785b 305d 2e64 6174  {df.index[0].dat
-0001d6c0: 6528 297d 202d 3e20 7b64 662e 696e 6465  e()} -> {df.inde
-0001d6d0: 785b 2d31 5d2e 6461 7465 2829 7d22 0a20  x[-1].date()}". 
-0001d6e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d6f0: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
-0001d700: 2270 726f 6365 7373 6564 2059 4620 7265  "processed YF re
-0001d710: 7370 6f6e 7365 203d 207b 7365 6c66 2e69  sponse = {self.i
-0001d720: 7374 727d 207b 6466 2e69 6e64 6578 5b30  str} {df.index[0
-0001d730: 5d7d 202d 3e20 7b64 662e 696e 6465 785b  ]} -> {df.index[
-0001d740: 2d31 5d7d 220a 2020 2020 2020 2020 6d73  -1]}".        ms
-0001d750: 6720 2b3d 2066 2220 2843 6c6f 7365 3d20  g += f" (Close= 
-0001d760: 7b64 665b 2743 6c6f 7365 275d 2e6d 6561  {df['Close'].mea
-0001d770: 6e28 293a 2e32 657d 20c2 b120 7b64 665b  n():.2e} .. {df[
-0001d780: 2743 6c6f 7365 275d 2e64 726f 706e 6128  'Close'].dropna(
-0001d790: 292e 7374 6428 293a 2e32 657d 2922 0a20  ).std():.2e})". 
-0001d7a0: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
-0001d7b0: 6765 722e 4c6f 6745 7665 6e74 2822 696e  ger.LogEvent("in
-0001d7c0: 666f 222c 2022 5072 6963 654d 616e 6167  fo", "PriceManag
-0001d7d0: 6572 222c 206d 7367 290a 0a20 2020 2020  er", msg)..     
-0001d7e0: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
-0001d7f0: 2020 6465 6620 5f66 6574 6368 5966 4869    def _fetchYfHi
-0001d800: 7374 6f72 795f 6461 7465 5261 6e67 6528  story_dateRange(
-0001d810: 7365 6c66 2c20 7374 6172 742c 2065 6e64  self, start, end
-0001d820: 2c20 7072 6570 6f73 742c 2064 6562 7567  , prepost, debug
-0001d830: 293a 0a20 2020 2020 2020 2079 6663 752e  ):.        yfcu.
-0001d840: 5479 7065 4368 6563 6b49 6e74 6572 7661  TypeCheckInterva
-0001d850: 6c44 7428 7374 6172 742c 2073 656c 662e  lDt(start, self.
-0001d860: 696e 7465 7276 616c 2c20 2273 7461 7274  interval, "start
-0001d870: 2229 0a20 2020 2020 2020 2079 6663 752e  ").        yfcu.
-0001d880: 5479 7065 4368 6563 6b49 6e74 6572 7661  TypeCheckInterva
-0001d890: 6c44 7428 656e 642c 2073 656c 662e 696e  lDt(end, self.in
-0001d8a0: 7465 7276 616c 2c20 2265 6e64 2229 0a20  terval, "end"). 
-0001d8b0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
-0001d8c0: 4368 6563 6b42 6f6f 6c28 7072 6570 6f73  CheckBool(prepos
-0001d8d0: 742c 2022 7072 6570 6f73 7422 290a 2020  t, "prepost").  
-0001d8e0: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-0001d8f0: 6865 636b 426f 6f6c 2864 6562 7567 2c20  heckBool(debug, 
-0001d900: 2264 6562 7567 2229 0a0a 2020 2020 2020  "debug")..      
-0001d910: 2020 6465 6275 675f 7966 6320 3d20 4661    debug_yfc = Fa
-0001d920: 6c73 650a 2020 2020 2020 2020 2320 6465  lse.        # de
-0001d930: 6275 675f 7966 6320 3d20 5472 7565 0a0a  bug_yfc = True..
-0001d940: 2020 2020 2020 2020 6c6f 675f 6d73 6720          log_msg 
-0001d950: 3d20 6622 504d 3a3a 5f66 6574 6368 5966  = f"PM::_fetchYf
-0001d960: 4869 7374 6f72 795f 6461 7465 5261 6e67  History_dateRang
-0001d970: 652d 7b73 656c 662e 6973 7472 7d28 7374  e-{self.istr}(st
-0001d980: 6172 743d 7b73 7461 7274 7d20 2c20 656e  art={start} , en
-0001d990: 643d 7b65 6e64 7d20 2c20 7072 6570 6f73  d={end} , prepos
-0001d9a0: 743d 7b70 7265 706f 7374 7d29 220a 2020  t={prepost})".  
-0001d9b0: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
-0001d9c0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-0001d9d0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-0001d9e0: 636c 2e54 7261 6365 456e 7465 7228 6c6f  cl.TraceEnter(lo
-0001d9f0: 675f 6d73 6729 0a20 2020 2020 2020 2065  g_msg).        e
-0001da00: 6c69 6620 6465 6275 675f 7966 633a 0a20  lif debug_yfc:. 
-0001da10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001da20: 2822 2229 0a20 2020 2020 2020 2020 2020  ("").           
-0001da30: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
-0001da40: 0a20 2020 2020 2020 2066 6574 6368 5f73  .        fetch_s
-0001da50: 7461 7274 203d 2073 7461 7274 0a20 2020  tart = start.   
-0001da60: 2020 2020 2066 6574 6368 5f65 6e64 203d       fetch_end =
-0001da70: 2065 6e64 0a20 2020 2020 2020 2069 6620   end.        if 
-0001da80: 6e6f 7420 6973 696e 7374 616e 6365 2866  not isinstance(f
-0001da90: 6574 6368 5f73 7461 7274 2c20 2864 6174  etch_start, (dat
-0001daa0: 6574 696d 652c 2070 642e 5469 6d65 7374  etime, pd.Timest
-0001dab0: 616d 7029 293a 0a20 2020 2020 2020 2020  amp)):.         
-0001dac0: 2020 2066 6574 6368 5f73 7461 7274 5f64     fetch_start_d
-0001dad0: 7420 3d20 6461 7465 7469 6d65 2e63 6f6d  t = datetime.com
-0001dae0: 6269 6e65 2866 6574 6368 5f73 7461 7274  bine(fetch_start
-0001daf0: 2c20 7469 6d65 2830 292c 2073 656c 662e  , time(0), self.
-0001db00: 747a 290a 2020 2020 2020 2020 656c 7365  tz).        else
-0001db10: 3a0a 2020 2020 2020 2020 2020 2020 6665  :.            fe
-0001db20: 7463 685f 7374 6172 745f 6474 203d 2066  tch_start_dt = f
-0001db30: 6574 6368 5f73 7461 7274 0a0a 2020 2020  etch_start..    
-0001db40: 2020 2020 6869 7374 6f72 795f 6172 6773      history_args
-0001db50: 203d 207b 2270 6572 696f 6422 3a20 4e6f   = {"period": No
-0001db60: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0001db70: 2020 2020 2020 2020 2020 2020 2269 6e74              "int
-0001db80: 6572 7661 6c22 3a20 7365 6c66 2e69 7374  erval": self.ist
-0001db90: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0001dba0: 2020 2020 2020 2020 2020 2022 7374 6172             "star
-0001dbb0: 7422 3a20 6665 7463 685f 7374 6172 742c  t": fetch_start,
-0001dbc0: 2022 656e 6422 3a20 6665 7463 685f 656e   "end": fetch_en
-0001dbd0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0001dbe0: 2020 2020 2020 2020 2020 2022 7072 6570             "prep
-0001dbf0: 6f73 7422 3a20 7072 6570 6f73 742c 0a20  ost": prepost,. 
-0001dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc10: 2020 2020 2020 2022 6163 7469 6f6e 7322         "actions"
-0001dc20: 3a20 5472 7565 2c20 2023 2041 6c77 6179  : True,  # Alway
-0001dc30: 7320 6665 7463 680a 2020 2020 2020 2020  s fetch.        
-0001dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc50: 226b 6565 706e 6122 3a20 5472 7565 2c0a  "keepna": True,.
-0001dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc70: 2020 2020 2020 2020 2272 6570 6169 7222          "repair"
-0001dc80: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
-0001dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dca0: 2261 7574 6f5f 6164 6a75 7374 223a 2046  "auto_adjust": F
-0001dcb0: 616c 7365 2c20 2023 2073 746f 7265 2072  alse,  # store r
-0001dcc0: 6177 2064 6174 612c 2061 646a 7573 7420  aw data, adjust 
-0001dcd0: 6d79 7365 6c66 0a20 2020 2020 2020 2020  myself.         
-0001dce0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001dcf0: 6261 636b 5f61 646a 7573 7422 3a20 4661  back_adjust": Fa
-0001dd00: 6c73 652c 2020 2320 7374 6f72 6520 7261  lse,  # store ra
-0001dd10: 7720 6461 7461 2c20 6164 6a75 7374 206d  w data, adjust m
-0001dd20: 7973 656c 660a 2020 2020 2020 2020 2020  yself.          
-0001dd30: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-0001dd40: 726f 7879 223a 2073 656c 662e 7072 6f78  roxy": self.prox
-0001dd50: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-0001dd60: 2020 2020 2020 2020 2020 2022 726f 756e             "roun
-0001dd70: 6469 6e67 223a 2046 616c 7365 2c20 2023  ding": False,  #
-0001dd80: 2073 746f 7265 2072 6177 2064 6174 612c   store raw data,
-0001dd90: 2072 6f75 6e64 206d 7973 656c 660a 2020   round myself.  
-0001dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddb0: 2020 2020 2020 2272 6169 7365 5f65 7272        "raise_err
-0001ddc0: 6f72 7322 3a20 5472 7565 7d0a 2020 2020  ors": True}.    
-0001ddd0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-0001dde0: 2020 2020 2020 2020 2020 7966 5f6c 6f67            yf_log
-0001ddf0: 6765 7220 3d20 6c6f 6767 696e 672e 6765  ger = logging.ge
-0001de00: 744c 6f67 6765 7228 2779 6669 6e61 6e63  tLogger('yfinanc
-0001de10: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-0001de20: 7966 5f6c 6f67 6765 722e 7365 744c 6576  yf_logger.setLev
-0001de30: 656c 286c 6f67 6769 6e67 2e44 4542 5547  el(logging.DEBUG
-0001de40: 2920 2023 2076 6572 626f 7365 3a20 7072  )  # verbose: pr
-0001de50: 696e 7420 6572 726f 7273 2026 2064 6562  int errors & deb
-0001de60: 7567 2069 6e66 6f0a 0a20 2020 2020 2020  ug info..       
-0001de70: 2069 6620 6465 6275 675f 7966 633a 0a20   if debug_yfc:. 
-0001de80: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
-0001de90: 6f74 2069 7369 6e73 7461 6e63 6528 6665  ot isinstance(fe
-0001dea0: 7463 685f 7374 6172 742c 2064 6174 6574  tch_start, datet
-0001deb0: 696d 6529 2920 6f72 2066 6574 6368 5f73  ime)) or fetch_s
-0001dec0: 7461 7274 2e74 696d 6528 2920 3d3d 2074  tart.time() == t
-0001ded0: 696d 6528 3029 3a0a 2020 2020 2020 2020  ime(0):.        
-0001dee0: 2020 2020 2020 2020 7374 6172 745f 7374          start_st
-0001def0: 7220 3d20 6665 7463 685f 7374 6172 742e  r = fetch_start.
-0001df00: 7374 7266 7469 6d65 2822 2559 2d25 6d2d  strftime("%Y-%m-
-0001df10: 2564 2229 0a20 2020 2020 2020 2020 2020  %d").           
-0001df20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001df30: 2020 2020 2020 2073 7461 7274 5f73 7472         start_str
-0001df40: 203d 2066 6574 6368 5f73 7461 7274 2e73   = fetch_start.s
-0001df50: 7472 6674 696d 6528 2225 592d 256d 2d25  trftime("%Y-%m-%
-0001df60: 6420 2548 3a25 4d3a 2553 2229 0a20 2020  d %H:%M:%S").   
-0001df70: 2020 2020 2020 2020 2069 6620 286e 6f74           if (not
-0001df80: 2069 7369 6e73 7461 6e63 6528 6665 7463   isinstance(fetc
-0001df90: 685f 656e 642c 2064 6174 6574 696d 6529  h_end, datetime)
-0001dfa0: 2920 6f72 2066 6574 6368 5f65 6e64 2e74  ) or fetch_end.t
-0001dfb0: 696d 6528 2920 3d3d 2074 696d 6528 3029  ime() == time(0)
-0001dfc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001dfd0: 2020 656e 645f 7374 7220 3d20 6665 7463    end_str = fetc
-0001dfe0: 685f 656e 642e 7374 7266 7469 6d65 2822  h_end.strftime("
-0001dff0: 2559 2d25 6d2d 2564 2229 0a20 2020 2020  %Y-%m-%d").     
-0001e000: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001e010: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-0001e020: 5f73 7472 203d 2066 6574 6368 5f65 6e64  _str = fetch_end
-0001e030: 2e73 7472 6674 696d 6528 2225 592d 256d  .strftime("%Y-%m
-0001e040: 2d25 6420 2548 3a25 4d3a 2553 2229 0a20  -%d %H:%M:%S"). 
-0001e050: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0001e060: 2066 222d 207b 7365 6c66 2e74 6963 6b65   f"- {self.ticke
-0001e070: 727d 3a20 6665 7463 6869 6e67 207b 7365  r}: fetching {se
-0001e080: 6c66 2e69 7374 727d 207b 7374 6172 745f  lf.istr} {start_
-0001e090: 7374 727d 202d 3e20 7b65 6e64 5f73 7472  str} -> {end_str
-0001e0a0: 7d22 0a20 2020 2020 2020 2020 2020 2079  }".            y
-0001e0b0: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-0001e0c0: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-0001e0d0: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-0001e0e0: 6c73 6520 7072 696e 7428 6d73 6729 0a0a  lse print(msg)..
-0001e0f0: 2020 2020 2020 2020 6669 7273 745f 6665          first_fe
-0001e100: 7463 685f 6661 696c 6564 203d 2046 616c  tch_failed = Fal
-0001e110: 7365 0a20 2020 2020 2020 2064 6620 3d20  se.        df = 
-0001e120: 4e6f 6e65 0a20 2020 2020 2020 2074 7279  None.        try
-0001e130: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0001e140: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
-0001e150: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-0001e160: 3d20 6622 2d20 6665 7463 685f 7374 6172  = f"- fetch_star
-0001e170: 743d 7b66 6574 6368 5f73 7461 7274 7d20  t={fetch_start} 
-0001e180: 3b20 6665 7463 685f 656e 643d 7b66 6574  ; fetch_end={fet
-0001e190: 6368 5f65 6e64 7d22 0a20 2020 2020 2020  ch_end}".       
-0001e1a0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-0001e1b0: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-0001e1c0: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-0001e1d0: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-0001e1e0: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
-0001e1f0: 2020 2020 2064 6620 3d20 7365 6c66 2e64       df = self.d
-0001e200: 6174 2e68 6973 746f 7279 282a 2a68 6973  at.history(**his
-0001e210: 746f 7279 5f61 7267 7329 0a20 2020 2020  tory_args).     
-0001e220: 2020 2020 2020 2064 6620 3d20 6466 2e73         df = df.s
-0001e230: 6f72 745f 696e 6465 7828 290a 2020 2020  ort_index().    
-0001e240: 2020 2020 2020 2020 6966 2022 5265 7061          if "Repa
-0001e250: 6972 6564 3f22 206e 6f74 2069 6e20 6466  ired?" not in df
-0001e260: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
-0001e270: 2020 2020 2020 2020 2020 6466 5b22 5265            df["Re
-0001e280: 7061 6972 6564 3f22 5d20 3d20 4661 6c73  paired?"] = Fals
-0001e290: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0001e2a0: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
-0001e2b0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0001e2c0: 6620 6973 204e 6f6e 653a 0a20 2020 2020  f is None:.     
-0001e2d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e2e0: 7367 203d 2022 2d20 5946 2072 6574 7572  sg = "- YF retur
-0001e2f0: 6e65 6420 4e6f 6e65 220a 2020 2020 2020  ned None".      
-0001e300: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-0001e310: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-0001e320: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-0001e330: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-0001e340: 7365 2070 7269 6e74 286d 7367 290a 2020  se print(msg).  
-0001e350: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0001e360: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001e370: 2020 2020 2020 2020 6d73 6720 3d20 222d          msg = "-
-0001e380: 2059 4620 7265 7475 726e 6564 2074 6162   YF returned tab
-0001e390: 6c65 3a22 0a20 2020 2020 2020 2020 2020  le:".           
-0001e3a0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-0001e3b0: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-0001e3c0: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-0001e3d0: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-0001e3e0: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
-0001e3f0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001e400: 6e74 2864 665b 5b63 2066 6f72 2063 2069  nt(df[[c for c i
-0001e410: 6e20 5b22 4f70 656e 222c 2022 4c6f 7722  n ["Open", "Low"
-0001e420: 2c20 2248 6967 6822 2c20 2243 6c6f 7365  , "High", "Close
-0001e430: 222c 2022 4469 7669 6465 6e64 7322 2c20  ", "Dividends", 
-0001e440: 2256 6f6c 756d 6522 5d20 6966 2063 2069  "Volume"] if c i
-0001e450: 6e20 6466 2e63 6f6c 756d 6e73 5d5d 290a  n df.columns]]).
-0001e460: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0001e470: 6620 6973 204e 6f6e 6520 6f72 2064 662e  f is None or df.
-0001e480: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
-0001e490: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0001e4a0: 6570 7469 6f6e 2822 4e6f 2064 6174 6120  eption("No data 
-0001e4b0: 666f 756e 6420 666f 7220 7468 6973 2064  found for this d
-0001e4c0: 6174 6520 7261 6e67 6522 290a 2020 2020  ate range").    
-0001e4d0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0001e4e0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0001e4f0: 2020 2020 2020 2066 6972 7374 5f66 6574         first_fet
-0001e500: 6368 5f66 6169 6c65 6420 3d20 5472 7565  ch_failed = True
-0001e510: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001e520: 2244 6174 6120 646f 6573 6e27 7420 6578  "Data doesn't ex
-0001e530: 6973 7420 666f 7220 7374 6172 7444 6174  ist for startDat
-0001e540: 6522 2069 6e20 7374 7228 6529 3a0a 2020  e" in str(e):.  
-0001e550: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001e560: 6973 6520 7966 6364 2e4e 6f50 7269 6365  ise yfcd.NoPrice
-0001e570: 4461 7461 496e 5261 6e67 6545 7863 6570  DataInRangeExcep
-0001e580: 7469 6f6e 2873 656c 662e 7469 636b 6572  tion(self.ticker
-0001e590: 2c20 7365 6c66 2e69 7374 722c 2073 7461  , self.istr, sta
-0001e5a0: 7274 2c20 656e 6429 0a20 2020 2020 2020  rt, end).       
-0001e5b0: 2020 2020 2065 6c69 6620 224e 6f20 6461       elif "No da
-0001e5c0: 7461 2066 6f75 6e64 2066 6f72 2074 6869  ta found for thi
-0001e5d0: 7320 6461 7465 2072 616e 6765 2220 696e  s date range" in
-0001e5e0: 2073 7472 2865 293a 0a20 2020 2020 2020   str(e):.       
-0001e5f0: 2020 2020 2020 2020 2072 6169 7365 2079           raise y
-0001e600: 6663 642e 4e6f 5072 6963 6544 6174 6149  fcd.NoPriceDataI
-0001e610: 6e52 616e 6765 4578 6365 7074 696f 6e28  nRangeException(
-0001e620: 7365 6c66 2e74 6963 6b65 722c 2073 656c  self.ticker, sel
-0001e630: 662e 6973 7472 2c20 7374 6172 742c 2065  f.istr, start, e
-0001e640: 6e64 290a 2020 2020 2020 2020 2020 2020  nd).            
-0001e650: 656c 6966 2022 4e6f 2070 7269 6365 2064  elif "No price d
-0001e660: 6174 6120 666f 756e 642c 2073 796d 626f  ata found, symbo
-0001e670: 6c20 6d61 7920 6265 2064 656c 6973 7465  l may be deliste
-0001e680: 6422 2069 6e20 7374 7228 6529 3a0a 2020  d" in str(e):.  
-0001e690: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001e6a0: 6973 6520 7966 6364 2e4e 6f50 7269 6365  ise yfcd.NoPrice
-0001e6b0: 4461 7461 496e 5261 6e67 6545 7863 6570  DataInRangeExcep
-0001e6c0: 7469 6f6e 2873 656c 662e 7469 636b 6572  tion(self.ticker
-0001e6d0: 2c20 7365 6c66 2e69 7374 722c 2073 7461  , self.istr, sta
-0001e6e0: 7274 2c20 656e 6429 0a20 2020 2020 2020  rt, end).       
-0001e6f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001e700: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001e710: 2822 6466 3a22 290a 2020 2020 2020 2020  ("df:").        
-0001e720: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
-0001e730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e740: 2020 7261 6973 6520 650a 0a20 2020 2020    raise e..     
-0001e750: 2020 2069 6620 6e6f 7420 6669 7273 745f     if not first_
-0001e760: 6665 7463 685f 6661 696c 6564 2061 6e64  fetch_failed and
-0001e770: 2066 6574 6368 5f73 7461 7274 2069 7320   fetch_start is 
-0001e780: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0001e790: 2020 2020 2020 6c6f 675f 6d73 6720 3d20        log_msg = 
-0001e7a0: 6622 7265 7175 6573 7465 6420 6672 6f6d  f"requested from
-0001e7b0: 2059 463a 207b 7365 6c66 2e69 7374 727d   YF: {self.istr}
-0001e7c0: 207b 6869 7374 6f72 795f 6172 6773 5b27   {history_args['
-0001e7d0: 7374 6172 7427 5d7d 202d 3e20 7b68 6973  start']} -> {his
-0001e7e0: 746f 7279 5f61 7267 735b 2765 6e64 275d  tory_args['end']
-0001e7f0: 7d22 0a20 2020 2020 2020 2020 2020 2069  }".            i
-0001e800: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
-0001e810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e820: 206c 6f67 5f6d 7367 202b 3d20 6622 2c20   log_msg += f", 
-0001e830: 7265 6365 6976 6564 3a20 7b64 662e 696e  received: {df.in
-0001e840: 6465 785b 305d 2e64 6174 6528 297d 202d  dex[0].date()} -
-0001e850: 3e20 7b64 662e 696e 6465 785b 2d31 5d2e  > {df.index[-1].
-0001e860: 6461 7465 2829 7d22 0a20 2020 2020 2020  date()}".       
-0001e870: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001e880: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
-0001e890: 7367 202b 3d20 6622 2c20 7265 6365 6976  sg += f", receiv
-0001e8a0: 6564 3a20 7b64 662e 696e 6465 785b 305d  ed: {df.index[0]
-0001e8b0: 7d20 2d3e 207b 6466 2e69 6e64 6578 5b2d  } -> {df.index[-
-0001e8c0: 315d 7d22 0a20 2020 2020 2020 2020 2020  1]}".           
-0001e8d0: 2073 656c 662e 6d61 6e61 6765 722e 4c6f   self.manager.Lo
-0001e8e0: 6745 7665 6e74 2822 696e 666f 222c 2022  gEvent("info", "
-0001e8f0: 5072 6963 654d 616e 6167 6572 222c 206c  PriceManager", l
-0001e900: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
-0001e910: 2020 2020 2064 6620 3d20 6466 2e6c 6f63       df = df.loc
-0001e920: 5b66 6574 6368 5f73 7461 7274 5f64 743a  [fetch_start_dt:
-0001e930: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0001e940: 2064 662e 656d 7074 793a 0a20 2020 2020   df.empty:.     
-0001e950: 2020 2020 2020 2020 2020 2066 6972 7374             first
-0001e960: 5f66 6574 6368 5f66 6169 6c65 6420 3d20  _fetch_failed = 
-0001e970: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001e980: 2020 2020 2072 6169 7365 2079 6663 642e       raise yfcd.
-0001e990: 4e6f 5072 6963 6544 6174 6149 6e52 616e  NoPriceDataInRan
-0001e9a0: 6765 4578 6365 7074 696f 6e28 7365 6c66  geException(self
-0001e9b0: 2e74 6963 6b65 722c 2073 656c 662e 6973  .ticker, self.is
-0001e9c0: 7472 2c20 7374 6172 742c 2065 6e64 290a  tr, start, end).
-0001e9d0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-0001e9e0: 2074 6861 7420 7765 656b 6c79 2061 6c69   that weekly ali
-0001e9f0: 676e 6564 2074 6f20 4d6f 6e64 6179 2e20  gned to Monday. 
-0001ea00: 4966 206e 6f74 2c20 7368 6966 7420 7374  If not, shift st
-0001ea10: 6172 7420 6461 7465 2062 6163 6b20 616e  art date back an
-0001ea20: 6420 7265 2d66 6574 6368 0a20 2020 2020  d re-fetch.     
-0001ea30: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-0001ea40: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-0001ea50: 7276 616c 2e57 6565 6b20 616e 6420 286e  rval.Week and (n
-0001ea60: 6f74 2064 662e 656d 7074 7929 2061 6e64  ot df.empty) and
-0001ea70: 2028 6466 2e69 6e64 6578 5b30 5d2e 7765   (df.index[0].we
-0001ea80: 656b 6461 7928 2920 213d 2030 293a 0a20  ekday() != 0):. 
-0001ea90: 2020 2020 2020 2020 2020 2023 2044 6573             # Des
-0001eaa0: 7069 7465 2066 6574 6368 5f73 7461 7274  pite fetch_start
-0001eab0: 2061 6c69 676e 6564 2074 6f20 4d6f 6e64   aligned to Mond
-0001eac0: 6179 2c20 736f 6d65 7469 6d65 7320 5961  ay, sometimes Ya
-0001ead0: 686f 6f20 7265 7475 726e 7320 7765 656b  hoo returns week
-0001eae0: 6c79 0a20 2020 2020 2020 2020 2020 2023  ly.            #
-0001eaf0: 2064 6174 6120 7374 6172 7469 6e67 2061   data starting a
-0001eb00: 2064 6966 6665 7265 6e74 2064 6179 2e20   different day. 
-0001eb10: 5368 6966 7469 6e67 2062 6163 6b20 6120  Shifting back a 
-0001eb20: 6c69 7474 6c65 2066 6978 6573 0a20 2020  little fixes.   
-0001eb30: 2020 2020 2020 2020 2073 6869 6674 5f62           shift_b
-0001eb40: 6163 6b73 203d 205b 322c 2034 5d0a 2020  acks = [2, 4].  
-0001eb50: 2020 2020 2020 2020 2020 666f 7220 6420            for d 
-0001eb60: 696e 2073 6869 6674 5f62 6163 6b73 3a0a  in shift_backs:.
-0001eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb80: 6665 7463 685f 7374 6172 7432 203d 2066  fetch_start2 = f
-0001eb90: 6574 6368 5f73 7461 7274 202d 2074 696d  etch_start - tim
-0001eba0: 6564 656c 7461 2864 6179 733d 6429 0a20  edelta(days=d). 
-0001ebb0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0001ebc0: 6973 746f 7279 5f61 7267 735b 2273 7461  istory_args["sta
-0001ebd0: 7274 225d 203d 2066 6574 6368 5f73 7461  rt"] = fetch_sta
-0001ebe0: 7274 320a 2020 2020 2020 2020 2020 2020  rt2.            
-0001ebf0: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-0001ec00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ec10: 2020 2020 2020 6d73 6720 3d20 222d 2077        msg = "- w
-0001ec20: 6565 6b6c 7920 6461 7461 206e 6f74 2061  eekly data not a
-0001ec30: 6c69 676e 6564 2074 6f20 4d6f 6e64 6179  ligned to Monday
-0001ec40: 2c20 7265 2d66 6574 6368 696e 6720 6672  , re-fetching fr
-0001ec50: 6f6d 207b 7d22 2e66 6f72 6d61 7428 6665  om {}".format(fe
-0001ec60: 7463 685f 7374 6172 7432 290a 2020 2020  tch_start2).    
-0001ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec80: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-0001ec90: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-0001eca0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-0001ecb0: 656c 7365 2070 7269 6e74 286d 7367 290a  else print(msg).
-0001ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecd0: 6466 203d 2073 656c 662e 6461 742e 6869  df = self.dat.hi
-0001ece0: 7374 6f72 7928 2a2a 6869 7374 6f72 795f  story(**history_
-0001ecf0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-0001ed00: 2020 2020 2020 6966 2022 5265 7061 6972        if "Repair
-0001ed10: 6564 3f22 206e 6f74 2069 6e20 6466 2e63  ed?" not in df.c
-0001ed20: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
-0001ed30: 2020 2020 2020 2020 2020 2020 6466 5b22              df["
-0001ed40: 5265 7061 6972 6564 3f22 5d20 3d20 4661  Repaired?"] = Fa
-0001ed50: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0001ed60: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-0001ed70: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001ed80: 6572 7661 6c2e 5765 656b 2061 6e64 2028  erval.Week and (
-0001ed90: 6466 2e69 6e64 6578 5b30 5d2e 7765 656b  df.index[0].week
-0001eda0: 6461 7928 2920 3d3d 2030 293a 0a20 2020  day() == 0):.   
-0001edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edc0: 206c 6f67 5f6d 7367 203d 2066 2272 6571   log_msg = f"req
-0001edd0: 7565 7374 6564 2066 726f 6d20 5946 3a20  uested from YF: 
-0001ede0: 7b73 656c 662e 6973 7472 7d20 7b68 6973  {self.istr} {his
-0001edf0: 746f 7279 5f61 7267 735b 2773 7461 7274  tory_args['start
-0001ee00: 275d 7d20 2d3e 207b 6869 7374 6f72 795f  ']} -> {history_
-0001ee10: 6172 6773 5b27 656e 6427 5d7d 220a 2020  args['end']}".  
-0001ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee30: 2020 6c6f 675f 6d73 6720 2b3d 2066 222c    log_msg += f",
-0001ee40: 2072 6563 6569 7665 643a 207b 6466 2e69   received: {df.i
-0001ee50: 6e64 6578 5b30 5d7d 202d 3e20 7b64 662e  ndex[0]} -> {df.
-0001ee60: 696e 6465 785b 2d31 5d7d 220a 2020 2020  index[-1]}".    
-0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee80: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
-0001ee90: 4576 656e 7428 2269 6e66 6f22 2c20 2250  Event("info", "P
-0001eea0: 7269 6365 4d61 6e61 6765 7222 2c20 6c6f  riceManager", lo
-0001eeb0: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
-0001eec0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0001eed0: 7369 6e73 7461 6e63 6528 7374 6172 742c  sinstance(start,
-0001eee0: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
-0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef00: 2020 2020 7374 6172 745f 6474 203d 2073      start_dt = s
-0001ef10: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
-0001ef20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef40: 2020 2020 2020 2073 7461 7274 5f64 7420         start_dt 
-0001ef50: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
-0001ef60: 6e65 2873 7461 7274 2c20 7469 6d65 2830  ne(start, time(0
-0001ef70: 292c 2073 656c 662e 747a 290a 2020 2020  ), self.tz).    
-0001ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef90: 6466 203d 2064 662e 6c6f 635b 7374 6172  df = df.loc[star
-0001efa0: 745f 6474 3a5d 0a20 2020 2020 2020 2020  t_dt:].         
-0001efb0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0001efc0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0001efd0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-0001efe0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-0001eff0: 5765 656b 2061 6e64 2028 6466 2e69 6e64  Week and (df.ind
-0001f000: 6578 5b30 5d2e 7765 656b 6461 7928 2920  ex[0].weekday() 
-0001f010: 213d 2030 293a 0a20 2020 2020 2020 2020  != 0):.         
-0001f020: 2020 2020 2020 2023 2070 7269 6e74 2822         # print("
-0001f030: 4461 7465 2072 616e 6765 2072 6571 7565  Date range reque
-0001f040: 7374 6564 3a20 7b7d 202d 3e20 7b7d 222e  sted: {} -> {}".
-0001f050: 666f 726d 6174 2866 6574 6368 5f73 7461  format(fetch_sta
-0001f060: 7274 2c20 6665 7463 685f 656e 6429 290a  rt, fetch_end)).
-0001f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f080: 7072 696e 7428 6466 290a 2020 2020 2020  print(df).      
-0001f090: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001f0a0: 4578 6365 7074 696f 6e28 2257 6565 6b6c  Exception("Weekl
-0001f0b0: 7920 6461 7461 2072 6574 7572 6e65 6420  y data returned 
-0001f0c0: 6279 2059 4620 646f 6573 6e27 7420 6265  by YF doesn't be
-0001f0d0: 6769 6e20 4d6f 6e64 6179 2062 7574 207b  gin Monday but {
-0001f0e0: 7d22 2e66 6f72 6d61 7428 6466 2e69 6e64  }".format(df.ind
-0001f0f0: 6578 5b30 5d2e 7765 656b 6461 7928 2929  ex[0].weekday())
-0001f100: 290a 0a20 2020 2020 2020 2069 6620 6466  )..        if df
-0001f110: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0001f120: 2064 662e 656d 7074 793a 0a20 2020 2020   df.empty:.     
-0001f130: 2020 2020 2020 2064 6620 3d20 4e6f 6e65         df = None
-0001f140: 0a0a 2020 2020 2020 2020 6966 2064 6620  ..        if df 
-0001f150: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001f160: 2020 2020 206c 6f67 5f6d 7367 203d 2022       log_msg = "
-0001f170: 504d 3a3a 5f66 6574 6368 5966 4869 7374  PM::_fetchYfHist
-0001f180: 6f72 795f 6461 7465 5261 6e67 6528 2920  ory_dateRange() 
-0001f190: 7265 7475 726e 696e 6720 4e6f 6e65 220a  returning None".
-0001f1a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f1b0: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
-0001f1c0: 6720 3d20 6622 504d 3a3a 5f66 6574 6368  g = f"PM::_fetch
-0001f1d0: 5966 4869 7374 6f72 795f 6461 7465 5261  YfHistory_dateRa
-0001f1e0: 6e67 6528 2920 7265 7475 726e 696e 6720  nge() returning 
-0001f1f0: 4446 207b 6466 2e69 6e64 6578 5b30 5d7d  DF {df.index[0]}
-0001f200: 202d 3e20 7b64 662e 696e 6465 785b 2d31   -> {df.index[-1
-0001f210: 5d7d 220a 2020 2020 2020 2020 6966 2079  ]}".        if y
-0001f220: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-0001f230: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
-0001f240: 2020 2020 7966 636c 2e54 7261 6365 4578      yfcl.TraceEx
-0001f250: 6974 286c 6f67 5f6d 7367 290a 2020 2020  it(log_msg).    
-0001f260: 2020 2020 656c 6966 2064 6562 7567 5f79      elif debug_y
-0001f270: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-0001f280: 7072 696e 7428 6c6f 675f 6d73 6729 0a0a  print(log_msg)..
-0001f290: 2020 2020 2020 2020 2320 6466 203d 2079          # df = y
-0001f2a0: 6663 752e 4375 7374 6f6d 4e61 6e43 6865  fcu.CustomNanChe
-0001f2b0: 636b 696e 6744 6174 6146 7261 6d65 2864  ckingDataFrame(d
-0001f2c0: 6629 0a0a 2020 2020 2020 2020 7265 7475  f)..        retu
-0001f2d0: 726e 2064 660a 0a20 2020 2064 6566 205f  rn df..    def _
-0001f2e0: 7265 636f 6e73 7472 7563 745f 696e 7465  reconstruct_inte
-0001f2f0: 7276 616c 735f 6261 7463 6828 7365 6c66  rvals_batch(self
-0001f300: 2c20 6466 2c20 7461 673d 2d31 293a 0a20  , df, tag=-1):. 
-0001f310: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0001f320: 696e 7374 616e 6365 2864 662c 2070 642e  instance(df, pd.
-0001f330: 4461 7461 4672 616d 6529 3a0a 2020 2020  DataFrame):.    
-0001f340: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0001f350: 6365 7074 696f 6e28 2227 6466 2720 6d75  ception("'df' mu
-0001f360: 7374 2062 6520 6120 5061 6e64 6173 2044  st be a Pandas D
-0001f370: 6174 6146 7261 6d65 206e 6f74 222c 2074  ataFrame not", t
-0001f380: 7970 6528 6466 2929 0a20 2020 2020 2020  ype(df)).       
-0001f390: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
-0001f3a0: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-0001f3b0: 616c 2e4d 696e 7331 3a0a 2020 2020 2020  al.Mins1:.      
-0001f3c0: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
-0001f3d0: 0a20 2020 2020 2020 2023 2052 6563 6f6e  .        # Recon
-0001f3e0: 7374 7275 6374 2076 616c 7565 7320 696e  struct values in
-0001f3f0: 2064 6620 7573 696e 6720 6669 6e65 722d   df using finer-
-0001f400: 6772 6169 6e65 6420 7072 6963 6520 6461  grained price da
-0001f410: 7461 2e20 4465 6c69 6d69 7465 7220 6d61  ta. Delimiter ma
-0001f420: 726b 7320 7768 6174 2074 6f20 7265 636f  rks what to reco
-0001f430: 6e73 7472 7563 740a 0a20 2020 2020 2020  nstruct..       
-0001f440: 2064 6562 7567 203d 2046 616c 7365 0a20   debug = False. 
-0001f450: 2020 2020 2020 2023 2064 6562 7567 203d         # debug =
-0001f460: 2054 7275 650a 0a20 2020 2020 2020 2070   True..        p
-0001f470: 7269 6365 5f63 6f6c 7320 3d20 5b63 2066  rice_cols = [c f
-0001f480: 6f72 2063 2069 6e20 5b22 4f70 656e 222c  or c in ["Open",
-0001f490: 2022 4869 6768 222c 2022 4c6f 7722 2c20   "High", "Low", 
-0001f4a0: 2243 6c6f 7365 222c 2022 4164 6a20 436c  "Close", "Adj Cl
-0001f4b0: 6f73 6522 5d20 6966 2063 2069 6e20 6466  ose"] if c in df
-0001f4c0: 5d0a 2020 2020 2020 2020 6461 7461 5f63  ].        data_c
-0001f4d0: 6f6c 7320 3d20 7072 6963 655f 636f 6c73  ols = price_cols
-0001f4e0: 202b 205b 2256 6f6c 756d 6522 5d0a 0a20   + ["Volume"].. 
-0001f4f0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
-0001f500: 2066 2250 4d3a 3a5f 7265 636f 6e73 7472   f"PM::_reconstr
-0001f510: 7563 745f 696e 7465 7276 616c 735f 6261  uct_intervals_ba
-0001f520: 7463 682d 7b73 656c 662e 6973 7472 7d28  tch-{self.istr}(
-0001f530: 6474 303d 7b64 662e 696e 6465 785b 305d  dt0={df.index[0]
-0001f540: 7d29 220a 2020 2020 2020 2020 7966 636c  })".        yfcl
-0001f550: 2e54 7261 6365 456e 7465 7228 6c6f 675f  .TraceEnter(log_
-0001f560: 6d73 6729 0a0a 2020 2020 2020 2020 2320  msg)..        # 
-0001f570: 4966 2069 6e74 6572 7661 6c20 6973 2077  If interval is w
-0001f580: 6565 6b6c 7920 7468 656e 2063 616e 2063  eekly then can c
-0001f590: 6f6e 7374 7275 6374 2077 6974 6820 6461  onstruct with da
-0001f5a0: 696c 792e 2042 7574 2069 6620 736d 616c  ily. But if smal
-0001f5b0: 6c65 7220 696e 7465 7276 616c 7320 7468  ler intervals th
-0001f5c0: 656e 0a20 2020 2020 2020 2023 2072 6573  en.        # res
-0001f5d0: 7472 6963 7465 6420 746f 2072 6563 656e  tricted to recen
-0001f5e0: 7420 7469 6d65 733a 0a20 2020 2020 2020  t times:.       
-0001f5f0: 206d 696e 5f6c 6f6f 6b62 6163 6b20 3d20   min_lookback = 
-0001f600: 4e6f 6e65 0a20 2020 2020 2020 2023 202d  None.        # -
-0001f610: 2064 6169 6c79 203d 2068 6f75 726c 7920   daily = hourly 
-0001f620: 7265 7374 7269 6374 6564 2074 6f20 6c61  restricted to la
-0001f630: 7374 2037 3330 2064 6179 730a 2020 2020  st 730 days.    
-0001f640: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-0001f650: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001f660: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
-0001f670: 2020 2020 2020 2020 2320 436f 7272 6563          # Correc
-0001f680: 7420 6279 2066 6574 6368 696e 6720 7765  t by fetching we
-0001f690: 656b 206f 6620 6461 696c 7920 6461 7461  ek of daily data
-0001f6a0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-0001f6b0: 5f69 6e74 6572 7661 6c20 3d20 7966 6364  _interval = yfcd
-0001f6c0: 2e49 6e74 6572 7661 6c2e 4461 7973 310a  .Interval.Days1.
-0001f6d0: 2020 2020 2020 2020 2020 2020 7464 5f72              td_r
-0001f6e0: 616e 6765 203d 2074 696d 6564 656c 7461  ange = timedelta
-0001f6f0: 2864 6179 733d 3729 0a20 2020 2020 2020  (days=7).       
-0001f700: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
-0001f710: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-0001f720: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
-0001f730: 2020 2020 2020 2020 2320 436f 7272 6563          # Correc
-0001f740: 7420 6279 2066 6574 6368 696e 6720 6461  t by fetching da
-0001f750: 7920 6f66 2068 6f75 726c 7920 6461 7461  y of hourly data
-0001f760: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-0001f770: 5f69 6e74 6572 7661 6c20 3d20 7966 6364  _interval = yfcd
-0001f780: 2e49 6e74 6572 7661 6c2e 486f 7572 7331  .Interval.Hours1
-0001f790: 0a20 2020 2020 2020 2020 2020 2074 645f  .            td_
-0001f7a0: 7261 6e67 6520 3d20 7469 6d65 6465 6c74  range = timedelt
-0001f7b0: 6128 6461 7973 3d31 290a 2020 2020 2020  a(days=1).      
-0001f7c0: 2020 2020 2020 6d69 6e5f 6c6f 6f6b 6261        min_lookba
-0001f7d0: 636b 203d 2074 696d 6564 656c 7461 2864  ck = timedelta(d
-0001f7e0: 6179 733d 3733 3029 0a20 2020 2020 2020  ays=730).       
-0001f7f0: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
-0001f800: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-0001f810: 7276 616c 2e48 6f75 7273 313a 0a20 2020  rval.Hours1:.   
-0001f820: 2020 2020 2020 2020 2023 2043 6f72 7265           # Corre
-0001f830: 6374 2062 7920 6665 7463 6869 6e67 2068  ct by fetching h
-0001f840: 6f75 7220 6f66 2033 306d 2064 6174 610a  our of 30m data.
-0001f850: 2020 2020 2020 2020 2020 2020 7375 625f              sub_
-0001f860: 696e 7465 7276 616c 203d 2079 6663 642e  interval = yfcd.
-0001f870: 496e 7465 7276 616c 2e4d 696e 7333 300a  Interval.Mins30.
-0001f880: 2020 2020 2020 2020 2020 2020 7464 5f72              td_r
-0001f890: 616e 6765 203d 2074 696d 6564 656c 7461  ange = timedelta
-0001f8a0: 2868 6f75 7273 3d31 290a 2020 2020 2020  (hours=1).      
-0001f8b0: 2020 2020 2020 6d69 6e5f 6c6f 6f6b 6261        min_lookba
-0001f8c0: 636b 203d 2074 696d 6564 656c 7461 2864  ck = timedelta(d
-0001f8d0: 6179 733d 3630 290a 2020 2020 2020 2020  ays=60).        
-0001f8e0: 656c 6966 2073 656c 662e 696e 7465 7276  elif self.interv
-0001f8f0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-0001f900: 7661 6c2e 4d69 6e73 3330 3a0a 2020 2020  val.Mins30:.    
-0001f910: 2020 2020 2020 2020 2320 436f 7272 6563          # Correc
-0001f920: 7420 6279 2066 6574 6368 696e 6720 686f  t by fetching ho
-0001f930: 7572 206f 6620 3135 6d20 6461 7461 0a20  ur of 15m data. 
-0001f940: 2020 2020 2020 2020 2020 2073 7562 5f69             sub_i
-0001f950: 6e74 6572 7661 6c20 3d20 7966 6364 2e49  nterval = yfcd.I
-0001f960: 6e74 6572 7661 6c2e 4d69 6e73 3135 0a20  nterval.Mins15. 
-0001f970: 2020 2020 2020 2020 2020 2074 645f 7261             td_ra
-0001f980: 6e67 6520 3d20 7469 6d65 6465 6c74 6128  nge = timedelta(
-0001f990: 6d69 6e75 7465 733d 3330 290a 2020 2020  minutes=30).    
-0001f9a0: 2020 2020 2020 2020 6d69 6e5f 6c6f 6f6b          min_look
-0001f9b0: 6261 636b 203d 2074 696d 6564 656c 7461  back = timedelta
-0001f9c0: 2864 6179 733d 3630 290a 2020 2020 2020  (days=60).      
-0001f9d0: 2020 656c 6966 2073 656c 662e 696e 7465    elif self.inte
-0001f9e0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001f9f0: 6572 7661 6c2e 4d69 6e73 3135 3a0a 2020  erval.Mins15:.  
-0001fa00: 2020 2020 2020 2020 2020 2320 436f 7272            # Corr
-0001fa10: 6563 7420 6279 2066 6574 6368 696e 6720  ect by fetching 
-0001fa20: 686f 7572 206f 6620 356d 2064 6174 610a  hour of 5m data.
-0001fa30: 2020 2020 2020 2020 2020 2020 7375 625f              sub_
-0001fa40: 696e 7465 7276 616c 203d 2079 6663 642e  interval = yfcd.
-0001fa50: 496e 7465 7276 616c 2e4d 696e 7335 0a20  Interval.Mins5. 
-0001fa60: 2020 2020 2020 2020 2020 2074 645f 7261             td_ra
-0001fa70: 6e67 6520 3d20 7469 6d65 6465 6c74 6128  nge = timedelta(
-0001fa80: 6d69 6e75 7465 733d 3135 290a 2020 2020  minutes=15).    
-0001fa90: 2020 2020 2020 2020 6d69 6e5f 6c6f 6f6b          min_look
-0001faa0: 6261 636b 203d 2074 696d 6564 656c 7461  back = timedelta
-0001fab0: 2864 6179 733d 3630 290a 2020 2020 2020  (days=60).      
-0001fac0: 2020 656c 6966 2073 656c 662e 696e 7465    elif self.inte
-0001fad0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001fae0: 6572 7661 6c2e 4d69 6e73 353a 0a20 2020  erval.Mins5:.   
-0001faf0: 2020 2020 2020 2020 2023 2043 6f72 7265           # Corre
-0001fb00: 6374 2062 7920 6665 7463 6869 6e67 2068  ct by fetching h
-0001fb10: 6f75 7220 6f66 2032 6d20 6461 7461 0a20  our of 2m data. 
-0001fb20: 2020 2020 2020 2020 2020 2073 7562 5f69             sub_i
-0001fb30: 6e74 6572 7661 6c20 3d20 7966 6364 2e49  nterval = yfcd.I
-0001fb40: 6e74 6572 7661 6c2e 4d69 6e73 320a 2020  nterval.Mins2.  
-0001fb50: 2020 2020 2020 2020 2020 7464 5f72 616e            td_ran
-0001fb60: 6765 203d 2074 696d 6564 656c 7461 286d  ge = timedelta(m
-0001fb70: 696e 7574 6573 3d35 290a 2020 2020 2020  inutes=5).      
-0001fb80: 2020 2020 2020 6d69 6e5f 6c6f 6f6b 6261        min_lookba
-0001fb90: 636b 203d 2074 696d 6564 656c 7461 2864  ck = timedelta(d
-0001fba0: 6179 733d 3630 290a 2020 2020 2020 2020  ays=60).        
-0001fbb0: 656c 6966 2073 656c 662e 696e 7465 7276  elif self.interv
-0001fbc0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-0001fbd0: 7661 6c2e 4d69 6e73 323a 0a20 2020 2020  val.Mins2:.     
-0001fbe0: 2020 2020 2020 2023 2043 6f72 7265 6374         # Correct
-0001fbf0: 2062 7920 6665 7463 6869 6e67 2068 6f75   by fetching hou
-0001fc00: 7220 6f66 2031 6d20 6461 7461 0a20 2020  r of 1m data.   
-0001fc10: 2020 2020 2020 2020 2073 7562 5f69 6e74           sub_int
-0001fc20: 6572 7661 6c20 3d20 7966 6364 2e49 6e74  erval = yfcd.Int
-0001fc30: 6572 7661 6c2e 4d69 6e73 310a 2020 2020  erval.Mins1.    
-0001fc40: 2020 2020 2020 2020 7464 5f72 616e 6765          td_range
-0001fc50: 203d 2074 696d 6564 656c 7461 286d 696e   = timedelta(min
-0001fc60: 7574 6573 3d32 290a 2020 2020 2020 2020  utes=2).        
-0001fc70: 2020 2020 6d69 6e5f 6c6f 6f6b 6261 636b      min_lookback
-0001fc80: 203d 2074 696d 6564 656c 7461 2864 6179   = timedelta(day
-0001fc90: 733d 3330 290a 2020 2020 2020 2020 656c  s=30).        el
-0001fca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001fcb0: 6d73 6720 3d20 6622 5741 524e 494e 473a  msg = f"WARNING:
-0001fcc0: 2048 6176 6520 6e6f 7420 696d 706c 656d   Have not implem
-0001fcd0: 656e 7465 6420 7265 7061 6972 2066 6f72  ented repair for
-0001fce0: 2027 7b73 656c 662e 696e 7465 7276 616c   '{self.interval
-0001fcf0: 7d27 2069 6e74 6572 7661 6c2e 2043 6f6e  }' interval. Con
-0001fd00: 7461 6374 2064 6576 656c 6f70 6572 7322  tact developers"
-0001fd10: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
-0001fd20: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-0001fd30: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-0001fd40: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-0001fd50: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
-0001fd60: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
-0001fd70: 203d 2022 504d 3a3a 5f72 6563 6f6e 7374   = "PM::_reconst
-0001fd80: 7275 6374 5f69 6e74 6572 7661 6c73 5f62  ruct_intervals_b
-0001fd90: 6174 6368 2829 2072 6574 7572 6e69 6e67  atch() returning
-0001fda0: 220a 2020 2020 2020 2020 2020 2020 7966  ".            yf
-0001fdb0: 636c 2e54 7261 6365 4578 6974 286c 6f67  cl.TraceExit(log
-0001fdc0: 5f6d 7367 290a 2020 2020 2020 2020 2020  _msg).          
-0001fdd0: 2020 7265 7475 726e 2064 660a 2020 2020    return df.    
-0001fde0: 2020 2020 7375 625f 696e 7465 7264 6179      sub_interday
-0001fdf0: 203d 2073 7562 5f69 6e74 6572 7661 6c20   = sub_interval 
-0001fe00: 696e 205b 7966 6364 2e49 6e74 6572 7661  in [yfcd.Interva
-0001fe10: 6c2e 4461 7973 312c 2079 6663 642e 496e  l.Days1, yfcd.In
-0001fe20: 7465 7276 616c 2e57 6565 6b2c 2079 6663  terval.Week, yfc
-0001fe30: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
-0001fe40: 7331 2c20 7966 6364 2e49 6e74 6572 7661  s1, yfcd.Interva
-0001fe50: 6c2e 4d6f 6e74 6873 335d 0a20 2020 2020  l.Months3].     
-0001fe60: 2020 2073 7562 5f69 6e74 7261 6461 7920     sub_intraday 
-0001fe70: 3d20 6e6f 7420 7375 625f 696e 7465 7264  = not sub_interd
-0001fe80: 6179 0a0a 2020 2020 2020 2020 6466 203d  ay..        df =
-0001fe90: 2064 662e 736f 7274 5f69 6e64 6578 2829   df.sort_index()
-0001fea0: 0a0a 2020 2020 2020 2020 665f 7265 7061  ..        f_repa
-0001feb0: 6972 203d 2064 665b 6461 7461 5f63 6f6c  ir = df[data_col
-0001fec0: 735d 2e74 6f5f 6e75 6d70 7928 2920 3d3d  s].to_numpy() ==
-0001fed0: 2074 6167 0a20 2020 2020 2020 2066 5f72   tag.        f_r
-0001fee0: 6570 6169 725f 726f 7773 203d 2066 5f72  epair_rows = f_r
-0001fef0: 6570 6169 722e 616e 7928 6178 6973 3d31  epair.any(axis=1
-0001ff00: 290a 0a20 2020 2020 2020 2023 2049 676e  )..        # Ign
-0001ff10: 6f72 6520 6f6c 6420 696e 7465 7276 616c  ore old interval
-0001ff20: 7320 666f 7220 7768 6963 6820 5961 686f  s for which Yaho
-0001ff30: 6f20 776f 6e27 7420 7265 7475 726e 2066  o won't return f
-0001ff40: 696e 6572 2064 6174 613a 0a20 2020 2020  iner data:.     
-0001ff50: 2020 2023 2069 6620 7375 625f 696e 7465     # if sub_inte
-0001ff60: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001ff70: 6572 7661 6c2e 486f 7572 7331 3a0a 2020  erval.Hours1:.  
-0001ff80: 2020 2020 2020 2320 2020 2020 665f 7265        #     f_re
-0001ff90: 6365 6e74 203d 2064 6174 652e 746f 6461  cent = date.toda
-0001ffa0: 7928 2920 2d20 6466 2e69 6e64 6578 2e64  y() - df.index.d
-0001ffb0: 6174 6520 3c20 7469 6d65 6465 6c74 6128  ate < timedelta(
-0001ffc0: 6461 7973 3d37 3330 290a 2020 2020 2020  days=730).      
-0001ffd0: 2020 2320 2020 2020 665f 7265 7061 6972    #     f_repair
-0001ffe0: 5f72 6f77 7320 3d20 665f 7265 7061 6972  _rows = f_repair
-0001fff0: 5f72 6f77 7320 2620 665f 7265 6365 6e74  _rows & f_recent
-00020000: 0a20 2020 2020 2020 2023 2065 6c69 6620  .        # elif 
-00020010: 7375 625f 696e 7465 7276 616c 2069 6e20  sub_interval in 
-00020020: 5b79 6663 642e 496e 7465 7276 616c 2e4d  [yfcd.Interval.M
-00020030: 696e 7333 302c 2079 6663 642e 496e 7465  ins30, yfcd.Inte
-00020040: 7276 616c 2e4d 696e 7331 355d 3a0a 2020  rval.Mins15]:.  
-00020050: 2020 2020 2020 2320 2020 2020 665f 7265        #     f_re
-00020060: 6365 6e74 203d 2064 6174 652e 746f 6461  cent = date.toda
-00020070: 7928 2920 2d20 6466 2e69 6e64 6578 2e64  y() - df.index.d
-00020080: 6174 6520 3c20 7469 6d65 6465 6c74 6128  ate < timedelta(
-00020090: 6461 7973 3d36 3029 0a20 2020 2020 2020  days=60).       
-000200a0: 2023 2020 2020 2066 5f72 6570 6169 725f   #     f_repair_
-000200b0: 726f 7773 203d 2066 5f72 6570 6169 725f  rows = f_repair_
-000200c0: 726f 7773 2026 2066 5f72 6563 656e 740a  rows & f_recent.
-000200d0: 2020 2020 2020 2020 6966 206d 696e 5f6c          if min_l
-000200e0: 6f6f 6b62 6163 6b20 6973 204e 6f6e 653a  ookback is None:
-000200f0: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
-00020100: 5f64 7420 3d20 4e6f 6e65 0a20 2020 2020  _dt = None.     
-00020110: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00020120: 2020 2020 206d 696e 5f64 7420 3d20 7064       min_dt = pd
-00020130: 2e54 696d 6573 7461 6d70 2e75 7463 6e6f  .Timestamp.utcno
-00020140: 7728 292e 747a 5f63 6f6e 7665 7274 285a  w().tz_convert(Z
-00020150: 6f6e 6549 6e66 6f28 2255 5443 2229 2920  oneInfo("UTC")) 
-00020160: 2d20 6d69 6e5f 6c6f 6f6b 6261 636b 0a20  - min_lookback. 
-00020170: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
-00020180: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00020190: 6e74 2866 222d 206d 696e 5f64 743d 7b6d  nt(f"- min_dt={m
-000201a0: 696e 5f64 747d 2069 6e74 6572 7661 6c3d  in_dt} interval=
-000201b0: 7b73 656c 662e 696e 7465 7276 616c 7d20  {self.interval} 
-000201c0: 7375 625f 696e 7465 7276 616c 3d7b 7375  sub_interval={su
-000201d0: 625f 696e 7465 7276 616c 7d22 290a 2020  b_interval}").  
-000201e0: 2020 2020 2020 6966 206d 696e 5f64 7420        if min_dt 
-000201f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00020200: 2020 2020 2020 2020 2066 5f72 6563 656e           f_recen
-00020210: 7420 3d20 6466 2e69 6e64 6578 203e 206d  t = df.index > m
-00020220: 696e 5f64 740a 2020 2020 2020 2020 2020  in_dt.          
-00020230: 2020 665f 7265 7061 6972 5f72 6f77 7320    f_repair_rows 
-00020240: 3d20 665f 7265 7061 6972 5f72 6f77 7320  = f_repair_rows 
-00020250: 2620 665f 7265 6365 6e74 0a20 2020 2020  & f_recent.     
-00020260: 2020 2020 2020 2069 6620 6e6f 7420 665f         if not f_
-00020270: 7265 7061 6972 5f72 6f77 732e 616e 7928  repair_rows.any(
-00020280: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00020290: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-000202a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202b0: 2070 7269 6e74 2822 2d20 6461 7461 2074   print("- data t
-000202c0: 6f6f 206f 6c64 2074 6f20 7265 7061 6972  oo old to repair
-000202d0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-000202e0: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
-000202f0: 2020 2020 2020 6474 735f 746f 5f72 6570        dts_to_rep
-00020300: 6169 7220 3d20 6466 2e69 6e64 6578 5b66  air = df.index[f
-00020310: 5f72 6570 6169 725f 726f 7773 5d0a 2020  _repair_rows].  
-00020320: 2020 2020 2020 2320 696e 6469 6365 735f        # indices_
-00020330: 746f 5f72 6570 6169 7220 3d20 6e70 2e77  to_repair = np.w
-00020340: 6865 7265 2866 5f72 6570 6169 725f 726f  here(f_repair_ro
-00020350: 7773 295b 305d 0a0a 2020 2020 2020 2020  ws)[0]..        
-00020360: 6966 206c 656e 2864 7473 5f74 6f5f 7265  if len(dts_to_re
-00020370: 7061 6972 2920 3d3d 2030 3a0a 2020 2020  pair) == 0:.    
-00020380: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00020390: 660a 0a20 2020 2020 2020 2064 665f 7632  f..        df_v2
-000203a0: 203d 2064 662e 636f 7079 2829 0a20 2020   = df.copy().   
-000203b0: 2020 2020 2069 6620 2252 6570 6169 7265       if "Repaire
-000203c0: 643f 2220 6e6f 7420 696e 2064 665f 7632  d?" not in df_v2
-000203d0: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
-000203e0: 2020 2020 2020 6466 5f76 325b 2252 6570        df_v2["Rep
-000203f0: 6169 7265 643f 225d 203d 2046 616c 7365  aired?"] = False
-00020400: 0a20 2020 2020 2020 2064 665f 676f 6f64  .        df_good
-00020410: 203d 2064 665b 7e64 665b 7072 6963 655f   = df[~df[price_
-00020420: 636f 6c73 5d2e 6973 6e61 2829 2e61 6e79  cols].isna().any
-00020430: 2861 7869 733d 3129 5d0a 2020 2020 2020  (axis=1)].      
-00020440: 2020 665f 7461 6720 3d20 6466 5f76 325b    f_tag = df_v2[
-00020450: 7072 6963 655f 636f 6c73 5d2e 746f 5f6e  price_cols].to_n
-00020460: 756d 7079 2829 203d 3d20 7461 670a 0a20  umpy() == tag.. 
-00020470: 2020 2020 2020 2023 2047 726f 7570 206e         # Group n
-00020480: 6561 7262 7920 4e61 4e2d 696e 7465 7276  earby NaN-interv
-00020490: 616c 7320 746f 6765 7468 6572 2074 6f20  als together to 
-000204a0: 7265 6475 6365 206e 756d 6265 7220 6f66  reduce number of
-000204b0: 2059 6168 6f6f 2066 6574 6368 6573 0a20   Yahoo fetches. 
-000204c0: 2020 2020 2020 2064 7473 5f67 726f 7570         dts_group
-000204d0: 7320 3d20 5b5b 6474 735f 746f 5f72 6570  s = [[dts_to_rep
-000204e0: 6169 725b 305d 5d5d 0a20 2020 2020 2020  air[0]]].       
-000204f0: 2023 206c 6173 745f 6474 203d 2064 7473   # last_dt = dts
-00020500: 5f74 6f5f 7265 7061 6972 5b30 5d0a 2020  _to_repair[0].  
-00020510: 2020 2020 2020 2320 6c61 7374 5f69 6e64        # last_ind
-00020520: 203d 2069 6e64 6963 6573 5f74 6f5f 7265   = indices_to_re
-00020530: 7061 6972 5b30 5d0a 2020 2020 2020 2020  pair[0].        
-00020540: 2320 7464 203d 2079 6663 642e 696e 7465  # td = yfcd.inte
-00020550: 7276 616c 546f 5469 6d65 6465 6c74 615b  rvalToTimedelta[
-00020560: 7365 6c66 2e69 6e74 6572 7661 6c5d 0a20  self.interval]. 
-00020570: 2020 2020 2020 2023 2069 6620 7365 6c66         # if self
-00020580: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-00020590: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
-000205a0: 7331 3a0a 2020 2020 2020 2020 2320 2020  s1:.        #   
-000205b0: 2020 6772 705f 7464 5f74 6872 6573 686f    grp_td_thresho
-000205c0: 6c64 203d 2074 696d 6564 656c 7461 2864  ld = timedelta(d
-000205d0: 6179 733d 3238 290a 2020 2020 2020 2020  ays=28).        
-000205e0: 2320 656c 6966 2073 656c 662e 696e 7465  # elif self.inte
-000205f0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-00020600: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
-00020610: 2020 2020 2320 2020 2020 6772 705f 7464      #     grp_td
-00020620: 5f74 6872 6573 686f 6c64 203d 2074 696d  _threshold = tim
-00020630: 6564 656c 7461 2864 6179 733d 3238 290a  edelta(days=28).
-00020640: 2020 2020 2020 2020 2320 656c 6966 2073          # elif s
-00020650: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-00020660: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-00020670: 7973 313a 0a20 2020 2020 2020 2023 2020  ys1:.        #  
-00020680: 2020 2067 7270 5f74 645f 7468 7265 7368     grp_td_thresh
-00020690: 6f6c 6420 3d20 7469 6d65 6465 6c74 6128  old = timedelta(
-000206a0: 6461 7973 3d31 3429 0a20 2020 2020 2020  days=14).       
-000206b0: 2023 2065 6c69 6620 7365 6c66 2e69 6e74   # elif self.int
-000206c0: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-000206d0: 7465 7276 616c 2e48 6f75 7273 313a 0a20  terval.Hours1:. 
-000206e0: 2020 2020 2020 2023 2020 2020 2067 7270         #     grp
-000206f0: 5f74 645f 7468 7265 7368 6f6c 6420 3d20  _td_threshold = 
-00020700: 7469 6d65 6465 6c74 6128 6461 7973 3d37  timedelta(days=7
-00020710: 290a 2020 2020 2020 2020 2320 656c 7365  ).        # else
-00020720: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
-00020730: 6772 705f 7464 5f74 6872 6573 686f 6c64  grp_td_threshold
-00020740: 203d 2074 696d 6564 656c 7461 2864 6179   = timedelta(day
-00020750: 733d 3229 0a20 2020 2020 2020 2023 2020  s=2).        #  
-00020760: 2020 2023 2067 7270 5f74 645f 7468 7265     # grp_td_thre
-00020770: 7368 6f6c 6420 3d20 7469 6d65 6465 6c74  shold = timedelt
-00020780: 6128 6461 7973 3d37 290a 2020 2020 2020  a(days=7).      
-00020790: 2020 2320 666f 7220 6920 696e 2072 616e    # for i in ran
-000207a0: 6765 2831 2c20 6c65 6e28 6474 735f 746f  ge(1, len(dts_to
-000207b0: 5f72 6570 6169 7229 293a 0a20 2020 2020  _repair)):.     
-000207c0: 2020 2023 2020 2020 2069 6e64 203d 2069     #     ind = i
-000207d0: 6e64 6963 6573 5f74 6f5f 7265 7061 6972  ndices_to_repair
-000207e0: 5b69 5d0a 2020 2020 2020 2020 2320 2020  [i].        #   
-000207f0: 2020 6474 203d 2064 7473 5f74 6f5f 7265    dt = dts_to_re
-00020800: 7061 6972 5b69 5d0a 2020 2020 2020 2020  pair[i].        
-00020810: 2320 2020 2020 6966 2028 6474 2d64 7473  #     if (dt-dts
-00020820: 5f67 726f 7570 735b 2d31 5d5b 2d31 5d29  _groups[-1][-1])
-00020830: 203c 2067 7270 5f74 645f 7468 7265 7368   < grp_td_thresh
-00020840: 6f6c 643a 0a20 2020 2020 2020 2023 2020  old:.        #  
-00020850: 2020 2020 2020 2064 7473 5f67 726f 7570         dts_group
-00020860: 735b 2d31 5d2e 6170 7065 6e64 2864 7429  s[-1].append(dt)
-00020870: 0a20 2020 2020 2020 2023 2020 2020 2065  .        #     e
-00020880: 6c69 6620 696e 6420 2d20 6c61 7374 5f69  lif ind - last_i
-00020890: 6e64 203c 3d20 333a 0a20 2020 2020 2020  nd <= 3:.       
-000208a0: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
-000208b0: 726f 7570 735b 2d31 5d2e 6170 7065 6e64  roups[-1].append
-000208c0: 2864 7429 0a20 2020 2020 2020 2023 2020  (dt).        #  
-000208d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000208e0: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
-000208f0: 726f 7570 732e 6170 7065 6e64 285b 6474  roups.append([dt
-00020900: 5d29 0a20 2020 2020 2020 2023 2020 2020  ]).        #    
-00020910: 206c 6173 745f 6474 203d 2064 740a 2020   last_dt = dt.  
-00020920: 2020 2020 2020 2320 2020 2020 6c61 7374        #     last
-00020930: 5f69 6e64 203d 2069 6e64 0a20 2020 2020  _ind = ind.     
-00020940: 2020 2023 2066 6f72 2069 2069 6e20 7261     # for i in ra
-00020950: 6e67 6528 312c 206c 656e 2864 7473 5f74  nge(1, len(dts_t
-00020960: 6f5f 7265 7061 6972 2929 3a0a 2020 2020  o_repair)):.    
-00020970: 2020 2020 2320 2020 2020 696e 6420 3d20      #     ind = 
-00020980: 696e 6469 6365 735f 746f 5f72 6570 6169  indices_to_repai
-00020990: 725b 695d 0a20 2020 2020 2020 2023 2020  r[i].        #  
-000209a0: 2020 2064 7420 3d20 6474 735f 746f 5f72     dt = dts_to_r
-000209b0: 6570 6169 725b 695d 0a20 2020 2020 2020  epair[i].       
-000209c0: 2023 2020 2020 2069 6620 2864 742d 6474   #     if (dt-dt
-000209d0: 735f 6772 6f75 7073 5b2d 315d 5b2d 315d  s_groups[-1][-1]
-000209e0: 2920 3c20 6772 705f 7464 5f74 6872 6573  ) < grp_td_thres
-000209f0: 686f 6c64 3a0a 2020 2020 2020 2020 2320  hold:.        # 
-00020a00: 2020 2020 2020 2020 6474 735f 6772 6f75          dts_grou
-00020a10: 7073 5b2d 315d 2e61 7070 656e 6428 6474  ps[-1].append(dt
-00020a20: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00020a30: 656c 6966 2069 6e64 202d 206c 6173 745f  elif ind - last_
-00020a40: 696e 6420 3c3d 2033 3a0a 2020 2020 2020  ind <= 3:.      
-00020a50: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
-00020a60: 6772 6f75 7073 5b2d 315d 2e61 7070 656e  groups[-1].appen
-00020a70: 6428 6474 290a 2020 2020 2020 2020 2320  d(dt).        # 
-00020a80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00020a90: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
-00020aa0: 6772 6f75 7073 2e61 7070 656e 6428 5b64  groups.append([d
-00020ab0: 745d 290a 2020 2020 2020 2020 2320 2020  t]).        #   
-00020ac0: 2020 6c61 7374 5f64 7420 3d20 6474 0a20    last_dt = dt. 
-00020ad0: 2020 2020 2020 2023 2020 2020 206c 6173         #     las
-00020ae0: 745f 696e 6420 3d20 696e 640a 2020 2020  t_ind = ind.    
-00020af0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-00020b00: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-00020b10: 6572 7661 6c2e 4d6f 6e74 6873 313a 0a20  erval.Months1:. 
-00020b20: 2020 2020 2020 2020 2020 2067 7270 5f6d             grp_m
-00020b30: 6178 5f73 697a 6520 3d20 6461 7465 7574  ax_size = dateut
-00020b40: 696c 2e72 656c 6174 6976 6564 656c 7461  il.relativedelta
-00020b50: 2e72 656c 6174 6976 6564 656c 7461 2879  .relativedelta(y
-00020b60: 6561 7273 3d32 290a 2020 2020 2020 2020  ears=2).        
-00020b70: 656c 6966 2073 656c 662e 696e 7465 7276  elif self.interv
-00020b80: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-00020b90: 7661 6c2e 5765 656b 3a0a 2020 2020 2020  val.Week:.      
-00020ba0: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
-00020bb0: 7a65 203d 2064 6174 6575 7469 6c2e 7265  ze = dateutil.re
-00020bc0: 6c61 7469 7665 6465 6c74 612e 7265 6c61  lativedelta.rela
-00020bd0: 7469 7665 6465 6c74 6128 7965 6172 733d  tivedelta(years=
-00020be0: 3229 0a20 2020 2020 2020 2065 6c69 6620  2).        elif 
-00020bf0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
-00020c00: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
-00020c10: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
-00020c20: 2020 6772 705f 6d61 785f 7369 7a65 203d    grp_max_size =
-00020c30: 2064 6174 6575 7469 6c2e 7265 6c61 7469   dateutil.relati
-00020c40: 7665 6465 6c74 612e 7265 6c61 7469 7665  vedelta.relative
-00020c50: 6465 6c74 6128 7965 6172 733d 3229 0a20  delta(years=2). 
-00020c60: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00020c70: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-00020c80: 642e 496e 7465 7276 616c 2e48 6f75 7273  d.Interval.Hours
-00020c90: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
-00020ca0: 7270 5f6d 6178 5f73 697a 6520 3d20 6461  rp_max_size = da
-00020cb0: 7465 7574 696c 2e72 656c 6174 6976 6564  teutil.relatived
-00020cc0: 656c 7461 2e72 656c 6174 6976 6564 656c  elta.relativedel
-00020cd0: 7461 2879 6561 7273 3d31 290a 2020 2020  ta(years=1).    
-00020ce0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00020cf0: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
-00020d00: 7a65 203d 2074 696d 6564 656c 7461 2864  ze = timedelta(d
-00020d10: 6179 733d 3330 290a 2020 2020 2020 2020  ays=30).        
-00020d20: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-00020d30: 2020 2020 2020 7072 696e 7428 222d 2067        print("- g
-00020d40: 7270 5f6d 6178 5f73 697a 6520 3d22 2c20  rp_max_size =", 
-00020d50: 6772 705f 6d61 785f 7369 7a65 290a 2020  grp_max_size).  
-00020d60: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-00020d70: 616e 6765 2831 2c20 6c65 6e28 6474 735f  ange(1, len(dts_
-00020d80: 746f 5f72 6570 6169 7229 293a 0a20 2020  to_repair)):.   
-00020d90: 2020 2020 2020 2020 2023 2069 6e64 203d           # ind =
-00020da0: 2069 6e64 6963 6573 5f74 6f5f 7265 7061   indices_to_repa
-00020db0: 6972 5b69 5d0a 2020 2020 2020 2020 2020  ir[i].          
-00020dc0: 2020 6474 203d 2064 7473 5f74 6f5f 7265    dt = dts_to_re
-00020dd0: 7061 6972 5b69 5d0a 2020 2020 2020 2020  pair[i].        
-00020de0: 2020 2020 6966 2064 742e 6461 7465 2829      if dt.date()
-00020df0: 203c 2064 7473 5f67 726f 7570 735b 2d31   < dts_groups[-1
-00020e00: 5d5b 305d 2e64 6174 6528 292b 6772 705f  ][0].date()+grp_
-00020e10: 6d61 785f 7369 7a65 3a0a 2020 2020 2020  max_size:.      
-00020e20: 2020 2020 2020 2020 2020 6474 735f 6772            dts_gr
-00020e30: 6f75 7073 5b2d 315d 2e61 7070 656e 6428  oups[-1].append(
-00020e40: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
-00020e50: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00020e60: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
-00020e70: 2e61 7070 656e 6428 5b64 745d 290a 2020  .append([dt]).  
-00020e80: 2020 2020 2020 2020 2020 2320 6c61 7374            # last
-00020e90: 5f64 7420 3d20 6474 0a20 2020 2020 2020  _dt = dt.       
-00020ea0: 2020 2020 2023 206c 6173 745f 696e 6420       # last_ind 
-00020eb0: 3d20 696e 640a 0a20 2020 2020 2020 2069  = ind..        i
-00020ec0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00020ed0: 2020 2020 2070 7269 6e74 2822 5265 7061       print("Repa
-00020ee0: 6972 2067 726f 7570 733a 2229 0a20 2020  ir groups:").   
-00020ef0: 2020 2020 2020 2020 2066 6f72 2067 2069           for g i
-00020f00: 6e20 6474 735f 6772 6f75 7073 3a0a 2020  n dts_groups:.  
-00020f10: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00020f20: 696e 7428 6622 2d20 7b67 5b30 5d7d 202d  int(f"- {g[0]} -
-00020f30: 3e20 7b67 5b2d 315d 7d22 290a 0a20 2020  > {g[-1]}")..   
-00020f40: 2020 2020 2023 2041 6464 2073 6f6d 6520       # Add some 
-00020f50: 676f 6f64 2064 6174 6120 746f 2065 6163  good data to eac
-00020f60: 6820 6772 6f75 702c 2073 6f20 6361 6e20  h group, so can 
-00020f70: 6361 6c69 6272 6174 6520 6c61 7465 723a  calibrate later:
-00020f80: 0a20 2020 2020 2020 2023 2066 6f72 2069  .        # for i
-00020f90: 2069 6e20 7261 6e67 6528 6c65 6e28 6474   in range(len(dt
-00020fa0: 735f 6772 6f75 7073 2929 3a0a 2020 2020  s_groups)):.    
-00020fb0: 2020 2020 2320 2020 2020 6720 3d20 6474      #     g = dt
-00020fc0: 735f 6772 6f75 7073 5b69 5d0a 2020 2020  s_groups[i].    
-00020fd0: 2020 2020 2320 2020 2020 6730 203d 2067      #     g0 = g
-00020fe0: 5b30 5d0a 2020 2020 2020 2020 2320 2020  [0].        #   
-00020ff0: 2020 6930 203d 2064 665f 676f 6f64 2e69    i0 = df_good.i
-00021000: 6e64 6578 2e67 6574 5f6c 6f63 2867 3029  ndex.get_loc(g0)
-00021010: 0a20 2020 2020 2020 2023 2020 2020 2069  .        #     i
-00021020: 6620 6930 203e 2030 3a0a 2020 2020 2020  f i0 > 0:.      
-00021030: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
-00021040: 6772 6f75 7073 5b69 5d2e 696e 7365 7274  groups[i].insert
-00021050: 2830 2c20 6466 5f67 6f6f 642e 696e 6465  (0, df_good.inde
-00021060: 785b 6930 2d31 5d29 0a20 2020 2020 2020  x[i0-1]).       
-00021070: 2023 2020 2020 2067 6c20 3d20 675b 2d31   #     gl = g[-1
-00021080: 5d0a 2020 2020 2020 2020 2320 2020 2020  ].        #     
-00021090: 696c 203d 2064 665f 676f 6f64 2e69 6e64  il = df_good.ind
-000210a0: 6578 2e67 6574 5f6c 6f63 2867 6c29 0a20  ex.get_loc(gl). 
-000210b0: 2020 2020 2020 2023 2020 2020 2069 6620         #     if 
-000210c0: 696c 203c 206c 656e 2864 665f 676f 6f64  il < len(df_good
-000210d0: 292d 313a 0a20 2020 2020 2020 2023 2020  )-1:.        #  
-000210e0: 2020 2020 2020 2064 7473 5f67 726f 7570         dts_group
-000210f0: 735b 695d 2e61 7070 656e 6428 6466 5f67  s[i].append(df_g
-00021100: 6f6f 642e 696e 6465 785b 696c 2b31 5d29  ood.index[il+1])
-00021110: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
-00021120: 6e20 7261 6e67 6528 6c65 6e28 6474 735f  n range(len(dts_
-00021130: 6772 6f75 7073 2929 3a0a 2020 2020 2020  groups)):.      
-00021140: 2020 2020 2020 6720 3d20 6474 735f 6772        g = dts_gr
-00021150: 6f75 7073 5b69 5d0a 2020 2020 2020 2020  oups[i].        
-00021160: 2020 2020 6730 203d 2067 5b30 5d0a 2020      g0 = g[0].  
-00021170: 2020 2020 2020 2020 2020 6930 203d 2064            i0 = d
-00021180: 665f 676f 6f64 2e69 6e64 6578 2e67 6574  f_good.index.get
-00021190: 5f69 6e64 6578 6572 285b 6730 5d2c 206d  _indexer([g0], m
-000211a0: 6574 686f 643d 226e 6561 7265 7374 2229  ethod="nearest")
-000211b0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-000211c0: 6966 2069 3020 3e20 303a 0a20 2020 2020  if i0 > 0:.     
-000211d0: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
-000211e0: 696e 5f64 7420 6973 204e 6f6e 6520 6f72  in_dt is None or
-000211f0: 2064 665f 676f 6f64 2e69 6e64 6578 5b69   df_good.index[i
-00021200: 302d 315d 203e 3d20 6d69 6e5f 6474 2920  0-1] >= min_dt) 
-00021210: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00021220: 2020 2020 2020 616e 6420 2828 6e6f 7420        and ((not 
-00021230: 7365 6c66 2e69 6e74 7261 6461 7929 206f  self.intraday) o
-00021240: 7220 6466 5f67 6f6f 642e 696e 6465 785b  r df_good.index[
-00021250: 6930 2d31 5d2e 6461 7465 2829 203d 3d20  i0-1].date() == 
-00021260: 6730 2e64 6174 6528 2929 3a0a 2020 2020  g0.date()):.    
-00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021280: 6930 202d 3d20 310a 2020 2020 2020 2020  i0 -= 1.        
-00021290: 2020 2020 676c 203d 2067 5b2d 315d 0a20      gl = g[-1]. 
-000212a0: 2020 2020 2020 2020 2020 2069 6c20 3d20             il = 
-000212b0: 6466 5f67 6f6f 642e 696e 6465 782e 6765  df_good.index.ge
-000212c0: 745f 696e 6465 7865 7228 5b67 6c5d 2c20  t_indexer([gl], 
-000212d0: 6d65 7468 6f64 3d22 6e65 6172 6573 7422  method="nearest"
-000212e0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-000212f0: 2069 6620 696c 203c 206c 656e 2864 665f   if il < len(df_
-00021300: 676f 6f64 292d 313a 0a20 2020 2020 2020  good)-1:.       
-00021310: 2020 2020 2020 2020 2069 6620 286e 6f74           if (not
-00021320: 2073 656c 662e 696e 7472 6164 6179 2920   self.intraday) 
-00021330: 6f72 2064 665f 676f 6f64 2e69 6e64 6578  or df_good.index
-00021340: 5b69 6c2b 315d 2e64 6174 6528 2920 3d3d  [il+1].date() ==
-00021350: 2067 6c2e 6461 7465 2829 3a0a 2020 2020   gl.date():.    
-00021360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021370: 696c 202b 3d20 310a 2020 2020 2020 2020  il += 1.        
-00021380: 2020 2020 676f 6f64 5f64 7473 203d 2064      good_dts = d
-00021390: 665f 676f 6f64 2e69 6e64 6578 5b69 303a  f_good.index[i0:
-000213a0: 696c 2b31 5d0a 2020 2020 2020 2020 2020  il+1].          
-000213b0: 2020 6474 735f 6772 6f75 7073 5b69 5d20    dts_groups[i] 
-000213c0: 2b3d 2067 6f6f 645f 6474 732e 746f 5f6c  += good_dts.to_l
-000213d0: 6973 7428 290a 2020 2020 2020 2020 2020  ist().          
-000213e0: 2020 6474 735f 6772 6f75 7073 5b69 5d2e    dts_groups[i].
-000213f0: 736f 7274 2829 0a0a 2020 2020 2020 2020  sort()..        
-00021400: 6e5f 6669 7865 6420 3d20 300a 2020 2020  n_fixed = 0.    
-00021410: 2020 2020 666f 7220 6720 696e 2064 7473      for g in dts
-00021420: 5f67 726f 7570 733a 0a20 2020 2020 2020  _groups:.       
-00021430: 2020 2020 2064 665f 626c 6f63 6b20 3d20       df_block = 
-00021440: 6466 5b64 662e 696e 6465 782e 6973 696e  df[df.index.isin
-00021450: 2867 295d 0a0a 2020 2020 2020 2020 2020  (g)]..          
-00021460: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
-00021470: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00021480: 7428 2264 665f 626c 6f63 6b3a 2229 203b  t("df_block:") ;
-00021490: 2070 7269 6e74 2864 665f 626c 6f63 6b29   print(df_block)
-000214a0: 0a0a 2020 2020 2020 2020 2020 2020 7374  ..            st
-000214b0: 6172 745f 6474 203d 2067 5b30 5d0a 2020  art_dt = g[0].  
-000214c0: 2020 2020 2020 2020 2020 7374 6172 745f            start_
-000214d0: 6420 3d20 7374 6172 745f 6474 2e64 6174  d = start_dt.dat
-000214e0: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
-000214f0: 2069 6620 7375 625f 696e 7465 7276 616c   if sub_interval
-00021500: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
-00021510: 6c2e 486f 7572 7331 2061 6e64 2028 6461  l.Hours1 and (da
-00021520: 7465 2e74 6f64 6179 2829 2d73 7461 7274  te.today()-start
-00021530: 5f64 2920 3e20 7469 6d65 6465 6c74 6128  _d) > timedelta(
-00021540: 6461 7973 3d37 3239 293a 0a20 2020 2020  days=729):.     
-00021550: 2020 2020 2020 2020 2020 2023 2044 6f6e             # Don
-00021560: 2774 2062 6f74 6865 7220 7265 7175 6573  't bother reques
-00021570: 7469 6e67 206d 6f72 6520 7072 6963 6520  ting more price 
-00021580: 6461 7461 2c20 5961 686f 6f20 7769 6c6c  data, Yahoo will
-00021590: 2072 656a 6563 740a 2020 2020 2020 2020   reject.        
-000215a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000215b0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-000215c0: 6620 7375 625f 696e 7465 7276 616c 2069  f sub_interval i
-000215d0: 6e20 5b79 6663 642e 496e 7465 7276 616c  n [yfcd.Interval
-000215e0: 2e4d 696e 7333 302c 2079 6663 642e 496e  .Mins30, yfcd.In
-000215f0: 7465 7276 616c 2e4d 696e 7331 355d 2061  terval.Mins15] a
-00021600: 6e64 2028 6461 7465 2e74 6f64 6179 2829  nd (date.today()
-00021610: 2d73 7461 7274 5f64 2920 3e20 7469 6d65  -start_d) > time
-00021620: 6465 6c74 6128 6461 7973 3d35 3929 3a0a  delta(days=59):.
-00021630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021640: 2320 446f 6e27 7420 626f 7468 6572 2072  # Don't bother r
-00021650: 6571 7565 7374 696e 6720 6d6f 7265 2070  equesting more p
-00021660: 7269 6365 2064 6174 612c 2059 6168 6f6f  rice data, Yahoo
-00021670: 2077 696c 6c20 7265 6a65 6374 0a20 2020   will reject.   
-00021680: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00021690: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-000216a0: 2020 2069 6620 7365 6c66 2e5f 7265 636f     if self._reco
-000216b0: 7264 5f73 7461 636b 5f74 7261 6365 3a0a  rd_stack_trace:.
-000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216d0: 2320 4c6f 6720 6675 6e63 7469 6f6e 2063  # Log function c
-000216e0: 616c 6c73 2074 6f20 6465 7465 6374 2061  alls to detect a
-000216f0: 6e64 206d 616e 6167 6520 696e 6669 6e69  nd manage infini
-00021700: 7465 2072 6563 7572 7369 6f6e 0a20 2020  te recursion.   
-00021710: 2020 2020 2020 2020 2020 2020 2066 6e5f               fn_
-00021720: 7475 706c 6520 3d20 2822 5f72 6563 6f6e  tuple = ("_recon
-00021730: 7374 7275 6374 5f69 6e74 6572 7661 6c73  struct_intervals
-00021740: 5f62 6174 6368 2829 222c 2066 2264 7430  _batch()", f"dt0
-00021750: 3d7b 6466 2e69 6e64 6578 5b30 5d7d 222c  ={df.index[0]}",
-00021760: 2066 2269 6e74 6572 7661 6c3d 7b73 656c   f"interval={sel
-00021770: 662e 696e 7465 7276 616c 7d22 290a 2020  f.interval}").  
-00021780: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00021790: 2066 6e5f 7475 706c 6520 696e 2073 656c   fn_tuple in sel
-000217a0: 662e 5f73 7461 636b 5f74 7261 6365 3a0a  f._stack_trace:.
-000217b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000217c0: 2020 2020 2320 4465 7465 6374 6564 2061      # Detected a
-000217d0: 2070 6f74 656e 7469 616c 2072 6563 7572   potential recur
-000217e0: 7369 6f6e 206c 6f6f 700a 2020 2020 2020  sion loop.      
-000217f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00021800: 636f 6e73 7472 7563 745f 6465 7465 6374  construct_detect
-00021810: 6564 203d 2046 616c 7365 0a20 2020 2020  ed = False.     
-00021820: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00021830: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-00021840: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
-00021850: 6163 6529 2d31 2c20 2d31 2c20 2d31 293a  ace)-1, -1, -1):
-00021860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021870: 2020 2020 2020 2020 2069 6620 225f 7265           if "_re
-00021880: 636f 6e73 7472 7563 745f 696e 7465 7276  construct_interv
-00021890: 616c 735f 6261 7463 6822 2069 6e20 7374  als_batch" in st
-000218a0: 7228 7365 6c66 2e5f 7374 6163 6b5f 7472  r(self._stack_tr
-000218b0: 6163 655b 695d 293a 0a20 2020 2020 2020  ace[i]):.       
-000218c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218d0: 2020 2020 2072 6563 6f6e 7374 7275 6374       reconstruct
-000218e0: 5f64 6574 6563 7465 6420 3d20 5472 7565  _detected = True
-000218f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021900: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00021910: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
-00021920: 2020 2020 2020 2069 6620 7265 636f 6e73         if recons
-00021930: 7472 7563 745f 6465 7465 6374 6564 3a0a  truct_detected:.
-00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021950: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
-00021960: 6669 6e69 7465 5f72 6563 7572 7369 6f6e  finite_recursion
-00021970: 5f64 6574 6563 7465 6420 3d20 5472 7565  _detected = True
-00021980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021990: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
-000219a0: 6365 2e61 7070 656e 6428 666e 5f74 7570  ce.append(fn_tup
-000219b0: 6c65 290a 0a20 2020 2020 2020 2020 2020  le)..           
-000219c0: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
-000219d0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-000219e0: 2020 206c 6f67 5f6d 7367 203d 2066 2272     log_msg = f"r
-000219f0: 6570 6169 7269 6e67 207b 7365 6c66 2e69  epairing {self.i
-00021a00: 7374 727d 2062 6c6f 636b 207b 675b 305d  str} block {g[0]
-00021a10: 2e64 6174 6528 297d 202d 3e20 7b67 5b2d  .date()} -> {g[-
-00021a20: 315d 2e64 6174 6528 292b 7469 6d65 6465  1].date()+timede
-00021a30: 6c74 6128 6461 7973 3d31 297d 220a 2020  lta(days=1)}".  
-00021a40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00021a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a60: 6c6f 675f 6d73 6720 3d20 6622 7265 7061  log_msg = f"repa
-00021a70: 6972 696e 6720 7b73 656c 662e 6973 7472  iring {self.istr
-00021a80: 7d20 626c 6f63 6b20 7b67 5b30 5d7d 202d  } block {g[0]} -
-00021a90: 3e20 7b67 5b2d 315d 7d22 0a20 2020 2020  > {g[-1]}".     
-00021aa0: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
-00021ab0: 6765 722e 4c6f 6745 7665 6e74 2822 696e  ger.LogEvent("in
-00021ac0: 666f 222c 2022 5072 6963 654d 616e 6167  fo", "PriceManag
-00021ad0: 6572 222c 206c 6f67 5f6d 7367 290a 0a20  er", log_msg).. 
-00021ae0: 2020 2020 2020 2020 2020 2023 2049 6e66             # Inf
-00021af0: 696e 6974 6520 6c6f 6f70 2070 6f74 656e  inite loop poten
-00021b00: 7469 616c 2068 6572 6520 7669 6120 7265  tial here via re
-00021b10: 7061 6972 3a0a 2020 2020 2020 2020 2020  pair:.          
-00021b20: 2020 2320 2d20 7265 7175 6573 7420 6669    # - request fi
-00021b30: 6e65 2d67 7261 696e 6564 2064 6174 6120  ne-grained data 
-00021b40: 652e 672e 2031 480a 2020 2020 2020 2020  e.g. 1H.        
-00021b50: 2020 2020 2320 2d20 3148 2072 6571 7569      # - 1H requi
-00021b60: 7265 7320 6163 6375 7261 7465 2064 6976  res accurate div
-00021b70: 6964 656e 6420 6461 7461 0a20 2020 2020  idend data.     
-00021b80: 2020 2020 2020 2023 202d 2074 7269 6767         # - trigg
-00021b90: 6572 7320 6665 7463 6820 6f66 2031 4420  ers fetch of 1D 
-00021ba0: 6461 7461 2077 6869 6368 206d 7573 7420  data which must 
-00021bb0: 6265 206b 6570 7420 636f 6e74 6967 756f  be kept contiguo
-00021bc0: 7573 0a20 2020 2020 2020 2020 2020 2023  us.            #
-00021bd0: 202d 2074 7269 6767 6572 7320 6665 7463   - triggers fetc
-00021be0: 6820 6f66 206f 6c64 6572 2031 4420 6461  h of older 1D da
-00021bf0: 7461 2077 6869 6368 2072 6571 7569 7265  ta which require
-00021c00: 7320 7265 7061 6972 2075 7369 6e67 2031  s repair using 1
-00021c10: 4820 6461 7461 202d 3e20 7265 6375 7273  H data -> recurs
-00021c20: 696f 6e20 6c6f 6f70 0a20 2020 2020 2020  ion loop.       
-00021c30: 2020 2020 2023 2053 6f6c 7574 696f 6e3a       # Solution:
-00021c40: 0a20 2020 2020 2020 2020 2020 2023 2031  .            # 1
-00021c50: 2920 6164 6420 7475 706c 6520 746f 2066  ) add tuple to f
-00021c60: 6e20 7374 6163 6b20 6275 7920 7769 7468  n stack buy with
-00021c70: 2059 463d 5472 7565 0a20 2020 2020 2020   YF=True.       
-00021c80: 2020 2020 2023 2032 2920 6966 2074 6861       # 2) if tha
-00021c90: 7420 7475 706c 6520 616c 7265 6164 7920  t tuple already 
-00021ca0: 696e 2073 7461 636b 2074 6865 6e20 7261  in stack then ra
-00021cb0: 6973 6520 4578 6365 7074 696f 6e0a 2020  ise Exception.  
-00021cc0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00021cd0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-00021ce0: 6364 2e49 6e74 6572 7661 6c2e 5765 656b  cd.Interval.Week
-00021cf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00021d00: 2020 6665 7463 685f 7374 6172 7420 3d20    fetch_start = 
-00021d10: 7374 6172 745f 6420 2d20 7464 5f72 616e  start_d - td_ran
-00021d20: 6765 2020 2320 6e65 6564 2070 7265 7669  ge  # need previ
-00021d30: 6f75 7320 7765 656b 2074 6f6f 0a20 2020  ous week too.   
-00021d40: 2020 2020 2020 2020 2020 2020 2066 6574               fet
-00021d50: 6368 5f65 6e64 203d 2067 5b2d 315d 2e64  ch_end = g[-1].d
-00021d60: 6174 6528 2920 2b20 7464 5f72 616e 6765  ate() + td_range
-00021d70: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00021d80: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
-00021d90: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
-00021da0: 2e44 6179 7331 3a0a 2020 2020 2020 2020  .Days1:.        
-00021db0: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
-00021dc0: 6172 7420 3d20 7374 6172 745f 640a 2020  art = start_d.  
-00021dd0: 2020 2020 2020 2020 2020 2020 2020 6665                fe
-00021de0: 7463 685f 656e 6420 3d20 675b 2d31 5d2e  tch_end = g[-1].
-00021df0: 6461 7465 2829 202b 2074 645f 7261 6e67  date() + td_rang
-00021e00: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00021e10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00021e20: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
-00021e30: 3d20 675b 305d 0a20 2020 2020 2020 2020  = g[0].         
-00021e40: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
-00021e50: 203d 2067 5b2d 315d 202b 2074 645f 7261   = g[-1] + td_ra
-00021e60: 6e67 650a 2020 2020 2020 2020 2020 2020  nge.            
-00021e70: 2320 7072 696e 7428 6622 6665 7463 685f  # print(f"fetch_
-00021e80: 7374 6172 743d 7b66 6574 6368 5f73 7461  start={fetch_sta
-00021e90: 7274 7d20 6665 7463 685f 656e 643d 7b66  rt} fetch_end={f
-00021ea0: 6574 6368 5f65 6e64 7d22 290a 0a20 2020  etch_end}")..   
-00021eb0: 2020 2020 2020 2020 2023 2070 7265 706f           # prepo
-00021ec0: 7374 203d 2073 656c 662e 696e 7465 7276  st = self.interv
-00021ed0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-00021ee0: 7661 6c2e 4461 7973 310a 2020 2020 2020  val.Days1.      
-00021ef0: 2020 2020 2020 7072 6570 6f73 7420 3d20        prepost = 
-00021f00: 7365 6c66 2e69 6e74 6572 6461 790a 2020  self.interday.  
-00021f10: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
-00021f20: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
-00021f30: 2020 2020 7072 696e 7428 6622 2d20 6665      print(f"- fe
-00021f40: 7463 685f 7374 6172 743d 7b66 6574 6368  tch_start={fetch
-00021f50: 5f73 7461 7274 7d2c 2066 6574 6368 5f65  _start}, fetch_e
-00021f60: 6e64 3d7b 6665 7463 685f 656e 647d 2070  nd={fetch_end} p
-00021f70: 7265 706f 7374 3d7b 7072 6570 6f73 747d  repost={prepost}
-00021f80: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-00021f90: 6620 7365 6c66 2e5f 696e 6669 6e69 7465  f self._infinite
-00021fa0: 5f72 6563 7572 7369 6f6e 5f64 6574 6563  _recursion_detec
-00021fb0: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-00021fc0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00021fd0: 6e67 6528 6c65 6e28 7365 6c66 2e5f 7374  nge(len(self._st
-00021fe0: 6163 6b5f 7472 6163 6529 293a 0a20 2020  ack_trace)):.   
-00021ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022000: 2070 7269 6e74 2822 2020 222a 6920 2b20   print("  "*i + 
-00022010: 7374 7228 7365 6c66 2e5f 7374 6163 6b5f  str(self._stack_
-00022020: 7472 6163 655b 695d 2929 0a20 2020 2020  trace[i])).     
-00022030: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00022040: 2045 7863 6570 7469 6f6e 2822 5741 524e   Exception("WARN
-00022050: 494e 473a 2049 6e66 696e 6974 6520 7265  ING: Infinite re
-00022060: 6375 7273 696f 6e20 6465 7465 6374 6564  cursion detected
-00022070: 2028 7365 6520 7374 6163 6b20 7472 6163   (see stack trac
-00022080: 6520 6162 6f76 6529 2e20 5377 6974 6368  e above). Switch
-00022090: 2074 6f20 6665 7463 6869 6e67 2070 7269   to fetching pri
-000220a0: 6365 7320 6469 7265 6374 2066 726f 6d20  ces direct from 
-000220b0: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
-000220c0: 2020 2020 2070 7269 6e74 2822 5741 524e       print("WARN
-000220d0: 494e 473a 2049 6e66 696e 6974 6520 7265  ING: Infinite re
-000220e0: 6375 7273 696f 6e20 6465 7465 6374 6564  cursion detected
-000220f0: 2028 7365 6520 7374 6163 6b20 7472 6163   (see stack trac
-00022100: 6520 6162 6f76 6529 2e20 5377 6974 6368  e above). Switch
-00022110: 2074 6f20 6665 7463 6869 6e67 2070 7269   to fetching pri
-00022120: 6365 7320 6469 7265 6374 2066 726f 6d20  ces direct from 
-00022130: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
-00022140: 2020 2020 2023 2064 665f 6669 6e65 203d       # df_fine =
-00022150: 2073 656c 662e 6461 742e 6869 7374 6f72   self.dat.histor
-00022160: 7928 7374 6172 743d 6665 7463 685f 7374  y(start=fetch_st
-00022170: 6172 742c 2065 6e64 3d66 6574 6368 5f65  art, end=fetch_e
-00022180: 6e64 2c20 696e 7465 7276 616c 3d79 6663  nd, interval=yfc
-00022190: 642e 696e 7465 7276 616c 546f 5374 7269  d.intervalToStri
-000221a0: 6e67 5b73 7562 5f69 6e74 6572 7661 6c5d  ng[sub_interval]
-000221b0: 2c20 6175 746f 5f61 646a 7573 743d 4661  , auto_adjust=Fa
-000221c0: 6c73 652c 2070 7265 706f 7374 3d70 7265  lse, prepost=pre
-000221d0: 706f 7374 2c20 6b65 6570 6e61 3d54 7275  post, keepna=Tru
-000221e0: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
-000221f0: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
-00022200: 7661 6c20 696e 205b 7966 6364 2e49 6e74  val in [yfcd.Int
-00022210: 6572 7661 6c2e 4461 7973 315d 3a20 2023  erval.Days1]:  #
-00022220: 206f 7220 7365 6c66 2e5f 696e 6669 6e69   or self._infini
-00022230: 7465 5f72 6563 7572 7369 6f6e 5f64 6574  te_recursion_det
-00022240: 6563 7465 643a 0a20 2020 2020 2020 2020  ected:.         
-00022250: 2020 2023 2020 2020 2023 2041 7373 756d     #     # Assum
-00022260: 6520 696e 6669 6e69 7465 2072 6563 7572  e infinite recur
-00022270: 7369 6f6e 2077 696c 6c20 6861 7070 656e  sion will happen
-00022280: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00022290: 2020 2064 665f 6669 6e65 203d 2073 656c     df_fine = sel
-000222a0: 662e 6461 742e 6869 7374 6f72 7928 7374  f.dat.history(st
-000222b0: 6172 743d 6665 7463 685f 7374 6172 742c  art=fetch_start,
-000222c0: 2065 6e64 3d66 6574 6368 5f65 6e64 2c20   end=fetch_end, 
-000222d0: 696e 7465 7276 616c 3d79 6663 642e 696e  interval=yfcd.in
-000222e0: 7465 7276 616c 546f 5374 7269 6e67 5b73  tervalToString[s
-000222f0: 7562 5f69 6e74 6572 7661 6c5d 2c20 6175  ub_interval], au
-00022300: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
-00022310: 2072 6570 6169 723d 5472 7565 290a 2020   repair=True).  
-00022320: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00022330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022340: 6966 2070 7265 706f 7374 2061 6e64 2073  if prepost and s
-00022350: 7562 5f69 6e74 7261 6461 793a 0a20 2020  ub_intraday:.   
-00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022370: 2023 2059 4643 2063 616e 6e6f 7420 6861   # YFC cannot ha
-00022380: 6e64 6c65 2069 6e74 7261 6461 7920 7072  ndle intraday pr
-00022390: 652d 2061 6e64 2070 6f73 742d 6d61 726b  e- and post-mark
-000223a0: 6574 2c20 736f 2066 6574 6368 2076 6961  et, so fetch via
-000223b0: 2079 6669 6e61 6e63 650a 2020 2020 2020   yfinance.      
-000223c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000223d0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-000223e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223f0: 2320 7072 696e 7428 222d 2066 6574 6368  # print("- fetch
-00022400: 696e 6720 6466 5f66 696e 6520 6469 7265  ing df_fine dire
-00022410: 6374 2066 726f 6d20 5946 2229 0a20 2020  ct from YF").   
-00022420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022430: 2020 2020 2070 7269 6e74 2866 222d 202d       print(f"- -
-00022440: 2066 6574 6368 5f73 7461 7274 3d7b 6665   fetch_start={fe
-00022450: 7463 685f 7374 6172 747d 2066 6574 6368  tch_start} fetch
-00022460: 5f65 6e64 3d7b 6665 7463 685f 656e 647d  _end={fetch_end}
-00022470: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00022480: 2020 2020 2020 2064 665f 6669 6e65 5f6f         df_fine_o
-00022490: 6c64 203d 2073 656c 662e 6461 742e 6869  ld = self.dat.hi
-000224a0: 7374 6f72 7928 7374 6172 743d 6665 7463  story(start=fetc
-000224b0: 685f 7374 6172 742c 2065 6e64 3d66 6574  h_start, end=fet
-000224c0: 6368 5f65 6e64 2c20 696e 7465 7276 616c  ch_end, interval
-000224d0: 3d79 6663 642e 696e 7465 7276 616c 546f  =yfcd.intervalTo
-000224e0: 5374 7269 6e67 5b73 7562 5f69 6e74 6572  String[sub_inter
-000224f0: 7661 6c5d 2c20 6175 746f 5f61 646a 7573  val], auto_adjus
-00022500: 743d 5472 7565 2c20 7072 6570 6f73 743d  t=True, prepost=
-00022510: 7072 6570 6f73 7429 0a20 2020 2020 2020  prepost).       
-00022520: 2020 2020 2020 2020 2020 2020 2068 6973               his
-00022530: 745f 7375 6220 3d20 7365 6c66 2e6d 616e  t_sub = self.man
-00022540: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
-00022550: 7375 625f 696e 7465 7276 616c 290a 2020  sub_interval).  
-00022560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022570: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00022580: 6e63 6528 6665 7463 685f 7374 6172 742c  nce(fetch_start,
-00022590: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
-000225a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225b0: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
-000225c0: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
-000225d0: 6e65 2866 6574 6368 5f73 7461 7274 2c20  ne(fetch_start, 
-000225e0: 7469 6d65 2830 292c 205a 6f6e 6549 6e66  time(0), ZoneInf
-000225f0: 6f28 7365 6c66 2e74 7a4e 616d 6529 290a  o(self.tzName)).
-00022600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022610: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00022620: 7461 6e63 6528 6665 7463 685f 656e 642c  tance(fetch_end,
-00022630: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
-00022640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022650: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
-00022660: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
-00022670: 2866 6574 6368 5f65 6e64 2c20 7469 6d65  (fetch_end, time
-00022680: 2830 292c 205a 6f6e 6549 6e66 6f28 7365  (0), ZoneInfo(se
-00022690: 6c66 2e74 7a4e 616d 6529 290a 2020 2020  lf.tzName)).    
-000226a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226b0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-000226c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226d0: 2020 7072 696e 7428 222d 2066 6574 6368    print("- fetch
-000226e0: 696e 6720 6466 5f66 696e 6520 7669 6120  ing df_fine via 
-000226f0: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
-00022700: 2920 7772 6170 7065 7222 290a 2020 2020  ) wrapper").    
-00022710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022720: 2020 2020 7072 696e 7428 6622 2d20 2d20      print(f"- - 
-00022730: 6665 7463 685f 7374 6172 743d 7b66 6574  fetch_start={fet
-00022740: 6368 5f73 7461 7274 7d20 6665 7463 685f  ch_start} fetch_
-00022750: 656e 643d 7b66 6574 6368 5f65 6e64 7d22  end={fetch_end}"
-00022760: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00022770: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00022780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022790: 2020 2064 665f 6669 6e65 203d 2068 6973     df_fine = his
-000227a0: 745f 7375 622e 5f66 6574 6368 5966 4869  t_sub._fetchYfHi
-000227b0: 7374 6f72 7928 7073 7472 3d4e 6f6e 652c  story(pstr=None,
-000227c0: 2073 7461 7274 3d66 6574 6368 5f73 7461   start=fetch_sta
-000227d0: 7274 2c20 656e 643d 6665 7463 685f 656e  rt, end=fetch_en
-000227e0: 642c 2070 7265 706f 7374 3d70 7265 706f  d, prepost=prepo
-000227f0: 7374 2c20 6465 6275 673d 4661 6c73 652c  st, debug=False,
-00022800: 2076 6572 6966 795f 696e 7465 7276 616c   verify_interval
-00022810: 733d 4661 6c73 652c 2064 6973 6162 6c65  s=False, disable
-00022820: 5f79 6663 5f6d 6574 6164 6174 613d 5472  _yfc_metadata=Tr
-00022830: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00022840: 2020 2020 2020 2020 6578 6365 7074 2079          except y
-00022850: 6663 642e 4e6f 5072 6963 6544 6174 6149  fcd.NoPriceDataI
-00022860: 6e52 616e 6765 4578 6365 7074 696f 6e20  nRangeException 
-00022870: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00022880: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00022890: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-000228a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000228b0: 2020 2020 7072 696e 7428 222d 2066 6574      print("- fet
-000228c0: 6368 206f 6620 6669 6e65 2070 7269 6365  ch of fine price
-000228d0: 2064 6174 6120 6661 696c 6564 3a22 202b   data failed:" +
-000228e0: 2073 7472 2865 2929 0a20 2020 2020 2020   str(e)).       
-000228f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022900: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00022910: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00022920: 2064 665f 6669 6e65 2069 7320 6e6f 7420   df_fine is not 
-00022930: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00022940: 2020 2020 2020 2020 2020 2020 2020 6164                ad
-00022950: 6a20 3d20 2864 665f 6669 6e65 5b22 4164  j = (df_fine["Ad
-00022960: 6a20 436c 6f73 6522 5d2f 6466 5f66 696e  j Close"]/df_fin
-00022970: 655b 2243 6c6f 7365 225d 292e 746f 5f6e  e["Close"]).to_n
-00022980: 756d 7079 2829 0a20 2020 2020 2020 2020  umpy().         
-00022990: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000229a0: 6f72 2063 2069 6e20 5b22 4f70 656e 222c  or c in ["Open",
-000229b0: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
-000229c0: 2243 6c6f 7365 225d 3a0a 2020 2020 2020  "Close"]:.      
-000229d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229e0: 2020 2020 2020 6466 5f66 696e 655b 635d        df_fine[c]
-000229f0: 202a 3d20 6164 6a0a 2020 2020 2020 2020   *= adj.        
-00022a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a10: 6466 5f66 696e 6520 3d20 6466 5f66 696e  df_fine = df_fin
-00022a20: 655b 5b22 4f70 656e 222c 2022 4c6f 7722  e[["Open", "Low"
-00022a30: 2c20 2248 6967 6822 2c20 2243 6c6f 7365  , "High", "Close
-00022a40: 222c 2022 566f 6c75 6d65 222c 2022 4469  ", "Volume", "Di
-00022a50: 7669 6465 6e64 7322 2c20 2253 746f 636b  vidends", "Stock
-00022a60: 2053 706c 6974 7322 5d5d 0a20 2020 2020   Splits"]].     
-00022a70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00022a80: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00022a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022aa0: 2070 7269 6e74 2822 6466 5f66 696e 655f   print("df_fine_
-00022ab0: 6f6c 643a 2229 0a20 2020 2020 2020 2020  old:").         
-00022ac0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00022ad0: 7269 6e74 2864 665f 6669 6e65 5f6f 6c64  rint(df_fine_old
-00022ae0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00022af0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00022b00: 2264 665f 6669 6e65 3a22 290a 2020 2020  "df_fine:").    
-00022b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b20: 2020 2020 7072 696e 7428 6466 5f66 696e      print(df_fin
-00022b30: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00022b40: 2020 2020 2020 2023 2072 6169 7365 2045         # raise E
-00022b50: 7863 6570 7469 6f6e 2822 6865 7265 2229  xception("here")
-00022b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00022b80: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00022b90: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-00022ba0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00022bb0: 6e74 2822 2d20 6665 7463 6869 6e67 2064  nt("- fetching d
-00022bc0: 665f 6669 6e65 2076 6961 2059 4643 2229  f_fine via YFC")
-00022bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022be0: 2020 2020 2068 6973 745f 7375 6220 3d20       hist_sub = 
-00022bf0: 7365 6c66 2e6d 616e 6167 6572 2e47 6574  self.manager.Get
-00022c00: 4869 7374 6f72 7928 7375 625f 696e 7465  History(sub_inte
-00022c10: 7276 616c 290a 2020 2020 2020 2020 2020  rval).          
-00022c20: 2020 2020 2020 2020 2020 6466 5f66 696e            df_fin
-00022c30: 6520 3d20 6869 7374 5f73 7562 2e67 6574  e = hist_sub.get
-00022c40: 2866 6574 6368 5f73 7461 7274 2c20 6665  (fetch_start, fe
-00022c50: 7463 685f 656e 642c 2061 646a 7573 745f  tch_end, adjust_
-00022c60: 7370 6c69 7473 3d46 616c 7365 2c20 6164  splits=False, ad
-00022c70: 6a75 7374 5f64 6976 733d 4661 6c73 652c  just_divs=False,
-00022c80: 2072 6570 6169 723d 4661 6c73 652c 2070   repair=False, p
-00022c90: 7265 706f 7374 3d70 7265 706f 7374 290a  repost=prepost).
-00022ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022cb0: 2320 6466 5f66 696e 655b 2241 646a 2043  # df_fine["Adj C
-00022cc0: 6c6f 7365 225d 203d 2064 665f 6669 6e65  lose"] = df_fine
-00022cd0: 5b22 436c 6f73 6522 5d20 2a20 6466 5f66  ["Close"] * df_f
-00022ce0: 696e 655b 2243 4446 225d 0a20 2020 2020  ine["CDF"].     
-00022cf0: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
-00022d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022d10: 2070 7269 6e74 2822 2d20 6466 5f66 696e   print("- df_fin
-00022d20: 653a 2229 0a20 2020 2020 2020 2020 2020  e:").           
-00022d30: 2020 2020 2070 7269 6e74 2864 665f 6669       print(df_fi
-00022d40: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-00022d50: 6966 2064 665f 6669 6e65 2069 7320 4e6f  if df_fine is No
-00022d60: 6e65 206f 7220 6c65 6e28 6466 5f66 696e  ne or len(df_fin
-00022d70: 6529 203d 3d20 303a 0a20 2020 2020 2020  e) == 0:.       
-00022d80: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00022d90: 5946 3a20 5741 524e 494e 473a 2043 616e  YF: WARNING: Can
-00022da0: 6e6f 7420 7265 636f 6e73 7472 7563 7420  not reconstruct 
-00022db0: 6265 6361 7573 6520 5961 686f 6f20 6e6f  because Yahoo no
-00022dc0: 7420 7265 7475 726e 696e 6720 6461 7461  t returning data
-00022dd0: 2069 6e20 696e 7465 7276 616c 2229 0a20   in interval"). 
-00022de0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00022df0: 6620 7365 6c66 2e5f 7265 636f 7264 5f73  f self._record_s
-00022e00: 7461 636b 5f74 7261 6365 3a0a 2020 2020  tack_trace:.    
-00022e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e20: 2320 506f 7020 7374 6163 6b20 7472 6163  # Pop stack trac
-00022e30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00022e40: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
-00022e50: 662e 5f73 7461 636b 5f74 7261 6365 2920  f._stack_trace) 
-00022e60: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00022e70: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00022e80: 6973 6520 4578 6365 7074 696f 6e28 2246  ise Exception("F
-00022e90: 6169 6c69 6e67 2074 6f20 636f 7272 6563  ailing to correc
-00022ea0: 746c 7920 7075 7368 2f70 6f70 2073 7461  tly push/pop sta
-00022eb0: 636b 2074 7261 6365 2028 6973 2065 6d70  ck trace (is emp
-00022ec0: 7479 2074 6f6f 2065 6172 6c79 2922 290a  ty too early)").
-00022ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ee0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00022ef0: 5f73 7461 636b 5f74 7261 6365 5b2d 315d  _stack_trace[-1]
-00022f00: 203d 3d20 666e 5f74 7570 6c65 3a0a 2020   == fn_tuple:.  
-00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f20: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-00022f30: 616e 6765 286c 656e 2873 656c 662e 5f73  ange(len(self._s
-00022f40: 7461 636b 5f74 7261 6365 2929 3a0a 2020  tack_trace)):.  
-00022f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f60: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00022f70: 2220 2022 2a69 202b 2073 7472 2873 656c  "  "*i + str(sel
-00022f80: 662e 5f73 7461 636b 5f74 7261 6365 5b69  f._stack_trace[i
-00022f90: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-00022fa0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00022fb0: 6520 4578 6365 7074 696f 6e28 2246 6169  e Exception("Fai
-00022fc0: 6c69 6e67 2074 6f20 636f 7272 6563 746c  ling to correctl
-00022fd0: 7920 7075 7368 2f70 6f70 2073 7461 636b  y push/pop stack
-00022fe0: 2074 7261 6365 2028 7365 6520 6162 6f76   trace (see abov
-00022ff0: 6529 2229 0a20 2020 2020 2020 2020 2020  e)").           
-00023000: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-00023010: 7461 636b 5f74 7261 6365 2e70 6f70 286c  tack_trace.pop(l
-00023020: 656e 2873 656c 662e 5f73 7461 636b 5f74  en(self._stack_t
-00023030: 7261 6365 2920 2d20 3129 0a20 2020 2020  race) - 1).     
-00023040: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00023050: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00023060: 2064 665f 6669 6e65 5b22 6374 7222 5d20   df_fine["ctr"] 
-00023070: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-00023080: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
-00023090: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
-000230a0: 6c2e 5765 656b 3a0a 2020 2020 2020 2020  l.Week:.        
-000230b0: 2020 2020 2020 2020 2320 6466 5f66 696e          # df_fin
-000230c0: 655b 2257 6565 6b20 5374 6172 7422 5d20  e["Week Start"] 
-000230d0: 3d20 6466 5f66 696e 652e 696e 6465 782e  = df_fine.index.
-000230e0: 747a 5f6c 6f63 616c 697a 6528 4e6f 6e65  tz_localize(None
-000230f0: 292e 746f 5f70 6572 696f 6428 2257 2d53  ).to_period("W-S
-00023100: 554e 2229 2e73 7461 7274 5f74 696d 650a  UN").start_time.
-00023110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023120: 7765 656b 6461 7973 203d 205b 224d 4f4e  weekdays = ["MON
-00023130: 222c 2022 5455 4522 2c20 2257 4544 222c  ", "TUE", "WED",
-00023140: 2022 5448 5522 2c20 2246 5249 222c 2022   "THU", "FRI", "
-00023150: 5341 5422 2c20 2253 554e 225d 0a20 2020  SAT", "SUN"].   
-00023160: 2020 2020 2020 2020 2020 2020 2077 6565               wee
-00023170: 6b5f 656e 645f 6461 7920 3d20 7765 656b  k_end_day = week
-00023180: 6461 7973 5b28 6466 5f62 6c6f 636b 2e69  days[(df_block.i
-00023190: 6e64 6578 5b30 5d2e 7765 656b 6461 7928  ndex[0].weekday(
-000231a0: 2920 2b20 3720 2d20 3129 2025 2037 5d0a  ) + 7 - 1) % 7].
+0001c630: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+0001c640: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+0001c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c660: 2020 2020 2020 696e 7465 7276 616c 732e        intervals.
+0001c670: 6c6f 635b 6474 2c20 2269 6e74 6572 7661  loc[dt, "interva
+0001c680: 6c5f 6f70 656e 225d 203d 2064 662e 696e  l_open"] = df.in
+0001c690: 6465 785b 6964 785d 2e64 6174 6528 290a  dex[idx].date().
+0001c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6c0: 696e 7465 7276 616c 732e 6c6f 635b 6474  intervals.loc[dt
+0001c6d0: 2c20 2269 6e74 6572 7661 6c5f 636c 6f73  , "interval_clos
+0001c6e0: 6522 5d20 3d20 6466 2e69 6e64 6578 5b69  e"] = df.index[i
+0001c6f0: 6478 5d2e 6461 7465 2829 202b 2073 656c  dx].date() + sel
+0001c700: 662e 6974 640a 2020 2020 2020 2020 2020  f.itd.          
+0001c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c720: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c740: 2020 2020 2020 2020 696e 7465 7276 616c          interval
+0001c750: 732e 6c6f 635b 6474 2c20 2269 6e74 6572  s.loc[dt, "inter
+0001c760: 7661 6c5f 6f70 656e 225d 203d 2064 662e  val_open"] = df.
+0001c770: 696e 6465 785b 6964 785d 0a20 2020 2020  index[idx].     
+0001c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c790: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+0001c7a0: 7661 6c73 2e6c 6f63 5b64 742c 2022 696e  vals.loc[dt, "in
+0001c7b0: 7465 7276 616c 5f63 6c6f 7365 225d 203d  terval_close"] =
+0001c7c0: 2064 662e 696e 6465 785b 6964 785d 202b   df.index[idx] +
+0001c7d0: 2073 656c 662e 6974 640a 2020 2020 2020   self.itd.      
+0001c7e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001c7f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c800: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c810: 6520 4578 6365 7074 696f 6e28 2250 726f  e Exception("Pro
+0001c820: 626c 656d 2077 6974 6820 6461 7465 7320  blem with dates 
+0001c830: 7265 7475 726e 6564 2062 7920 5961 686f  returned by Yaho
+0001c840: 6f2c 2073 6565 2061 626f 7665 2229 0a0a  o, see above")..
+0001c850: 2020 2020 2020 2020 6466 203d 2064 662e          df = df.
+0001c860: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
+0001c870: 6966 206e 6f74 2064 6973 6162 6c65 5f79  if not disable_y
+0001c880: 6663 5f6d 6574 6164 6174 613a 0a20 2020  fc_metadata:.   
+0001c890: 2020 2020 2020 2020 206c 6173 7444 6174           lastDat
+0001c8a0: 6144 7473 203d 2079 6663 742e 4361 6c63  aDts = yfct.Calc
+0001c8b0: 496e 7465 7276 616c 4c61 7374 4461 7461  IntervalLastData
+0001c8c0: 4474 5f62 6174 6368 2873 656c 662e 6578  Dt_batch(self.ex
+0001c8d0: 6368 616e 6765 2c20 696e 7465 7276 616c  change, interval
+0001c8e0: 735b 2269 6e74 6572 7661 6c5f 6f70 656e  s["interval_open
+0001c8f0: 225d 2e74 6f5f 6e75 6d70 7928 292c 2073  "].to_numpy(), s
+0001c900: 656c 662e 696e 7465 7276 616c 290a 2020  elf.interval).  
+0001c910: 2020 2020 2020 2020 2020 6966 2066 5f6e            if f_n
+0001c920: 612e 616e 7928 293a 0a20 2020 2020 2020  a.any():.       
+0001c930: 2020 2020 2020 2020 2023 2048 6163 6b79           # Hacky
+0001c940: 2073 6f6c 7574 696f 6e20 746f 2068 616e   solution to han
+0001c950: 646c 6520 7863 616c 2068 6176 696e 6720  dle xcal having 
+0001c960: 696e 636f 7272 6563 7420 7363 6865 6475  incorrect schedu
+0001c970: 6c65 2c20 666f 7220 7661 6c69 6420 5961  le, for valid Ya
+0001c980: 686f 6f20 6461 7461 0a20 2020 2020 2020  hoo data.       
+0001c990: 2020 2020 2020 2020 206c 6173 7444 6174           lastDat
+0001c9a0: 6144 7473 5b66 5f6e 615d 203d 2069 6e74  aDts[f_na] = int
+0001c9b0: 6572 7661 6c73 2e69 6e64 6578 5b66 5f6e  ervals.index[f_n
+0001c9c0: 615d 202b 2073 656c 662e 6974 640a 2020  a] + self.itd.  
+0001c9d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001c9e0: 2073 656c 662e 696e 7472 6164 6179 3a0a   self.intraday:.
+0001c9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca00: 2020 2020 6c61 7374 4461 7461 4474 735b      lastDataDts[
+0001ca10: 665f 6e61 5d20 2b3d 2079 6663 742e 4765  f_na] += yfct.Ge
+0001ca20: 7445 7863 6861 6e67 6544 6174 6144 656c  tExchangeDataDel
+0001ca30: 6179 2873 656c 662e 6578 6368 616e 6765  ay(self.exchange
+0001ca40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ca50: 2020 2020 2020 2320 466f 7220 736f 6d65        # For some
+0001ca60: 2065 7863 6861 6e67 6573 2c20 5961 686f   exchanges, Yaho
+0001ca70: 6f20 6861 7320 7472 6164 6573 2074 6861  o has trades tha
+0001ca80: 7420 6f63 6375 7272 6564 2073 6f6f 6e20  t occurred soon 
+0001ca90: 6166 6572 206f 6666 6963 6961 6c20 6d61  afer official ma
+0001caa0: 726b 6574 2063 6c6f 7365 2c20 652e 672e  rket close, e.g.
+0001cab0: 204a 6f68 616e 6e65 7362 7572 673a 0a20   Johannesburg:. 
+0001cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cad0: 2020 2069 6620 7365 6c66 2e65 7863 6861     if self.excha
+0001cae0: 6e67 6520 696e 205b 224a 4e42 225d 3a0a  nge in ["JNB"]:.
+0001caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb00: 2020 2020 2020 2020 6c61 7374 4461 7461          lastData
+0001cb10: 4474 735b 665f 6e61 5d20 2b3d 2074 696d  Dts[f_na] += tim
+0001cb20: 6564 656c 7461 286d 696e 7574 6573 3d31  edelta(minutes=1
+0001cb30: 3529 0a20 2020 2020 2020 2020 2020 2020  5).             
+0001cb40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001cb50: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+0001cb60: 6464 207e 3130 2068 6f75 7273 2074 6f20  dd ~10 hours to 
+0001cb70: 656e 7375 7265 2068 6974 206e 6578 7420  ensure hit next 
+0001cb80: 6d61 726b 6574 206f 7065 6e0a 2020 2020  market open.    
+0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cba0: 6c61 7374 4461 7461 4474 735b 665f 6e61  lastDataDts[f_na
+0001cbb0: 5d20 2b3d 2074 696d 6564 656c 7461 2868  ] += timedelta(h
+0001cbc0: 6f75 7273 3d31 3029 0a20 2020 2020 2020  ours=10).       
+0001cbd0: 2020 2020 2064 6174 615f 6669 6e61 6c20       data_final 
+0001cbe0: 3d20 6665 7463 685f 6474 203e 3d20 6c61  = fetch_dt >= la
+0001cbf0: 7374 4461 7461 4474 730a 2020 2020 2020  stDataDts.      
+0001cc00: 2020 2020 2020 6466 5b22 4669 6e61 6c3f        df["Final?
+0001cc10: 225d 203d 2064 6174 615f 6669 6e61 6c0a  "] = data_final.
+0001cc20: 0a20 2020 2020 2020 2020 2020 2023 2064  .            # d
+0001cc30: 665b 2246 6574 6368 4461 7465 225d 203d  f["FetchDate"] =
+0001cc40: 2070 642e 5469 6d65 7374 616d 7028 6665   pd.Timestamp(fe
+0001cc50: 7463 685f 6474 5f75 7463 292e 747a 5f6c  tch_dt_utc).tz_l
+0001cc60: 6f63 616c 697a 6528 2255 5443 2229 0a20  ocalize("UTC"). 
+0001cc70: 2020 2020 2020 2020 2020 2064 665b 2246             df["F
+0001cc80: 6574 6368 4461 7465 225d 203d 2066 6574  etchDate"] = fet
+0001cc90: 6368 5f64 745f 7574 630a 0a20 2020 2020  ch_dt_utc..     
+0001cca0: 2020 2020 2020 2064 665b 2243 2d43 6865         df["C-Che
+0001ccb0: 636b 3f22 5d20 3d20 4661 6c73 650a 0a20  ck?"] = False.. 
+0001ccc0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
+0001ccd0: 2066 2250 4d3a 3a5f 6665 7463 6859 6648   f"PM::_fetchYfH
+0001cce0: 6973 746f 7279 2829 2072 6574 7572 6e69  istory() returni
+0001ccf0: 6e67 2044 4620 7b64 662e 696e 6465 785b  ng DF {df.index[
+0001cd00: 305d 7d20 2d3e 207b 6466 2e69 6e64 6578  0]} -> {df.index
+0001cd10: 5b2d 315d 7d22 0a20 2020 2020 2020 2069  [-1]}".        i
+0001cd20: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+0001cd30: 456e 6162 6c65 6428 293a 0a20 2020 2020  Enabled():.     
+0001cd40: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+0001cd50: 6545 7869 7428 6c6f 675f 6d73 6729 0a20  eExit(log_msg). 
+0001cd60: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
+0001cd70: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
+0001cd80: 2020 2070 7269 6e74 286c 6f67 5f6d 7367     print(log_msg
+0001cd90: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0001cda0: 6e20 6466 0a0a 2020 2020 6465 6620 5f66  n df..    def _f
+0001cdb0: 6574 6368 5966 4869 7374 6f72 795f 6461  etchYfHistory_da
+0001cdc0: 7465 5261 6e67 6528 7365 6c66 2c20 7374  teRange(self, st
+0001cdd0: 6172 742c 2065 6e64 2c20 7072 6570 6f73  art, end, prepos
+0001cde0: 742c 2064 6562 7567 293a 0a20 2020 2020  t, debug):.     
+0001cdf0: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+0001ce00: 6b49 6e74 6572 7661 6c44 7428 7374 6172  kIntervalDt(star
+0001ce10: 742c 2073 656c 662e 696e 7465 7276 616c  t, self.interval
+0001ce20: 2c20 2273 7461 7274 2229 0a20 2020 2020  , "start").     
+0001ce30: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+0001ce40: 6b49 6e74 6572 7661 6c44 7428 656e 642c  kIntervalDt(end,
+0001ce50: 2073 656c 662e 696e 7465 7276 616c 2c20   self.interval, 
+0001ce60: 2265 6e64 2229 0a20 2020 2020 2020 2079  "end").        y
+0001ce70: 6663 752e 5479 7065 4368 6563 6b42 6f6f  fcu.TypeCheckBoo
+0001ce80: 6c28 7072 6570 6f73 742c 2022 7072 6570  l(prepost, "prep
+0001ce90: 6f73 7422 290a 2020 2020 2020 2020 7966  ost").        yf
+0001cea0: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
+0001ceb0: 2864 6562 7567 2c20 2264 6562 7567 2229  (debug, "debug")
+0001cec0: 0a0a 2020 2020 2020 2020 6465 6275 675f  ..        debug_
+0001ced0: 7966 6320 3d20 4661 6c73 650a 2020 2020  yfc = False.    
+0001cee0: 2020 2020 2320 6465 6275 675f 7966 6320      # debug_yfc 
+0001cef0: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
+0001cf00: 6c6f 675f 6d73 6720 3d20 6622 504d 3a3a  log_msg = f"PM::
+0001cf10: 5f66 6574 6368 5966 4869 7374 6f72 795f  _fetchYfHistory_
+0001cf20: 6461 7465 5261 6e67 652d 7b73 656c 662e  dateRange-{self.
+0001cf30: 6973 7472 7d28 7374 6172 743d 7b73 7461  istr}(start={sta
+0001cf40: 7274 7d20 2c20 656e 643d 7b65 6e64 7d20  rt} , end={end} 
+0001cf50: 2c20 7072 6570 6f73 743d 7b70 7265 706f  , prepost={prepo
+0001cf60: 7374 7d29 220a 2020 2020 2020 2020 6966  st})".        if
+0001cf70: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
+0001cf80: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
+0001cf90: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+0001cfa0: 456e 7465 7228 6c6f 675f 6d73 6729 0a20  Enter(log_msg). 
+0001cfb0: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
+0001cfc0: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
+0001cfd0: 2020 2070 7269 6e74 2822 2229 0a20 2020     print("").   
+0001cfe0: 2020 2020 2020 2020 2070 7269 6e74 286c           print(l
+0001cff0: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
+0001d000: 2066 6574 6368 5f73 7461 7274 203d 2073   fetch_start = s
+0001d010: 7461 7274 0a20 2020 2020 2020 2066 6574  tart.        fet
+0001d020: 6368 5f65 6e64 203d 2065 6e64 0a20 2020  ch_end = end.   
+0001d030: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+0001d040: 7374 616e 6365 2866 6574 6368 5f73 7461  stance(fetch_sta
+0001d050: 7274 2c20 2864 6174 6574 696d 652c 2070  rt, (datetime, p
+0001d060: 642e 5469 6d65 7374 616d 7029 293a 0a20  d.Timestamp)):. 
+0001d070: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+0001d080: 5f73 7461 7274 5f64 7420 3d20 6461 7465  _start_dt = date
+0001d090: 7469 6d65 2e63 6f6d 6269 6e65 2866 6574  time.combine(fet
+0001d0a0: 6368 5f73 7461 7274 2c20 7469 6d65 2830  ch_start, time(0
+0001d0b0: 292c 2073 656c 662e 747a 290a 2020 2020  ), self.tz).    
+0001d0c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001d0d0: 2020 2020 2020 6665 7463 685f 7374 6172        fetch_star
+0001d0e0: 745f 6474 203d 2066 6574 6368 5f73 7461  t_dt = fetch_sta
+0001d0f0: 7274 0a0a 2020 2020 2020 2020 6869 7374  rt..        hist
+0001d100: 6f72 795f 6172 6773 203d 207b 2270 6572  ory_args = {"per
+0001d110: 696f 6422 3a20 4e6f 6e65 2c0a 2020 2020  iod": None,.    
+0001d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d130: 2020 2020 2269 6e74 6572 7661 6c22 3a20      "interval": 
+0001d140: 7365 6c66 2e69 7374 722c 0a20 2020 2020  self.istr,.     
+0001d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d160: 2020 2022 7374 6172 7422 3a20 6665 7463     "start": fetc
+0001d170: 685f 7374 6172 742c 2022 656e 6422 3a20  h_start, "end": 
+0001d180: 6665 7463 685f 656e 642c 0a20 2020 2020  fetch_end,.     
+0001d190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1a0: 2020 2022 7072 6570 6f73 7422 3a20 7072     "prepost": pr
+0001d1b0: 6570 6f73 742c 0a20 2020 2020 2020 2020  epost,.         
+0001d1c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001d1d0: 6163 7469 6f6e 7322 3a20 5472 7565 2c20  actions": True, 
+0001d1e0: 2023 2041 6c77 6179 7320 6665 7463 680a   # Always fetch.
+0001d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d200: 2020 2020 2020 2020 226b 6565 706e 6122          "keepna"
+0001d210: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
+0001d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d230: 2272 6570 6169 7222 3a20 5472 7565 2c0a  "repair": True,.
+0001d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d250: 2020 2020 2020 2020 2261 7574 6f5f 6164          "auto_ad
+0001d260: 6a75 7374 223a 2046 616c 7365 2c20 2023  just": False,  #
+0001d270: 2073 746f 7265 2072 6177 2064 6174 612c   store raw data,
+0001d280: 2061 646a 7573 7420 6d79 7365 6c66 0a20   adjust myself. 
+0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2a0: 2020 2020 2020 2022 6261 636b 5f61 646a         "back_adj
+0001d2b0: 7573 7422 3a20 4661 6c73 652c 2020 2320  ust": False,  # 
+0001d2c0: 7374 6f72 6520 7261 7720 6461 7461 2c20  store raw data, 
+0001d2d0: 6164 6a75 7374 206d 7973 656c 660a 2020  adjust myself.  
+0001d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2f0: 2020 2020 2020 2270 726f 7879 223a 2073        "proxy": s
+0001d300: 656c 662e 7072 6f78 792c 0a20 2020 2020  elf.proxy,.     
+0001d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d320: 2020 2022 726f 756e 6469 6e67 223a 2046     "rounding": F
+0001d330: 616c 7365 2c20 2023 2073 746f 7265 2072  alse,  # store r
+0001d340: 6177 2064 6174 612c 2072 6f75 6e64 206d  aw data, round m
+0001d350: 7973 656c 660a 2020 2020 2020 2020 2020  yself.          
+0001d360: 2020 2020 2020 2020 2020 2020 2020 2272                "r
+0001d370: 6169 7365 5f65 7272 6f72 7322 3a20 5472  aise_errors": Tr
+0001d380: 7565 7d0a 2020 2020 2020 2020 6966 2064  ue}.        if d
+0001d390: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+0001d3a0: 2020 7966 5f6c 6f67 6765 7220 3d20 6c6f    yf_logger = lo
+0001d3b0: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
+0001d3c0: 2779 6669 6e61 6e63 6527 290a 2020 2020  'yfinance').    
+0001d3d0: 2020 2020 2020 2020 7966 5f6c 6f67 6765          yf_logge
+0001d3e0: 722e 7365 744c 6576 656c 286c 6f67 6769  r.setLevel(loggi
+0001d3f0: 6e67 2e44 4542 5547 2920 2023 2076 6572  ng.DEBUG)  # ver
+0001d400: 626f 7365 3a20 7072 696e 7420 6572 726f  bose: print erro
+0001d410: 7273 2026 2064 6562 7567 2069 6e66 6f0a  rs & debug info.
+0001d420: 0a20 2020 2020 2020 2069 6620 6465 6275  .        if debu
+0001d430: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
+0001d440: 2020 2069 6620 286e 6f74 2069 7369 6e73     if (not isins
+0001d450: 7461 6e63 6528 6665 7463 685f 7374 6172  tance(fetch_star
+0001d460: 742c 2064 6174 6574 696d 6529 2920 6f72  t, datetime)) or
+0001d470: 2066 6574 6368 5f73 7461 7274 2e74 696d   fetch_start.tim
+0001d480: 6528 2920 3d3d 2074 696d 6528 3029 3a0a  e() == time(0):.
+0001d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4a0: 7374 6172 745f 7374 7220 3d20 6665 7463  start_str = fetc
+0001d4b0: 685f 7374 6172 742e 7374 7266 7469 6d65  h_start.strftime
+0001d4c0: 2822 2559 2d25 6d2d 2564 2229 0a20 2020  ("%Y-%m-%d").   
+0001d4d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001d4e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d4f0: 7461 7274 5f73 7472 203d 2066 6574 6368  tart_str = fetch
+0001d500: 5f73 7461 7274 2e73 7472 6674 696d 6528  _start.strftime(
+0001d510: 2225 592d 256d 2d25 6420 2548 3a25 4d3a  "%Y-%m-%d %H:%M:
+0001d520: 2553 2229 0a20 2020 2020 2020 2020 2020  %S").           
+0001d530: 2069 6620 286e 6f74 2069 7369 6e73 7461   if (not isinsta
+0001d540: 6e63 6528 6665 7463 685f 656e 642c 2064  nce(fetch_end, d
+0001d550: 6174 6574 696d 6529 2920 6f72 2066 6574  atetime)) or fet
+0001d560: 6368 5f65 6e64 2e74 696d 6528 2920 3d3d  ch_end.time() ==
+0001d570: 2074 696d 6528 3029 3a0a 2020 2020 2020   time(0):.      
+0001d580: 2020 2020 2020 2020 2020 656e 645f 7374            end_st
+0001d590: 7220 3d20 6665 7463 685f 656e 642e 7374  r = fetch_end.st
+0001d5a0: 7266 7469 6d65 2822 2559 2d25 6d2d 2564  rftime("%Y-%m-%d
+0001d5b0: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+0001d5c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001d5d0: 2020 2020 2065 6e64 5f73 7472 203d 2066       end_str = f
+0001d5e0: 6574 6368 5f65 6e64 2e73 7472 6674 696d  etch_end.strftim
+0001d5f0: 6528 2225 592d 256d 2d25 6420 2548 3a25  e("%Y-%m-%d %H:%
+0001d600: 4d3a 2553 2229 0a20 2020 2020 2020 2020  M:%S").         
+0001d610: 2020 206d 7367 203d 2066 222d 207b 7365     msg = f"- {se
+0001d620: 6c66 2e74 6963 6b65 727d 3a20 6665 7463  lf.ticker}: fetc
+0001d630: 6869 6e67 207b 7365 6c66 2e69 7374 727d  hing {self.istr}
+0001d640: 207b 7374 6172 745f 7374 727d 202d 3e20   {start_str} -> 
+0001d650: 7b65 6e64 5f73 7472 7d22 0a20 2020 2020  {end_str}".     
+0001d660: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+0001d670: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+0001d680: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+0001d690: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+0001d6a0: 7428 6d73 6729 0a0a 2020 2020 2020 2020  t(msg)..        
+0001d6b0: 6669 7273 745f 6665 7463 685f 6661 696c  first_fetch_fail
+0001d6c0: 6564 203d 2046 616c 7365 0a20 2020 2020  ed = False.     
+0001d6d0: 2020 2064 6620 3d20 4e6f 6e65 0a20 2020     df = None.   
+0001d6e0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001d6f0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+0001d700: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+0001d710: 2020 2020 6d73 6720 3d20 6622 2d20 6665      msg = f"- fe
+0001d720: 7463 685f 7374 6172 743d 7b66 6574 6368  tch_start={fetch
+0001d730: 5f73 7461 7274 7d20 3b20 6665 7463 685f  _start} ; fetch_
+0001d740: 656e 643d 7b66 6574 6368 5f65 6e64 7d22  end={fetch_end}"
+0001d750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d760: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+0001d770: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+0001d780: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+0001d790: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
+0001d7a0: 0a20 2020 2020 2020 2020 2020 2064 6620  .            df 
+0001d7b0: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
+0001d7c0: 7279 282a 2a68 6973 746f 7279 5f61 7267  ry(**history_arg
+0001d7d0: 7329 0a20 2020 2020 2020 2020 2020 2064  s).            d
+0001d7e0: 6620 3d20 6466 2e73 6f72 745f 696e 6465  f = df.sort_inde
+0001d7f0: 7828 290a 2020 2020 2020 2020 2020 2020  x().            
+0001d800: 6966 2022 5265 7061 6972 6564 3f22 206e  if "Repaired?" n
+0001d810: 6f74 2069 6e20 6466 2e63 6f6c 756d 6e73  ot in df.columns
+0001d820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001d830: 2020 6466 5b22 5265 7061 6972 6564 3f22    df["Repaired?"
+0001d840: 5d20 3d20 4661 6c73 650a 2020 2020 2020  ] = False.      
+0001d850: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+0001d860: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+0001d870: 2020 2020 6966 2064 6620 6973 204e 6f6e      if df is Non
+0001d880: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001d890: 2020 2020 2020 206d 7367 203d 2022 2d20         msg = "- 
+0001d8a0: 5946 2072 6574 7572 6e65 6420 4e6f 6e65  YF returned None
+0001d8b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001d8c0: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+0001d8d0: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
+0001d8e0: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
+0001d8f0: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
+0001d900: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
+0001d910: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d930: 6d73 6720 3d20 222d 2059 4620 7265 7475  msg = "- YF retu
+0001d940: 726e 6564 2074 6162 6c65 3a22 0a20 2020  rned table:".   
+0001d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d960: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+0001d970: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+0001d980: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+0001d990: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
+0001d9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d9b0: 2020 2020 2070 7269 6e74 2864 665b 5b63       print(df[[c
+0001d9c0: 2066 6f72 2063 2069 6e20 5b22 4f70 656e   for c in ["Open
+0001d9d0: 222c 2022 4c6f 7722 2c20 2248 6967 6822  ", "Low", "High"
+0001d9e0: 2c20 2243 6c6f 7365 222c 2022 4469 7669  , "Close", "Divi
+0001d9f0: 6465 6e64 7322 2c20 2256 6f6c 756d 6522  dends", "Volume"
+0001da00: 5d20 6966 2063 2069 6e20 6466 2e63 6f6c  ] if c in df.col
+0001da10: 756d 6e73 5d5d 290a 2020 2020 2020 2020  umns]]).        
+0001da20: 2020 2020 6966 2064 6620 6973 204e 6f6e      if df is Non
+0001da30: 6520 6f72 2064 662e 656d 7074 793a 0a20  e or df.empty:. 
+0001da40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001da50: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+0001da60: 4e6f 2064 6174 6120 666f 756e 6420 666f  No data found fo
+0001da70: 7220 7468 6973 2064 6174 6520 7261 6e67  r this date rang
+0001da80: 6522 290a 2020 2020 2020 2020 6578 6365  e").        exce
+0001da90: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0001daa0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+0001dab0: 6972 7374 5f66 6574 6368 5f66 6169 6c65  irst_fetch_faile
+0001dac0: 6420 3d20 5472 7565 0a20 2020 2020 2020  d = True.       
+0001dad0: 2020 2020 2069 6620 2244 6174 6120 646f       if "Data do
+0001dae0: 6573 6e27 7420 6578 6973 7420 666f 7220  esn't exist for 
+0001daf0: 7374 6172 7444 6174 6522 2069 6e20 7374  startDate" in st
+0001db00: 7228 6529 3a0a 2020 2020 2020 2020 2020  r(e):.          
+0001db10: 2020 2020 2020 7261 6973 6520 7966 6364        raise yfcd
+0001db20: 2e4e 6f50 7269 6365 4461 7461 496e 5261  .NoPriceDataInRa
+0001db30: 6e67 6545 7863 6570 7469 6f6e 2873 656c  ngeException(sel
+0001db40: 662e 7469 636b 6572 2c20 7365 6c66 2e69  f.ticker, self.i
+0001db50: 7374 722c 2073 7461 7274 2c20 656e 6429  str, start, end)
+0001db60: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0001db70: 6620 224e 6f20 6461 7461 2066 6f75 6e64  f "No data found
+0001db80: 2066 6f72 2074 6869 7320 6461 7465 2072   for this date r
+0001db90: 616e 6765 2220 696e 2073 7472 2865 293a  ange" in str(e):
+0001dba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dbb0: 2072 6169 7365 2079 6663 642e 4e6f 5072   raise yfcd.NoPr
+0001dbc0: 6963 6544 6174 6149 6e52 616e 6765 4578  iceDataInRangeEx
+0001dbd0: 6365 7074 696f 6e28 7365 6c66 2e74 6963  ception(self.tic
+0001dbe0: 6b65 722c 2073 656c 662e 6973 7472 2c20  ker, self.istr, 
+0001dbf0: 7374 6172 742c 2065 6e64 290a 2020 2020  start, end).    
+0001dc00: 2020 2020 2020 2020 656c 6966 2022 4e6f          elif "No
+0001dc10: 2070 7269 6365 2064 6174 6120 666f 756e   price data foun
+0001dc20: 642c 2073 796d 626f 6c20 6d61 7920 6265  d, symbol may be
+0001dc30: 2064 656c 6973 7465 6422 2069 6e20 7374   delisted" in st
+0001dc40: 7228 6529 3a0a 2020 2020 2020 2020 2020  r(e):.          
+0001dc50: 2020 2020 2020 7261 6973 6520 7966 6364        raise yfcd
+0001dc60: 2e4e 6f50 7269 6365 4461 7461 496e 5261  .NoPriceDataInRa
+0001dc70: 6e67 6545 7863 6570 7469 6f6e 2873 656c  ngeException(sel
+0001dc80: 662e 7469 636b 6572 2c20 7365 6c66 2e69  f.ticker, self.i
+0001dc90: 7374 722c 2073 7461 7274 2c20 656e 6429  str, start, end)
+0001dca0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001dcb0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001dcc0: 2020 2070 7269 6e74 2822 6466 3a22 290a     print("df:").
+0001dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dce0: 7072 696e 7428 6466 290a 2020 2020 2020  print(df).      
+0001dcf0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001dd00: 650a 0a20 2020 2020 2020 2069 6620 6e6f  e..        if no
+0001dd10: 7420 6669 7273 745f 6665 7463 685f 6661  t first_fetch_fa
+0001dd20: 696c 6564 2061 6e64 2066 6574 6368 5f73  iled and fetch_s
+0001dd30: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
+0001dd40: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+0001dd50: 675f 6d73 6720 3d20 6622 7265 7175 6573  g_msg = f"reques
+0001dd60: 7465 6420 6672 6f6d 2059 463a 207b 7365  ted from YF: {se
+0001dd70: 6c66 2e69 7374 727d 207b 6869 7374 6f72  lf.istr} {histor
+0001dd80: 795f 6172 6773 5b27 7374 6172 7427 5d7d  y_args['start']}
+0001dd90: 202d 3e20 7b68 6973 746f 7279 5f61 7267   -> {history_arg
+0001dda0: 735b 2765 6e64 275d 7d22 0a20 2020 2020  s['end']}".     
+0001ddb0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+0001ddc0: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
+0001ddd0: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+0001dde0: 202b 3d20 6622 2c20 7265 6365 6976 6564   += f", received
+0001ddf0: 3a20 7b64 662e 696e 6465 785b 305d 2e64  : {df.index[0].d
+0001de00: 6174 6528 297d 202d 3e20 7b64 662e 696e  ate()} -> {df.in
+0001de10: 6465 785b 2d31 5d2e 6461 7465 2829 7d22  dex[-1].date()}"
+0001de20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001de30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001de40: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
+0001de50: 2c20 7265 6365 6976 6564 3a20 7b64 662e  , received: {df.
+0001de60: 696e 6465 785b 305d 7d20 2d3e 207b 6466  index[0]} -> {df
+0001de70: 2e69 6e64 6578 5b2d 315d 7d22 0a20 2020  .index[-1]}".   
+0001de80: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+0001de90: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
+0001dea0: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
+0001deb0: 6167 6572 222c 206c 6f67 5f6d 7367 290a  ager", log_msg).
+0001dec0: 0a20 2020 2020 2020 2020 2020 2064 6620  .            df 
+0001ded0: 3d20 6466 2e6c 6f63 5b66 6574 6368 5f73  = df.loc[fetch_s
+0001dee0: 7461 7274 5f64 743a 5d0a 2020 2020 2020  tart_dt:].      
+0001def0: 2020 2020 2020 6966 2064 662e 656d 7074        if df.empt
+0001df00: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0001df10: 2020 2066 6972 7374 5f66 6574 6368 5f66     first_fetch_f
+0001df20: 6169 6c65 6420 3d20 5472 7565 0a20 2020  ailed = True.   
+0001df30: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001df40: 7365 2079 6663 642e 4e6f 5072 6963 6544  se yfcd.NoPriceD
+0001df50: 6174 6149 6e52 616e 6765 4578 6365 7074  ataInRangeExcept
+0001df60: 696f 6e28 7365 6c66 2e74 6963 6b65 722c  ion(self.ticker,
+0001df70: 2073 656c 662e 6973 7472 2c20 7374 6172   self.istr, star
+0001df80: 742c 2065 6e64 290a 0a20 2020 2020 2020  t, end)..       
+0001df90: 2023 2043 6865 636b 2074 6861 7420 7765   # Check that we
+0001dfa0: 656b 6c79 2061 6c69 676e 6564 2074 6f20  ekly aligned to 
+0001dfb0: 4d6f 6e64 6179 2e20 4966 206e 6f74 2c20  Monday. If not, 
+0001dfc0: 7368 6966 7420 7374 6172 7420 6461 7465  shift start date
+0001dfd0: 2062 6163 6b20 616e 6420 7265 2d66 6574   back and re-fet
+0001dfe0: 6368 0a20 2020 2020 2020 2069 6620 7365  ch.        if se
+0001dff0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+0001e000: 6663 642e 496e 7465 7276 616c 2e57 6565  fcd.Interval.Wee
+0001e010: 6b20 616e 6420 286e 6f74 2064 662e 656d  k and (not df.em
+0001e020: 7074 7929 2061 6e64 2028 6466 2e69 6e64  pty) and (df.ind
+0001e030: 6578 5b30 5d2e 7765 656b 6461 7928 2920  ex[0].weekday() 
+0001e040: 213d 2030 293a 0a20 2020 2020 2020 2020  != 0):.         
+0001e050: 2020 2023 2044 6573 7069 7465 2066 6574     # Despite fet
+0001e060: 6368 5f73 7461 7274 2061 6c69 676e 6564  ch_start aligned
+0001e070: 2074 6f20 4d6f 6e64 6179 2c20 736f 6d65   to Monday, some
+0001e080: 7469 6d65 7320 5961 686f 6f20 7265 7475  times Yahoo retu
+0001e090: 726e 7320 7765 656b 6c79 0a20 2020 2020  rns weekly.     
+0001e0a0: 2020 2020 2020 2023 2064 6174 6120 7374         # data st
+0001e0b0: 6172 7469 6e67 2061 2064 6966 6665 7265  arting a differe
+0001e0c0: 6e74 2064 6179 2e20 5368 6966 7469 6e67  nt day. Shifting
+0001e0d0: 2062 6163 6b20 6120 6c69 7474 6c65 2066   back a little f
+0001e0e0: 6978 6573 0a20 2020 2020 2020 2020 2020  ixes.           
+0001e0f0: 2073 6869 6674 5f62 6163 6b73 203d 205b   shift_backs = [
+0001e100: 322c 2034 5d0a 2020 2020 2020 2020 2020  2, 4].          
+0001e110: 2020 666f 7220 6420 696e 2073 6869 6674    for d in shift
+0001e120: 5f62 6163 6b73 3a0a 2020 2020 2020 2020  _backs:.        
+0001e130: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+0001e140: 6172 7432 203d 2066 6574 6368 5f73 7461  art2 = fetch_sta
+0001e150: 7274 202d 2074 696d 6564 656c 7461 2864  rt - timedelta(d
+0001e160: 6179 733d 6429 0a20 2020 2020 2020 2020  ays=d).         
+0001e170: 2020 2020 2020 2068 6973 746f 7279 5f61         history_a
+0001e180: 7267 735b 2273 7461 7274 225d 203d 2066  rgs["start"] = f
+0001e190: 6574 6368 5f73 7461 7274 320a 2020 2020  etch_start2.    
+0001e1a0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0001e1b0: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
+0001e1c0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+0001e1d0: 6720 3d20 222d 2077 6565 6b6c 7920 6461  g = "- weekly da
+0001e1e0: 7461 206e 6f74 2061 6c69 676e 6564 2074  ta not aligned t
+0001e1f0: 6f20 4d6f 6e64 6179 2c20 7265 2d66 6574  o Monday, re-fet
+0001e200: 6368 696e 6720 6672 6f6d 207b 7d22 2e66  ching from {}".f
+0001e210: 6f72 6d61 7428 6665 7463 685f 7374 6172  ormat(fetch_star
+0001e220: 7432 290a 2020 2020 2020 2020 2020 2020  t2).            
+0001e230: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+0001e240: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+0001e250: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+0001e260: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+0001e270: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+0001e280: 2020 2020 2020 2020 6466 203d 2073 656c          df = sel
+0001e290: 662e 6461 742e 6869 7374 6f72 7928 2a2a  f.dat.history(**
+0001e2a0: 6869 7374 6f72 795f 6172 6773 290a 2020  history_args).  
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001e2c0: 2022 5265 7061 6972 6564 3f22 206e 6f74   "Repaired?" not
+0001e2d0: 2069 6e20 6466 2e63 6f6c 756d 6e73 3a0a   in df.columns:.
+0001e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2f0: 2020 2020 6466 5b22 5265 7061 6972 6564      df["Repaired
+0001e300: 3f22 5d20 3d20 4661 6c73 650a 2020 2020  ?"] = False.    
+0001e310: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001e320: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
+0001e330: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
+0001e340: 656b 2061 6e64 2028 6466 2e69 6e64 6578  ek and (df.index
+0001e350: 5b30 5d2e 7765 656b 6461 7928 2920 3d3d  [0].weekday() ==
+0001e360: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+0001e370: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+0001e380: 203d 2066 2272 6571 7565 7374 6564 2066   = f"requested f
+0001e390: 726f 6d20 5946 3a20 7b73 656c 662e 6973  rom YF: {self.is
+0001e3a0: 7472 7d20 7b68 6973 746f 7279 5f61 7267  tr} {history_arg
+0001e3b0: 735b 2773 7461 7274 275d 7d20 2d3e 207b  s['start']} -> {
+0001e3c0: 6869 7374 6f72 795f 6172 6773 5b27 656e  history_args['en
+0001e3d0: 6427 5d7d 220a 2020 2020 2020 2020 2020  d']}".          
+0001e3e0: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
+0001e3f0: 6720 2b3d 2066 222c 2072 6563 6569 7665  g += f", receive
+0001e400: 643a 207b 6466 2e69 6e64 6578 5b30 5d7d  d: {df.index[0]}
+0001e410: 202d 3e20 7b64 662e 696e 6465 785b 2d31   -> {df.index[-1
+0001e420: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
+0001e430: 2020 2020 2020 2020 7365 6c66 2e6d 616e          self.man
+0001e440: 6167 6572 2e4c 6f67 4576 656e 7428 2269  ager.LogEvent("i
+0001e450: 6e66 6f22 2c20 2250 7269 6365 4d61 6e61  nfo", "PriceMana
+0001e460: 6765 7222 2c20 6c6f 675f 6d73 6729 0a0a  ger", log_msg)..
+0001e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e480: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001e490: 6528 7374 6172 742c 2064 6174 6574 696d  e(start, datetim
+0001e4a0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001e4b0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0001e4c0: 745f 6474 203d 2073 7461 7274 0a20 2020  t_dt = start.   
+0001e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e4e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001e4f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001e500: 7461 7274 5f64 7420 3d20 6461 7465 7469  tart_dt = dateti
+0001e510: 6d65 2e63 6f6d 6269 6e65 2873 7461 7274  me.combine(start
+0001e520: 2c20 7469 6d65 2830 292c 2073 656c 662e  , time(0), self.
+0001e530: 747a 290a 2020 2020 2020 2020 2020 2020  tz).            
+0001e540: 2020 2020 2020 2020 6466 203d 2064 662e          df = df.
+0001e550: 6c6f 635b 7374 6172 745f 6474 3a5d 0a20  loc[start_dt:]. 
+0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e570: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+0001e580: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+0001e590: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001e5a0: 6e74 6572 7661 6c2e 5765 656b 2061 6e64  nterval.Week and
+0001e5b0: 2028 6466 2e69 6e64 6578 5b30 5d2e 7765   (df.index[0].we
+0001e5c0: 656b 6461 7928 2920 213d 2030 293a 0a20  ekday() != 0):. 
+0001e5d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001e5e0: 2070 7269 6e74 2822 4461 7465 2072 616e   print("Date ran
+0001e5f0: 6765 2072 6571 7565 7374 6564 3a20 7b7d  ge requested: {}
+0001e600: 202d 3e20 7b7d 222e 666f 726d 6174 2866   -> {}".format(f
+0001e610: 6574 6368 5f73 7461 7274 2c20 6665 7463  etch_start, fetc
+0001e620: 685f 656e 6429 290a 2020 2020 2020 2020  h_end)).        
+0001e630: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
+0001e640: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001e650: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+0001e660: 6e28 2257 6565 6b6c 7920 6461 7461 2072  n("Weekly data r
+0001e670: 6574 7572 6e65 6420 6279 2059 4620 646f  eturned by YF do
+0001e680: 6573 6e27 7420 6265 6769 6e20 4d6f 6e64  esn't begin Mond
+0001e690: 6179 2062 7574 207b 7d22 2e66 6f72 6d61  ay but {}".forma
+0001e6a0: 7428 6466 2e69 6e64 6578 5b30 5d2e 7765  t(df.index[0].we
+0001e6b0: 656b 6461 7928 2929 290a 0a20 2020 2020  ekday()))..     
+0001e6c0: 2020 2069 6620 6466 2069 7320 6e6f 7420     if df is not 
+0001e6d0: 4e6f 6e65 2061 6e64 2064 662e 656d 7074  None and df.empt
+0001e6e0: 793a 0a20 2020 2020 2020 2020 2020 2064  y:.            d
+0001e6f0: 6620 3d20 4e6f 6e65 0a0a 2020 2020 2020  f = None..      
+0001e700: 2020 6966 2064 6620 6973 204e 6f6e 653a    if df is None:
+0001e710: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001e720: 5f6d 7367 203d 2022 504d 3a3a 5f66 6574  _msg = "PM::_fet
+0001e730: 6368 5966 4869 7374 6f72 795f 6461 7465  chYfHistory_date
+0001e740: 5261 6e67 6528 2920 7265 7475 726e 696e  Range() returnin
+0001e750: 6720 4e6f 6e65 220a 2020 2020 2020 2020  g None".        
+0001e760: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001e770: 2020 6c6f 675f 6d73 6720 3d20 6622 504d    log_msg = f"PM
+0001e780: 3a3a 5f66 6574 6368 5966 4869 7374 6f72  ::_fetchYfHistor
+0001e790: 795f 6461 7465 5261 6e67 6528 2920 7265  y_dateRange() re
+0001e7a0: 7475 726e 696e 6720 4446 207b 6466 2e69  turning DF {df.i
+0001e7b0: 6e64 6578 5b30 5d7d 202d 3e20 7b64 662e  ndex[0]} -> {df.
+0001e7c0: 696e 6465 785b 2d31 5d7d 220a 2020 2020  index[-1]}".    
+0001e7d0: 2020 2020 6966 2079 6663 6c2e 4973 5472      if yfcl.IsTr
+0001e7e0: 6163 696e 6745 6e61 626c 6564 2829 3a0a  acingEnabled():.
+0001e7f0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0001e800: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+0001e810: 7367 290a 2020 2020 2020 2020 656c 6966  sg).        elif
+0001e820: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
+0001e830: 2020 2020 2020 2020 7072 696e 7428 6c6f          print(lo
+0001e840: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
+0001e850: 2320 6466 203d 2079 6663 752e 4375 7374  # df = yfcu.Cust
+0001e860: 6f6d 4e61 6e43 6865 636b 696e 6744 6174  omNanCheckingDat
+0001e870: 6146 7261 6d65 2864 6629 0a0a 2020 2020  aFrame(df)..    
+0001e880: 2020 2020 7265 7475 726e 2064 660a 0a20      return df.. 
+0001e890: 2020 2064 6566 205f 7265 636f 6e73 7472     def _reconstr
+0001e8a0: 7563 745f 696e 7465 7276 616c 735f 6261  uct_intervals_ba
+0001e8b0: 7463 6828 7365 6c66 2c20 6466 2c20 7461  tch(self, df, ta
+0001e8c0: 673d 2d31 293a 0a20 2020 2020 2020 2069  g=-1):.        i
+0001e8d0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0001e8e0: 2864 662c 2070 642e 4461 7461 4672 616d  (df, pd.DataFram
+0001e8f0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001e900: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0001e910: 2227 6466 2720 6d75 7374 2062 6520 6120  "'df' must be a 
+0001e920: 5061 6e64 6173 2044 6174 6146 7261 6d65  Pandas DataFrame
+0001e930: 206e 6f74 222c 2074 7970 6528 6466 2929   not", type(df))
+0001e940: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001e950: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0001e960: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
+0001e970: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001e980: 7475 726e 2064 660a 0a20 2020 2020 2020  turn df..       
+0001e990: 2023 2052 6563 6f6e 7374 7275 6374 2076   # Reconstruct v
+0001e9a0: 616c 7565 7320 696e 2064 6620 7573 696e  alues in df usin
+0001e9b0: 6720 6669 6e65 722d 6772 6169 6e65 6420  g finer-grained 
+0001e9c0: 7072 6963 6520 6461 7461 2e20 4465 6c69  price data. Deli
+0001e9d0: 6d69 7465 7220 6d61 726b 7320 7768 6174  miter marks what
+0001e9e0: 2074 6f20 7265 636f 6e73 7472 7563 740a   to reconstruct.
+0001e9f0: 0a20 2020 2020 2020 2064 6562 7567 203d  .        debug =
+0001ea00: 2046 616c 7365 0a20 2020 2020 2020 2023   False.        #
+0001ea10: 2064 6562 7567 203d 2054 7275 650a 0a20   debug = True.. 
+0001ea20: 2020 2020 2020 2070 7269 6365 5f63 6f6c         price_col
+0001ea30: 7320 3d20 5b63 2066 6f72 2063 2069 6e20  s = [c for c in 
+0001ea40: 5b22 4f70 656e 222c 2022 4869 6768 222c  ["Open", "High",
+0001ea50: 2022 4c6f 7722 2c20 2243 6c6f 7365 222c   "Low", "Close",
+0001ea60: 2022 4164 6a20 436c 6f73 6522 5d20 6966   "Adj Close"] if
+0001ea70: 2063 2069 6e20 6466 5d0a 2020 2020 2020   c in df].      
+0001ea80: 2020 6461 7461 5f63 6f6c 7320 3d20 7072    data_cols = pr
+0001ea90: 6963 655f 636f 6c73 202b 205b 2256 6f6c  ice_cols + ["Vol
+0001eaa0: 756d 6522 5d0a 0a20 2020 2020 2020 206c  ume"]..        l
+0001eab0: 6f67 5f6d 7367 203d 2066 2250 4d3a 3a5f  og_msg = f"PM::_
+0001eac0: 7265 636f 6e73 7472 7563 745f 696e 7465  reconstruct_inte
+0001ead0: 7276 616c 735f 6261 7463 682d 7b73 656c  rvals_batch-{sel
+0001eae0: 662e 6973 7472 7d28 6474 303d 7b64 662e  f.istr}(dt0={df.
+0001eaf0: 696e 6465 785b 305d 7d29 220a 2020 2020  index[0]})".    
+0001eb00: 2020 2020 7966 636c 2e54 7261 6365 456e      yfcl.TraceEn
+0001eb10: 7465 7228 6c6f 675f 6d73 6729 0a0a 2020  ter(log_msg)..  
+0001eb20: 2020 2020 2020 2320 4966 2069 6e74 6572        # If inter
+0001eb30: 7661 6c20 6973 2077 6565 6b6c 7920 7468  val is weekly th
+0001eb40: 656e 2063 616e 2063 6f6e 7374 7275 6374  en can construct
+0001eb50: 2077 6974 6820 6461 696c 792e 2042 7574   with daily. But
+0001eb60: 2069 6620 736d 616c 6c65 7220 696e 7465   if smaller inte
+0001eb70: 7276 616c 7320 7468 656e 0a20 2020 2020  rvals then.     
+0001eb80: 2020 2023 2072 6573 7472 6963 7465 6420     # restricted 
+0001eb90: 746f 2072 6563 656e 7420 7469 6d65 733a  to recent times:
+0001eba0: 0a20 2020 2020 2020 206d 696e 5f6c 6f6f  .        min_loo
+0001ebb0: 6b62 6163 6b20 3d20 4e6f 6e65 0a20 2020  kback = None.   
+0001ebc0: 2020 2020 2023 202d 2064 6169 6c79 203d       # - daily =
+0001ebd0: 2068 6f75 726c 7920 7265 7374 7269 6374   hourly restrict
+0001ebe0: 6564 2074 6f20 6c61 7374 2037 3330 2064  ed to last 730 d
+0001ebf0: 6179 730a 2020 2020 2020 2020 6966 2073  ays.        if s
+0001ec00: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
+0001ec10: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
+0001ec20: 656b 3a0a 2020 2020 2020 2020 2020 2020  ek:.            
+0001ec30: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
+0001ec40: 6368 696e 6720 7765 656b 206f 6620 6461  ching week of da
+0001ec50: 696c 7920 6461 7461 0a20 2020 2020 2020  ily data.       
+0001ec60: 2020 2020 2073 7562 5f69 6e74 6572 7661       sub_interva
+0001ec70: 6c20 3d20 7966 6364 2e49 6e74 6572 7661  l = yfcd.Interva
+0001ec80: 6c2e 4461 7973 310a 2020 2020 2020 2020  l.Days1.        
+0001ec90: 2020 2020 7464 5f72 616e 6765 203d 2074      td_range = t
+0001eca0: 696d 6564 656c 7461 2864 6179 733d 3729  imedelta(days=7)
+0001ecb0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+0001ecc0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+0001ecd0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
+0001ece0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
+0001ecf0: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
+0001ed00: 6368 696e 6720 6461 7920 6f66 2068 6f75  ching day of hou
+0001ed10: 726c 7920 6461 7461 0a20 2020 2020 2020  rly data.       
+0001ed20: 2020 2020 2073 7562 5f69 6e74 6572 7661       sub_interva
+0001ed30: 6c20 3d20 7966 6364 2e49 6e74 6572 7661  l = yfcd.Interva
+0001ed40: 6c2e 486f 7572 7331 0a20 2020 2020 2020  l.Hours1.       
+0001ed50: 2020 2020 2074 645f 7261 6e67 6520 3d20       td_range = 
+0001ed60: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
+0001ed70: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
+0001ed80: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
+0001ed90: 6564 656c 7461 2864 6179 733d 3733 3029  edelta(days=730)
+0001eda0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+0001edb0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+0001edc0: 6663 642e 496e 7465 7276 616c 2e48 6f75  fcd.Interval.Hou
+0001edd0: 7273 313a 0a20 2020 2020 2020 2020 2020  rs1:.           
+0001ede0: 2023 2043 6f72 7265 6374 2062 7920 6665   # Correct by fe
+0001edf0: 7463 6869 6e67 2068 6f75 7220 6f66 2033  tching hour of 3
+0001ee00: 306d 2064 6174 610a 2020 2020 2020 2020  0m data.        
+0001ee10: 2020 2020 7375 625f 696e 7465 7276 616c      sub_interval
+0001ee20: 203d 2079 6663 642e 496e 7465 7276 616c   = yfcd.Interval
+0001ee30: 2e4d 696e 7333 300a 2020 2020 2020 2020  .Mins30.        
+0001ee40: 2020 2020 7464 5f72 616e 6765 203d 2074      td_range = t
+0001ee50: 696d 6564 656c 7461 2868 6f75 7273 3d31  imedelta(hours=1
+0001ee60: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
+0001ee70: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
+0001ee80: 6564 656c 7461 2864 6179 733d 3630 290a  edelta(days=60).
+0001ee90: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0001eea0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+0001eeb0: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+0001eec0: 3330 3a0a 2020 2020 2020 2020 2020 2020  30:.            
+0001eed0: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
+0001eee0: 6368 696e 6720 686f 7572 206f 6620 3135  ching hour of 15
+0001eef0: 6d20 6461 7461 0a20 2020 2020 2020 2020  m data.         
+0001ef00: 2020 2073 7562 5f69 6e74 6572 7661 6c20     sub_interval 
+0001ef10: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0001ef20: 4d69 6e73 3135 0a20 2020 2020 2020 2020  Mins15.         
+0001ef30: 2020 2074 645f 7261 6e67 6520 3d20 7469     td_range = ti
+0001ef40: 6d65 6465 6c74 6128 6d69 6e75 7465 733d  medelta(minutes=
+0001ef50: 3330 290a 2020 2020 2020 2020 2020 2020  30).            
+0001ef60: 6d69 6e5f 6c6f 6f6b 6261 636b 203d 2074  min_lookback = t
+0001ef70: 696d 6564 656c 7461 2864 6179 733d 3630  imedelta(days=60
+0001ef80: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+0001ef90: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
+0001efa0: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
+0001efb0: 6e73 3135 3a0a 2020 2020 2020 2020 2020  ns15:.          
+0001efc0: 2020 2320 436f 7272 6563 7420 6279 2066    # Correct by f
+0001efd0: 6574 6368 696e 6720 686f 7572 206f 6620  etching hour of 
+0001efe0: 356d 2064 6174 610a 2020 2020 2020 2020  5m data.        
+0001eff0: 2020 2020 7375 625f 696e 7465 7276 616c      sub_interval
+0001f000: 203d 2079 6663 642e 496e 7465 7276 616c   = yfcd.Interval
+0001f010: 2e4d 696e 7335 0a20 2020 2020 2020 2020  .Mins5.         
+0001f020: 2020 2074 645f 7261 6e67 6520 3d20 7469     td_range = ti
+0001f030: 6d65 6465 6c74 6128 6d69 6e75 7465 733d  medelta(minutes=
+0001f040: 3135 290a 2020 2020 2020 2020 2020 2020  15).            
+0001f050: 6d69 6e5f 6c6f 6f6b 6261 636b 203d 2074  min_lookback = t
+0001f060: 696d 6564 656c 7461 2864 6179 733d 3630  imedelta(days=60
+0001f070: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+0001f080: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
+0001f090: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
+0001f0a0: 6e73 353a 0a20 2020 2020 2020 2020 2020  ns5:.           
+0001f0b0: 2023 2043 6f72 7265 6374 2062 7920 6665   # Correct by fe
+0001f0c0: 7463 6869 6e67 2068 6f75 7220 6f66 2032  tching hour of 2
+0001f0d0: 6d20 6461 7461 0a20 2020 2020 2020 2020  m data.         
+0001f0e0: 2020 2073 7562 5f69 6e74 6572 7661 6c20     sub_interval 
+0001f0f0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0001f100: 4d69 6e73 320a 2020 2020 2020 2020 2020  Mins2.          
+0001f110: 2020 7464 5f72 616e 6765 203d 2074 696d    td_range = tim
+0001f120: 6564 656c 7461 286d 696e 7574 6573 3d35  edelta(minutes=5
+0001f130: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
+0001f140: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
+0001f150: 6564 656c 7461 2864 6179 733d 3630 290a  edelta(days=60).
+0001f160: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0001f170: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+0001f180: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+0001f190: 323a 0a20 2020 2020 2020 2020 2020 2023  2:.            #
+0001f1a0: 2043 6f72 7265 6374 2062 7920 6665 7463   Correct by fetc
+0001f1b0: 6869 6e67 2068 6f75 7220 6f66 2031 6d20  hing hour of 1m 
+0001f1c0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0001f1d0: 2073 7562 5f69 6e74 6572 7661 6c20 3d20   sub_interval = 
+0001f1e0: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
+0001f1f0: 6e73 310a 2020 2020 2020 2020 2020 2020  ns1.            
+0001f200: 7464 5f72 616e 6765 203d 2074 696d 6564  td_range = timed
+0001f210: 656c 7461 286d 696e 7574 6573 3d32 290a  elta(minutes=2).
+0001f220: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0001f230: 6c6f 6f6b 6261 636b 203d 2074 696d 6564  lookback = timed
+0001f240: 656c 7461 2864 6179 733d 3330 290a 2020  elta(days=30).  
+0001f250: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001f260: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
+0001f270: 5741 524e 494e 473a 2048 6176 6520 6e6f  WARNING: Have no
+0001f280: 7420 696d 706c 656d 656e 7465 6420 7265  t implemented re
+0001f290: 7061 6972 2066 6f72 2027 7b73 656c 662e  pair for '{self.
+0001f2a0: 696e 7465 7276 616c 7d27 2069 6e74 6572  interval}' inter
+0001f2b0: 7661 6c2e 2043 6f6e 7461 6374 2064 6576  val. Contact dev
+0001f2c0: 656c 6f70 6572 7322 0a20 2020 2020 2020  elopers".       
+0001f2d0: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
+0001f2e0: 7269 6e74 286d 7367 2920 6966 2079 6663  rint(msg) if yfc
+0001f2f0: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
+0001f300: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
+0001f310: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0001f320: 206c 6f67 5f6d 7367 203d 2022 504d 3a3a   log_msg = "PM::
+0001f330: 5f72 6563 6f6e 7374 7275 6374 5f69 6e74  _reconstruct_int
+0001f340: 6572 7661 6c73 5f62 6174 6368 2829 2072  ervals_batch() r
+0001f350: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
+0001f360: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+0001f370: 4578 6974 286c 6f67 5f6d 7367 290a 2020  Exit(log_msg).  
+0001f380: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001f390: 2064 660a 2020 2020 2020 2020 7375 625f   df.        sub_
+0001f3a0: 696e 7465 7264 6179 203d 2073 7562 5f69  interday = sub_i
+0001f3b0: 6e74 6572 7661 6c20 696e 205b 7966 6364  nterval in [yfcd
+0001f3c0: 2e49 6e74 6572 7661 6c2e 4461 7973 312c  .Interval.Days1,
+0001f3d0: 2079 6663 642e 496e 7465 7276 616c 2e57   yfcd.Interval.W
+0001f3e0: 6565 6b5d 232c 2079 6663 642e 496e 7465  eek]#, yfcd.Inte
+0001f3f0: 7276 616c 2e4d 6f6e 7468 7331 2c20 7966  rval.Months1, yf
+0001f400: 6364 2e49 6e74 6572 7661 6c2e 4d6f 6e74  cd.Interval.Mont
+0001f410: 6873 335d 0a20 2020 2020 2020 2073 7562  hs3].        sub
+0001f420: 5f69 6e74 7261 6461 7920 3d20 6e6f 7420  _intraday = not 
+0001f430: 7375 625f 696e 7465 7264 6179 0a0a 2020  sub_interday..  
+0001f440: 2020 2020 2020 6466 203d 2064 662e 736f        df = df.so
+0001f450: 7274 5f69 6e64 6578 2829 0a0a 2020 2020  rt_index()..    
+0001f460: 2020 2020 665f 7265 7061 6972 203d 2064      f_repair = d
+0001f470: 665b 6461 7461 5f63 6f6c 735d 2e74 6f5f  f[data_cols].to_
+0001f480: 6e75 6d70 7928 2920 3d3d 2074 6167 0a20  numpy() == tag. 
+0001f490: 2020 2020 2020 2066 5f72 6570 6169 725f         f_repair_
+0001f4a0: 726f 7773 203d 2066 5f72 6570 6169 722e  rows = f_repair.
+0001f4b0: 616e 7928 6178 6973 3d31 290a 0a20 2020  any(axis=1)..   
+0001f4c0: 2020 2020 2023 2049 676e 6f72 6520 6f6c       # Ignore ol
+0001f4d0: 6420 696e 7465 7276 616c 7320 666f 7220  d intervals for 
+0001f4e0: 7768 6963 6820 5961 686f 6f20 776f 6e27  which Yahoo won'
+0001f4f0: 7420 7265 7475 726e 2066 696e 6572 2064  t return finer d
+0001f500: 6174 613a 0a20 2020 2020 2020 2023 2069  ata:.        # i
+0001f510: 6620 7375 625f 696e 7465 7276 616c 203d  f sub_interval =
+0001f520: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0001f530: 486f 7572 7331 3a0a 2020 2020 2020 2020  Hours1:.        
+0001f540: 2320 2020 2020 665f 7265 6365 6e74 203d  #     f_recent =
+0001f550: 2064 6174 652e 746f 6461 7928 2920 2d20   date.today() - 
+0001f560: 6466 2e69 6e64 6578 2e64 6174 6520 3c20  df.index.date < 
+0001f570: 7469 6d65 6465 6c74 6128 6461 7973 3d37  timedelta(days=7
+0001f580: 3330 290a 2020 2020 2020 2020 2320 2020  30).        #   
+0001f590: 2020 665f 7265 7061 6972 5f72 6f77 7320    f_repair_rows 
+0001f5a0: 3d20 665f 7265 7061 6972 5f72 6f77 7320  = f_repair_rows 
+0001f5b0: 2620 665f 7265 6365 6e74 0a20 2020 2020  & f_recent.     
+0001f5c0: 2020 2023 2065 6c69 6620 7375 625f 696e     # elif sub_in
+0001f5d0: 7465 7276 616c 2069 6e20 5b79 6663 642e  terval in [yfcd.
+0001f5e0: 496e 7465 7276 616c 2e4d 696e 7333 302c  Interval.Mins30,
+0001f5f0: 2079 6663 642e 496e 7465 7276 616c 2e4d   yfcd.Interval.M
+0001f600: 696e 7331 355d 3a0a 2020 2020 2020 2020  ins15]:.        
+0001f610: 2320 2020 2020 665f 7265 6365 6e74 203d  #     f_recent =
+0001f620: 2064 6174 652e 746f 6461 7928 2920 2d20   date.today() - 
+0001f630: 6466 2e69 6e64 6578 2e64 6174 6520 3c20  df.index.date < 
+0001f640: 7469 6d65 6465 6c74 6128 6461 7973 3d36  timedelta(days=6
+0001f650: 3029 0a20 2020 2020 2020 2023 2020 2020  0).        #    
+0001f660: 2066 5f72 6570 6169 725f 726f 7773 203d   f_repair_rows =
+0001f670: 2066 5f72 6570 6169 725f 726f 7773 2026   f_repair_rows &
+0001f680: 2066 5f72 6563 656e 740a 2020 2020 2020   f_recent.      
+0001f690: 2020 6966 206d 696e 5f6c 6f6f 6b62 6163    if min_lookbac
+0001f6a0: 6b20 6973 204e 6f6e 653a 0a20 2020 2020  k is None:.     
+0001f6b0: 2020 2020 2020 206d 696e 5f64 7420 3d20         min_dt = 
+0001f6c0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
+0001f6d0: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
+0001f6e0: 696e 5f64 7420 3d20 7064 2e54 696d 6573  in_dt = pd.Times
+0001f6f0: 7461 6d70 2e75 7463 6e6f 7728 292e 747a  tamp.utcnow().tz
+0001f700: 5f63 6f6e 7665 7274 285a 6f6e 6549 6e66  _convert(ZoneInf
+0001f710: 6f28 2255 5443 2229 2920 2d20 6d69 6e5f  o("UTC")) - min_
+0001f720: 6c6f 6f6b 6261 636b 0a20 2020 2020 2020  lookback.       
+0001f730: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
+0001f740: 2020 2020 2020 2070 7269 6e74 2866 222d         print(f"-
+0001f750: 206d 696e 5f64 743d 7b6d 696e 5f64 747d   min_dt={min_dt}
+0001f760: 2069 6e74 6572 7661 6c3d 7b73 656c 662e   interval={self.
+0001f770: 696e 7465 7276 616c 7d20 7375 625f 696e  interval} sub_in
+0001f780: 7465 7276 616c 3d7b 7375 625f 696e 7465  terval={sub_inte
+0001f790: 7276 616c 7d22 290a 2020 2020 2020 2020  rval}").        
+0001f7a0: 6966 206d 696e 5f64 7420 6973 206e 6f74  if min_dt is not
+0001f7b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001f7c0: 2020 2066 5f72 6563 656e 7420 3d20 6466     f_recent = df
+0001f7d0: 2e69 6e64 6578 203e 206d 696e 5f64 740a  .index > min_dt.
+0001f7e0: 2020 2020 2020 2020 2020 2020 665f 7265              f_re
+0001f7f0: 7061 6972 5f72 6f77 7320 3d20 665f 7265  pair_rows = f_re
+0001f800: 7061 6972 5f72 6f77 7320 2620 665f 7265  pair_rows & f_re
+0001f810: 6365 6e74 0a20 2020 2020 2020 2020 2020  cent.           
+0001f820: 2069 6620 6e6f 7420 665f 7265 7061 6972   if not f_repair
+0001f830: 5f72 6f77 732e 616e 7928 293a 0a20 2020  _rows.any():.   
+0001f840: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001f850: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
+0001f860: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001f870: 2822 2d20 6461 7461 2074 6f6f 206f 6c64  ("- data too old
+0001f880: 2074 6f20 7265 7061 6972 2229 0a20 2020   to repair").   
+0001f890: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001f8a0: 7572 6e20 6466 0a0a 2020 2020 2020 2020  urn df..        
+0001f8b0: 6474 735f 746f 5f72 6570 6169 7220 3d20  dts_to_repair = 
+0001f8c0: 6466 2e69 6e64 6578 5b66 5f72 6570 6169  df.index[f_repai
+0001f8d0: 725f 726f 7773 5d0a 2020 2020 2020 2020  r_rows].        
+0001f8e0: 2320 696e 6469 6365 735f 746f 5f72 6570  # indices_to_rep
+0001f8f0: 6169 7220 3d20 6e70 2e77 6865 7265 2866  air = np.where(f
+0001f900: 5f72 6570 6169 725f 726f 7773 295b 305d  _repair_rows)[0]
+0001f910: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
+0001f920: 2864 7473 5f74 6f5f 7265 7061 6972 2920  (dts_to_repair) 
+0001f930: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0001f940: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
+0001f950: 2020 2020 2064 665f 7632 203d 2064 662e       df_v2 = df.
+0001f960: 636f 7079 2829 0a20 2020 2020 2020 2069  copy().        i
+0001f970: 6620 2252 6570 6169 7265 643f 2220 6e6f  f "Repaired?" no
+0001f980: 7420 696e 2064 665f 7632 2e63 6f6c 756d  t in df_v2.colum
+0001f990: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0001f9a0: 6466 5f76 325b 2252 6570 6169 7265 643f  df_v2["Repaired?
+0001f9b0: 225d 203d 2046 616c 7365 0a20 2020 2020  "] = False.     
+0001f9c0: 2020 2064 665f 676f 6f64 203d 2064 665b     df_good = df[
+0001f9d0: 7e64 665b 7072 6963 655f 636f 6c73 5d2e  ~df[price_cols].
+0001f9e0: 6973 6e61 2829 2e61 6e79 2861 7869 733d  isna().any(axis=
+0001f9f0: 3129 5d0a 2020 2020 2020 2020 665f 7461  1)].        f_ta
+0001fa00: 6720 3d20 6466 5f76 325b 7072 6963 655f  g = df_v2[price_
+0001fa10: 636f 6c73 5d2e 746f 5f6e 756d 7079 2829  cols].to_numpy()
+0001fa20: 203d 3d20 7461 670a 0a20 2020 2020 2020   == tag..       
+0001fa30: 2023 2047 726f 7570 206e 6561 7262 7920   # Group nearby 
+0001fa40: 4e61 4e2d 696e 7465 7276 616c 7320 746f  NaN-intervals to
+0001fa50: 6765 7468 6572 2074 6f20 7265 6475 6365  gether to reduce
+0001fa60: 206e 756d 6265 7220 6f66 2059 6168 6f6f   number of Yahoo
+0001fa70: 2066 6574 6368 6573 0a20 2020 2020 2020   fetches.       
+0001fa80: 2064 7473 5f67 726f 7570 7320 3d20 5b5b   dts_groups = [[
+0001fa90: 6474 735f 746f 5f72 6570 6169 725b 305d  dts_to_repair[0]
+0001faa0: 5d5d 0a20 2020 2020 2020 2023 206c 6173  ]].        # las
+0001fab0: 745f 6474 203d 2064 7473 5f74 6f5f 7265  t_dt = dts_to_re
+0001fac0: 7061 6972 5b30 5d0a 2020 2020 2020 2020  pair[0].        
+0001fad0: 2320 6c61 7374 5f69 6e64 203d 2069 6e64  # last_ind = ind
+0001fae0: 6963 6573 5f74 6f5f 7265 7061 6972 5b30  ices_to_repair[0
+0001faf0: 5d0a 2020 2020 2020 2020 2320 7464 203d  ].        # td =
+0001fb00: 2079 6663 642e 696e 7465 7276 616c 546f   yfcd.intervalTo
+0001fb10: 5469 6d65 6465 6c74 615b 7365 6c66 2e69  Timedelta[self.i
+0001fb20: 6e74 6572 7661 6c5d 0a20 2020 2020 2020  nterval].       
+0001fb30: 2023 2069 6620 7365 6c66 2e69 6e74 6572   # if self.inter
+0001fb40: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+0001fb50: 7276 616c 2e4d 6f6e 7468 7331 3a0a 2020  rval.Months1:.  
+0001fb60: 2020 2020 2020 2320 2020 2020 6772 705f        #     grp_
+0001fb70: 7464 5f74 6872 6573 686f 6c64 203d 2074  td_threshold = t
+0001fb80: 696d 6564 656c 7461 2864 6179 733d 3238  imedelta(days=28
+0001fb90: 290a 2020 2020 2020 2020 2320 656c 6966  ).        # elif
+0001fba0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
+0001fbb0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+0001fbc0: 5765 656b 3a0a 2020 2020 2020 2020 2320  Week:.        # 
+0001fbd0: 2020 2020 6772 705f 7464 5f74 6872 6573      grp_td_thres
+0001fbe0: 686f 6c64 203d 2074 696d 6564 656c 7461  hold = timedelta
+0001fbf0: 2864 6179 733d 3238 290a 2020 2020 2020  (days=28).      
+0001fc00: 2020 2320 656c 6966 2073 656c 662e 696e    # elif self.in
+0001fc10: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001fc20: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
+0001fc30: 2020 2020 2020 2023 2020 2020 2067 7270         #     grp
+0001fc40: 5f74 645f 7468 7265 7368 6f6c 6420 3d20  _td_threshold = 
+0001fc50: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
+0001fc60: 3429 0a20 2020 2020 2020 2023 2065 6c69  4).        # eli
+0001fc70: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+0001fc80: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+0001fc90: 2e48 6f75 7273 313a 0a20 2020 2020 2020  .Hours1:.       
+0001fca0: 2023 2020 2020 2067 7270 5f74 645f 7468   #     grp_td_th
+0001fcb0: 7265 7368 6f6c 6420 3d20 7469 6d65 6465  reshold = timede
+0001fcc0: 6c74 6128 6461 7973 3d37 290a 2020 2020  lta(days=7).    
+0001fcd0: 2020 2020 2320 656c 7365 3a0a 2020 2020      # else:.    
+0001fce0: 2020 2020 2320 2020 2020 6772 705f 7464      #     grp_td
+0001fcf0: 5f74 6872 6573 686f 6c64 203d 2074 696d  _threshold = tim
+0001fd00: 6564 656c 7461 2864 6179 733d 3229 0a20  edelta(days=2). 
+0001fd10: 2020 2020 2020 2023 2020 2020 2023 2067         #     # g
+0001fd20: 7270 5f74 645f 7468 7265 7368 6f6c 6420  rp_td_threshold 
+0001fd30: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
+0001fd40: 3d37 290a 2020 2020 2020 2020 2320 666f  =7).        # fo
+0001fd50: 7220 6920 696e 2072 616e 6765 2831 2c20  r i in range(1, 
+0001fd60: 6c65 6e28 6474 735f 746f 5f72 6570 6169  len(dts_to_repai
+0001fd70: 7229 293a 0a20 2020 2020 2020 2023 2020  r)):.        #  
+0001fd80: 2020 2069 6e64 203d 2069 6e64 6963 6573     ind = indices
+0001fd90: 5f74 6f5f 7265 7061 6972 5b69 5d0a 2020  _to_repair[i].  
+0001fda0: 2020 2020 2020 2320 2020 2020 6474 203d        #     dt =
+0001fdb0: 2064 7473 5f74 6f5f 7265 7061 6972 5b69   dts_to_repair[i
+0001fdc0: 5d0a 2020 2020 2020 2020 2320 2020 2020  ].        #     
+0001fdd0: 6966 2028 6474 2d64 7473 5f67 726f 7570  if (dt-dts_group
+0001fde0: 735b 2d31 5d5b 2d31 5d29 203c 2067 7270  s[-1][-1]) < grp
+0001fdf0: 5f74 645f 7468 7265 7368 6f6c 643a 0a20  _td_threshold:. 
+0001fe00: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0001fe10: 2064 7473 5f67 726f 7570 735b 2d31 5d2e   dts_groups[-1].
+0001fe20: 6170 7065 6e64 2864 7429 0a20 2020 2020  append(dt).     
+0001fe30: 2020 2023 2020 2020 2065 6c69 6620 696e     #     elif in
+0001fe40: 6420 2d20 6c61 7374 5f69 6e64 203c 3d20  d - last_ind <= 
+0001fe50: 333a 0a20 2020 2020 2020 2023 2020 2020  3:.        #    
+0001fe60: 2020 2020 2064 7473 5f67 726f 7570 735b       dts_groups[
+0001fe70: 2d31 5d2e 6170 7065 6e64 2864 7429 0a20  -1].append(dt). 
+0001fe80: 2020 2020 2020 2023 2020 2020 2065 6c73         #     els
+0001fe90: 653a 0a20 2020 2020 2020 2023 2020 2020  e:.        #    
+0001fea0: 2020 2020 2064 7473 5f67 726f 7570 732e       dts_groups.
+0001feb0: 6170 7065 6e64 285b 6474 5d29 0a20 2020  append([dt]).   
+0001fec0: 2020 2020 2023 2020 2020 206c 6173 745f       #     last_
+0001fed0: 6474 203d 2064 740a 2020 2020 2020 2020  dt = dt.        
+0001fee0: 2320 2020 2020 6c61 7374 5f69 6e64 203d  #     last_ind =
+0001fef0: 2069 6e64 0a20 2020 2020 2020 2023 2066   ind.        # f
+0001ff00: 6f72 2069 2069 6e20 7261 6e67 6528 312c  or i in range(1,
+0001ff10: 206c 656e 2864 7473 5f74 6f5f 7265 7061   len(dts_to_repa
+0001ff20: 6972 2929 3a0a 2020 2020 2020 2020 2320  ir)):.        # 
+0001ff30: 2020 2020 696e 6420 3d20 696e 6469 6365      ind = indice
+0001ff40: 735f 746f 5f72 6570 6169 725b 695d 0a20  s_to_repair[i]. 
+0001ff50: 2020 2020 2020 2023 2020 2020 2064 7420         #     dt 
+0001ff60: 3d20 6474 735f 746f 5f72 6570 6169 725b  = dts_to_repair[
+0001ff70: 695d 0a20 2020 2020 2020 2023 2020 2020  i].        #    
+0001ff80: 2069 6620 2864 742d 6474 735f 6772 6f75   if (dt-dts_grou
+0001ff90: 7073 5b2d 315d 5b2d 315d 2920 3c20 6772  ps[-1][-1]) < gr
+0001ffa0: 705f 7464 5f74 6872 6573 686f 6c64 3a0a  p_td_threshold:.
+0001ffb0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0001ffc0: 2020 6474 735f 6772 6f75 7073 5b2d 315d    dts_groups[-1]
+0001ffd0: 2e61 7070 656e 6428 6474 290a 2020 2020  .append(dt).    
+0001ffe0: 2020 2020 2320 2020 2020 656c 6966 2069      #     elif i
+0001fff0: 6e64 202d 206c 6173 745f 696e 6420 3c3d  nd - last_ind <=
+00020000: 2033 3a0a 2020 2020 2020 2020 2320 2020   3:.        #   
+00020010: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
+00020020: 5b2d 315d 2e61 7070 656e 6428 6474 290a  [-1].append(dt).
+00020030: 2020 2020 2020 2020 2320 2020 2020 656c          #     el
+00020040: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
+00020050: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
+00020060: 2e61 7070 656e 6428 5b64 745d 290a 2020  .append([dt]).  
+00020070: 2020 2020 2020 2320 2020 2020 6c61 7374        #     last
+00020080: 5f64 7420 3d20 6474 0a20 2020 2020 2020  _dt = dt.       
+00020090: 2023 2020 2020 206c 6173 745f 696e 6420   #     last_ind 
+000200a0: 3d20 696e 640a 2020 2020 2020 2020 2320  = ind.        # 
+000200b0: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+000200c0: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+000200d0: 6c2e 4d6f 6e74 6873 313a 0a20 2020 2020  l.Months1:.     
+000200e0: 2020 2023 2020 2020 2067 7270 5f6d 6178     #     grp_max
+000200f0: 5f73 697a 6520 3d20 6461 7465 7574 696c  _size = dateutil
+00020100: 2e72 656c 6174 6976 6564 656c 7461 2e72  .relativedelta.r
+00020110: 656c 6174 6976 6564 656c 7461 2879 6561  elativedelta(yea
+00020120: 7273 3d32 290a 2020 2020 2020 2020 2320  rs=2).        # 
+00020130: 656c 6966 2073 656c 662e 696e 7465 7276  elif self.interv
+00020140: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+00020150: 7661 6c2e 5765 656b 3a0a 2020 2020 2020  val.Week:.      
+00020160: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
+00020170: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+00020180: 7661 6c2e 5765 656b 3a0a 2020 2020 2020  val.Week:.      
+00020190: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
+000201a0: 7a65 203d 2064 6174 6575 7469 6c2e 7265  ze = dateutil.re
+000201b0: 6c61 7469 7665 6465 6c74 612e 7265 6c61  lativedelta.rela
+000201c0: 7469 7665 6465 6c74 6128 7965 6172 733d  tivedelta(years=
+000201d0: 3229 0a20 2020 2020 2020 2065 6c69 6620  2).        elif 
+000201e0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+000201f0: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+00020200: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
+00020210: 2020 6772 705f 6d61 785f 7369 7a65 203d    grp_max_size =
+00020220: 2064 6174 6575 7469 6c2e 7265 6c61 7469   dateutil.relati
+00020230: 7665 6465 6c74 612e 7265 6c61 7469 7665  vedelta.relative
+00020240: 6465 6c74 6128 7965 6172 733d 3229 0a20  delta(years=2). 
+00020250: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00020260: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+00020270: 642e 496e 7465 7276 616c 2e48 6f75 7273  d.Interval.Hours
+00020280: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
+00020290: 7270 5f6d 6178 5f73 697a 6520 3d20 6461  rp_max_size = da
+000202a0: 7465 7574 696c 2e72 656c 6174 6976 6564  teutil.relatived
+000202b0: 656c 7461 2e72 656c 6174 6976 6564 656c  elta.relativedel
+000202c0: 7461 2879 6561 7273 3d31 290a 2020 2020  ta(years=1).    
+000202d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000202e0: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
+000202f0: 7a65 203d 2074 696d 6564 656c 7461 2864  ze = timedelta(d
+00020300: 6179 733d 3330 290a 2020 2020 2020 2020  ays=30).        
+00020310: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+00020320: 2020 2020 2020 7072 696e 7428 222d 2067        print("- g
+00020330: 7270 5f6d 6178 5f73 697a 6520 3d22 2c20  rp_max_size =", 
+00020340: 6772 705f 6d61 785f 7369 7a65 290a 2020  grp_max_size).  
+00020350: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+00020360: 616e 6765 2831 2c20 6c65 6e28 6474 735f  ange(1, len(dts_
+00020370: 746f 5f72 6570 6169 7229 293a 0a20 2020  to_repair)):.   
+00020380: 2020 2020 2020 2020 2023 2069 6e64 203d           # ind =
+00020390: 2069 6e64 6963 6573 5f74 6f5f 7265 7061   indices_to_repa
+000203a0: 6972 5b69 5d0a 2020 2020 2020 2020 2020  ir[i].          
+000203b0: 2020 6474 203d 2064 7473 5f74 6f5f 7265    dt = dts_to_re
+000203c0: 7061 6972 5b69 5d0a 2020 2020 2020 2020  pair[i].        
+000203d0: 2020 2020 6966 2064 742e 6461 7465 2829      if dt.date()
+000203e0: 203c 2064 7473 5f67 726f 7570 735b 2d31   < dts_groups[-1
+000203f0: 5d5b 305d 2e64 6174 6528 292b 6772 705f  ][0].date()+grp_
+00020400: 6d61 785f 7369 7a65 3a0a 2020 2020 2020  max_size:.      
+00020410: 2020 2020 2020 2020 2020 6474 735f 6772            dts_gr
+00020420: 6f75 7073 5b2d 315d 2e61 7070 656e 6428  oups[-1].append(
+00020430: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
+00020440: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00020450: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
+00020460: 2e61 7070 656e 6428 5b64 745d 290a 2020  .append([dt]).  
+00020470: 2020 2020 2020 2020 2020 2320 6c61 7374            # last
+00020480: 5f64 7420 3d20 6474 0a20 2020 2020 2020  _dt = dt.       
+00020490: 2020 2020 2023 206c 6173 745f 696e 6420       # last_ind 
+000204a0: 3d20 696e 640a 0a20 2020 2020 2020 2069  = ind..        i
+000204b0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+000204c0: 2020 2020 2070 7269 6e74 2822 5265 7061       print("Repa
+000204d0: 6972 2067 726f 7570 733a 2229 0a20 2020  ir groups:").   
+000204e0: 2020 2020 2020 2020 2066 6f72 2067 2069           for g i
+000204f0: 6e20 6474 735f 6772 6f75 7073 3a0a 2020  n dts_groups:.  
+00020500: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00020510: 696e 7428 6622 2d20 7b67 5b30 5d7d 202d  int(f"- {g[0]} -
+00020520: 3e20 7b67 5b2d 315d 7d22 290a 0a20 2020  > {g[-1]}")..   
+00020530: 2020 2020 2023 2041 6464 2073 6f6d 6520       # Add some 
+00020540: 676f 6f64 2064 6174 6120 746f 2065 6163  good data to eac
+00020550: 6820 6772 6f75 702c 2073 6f20 6361 6e20  h group, so can 
+00020560: 6361 6c69 6272 6174 6520 6c61 7465 723a  calibrate later:
+00020570: 0a20 2020 2020 2020 2023 2066 6f72 2069  .        # for i
+00020580: 2069 6e20 7261 6e67 6528 6c65 6e28 6474   in range(len(dt
+00020590: 735f 6772 6f75 7073 2929 3a0a 2020 2020  s_groups)):.    
+000205a0: 2020 2020 2320 2020 2020 6720 3d20 6474      #     g = dt
+000205b0: 735f 6772 6f75 7073 5b69 5d0a 2020 2020  s_groups[i].    
+000205c0: 2020 2020 2320 2020 2020 6730 203d 2067      #     g0 = g
+000205d0: 5b30 5d0a 2020 2020 2020 2020 2320 2020  [0].        #   
+000205e0: 2020 6930 203d 2064 665f 676f 6f64 2e69    i0 = df_good.i
+000205f0: 6e64 6578 2e67 6574 5f6c 6f63 2867 3029  ndex.get_loc(g0)
+00020600: 0a20 2020 2020 2020 2023 2020 2020 2069  .        #     i
+00020610: 6620 6930 203e 2030 3a0a 2020 2020 2020  f i0 > 0:.      
+00020620: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
+00020630: 6772 6f75 7073 5b69 5d2e 696e 7365 7274  groups[i].insert
+00020640: 2830 2c20 6466 5f67 6f6f 642e 696e 6465  (0, df_good.inde
+00020650: 785b 6930 2d31 5d29 0a20 2020 2020 2020  x[i0-1]).       
+00020660: 2023 2020 2020 2067 6c20 3d20 675b 2d31   #     gl = g[-1
+00020670: 5d0a 2020 2020 2020 2020 2320 2020 2020  ].        #     
+00020680: 696c 203d 2064 665f 676f 6f64 2e69 6e64  il = df_good.ind
+00020690: 6578 2e67 6574 5f6c 6f63 2867 6c29 0a20  ex.get_loc(gl). 
+000206a0: 2020 2020 2020 2023 2020 2020 2069 6620         #     if 
+000206b0: 696c 203c 206c 656e 2864 665f 676f 6f64  il < len(df_good
+000206c0: 292d 313a 0a20 2020 2020 2020 2023 2020  )-1:.        #  
+000206d0: 2020 2020 2020 2064 7473 5f67 726f 7570         dts_group
+000206e0: 735b 695d 2e61 7070 656e 6428 6466 5f67  s[i].append(df_g
+000206f0: 6f6f 642e 696e 6465 785b 696c 2b31 5d29  ood.index[il+1])
+00020700: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+00020710: 6e20 7261 6e67 6528 6c65 6e28 6474 735f  n range(len(dts_
+00020720: 6772 6f75 7073 2929 3a0a 2020 2020 2020  groups)):.      
+00020730: 2020 2020 2020 6720 3d20 6474 735f 6772        g = dts_gr
+00020740: 6f75 7073 5b69 5d0a 2020 2020 2020 2020  oups[i].        
+00020750: 2020 2020 6730 203d 2067 5b30 5d0a 2020      g0 = g[0].  
+00020760: 2020 2020 2020 2020 2020 6930 203d 2064            i0 = d
+00020770: 665f 676f 6f64 2e69 6e64 6578 2e67 6574  f_good.index.get
+00020780: 5f69 6e64 6578 6572 285b 6730 5d2c 206d  _indexer([g0], m
+00020790: 6574 686f 643d 226e 6561 7265 7374 2229  ethod="nearest")
+000207a0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+000207b0: 6966 2069 3020 3e20 303a 0a20 2020 2020  if i0 > 0:.     
+000207c0: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
+000207d0: 696e 5f64 7420 6973 204e 6f6e 6520 6f72  in_dt is None or
+000207e0: 2064 665f 676f 6f64 2e69 6e64 6578 5b69   df_good.index[i
+000207f0: 302d 315d 203e 3d20 6d69 6e5f 6474 2920  0-1] >= min_dt) 
+00020800: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00020810: 2020 2020 2020 616e 6420 2828 6e6f 7420        and ((not 
+00020820: 7365 6c66 2e69 6e74 7261 6461 7929 206f  self.intraday) o
+00020830: 7220 6466 5f67 6f6f 642e 696e 6465 785b  r df_good.index[
+00020840: 6930 2d31 5d2e 6461 7465 2829 203d 3d20  i0-1].date() == 
+00020850: 6730 2e64 6174 6528 2929 3a0a 2020 2020  g0.date()):.    
+00020860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020870: 6930 202d 3d20 310a 2020 2020 2020 2020  i0 -= 1.        
+00020880: 2020 2020 676c 203d 2067 5b2d 315d 0a20      gl = g[-1]. 
+00020890: 2020 2020 2020 2020 2020 2069 6c20 3d20             il = 
+000208a0: 6466 5f67 6f6f 642e 696e 6465 782e 6765  df_good.index.ge
+000208b0: 745f 696e 6465 7865 7228 5b67 6c5d 2c20  t_indexer([gl], 
+000208c0: 6d65 7468 6f64 3d22 6e65 6172 6573 7422  method="nearest"
+000208d0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+000208e0: 2069 6620 696c 203c 206c 656e 2864 665f   if il < len(df_
+000208f0: 676f 6f64 292d 313a 0a20 2020 2020 2020  good)-1:.       
+00020900: 2020 2020 2020 2020 2069 6620 286e 6f74           if (not
+00020910: 2073 656c 662e 696e 7472 6164 6179 2920   self.intraday) 
+00020920: 6f72 2064 665f 676f 6f64 2e69 6e64 6578  or df_good.index
+00020930: 5b69 6c2b 315d 2e64 6174 6528 2920 3d3d  [il+1].date() ==
+00020940: 2067 6c2e 6461 7465 2829 3a0a 2020 2020   gl.date():.    
+00020950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020960: 696c 202b 3d20 310a 2020 2020 2020 2020  il += 1.        
+00020970: 2020 2020 676f 6f64 5f64 7473 203d 2064      good_dts = d
+00020980: 665f 676f 6f64 2e69 6e64 6578 5b69 303a  f_good.index[i0:
+00020990: 696c 2b31 5d0a 2020 2020 2020 2020 2020  il+1].          
+000209a0: 2020 6474 735f 6772 6f75 7073 5b69 5d20    dts_groups[i] 
+000209b0: 2b3d 2067 6f6f 645f 6474 732e 746f 5f6c  += good_dts.to_l
+000209c0: 6973 7428 290a 2020 2020 2020 2020 2020  ist().          
+000209d0: 2020 6474 735f 6772 6f75 7073 5b69 5d2e    dts_groups[i].
+000209e0: 736f 7274 2829 0a0a 2020 2020 2020 2020  sort()..        
+000209f0: 6e5f 6669 7865 6420 3d20 300a 2020 2020  n_fixed = 0.    
+00020a00: 2020 2020 666f 7220 6720 696e 2064 7473      for g in dts
+00020a10: 5f67 726f 7570 733a 0a20 2020 2020 2020  _groups:.       
+00020a20: 2020 2020 2064 665f 626c 6f63 6b20 3d20       df_block = 
+00020a30: 6466 5b64 662e 696e 6465 782e 6973 696e  df[df.index.isin
+00020a40: 2867 295d 0a0a 2020 2020 2020 2020 2020  (g)]..          
+00020a50: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
+00020a60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00020a70: 7428 2264 665f 626c 6f63 6b3a 2229 203b  t("df_block:") ;
+00020a80: 2070 7269 6e74 2864 665f 626c 6f63 6b29   print(df_block)
+00020a90: 0a0a 2020 2020 2020 2020 2020 2020 7374  ..            st
+00020aa0: 6172 745f 6474 203d 2067 5b30 5d0a 2020  art_dt = g[0].  
+00020ab0: 2020 2020 2020 2020 2020 7374 6172 745f            start_
+00020ac0: 6420 3d20 7374 6172 745f 6474 2e64 6174  d = start_dt.dat
+00020ad0: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
+00020ae0: 2069 6620 7375 625f 696e 7465 7276 616c   if sub_interval
+00020af0: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+00020b00: 6c2e 486f 7572 7331 2061 6e64 2028 6461  l.Hours1 and (da
+00020b10: 7465 2e74 6f64 6179 2829 2d73 7461 7274  te.today()-start
+00020b20: 5f64 2920 3e20 7469 6d65 6465 6c74 6128  _d) > timedelta(
+00020b30: 6461 7973 3d37 3239 293a 0a20 2020 2020  days=729):.     
+00020b40: 2020 2020 2020 2020 2020 2023 2044 6f6e             # Don
+00020b50: 2774 2062 6f74 6865 7220 7265 7175 6573  't bother reques
+00020b60: 7469 6e67 206d 6f72 6520 7072 6963 6520  ting more price 
+00020b70: 6461 7461 2c20 5961 686f 6f20 7769 6c6c  data, Yahoo will
+00020b80: 2072 656a 6563 740a 2020 2020 2020 2020   reject.        
+00020b90: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00020ba0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00020bb0: 6620 7375 625f 696e 7465 7276 616c 2069  f sub_interval i
+00020bc0: 6e20 5b79 6663 642e 496e 7465 7276 616c  n [yfcd.Interval
+00020bd0: 2e4d 696e 7333 302c 2079 6663 642e 496e  .Mins30, yfcd.In
+00020be0: 7465 7276 616c 2e4d 696e 7331 355d 2061  terval.Mins15] a
+00020bf0: 6e64 2028 6461 7465 2e74 6f64 6179 2829  nd (date.today()
+00020c00: 2d73 7461 7274 5f64 2920 3e20 7469 6d65  -start_d) > time
+00020c10: 6465 6c74 6128 6461 7973 3d35 3929 3a0a  delta(days=59):.
+00020c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c30: 2320 446f 6e27 7420 626f 7468 6572 2072  # Don't bother r
+00020c40: 6571 7565 7374 696e 6720 6d6f 7265 2070  equesting more p
+00020c50: 7269 6365 2064 6174 612c 2059 6168 6f6f  rice data, Yahoo
+00020c60: 2077 696c 6c20 7265 6a65 6374 0a20 2020   will reject.   
+00020c70: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00020c80: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+00020c90: 2020 2069 6620 7365 6c66 2e5f 7265 636f     if self._reco
+00020ca0: 7264 5f73 7461 636b 5f74 7261 6365 3a0a  rd_stack_trace:.
+00020cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cc0: 2320 4c6f 6720 6675 6e63 7469 6f6e 2063  # Log function c
+00020cd0: 616c 6c73 2074 6f20 6465 7465 6374 2061  alls to detect a
+00020ce0: 6e64 206d 616e 6167 6520 696e 6669 6e69  nd manage infini
+00020cf0: 7465 2072 6563 7572 7369 6f6e 0a20 2020  te recursion.   
+00020d00: 2020 2020 2020 2020 2020 2020 2066 6e5f               fn_
+00020d10: 7475 706c 6520 3d20 2822 5f72 6563 6f6e  tuple = ("_recon
+00020d20: 7374 7275 6374 5f69 6e74 6572 7661 6c73  struct_intervals
+00020d30: 5f62 6174 6368 2829 222c 2066 2264 7430  _batch()", f"dt0
+00020d40: 3d7b 6466 2e69 6e64 6578 5b30 5d7d 222c  ={df.index[0]}",
+00020d50: 2066 2269 6e74 6572 7661 6c3d 7b73 656c   f"interval={sel
+00020d60: 662e 696e 7465 7276 616c 7d22 290a 2020  f.interval}").  
+00020d70: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00020d80: 2066 6e5f 7475 706c 6520 696e 2073 656c   fn_tuple in sel
+00020d90: 662e 5f73 7461 636b 5f74 7261 6365 3a0a  f._stack_trace:.
+00020da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020db0: 2020 2020 2320 4465 7465 6374 6564 2061      # Detected a
+00020dc0: 2070 6f74 656e 7469 616c 2072 6563 7572   potential recur
+00020dd0: 7369 6f6e 206c 6f6f 700a 2020 2020 2020  sion loop.      
+00020de0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00020df0: 636f 6e73 7472 7563 745f 6465 7465 6374  construct_detect
+00020e00: 6564 203d 2046 616c 7365 0a20 2020 2020  ed = False.     
+00020e10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020e20: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00020e30: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
+00020e40: 6163 6529 2d31 2c20 2d31 2c20 2d31 293a  ace)-1, -1, -1):
+00020e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020e60: 2020 2020 2020 2020 2069 6620 225f 7265           if "_re
+00020e70: 636f 6e73 7472 7563 745f 696e 7465 7276  construct_interv
+00020e80: 616c 735f 6261 7463 6822 2069 6e20 7374  als_batch" in st
+00020e90: 7228 7365 6c66 2e5f 7374 6163 6b5f 7472  r(self._stack_tr
+00020ea0: 6163 655b 695d 293a 0a20 2020 2020 2020  ace[i]):.       
+00020eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ec0: 2020 2020 2072 6563 6f6e 7374 7275 6374       reconstruct
+00020ed0: 5f64 6574 6563 7465 6420 3d20 5472 7565  _detected = True
+00020ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ef0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00020f00: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
+00020f10: 2020 2020 2020 2069 6620 7265 636f 6e73         if recons
+00020f20: 7472 7563 745f 6465 7465 6374 6564 3a0a  truct_detected:.
+00020f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f40: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00020f50: 6669 6e69 7465 5f72 6563 7572 7369 6f6e  finite_recursion
+00020f60: 5f64 6574 6563 7465 6420 3d20 5472 7565  _detected = True
+00020f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020f80: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+00020f90: 6365 2e61 7070 656e 6428 666e 5f74 7570  ce.append(fn_tup
+00020fa0: 6c65 290a 0a20 2020 2020 2020 2020 2020  le)..           
+00020fb0: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+00020fc0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00020fd0: 2020 206c 6f67 5f6d 7367 203d 2066 2272     log_msg = f"r
+00020fe0: 6570 6169 7269 6e67 207b 7365 6c66 2e69  epairing {self.i
+00020ff0: 7374 727d 2062 6c6f 636b 207b 675b 305d  str} block {g[0]
+00021000: 2e64 6174 6528 297d 202d 3e20 7b67 5b2d  .date()} -> {g[-
+00021010: 315d 2e64 6174 6528 292b 7469 6d65 6465  1].date()+timede
+00021020: 6c74 6128 6461 7973 3d31 297d 220a 2020  lta(days=1)}".  
+00021030: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00021040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021050: 6c6f 675f 6d73 6720 3d20 6622 7265 7061  log_msg = f"repa
+00021060: 6972 696e 6720 7b73 656c 662e 6973 7472  iring {self.istr
+00021070: 7d20 626c 6f63 6b20 7b67 5b30 5d7d 202d  } block {g[0]} -
+00021080: 3e20 7b67 5b2d 315d 7d22 0a20 2020 2020  > {g[-1]}".     
+00021090: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
+000210a0: 6765 722e 4c6f 6745 7665 6e74 2822 696e  ger.LogEvent("in
+000210b0: 666f 222c 2022 5072 6963 654d 616e 6167  fo", "PriceManag
+000210c0: 6572 222c 206c 6f67 5f6d 7367 290a 0a20  er", log_msg).. 
+000210d0: 2020 2020 2020 2020 2020 2023 2049 6e66             # Inf
+000210e0: 696e 6974 6520 6c6f 6f70 2070 6f74 656e  inite loop poten
+000210f0: 7469 616c 2068 6572 6520 7669 6120 7265  tial here via re
+00021100: 7061 6972 3a0a 2020 2020 2020 2020 2020  pair:.          
+00021110: 2020 2320 2d20 7265 7175 6573 7420 6669    # - request fi
+00021120: 6e65 2d67 7261 696e 6564 2064 6174 6120  ne-grained data 
+00021130: 652e 672e 2031 480a 2020 2020 2020 2020  e.g. 1H.        
+00021140: 2020 2020 2320 2d20 3148 2072 6571 7569      # - 1H requi
+00021150: 7265 7320 6163 6375 7261 7465 2064 6976  res accurate div
+00021160: 6964 656e 6420 6461 7461 0a20 2020 2020  idend data.     
+00021170: 2020 2020 2020 2023 202d 2074 7269 6767         # - trigg
+00021180: 6572 7320 6665 7463 6820 6f66 2031 4420  ers fetch of 1D 
+00021190: 6461 7461 2077 6869 6368 206d 7573 7420  data which must 
+000211a0: 6265 206b 6570 7420 636f 6e74 6967 756f  be kept contiguo
+000211b0: 7573 0a20 2020 2020 2020 2020 2020 2023  us.            #
+000211c0: 202d 2074 7269 6767 6572 7320 6665 7463   - triggers fetc
+000211d0: 6820 6f66 206f 6c64 6572 2031 4420 6461  h of older 1D da
+000211e0: 7461 2077 6869 6368 2072 6571 7569 7265  ta which require
+000211f0: 7320 7265 7061 6972 2075 7369 6e67 2031  s repair using 1
+00021200: 4820 6461 7461 202d 3e20 7265 6375 7273  H data -> recurs
+00021210: 696f 6e20 6c6f 6f70 0a20 2020 2020 2020  ion loop.       
+00021220: 2020 2020 2023 2053 6f6c 7574 696f 6e3a       # Solution:
+00021230: 0a20 2020 2020 2020 2020 2020 2023 2031  .            # 1
+00021240: 2920 6164 6420 7475 706c 6520 746f 2066  ) add tuple to f
+00021250: 6e20 7374 6163 6b20 6275 7920 7769 7468  n stack buy with
+00021260: 2059 463d 5472 7565 0a20 2020 2020 2020   YF=True.       
+00021270: 2020 2020 2023 2032 2920 6966 2074 6861       # 2) if tha
+00021280: 7420 7475 706c 6520 616c 7265 6164 7920  t tuple already 
+00021290: 696e 2073 7461 636b 2074 6865 6e20 7261  in stack then ra
+000212a0: 6973 6520 4578 6365 7074 696f 6e0a 2020  ise Exception.  
+000212b0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000212c0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+000212d0: 6364 2e49 6e74 6572 7661 6c2e 5765 656b  cd.Interval.Week
+000212e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000212f0: 2020 6665 7463 685f 7374 6172 7420 3d20    fetch_start = 
+00021300: 7374 6172 745f 6420 2d20 7464 5f72 616e  start_d - td_ran
+00021310: 6765 2020 2320 6e65 6564 2070 7265 7669  ge  # need previ
+00021320: 6f75 7320 7765 656b 2074 6f6f 0a20 2020  ous week too.   
+00021330: 2020 2020 2020 2020 2020 2020 2066 6574               fet
+00021340: 6368 5f65 6e64 203d 2067 5b2d 315d 2e64  ch_end = g[-1].d
+00021350: 6174 6528 2920 2b20 7464 5f72 616e 6765  ate() + td_range
+00021360: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00021370: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+00021380: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+00021390: 2e44 6179 7331 3a0a 2020 2020 2020 2020  .Days1:.        
+000213a0: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+000213b0: 6172 7420 3d20 7374 6172 745f 640a 2020  art = start_d.  
+000213c0: 2020 2020 2020 2020 2020 2020 2020 6665                fe
+000213d0: 7463 685f 656e 6420 3d20 675b 2d31 5d2e  tch_end = g[-1].
+000213e0: 6461 7465 2829 202b 2074 645f 7261 6e67  date() + td_rang
+000213f0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+00021400: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00021410: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
+00021420: 3d20 675b 305d 0a20 2020 2020 2020 2020  = g[0].         
+00021430: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
+00021440: 203d 2067 5b2d 315d 202b 2074 645f 7261   = g[-1] + td_ra
+00021450: 6e67 650a 2020 2020 2020 2020 2020 2020  nge.            
+00021460: 2320 7072 696e 7428 6622 6665 7463 685f  # print(f"fetch_
+00021470: 7374 6172 743d 7b66 6574 6368 5f73 7461  start={fetch_sta
+00021480: 7274 7d20 6665 7463 685f 656e 643d 7b66  rt} fetch_end={f
+00021490: 6574 6368 5f65 6e64 7d22 290a 0a20 2020  etch_end}")..   
+000214a0: 2020 2020 2020 2020 2023 2070 7265 706f           # prepo
+000214b0: 7374 203d 2073 656c 662e 696e 7465 7276  st = self.interv
+000214c0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+000214d0: 7661 6c2e 4461 7973 310a 2020 2020 2020  val.Days1.      
+000214e0: 2020 2020 2020 7072 6570 6f73 7420 3d20        prepost = 
+000214f0: 7365 6c66 2e69 6e74 6572 6461 790a 2020  self.interday.  
+00021500: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00021510: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
+00021520: 2020 2020 7072 696e 7428 6622 2d20 6665      print(f"- fe
+00021530: 7463 685f 7374 6172 743d 7b66 6574 6368  tch_start={fetch
+00021540: 5f73 7461 7274 7d2c 2066 6574 6368 5f65  _start}, fetch_e
+00021550: 6e64 3d7b 6665 7463 685f 656e 647d 2070  nd={fetch_end} p
+00021560: 7265 706f 7374 3d7b 7072 6570 6f73 747d  repost={prepost}
+00021570: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
+00021580: 6620 7365 6c66 2e5f 696e 6669 6e69 7465  f self._infinite
+00021590: 5f72 6563 7572 7369 6f6e 5f64 6574 6563  _recursion_detec
+000215a0: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+000215b0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+000215c0: 6e67 6528 6c65 6e28 7365 6c66 2e5f 7374  nge(len(self._st
+000215d0: 6163 6b5f 7472 6163 6529 293a 0a20 2020  ack_trace)):.   
+000215e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215f0: 2070 7269 6e74 2822 2020 222a 6920 2b20   print("  "*i + 
+00021600: 7374 7228 7365 6c66 2e5f 7374 6163 6b5f  str(self._stack_
+00021610: 7472 6163 655b 695d 2929 0a20 2020 2020  trace[i])).     
+00021620: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00021630: 2045 7863 6570 7469 6f6e 2822 5741 524e   Exception("WARN
+00021640: 494e 473a 2049 6e66 696e 6974 6520 7265  ING: Infinite re
+00021650: 6375 7273 696f 6e20 6465 7465 6374 6564  cursion detected
+00021660: 2028 7365 6520 7374 6163 6b20 7472 6163   (see stack trac
+00021670: 6520 6162 6f76 6529 2e20 5377 6974 6368  e above). Switch
+00021680: 2074 6f20 6665 7463 6869 6e67 2070 7269   to fetching pri
+00021690: 6365 7320 6469 7265 6374 2066 726f 6d20  ces direct from 
+000216a0: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
+000216b0: 2020 2020 2070 7269 6e74 2822 5741 524e       print("WARN
+000216c0: 494e 473a 2049 6e66 696e 6974 6520 7265  ING: Infinite re
+000216d0: 6375 7273 696f 6e20 6465 7465 6374 6564  cursion detected
+000216e0: 2028 7365 6520 7374 6163 6b20 7472 6163   (see stack trac
+000216f0: 6520 6162 6f76 6529 2e20 5377 6974 6368  e above). Switch
+00021700: 2074 6f20 6665 7463 6869 6e67 2070 7269   to fetching pri
+00021710: 6365 7320 6469 7265 6374 2066 726f 6d20  ces direct from 
+00021720: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
+00021730: 2020 2020 2023 2064 665f 6669 6e65 203d       # df_fine =
+00021740: 2073 656c 662e 6461 742e 6869 7374 6f72   self.dat.histor
+00021750: 7928 7374 6172 743d 6665 7463 685f 7374  y(start=fetch_st
+00021760: 6172 742c 2065 6e64 3d66 6574 6368 5f65  art, end=fetch_e
+00021770: 6e64 2c20 696e 7465 7276 616c 3d79 6663  nd, interval=yfc
+00021780: 642e 696e 7465 7276 616c 546f 5374 7269  d.intervalToStri
+00021790: 6e67 5b73 7562 5f69 6e74 6572 7661 6c5d  ng[sub_interval]
+000217a0: 2c20 6175 746f 5f61 646a 7573 743d 4661  , auto_adjust=Fa
+000217b0: 6c73 652c 2070 7265 706f 7374 3d70 7265  lse, prepost=pre
+000217c0: 706f 7374 2c20 6b65 6570 6e61 3d54 7275  post, keepna=Tru
+000217d0: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
+000217e0: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
+000217f0: 7661 6c20 696e 205b 7966 6364 2e49 6e74  val in [yfcd.Int
+00021800: 6572 7661 6c2e 4461 7973 315d 3a20 2023  erval.Days1]:  #
+00021810: 206f 7220 7365 6c66 2e5f 696e 6669 6e69   or self._infini
+00021820: 7465 5f72 6563 7572 7369 6f6e 5f64 6574  te_recursion_det
+00021830: 6563 7465 643a 0a20 2020 2020 2020 2020  ected:.         
+00021840: 2020 2023 2020 2020 2023 2041 7373 756d     #     # Assum
+00021850: 6520 696e 6669 6e69 7465 2072 6563 7572  e infinite recur
+00021860: 7369 6f6e 2077 696c 6c20 6861 7070 656e  sion will happen
+00021870: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00021880: 2020 2064 665f 6669 6e65 203d 2073 656c     df_fine = sel
+00021890: 662e 6461 742e 6869 7374 6f72 7928 7374  f.dat.history(st
+000218a0: 6172 743d 6665 7463 685f 7374 6172 742c  art=fetch_start,
+000218b0: 2065 6e64 3d66 6574 6368 5f65 6e64 2c20   end=fetch_end, 
+000218c0: 696e 7465 7276 616c 3d79 6663 642e 696e  interval=yfcd.in
+000218d0: 7465 7276 616c 546f 5374 7269 6e67 5b73  tervalToString[s
+000218e0: 7562 5f69 6e74 6572 7661 6c5d 2c20 6175  ub_interval], au
+000218f0: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
+00021900: 2072 6570 6169 723d 5472 7565 290a 2020   repair=True).  
+00021910: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00021920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021930: 6966 2070 7265 706f 7374 2061 6e64 2073  if prepost and s
+00021940: 7562 5f69 6e74 7261 6461 793a 0a20 2020  ub_intraday:.   
+00021950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021960: 2023 2059 4643 2063 616e 6e6f 7420 6861   # YFC cannot ha
+00021970: 6e64 6c65 2069 6e74 7261 6461 7920 7072  ndle intraday pr
+00021980: 652d 2061 6e64 2070 6f73 742d 6d61 726b  e- and post-mark
+00021990: 6574 2c20 736f 2066 6574 6368 2076 6961  et, so fetch via
+000219a0: 2079 6669 6e61 6e63 650a 2020 2020 2020   yfinance.      
+000219b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000219c0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219e0: 2320 7072 696e 7428 222d 2066 6574 6368  # print("- fetch
+000219f0: 696e 6720 6466 5f66 696e 6520 6469 7265  ing df_fine dire
+00021a00: 6374 2066 726f 6d20 5946 2229 0a20 2020  ct from YF").   
+00021a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a20: 2020 2020 2070 7269 6e74 2866 222d 202d       print(f"- -
+00021a30: 2066 6574 6368 5f73 7461 7274 3d7b 6665   fetch_start={fe
+00021a40: 7463 685f 7374 6172 747d 2066 6574 6368  tch_start} fetch
+00021a50: 5f65 6e64 3d7b 6665 7463 685f 656e 647d  _end={fetch_end}
+00021a60: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00021a70: 2020 2020 2020 2064 665f 6669 6e65 5f6f         df_fine_o
+00021a80: 6c64 203d 2073 656c 662e 6461 742e 6869  ld = self.dat.hi
+00021a90: 7374 6f72 7928 7374 6172 743d 6665 7463  story(start=fetc
+00021aa0: 685f 7374 6172 742c 2065 6e64 3d66 6574  h_start, end=fet
+00021ab0: 6368 5f65 6e64 2c20 696e 7465 7276 616c  ch_end, interval
+00021ac0: 3d79 6663 642e 696e 7465 7276 616c 546f  =yfcd.intervalTo
+00021ad0: 5374 7269 6e67 5b73 7562 5f69 6e74 6572  String[sub_inter
+00021ae0: 7661 6c5d 2c20 6175 746f 5f61 646a 7573  val], auto_adjus
+00021af0: 743d 5472 7565 2c20 7072 6570 6f73 743d  t=True, prepost=
+00021b00: 7072 6570 6f73 7429 0a20 2020 2020 2020  prepost).       
+00021b10: 2020 2020 2020 2020 2020 2020 2068 6973               his
+00021b20: 745f 7375 6220 3d20 7365 6c66 2e6d 616e  t_sub = self.man
+00021b30: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
+00021b40: 7375 625f 696e 7465 7276 616c 290a 2020  sub_interval).  
+00021b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b60: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00021b70: 6e63 6528 6665 7463 685f 7374 6172 742c  nce(fetch_start,
+00021b80: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
+00021b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ba0: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
+00021bb0: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+00021bc0: 6e65 2866 6574 6368 5f73 7461 7274 2c20  ne(fetch_start, 
+00021bd0: 7469 6d65 2830 292c 205a 6f6e 6549 6e66  time(0), ZoneInf
+00021be0: 6f28 7365 6c66 2e74 7a4e 616d 6529 290a  o(self.tzName)).
+00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c00: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00021c10: 7461 6e63 6528 6665 7463 685f 656e 642c  tance(fetch_end,
+00021c20: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
+00021c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c40: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
+00021c50: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
+00021c60: 2866 6574 6368 5f65 6e64 2c20 7469 6d65  (fetch_end, time
+00021c70: 2830 292c 205a 6f6e 6549 6e66 6f28 7365  (0), ZoneInfo(se
+00021c80: 6c66 2e74 7a4e 616d 6529 290a 2020 2020  lf.tzName)).    
+00021c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ca0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+00021cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021cc0: 2020 7072 696e 7428 222d 2066 6574 6368    print("- fetch
+00021cd0: 696e 6720 6466 5f66 696e 6520 7669 6120  ing df_fine via 
+00021ce0: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
+00021cf0: 2920 7772 6170 7065 7222 290a 2020 2020  ) wrapper").    
+00021d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d10: 2020 2020 7072 696e 7428 6622 2d20 2d20      print(f"- - 
+00021d20: 6665 7463 685f 7374 6172 743d 7b66 6574  fetch_start={fet
+00021d30: 6368 5f73 7461 7274 7d20 6665 7463 685f  ch_start} fetch_
+00021d40: 656e 643d 7b66 6574 6368 5f65 6e64 7d22  end={fetch_end}"
+00021d50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00021d60: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d80: 2020 2064 665f 6669 6e65 203d 2068 6973     df_fine = his
+00021d90: 745f 7375 622e 5f66 6574 6368 5966 4869  t_sub._fetchYfHi
+00021da0: 7374 6f72 7928 7374 6172 743d 6665 7463  story(start=fetc
+00021db0: 685f 7374 6172 742c 2065 6e64 3d66 6574  h_start, end=fet
+00021dc0: 6368 5f65 6e64 2c20 7072 6570 6f73 743d  ch_end, prepost=
+00021dd0: 7072 6570 6f73 742c 2064 6562 7567 3d46  prepost, debug=F
+00021de0: 616c 7365 2c20 7665 7269 6679 5f69 6e74  alse, verify_int
+00021df0: 6572 7661 6c73 3d46 616c 7365 2c20 6469  ervals=False, di
+00021e00: 7361 626c 655f 7966 635f 6d65 7461 6461  sable_yfc_metada
+00021e10: 7461 3d54 7275 6529 0a20 2020 2020 2020  ta=True).       
+00021e20: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00021e30: 6570 7420 7966 6364 2e4e 6f50 7269 6365  ept yfcd.NoPrice
+00021e40: 4461 7461 496e 5261 6e67 6545 7863 6570  DataInRangeExcep
+00021e50: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00021e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e70: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
+00021e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e90: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00021ea0: 2d20 6665 7463 6820 6f66 2066 696e 6520  - fetch of fine 
+00021eb0: 7072 6963 6520 6461 7461 2066 6169 6c65  price data faile
+00021ec0: 643a 2220 2b20 7374 7228 6529 290a 2020  d:" + str(e)).  
+00021ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ee0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00021ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f00: 2020 2069 6620 6466 5f66 696e 6520 6973     if df_fine is
+00021f10: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00021f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f30: 2020 2061 646a 203d 2028 6466 5f66 696e     adj = (df_fin
+00021f40: 655b 2241 646a 2043 6c6f 7365 225d 2f64  e["Adj Close"]/d
+00021f50: 665f 6669 6e65 5b22 436c 6f73 6522 5d29  f_fine["Close"])
+00021f60: 2e74 6f5f 6e75 6d70 7928 290a 2020 2020  .to_numpy().    
+00021f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f80: 2020 2020 666f 7220 6320 696e 205b 224f      for c in ["O
+00021f90: 7065 6e22 2c20 224c 6f77 222c 2022 4869  pen", "Low", "Hi
+00021fa0: 6768 222c 2022 436c 6f73 6522 5d3a 0a20  gh", "Close"]:. 
+00021fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021fc0: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
+00021fd0: 6e65 5b63 5d20 2a3d 2061 646a 0a20 2020  ne[c] *= adj.   
+00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ff0: 2020 2020 2064 665f 6669 6e65 203d 2064       df_fine = d
+00022000: 665f 6669 6e65 5b5b 224f 7065 6e22 2c20  f_fine[["Open", 
+00022010: 224c 6f77 222c 2022 4869 6768 222c 2022  "Low", "High", "
+00022020: 436c 6f73 6522 2c20 2256 6f6c 756d 6522  Close", "Volume"
+00022030: 2c20 2244 6976 6964 656e 6473 222c 2022  , "Dividends", "
+00022040: 5374 6f63 6b20 5370 6c69 7473 225d 5d0a  Stock Splits"]].
+00022050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022060: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+00022070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022080: 2020 2020 2020 7072 696e 7428 2264 665f        print("df_
+00022090: 6669 6e65 5f6f 6c64 3a22 290a 2020 2020  fine_old:").    
+000220a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220b0: 2020 2020 7072 696e 7428 6466 5f66 696e      print(df_fin
+000220c0: 655f 6f6c 6429 0a20 2020 2020 2020 2020  e_old).         
+000220d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000220e0: 7269 6e74 2822 6466 5f66 696e 653a 2229  rint("df_fine:")
+000220f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022100: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
+00022110: 665f 6669 6e65 290a 2020 2020 2020 2020  f_fine).        
+00022120: 2020 2020 2020 2020 2020 2020 2320 7261              # ra
+00022130: 6973 6520 4578 6365 7074 696f 6e28 2268  ise Exception("h
+00022140: 6572 6522 290a 2020 2020 2020 2020 2020  ere").          
+00022150: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00022160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022170: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+00022180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022190: 2020 7072 696e 7428 222d 2066 6574 6368    print("- fetch
+000221a0: 696e 6720 6466 5f66 696e 6520 7669 6120  ing df_fine via 
+000221b0: 5946 4322 290a 2020 2020 2020 2020 2020  YFC").          
+000221c0: 2020 2020 2020 2020 2020 6869 7374 5f73            hist_s
+000221d0: 7562 203d 2073 656c 662e 6d61 6e61 6765  ub = self.manage
+000221e0: 722e 4765 7448 6973 746f 7279 2873 7562  r.GetHistory(sub
+000221f0: 5f69 6e74 6572 7661 6c29 0a20 2020 2020  _interval).     
+00022200: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00022210: 665f 6669 6e65 203d 2068 6973 745f 7375  f_fine = hist_su
+00022220: 622e 6765 7428 6665 7463 685f 7374 6172  b.get(fetch_star
+00022230: 742c 2066 6574 6368 5f65 6e64 2c20 6164  t, fetch_end, ad
+00022240: 6a75 7374 5f73 706c 6974 733d 4661 6c73  just_splits=Fals
+00022250: 652c 2061 646a 7573 745f 6469 7673 3d46  e, adjust_divs=F
+00022260: 616c 7365 2c20 7265 7061 6972 3d46 616c  alse, repair=Fal
+00022270: 7365 2c20 7072 6570 6f73 743d 7072 6570  se, prepost=prep
+00022280: 6f73 7429 0a20 2020 2020 2020 2020 2020  ost).           
+00022290: 2020 2020 2023 2064 665f 6669 6e65 5b22       # df_fine["
+000222a0: 4164 6a20 436c 6f73 6522 5d20 3d20 6466  Adj Close"] = df
+000222b0: 5f66 696e 655b 2243 6c6f 7365 225d 202a  _fine["Close"] *
+000222c0: 2064 665f 6669 6e65 5b22 4344 4622 5d0a   df_fine["CDF"].
+000222d0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+000222e0: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+000222f0: 2020 2020 2020 7072 696e 7428 222d 2064        print("- d
+00022300: 665f 6669 6e65 3a22 290a 2020 2020 2020  f_fine:").      
+00022310: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00022320: 6466 5f66 696e 6529 0a20 2020 2020 2020  df_fine).       
+00022330: 2020 2020 2069 6620 6466 5f66 696e 6520       if df_fine 
+00022340: 6973 204e 6f6e 6520 6f72 206c 656e 2864  is None or len(d
+00022350: 665f 6669 6e65 2920 3d3d 2030 3a0a 2020  f_fine) == 0:.  
+00022360: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00022370: 696e 7428 2259 463a 2057 4152 4e49 4e47  int("YF: WARNING
+00022380: 3a20 4361 6e6e 6f74 2072 6563 6f6e 7374  : Cannot reconst
+00022390: 7275 6374 2062 6563 6175 7365 2059 6168  ruct because Yah
+000223a0: 6f6f 206e 6f74 2072 6574 7572 6e69 6e67  oo not returning
+000223b0: 2064 6174 6120 696e 2069 6e74 6572 7661   data in interva
+000223c0: 6c22 290a 2020 2020 2020 2020 2020 2020  l").            
+000223d0: 2020 2020 6966 2073 656c 662e 5f72 6563      if self._rec
+000223e0: 6f72 645f 7374 6163 6b5f 7472 6163 653a  ord_stack_trace:
+000223f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022400: 2020 2020 2023 2050 6f70 2073 7461 636b       # Pop stack
+00022410: 2074 7261 6365 0a20 2020 2020 2020 2020   trace.         
+00022420: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00022430: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
+00022440: 6163 6529 203d 3d20 303a 0a20 2020 2020  ace) == 0:.     
+00022450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022460: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+00022470: 6f6e 2822 4661 696c 696e 6720 746f 2063  on("Failing to c
+00022480: 6f72 7265 6374 6c79 2070 7573 682f 706f  orrectly push/po
+00022490: 7020 7374 6163 6b20 7472 6163 6520 2869  p stack trace (i
+000224a0: 7320 656d 7074 7920 746f 6f20 6561 726c  s empty too earl
+000224b0: 7929 2229 0a20 2020 2020 2020 2020 2020  y)").           
+000224c0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000224d0: 7365 6c66 2e5f 7374 6163 6b5f 7472 6163  self._stack_trac
+000224e0: 655b 2d31 5d20 3d3d 2066 6e5f 7475 706c  e[-1] == fn_tupl
+000224f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00022500: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00022510: 2069 6e20 7261 6e67 6528 6c65 6e28 7365   in range(len(se
+00022520: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
+00022530: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00022540: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00022550: 7269 6e74 2822 2020 222a 6920 2b20 7374  rint("  "*i + st
+00022560: 7228 7365 6c66 2e5f 7374 6163 6b5f 7472  r(self._stack_tr
+00022570: 6163 655b 695d 2929 0a20 2020 2020 2020  ace[i])).       
+00022580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022590: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+000225a0: 2822 4661 696c 696e 6720 746f 2063 6f72  ("Failing to cor
+000225b0: 7265 6374 6c79 2070 7573 682f 706f 7020  rectly push/pop 
+000225c0: 7374 6163 6b20 7472 6163 6520 2873 6565  stack trace (see
+000225d0: 2061 626f 7665 2922 290a 2020 2020 2020   above)").      
+000225e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000225f0: 6c66 2e5f 7374 6163 6b5f 7472 6163 652e  lf._stack_trace.
+00022600: 706f 7028 6c65 6e28 7365 6c66 2e5f 7374  pop(len(self._st
+00022610: 6163 6b5f 7472 6163 6529 202d 2031 290a  ack_trace) - 1).
+00022620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022630: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00022640: 2020 2020 2020 6466 5f66 696e 655b 2263        df_fine["c
+00022650: 7472 225d 203d 2030 0a20 2020 2020 2020  tr"] = 0.       
+00022660: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00022670: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+00022680: 7465 7276 616c 2e57 6565 6b3a 0a20 2020  terval.Week:.   
+00022690: 2020 2020 2020 2020 2020 2020 2023 2064               # d
+000226a0: 665f 6669 6e65 5b22 5765 656b 2053 7461  f_fine["Week Sta
+000226b0: 7274 225d 203d 2064 665f 6669 6e65 2e69  rt"] = df_fine.i
+000226c0: 6e64 6578 2e74 7a5f 6c6f 6361 6c69 7a65  ndex.tz_localize
+000226d0: 284e 6f6e 6529 2e74 6f5f 7065 7269 6f64  (None).to_period
+000226e0: 2822 572d 5355 4e22 292e 7374 6172 745f  ("W-SUN").start_
+000226f0: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+00022700: 2020 2020 2077 6565 6b64 6179 7320 3d20       weekdays = 
+00022710: 5b22 4d4f 4e22 2c20 2254 5545 222c 2022  ["MON", "TUE", "
+00022720: 5745 4422 2c20 2254 4855 222c 2022 4652  WED", "THU", "FR
+00022730: 4922 2c20 2253 4154 222c 2022 5355 4e22  I", "SAT", "SUN"
+00022740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00022750: 2020 7765 656b 5f65 6e64 5f64 6179 203d    week_end_day =
+00022760: 2077 6565 6b64 6179 735b 2864 665f 626c   weekdays[(df_bl
+00022770: 6f63 6b2e 696e 6465 785b 305d 2e77 6565  ock.index[0].wee
+00022780: 6b64 6179 2829 202b 2037 202d 2031 2920  kday() + 7 - 1) 
+00022790: 2520 375d 0a20 2020 2020 2020 2020 2020  % 7].           
+000227a0: 2020 2020 2064 665f 6669 6e65 5b22 5765       df_fine["We
+000227b0: 656b 2053 7461 7274 225d 203d 2064 665f  ek Start"] = df_
+000227c0: 6669 6e65 2e69 6e64 6578 2e74 7a5f 6c6f  fine.index.tz_lo
+000227d0: 6361 6c69 7a65 284e 6f6e 6529 2e74 6f5f  calize(None).to_
+000227e0: 7065 7269 6f64 2822 572d 222b 7765 656b  period("W-"+week
+000227f0: 5f65 6e64 5f64 6179 292e 7374 6172 745f  _end_day).start_
+00022800: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+00022810: 2020 2020 2067 7270 5f63 6f6c 203d 2022       grp_col = "
+00022820: 5765 656b 2053 7461 7274 220a 2020 2020  Week Start".    
+00022830: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+00022840: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+00022850: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
+00022860: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00022870: 2020 2064 665f 6669 6e65 5b22 4461 7920     df_fine["Day 
+00022880: 5374 6172 7422 5d20 3d20 7064 2e74 6f5f  Start"] = pd.to_
+00022890: 6461 7465 7469 6d65 2864 665f 6669 6e65  datetime(df_fine
+000228a0: 2e69 6e64 6578 2e64 6174 6529 0a20 2020  .index.date).   
+000228b0: 2020 2020 2020 2020 2020 2020 2067 7270               grp
+000228c0: 5f63 6f6c 203d 2022 4461 7920 5374 6172  _col = "Day Star
+000228d0: 7422 0a20 2020 2020 2020 2020 2020 2065  t".            e
+000228e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000228f0: 2020 2020 2064 665f 6669 6e65 2e6c 6f63       df_fine.loc
+00022900: 5b64 665f 6669 6e65 2e69 6e64 6578 2e69  [df_fine.index.i
+00022910: 7369 6e28 6466 5f62 6c6f 636b 2e69 6e64  sin(df_block.ind
+00022920: 6578 292c 2022 6374 7222 5d20 3d20 310a  ex), "ctr"] = 1.
+00022930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022940: 6466 5f66 696e 655b 2269 6e74 6572 7661  df_fine["interva
+00022950: 6c49 4422 5d20 3d20 6466 5f66 696e 655b  lID"] = df_fine[
+00022960: 2263 7472 225d 2e63 756d 7375 6d28 290a  "ctr"].cumsum().
+00022970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022980: 6466 5f66 696e 6520 3d20 6466 5f66 696e  df_fine = df_fin
+00022990: 652e 6472 6f70 2822 6374 7222 2c20 6178  e.drop("ctr", ax
+000229a0: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
+000229b0: 2020 2020 2020 6772 705f 636f 6c20 3d20        grp_col = 
+000229c0: 2269 6e74 6572 7661 6c49 4422 0a20 2020  "intervalID".   
+000229d0: 2020 2020 2020 2020 2023 2064 665f 6669           # df_fi
+000229e0: 6e65 203d 2064 665f 6669 6e65 5b7e 6466  ne = df_fine[~df
+000229f0: 5f66 696e 655b 7072 6963 655f 636f 6c73  _fine[price_cols
+00022a00: 5d2e 6973 6e61 2829 2e61 6c6c 2861 7869  ].isna().all(axi
+00022a10: 733d 3129 5d0a 0a20 2020 2020 2020 2020  s=1)]..         
+00022a20: 2020 2064 665f 6e65 7720 3d20 6466 5f66     df_new = df_f
+00022a30: 696e 652e 6772 6f75 7062 7928 6772 705f  ine.groupby(grp_
+00022a40: 636f 6c29 2e61 6767 280a 2020 2020 2020  col).agg(.      
+00022a50: 2020 2020 2020 2020 2020 4f70 656e 3d28            Open=(
+00022a60: 224f 7065 6e22 2c20 2266 6972 7374 2229  "Open", "first")
+00022a70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022a80: 2020 436c 6f73 653d 2822 436c 6f73 6522    Close=("Close"
+00022a90: 2c20 226c 6173 7422 292c 0a20 2020 2020  , "last"),.     
+00022aa0: 2020 2020 2020 2020 2020 2023 2041 646a             # Adj
+00022ab0: 436c 6f73 653d 2822 4164 6a20 436c 6f73  Close=("Adj Clos
+00022ac0: 6522 2c20 226c 6173 7422 292c 0a20 2020  e", "last"),.   
+00022ad0: 2020 2020 2020 2020 2020 2020 204c 6f77               Low
+00022ae0: 3d28 224c 6f77 222c 2022 6d69 6e22 292c  =("Low", "min"),
+00022af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b00: 2048 6967 683d 2822 4869 6768 222c 2022   High=("High", "
+00022b10: 6d61 7822 292c 0a20 2020 2020 2020 2020  max"),.         
+00022b20: 2020 2020 2020 2056 6f6c 756d 653d 2822         Volume=("
+00022b30: 566f 6c75 6d65 222c 2022 7375 6d22 2929  Volume", "sum"))
+00022b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b50: 2023 2043 5346 3d28 2243 5346 222c 2022   # CSF=("CSF", "
+00022b60: 6669 7273 7422 292c 0a20 2020 2020 2020  first"),.       
+00022b70: 2020 2020 2020 2020 2023 2043 4446 3d28           # CDF=(
+00022b80: 2243 4446 222c 2022 6669 7273 7422 2929  "CDF", "first"))
+00022b90: 232e 7265 6e61 6d65 2863 6f6c 756d 6e73  #.rename(columns
+00022ba0: 3d7b 2241 646a 436c 6f73 6522 3a20 2241  ={"AdjClose": "A
+00022bb0: 646a 2043 6c6f 7365 227d 290a 2020 2020  dj Close"}).    
+00022bc0: 2020 2020 2020 2020 6966 2067 7270 5f63          if grp_c
+00022bd0: 6f6c 2069 6e20 5b22 5765 656b 2053 7461  ol in ["Week Sta
+00022be0: 7274 222c 2022 4461 7920 5374 6172 7422  rt", "Day Start"
+00022bf0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00022c00: 2020 2064 665f 6e65 772e 696e 6465 7820     df_new.index 
+00022c10: 3d20 6466 5f6e 6577 2e69 6e64 6578 2e74  = df_new.index.t
+00022c20: 7a5f 6c6f 6361 6c69 7a65 2864 665f 6669  z_localize(df_fi
+00022c30: 6e65 2e69 6e64 6578 2e74 7a29 0a20 2020  ne.index.tz).   
+00022c40: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00022c50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00022c60: 665f 6669 6e65 5b22 6469 6666 225d 203d  f_fine["diff"] =
+00022c70: 2064 665f 6669 6e65 5b22 696e 7465 7276   df_fine["interv
+00022c80: 616c 4944 225d 2e64 6966 6628 290a 2020  alID"].diff().  
+00022c90: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00022ca0: 775f 696e 6465 7820 3d20 6e70 2e61 7070  w_index = np.app
+00022cb0: 656e 6428 5b64 665f 6669 6e65 2e69 6e64  end([df_fine.ind
+00022cc0: 6578 5b30 5d5d 2c20 6466 5f66 696e 652e  ex[0]], df_fine.
+00022cd0: 696e 6465 785b 6466 5f66 696e 655b 2269  index[df_fine["i
+00022ce0: 6e74 6572 7661 6c49 4422 5d2e 6469 6666  ntervalID"].diff
+00022cf0: 2829 203e 2030 5d29 0a20 2020 2020 2020  () > 0]).       
+00022d00: 2020 2020 2020 2020 2064 665f 6e65 772e           df_new.
+00022d10: 696e 6465 7820 3d20 6e65 775f 696e 6465  index = new_inde
+00022d20: 780a 0a20 2020 2020 2020 2020 2020 2023  x..            #
+00022d30: 2043 616c 6962 7261 7465 2120 4368 6563   Calibrate! Chec
+00022d40: 6b20 7768 6574 6865 7220 2764 665f 6669  k whether 'df_fi
+00022d50: 6e65 2720 6861 7320 6469 6666 6572 656e  ne' has differen
+00022d60: 7420 7370 6c69 742d 6164 6a75 7374 6d65  t split-adjustme
+00022d70: 6e74 2e0a 2020 2020 2020 2020 2020 2020  nt..            
+00022d80: 2320 4966 2064 6966 6665 7265 6e74 2c20  # If different, 
+00022d90: 7468 656e 2061 646a 7573 7420 746f 206d  then adjust to m
+00022da0: 6174 6368 2027 6466 270a 2020 2020 2020  atch 'df'.      
+00022db0: 2020 2020 2020 6466 5f62 6c6f 636b 5f63        df_block_c
+00022dc0: 616c 6962 203d 2064 665f 626c 6f63 6b5b  alib = df_block[
+00022dd0: 7072 6963 655f 636f 6c73 5d0a 2020 2020  price_cols].    
+00022de0: 2020 2020 2020 2020 2320 6466 5f6e 6577          # df_new
+00022df0: 5f63 616c 6962 203d 2064 665f 6e65 775b  _calib = df_new[
+00022e00: 6466 5f6e 6577 2e69 6e64 6578 2e69 7369  df_new.index.isi
+00022e10: 6e28 6466 5f62 6c6f 636b 5f63 616c 6962  n(df_block_calib
+00022e20: 2e69 6e64 6578 295d 5b70 7269 6365 5f63  .index)][price_c
+00022e30: 6f6c 735d 0a20 2020 2020 2020 2020 2020  ols].           
+00022e40: 2023 2064 665f 626c 6f63 6b5f 6361 6c69   # df_block_cali
+00022e50: 6220 3d20 6466 5f62 6c6f 636b 5f63 616c  b = df_block_cal
+00022e60: 6962 5b64 665f 626c 6f63 6b5f 6361 6c69  ib[df_block_cali
+00022e70: 622e 696e 6465 782e 6973 696e 2864 665f  b.index.isin(df_
+00022e80: 6e65 775f 6361 6c69 6229 5d0a 2020 2020  new_calib)].    
+00022e90: 2020 2020 2020 2020 636f 6d6d 6f6e 5f69          common_i
+00022ea0: 6e64 6578 203d 206e 702e 696e 7465 7273  ndex = np.inters
+00022eb0: 6563 7431 6428 6466 5f62 6c6f 636b 5f63  ect1d(df_block_c
+00022ec0: 616c 6962 2e69 6e64 6578 2c20 6466 5f6e  alib.index, df_n
+00022ed0: 6577 2e69 6e64 6578 290a 2020 2020 2020  ew.index).      
+00022ee0: 2020 2020 2020 6466 5f6e 6577 5f63 616c        df_new_cal
+00022ef0: 6962 203d 2064 665f 6e65 775b 7072 6963  ib = df_new[pric
+00022f00: 655f 636f 6c73 5d2e 6c6f 635b 636f 6d6d  e_cols].loc[comm
+00022f10: 6f6e 5f69 6e64 6578 5d0a 2020 2020 2020  on_index].      
+00022f20: 2020 2020 2020 6466 5f62 6c6f 636b 5f63        df_block_c
+00022f30: 616c 6962 203d 2064 665f 626c 6f63 6b5f  alib = df_block_
+00022f40: 6361 6c69 622e 6c6f 635b 636f 6d6d 6f6e  calib.loc[common
+00022f50: 5f69 6e64 6578 5d0a 2020 2020 2020 2020  _index].        
+00022f60: 2020 2020 6361 6c69 625f 6669 6c74 6572      calib_filter
+00022f70: 203d 2028 6466 5f62 6c6f 636b 5f63 616c   = (df_block_cal
+00022f80: 6962 2021 3d20 7461 6729 2e74 6f5f 6e75  ib != tag).to_nu
+00022f90: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
+00022fa0: 2020 6966 206e 6f74 2063 616c 6962 5f66    if not calib_f
+00022fb0: 696c 7465 722e 616e 7928 293a 0a20 2020  ilter.any():.   
+00022fc0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+00022fd0: 616e 2774 2063 616c 6962 7261 7465 2073  an't calibrate s
+00022fe0: 6f20 646f 6e27 7420 6174 7465 6d70 7420  o don't attempt 
+00022ff0: 7265 7061 6972 0a20 2020 2020 2020 2020  repair.         
+00023000: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+00023010: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
+00023020: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00023030: 2020 2020 2020 2020 2320 506f 7020 7374          # Pop st
+00023040: 6163 6b20 7472 6163 650a 2020 2020 2020  ack trace.      
+00023050: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00023060: 206c 656e 2873 656c 662e 5f73 7461 636b   len(self._stack
+00023070: 5f74 7261 6365 2920 3d3d 2030 3a0a 2020  _trace) == 0:.  
+00023080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023090: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+000230a0: 7074 696f 6e28 2246 6169 6c69 6e67 2074  ption("Failing t
+000230b0: 6f20 636f 7272 6563 746c 7920 7075 7368  o correctly push
+000230c0: 2f70 6f70 2073 7461 636b 2074 7261 6365  /pop stack trace
+000230d0: 2028 6973 2065 6d70 7479 2074 6f6f 2065   (is empty too e
+000230e0: 6172 6c79 2922 290a 2020 2020 2020 2020  arly)").        
+000230f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00023100: 6f74 2073 656c 662e 5f73 7461 636b 5f74  ot self._stack_t
+00023110: 7261 6365 5b2d 315d 203d 3d20 666e 5f74  race[-1] == fn_t
+00023120: 7570 6c65 3a0a 2020 2020 2020 2020 2020  uple:.          
+00023130: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00023140: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+00023150: 2873 656c 662e 5f73 7461 636b 5f74 7261  (self._stack_tra
+00023160: 6365 2929 3a0a 2020 2020 2020 2020 2020  ce)):.          
+00023170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023180: 2020 7072 696e 7428 2220 2022 2a69 202b    print("  "*i +
+00023190: 2073 7472 2873 656c 662e 5f73 7461 636b   str(self._stack
+000231a0: 5f74 7261 6365 5b69 5d29 290a 2020 2020  _trace[i])).    
 000231b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231c0: 6466 5f66 696e 655b 2257 6565 6b20 5374  df_fine["Week St
-000231d0: 6172 7422 5d20 3d20 6466 5f66 696e 652e  art"] = df_fine.
-000231e0: 696e 6465 782e 747a 5f6c 6f63 616c 697a  index.tz_localiz
-000231f0: 6528 4e6f 6e65 292e 746f 5f70 6572 696f  e(None).to_perio
-00023200: 6428 2257 2d22 2b77 6565 6b5f 656e 645f  d("W-"+week_end_
-00023210: 6461 7929 2e73 7461 7274 5f74 696d 650a  day).start_time.
-00023220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023230: 6772 705f 636f 6c20 3d20 2257 6565 6b20  grp_col = "Week 
-00023240: 5374 6172 7422 0a20 2020 2020 2020 2020  Start".         
-00023250: 2020 2065 6c69 6620 7365 6c66 2e69 6e74     elif self.int
-00023260: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00023270: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
-00023280: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00023290: 5f66 696e 655b 2244 6179 2053 7461 7274  _fine["Day Start
-000232a0: 225d 203d 2070 642e 746f 5f64 6174 6574  "] = pd.to_datet
-000232b0: 696d 6528 6466 5f66 696e 652e 696e 6465  ime(df_fine.inde
-000232c0: 782e 6461 7465 290a 2020 2020 2020 2020  x.date).        
-000232d0: 2020 2020 2020 2020 6772 705f 636f 6c20          grp_col 
-000232e0: 3d20 2244 6179 2053 7461 7274 220a 2020  = "Day Start".  
-000232f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00023300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023310: 6466 5f66 696e 652e 6c6f 635b 6466 5f66  df_fine.loc[df_f
-00023320: 696e 652e 696e 6465 782e 6973 696e 2864  ine.index.isin(d
-00023330: 665f 626c 6f63 6b2e 696e 6465 7829 2c20  f_block.index), 
-00023340: 2263 7472 225d 203d 2031 0a20 2020 2020  "ctr"] = 1.     
-00023350: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
-00023360: 6e65 5b22 696e 7465 7276 616c 4944 225d  ne["intervalID"]
-00023370: 203d 2064 665f 6669 6e65 5b22 6374 7222   = df_fine["ctr"
-00023380: 5d2e 6375 6d73 756d 2829 0a20 2020 2020  ].cumsum().     
-00023390: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
-000233a0: 6e65 203d 2064 665f 6669 6e65 2e64 726f  ne = df_fine.dro
-000233b0: 7028 2263 7472 222c 2061 7869 733d 3129  p("ctr", axis=1)
-000233c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000233d0: 2067 7270 5f63 6f6c 203d 2022 696e 7465   grp_col = "inte
-000233e0: 7276 616c 4944 220a 2020 2020 2020 2020  rvalID".        
-000233f0: 2020 2020 2320 6466 5f66 696e 6520 3d20      # df_fine = 
-00023400: 6466 5f66 696e 655b 7e64 665f 6669 6e65  df_fine[~df_fine
-00023410: 5b70 7269 6365 5f63 6f6c 735d 2e69 736e  [price_cols].isn
-00023420: 6128 292e 616c 6c28 6178 6973 3d31 295d  a().all(axis=1)]
-00023430: 0a0a 2020 2020 2020 2020 2020 2020 6466  ..            df
-00023440: 5f6e 6577 203d 2064 665f 6669 6e65 2e67  _new = df_fine.g
-00023450: 726f 7570 6279 2867 7270 5f63 6f6c 292e  roupby(grp_col).
-00023460: 6167 6728 0a20 2020 2020 2020 2020 2020  agg(.           
-00023470: 2020 2020 204f 7065 6e3d 2822 4f70 656e       Open=("Open
-00023480: 222c 2022 6669 7273 7422 292c 0a20 2020  ", "first"),.   
-00023490: 2020 2020 2020 2020 2020 2020 2043 6c6f               Clo
-000234a0: 7365 3d28 2243 6c6f 7365 222c 2022 6c61  se=("Close", "la
-000234b0: 7374 2229 2c0a 2020 2020 2020 2020 2020  st"),.          
-000234c0: 2020 2020 2020 2320 4164 6a43 6c6f 7365        # AdjClose
-000234d0: 3d28 2241 646a 2043 6c6f 7365 222c 2022  =("Adj Close", "
-000234e0: 6c61 7374 2229 2c0a 2020 2020 2020 2020  last"),.        
-000234f0: 2020 2020 2020 2020 4c6f 773d 2822 4c6f          Low=("Lo
-00023500: 7722 2c20 226d 696e 2229 2c0a 2020 2020  w", "min"),.    
-00023510: 2020 2020 2020 2020 2020 2020 4869 6768              High
-00023520: 3d28 2248 6967 6822 2c20 226d 6178 2229  =("High", "max")
-00023530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023540: 2020 566f 6c75 6d65 3d28 2256 6f6c 756d    Volume=("Volum
-00023550: 6522 2c20 2273 756d 2229 290a 2020 2020  e", "sum")).    
-00023560: 2020 2020 2020 2020 2020 2020 2320 4353              # CS
-00023570: 463d 2822 4353 4622 2c20 2266 6972 7374  F=("CSF", "first
-00023580: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00023590: 2020 2020 2320 4344 463d 2822 4344 4622      # CDF=("CDF"
-000235a0: 2c20 2266 6972 7374 2229 2923 2e72 656e  , "first"))#.ren
-000235b0: 616d 6528 636f 6c75 6d6e 733d 7b22 4164  ame(columns={"Ad
-000235c0: 6a43 6c6f 7365 223a 2022 4164 6a20 436c  jClose": "Adj Cl
-000235d0: 6f73 6522 7d29 0a20 2020 2020 2020 2020  ose"}).         
-000235e0: 2020 2069 6620 6772 705f 636f 6c20 696e     if grp_col in
-000235f0: 205b 2257 6565 6b20 5374 6172 7422 2c20   ["Week Start", 
-00023600: 2244 6179 2053 7461 7274 225d 3a0a 2020  "Day Start"]:.  
-00023610: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00023620: 5f6e 6577 2e69 6e64 6578 203d 2064 665f  _new.index = df_
-00023630: 6e65 772e 696e 6465 782e 747a 5f6c 6f63  new.index.tz_loc
-00023640: 616c 697a 6528 6466 5f66 696e 652e 696e  alize(df_fine.in
-00023650: 6465 782e 747a 290a 2020 2020 2020 2020  dex.tz).        
-00023660: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023670: 2020 2020 2020 2020 2020 6466 5f66 696e            df_fin
-00023680: 655b 2264 6966 6622 5d20 3d20 6466 5f66  e["diff"] = df_f
-00023690: 696e 655b 2269 6e74 6572 7661 6c49 4422  ine["intervalID"
-000236a0: 5d2e 6469 6666 2829 0a20 2020 2020 2020  ].diff().       
-000236b0: 2020 2020 2020 2020 206e 6577 5f69 6e64           new_ind
-000236c0: 6578 203d 206e 702e 6170 7065 6e64 285b  ex = np.append([
-000236d0: 6466 5f66 696e 652e 696e 6465 785b 305d  df_fine.index[0]
-000236e0: 5d2c 2064 665f 6669 6e65 2e69 6e64 6578  ], df_fine.index
-000236f0: 5b64 665f 6669 6e65 5b22 696e 7465 7276  [df_fine["interv
-00023700: 616c 4944 225d 2e64 6966 6628 2920 3e20  alID"].diff() > 
-00023710: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
-00023720: 2020 2020 6466 5f6e 6577 2e69 6e64 6578      df_new.index
-00023730: 203d 206e 6577 5f69 6e64 6578 0a0a 2020   = new_index..  
-00023740: 2020 2020 2020 2020 2020 2320 4361 6c69            # Cali
-00023750: 6272 6174 6521 2043 6865 636b 2077 6865  brate! Check whe
-00023760: 7468 6572 2027 6466 5f66 696e 6527 2068  ther 'df_fine' h
-00023770: 6173 2064 6966 6665 7265 6e74 2073 706c  as different spl
-00023780: 6974 2d61 646a 7573 746d 656e 742e 0a20  it-adjustment.. 
-00023790: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-000237a0: 6469 6666 6572 656e 742c 2074 6865 6e20  different, then 
-000237b0: 6164 6a75 7374 2074 6f20 6d61 7463 6820  adjust to match 
-000237c0: 2764 6627 0a20 2020 2020 2020 2020 2020  'df'.           
-000237d0: 2064 665f 626c 6f63 6b5f 6361 6c69 6220   df_block_calib 
-000237e0: 3d20 6466 5f62 6c6f 636b 5b70 7269 6365  = df_block[price
-000237f0: 5f63 6f6c 735d 0a20 2020 2020 2020 2020  _cols].         
-00023800: 2020 2023 2064 665f 6e65 775f 6361 6c69     # df_new_cali
-00023810: 6220 3d20 6466 5f6e 6577 5b64 665f 6e65  b = df_new[df_ne
-00023820: 772e 696e 6465 782e 6973 696e 2864 665f  w.index.isin(df_
-00023830: 626c 6f63 6b5f 6361 6c69 622e 696e 6465  block_calib.inde
-00023840: 7829 5d5b 7072 6963 655f 636f 6c73 5d0a  x)][price_cols].
-00023850: 2020 2020 2020 2020 2020 2020 2320 6466              # df
-00023860: 5f62 6c6f 636b 5f63 616c 6962 203d 2064  _block_calib = d
-00023870: 665f 626c 6f63 6b5f 6361 6c69 625b 6466  f_block_calib[df
-00023880: 5f62 6c6f 636b 5f63 616c 6962 2e69 6e64  _block_calib.ind
-00023890: 6578 2e69 7369 6e28 6466 5f6e 6577 5f63  ex.isin(df_new_c
-000238a0: 616c 6962 295d 0a20 2020 2020 2020 2020  alib)].         
-000238b0: 2020 2063 6f6d 6d6f 6e5f 696e 6465 7820     common_index 
-000238c0: 3d20 6e70 2e69 6e74 6572 7365 6374 3164  = np.intersect1d
-000238d0: 2864 665f 626c 6f63 6b5f 6361 6c69 622e  (df_block_calib.
-000238e0: 696e 6465 782c 2064 665f 6e65 772e 696e  index, df_new.in
-000238f0: 6465 7829 0a20 2020 2020 2020 2020 2020  dex).           
-00023900: 2064 665f 6e65 775f 6361 6c69 6220 3d20   df_new_calib = 
-00023910: 6466 5f6e 6577 5b70 7269 6365 5f63 6f6c  df_new[price_col
-00023920: 735d 2e6c 6f63 5b63 6f6d 6d6f 6e5f 696e  s].loc[common_in
-00023930: 6465 785d 0a20 2020 2020 2020 2020 2020  dex].           
-00023940: 2064 665f 626c 6f63 6b5f 6361 6c69 6220   df_block_calib 
-00023950: 3d20 6466 5f62 6c6f 636b 5f63 616c 6962  = df_block_calib
-00023960: 2e6c 6f63 5b63 6f6d 6d6f 6e5f 696e 6465  .loc[common_inde
-00023970: 785d 0a20 2020 2020 2020 2020 2020 2063  x].            c
-00023980: 616c 6962 5f66 696c 7465 7220 3d20 2864  alib_filter = (d
-00023990: 665f 626c 6f63 6b5f 6361 6c69 6220 213d  f_block_calib !=
-000239a0: 2074 6167 292e 746f 5f6e 756d 7079 2829   tag).to_numpy()
-000239b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000239c0: 6e6f 7420 6361 6c69 625f 6669 6c74 6572  not calib_filter
-000239d0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-000239e0: 2020 2020 2020 2020 2320 4361 6e27 7420          # Can't 
-000239f0: 6361 6c69 6272 6174 6520 736f 2064 6f6e  calibrate so don
-00023a00: 2774 2061 7474 656d 7074 2072 6570 6169  't attempt repai
-00023a10: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00023a20: 2020 6966 2073 656c 662e 5f72 6563 6f72    if self._recor
-00023a30: 645f 7374 6163 6b5f 7472 6163 653a 0a20  d_stack_trace:. 
-00023a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a50: 2020 2023 2050 6f70 2073 7461 636b 2074     # Pop stack t
-00023a60: 7261 6365 0a20 2020 2020 2020 2020 2020  race.           
-00023a70: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00023a80: 7365 6c66 2e5f 7374 6163 6b5f 7472 6163  self._stack_trac
-00023a90: 6529 203d 3d20 303a 0a20 2020 2020 2020  e) == 0:.       
-00023aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ab0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-00023ac0: 2822 4661 696c 696e 6720 746f 2063 6f72  ("Failing to cor
-00023ad0: 7265 6374 6c79 2070 7573 682f 706f 7020  rectly push/pop 
-00023ae0: 7374 6163 6b20 7472 6163 6520 2869 7320  stack trace (is 
-00023af0: 656d 7074 7920 746f 6f20 6561 726c 7929  empty too early)
-00023b00: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00023b10: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00023b20: 6c66 2e5f 7374 6163 6b5f 7472 6163 655b  lf._stack_trace[
-00023b30: 2d31 5d20 3d3d 2066 6e5f 7475 706c 653a  -1] == fn_tuple:
-00023b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b50: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-00023b60: 6e20 7261 6e67 6528 6c65 6e28 7365 6c66  n range(len(self
-00023b70: 2e5f 7374 6163 6b5f 7472 6163 6529 293a  ._stack_trace)):
-00023b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b90: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00023ba0: 6e74 2822 2020 222a 6920 2b20 7374 7228  nt("  "*i + str(
-00023bb0: 7365 6c66 2e5f 7374 6163 6b5f 7472 6163  self._stack_trac
-00023bc0: 655b 695d 2929 0a20 2020 2020 2020 2020  e[i])).         
-00023bd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00023be0: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
-00023bf0: 4661 696c 696e 6720 746f 2063 6f72 7265  Failing to corre
-00023c00: 6374 6c79 2070 7573 682f 706f 7020 7374  ctly push/pop st
-00023c10: 6163 6b20 7472 6163 6520 2873 6565 2061  ack trace (see a
-00023c20: 626f 7665 2922 290a 2020 2020 2020 2020  bove)").        
-00023c30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00023c40: 2e5f 7374 6163 6b5f 7472 6163 652e 706f  ._stack_trace.po
-00023c50: 7028 6c65 6e28 7365 6c66 2e5f 7374 6163  p(len(self._stac
-00023c60: 6b5f 7472 6163 6529 202d 2031 290a 2020  k_trace) - 1).  
-00023c70: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00023c80: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-00023c90: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-00023ca0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00023cb0: 6e74 2822 6361 6c69 625f 6669 6c74 6572  nt("calib_filter
-00023cc0: 3a22 2920 3b20 7072 696e 7428 6361 6c69  :") ; print(cali
-00023cd0: 625f 6669 6c74 6572 290a 2020 2020 2020  b_filter).      
-00023ce0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00023cf0: 2264 665f 6e65 775f 6361 6c69 623a 2229  "df_new_calib:")
-00023d00: 203b 2070 7269 6e74 2864 665f 6e65 775f   ; print(df_new_
-00023d10: 6361 6c69 6229 0a20 2020 2020 2020 2020  calib).         
-00023d20: 2020 2020 2020 2070 7269 6e74 2822 6466         print("df
-00023d30: 5f62 6c6f 636b 5f63 616c 6962 3a22 2920  _block_calib:") 
-00023d40: 3b20 7072 696e 7428 6466 5f62 6c6f 636b  ; print(df_block
-00023d50: 5f63 616c 6962 290a 2020 2020 2020 2020  _calib).        
-00023d60: 2020 2020 2320 4176 6f69 6420 6469 7669      # Avoid divi
-00023d70: 6465 2d62 792d 7a65 726f 2077 6172 6e69  de-by-zero warni
-00023d80: 6e67 7320 7072 696e 7469 6e67 3a0a 2020  ngs printing:.  
-00023d90: 2020 2020 2020 2020 2020 6466 5f6e 6577            df_new
-00023da0: 5f63 616c 6962 203d 2064 665f 6e65 775f  _calib = df_new_
-00023db0: 6361 6c69 622e 746f 5f6e 756d 7079 2829  calib.to_numpy()
-00023dc0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-00023dd0: 626c 6f63 6b5f 6361 6c69 6220 3d20 6466  block_calib = df
-00023de0: 5f62 6c6f 636b 5f63 616c 6962 2e74 6f5f  _block_calib.to_
-00023df0: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-00023e00: 2020 2020 666f 7220 6a20 696e 2072 616e      for j in ran
-00023e10: 6765 286c 656e 2870 7269 6365 5f63 6f6c  ge(len(price_col
-00023e20: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-00023e30: 2020 2020 2063 203d 2070 7269 6365 5f63       c = price_c
-00023e40: 6f6c 735b 6a5d 0a20 2020 2020 2020 2020  ols[j].         
-00023e50: 2020 2020 2020 2066 203d 207e 6361 6c69         f = ~cali
-00023e60: 625f 6669 6c74 6572 5b3a 2c20 6a5d 0a20  b_filter[:, j]. 
-00023e70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00023e80: 6620 662e 616e 7928 293a 0a20 2020 2020  f f.any():.     
-00023e90: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00023ea0: 665f 626c 6f63 6b5f 6361 6c69 625b 662c  f_block_calib[f,
-00023eb0: 206a 5d20 3d20 310a 2020 2020 2020 2020   j] = 1.        
-00023ec0: 2020 2020 2020 2020 2020 2020 6466 5f6e              df_n
-00023ed0: 6577 5f63 616c 6962 5b66 2c20 6a5d 203d  ew_calib[f, j] =
-00023ee0: 2031 0a20 2020 2020 2020 2020 2020 2072   1.            r
-00023ef0: 6174 696f 7320 3d20 2864 665f 626c 6f63  atios = (df_bloc
-00023f00: 6b5f 6361 6c69 6220 2f20 6466 5f6e 6577  k_calib / df_new
-00023f10: 5f63 616c 6962 295b 6361 6c69 625f 6669  _calib)[calib_fi
-00023f20: 6c74 6572 5d0a 2020 2020 2020 2020 2020  lter].          
-00023f30: 2020 7261 7469 6f20 3d20 6e70 2e6d 6561    ratio = np.mea
-00023f40: 6e28 7261 7469 6f73 290a 2020 2020 2020  n(ratios).      
-00023f50: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-00023f60: 2020 2020 7261 7469 6f5f 7263 7020 3d20      ratio_rcp = 
-00023f70: 726f 756e 6428 312e 3020 2f20 7261 7469  round(1.0 / rati
-00023f80: 6f2c 2031 290a 2020 2020 2020 2020 2020  o, 1).          
-00023f90: 2020 7261 7469 6f20 3d20 726f 756e 6428    ratio = round(
-00023fa0: 7261 7469 6f2c 2031 290a 2020 2020 2020  ratio, 1).      
-00023fb0: 2020 2020 2020 6966 2072 6174 696f 203d        if ratio =
-00023fc0: 3d20 3120 616e 6420 7261 7469 6f5f 7263  = 1 and ratio_rc
-00023fd0: 7020 3d3d 2031 3a0a 2020 2020 2020 2020  p == 1:.        
-00023fe0: 2020 2020 2020 2020 2320 476f 6f64 210a          # Good!.
-00023ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024000: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00024010: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00024020: 2020 2020 2020 2069 6620 7261 7469 6f20         if ratio 
-00024030: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00024040: 2020 2020 2020 2020 2023 2064 6174 6120           # data 
-00024050: 6861 7320 6469 6666 6572 656e 7420 7370  has different sp
-00024060: 6c69 742d 6164 6a75 7374 6d65 6e74 2074  lit-adjustment t
-00024070: 6861 6e20 6669 6e65 2d67 7261 696e 6564  han fine-grained
-00024080: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-00024090: 2020 2020 2020 2020 2020 2320 4164 6a75            # Adju
-000240a0: 7374 2066 696e 652d 6772 6169 6e65 6420  st fine-grained 
-000240b0: 746f 206d 6174 6368 0a20 2020 2020 2020  to match.       
-000240c0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000240d0: 6e65 775b 7072 6963 655f 636f 6c73 5d20  new[price_cols] 
-000240e0: 2a3d 2072 6174 696f 0a20 2020 2020 2020  *= ratio.       
-000240f0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00024100: 6e65 775b 2256 6f6c 756d 6522 5d20 2f3d  new["Volume"] /=
-00024110: 2072 6174 696f 0a20 2020 2020 2020 2020   ratio.         
-00024120: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-00024130: 775b 2256 6f6c 756d 6522 5d20 3d20 6466  w["Volume"] = df
-00024140: 5f6e 6577 5b22 566f 6c75 6d65 225d 2e72  _new["Volume"].r
-00024150: 6f75 6e64 2830 292e 6173 7479 7065 2827  ound(0).astype('
-00024160: 696e 7427 290a 2020 2020 2020 2020 2020  int').          
-00024170: 2020 2020 2020 656c 6966 2072 6174 696f        elif ratio
-00024180: 5f72 6370 203e 2031 3a0a 2020 2020 2020  _rcp > 1:.      
-00024190: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000241a0: 6461 7461 2068 6173 2064 6966 6665 7265  data has differe
-000241b0: 6e74 2073 706c 6974 2d61 646a 7573 746d  nt split-adjustm
-000241c0: 656e 7420 7468 616e 2066 696e 652d 6772  ent than fine-gr
-000241d0: 6169 6e65 6420 6461 7461 0a20 2020 2020  ained data.     
-000241e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000241f0: 2041 646a 7573 7420 6669 6e65 2d67 7261   Adjust fine-gra
-00024200: 696e 6564 2074 6f20 6d61 7463 680a 2020  ined to match.  
-00024210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024220: 2020 6466 5f6e 6577 5b70 7269 6365 5f63    df_new[price_c
-00024230: 6f6c 735d 202a 3d20 312e 3020 2f20 7261  ols] *= 1.0 / ra
-00024240: 7469 6f5f 7263 700a 2020 2020 2020 2020  tio_rcp.        
-00024250: 2020 2020 2020 2020 2020 2020 6466 5f6e              df_n
-00024260: 6577 5b22 566f 6c75 6d65 225d 202a 3d20  ew["Volume"] *= 
-00024270: 7261 7469 6f5f 7263 700a 2020 2020 2020  ratio_rcp.      
-00024280: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00024290: 5f6e 6577 5b22 566f 6c75 6d65 225d 203d  _new["Volume"] =
-000242a0: 2064 665f 6e65 775b 2256 6f6c 756d 6522   df_new["Volume"
-000242b0: 5d2e 726f 756e 6428 3029 2e61 7374 7970  ].round(0).astyp
-000242c0: 6528 2769 6e74 2729 0a0a 2020 2020 2020  e('int')..      
-000242d0: 2020 2020 2020 2320 5265 7061 6972 210a        # Repair!.
-000242e0: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
-000242f0: 6474 7320 3d20 6466 5f62 6c6f 636b 2e69  dts = df_block.i
-00024300: 6e64 6578 5b28 6466 5f62 6c6f 636b 5b70  ndex[(df_block[p
-00024310: 7269 6365 5f63 6f6c 735d 203d 3d20 7461  rice_cols] == ta
-00024320: 6729 2e61 6e79 2861 7869 733d 3129 5d0a  g).any(axis=1)].
-00024330: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00024340: 2069 6478 2069 6e20 6261 645f 6474 733a   idx in bad_dts:
-00024350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024360: 2069 6620 6964 7820 6e6f 7420 696e 2064   if idx not in d
-00024370: 665f 6e65 772e 696e 6465 783a 0a20 2020  f_new.index:.   
-00024380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024390: 2023 2059 6168 6f6f 2064 6964 6e27 7420   # Yahoo didn't 
-000243a0: 7265 7475 726e 2066 696e 6572 2d67 7261  return finer-gra
-000243b0: 696e 2064 6174 6120 666f 7220 7468 6973  in data for this
-000243c0: 2069 6e74 6572 7661 6c2c 0a20 2020 2020   interval,.     
-000243d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000243e0: 2073 6f20 7072 6f62 6162 6c79 206e 6f20   so probably no 
-000243f0: 7472 6164 696e 6720 6861 7070 656e 6564  trading happened
-00024400: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00024410: 2020 2020 2020 2320 7072 696e 7428 226e        # print("n
-00024420: 6f20 6669 6e65 2064 6174 6122 290a 2020  o fine data").  
-00024430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024440: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00024450: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-00024460: 775f 726f 7720 3d20 6466 5f6e 6577 2e6c  w_row = df_new.l
-00024470: 6f63 5b69 6478 5d0a 0a20 2020 2020 2020  oc[idx]..       
-00024480: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00024490: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000244a0: 642e 496e 7465 7276 616c 2e57 6565 6b3a  d.Interval.Week:
-000244b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000244c0: 2020 2020 2064 665f 6c61 7374 5f77 6565       df_last_wee
-000244d0: 6b20 3d20 6466 5f6e 6577 2e69 6c6f 635b  k = df_new.iloc[
-000244e0: 6466 5f6e 6577 2e69 6e64 6578 2e67 6574  df_new.index.get
-000244f0: 5f6c 6f63 2869 6478 292d 315d 0a20 2020  _loc(idx)-1].   
-00024500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024510: 2064 665f 6669 6e65 203d 2064 665f 6669   df_fine = df_fi
-00024520: 6e65 2e6c 6f63 5b69 6478 3a5d 0a0a 2020  ne.loc[idx:]..  
-00024530: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00024540: 5f62 6164 5f72 6f77 203d 2064 662e 6c6f  _bad_row = df.lo
-00024550: 635b 6964 785d 0a20 2020 2020 2020 2020  c[idx].         
-00024560: 2020 2020 2020 2062 6164 5f66 6965 6c64         bad_field
-00024570: 7320 3d20 6466 5f62 6164 5f72 6f77 2e69  s = df_bad_row.i
-00024580: 6e64 6578 5b64 665f 6261 645f 726f 7720  ndex[df_bad_row 
-00024590: 3d3d 2074 6167 5d2e 746f 5f6e 756d 7079  == tag].to_numpy
-000245a0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000245b0: 2020 2069 6620 2248 6967 6822 2069 6e20     if "High" in 
-000245c0: 6261 645f 6669 656c 6473 3a0a 2020 2020  bad_fields:.    
-000245d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245e0: 6466 5f76 322e 6c6f 635b 6964 782c 2022  df_v2.loc[idx, "
-000245f0: 4869 6768 225d 203d 2064 665f 6e65 775f  High"] = df_new_
-00024600: 726f 775b 2248 6967 6822 5d0a 2020 2020  row["High"].    
-00024610: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-00024620: 4c6f 7722 2069 6e20 6261 645f 6669 656c  Low" in bad_fiel
-00024630: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
-00024640: 2020 2020 2020 2020 6466 5f76 322e 6c6f          df_v2.lo
-00024650: 635b 6964 782c 2022 4c6f 7722 5d20 3d20  c[idx, "Low"] = 
-00024660: 6466 5f6e 6577 5f72 6f77 5b22 4c6f 7722  df_new_row["Low"
-00024670: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00024680: 2020 6966 2022 4f70 656e 2220 696e 2062    if "Open" in b
-00024690: 6164 5f66 6965 6c64 733a 0a20 2020 2020  ad_fields:.     
-000246a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000246b0: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
-000246c0: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
-000246d0: 2e57 6565 6b20 616e 6420 6964 7820 213d  .Week and idx !=
-000246e0: 2064 665f 6669 6e65 2e69 6e64 6578 5b30   df_fine.index[0
-000246f0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00024700: 2020 2020 2020 2020 2020 2023 2045 7863             # Exc
-00024710: 6861 6e67 6520 636c 6f73 6564 204d 6f6e  hange closed Mon
-00024720: 6461 792e 2049 6e20 7468 6973 2063 6173  day. In this cas
-00024730: 652c 2059 6168 6f6f 2073 6574 7320 4f70  e, Yahoo sets Op
-00024740: 656e 2074 6f20 6c61 7374 2077 6565 6b20  en to last week 
-00024750: 636c 6f73 650a 2020 2020 2020 2020 2020  close.          
-00024760: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00024770: 5f76 322e 6c6f 635b 6964 782c 2022 4f70  _v2.loc[idx, "Op
-00024780: 656e 225d 203d 2064 665f 6c61 7374 5f77  en"] = df_last_w
-00024790: 6565 6b5b 2243 6c6f 7365 225d 0a20 2020  eek["Close"].   
-000247a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000247b0: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
-000247c0: 6478 2c20 224c 6f77 225d 203d 206d 696e  dx, "Low"] = min
-000247d0: 2864 665f 7632 2e6c 6f63 5b69 6478 2c20  (df_v2.loc[idx, 
-000247e0: 224f 7065 6e22 5d2c 2064 665f 7632 2e6c  "Open"], df_v2.l
-000247f0: 6f63 5b69 6478 2c20 224c 6f77 225d 290a  oc[idx, "Low"]).
-00024800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024810: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00024820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024830: 2020 6466 5f76 322e 6c6f 635b 6964 782c    df_v2.loc[idx,
-00024840: 2022 4f70 656e 225d 203d 2064 665f 6e65   "Open"] = df_ne
-00024850: 775f 726f 775b 224f 7065 6e22 5d0a 2020  w_row["Open"].  
-00024860: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00024870: 2022 436c 6f73 6522 2069 6e20 6261 645f   "Close" in bad_
-00024880: 6669 656c 6473 3a0a 2020 2020 2020 2020  fields:.        
-00024890: 2020 2020 2020 2020 2020 2020 6466 5f76              df_v
-000248a0: 322e 6c6f 635b 6964 782c 2022 436c 6f73  2.loc[idx, "Clos
-000248b0: 6522 5d20 3d20 6466 5f6e 6577 5f72 6f77  e"] = df_new_row
-000248c0: 5b22 436c 6f73 6522 5d0a 2020 2020 2020  ["Close"].      
-000248d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000248e0: 5368 6f75 6c64 206e 6f74 206e 6565 6420  Should not need 
-000248f0: 746f 2063 6f70 7920 6f76 6572 2043 4446  to copy over CDF
-00024900: 2026 2043 5346 2c20 6265 6361 7573 650a   & CSF, because.
-00024910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024920: 2020 2020 2320 636f 7272 6563 7420 7661      # correct va
-00024930: 6c75 6573 2061 7265 2061 6c72 6561 6479  lues are already
-00024940: 206d 6572 6765 6420 696e 2066 726f 6d20   merged in from 
-00024950: 6461 696c 790a 2020 2020 2020 2020 2020  daily.          
-00024960: 2020 2020 2020 2020 2020 2320 6466 5f76            # df_v
-00024970: 322e 6c6f 635b 6964 782c 2022 4344 4622  2.loc[idx, "CDF"
-00024980: 5d20 3d20 6466 5f6e 6577 5f72 6f77 5b22  ] = df_new_row["
-00024990: 4344 4622 5d0a 2020 2020 2020 2020 2020  CDF"].          
-000249a0: 2020 2020 2020 2020 2020 2320 6466 5f76            # df_v
-000249b0: 322e 6c6f 635b 6964 782c 2022 4353 4622  2.loc[idx, "CSF"
-000249c0: 5d20 3d20 6466 5f6e 6577 5f72 6f77 5b22  ] = df_new_row["
-000249d0: 4353 4622 5d0a 2020 2020 2020 2020 2020  CSF"].          
-000249e0: 2020 2020 2020 6966 2022 566f 6c75 6d65        if "Volume
-000249f0: 2220 696e 2062 6164 5f66 6965 6c64 733a  " in bad_fields:
-00024a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024a10: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
-00024a20: 6478 2c20 2256 6f6c 756d 6522 5d20 3d20  dx, "Volume"] = 
-00024a30: 6466 5f6e 6577 5f72 6f77 5b22 566f 6c75  df_new_row["Volu
-00024a40: 6d65 225d 0a20 2020 2020 2020 2020 2020  me"].           
-00024a50: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
-00024a60: 6478 2c20 2252 6570 6169 7265 643f 225d  dx, "Repaired?"]
-00024a70: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00024a80: 2020 2020 2020 2020 6e5f 6669 7865 6420          n_fixed 
-00024a90: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-00024aa0: 2020 2320 5265 7374 6f72 6520 756e 2d72    # Restore un-r
-00024ab0: 6570 6169 7265 6420 6261 6420 7661 6c75  epaired bad valu
-00024ac0: 6573 0a20 2020 2020 2020 2020 2020 2066  es.            f
-00024ad0: 5f6e 616e 203d 2064 665f 7632 5b70 7269  _nan = df_v2[pri
-00024ae0: 6365 5f63 6f6c 735d 2e69 736e 6128 292e  ce_cols].isna().
-00024af0: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-00024b00: 2020 2020 2020 2066 5f66 6169 6c65 6420         f_failed 
-00024b10: 3d20 665f 7461 6720 2620 665f 6e61 6e0a  = f_tag & f_nan.
-00024b20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00024b30: 6a20 696e 2072 616e 6765 286c 656e 2870  j in range(len(p
-00024b40: 7269 6365 5f63 6f6c 7329 293a 0a20 2020  rice_cols)):.   
-00024b50: 2020 2020 2020 2020 2020 2020 2066 203d               f =
-00024b60: 2066 5f66 6169 6c65 645b 3a2c 206a 5d0a   f_failed[:, j].
-00024b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b80: 6966 2066 2e61 6e79 2829 3a0a 2020 2020  if f.any():.    
-00024b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ba0: 6320 3d20 7072 6963 655f 636f 6c73 5b6a  c = price_cols[j
-00024bb0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00024bc0: 2020 2020 2020 6466 5f76 322e 6c6f 635b        df_v2.loc[
-00024bd0: 662c 2063 5d20 3d20 6466 2e6c 6f63 5b66  f, c] = df.loc[f
-00024be0: 2c20 635d 0a0a 2020 2020 2020 2020 2020  , c]..          
-00024bf0: 2020 6966 2073 656c 662e 5f72 6563 6f72    if self._recor
-00024c00: 645f 7374 6163 6b5f 7472 6163 653a 0a20  d_stack_trace:. 
-00024c10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00024c20: 2050 6f70 2073 7461 636b 2074 7261 6365   Pop stack trace
-00024c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024c40: 2069 6620 6c65 6e28 7365 6c66 2e5f 7374   if len(self._st
-00024c50: 6163 6b5f 7472 6163 6529 203d 3d20 303a  ack_trace) == 0:
-00024c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024c70: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-00024c80: 7469 6f6e 2822 4661 696c 696e 6720 746f  tion("Failing to
-00024c90: 2063 6f72 7265 6374 6c79 2070 7573 682f   correctly push/
-00024ca0: 706f 7020 7374 6163 6b20 7472 6163 6520  pop stack trace 
-00024cb0: 2869 7320 656d 7074 7920 746f 6f20 6561  (is empty too ea
-00024cc0: 726c 7929 2229 0a20 2020 2020 2020 2020  rly)").         
-00024cd0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00024ce0: 6c66 2e5f 7374 6163 6b5f 7472 6163 655b  lf._stack_trace[
-00024cf0: 2d31 5d20 3d3d 2066 6e5f 7475 706c 653a  -1] == fn_tuple:
-00024d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024d10: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00024d20: 6e67 6528 6c65 6e28 7365 6c66 2e5f 7374  nge(len(self._st
-00024d30: 6163 6b5f 7472 6163 6529 293a 0a20 2020  ack_trace)):.   
-00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d50: 2020 2020 2070 7269 6e74 2822 2020 222a       print("  "*
-00024d60: 6920 2b20 7374 7228 7365 6c66 2e5f 7374  i + str(self._st
-00024d70: 6163 6b5f 7472 6163 655b 695d 2929 0a20  ack_trace[i])). 
-00024d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d90: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00024da0: 6f6e 2822 4661 696c 696e 6720 746f 2063  on("Failing to c
-00024db0: 6f72 7265 6374 6c79 2070 7573 682f 706f  orrectly push/po
-00024dc0: 7020 7374 6163 6b20 7472 6163 6520 2873  p stack trace (s
-00024dd0: 6565 2061 626f 7665 2922 290a 2020 2020  ee above)").    
-00024de0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00024df0: 2e5f 7374 6163 6b5f 7472 6163 652e 706f  ._stack_trace.po
-00024e00: 7028 6c65 6e28 7365 6c66 2e5f 7374 6163  p(len(self._stac
-00024e10: 6b5f 7472 6163 6529 202d 2031 290a 0a20  k_trace) - 1).. 
-00024e20: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
-00024e30: 2022 504d 3a3a 5f72 6563 6f6e 7374 7275   "PM::_reconstru
-00024e40: 6374 5f69 6e74 6572 7661 6c73 5f62 6174  ct_intervals_bat
-00024e50: 6368 2829 2072 6574 7572 6e69 6e67 220a  ch() returning".
-00024e60: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-00024e70: 6365 4578 6974 286c 6f67 5f6d 7367 290a  ceExit(log_msg).
-00024e80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00024e90: 6466 5f76 320a 0a20 2020 2064 6566 205f  df_v2..    def _
-00024ea0: 7265 7061 6972 556e 6974 4d69 7875 7073  repairUnitMixups
-00024eb0: 2873 656c 662c 2064 662c 2073 696c 656e  (self, df, silen
-00024ec0: 743d 4661 6c73 6529 3a0a 2020 2020 2020  t=False):.      
-00024ed0: 2020 6466 3220 3d20 7365 6c66 2e5f 6669    df2 = self._fi
-00024ee0: 7855 6e69 7453 7769 7463 6828 6466 290a  xUnitSwitch(df).
-00024ef0: 2020 2020 2020 2020 6466 3320 3d20 7365          df3 = se
-00024f00: 6c66 2e5f 7265 7061 6972 5370 6f72 6164  lf._repairSporad
-00024f10: 6963 556e 6974 4d69 7875 7073 2864 6632  icUnitMixups(df2
-00024f20: 2c20 7369 6c65 6e74 290a 2020 2020 2020  , silent).      
-00024f30: 2020 7265 7475 726e 2064 6633 0a0a 2020    return df3..  
-00024f40: 2020 6465 6620 5f72 6570 6169 7253 706f    def _repairSpo
-00024f50: 7261 6469 6355 6e69 744d 6978 7570 7328  radicUnitMixups(
-00024f60: 7365 6c66 2c20 6466 2c20 7369 6c65 6e74  self, df, silent
-00024f70: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00024f80: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
-00024f90: 6174 6146 7261 6d65 2864 662c 2022 6466  ataFrame(df, "df
-00024fa0: 2229 0a0a 2020 2020 2020 2020 2320 536f  ")..        # So
-00024fb0: 6d65 7469 6d65 7320 5961 686f 6f20 7265  metimes Yahoo re
-00024fc0: 7475 726e 7320 6665 7720 7072 6963 6573  turns few prices
-00024fd0: 2069 6e20 6365 6e74 732f 7065 6e63 6520   in cents/pence 
-00024fe0: 696e 7374 6561 6420 6f66 2024 2fc2 a30a  instead of $/...
-00024ff0: 2020 2020 2020 2020 2320 492e 652e 2031          # I.e. 1
-00025000: 3030 7820 6269 6767 6572 0a20 2020 2020  00x bigger.     
-00025010: 2020 2023 2045 6173 7920 746f 2064 6574     # Easy to det
-00025020: 6563 7420 616e 6420 6669 782c 206a 7573  ect and fix, jus
-00025030: 7420 6c6f 6f6b 2066 6f72 206f 7574 6c69  t look for outli
-00025040: 6572 7320 3d20 7e31 3030 7820 6c6f 6361  ers = ~100x loca
-00025050: 6c20 6d65 6469 616e 0a0a 2020 2020 2020  l median..      
-00025060: 2020 6966 2064 662e 656d 7074 793a 0a20    if df.empty:. 
-00025070: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00025080: 6e20 6466 0a20 2020 2020 2020 2069 6620  n df.        if 
-00025090: 6466 2e73 6861 7065 5b30 5d20 3d3d 2031  df.shape[0] == 1
-000250a0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000250b0: 4e65 6564 206d 756c 7469 706c 6520 726f  Need multiple ro
-000250c0: 7773 2074 6f20 636f 6e66 6964 656e 746c  ws to confidentl
-000250d0: 7920 6964 656e 7469 6679 206f 7574 6c69  y identify outli
-000250e0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-000250f0: 7265 7475 726e 2064 660a 0a20 2020 2020  return df..     
-00025100: 2020 206c 6f67 5f6d 7367 5f65 6e74 6572     log_msg_enter
-00025110: 203d 2066 2250 4d3a 3a5f 7265 7061 6972   = f"PM::_repair
-00025120: 5370 6f72 6164 6963 556e 6974 4d69 7875  SporadicUnitMixu
-00025130: 7073 2d7b 7365 6c66 2e69 7374 727d 2829  ps-{self.istr}()
-00025140: 220a 2020 2020 2020 2020 6c6f 675f 6d73  ".        log_ms
-00025150: 675f 6578 6974 203d 2066 2250 4d3a 3a5f  g_exit = f"PM::_
-00025160: 7265 7061 6972 5370 6f72 6164 6963 556e  repairSporadicUn
-00025170: 6974 4d69 7875 7073 2d7b 7365 6c66 2e69  itMixups-{self.i
-00025180: 7374 727d 2829 2072 6574 7572 6e69 6e67  str}() returning
-00025190: 220a 2020 2020 2020 2020 7966 636c 2e54  ".        yfcl.T
-000251a0: 7261 6365 456e 7465 7228 6c6f 675f 6d73  raceEnter(log_ms
-000251b0: 675f 656e 7465 7229 0a0a 2020 2020 2020  g_enter)..      
-000251c0: 2020 6466 3220 3d20 6466 2e63 6f70 7928    df2 = df.copy(
-000251d0: 290a 0a20 2020 2020 2020 2064 6174 615f  )..        data_
-000251e0: 636f 6c73 203d 205b 2248 6967 6822 2c20  cols = ["High", 
-000251f0: 224f 7065 6e22 2c20 224c 6f77 222c 2022  "Open", "Low", "
-00025200: 436c 6f73 6522 5d20 2023 204f 7264 6572  Close"]  # Order
-00025210: 2069 6d70 6f72 7461 6e74 2c20 7365 7061   important, sepa
-00025220: 7261 7465 2048 6967 6820 6672 6f6d 204c  rate High from L
-00025230: 6f77 0a20 2020 2020 2020 2064 6174 615f  ow.        data_
-00025240: 636f 6c73 203d 205b 6320 666f 7220 6320  cols = [c for c 
-00025250: 696e 2064 6174 615f 636f 6c73 2069 6620  in data_cols if 
-00025260: 6320 696e 2064 6632 2e63 6f6c 756d 6e73  c in df2.columns
-00025270: 5d0a 2020 2020 2020 2020 665f 7a65 726f  ].        f_zero
-00025280: 6573 203d 2028 6466 325b 6461 7461 5f63  es = (df2[data_c
-00025290: 6f6c 735d 203d 3d20 3029 2e61 6e79 2861  ols] == 0).any(a
-000252a0: 7869 733d 3129 0a20 2020 2020 2020 2069  xis=1).        i
-000252b0: 6620 665f 7a65 726f 6573 2e61 6e79 2829  f f_zeroes.any()
-000252c0: 3a0a 2020 2020 2020 2020 2020 2020 6466  :.            df
-000252d0: 325f 7a65 726f 6573 203d 2064 6632 5b66  2_zeroes = df2[f
-000252e0: 5f7a 6572 6f65 735d 0a20 2020 2020 2020  _zeroes].       
-000252f0: 2020 2020 2064 6632 203d 2064 6632 5b7e       df2 = df2[~
-00025300: 665f 7a65 726f 6573 5d0a 2020 2020 2020  f_zeroes].      
-00025310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00025320: 2020 2020 6466 325f 7a65 726f 6573 203d      df2_zeroes =
-00025330: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-00025340: 2064 6632 2e73 6861 7065 5b30 5d20 3c3d   df2.shape[0] <=
-00025350: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00025360: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-00025370: 6f67 5f6d 7367 5f65 7869 7429 0a20 2020  og_msg_exit).   
-00025380: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00025390: 6466 0a20 2020 2020 2020 2064 6632 5f64  df.        df2_d
-000253a0: 6174 6120 3d20 6466 325b 6461 7461 5f63  ata = df2[data_c
-000253b0: 6f6c 735d 2e74 6f5f 6e75 6d70 7928 290a  ols].to_numpy().
-000253c0: 2020 2020 2020 2020 6d65 6469 616e 203d          median =
-000253d0: 205f 6e64 696d 6167 652e 6d65 6469 616e   _ndimage.median
-000253e0: 5f66 696c 7465 7228 6466 325f 6461 7461  _filter(df2_data
-000253f0: 2c20 7369 7a65 3d28 332c 2033 292c 206d  , size=(3, 3), m
-00025400: 6f64 653d 2277 7261 7022 290a 2020 2020  ode="wrap").    
-00025410: 2020 2020 7261 7469 6f20 3d20 6466 325f      ratio = df2_
-00025420: 6461 7461 202f 206d 6564 6961 6e0a 2020  data / median.  
-00025430: 2020 2020 2020 7261 7469 6f5f 726f 756e        ratio_roun
-00025440: 6465 6420 3d20 2872 6174 696f 202f 2032  ded = (ratio / 2
-00025450: 3029 2e72 6f75 6e64 2829 202a 2032 3020  0).round() * 20 
-00025460: 2023 2072 6f75 6e64 2072 6174 696f 2074   # round ratio t
-00025470: 6f20 6e65 6172 6573 7420 3230 0a20 2020  o nearest 20.   
-00025480: 2020 2020 2066 203d 2072 6174 696f 5f72       f = ratio_r
-00025490: 6f75 6e64 6564 203d 3d20 3130 300a 2020  ounded == 100.  
-000254a0: 2020 2020 2020 7261 7469 6f5f 7263 7020        ratio_rcp 
-000254b0: 3d20 312e 302f 7261 7469 6f0a 2020 2020  = 1.0/ratio.    
-000254c0: 2020 2020 7261 7469 6f5f 7263 705f 726f      ratio_rcp_ro
-000254d0: 756e 6465 6420 3d20 2872 6174 696f 5f72  unded = (ratio_r
-000254e0: 6370 202f 2032 3029 2e72 6f75 6e64 2829  cp / 20).round()
-000254f0: 202a 2032 3020 2023 2072 6f75 6e64 2072   * 20  # round r
-00025500: 6174 696f 2074 6f20 6e65 6172 6573 7420  atio to nearest 
-00025510: 3230 0a20 2020 2020 2020 2066 5f72 6370  20.        f_rcp
-00025520: 203d 2028 7261 7469 6f5f 726f 756e 6465   = (ratio_rounde
-00025530: 6420 3d3d 2031 3030 2920 7c20 2872 6174  d == 100) | (rat
-00025540: 696f 5f72 6370 5f72 6f75 6e64 6564 203d  io_rcp_rounded =
-00025550: 3d20 3130 3029 0a20 2020 2020 2020 2066  = 100).        f
-00025560: 5f65 6974 6865 7220 3d20 6620 7c20 665f  _either = f | f_
-00025570: 7263 700a 2020 2020 2020 2020 6966 206e  rcp.        if n
-00025580: 6f74 2066 5f65 6974 6865 722e 616e 7928  ot f_either.any(
-00025590: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
-000255a0: 6663 6c2e 5472 6163 6545 7869 7428 6c6f  fcl.TraceExit(lo
-000255b0: 675f 6d73 675f 6578 6974 290a 2020 2020  g_msg_exit).    
-000255c0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-000255d0: 660a 0a20 2020 2020 2020 2023 204d 6172  f..        # Mar
-000255e0: 6b20 7661 6c75 6573 2074 6f20 7365 6e64  k values to send
-000255f0: 2066 6f72 2072 6570 6169 720a 2020 2020   for repair.    
-00025600: 2020 2020 7461 6720 3d20 2d31 2e30 0a20      tag = -1.0. 
-00025610: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00025620: 7261 6e67 6528 6c65 6e28 6461 7461 5f63  range(len(data_c
-00025630: 6f6c 7329 293a 0a20 2020 2020 2020 2020  ols)):.         
-00025640: 2020 2066 6920 3d20 665f 6569 7468 6572     fi = f_either
-00025650: 5b3a 2c20 695d 0a20 2020 2020 2020 2020  [:, i].         
-00025660: 2020 2063 203d 2064 6174 615f 636f 6c73     c = data_cols
-00025670: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
-00025680: 6466 322e 6c6f 635b 6669 2c20 635d 203d  df2.loc[fi, c] =
-00025690: 2074 6167 0a0a 2020 2020 2020 2020 6e5f   tag..        n_
-000256a0: 6265 666f 7265 203d 2028 6466 325f 6461  before = (df2_da
-000256b0: 7461 203d 3d20 7461 6729 2e73 756d 2829  ta == tag).sum()
-000256c0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000256d0: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
-000256e0: 7365 6c66 2e5f 7265 636f 6e73 7472 7563  self._reconstruc
-000256f0: 745f 696e 7465 7276 616c 735f 6261 7463  t_intervals_batc
-00025700: 6828 6466 322c 2074 6167 3d74 6167 290a  h(df2, tag=tag).
-00025710: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00025720: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-00025730: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
-00025740: 662e 5f73 7461 636b 5f74 7261 6365 2920  f._stack_trace) 
-00025750: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00025760: 2020 2020 2073 656c 662e 5f73 7461 636b       self._stack
-00025770: 5f74 7261 6365 2e70 6f70 286c 656e 2873  _trace.pop(len(s
-00025780: 656c 662e 5f73 7461 636b 5f74 7261 6365  elf._stack_trace
-00025790: 2920 2d20 3129 0a20 2020 2020 2020 2020  ) - 1).         
-000257a0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-000257b0: 206e 5f61 6674 6572 203d 2028 6466 325b   n_after = (df2[
-000257c0: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-000257d0: 6d70 7928 2920 3d3d 2074 6167 292e 7375  mpy() == tag).su
-000257e0: 6d28 290a 0a20 2020 2020 2020 2069 6620  m()..        if 
-000257f0: 6e5f 6166 7465 7220 3e20 303a 0a20 2020  n_after > 0:.   
-00025800: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-00025810: 7365 636f 6e64 2070 6173 7320 7769 6c6c  second pass will
-00025820: 202a 6372 7564 656c 792a 2022 6669 7822   *crudely* "fix"
-00025830: 2061 6e79 2072 656d 6169 6e69 6e67 2065   any remaining e
-00025840: 7272 6f72 7320 696e 2048 6967 682f 4c6f  rrors in High/Lo
-00025850: 770a 2020 2020 2020 2020 2020 2020 2320  w.            # 
-00025860: 7369 6d70 6c79 2062 7920 656e 7375 7269  simply by ensuri
-00025870: 6e67 2074 6865 7920 646f 6e27 7420 636f  ng they don't co
-00025880: 6e74 7261 6469 6374 2065 2e67 2e20 4c6f  ntradict e.g. Lo
-00025890: 7720 3d20 3130 3078 2048 6967 682e 0a20  w = 100x High.. 
-000258a0: 2020 2020 2020 2020 2020 2066 203d 2028             f = (
-000258b0: 6466 325b 6461 7461 5f63 6f6c 735d 2e74  df2[data_cols].t
-000258c0: 6f5f 6e75 6d70 7928 2920 3d3d 2074 6167  o_numpy() == tag
-000258d0: 2920 2620 660a 2020 2020 2020 2020 2020  ) & f.          
-000258e0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-000258f0: 2866 2e73 6861 7065 5b30 5d29 3a0a 2020  (f.shape[0]):.  
-00025900: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00025910: 203d 2066 5b69 2c20 3a5d 0a20 2020 2020   = f[i, :].     
-00025920: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00025930: 7420 6669 2e61 6e79 2829 3a0a 2020 2020  t fi.any():.    
-00025940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025950: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00025960: 2020 2020 2020 2020 2069 6478 203d 2064           idx = d
-00025970: 6632 2e69 6e64 6578 5b69 5d0a 0a20 2020  f2.index[i]..   
-00025980: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00025990: 2063 2069 6e20 5b27 4f70 656e 272c 2027   c in ['Open', '
-000259a0: 436c 6f73 6527 5d3a 0a20 2020 2020 2020  Close']:.       
-000259b0: 2020 2020 2020 2020 2020 2020 206a 203d               j =
-000259c0: 2064 6174 615f 636f 6c73 2e69 6e64 6578   data_cols.index
-000259d0: 2863 290a 2020 2020 2020 2020 2020 2020  (c).            
-000259e0: 2020 2020 2020 2020 6966 2066 695b 6a5d          if fi[j]
-000259f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025a00: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
-00025a10: 635b 6964 782c 2063 5d20 3d20 6466 2e6c  c[idx, c] = df.l
-00025a20: 6f63 5b69 6478 2c20 635d 202a 2030 2e30  oc[idx, c] * 0.0
-00025a30: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
-00025a40: 2020 2063 203d 2022 4869 6768 2220 3b20     c = "High" ; 
-00025a50: 6a20 3d20 6461 7461 5f63 6f6c 732e 696e  j = data_cols.in
-00025a60: 6465 7828 6329 0a20 2020 2020 2020 2020  dex(c).         
-00025a70: 2020 2020 2020 2069 6620 6669 5b6a 5d3a         if fi[j]:
-00025a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025a90: 2020 2020 2064 6632 2e6c 6f63 5b69 6478       df2.loc[idx
-00025aa0: 2c20 635d 203d 2064 6632 2e6c 6f63 5b69  , c] = df2.loc[i
-00025ab0: 6478 2c20 5b22 4f70 656e 222c 2022 436c  dx, ["Open", "Cl
-00025ac0: 6f73 6522 5d5d 2e6d 6178 2829 0a0a 2020  ose"]].max()..  
-00025ad0: 2020 2020 2020 2020 2020 2020 2020 6320                c 
-00025ae0: 3d20 224c 6f77 2220 3b20 6a20 3d20 6461  = "Low" ; j = da
-00025af0: 7461 5f63 6f6c 732e 696e 6465 7828 6329  ta_cols.index(c)
-00025b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025b10: 2069 6620 6669 5b6a 5d3a 0a20 2020 2020   if fi[j]:.     
-00025b20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00025b30: 6632 2e6c 6f63 5b69 6478 2c20 635d 203d  f2.loc[idx, c] =
-00025b40: 2064 6632 2e6c 6f63 5b69 6478 2c20 5b22   df2.loc[idx, ["
-00025b50: 4f70 656e 222c 2022 436c 6f73 6522 5d5d  Open", "Close"]]
-00025b60: 2e6d 696e 2829 0a0a 2020 2020 2020 2020  .min()..        
-00025b70: 2020 2020 665f 7263 7020 3d20 2864 6632      f_rcp = (df2
-00025b80: 5b64 6174 615f 636f 6c73 5d2e 746f 5f6e  [data_cols].to_n
-00025b90: 756d 7079 2829 203d 3d20 7461 6729 2026  umpy() == tag) &
-00025ba0: 2066 5f72 6370 0a20 2020 2020 2020 2020   f_rcp.         
-00025bb0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00025bc0: 6528 665f 7263 702e 7368 6170 655b 305d  e(f_rcp.shape[0]
-00025bd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00025be0: 2020 2066 6920 3d20 665f 7263 705b 692c     fi = f_rcp[i,
-00025bf0: 203a 5d0a 2020 2020 2020 2020 2020 2020   :].            
-00025c00: 2020 2020 6966 206e 6f74 2066 692e 616e      if not fi.an
-00025c10: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-00025c20: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00025c30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00025c40: 2020 6964 7820 3d20 6466 322e 696e 6465    idx = df2.inde
-00025c50: 785b 695d 0a0a 2020 2020 2020 2020 2020  x[i]..          
-00025c60: 2020 2020 2020 666f 7220 6320 696e 205b        for c in [
-00025c70: 274f 7065 6e27 2c20 2743 6c6f 7365 275d  'Open', 'Close']
-00025c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025c90: 2020 2020 2020 6a20 3d20 6461 7461 5f63        j = data_c
-00025ca0: 6f6c 732e 696e 6465 7828 6329 0a20 2020  ols.index(c).   
-00025cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025cc0: 2069 6620 6669 5b6a 5d3a 0a20 2020 2020   if fi[j]:.     
-00025cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ce0: 2020 2064 6632 2e6c 6f63 5b69 6478 2c20     df2.loc[idx, 
-00025cf0: 635d 203d 2064 662e 6c6f 635b 6964 782c  c] = df.loc[idx,
-00025d00: 2063 5d20 2a20 3130 302e 300a 0a20 2020   c] * 100.0..   
-00025d10: 2020 2020 2020 2020 2020 2020 2063 203d               c =
-00025d20: 2022 4869 6768 2220 3b20 6a20 3d20 6461   "High" ; j = da
-00025d30: 7461 5f63 6f6c 732e 696e 6465 7828 6329  ta_cols.index(c)
-00025d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025d50: 2069 6620 6669 5b6a 5d3a 0a20 2020 2020   if fi[j]:.     
-00025d60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00025d70: 6632 2e6c 6f63 5b69 6478 2c20 635d 203d  f2.loc[idx, c] =
-00025d80: 2064 6632 2e6c 6f63 5b69 6478 2c20 5b22   df2.loc[idx, ["
-00025d90: 4f70 656e 222c 2022 436c 6f73 6522 5d5d  Open", "Close"]]
-00025da0: 2e6d 6178 2829 0a0a 2020 2020 2020 2020  .max()..        
-00025db0: 2020 2020 2020 2020 6320 3d20 224c 6f77          c = "Low
-00025dc0: 2220 3b20 6a20 3d20 6461 7461 5f63 6f6c  " ; j = data_col
-00025dd0: 732e 696e 6465 7828 6329 0a20 2020 2020  s.index(c).     
-00025de0: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
-00025df0: 5b6a 5d3a 0a20 2020 2020 2020 2020 2020  [j]:.           
-00025e00: 2020 2020 2020 2020 2064 6632 2e6c 6f63           df2.loc
-00025e10: 5b69 6478 2c20 635d 203d 2064 6632 2e6c  [idx, c] = df2.l
-00025e20: 6f63 5b69 6478 2c20 5b22 4f70 656e 222c  oc[idx, ["Open",
-00025e30: 2022 436c 6f73 6522 5d5d 2e6d 696e 2829   "Close"]].min()
-00025e40: 0a0a 2020 2020 2020 2020 6e5f 6166 7465  ..        n_afte
-00025e50: 725f 6372 7564 6520 3d20 2864 6632 5b64  r_crude = (df2[d
-00025e60: 6174 615f 636f 6c73 5d2e 746f 5f6e 756d  ata_cols].to_num
-00025e70: 7079 2829 203d 3d20 7461 6729 2e73 756d  py() == tag).sum
-00025e80: 2829 0a0a 2020 2020 2020 2020 6e5f 6669  ()..        n_fi
-00025e90: 7865 6420 3d20 6e5f 6265 666f 7265 202d  xed = n_before -
-00025ea0: 206e 5f61 6674 6572 5f63 7275 6465 0a20   n_after_crude. 
-00025eb0: 2020 2020 2020 206e 5f66 6978 6564 5f63         n_fixed_c
-00025ec0: 7275 6465 6c79 203d 206e 5f61 6674 6572  rudely = n_after
-00025ed0: 202d 206e 5f61 6674 6572 5f63 7275 6465   - n_after_crude
-00025ee0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00025ef0: 7369 6c65 6e74 2061 6e64 206e 5f66 6978  silent and n_fix
-00025f00: 6564 203e 2030 3a0a 2020 2020 2020 2020  ed > 0:.        
-00025f10: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
-00025f20: 2066 227b 7365 6c66 2e74 6963 6b65 727d   f"{self.ticker}
-00025f30: 3a20 6669 7865 6420 7b6e 5f66 6978 6564  : fixed {n_fixed
-00025f40: 7d2f 7b6e 5f62 6566 6f72 657d 2063 7572  }/{n_before} cur
-00025f50: 7265 6e63 7920 756e 6974 206d 6978 7570  rency unit mixup
-00025f60: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
-00025f70: 6966 206e 5f66 6978 6564 5f63 7275 6465  if n_fixed_crude
-00025f80: 6c79 203e 2030 3a0a 2020 2020 2020 2020  ly > 0:.        
-00025f90: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
-00025fa0: 7367 202b 3d20 6622 287b 6e5f 6669 7865  sg += f"({n_fixe
-00025fb0: 645f 6372 7564 656c 797d 2063 7275 6465  d_crudely} crude
-00025fc0: 6c79 2920 220a 2020 2020 2020 2020 2020  ly) ".          
-00025fd0: 2020 7265 706f 7274 5f6d 7367 202b 3d20    report_msg += 
-00025fe0: 6622 696e 207b 7365 6c66 2e69 6e74 6572  f"in {self.inter
-00025ff0: 7661 6c7d 2070 7269 6365 2064 6174 6122  val} price data"
-00026000: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00026010: 6e74 2872 6570 6f72 745f 6d73 6729 0a0a  nt(report_msg)..
-00026020: 2020 2020 2020 2020 2320 5265 7374 6f72          # Restor
-00026030: 6520 6f72 6967 696e 616c 2076 616c 7565  e original value
-00026040: 7320 7768 6572 6520 7265 7061 6972 2066  s where repair f
-00026050: 6169 6c65 640a 2020 2020 2020 2020 665f  ailed.        f_
-00026060: 6569 7468 6572 203d 2064 6632 5b64 6174  either = df2[dat
-00026070: 615f 636f 6c73 5d2e 746f 5f6e 756d 7079  a_cols].to_numpy
-00026080: 2829 203d 3d20 7461 670a 2020 2020 2020  () == tag.      
-00026090: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
-000260a0: 286c 656e 2864 6174 615f 636f 6c73 2929  (len(data_cols))
-000260b0: 3a0a 2020 2020 2020 2020 2020 2020 666a  :.            fj
-000260c0: 203d 2066 5f65 6974 6865 725b 3a2c 206a   = f_either[:, j
-000260d0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-000260e0: 2066 6a2e 616e 7928 293a 0a20 2020 2020   fj.any():.     
-000260f0: 2020 2020 2020 2020 2020 2063 203d 2064             c = d
-00026100: 6174 615f 636f 6c73 5b6a 5d0a 2020 2020  ata_cols[j].    
-00026110: 2020 2020 2020 2020 2020 2020 6466 322e              df2.
-00026120: 6c6f 635b 666a 2c20 635d 203d 2064 662e  loc[fj, c] = df.
-00026130: 6c6f 635b 666a 2c20 635d 0a20 2020 2020  loc[fj, c].     
-00026140: 2020 2069 6620 6466 325f 7a65 726f 6573     if df2_zeroes
-00026150: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00026160: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
-00026170: 7064 2e63 6f6e 6361 7428 5b64 6632 2c20  pd.concat([df2, 
-00026180: 6466 325f 7a65 726f 6573 5d29 2e73 6f72  df2_zeroes]).sor
-00026190: 745f 696e 6465 7828 290a 2020 2020 2020  t_index().      
-000261a0: 2020 2020 2020 6466 322e 696e 6465 7820        df2.index 
-000261b0: 3d20 7064 2e74 6f5f 6461 7465 7469 6d65  = pd.to_datetime
-000261c0: 2829 0a0a 2020 2020 2020 2020 7966 636c  ()..        yfcl
-000261d0: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
-000261e0: 7367 5f65 7869 7429 0a0a 2020 2020 2020  sg_exit)..      
-000261f0: 2020 7265 7475 726e 2064 6632 0a0a 2020    return df2..  
-00026200: 2020 6465 6620 5f66 6978 556e 6974 5377    def _fixUnitSw
-00026210: 6974 6368 2873 656c 662c 2064 6629 3a0a  itch(self, df):.
-00026220: 2020 2020 2020 2020 2320 536f 6d65 7469          # Someti
-00026230: 6d65 7320 5961 686f 6f20 7265 7475 726e  mes Yahoo return
-00026240: 7320 6665 7720 7072 6963 6573 2069 6e20  s few prices in 
-00026250: 6365 6e74 732f 7065 6e63 6520 696e 7374  cents/pence inst
-00026260: 6561 6420 6f66 2024 2fc2 a30a 2020 2020  ead of $/...    
-00026270: 2020 2020 2320 492e 652e 2031 3030 7820      # I.e. 100x 
-00026280: 6269 6767 6572 0a20 2020 2020 2020 2023  bigger.        #
-00026290: 2032 2077 6179 7320 7468 6973 206d 616e   2 ways this man
-000262a0: 6966 6573 7473 3a0a 2020 2020 2020 2020  ifests:.        
-000262b0: 2320 2d20 7261 6e64 6f6d 2031 3030 7820  # - random 100x 
-000262c0: 6572 726f 7273 2073 7072 6561 6420 7468  errors spread th
-000262d0: 726f 7567 686f 7574 2074 6162 6c65 0a20  roughout table. 
-000262e0: 2020 2020 2020 2023 202d 2061 2073 7564         # - a sud
-000262f0: 6465 6e20 7377 6974 6368 2062 6574 7765  den switch betwe
-00026300: 656e 2024 3c2d 3e63 656e 7473 2061 7420  en $<->cents at 
-00026310: 736f 6d65 2064 6174 650a 2020 2020 2020  some date.      
-00026320: 2020 2320 5468 6973 2066 756e 6374 696f    # This functio
-00026330: 6e20 6669 7865 7320 7468 6520 7365 636f  n fixes the seco
-00026340: 6e64 2e0a 2020 2020 2020 2020 2320 4576  nd..        # Ev
-00026350: 656e 7475 616c 6c79 2059 6168 6f6f 2066  entually Yahoo f
-00026360: 6978 6573 2062 7574 2063 6f75 6c64 2074  ixes but could t
-00026370: 616b 6520 7468 656d 2032 2077 6565 6b73  ake them 2 weeks
-00026380: 2e0a 0a20 2020 2020 2020 2072 6574 7572  ...        retur
-00026390: 6e20 7365 6c66 2e5f 6669 7850 7269 6365  n self._fixPrice
-000263a0: 7353 7564 6465 6e43 6861 6e67 6528 6466  sSuddenChange(df
-000263b0: 2c20 3130 302e 3029 0a0a 2020 2020 6465  , 100.0)..    de
-000263c0: 6620 5f66 6978 4261 6453 746f 636b 5370  f _fixBadStockSp
-000263d0: 6c69 7428 7365 6c66 2c20 6466 293a 0a20  lit(self, df):. 
-000263e0: 2020 2020 2020 2023 2052 6570 6169 7220         # Repair 
-000263f0: 6964 6561 2069 7320 746f 206c 6f6f 6b20  idea is to look 
-00026400: 666f 7220 4249 4720 6461 696c 7920 7072  for BIG daily pr
-00026410: 6963 6520 6368 616e 6765 7320 7468 6174  ice changes that
-00026420: 2063 6c6f 7365 6c79 206d 6174 6368 2074   closely match t
-00026430: 6865 0a20 2020 2020 2020 2023 206d 6f73  he.        # mos
-00026440: 7420 7265 6365 6e74 2073 746f 636b 2073  t recent stock s
-00026450: 706c 6974 2072 6174 696f 2e20 5468 6973  plit ratio. This
-00026460: 2069 6e64 6963 6174 6573 2059 6168 6f6f   indicates Yahoo
-00026470: 2066 6169 6c65 6420 746f 2061 7070 6c79   failed to apply
-00026480: 2061 206e 6577 0a20 2020 2020 2020 2023   a new.        #
-00026490: 2073 746f 636b 2073 706c 6974 2074 6f20   stock split to 
-000264a0: 6f6c 6420 7072 6963 6520 6461 7461 2e0a  old price data..
-000264b0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-000264c0: 2020 2320 5468 6572 6520 6973 2061 2073    # There is a s
-000264d0: 6c69 6768 7420 636f 6d70 6c69 6361 7469  light complicati
-000264e0: 6f6e 2c20 6265 6361 7573 6520 5961 686f  on, because Yaho
-000264f0: 6f20 646f 6573 2061 6e6f 7468 6572 2073  o does another s
-00026500: 7475 7069 6420 7468 696e 672e 0a20 2020  tupid thing..   
-00026510: 2020 2020 2023 2053 6f6d 6574 696d 6573       # Sometimes
-00026520: 2074 6865 206f 6c64 2064 6174 6120 6973   the old data is
-00026530: 2061 646a 7573 7465 6420 7477 6963 652e   adjusted twice.
-00026540: 2053 6f20 6361 6e6e 6f74 2073 696d 706c   So cannot simpl
-00026550: 7920 6173 7375 6d65 200a 2020 2020 2020  y assume .      
-00026560: 2020 2320 7768 6963 6820 6469 7265 6374    # which direct
-00026570: 696f 6e20 746f 2072 6576 6572 7365 2061  ion to reverse a
-00026580: 646a 7573 746d 656e 7420 2d20 6861 7665  djustment - have
-00026590: 2074 6f20 616e 616c 7973 6520 7072 6963   to analyse pric
-000265a0: 6573 2061 6e64 2064 6574 6563 742e 200a  es and detect. .
-000265b0: 2020 2020 2020 2020 2320 4e6f 7420 6469          # Not di
-000265c0: 6666 6963 756c 742e 0a0a 2020 2020 2020  fficult...      
-000265d0: 2020 6966 206e 6f74 2073 656c 662e 696e    if not self.in
-000265e0: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
-000265f0: 2020 2020 7265 7475 726e 2064 660a 0a20      return df.. 
-00026600: 2020 2020 2020 2023 2046 696e 6420 7468         # Find th
-00026610: 6520 6d6f 7374 2072 6563 656e 7420 7374  e most recent st
-00026620: 6f63 6b20 7370 6c69 740a 2020 2020 2020  ock split.      
-00026630: 2020 6466 3220 3d20 6466 2e73 6f72 745f    df2 = df.sort_
-00026640: 696e 6465 7828 6173 6365 6e64 696e 673d  index(ascending=
-00026650: 4661 6c73 6529 0a20 2020 2020 2020 2073  False).        s
-00026660: 706c 6974 5f66 203d 2064 6632 5b27 5374  plit_f = df2['St
-00026670: 6f63 6b20 5370 6c69 7473 275d 2e74 6f5f  ock Splits'].to_
-00026680: 6e75 6d70 7928 2920 213d 2030 0a20 2020  numpy() != 0.   
-00026690: 2020 2020 2069 6620 6e6f 7420 7370 6c69       if not spli
-000266a0: 745f 662e 616e 7928 293a 0a20 2020 2020  t_f.any():.     
-000266b0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-000266c0: 0a20 2020 2020 2020 206d 6f73 745f 7265  .        most_re
-000266d0: 6365 6e74 5f73 706c 6974 5f64 6179 203d  cent_split_day =
-000266e0: 2064 6632 2e69 6e64 6578 5b73 706c 6974   df2.index[split
-000266f0: 5f66 5d2e 6d61 7828 290a 2020 2020 2020  _f].max().      
-00026700: 2020 6966 206d 6f73 745f 7265 6365 6e74    if most_recent
-00026710: 5f73 706c 6974 5f64 6179 203d 3d20 6466  _split_day == df
-00026720: 322e 696e 6465 785b 305d 3a0a 2020 2020  2.index[0]:.    
-00026730: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00026740: 660a 2020 2020 2020 2020 7370 6c69 7420  f.        split 
-00026750: 3d20 6466 322e 6c6f 635b 6d6f 7374 5f72  = df2.loc[most_r
-00026760: 6563 656e 745f 7370 6c69 745f 6461 792c  ecent_split_day,
-00026770: 2027 5374 6f63 6b20 5370 6c69 7473 275d   'Stock Splits']
-00026780: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00026790: 7365 6c66 2e5f 6669 7850 7269 6365 7353  self._fixPricesS
-000267a0: 7564 6465 6e43 6861 6e67 6528 6466 2c20  uddenChange(df, 
-000267b0: 7370 6c69 742c 2063 6f72 7265 6374 5f76  split, correct_v
-000267c0: 6f6c 756d 653d 5472 7565 290a 0a20 2020  olume=True)..   
-000267d0: 2064 6566 205f 6669 7850 7269 6365 7353   def _fixPricesS
-000267e0: 7564 6465 6e43 6861 6e67 6528 7365 6c66  uddenChange(self
-000267f0: 2c20 6466 2c20 6368 616e 6765 2c20 636f  , df, change, co
-00026800: 7272 6563 745f 766f 6c75 6d65 3d46 616c  rrect_volume=Fal
-00026810: 7365 293a 0a20 2020 2020 2020 206c 6f67  se):.        log
-00026820: 5f66 756e 6320 3d20 6622 504d 3a3a 5f66  _func = f"PM::_f
-00026830: 6978 5072 6963 6573 5375 6464 656e 4368  ixPricesSuddenCh
-00026840: 616e 6765 2d7b 7365 6c66 2e69 7374 727d  ange-{self.istr}
-00026850: 2863 6861 6e67 653d 7b63 6861 6e67 653a  (change={change:
-00026860: 2e32 667d 2922 0a20 2020 2020 2020 2079  .2f})".        y
-00026870: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
-00026880: 6f67 5f66 756e 6329 0a0a 2020 2020 2020  og_func)..      
-00026890: 2020 6466 3220 3d20 6466 2e73 6f72 745f    df2 = df.sort_
-000268a0: 696e 6465 7828 6173 6365 6e64 696e 673d  index(ascending=
-000268b0: 4661 6c73 6529 0a20 2020 2020 2020 2073  False).        s
-000268c0: 706c 6974 203d 2063 6861 6e67 650a 2020  plit = change.  
-000268d0: 2020 2020 2020 7370 6c69 745f 7263 7020        split_rcp 
-000268e0: 3d20 312e 3020 2f20 7370 6c69 740a 0a20  = 1.0 / split.. 
-000268f0: 2020 2020 2020 2069 6620 6368 616e 6765         if change
-00026900: 2069 6e20 5b31 3030 2e30 2c20 302e 3031   in [100.0, 0.01
-00026910: 5d3a 0a20 2020 2020 2020 2020 2020 2066  ]:.            f
-00026920: 6978 5f74 7970 6520 3d20 2731 3030 7820  ix_type = '100x 
-00026930: 6572 726f 7227 0a20 2020 2020 2020 2020  error'.         
-00026940: 2020 2073 7461 7274 5f6d 696e 203d 204e     start_min = N
-00026950: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
-00026960: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00026970: 785f 7479 7065 203d 2027 6261 6420 7370  x_type = 'bad sp
-00026980: 6c69 7427 0a20 2020 2020 2020 2020 2020  lit'.           
-00026990: 2066 203d 2064 6632 5b27 5374 6f63 6b20   f = df2['Stock 
-000269a0: 5370 6c69 7473 275d 2e74 6f5f 6e75 6d70  Splits'].to_nump
-000269b0: 7928 2920 213d 2030 2e30 0a20 2020 2020  y() != 0.0.     
-000269c0: 2020 2020 2020 2073 7461 7274 5f6d 696e         start_min
-000269d0: 203d 2028 6466 322e 696e 6465 785b 665d   = (df2.index[f]
-000269e0: 2e6d 696e 2829 202d 2064 6174 6575 7469  .min() - dateuti
-000269f0: 6c2e 7265 6c61 7469 7665 6465 6c74 612e  l.relativedelta.
-00026a00: 7265 6c61 7469 7665 6465 6c74 6128 7965  relativedelta(ye
-00026a10: 6172 733d 3129 292e 6461 7465 2829 0a0a  ars=1)).date()..
-00026a20: 2020 2020 2020 2020 4f48 4c43 203d 205b          OHLC = [
-00026a30: 274f 7065 6e27 2c20 2748 6967 6827 2c20  'Open', 'High', 
-00026a40: 274c 6f77 272c 2027 436c 6f73 6527 5d0a  'Low', 'Close'].
-00026a50: 0a20 2020 2020 2020 2023 2044 6f20 6e6f  .        # Do no
-00026a60: 7420 6174 7465 6d70 7420 7265 7061 6972  t attempt repair
-00026a70: 206f 6620 7468 6520 7370 6c69 7420 6973   of the split is
-00026a80: 2073 6d61 6c6c 2c20 0a20 2020 2020 2020   small, .       
-00026a90: 2023 2063 6f75 6c64 2062 6520 6d69 7374   # could be mist
-00026aa0: 616b 656e 2066 6f72 206e 6f72 6d61 6c20  aken for normal 
-00026ab0: 7072 6963 6520 7661 7269 616e 6365 0a20  price variance. 
-00026ac0: 2020 2020 2020 2069 6620 302e 3820 3c20         if 0.8 < 
-00026ad0: 7370 6c69 7420 3c20 312e 3235 3a0a 2020  split < 1.25:.  
-00026ae0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00026af0: 7261 6365 4578 6974 286c 6f67 5f66 756e  raceExit(log_fun
-00026b00: 6320 2b20 223a 2061 626f 7274 696e 672c  c + ": aborting,
-00026b10: 2073 706c 6974 2074 6f6f 206e 6561 7220   split too near 
-00026b20: 312e 3022 290a 2020 2020 2020 2020 2020  1.0").          
-00026b30: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
-00026b40: 2020 2020 206e 203d 2064 6632 2e73 6861       n = df2.sha
-00026b50: 7065 5b30 5d0a 0a20 2020 2020 2020 2064  pe[0]..        d
-00026b60: 665f 6465 6275 6720 3d20 6466 322e 636f  f_debug = df2.co
-00026b70: 7079 2829 0a20 2020 2020 2020 2064 665f  py().        df_
-00026b80: 6465 6275 6720 3d20 6466 5f64 6562 7567  debug = df_debug
-00026b90: 2e64 726f 7028 5b27 566f 6c75 6d65 272c  .drop(['Volume',
-00026ba0: 2027 4469 7669 6465 6e64 7327 2c20 2752   'Dividends', 'R
-00026bb0: 6570 6169 7265 643f 275d 2c20 6178 6973  epaired?'], axis
-00026bc0: 3d31 2c20 6572 726f 7273 3d27 6967 6e6f  =1, errors='igno
-00026bd0: 7265 2729 0a20 2020 2020 2020 2064 665f  re').        df_
-00026be0: 6465 6275 6720 3d20 6466 5f64 6562 7567  debug = df_debug
-00026bf0: 2e64 726f 7028 5b27 4344 4627 2c20 2743  .drop(['CDF', 'C
-00026c00: 5346 272c 2027 432d 4368 6563 6b3f 272c  SF', 'C-Check?',
-00026c10: 2027 4c61 7374 4469 7641 646a 7573 7444   'LastDivAdjustD
-00026c20: 7427 2c20 274c 6173 7453 706c 6974 4164  t', 'LastSplitAd
-00026c30: 6a75 7374 4474 275d 2c20 6178 6973 3d31  justDt'], axis=1
-00026c40: 2c20 6572 726f 7273 3d27 6967 6e6f 7265  , errors='ignore
-00026c50: 2729 0a20 2020 2020 2020 2064 6562 7567  ').        debug
-00026c60: 5f63 6f6c 7320 3d20 5b27 4f70 656e 272c  _cols = ['Open',
-00026c70: 2027 436c 6f73 6527 5d0a 2020 2020 2020   'Close'].      
-00026c80: 2020 6466 5f64 6562 7567 203d 2064 665f    df_debug = df_
-00026c90: 6465 6275 672e 6472 6f70 285b 6320 666f  debug.drop([c fo
-00026ca0: 7220 6320 696e 204f 484c 4320 6966 2063  r c in OHLC if c
-00026cb0: 206e 6f74 2069 6e20 6465 6275 675f 636f   not in debug_co
-00026cc0: 6c73 5d2c 2061 7869 733d 312c 2065 7272  ls], axis=1, err
-00026cd0: 6f72 733d 2769 676e 6f72 6527 290a 0a20  ors='ignore').. 
-00026ce0: 2020 2020 2020 2023 2043 616c 6375 6c61         # Calcula
-00026cf0: 7465 2064 6169 6c79 2070 7269 6365 2025  te daily price %
-00026d00: 2063 6861 6e67 652e 2054 6f20 7265 6475   change. To redu
-00026d10: 6365 2065 6666 6563 7420 6f66 2070 7269  ce effect of pri
-00026d20: 6365 2076 6f6c 6174 696c 6974 792c 200a  ce volatility, .
-00026d30: 2020 2020 2020 2020 2320 6361 6c63 756c          # calcul
-00026d40: 6174 6520 6368 616e 6765 2066 6f72 2065  ate change for e
-00026d50: 6163 6820 4f48 4c43 2063 6f6c 756d 6e2e  ach OHLC column.
-00026d60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00026d70: 2e69 6e74 6572 6461 7920 616e 6420 7365  .interday and se
-00026d80: 6c66 2e69 6e74 6572 7661 6c20 213d 2079  lf.interval != y
-00026d90: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-00026da0: 7331 2061 6e64 2073 706c 6974 206e 6f74  s1 and split not
-00026db0: 2069 6e20 5b31 3030 2e30 2c20 3130 302c   in [100.0, 100,
-00026dc0: 2030 2e30 3031 5d3a 0a20 2020 2020 2020   0.001]:.       
-00026dd0: 2020 2020 2023 2041 766f 6964 2075 7369       # Avoid usi
-00026de0: 6e67 2027 4c6f 7727 2061 6e64 2027 4869  ng 'Low' and 'Hi
-00026df0: 6768 272e 2046 6f72 206d 756c 7469 6461  gh'. For multida
-00026e00: 7920 696e 7465 7276 616c 732c 2074 6865  y intervals, the
-00026e10: 7365 2063 616e 2062 6520 0a20 2020 2020  se can be .     
-00026e20: 2020 2020 2020 2023 2076 6572 7920 766f         # very vo
-00026e30: 6c61 7469 6c65 2073 6f20 7265 6475 6365  latile so reduce
-00026e40: 2061 6269 6c69 7479 2074 6f20 6465 7465   ability to dete
-00026e50: 6374 2067 656e 7569 6e65 2073 746f 636b  ct genuine stock
-00026e60: 2073 706c 6974 2065 7272 6f72 730a 2020   split errors.  
-00026e70: 2020 2020 2020 2020 2020 5f31 645f 6368            _1d_ch
-00026e80: 616e 6765 5f78 203d 206e 702e 6675 6c6c  ange_x = np.full
-00026e90: 2828 6e2c 2032 292c 2031 2e30 290a 2020  ((n, 2), 1.0).  
-00026ea0: 2020 2020 2020 2020 2020 7072 6963 655f            price_
-00026eb0: 6461 7461 203d 2064 6632 5b5b 274f 7065  data = df2[['Ope
-00026ec0: 6e27 2c27 436c 6f73 6527 5d5d 2e74 6f5f  n','Close']].to_
-00026ed0: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-00026ee0: 2020 2020 665f 7a65 726f 203d 2070 7269      f_zero = pri
-00026ef0: 6365 5f64 6174 6120 3d3d 2030 2e30 0a20  ce_data == 0.0. 
-00026f00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00026f10: 2020 2020 2020 2020 205f 3164 5f63 6861           _1d_cha
-00026f20: 6e67 655f 7820 3d20 6e70 2e66 756c 6c28  nge_x = np.full(
-00026f30: 286e 2c20 3429 2c20 312e 3029 0a20 2020  (n, 4), 1.0).   
-00026f40: 2020 2020 2020 2020 2070 7269 6365 5f64           price_d
-00026f50: 6174 6120 3d20 6466 325b 4f48 4c43 5d2e  ata = df2[OHLC].
-00026f60: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-00026f70: 2020 2020 2020 2066 5f7a 6572 6f20 3d20         f_zero = 
-00026f80: 7072 6963 655f 6461 7461 203d 3d20 302e  price_data == 0.
-00026f90: 300a 2020 2020 2020 2020 6966 2066 5f7a  0.        if f_z
-00026fa0: 6572 6f2e 616e 7928 293a 0a20 2020 2020  ero.any():.     
-00026fb0: 2020 2020 2020 2070 7269 6365 5f64 6174         price_dat
-00026fc0: 615b 665f 7a65 726f 5d20 3d20 312e 300a  a[f_zero] = 1.0.
-00026fd0: 0a20 2020 2020 2020 2023 2055 7064 6174  .        # Updat
-00026fe0: 653a 2069 6620 6120 5645 5259 206c 6172  e: if a VERY lar
-00026ff0: 6765 2064 6976 6964 656e 6420 6973 2070  ge dividend is p
-00027000: 6169 6420 6f75 742c 2074 6865 6e20 6361  aid out, then ca
-00027010: 6e20 6265 206d 6973 7461 6b65 6e20 666f  n be mistaken fo
-00027020: 7220 6120 313a 3220 7374 6f63 6b20 7370  r a 1:2 stock sp
-00027030: 6c69 742e 0a20 2020 2020 2020 2023 2046  lit..        # F
-00027040: 6978 203d 2075 7365 2061 646a 7573 7465  ix = use adjuste
-00027050: 6420 7072 6963 6573 0a20 2020 2020 2020  d prices.       
-00027060: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
-00027070: 7072 6963 655f 6461 7461 2e73 6861 7065  price_data.shape
-00027080: 5b31 5d29 3a0a 2020 2020 2020 2020 2020  [1]):.          
-00027090: 2020 7072 6963 655f 6461 7461 5b3a 2c6a    price_data[:,j
-000270a0: 5d20 2a3d 2064 6632 5b27 4344 4627 5d0a  ] *= df2['CDF'].
-000270b0: 0a20 2020 2020 2020 205f 3164 5f63 6861  .        _1d_cha
-000270c0: 6e67 655f 785b 313a 5d20 3d20 7072 6963  nge_x[1:] = pric
-000270d0: 655f 6461 7461 5b31 3a2c 205d 202f 2070  e_data[1:, ] / p
-000270e0: 7269 6365 5f64 6174 615b 3a2d 312c 205d  rice_data[:-1, ]
-000270f0: 0a20 2020 2020 2020 2066 5f7a 6572 6f5f  .        f_zero_
-00027100: 6e75 6d5f 6465 6e6f 6d20 3d20 665f 7a65  num_denom = f_ze
-00027110: 726f 207c 206e 702e 726f 6c6c 2866 5f7a  ro | np.roll(f_z
-00027120: 6572 6f2c 2031 2c20 6178 6973 3d30 290a  ero, 1, axis=0).
-00027130: 2020 2020 2020 2020 6966 2066 5f7a 6572          if f_zer
-00027140: 6f5f 6e75 6d5f 6465 6e6f 6d2e 616e 7928  o_num_denom.any(
-00027150: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
-00027160: 3164 5f63 6861 6e67 655f 785b 665f 7a65  1d_change_x[f_ze
-00027170: 726f 5f6e 756d 5f64 656e 6f6d 5d20 3d20  ro_num_denom] = 
-00027180: 312e 300a 2020 2020 2020 2020 6966 2073  1.0.        if s
-00027190: 656c 662e 696e 7465 7264 6179 2061 6e64  elf.interday and
-000271a0: 2073 656c 662e 696e 7465 7276 616c 2021   self.interval !
-000271b0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-000271c0: 4461 7973 313a 0a20 2020 2020 2020 2020  Days1:.         
-000271d0: 2020 2023 2061 7665 7261 6765 2063 6861     # average cha
-000271e0: 6e67 650a 2020 2020 2020 2020 2020 2020  nge.            
-000271f0: 5f31 645f 6368 616e 6765 5f6d 696e 7820  _1d_change_minx 
-00027200: 3d20 6e70 2e61 7665 7261 6765 285f 3164  = np.average(_1d
-00027210: 5f63 6861 6e67 655f 782c 2061 7869 733d  _change_x, axis=
-00027220: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
-00027230: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00027240: 6861 6e67 6520 6e65 6172 6573 7420 746f  hange nearest to
-00027250: 2031 2e30 0a20 2020 2020 2020 2020 2020   1.0.           
-00027260: 2064 6966 6620 3d20 6e70 2e61 6273 285f   diff = np.abs(_
-00027270: 3164 5f63 6861 6e67 655f 7820 2d20 312e  1d_change_x - 1.
-00027280: 3029 0a20 2020 2020 2020 2020 2020 206a  0).            j
-00027290: 5f69 6e64 6963 6573 203d 206e 702e 6172  _indices = np.ar
-000272a0: 676d 696e 2864 6966 662c 2061 7869 733d  gmin(diff, axis=
-000272b0: 3129 0a20 2020 2020 2020 2020 2020 205f  1).            _
-000272c0: 3164 5f63 6861 6e67 655f 6d69 6e78 203d  1d_change_minx =
-000272d0: 205f 3164 5f63 6861 6e67 655f 785b 6e70   _1d_change_x[np
-000272e0: 2e61 7261 6e67 6528 6e29 2c20 6a5f 696e  .arange(n), j_in
-000272f0: 6469 6365 735d 0a20 2020 2020 2020 2066  dices].        f
-00027300: 5f6e 6120 3d20 6e70 2e69 736e 616e 285f  _na = np.isnan(_
-00027310: 3164 5f63 6861 6e67 655f 6d69 6e78 290a  1d_change_minx).
-00027320: 2020 2020 2020 2020 6966 2066 5f6e 612e          if f_na.
-00027330: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-00027340: 2020 2023 2050 6f73 7369 626c 6520 6966     # Possible if
-00027350: 2064 6174 6120 7761 7320 746f 6f20 6f6c   data was too ol
-00027360: 6420 666f 7220 7265 636f 6e73 7472 7563  d for reconstruc
-00027370: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
-00027380: 2020 5f31 645f 6368 616e 6765 5f6d 696e    _1d_change_min
-00027390: 785b 665f 6e61 5d20 3d20 312e 300a 2020  x[f_na] = 1.0.  
-000273a0: 2020 2020 2020 6466 5f64 6562 7567 5b27        df_debug['
-000273b0: 3144 2063 6861 6e67 6520 5827 5d20 3d20  1D change X'] = 
-000273c0: 5f31 645f 6368 616e 6765 5f6d 696e 780a  _1d_change_minx.
-000273d0: 2020 2020 2020 2020 6466 5f64 6562 7567          df_debug
-000273e0: 5b27 3144 2063 6861 6e67 6520 5827 5d20  ['1D change X'] 
-000273f0: 3d20 6466 5f64 6562 7567 5b27 3144 2063  = df_debug['1D c
-00027400: 6861 6e67 6520 5827 5d2e 726f 756e 6428  hange X'].round(
-00027410: 3229 2e61 7374 7970 6528 2773 7472 2729  2).astype('str')
-00027420: 0a0a 2020 2020 2020 2020 2320 4966 2061  ..        # If a
-00027430: 6c6c 2031 4420 6368 616e 6765 7320 6172  ll 1D changes ar
-00027440: 6520 636c 6f73 6572 2074 6f20 312e 3020  e closer to 1.0 
-00027450: 7468 616e 2073 706c 6974 2c20 6578 6974  than split, exit
-00027460: 0a20 2020 2020 2020 2073 706c 6974 5f6d  .        split_m
-00027470: 6178 203d 206d 6178 2873 706c 6974 2c20  ax = max(split, 
-00027480: 7370 6c69 745f 7263 7029 0a20 2020 2020  split_rcp).     
-00027490: 2020 2069 6620 6e70 2e6d 6178 285f 3164     if np.max(_1d
-000274a0: 5f63 6861 6e67 655f 6d69 6e78 2920 3c20  _change_minx) < 
-000274b0: 2873 706c 6974 5f6d 6178 202d 2031 2920  (split_max - 1) 
-000274c0: 2a20 302e 3520 2b20 3120 616e 6420 6e70  * 0.5 + 1 and np
-000274d0: 2e6d 696e 285f 3164 5f63 6861 6e67 655f  .min(_1d_change_
-000274e0: 6d69 6e78 2920 3e20 312e 3020 2f20 2828  minx) > 1.0 / ((
-000274f0: 7370 6c69 745f 6d61 7820 2d20 3129 202a  split_max - 1) *
-00027500: 2030 2e35 202b 2031 293a 0a20 2020 2020   0.5 + 1):.     
-00027510: 2020 2020 2020 2072 6561 736f 6e20 3d20         reason = 
-00027520: 2263 6861 6e67 6573 2074 6f6f 206e 6561  "changes too nea
-00027530: 7220 312e 3022 0a20 2020 2020 2020 2020  r 1.0".         
-00027540: 2020 2072 6561 736f 6e20 2b3d 2066 2220     reason += f" 
-00027550: 285f 3164 5f63 6861 6e67 655f 6d69 6e78  (_1d_change_minx
-00027560: 203d 207b 6e70 2e6d 696e 285f 3164 5f63   = {np.min(_1d_c
-00027570: 6861 6e67 655f 6d69 6e78 293a 2e32 667d  hange_minx):.2f}
-00027580: 202d 3e20 7b6e 702e 6d61 7828 5f31 645f   -> {np.max(_1d_
-00027590: 6368 616e 6765 5f6d 696e 7829 3a2e 3266  change_minx):.2f
-000275a0: 7d29 220a 2020 2020 2020 2020 2020 2020  })".            
-000275b0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-000275c0: 7265 6173 6f6e 290a 2020 2020 2020 2020  reason).        
-000275d0: 2020 2020 7966 636c 2e54 7261 6365 4578      yfcl.TraceEx
-000275e0: 6974 286c 6f67 5f66 756e 6320 2b20 2220  it(log_func + " 
-000275f0: 6162 6f72 7469 6e67 2229 0a20 2020 2020  aborting").     
-00027600: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-00027610: 0a0a 2020 2020 2020 2020 2320 4361 6c63  ..        # Calc
-00027620: 756c 6174 6520 7468 6520 7472 7565 2070  ulate the true p
-00027630: 7269 6365 2076 6172 6961 6e63 652c 2069  rice variance, i
-00027640: 2e65 2e20 7265 6d6f 7665 2065 6666 6563  .e. remove effec
-00027650: 7420 6f66 2062 6164 2073 706c 6974 2d61  t of bad split-a
-00027660: 646a 7573 746d 656e 7473 2e0a 2020 2020  djustments..    
-00027670: 2020 2020 2320 4b65 7920 3d20 6967 6e6f      # Key = igno
-00027680: 7265 2031 4420 6368 616e 6765 7320 6f75  re 1D changes ou
-00027690: 7473 6964 6520 6f66 2069 6e74 6572 7175  tside of interqu
-000276a0: 6172 7469 6c65 2072 616e 6765 0a20 2020  artile range.   
-000276b0: 2020 2020 2071 312c 2071 3320 3d20 6e70       q1, q3 = np
-000276c0: 2e70 6572 6365 6e74 696c 6528 5f31 645f  .percentile(_1d_
-000276d0: 6368 616e 6765 5f6d 696e 782c 205b 3235  change_minx, [25
-000276e0: 2c20 3735 5d29 0a20 2020 2020 2020 2069  , 75]).        i
-000276f0: 7172 203d 2071 3320 2d20 7131 0a20 2020  qr = q3 - q1.   
-00027700: 2020 2020 206c 6f77 6572 5f62 6f75 6e64       lower_bound
-00027710: 203d 2071 3120 2d20 312e 3520 2a20 6971   = q1 - 1.5 * iq
-00027720: 720a 2020 2020 2020 2020 7570 7065 725f  r.        upper_
-00027730: 626f 756e 6420 3d20 7133 202b 2031 2e35  bound = q3 + 1.5
-00027740: 202a 2069 7172 0a20 2020 2020 2020 2066   * iqr.        f
-00027750: 203d 2028 5f31 645f 6368 616e 6765 5f6d   = (_1d_change_m
-00027760: 696e 7820 3e3d 206c 6f77 6572 5f62 6f75  inx >= lower_bou
-00027770: 6e64 2920 2620 285f 3164 5f63 6861 6e67  nd) & (_1d_chang
-00027780: 655f 6d69 6e78 203c 3d20 7570 7065 725f  e_minx <= upper_
-00027790: 626f 756e 6429 0a20 2020 2020 2020 2061  bound).        a
-000277a0: 7667 203d 206e 702e 6d65 616e 285f 3164  vg = np.mean(_1d
-000277b0: 5f63 6861 6e67 655f 6d69 6e78 5b66 5d29  _change_minx[f])
-000277c0: 0a20 2020 2020 2020 2073 6420 3d20 6e70  .        sd = np
-000277d0: 2e73 7464 285f 3164 5f63 6861 6e67 655f  .std(_1d_change_
-000277e0: 6d69 6e78 5b66 5d29 0a20 2020 2020 2020  minx[f]).       
-000277f0: 2023 204e 6f77 2063 616e 2063 616c 6375   # Now can calcu
-00027800: 6c61 7465 2053 4420 6173 2025 206f 6620  late SD as % of 
-00027810: 6d65 616e 0a20 2020 2020 2020 2073 645f  mean.        sd_
-00027820: 7063 7420 3d20 7364 202f 2061 7667 0a20  pct = sd / avg. 
-00027830: 2020 2020 2020 206d 7367 203d 2066 2245         msg = f"E
-00027840: 7374 696d 6174 696f 6e20 6f66 2074 7275  stimation of tru
-00027850: 6520 3144 2063 6861 6e67 6520 7374 6174  e 1D change stat
-00027860: 733a 206d 6561 6e20 3d20 7b61 7667 3a2e  s: mean = {avg:.
-00027870: 3266 7d2c 2053 7464 4465 7620 3d20 7b73  2f}, StdDev = {s
-00027880: 643a 2e34 667d 2028 7b73 645f 7063 742a  d:.4f} ({sd_pct*
-00027890: 3130 302e 303a 2e31 667d 2520 6f66 206d  100.0:.1f}% of m
-000278a0: 6561 6e29 220a 2020 2020 2020 2020 7365  ean)".        se
-000278b0: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-000278c0: 656e 7428 2764 6562 7567 272c 2027 7072  ent('debug', 'pr
-000278d0: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
-000278e0: 2d27 2b73 656c 662e 6973 7472 2c20 6d73  -'+self.istr, ms
-000278f0: 6729 0a0a 2020 2020 2020 2020 2320 4f6e  g)..        # On
-00027900: 6c79 2070 726f 6365 6564 2069 6620 7370  ly proceed if sp
-00027910: 6c69 7420 6164 6a75 7374 6d65 6e74 2066  lit adjustment f
-00027920: 6172 2065 7863 6565 6473 206e 6f72 6d61  ar exceeds norma
-00027930: 6c20 3144 2063 6861 6e67 6573 0a20 2020  l 1D changes.   
-00027940: 2020 2020 206c 6172 6765 7374 5f63 6861       largest_cha
-00027950: 6e67 655f 7063 7420 3d20 3520 2a20 7364  nge_pct = 5 * sd
-00027960: 5f70 6374 0a20 2020 2020 2020 2069 6620  _pct.        if 
-00027970: 7365 6c66 2e69 6e74 6572 6461 7920 616e  self.interday an
-00027980: 6420 7365 6c66 2e69 6e74 6572 7661 6c20  d self.interval 
-00027990: 213d 2079 6663 642e 496e 7465 7276 616c  != yfcd.Interval
-000279a0: 2e44 6179 7331 3a0a 2020 2020 2020 2020  .Days1:.        
-000279b0: 2020 2020 6c61 7267 6573 745f 6368 616e      largest_chan
-000279c0: 6765 5f70 6374 202a 3d20 330a 2020 2020  ge_pct *= 3.    
-000279d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000279e0: 696e 7465 7276 616c 2069 6e20 5b79 6663  interval in [yfc
-000279f0: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
-00027a00: 7331 2c20 7966 6364 2e49 6e74 6572 7661  s1, yfcd.Interva
-00027a10: 6c2e 4d6f 6e74 6873 335d 3a0a 2020 2020  l.Months3]:.    
-00027a20: 2020 2020 2020 2020 2020 2020 6c61 7267              larg
-00027a30: 6573 745f 6368 616e 6765 5f70 6374 202a  est_change_pct *
-00027a40: 3d20 320a 2020 2020 2020 2020 6966 206d  = 2.        if m
-00027a50: 6178 2873 706c 6974 2c20 7370 6c69 745f  ax(split, split_
-00027a60: 7263 7029 203c 2031 2e30 202b 206c 6172  rcp) < 1.0 + lar
-00027a70: 6765 7374 5f63 6861 6e67 655f 7063 743a  gest_change_pct:
-00027a80: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-00027a90: 203d 2022 5370 6c69 7420 7261 7469 6f20   = "Split ratio 
-00027aa0: 746f 6f20 636c 6f73 6520 746f 206e 6f72  too close to nor
-00027ab0: 6d61 6c20 7072 6963 6520 766f 6c61 7469  mal price volati
-00027ac0: 6c69 7479 2e20 576f 6e27 7420 7265 7061  lity. Won't repa
-00027ad0: 6972 220a 2020 2020 2020 2020 2020 2020  ir".            
-00027ae0: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
-00027af0: 4576 656e 7428 2764 6562 7567 272c 2027  Event('debug', '
-00027b00: 7072 6963 652d 7265 7061 6972 2d73 706c  price-repair-spl
-00027b10: 6974 2d27 2b73 656c 662e 6973 7472 2c20  it-'+self.istr, 
-00027b20: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00027b30: 2023 206d 7367 203d 2066 2270 7269 6365   # msg = f"price
-00027b40: 2d72 6570 6169 722d 7370 6c69 743a 206d  -repair-split: m
-00027b50: 7920 776f 726b 696e 6773 3a22 202b 2027  y workings:" + '
-00027b60: 5c6e 2720 2b20 7374 7228 6466 5f64 6562  \n' + str(df_deb
-00027b70: 7567 290a 2020 2020 2020 2020 2020 2020  ug).            
-00027b80: 2320 7365 6c66 2e6d 616e 6167 6572 2e4c  # self.manager.L
-00027b90: 6f67 4576 656e 7428 2764 6562 7567 272c  ogEvent('debug',
-00027ba0: 2027 7072 6963 652d 7265 7061 6972 2d73   'price-repair-s
-00027bb0: 706c 6974 2d27 2b73 656c 662e 6973 7472  plit-'+self.istr
-00027bc0: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
-00027bd0: 2020 2079 6663 6c2e 5472 6163 6545 7869     yfcl.TraceExi
-00027be0: 7428 6c6f 675f 6675 6e63 202b 2022 3a20  t(log_func + ": 
-00027bf0: 6162 6f72 7469 6e67 2c20 6368 616e 6765  aborting, change
-00027c00: 7320 746f 206e 6561 7220 6e6f 726d 616c  s to near normal
-00027c10: 2070 7269 6365 2076 6f6c 6174 696c 6974   price volatilit
-00027c20: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
-00027c30: 7265 7475 726e 2064 660a 0a20 2020 2020  return df..     
-00027c40: 2020 2023 204e 6f77 2063 616e 2064 6574     # Now can det
-00027c50: 6563 7420 6261 6420 7370 6c69 7420 6164  ect bad split ad
-00027c60: 6a75 7374 6d65 6e74 730a 2020 2020 2020  justments.      
-00027c70: 2020 2320 5365 7420 7468 7265 7368 6f6c    # Set threshol
-00027c80: 6420 746f 2068 616c 6677 6179 2062 6574  d to halfway bet
-00027c90: 7765 656e 2073 706c 6974 2072 6174 696f  ween split ratio
-00027ca0: 2061 6e64 206c 6172 6765 7374 2065 7870   and largest exp
-00027cb0: 6563 7465 6420 6e6f 726d 616c 2070 7269  ected normal pri
-00027cc0: 6365 2063 6861 6e67 650a 2020 2020 2020  ce change.      
-00027cd0: 2020 7220 3d20 5f31 645f 6368 616e 6765    r = _1d_change
-00027ce0: 5f6d 696e 7820 2f20 7370 6c69 745f 7263  _minx / split_rc
-00027cf0: 700a 2020 2020 2020 2020 7370 6c69 745f  p.        split_
-00027d00: 6d61 7820 3d20 6d61 7828 7370 6c69 742c  max = max(split,
-00027d10: 2073 706c 6974 5f72 6370 290a 2020 2020   split_rcp).    
-00027d20: 2020 2020 7468 7265 7368 6f6c 6420 3d20      threshold = 
-00027d30: 2873 706c 6974 5f6d 6178 202b 2031 2e30  (split_max + 1.0
-00027d40: 202b 206c 6172 6765 7374 5f63 6861 6e67   + largest_chang
-00027d50: 655f 7063 7429 202a 2030 2e35 0a20 2020  e_pct) * 0.5.   
-00027d60: 2020 2020 206d 7367 203d 2066 2273 706c       msg = f"spl
-00027d70: 6974 5f6d 6178 3d7b 7370 6c69 745f 6d61  it_max={split_ma
-00027d80: 783a 2e33 667d 206c 6172 6765 7374 5f63  x:.3f} largest_c
-00027d90: 6861 6e67 655f 7063 743d 7b6c 6172 6765  hange_pct={large
-00027da0: 7374 5f63 6861 6e67 655f 7063 743a 2e34  st_change_pct:.4
-00027db0: 667d 2074 6872 6573 686f 6c64 3d7b 7468  f} threshold={th
-00027dc0: 7265 7368 6f6c 643a 2e33 667d 220a 2020  reshold:.3f}".  
-00027dd0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-00027de0: 6572 2e4c 6f67 4576 656e 7428 2764 6562  er.LogEvent('deb
-00027df0: 7567 272c 2027 7072 6963 652d 7265 7061  ug', 'price-repa
-00027e00: 6972 2d73 706c 6974 2d27 2b73 656c 662e  ir-split-'+self.
-00027e10: 6973 7472 2c20 6d73 6729 0a0a 2020 2020  istr, msg)..    
-00027e20: 2020 2020 6966 2027 5265 7061 6972 6564      if 'Repaired
-00027e30: 3f27 206e 6f74 2069 6e20 6466 322e 636f  ?' not in df2.co
-00027e40: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
-00027e50: 2020 2064 6632 5b27 5265 7061 6972 6564     df2['Repaired
-00027e60: 3f27 5d20 3d20 4661 6c73 650a 0a20 2020  ?'] = False..   
-00027e70: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00027e80: 6572 6461 7920 616e 6420 7365 6c66 2e69  erday and self.i
-00027e90: 6e74 6572 7661 6c20 213d 2079 6663 642e  nterval != yfcd.
-00027ea0: 496e 7465 7276 616c 2e44 6179 7331 3a0a  Interval.Days1:.
-00027eb0: 2020 2020 2020 2020 2020 2020 2320 5961              # Ya
-00027ec0: 686f 6f20 6372 6561 7465 7320 6d75 6c74  hoo creates mult
-00027ed0: 692d 6461 7920 696e 7465 7276 616c 7320  i-day intervals 
-00027ee0: 7573 696e 6720 706f 7465 6e74 6961 6c6c  using potentiall
-00027ef0: 2063 6f72 7275 7074 2064 6174 612c 2065   corrupt data, e
-00027f00: 2e67 2e0a 2020 2020 2020 2020 2020 2020  .g..            
-00027f10: 2320 7468 6520 436c 6f73 6520 636f 756c  # the Close coul
-00027f20: 6420 6265 2031 3030 7820 4f70 656e 2e20  d be 100x Open. 
-00027f30: 5468 6973 206d 6561 6e73 2068 6176 6520  This means have 
-00027f40: 746f 2063 6f72 7265 6374 2065 6163 6820  to correct each 
-00027f50: 4f48 4c43 2063 6f6c 756d 6e0a 2020 2020  OHLC column.    
-00027f60: 2020 2020 2020 2020 2320 696e 6469 7669          # indivi
-00027f70: 6475 616c 6c79 0a20 2020 2020 2020 2020  dually.         
-00027f80: 2020 2063 6f72 7265 6374 5f63 6f6c 756d     correct_colum
-00027f90: 6e73 5f69 6e64 6976 6964 7561 6c6c 7920  ns_individually 
-00027fa0: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
-00027fb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00027fc0: 2063 6f72 7265 6374 5f63 6f6c 756d 6e73   correct_columns
-00027fd0: 5f69 6e64 6976 6964 7561 6c6c 7920 3d20  _individually = 
-00027fe0: 4661 6c73 650a 0a20 2020 2020 2020 2069  False..        i
-00027ff0: 6620 636f 7272 6563 745f 636f 6c75 6d6e  f correct_column
-00028000: 735f 696e 6469 7669 6475 616c 6c79 3a0a  s_individually:.
-00028010: 2020 2020 2020 2020 2020 2020 5f31 645f              _1d_
-00028020: 6368 616e 6765 5f78 203d 206e 702e 6675  change_x = np.fu
-00028030: 6c6c 2828 6e2c 2034 292c 2031 2e30 290a  ll((n, 4), 1.0).
-00028040: 2020 2020 2020 2020 2020 2020 7072 6963              pric
-00028050: 655f 6461 7461 203d 2064 6632 5b4f 484c  e_data = df2[OHL
-00028060: 435d 2e72 6570 6c61 6365 2830 2e30 2c20  C].replace(0.0, 
-00028070: 312e 3029 2e74 6f5f 6e75 6d70 7928 290a  1.0).to_numpy().
-00028080: 2020 2020 2020 2020 2020 2020 5f31 645f              _1d_
-00028090: 6368 616e 6765 5f78 5b31 3a5d 203d 2070  change_x[1:] = p
-000280a0: 7269 6365 5f64 6174 615b 313a 2c20 5d20  rice_data[1:, ] 
-000280b0: 2f20 7072 6963 655f 6461 7461 5b3a 2d31  / price_data[:-1
-000280c0: 2c20 5d0a 2020 2020 2020 2020 656c 7365  , ].        else
-000280d0: 3a0a 2020 2020 2020 2020 2020 2020 5f31  :.            _1
-000280e0: 645f 6368 616e 6765 5f78 203d 205f 3164  d_change_x = _1d
-000280f0: 5f63 6861 6e67 655f 6d69 6e78 0a0a 2020  _change_minx..  
-00028100: 2020 2020 2020 7220 3d20 5f31 645f 6368        r = _1d_ch
-00028110: 616e 6765 5f78 202f 2073 706c 6974 5f72  ange_x / split_r
-00028120: 6370 0a20 2020 2020 2020 2066 5f64 6f77  cp.        f_dow
-00028130: 6e20 3d20 5f31 645f 6368 616e 6765 5f78  n = _1d_change_x
-00028140: 203c 2031 2e30 202f 2074 6872 6573 686f   < 1.0 / thresho
-00028150: 6c64 0a20 2020 2020 2020 2066 5f75 7020  ld.        f_up 
-00028160: 3d20 5f31 645f 6368 616e 6765 5f78 203e  = _1d_change_x >
-00028170: 2074 6872 6573 686f 6c64 0a20 2020 2020   threshold.     
-00028180: 2020 2066 203d 2066 5f64 6f77 6e20 7c20     f = f_down | 
-00028190: 665f 7570 0a20 2020 2020 2020 2069 6620  f_up.        if 
-000281a0: 6e6f 7420 636f 7272 6563 745f 636f 6c75  not correct_colu
-000281b0: 6d6e 735f 696e 6469 7669 6475 616c 6c79  mns_individually
-000281c0: 3a0a 2020 2020 2020 2020 2020 2020 6466  :.            df
-000281d0: 5f64 6562 7567 5b27 7227 5d20 3d20 720a  _debug['r'] = r.
-000281e0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-000281f0: 6562 7567 5b27 665f 646f 776e 275d 203d  ebug['f_down'] =
-00028200: 2066 5f64 6f77 6e0a 2020 2020 2020 2020   f_down.        
-00028210: 2020 2020 6466 5f64 6562 7567 5b27 665f      df_debug['f_
-00028220: 7570 275d 203d 2066 5f75 700a 2020 2020  up'] = f_up.    
-00028230: 2020 2020 2020 2020 6466 5f64 6562 7567          df_debug
-00028240: 5b27 7227 5d20 3d20 6466 5f64 6562 7567  ['r'] = df_debug
-00028250: 5b27 7227 5d2e 726f 756e 6428 3229 2e61  ['r'].round(2).a
-00028260: 7374 7970 6528 2773 7472 2729 0a20 2020  stype('str').   
-00028270: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00028280: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
-00028290: 7261 6e67 6528 6c65 6e28 4f48 4c43 2929  range(len(OHLC))
-000282a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000282b0: 2020 6320 3d20 4f48 4c43 5b6a 5d0a 2020    c = OHLC[j].  
-000282c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000282d0: 2063 2069 6e20 6465 6275 675f 636f 6c73   c in debug_cols
-000282e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000282f0: 2020 2020 2020 6466 5f64 6562 7567 5b63        df_debug[c
-00028300: 202b 2027 5f72 275d 203d 2072 5b3a 2c20   + '_r'] = r[:, 
-00028310: 6a5d 0a20 2020 2020 2020 2020 2020 2020  j].             
-00028320: 2020 2020 2020 2064 665f 6465 6275 675b         df_debug[
-00028330: 6320 2b20 275f 665f 646f 776e 275d 203d  c + '_f_down'] =
-00028340: 2066 5f64 6f77 6e5b 3a2c 206a 5d0a 2020   f_down[:, j].  
-00028350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028360: 2020 6466 5f64 6562 7567 5b63 202b 2027    df_debug[c + '
-00028370: 5f66 5f75 7027 5d20 3d20 665f 7570 5b3a  _f_up'] = f_up[:
-00028380: 2c20 6a5d 0a20 2020 2020 2020 2020 2020  , j].           
-00028390: 2020 2020 2020 2020 2064 665f 6465 6275           df_debu
-000283a0: 675b 6320 2b20 275f 7227 5d20 3d20 6466  g[c + '_r'] = df
-000283b0: 5f64 6562 7567 5b63 202b 2027 5f72 275d  _debug[c + '_r']
-000283c0: 2e72 6f75 6e64 2832 292e 6173 7479 7065  .round(2).astype
-000283d0: 2827 7374 7227 290a 0a20 2020 2020 2020  ('str')..       
-000283e0: 2069 6620 6e6f 7420 662e 616e 7928 293a   if not f.any():
-000283f0: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
-00028400: 6c2e 5472 6163 6545 7869 7428 6c6f 675f  l.TraceExit(log_
-00028410: 6675 6e63 202b 2022 3a20 6162 6f72 7469  func + ": aborti
-00028420: 6e67 2c20 6469 6420 6e6f 7420 6465 7465  ng, did not dete
-00028430: 6374 2073 706c 6974 2065 7272 6f72 7322  ct split errors"
-00028440: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00028450: 7475 726e 2064 660a 0a20 2020 2020 2020  turn df..       
-00028460: 2023 2049 6620 7374 6f63 6b20 6973 2063   # If stock is c
-00028470: 7572 7265 6e74 6c79 2073 7573 7065 6e64  urrently suspend
-00028480: 6564 2061 6e64 206e 6f74 2069 6e20 5553  ed and not in US
-00028490: 412c 2074 6865 6e20 7573 7561 6c6c 7920  A, then usually 
-000284a0: 5961 686f 6f20 696e 7472 6f64 7563 6573  Yahoo introduces
-000284b0: 0a20 2020 2020 2020 2023 2031 3030 7820  .        # 100x 
-000284c0: 6572 726f 7273 2069 6e74 6f20 7375 7370  errors into susp
-000284d0: 656e 6465 6420 696e 7465 7276 616c 732e  ended intervals.
-000284e0: 2043 6c75 6520 6973 206e 6f20 7072 6963   Clue is no pric
-000284f0: 6520 6368 616e 6765 2061 6e64 2030 2076  e change and 0 v
-00028500: 6f6c 756d 652e 0a20 2020 2020 2020 2023  olume..        #
-00028510: 2042 6574 7465 7220 746f 2075 7365 206c   Better to use l
-00028520: 6173 7420 6163 7469 7665 2074 7261 6469  ast active tradi
-00028530: 6e67 2069 6e74 6572 7661 6c20 6173 2062  ng interval as b
-00028540: 6173 656c 696e 652e 0a20 2020 2020 2020  aseline..       
-00028550: 2066 5f6e 6f5f 6163 7469 7669 7479 203d   f_no_activity =
-00028560: 2028 6466 325b 274c 6f77 275d 203d 3d20   (df2['Low'] == 
-00028570: 6466 325b 2748 6967 6827 5d29 2026 2028  df2['High']) & (
-00028580: 6466 325b 2756 6f6c 756d 6527 5d3d 3d30  df2['Volume']==0
-00028590: 290a 2020 2020 2020 2020 665f 6e6f 5f61  ).        f_no_a
-000285a0: 6374 6976 6974 7920 3d20 665f 6e6f 5f61  ctivity = f_no_a
-000285b0: 6374 6976 6974 7920 7c20 6466 325b 4f48  ctivity | df2[OH
-000285c0: 4c43 5d2e 6973 6e61 2829 2e61 6c6c 2861  LC].isna().all(a
-000285d0: 7869 733d 3129 0a20 2020 2020 2020 2061  xis=1).        a
-000285e0: 7070 6561 7273 5f73 7573 7065 6e64 6564  ppears_suspended
-000285f0: 203d 2066 5f6e 6f5f 6163 7469 7669 7479   = f_no_activity
-00028600: 2e61 6e79 2829 2061 6e64 206e 702e 7768  .any() and np.wh
-00028610: 6572 6528 665f 6e6f 5f61 6374 6976 6974  ere(f_no_activit
-00028620: 7929 5b30 5d5b 305d 3d3d 300a 2020 2020  y)[0][0]==0.    
-00028630: 2020 2020 665f 6163 7469 7665 203d 207e      f_active = ~
-00028640: 665f 6e6f 5f61 6374 6976 6974 790a 2020  f_no_activity.  
-00028650: 2020 2020 2020 2320 4669 7273 742c 2069        # First, i
-00028660: 6465 616c 6c79 2c20 6c6f 6f6b 2066 6f72  deally, look for
-00028670: 2032 2063 6f6e 7365 6375 7469 7665 2069   2 consecutive i
-00028680: 6e74 6572 7661 6c73 206f 6620 6163 7469  ntervals of acti
-00028690: 7669 7479 2074 6861 7420 6172 6520 6e6f  vity that are no
-000286a0: 740a 2020 2020 2020 2020 2320 6166 6665  t.        # affe
-000286b0: 6374 6564 2062 7920 6368 616e 6765 2065  cted by change e
-000286c0: 7272 6f72 730a 2020 2020 2020 2020 6966  rrors.        if
-000286d0: 2066 2e6e 6469 6d20 3d3d 2031 3a0a 2020   f.ndim == 1:.  
-000286e0: 2020 2020 2020 2020 2020 665f 6163 7469            f_acti
-000286f0: 7665 203d 2066 5f61 6374 6976 6520 2620  ve = f_active & 
-00028700: 287e 6629 0a20 2020 2020 2020 2065 6c73  (~f).        els
-00028710: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00028720: 5f61 6374 6976 6520 3d20 665f 6163 7469  _active = f_acti
-00028730: 7665 2026 2028 7e66 2e61 6e79 2861 7869  ve & (~f.any(axi
-00028740: 733d 3129 290a 2020 2020 2020 2020 665f  s=1)).        f_
-00028750: 6163 7469 7665 203d 2066 5f61 6374 6976  active = f_activ
-00028760: 6520 2620 6e70 2e72 6f6c 6c28 665f 6163  e & np.roll(f_ac
-00028770: 7469 7665 2c20 3129 0a20 2020 2020 2020  tive, 1).       
-00028780: 2069 6620 6e6f 7420 665f 6163 7469 7665   if not f_active
-00028790: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-000287a0: 2020 2020 2320 4669 7273 7420 706c 616e      # First plan
-000287b0: 2066 6169 6c65 642c 2077 696c 6c20 6861   failed, will ha
-000287c0: 7665 2074 6f20 7365 7474 6c65 2066 6f72  ve to settle for
-000287d0: 206d 6f73 7420 7265 6365 6e74 2061 6374   most recent act
-000287e0: 6976 6520 696e 7465 7276 616c 0a20 2020  ive interval.   
-000287f0: 2020 2020 2020 2020 2066 5f61 6374 6976           f_activ
-00028800: 6520 3d20 7e66 5f6e 6f5f 6163 7469 7669  e = ~f_no_activi
-00028810: 7479 0a20 2020 2020 2020 2020 2020 2066  ty.            f
-00028820: 5f61 6374 6976 6520 3d20 665f 6163 7469  _active = f_acti
-00028830: 7665 2026 206e 702e 726f 6c6c 2866 5f61  ve & np.roll(f_a
-00028840: 6374 6976 652c 2031 290a 2020 2020 2020  ctive, 1).      
-00028850: 2020 6964 785f 6c61 7465 7374 5f61 6374    idx_latest_act
-00028860: 6976 6520 3d20 6e70 2e77 6865 7265 2866  ive = np.where(f
-00028870: 5f61 6374 6976 6529 5b30 5d0a 2020 2020  _active)[0].    
-00028880: 2020 2020 6966 206c 656e 2869 6478 5f6c      if len(idx_l
-00028890: 6174 6573 745f 6163 7469 7665 2920 3d3d  atest_active) ==
-000288a0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000288b0: 6964 785f 6c61 7465 7374 5f61 6374 6976  idx_latest_activ
-000288c0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-000288d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000288e0: 2020 2069 6478 5f6c 6174 6573 745f 6163     idx_latest_ac
-000288f0: 7469 7665 203d 2069 6e74 2869 6478 5f6c  tive = int(idx_l
-00028900: 6174 6573 745f 6163 7469 7665 5b30 5d29  atest_active[0])
-00028910: 0a20 2020 2020 2020 206d 7367 203d 2066  .        msg = f
-00028920: 2761 7070 6561 7273 5f73 7573 7065 6e64  'appears_suspend
-00028930: 6564 3d7b 6170 7065 6172 735f 7375 7370  ed={appears_susp
-00028940: 656e 6465 647d 2069 6478 5f6c 6174 6573  ended} idx_lates
-00028950: 745f 6163 7469 7665 3d7b 6964 785f 6c61  t_active={idx_la
-00028960: 7465 7374 5f61 6374 6976 657d 270a 2020  test_active}'.  
-00028970: 2020 2020 2020 6966 2069 6478 5f6c 6174        if idx_lat
-00028980: 6573 745f 6163 7469 7665 2069 7320 6e6f  est_active is no
-00028990: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000289a0: 2020 2020 6d73 6720 2b3d 2066 2720 287b      msg += f' ({
-000289b0: 6466 2e69 6e64 6578 5b69 6478 5f6c 6174  df.index[idx_lat
-000289c0: 6573 745f 6163 7469 7665 5d2e 6461 7465  est_active].date
-000289d0: 2829 7d29 270a 2020 2020 2020 2020 7365  ()})'.        se
-000289e0: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-000289f0: 656e 7428 2764 6562 7567 272c 2027 7072  ent('debug', 'pr
-00028a00: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
-00028a10: 2d27 2b73 656c 662e 6973 7472 2c20 6d73  -'+self.istr, ms
-00028a20: 6729 0a0a 2020 2020 2020 2020 2320 5570  g)..        # Up
-00028a30: 6461 7465 3a20 6966 2061 6e79 2031 3030  date: if any 100
-00028a40: 7820 6368 616e 6765 7320 6172 6520 736f  x changes are so
-00028a50: 6f6e 2061 6674 6572 2061 2073 746f 636b  on after a stock
-00028a60: 2073 706c 6974 2c20 736f 2063 6f75 6c64   split, so could
-00028a70: 2062 6520 636f 6e66 7573 6564 2077 6974   be confused wit
-00028a80: 6820 7370 6c69 7420 6572 726f 722c 2074  h split error, t
-00028a90: 6865 6e20 6162 6f72 740a 2020 2020 2020  hen abort.      
-00028aa0: 2020 7468 7265 7368 6f6c 645f 6461 7973    threshold_days
-00028ab0: 203d 2033 300a 2020 2020 2020 2020 665f   = 30.        f_
-00028ac0: 7370 6c69 7473 203d 2064 665b 2753 746f  splits = df['Sto
-00028ad0: 636b 2053 706c 6974 7327 5d2e 746f 5f6e  ck Splits'].to_n
-00028ae0: 756d 7079 2829 2021 3d20 302e 300a 2020  umpy() != 0.0.  
-00028af0: 2020 2020 2020 6966 2063 6861 6e67 6520        if change 
-00028b00: 696e 205b 3130 302e 302c 2030 2e30 315d  in [100.0, 0.01]
-00028b10: 2061 6e64 2066 5f73 706c 6974 732e 616e   and f_splits.an
-00028b20: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-00028b30: 2069 6e64 6963 6573 5f41 203d 206e 702e   indices_A = np.
-00028b40: 7768 6572 6528 665f 7370 6c69 7473 295b  where(f_splits)[
-00028b50: 305d 0a20 2020 2020 2020 2020 2020 2069  0].            i
-00028b60: 6e64 6963 6573 5f42 203d 206e 702e 7768  ndices_B = np.wh
-00028b70: 6572 6528 6629 5b30 5d0a 2020 2020 2020  ere(f)[0].      
-00028b80: 2020 2020 2020 6966 206e 6f74 206c 656e        if not len
-00028b90: 2869 6e64 6963 6573 5f41 2920 6f72 206e  (indices_A) or n
-00028ba0: 6f74 206c 656e 2869 6e64 6963 6573 5f42  ot len(indices_B
-00028bb0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00028bc0: 2020 2079 6663 6c2e 5472 6163 6545 7869     yfcl.TraceExi
-00028bd0: 7428 6c6f 675f 6675 6e63 290a 2020 2020  t(log_func).    
-00028be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00028bf0: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
-00028c00: 2020 2020 6761 7073 203d 2069 6e64 6963      gaps = indic
-00028c10: 6573 5f42 5b3a 2c20 4e6f 6e65 5d20 2d20  es_B[:, None] - 
-00028c20: 696e 6469 6365 735f 410a 2020 2020 2020  indices_A.      
-00028c30: 2020 2020 2020 2320 4265 6361 7573 6520        # Because 
-00028c40: 6461 7461 2069 7320 736f 7274 6564 2069  data is sorted i
-00028c50: 6e20 4445 7363 656e 6469 6e67 206f 7264  n DEscending ord
-00028c60: 6572 2c20 6e65 6564 2074 6f20 666c 6970  er, need to flip
-00028c70: 2067 6170 730a 2020 2020 2020 2020 2020   gaps.          
-00028c80: 2020 6761 7073 202a 3d20 2d31 0a20 2020    gaps *= -1.   
-00028c90: 2020 2020 2020 2020 2066 5f70 6f73 203d           f_pos =
-00028ca0: 2067 6170 7320 3e20 300a 2020 2020 2020   gaps > 0.      
-00028cb0: 2020 2020 2020 6966 2066 5f70 6f73 2e61        if f_pos.a
-00028cc0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00028cd0: 2020 2020 2020 6761 705f 6d69 6e20 3d20        gap_min = 
-00028ce0: 6761 7073 5b66 5f70 6f73 5d2e 6d69 6e28  gaps[f_pos].min(
-00028cf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028d00: 2020 6761 705f 7464 203d 2073 656c 662e    gap_td = self.
-00028d10: 6974 6420 2a20 6761 705f 6d69 6e0a 2020  itd * gap_min.  
-00028d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00028d30: 2069 7369 6e73 7461 6e63 6528 6761 705f   isinstance(gap_
-00028d40: 7464 2c20 6461 7465 7574 696c 2e72 656c  td, dateutil.rel
-00028d50: 6174 6976 6564 656c 7461 2e72 656c 6174  ativedelta.relat
-00028d60: 6976 6564 656c 7461 293a 0a20 2020 2020  ivedelta):.     
-00028d70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028d80: 6872 6573 686f 6c64 203d 2064 6174 6575  hreshold = dateu
-00028d90: 7469 6c2e 7265 6c61 7469 7665 6465 6c74  til.relativedelt
-00028da0: 612e 7265 6c61 7469 7665 6465 6c74 6128  a.relativedelta(
-00028db0: 6461 7973 3d74 6872 6573 686f 6c64 5f64  days=threshold_d
-00028dc0: 6179 7329 0a20 2020 2020 2020 2020 2020  ays).           
-00028dd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00028de0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028df0: 6872 6573 686f 6c64 203d 2074 696d 6564  hreshold = timed
-00028e00: 656c 7461 2864 6179 733d 7468 7265 7368  elta(days=thresh
-00028e10: 6f6c 645f 6461 7973 290a 2020 2020 2020  old_days).      
-00028e20: 2020 2020 2020 2020 2020 6966 2067 6170            if gap
-00028e30: 5f74 6420 3c20 7468 7265 7368 6f6c 643a  _td < threshold:
-00028e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028e50: 2020 2020 206d 7367 203d 2027 7072 6963       msg = 'pric
-00028e60: 652d 7265 7061 6972 2d73 706c 6974 3a20  e-repair-split: 
-00028e70: 3130 3078 2063 6861 6e67 6573 2061 7265  100x changes are
-00028e80: 2074 6f6f 2073 6f6f 6e20 6166 7465 7220   too soon after 
-00028e90: 7374 6f63 6b20 7370 6c69 7420 6576 656e  stock split even
-00028ea0: 7473 2c20 6162 6f72 7469 6e67 270a 2020  ts, aborting'.  
-00028eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ec0: 2020 7365 6c66 2e6d 616e 6167 6572 2e4c    self.manager.L
-00028ed0: 6f67 4576 656e 7428 2769 6e66 6f27 2c20  ogEvent('info', 
-00028ee0: 2770 7269 6365 2d72 6570 6169 722d 7370  'price-repair-sp
-00028ef0: 6c69 742d 272b 7365 6c66 2e69 7374 722c  lit-'+self.istr,
-00028f00: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
-00028f10: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00028f20: 7261 6365 4578 6974 286c 6f67 5f66 756e  raceExit(log_fun
-00028f30: 6329 0a20 2020 2020 2020 2020 2020 2020  c).             
-00028f40: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-00028f50: 0a0a 2020 2020 2020 2020 2320 6966 2073  ..        # if s
-00028f60: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
-00028f70: 2020 2020 2020 2320 2020 2020 6466 5f64        #     df_d
-00028f80: 6562 7567 2e69 6e64 6578 203d 2064 665f  ebug.index = df_
-00028f90: 6465 6275 672e 696e 6465 782e 6461 7465  debug.index.date
-00028fa0: 0a20 2020 2020 2020 2023 2066 6f72 2063  .        # for c
-00028fb0: 2069 6e20 5b27 4665 7463 6844 6174 6527   in ['FetchDate'
-00028fc0: 5d3a 0a20 2020 2020 2020 2023 2020 2020  ]:.        #    
-00028fd0: 2064 665f 6465 6275 675b 635d 203d 2064   df_debug[c] = d
-00028fe0: 665f 6465 6275 675b 635d 2e64 742e 7374  f_debug[c].dt.st
-00028ff0: 7266 7469 6d65 2827 2559 2d25 6d2d 2564  rftime('%Y-%m-%d
-00029000: 2025 483a 254d 3a25 5325 7a27 290a 2020   %H:%M:%S%z').  
-00029010: 2020 2020 2020 2320 6d73 6720 3d20 6622        # msg = f"
-00029020: 7072 6963 652d 7265 7061 6972 2d73 706c  price-repair-spl
-00029030: 6974 3a20 6d79 2077 6f72 6b69 6e67 733a  it: my workings:
-00029040: 2220 2b20 275c 6e27 202b 2073 7472 2864  " + '\n' + str(d
-00029050: 665f 6465 6275 6729 0a20 2020 2020 2020  f_debug).       
-00029060: 2023 2073 656c 662e 6d61 6e61 6765 722e   # self.manager.
-00029070: 4c6f 6745 7665 6e74 2827 6465 6275 6727  LogEvent('debug'
-00029080: 2c20 2770 7269 6365 2d72 6570 6169 722d  , 'price-repair-
-00029090: 7370 6c69 742d 272b 7365 6c66 2e69 7374  split-'+self.ist
-000290a0: 722c 206d 7367 290a 2020 2020 2020 2020  r, msg).        
-000290b0: 2320 7072 696e 7428 6d73 6729 0a0a 2020  # print(msg)..  
-000290c0: 2020 2020 2020 6465 6620 6d61 705f 7369        def map_si
-000290d0: 676e 616c 735f 746f 5f72 616e 6765 7328  gnals_to_ranges(
-000290e0: 662c 2066 5f75 702c 2066 5f64 6f77 6e29  f, f_up, f_down)
-000290f0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00029100: 456e 7375 7265 2030 7468 2065 6c65 6d65  Ensure 0th eleme
-00029110: 6e74 2069 7320 4661 6c73 652c 2062 6563  nt is False, bec
-00029120: 6175 7365 2054 7275 6520 6973 206e 6f6e  ause True is non
-00029130: 7365 6e73 650a 2020 2020 2020 2020 2020  sense.          
-00029140: 2020 6966 2066 5b30 5d3a 0a20 2020 2020    if f[0]:.     
-00029150: 2020 2020 2020 2020 2020 2066 203d 206e             f = n
-00029160: 702e 636f 7079 2866 2920 3b20 665b 305d  p.copy(f) ; f[0]
-00029170: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00029180: 2020 2020 2020 2020 2066 5f75 7020 3d20           f_up = 
-00029190: 6e70 2e63 6f70 7928 665f 7570 2920 3b20  np.copy(f_up) ; 
-000291a0: 665f 7570 5b30 5d20 3d20 4661 6c73 650a  f_up[0] = False.
-000291b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291c0: 665f 646f 776e 203d 206e 702e 636f 7079  f_down = np.copy
-000291d0: 2866 5f64 6f77 6e29 203b 2066 5f64 6f77  (f_down) ; f_dow
-000291e0: 6e5b 305d 203d 2046 616c 7365 0a0a 2020  n[0] = False..  
-000291f0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00029200: 2066 2e61 6e79 2829 3a0a 2020 2020 2020   f.any():.      
-00029210: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00029220: 205b 5d0a 0a20 2020 2020 2020 2020 2020   []..           
-00029230: 2074 7275 655f 696e 6469 6365 7320 3d20   true_indices = 
-00029240: 6e70 2e77 6865 7265 2866 295b 305d 0a20  np.where(f)[0]. 
-00029250: 2020 2020 2020 2020 2020 2072 616e 6765             range
-00029260: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
-00029270: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00029280: 6765 286c 656e 2874 7275 655f 696e 6469  ge(len(true_indi
-00029290: 6365 7329 202d 2031 293a 0a20 2020 2020  ces) - 1):.     
-000292a0: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
-000292b0: 2520 3220 3d3d 2030 3a0a 2020 2020 2020  % 2 == 0:.      
-000292c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000292d0: 2073 706c 6974 203e 2031 2e30 3a0a 2020   split > 1.0:.  
-000292e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292f0: 2020 2020 2020 6164 6a20 3d20 2773 706c        adj = 'spl
-00029300: 6974 2720 6966 2066 5f64 6f77 6e5b 7472  it' if f_down[tr
-00029310: 7565 5f69 6e64 6963 6573 5b69 5d5d 2065  ue_indices[i]] e
-00029320: 6c73 6520 2731 2e30 2f73 706c 6974 270a  lse '1.0/split'.
-00029330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029340: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00029350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029360: 2020 6164 6a20 3d20 2731 2e30 2f73 706c    adj = '1.0/spl
-00029370: 6974 2720 6966 2066 5f64 6f77 6e5b 7472  it' if f_down[tr
-00029380: 7565 5f69 6e64 6963 6573 5b69 5d5d 2065  ue_indices[i]] e
-00029390: 6c73 6520 2773 706c 6974 270a 2020 2020  lse 'split'.    
-000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293b0: 7261 6e67 6573 2e61 7070 656e 6428 2874  ranges.append((t
-000293c0: 7275 655f 696e 6469 6365 735b 695d 2c20  rue_indices[i], 
-000293d0: 7472 7565 5f69 6e64 6963 6573 5b69 202b  true_indices[i +
-000293e0: 2031 5d2c 2061 646a 2929 0a0a 2020 2020   1], adj))..    
-000293f0: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-00029400: 7275 655f 696e 6469 6365 7329 2025 2032  rue_indices) % 2
-00029410: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-00029420: 2020 2020 2020 2069 6620 7370 6c69 7420         if split 
-00029430: 3e20 312e 303a 0a20 2020 2020 2020 2020  > 1.0:.         
-00029440: 2020 2020 2020 2020 2020 2061 646a 203d             adj =
-00029450: 2027 7370 6c69 7427 2069 6620 665f 646f   'split' if f_do
-00029460: 776e 5b74 7275 655f 696e 6469 6365 735b  wn[true_indices[
-00029470: 2d31 5d5d 2065 6c73 6520 2731 2e30 2f73  -1]] else '1.0/s
-00029480: 706c 6974 270a 2020 2020 2020 2020 2020  plit'.          
-00029490: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000294a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294b0: 6164 6a20 3d20 2731 2e30 2f73 706c 6974  adj = '1.0/split
-000294c0: 2720 6966 2066 5f64 6f77 6e5b 7472 7565  ' if f_down[true
-000294d0: 5f69 6e64 6963 6573 5b2d 315d 5d20 656c  _indices[-1]] el
-000294e0: 7365 2027 7370 6c69 7427 0a20 2020 2020  se 'split'.     
-000294f0: 2020 2020 2020 2020 2020 2072 616e 6765             range
-00029500: 732e 6170 7065 6e64 2828 7472 7565 5f69  s.append((true_i
-00029510: 6e64 6963 6573 5b2d 315d 2c20 6c65 6e28  ndices[-1], len(
-00029520: 6629 2c20 6164 6a29 290a 0a20 2020 2020  f), adj))..     
-00029530: 2020 2020 2020 2072 6574 7572 6e20 7261         return ra
-00029540: 6e67 6573 0a0a 2020 2020 2020 2020 6966  nges..        if
-00029550: 2069 6478 5f6c 6174 6573 745f 6163 7469   idx_latest_acti
-00029560: 7665 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ve is not None:.
-00029570: 2020 2020 2020 2020 2020 2020 6964 785f              idx_
-00029580: 7265 765f 6c61 7465 7374 5f61 6374 6976  rev_latest_activ
-00029590: 6520 3d20 6466 2e73 6861 7065 5b30 5d20  e = df.shape[0] 
-000295a0: 2d20 3120 2d20 6964 785f 6c61 7465 7374  - 1 - idx_latest
-000295b0: 5f61 6374 6976 650a 2020 2020 2020 2020  _active.        
-000295c0: 2020 2020 6d73 6720 3d20 6627 6964 785f      msg = f'idx_
-000295d0: 6c61 7465 7374 5f61 6374 6976 653d 7b69  latest_active={i
-000295e0: 6478 5f6c 6174 6573 745f 6163 7469 7665  dx_latest_active
-000295f0: 7d2c 2069 6478 5f72 6576 5f6c 6174 6573  }, idx_rev_lates
-00029600: 745f 6163 7469 7665 3d7b 6964 785f 7265  t_active={idx_re
-00029610: 765f 6c61 7465 7374 5f61 6374 6976 657d  v_latest_active}
-00029620: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
-00029630: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-00029640: 656e 7428 2764 6562 7567 272c 2027 7072  ent('debug', 'pr
-00029650: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
-00029660: 2d27 2b73 656c 662e 6973 7472 2c20 6d73  -'+self.istr, ms
-00029670: 6729 0a20 2020 2020 2020 2069 6620 636f  g).        if co
-00029680: 7272 6563 745f 636f 6c75 6d6e 735f 696e  rrect_columns_in
-00029690: 6469 7669 6475 616c 6c79 3a0a 2020 2020  dividually:.    
-000296a0: 2020 2020 2020 2020 665f 636f 7272 6563          f_correc
-000296b0: 7465 6420 3d20 6e70 2e66 756c 6c28 6e2c  ted = np.full(n,
-000296c0: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
-000296d0: 2020 2020 6966 2063 6f72 7265 6374 5f76      if correct_v
-000296e0: 6f6c 756d 653a 0a20 2020 2020 2020 2020  olume:.         
-000296f0: 2020 2020 2020 2023 2049 6620 4f70 656e         # If Open
-00029700: 206f 7220 436c 6f73 6520 6973 2072 6570   or Close is rep
-00029710: 6169 7265 6420 6275 7420 6e6f 7420 626f  aired but not bo
-00029720: 7468 2c20 0a20 2020 2020 2020 2020 2020  th, .           
-00029730: 2020 2020 2023 2074 6865 6e20 7468 6973       # then this
-00029740: 206d 6561 6e73 2074 6865 2069 6e74 6572   means the inter
-00029750: 7661 6c20 6861 7320 6120 6d69 7820 6f66  val has a mix of
-00029760: 2063 6f72 7265 6374 0a20 2020 2020 2020   correct.       
-00029770: 2020 2020 2020 2020 2023 2061 6e64 2065           # and e
-00029780: 7272 6f72 732e 2041 2070 726f 626c 656d  rrors. A problem
-00029790: 2066 6f72 2063 6f72 7265 6374 696e 6720   for correcting 
-000297a0: 566f 6c75 6d65 2c20 0a20 2020 2020 2020  Volume, .       
-000297b0: 2020 2020 2020 2020 2023 2073 6f20 7573           # so us
-000297c0: 6520 6120 6865 7572 6973 7469 633a 0a20  e a heuristic:. 
-000297d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000297e0: 202d 2069 6620 626f 7468 204f 7065 6e20   - if both Open 
-000297f0: 2620 436c 6f73 6520 7765 7265 204e 7820  & Close were Nx 
-00029800: 6261 6420 3d3e 2056 6f6c 756d 6520 6973  bad => Volume is
-00029810: 204e 7820 6261 640a 2020 2020 2020 2020   Nx bad.        
-00029820: 2020 2020 2020 2020 2320 2d20 6966 206f          # - if o
-00029830: 6e6c 7920 6f6e 6520 6f66 204f 7065 6e20  nly one of Open 
-00029840: 2620 436c 6f73 6520 6172 6520 4e78 2062  & Close are Nx b
-00029850: 6164 203d 3e20 566f 6c75 6d65 2069 7320  ad => Volume is 
-00029860: 302e 352a 4e78 2062 6164 0a20 2020 2020  0.5*Nx bad.     
-00029870: 2020 2020 2020 2020 2020 2066 5f6f 7065             f_ope
-00029880: 6e5f 6669 7865 6420 3d20 6e70 2e66 756c  n_fixed = np.ful
-00029890: 6c28 6e2c 2046 616c 7365 290a 2020 2020  l(n, False).    
-000298a0: 2020 2020 2020 2020 2020 2020 665f 636c              f_cl
-000298b0: 6f73 655f 6669 7865 6420 3d20 6e70 2e66  ose_fixed = np.f
-000298c0: 756c 6c28 6e2c 2046 616c 7365 290a 0a20  ull(n, False).. 
-000298d0: 2020 2020 2020 2020 2020 204f 484c 435f             OHLC_
-000298e0: 636f 7272 6563 745f 7261 6e67 6573 203d  correct_ranges =
-000298f0: 205b 4e6f 6e65 2c20 4e6f 6e65 2c20 4e6f   [None, None, No
-00029900: 6e65 2c20 4e6f 6e65 5d0a 2020 2020 2020  ne, None].      
-00029910: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
-00029920: 616e 6765 286c 656e 284f 484c 4329 293a  ange(len(OHLC)):
-00029930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029940: 2063 203d 204f 484c 435b 6a5d 0a20 2020   c = OHLC[j].   
-00029950: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-00029960: 5f66 6972 7374 5f66 203d 206e 702e 7768  _first_f = np.wh
-00029970: 6572 6528 6629 5b30 5d5b 305d 0a20 2020  ere(f)[0][0].   
-00029980: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00029990: 6170 7065 6172 735f 7375 7370 656e 6465  appears_suspende
-000299a0: 6420 616e 6420 2869 6478 5f6c 6174 6573  d and (idx_lates
-000299b0: 745f 6163 7469 7665 2069 7320 6e6f 7420  t_active is not 
-000299c0: 4e6f 6e65 2061 6e64 2069 6478 5f6c 6174  None and idx_lat
-000299d0: 6573 745f 6163 7469 7665 203e 3d20 6964  est_active >= id
-000299e0: 785f 6669 7273 745f 6629 3a0a 2020 2020  x_first_f):.    
+000231c0: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+000231d0: 696f 6e28 2246 6169 6c69 6e67 2074 6f20  ion("Failing to 
+000231e0: 636f 7272 6563 746c 7920 7075 7368 2f70  correctly push/p
+000231f0: 6f70 2073 7461 636b 2074 7261 6365 2028  op stack trace (
+00023200: 7365 6520 6162 6f76 6529 2229 0a20 2020  see above)").   
+00023210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023220: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+00023230: 6365 2e70 6f70 286c 656e 2873 656c 662e  ce.pop(len(self.
+00023240: 5f73 7461 636b 5f74 7261 6365 2920 2d20  _stack_trace) - 
+00023250: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+00023260: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00023270: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00023280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023290: 2020 7072 696e 7428 2263 616c 6962 5f66    print("calib_f
+000232a0: 696c 7465 723a 2229 203b 2070 7269 6e74  ilter:") ; print
+000232b0: 2863 616c 6962 5f66 696c 7465 7229 0a20  (calib_filter). 
+000232c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000232d0: 7269 6e74 2822 6466 5f6e 6577 5f63 616c  rint("df_new_cal
+000232e0: 6962 3a22 2920 3b20 7072 696e 7428 6466  ib:") ; print(df
+000232f0: 5f6e 6577 5f63 616c 6962 290a 2020 2020  _new_calib).    
+00023300: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00023310: 7428 2264 665f 626c 6f63 6b5f 6361 6c69  t("df_block_cali
+00023320: 623a 2229 203b 2070 7269 6e74 2864 665f  b:") ; print(df_
+00023330: 626c 6f63 6b5f 6361 6c69 6229 0a20 2020  block_calib).   
+00023340: 2020 2020 2020 2020 2023 2041 766f 6964           # Avoid
+00023350: 2064 6976 6964 652d 6279 2d7a 6572 6f20   divide-by-zero 
+00023360: 7761 726e 696e 6773 2070 7269 6e74 696e  warnings printin
+00023370: 673a 0a20 2020 2020 2020 2020 2020 2064  g:.            d
+00023380: 665f 6e65 775f 6361 6c69 6220 3d20 6466  f_new_calib = df
+00023390: 5f6e 6577 5f63 616c 6962 2e74 6f5f 6e75  _new_calib.to_nu
+000233a0: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
+000233b0: 2020 6466 5f62 6c6f 636b 5f63 616c 6962    df_block_calib
+000233c0: 203d 2064 665f 626c 6f63 6b5f 6361 6c69   = df_block_cali
+000233d0: 622e 746f 5f6e 756d 7079 2829 0a20 2020  b.to_numpy().   
+000233e0: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
+000233f0: 6e20 7261 6e67 6528 6c65 6e28 7072 6963  n range(len(pric
+00023400: 655f 636f 6c73 2929 3a0a 2020 2020 2020  e_cols)):.      
+00023410: 2020 2020 2020 2020 2020 6320 3d20 7072            c = pr
+00023420: 6963 655f 636f 6c73 5b6a 5d0a 2020 2020  ice_cols[j].    
+00023430: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
+00023440: 7e63 616c 6962 5f66 696c 7465 725b 3a2c  ~calib_filter[:,
+00023450: 206a 5d0a 2020 2020 2020 2020 2020 2020   j].            
+00023460: 2020 2020 6966 2066 2e61 6e79 2829 3a0a      if f.any():.
+00023470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023480: 2020 2020 6466 5f62 6c6f 636b 5f63 616c      df_block_cal
+00023490: 6962 5b66 2c20 6a5d 203d 2031 0a20 2020  ib[f, j] = 1.   
+000234a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234b0: 2064 665f 6e65 775f 6361 6c69 625b 662c   df_new_calib[f,
+000234c0: 206a 5d20 3d20 310a 2020 2020 2020 2020   j] = 1.        
+000234d0: 2020 2020 7261 7469 6f73 203d 2028 6466      ratios = (df
+000234e0: 5f62 6c6f 636b 5f63 616c 6962 202f 2064  _block_calib / d
+000234f0: 665f 6e65 775f 6361 6c69 6229 5b63 616c  f_new_calib)[cal
+00023500: 6962 5f66 696c 7465 725d 0a20 2020 2020  ib_filter].     
+00023510: 2020 2020 2020 2072 6174 696f 203d 206e         ratio = n
+00023520: 702e 6d65 616e 2872 6174 696f 7329 0a20  p.mean(ratios). 
+00023530: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00023540: 2020 2020 2020 2020 2072 6174 696f 5f72           ratio_r
+00023550: 6370 203d 2072 6f75 6e64 2831 2e30 202f  cp = round(1.0 /
+00023560: 2072 6174 696f 2c20 3129 0a20 2020 2020   ratio, 1).     
+00023570: 2020 2020 2020 2072 6174 696f 203d 2072         ratio = r
+00023580: 6f75 6e64 2872 6174 696f 2c20 3129 0a20  ound(ratio, 1). 
+00023590: 2020 2020 2020 2020 2020 2069 6620 7261             if ra
+000235a0: 7469 6f20 3d3d 2031 2061 6e64 2072 6174  tio == 1 and rat
+000235b0: 696f 5f72 6370 203d 3d20 313a 0a20 2020  io_rcp == 1:.   
+000235c0: 2020 2020 2020 2020 2020 2020 2023 2047               # G
+000235d0: 6f6f 6421 0a20 2020 2020 2020 2020 2020  ood!.           
+000235e0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+000235f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00023600: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00023610: 6174 696f 203e 2031 3a0a 2020 2020 2020  atio > 1:.      
+00023620: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00023630: 6461 7461 2068 6173 2064 6966 6665 7265  data has differe
+00023640: 6e74 2073 706c 6974 2d61 646a 7573 746d  nt split-adjustm
+00023650: 656e 7420 7468 616e 2066 696e 652d 6772  ent than fine-gr
+00023660: 6169 6e65 6420 6461 7461 0a20 2020 2020  ained data.     
+00023670: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00023680: 2041 646a 7573 7420 6669 6e65 2d67 7261   Adjust fine-gra
+00023690: 696e 6564 2074 6f20 6d61 7463 680a 2020  ined to match.  
+000236a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236b0: 2020 6466 5f6e 6577 5b70 7269 6365 5f63    df_new[price_c
+000236c0: 6f6c 735d 202a 3d20 7261 7469 6f0a 2020  ols] *= ratio.  
+000236d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236e0: 2020 6466 5f6e 6577 5b22 566f 6c75 6d65    df_new["Volume
+000236f0: 225d 202f 3d20 7261 7469 6f0a 2020 2020  "] /= ratio.    
+00023700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023710: 6466 5f6e 6577 5b22 566f 6c75 6d65 225d  df_new["Volume"]
+00023720: 203d 2064 665f 6e65 775b 2256 6f6c 756d   = df_new["Volum
+00023730: 6522 5d2e 726f 756e 6428 3029 2e61 7374  e"].round(0).ast
+00023740: 7970 6528 2769 6e74 2729 0a20 2020 2020  ype('int').     
+00023750: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00023760: 7261 7469 6f5f 7263 7020 3e20 313a 0a20  ratio_rcp > 1:. 
+00023770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023780: 2020 2023 2064 6174 6120 6861 7320 6469     # data has di
+00023790: 6666 6572 656e 7420 7370 6c69 742d 6164  fferent split-ad
+000237a0: 6a75 7374 6d65 6e74 2074 6861 6e20 6669  justment than fi
+000237b0: 6e65 2d67 7261 696e 6564 2064 6174 610a  ne-grained data.
+000237c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237d0: 2020 2020 2320 4164 6a75 7374 2066 696e      # Adjust fin
+000237e0: 652d 6772 6169 6e65 6420 746f 206d 6174  e-grained to mat
+000237f0: 6368 0a20 2020 2020 2020 2020 2020 2020  ch.             
+00023800: 2020 2020 2020 2064 665f 6e65 775b 7072         df_new[pr
+00023810: 6963 655f 636f 6c73 5d20 2a3d 2031 2e30  ice_cols] *= 1.0
+00023820: 202f 2072 6174 696f 5f72 6370 0a20 2020   / ratio_rcp.   
+00023830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023840: 2064 665f 6e65 775b 2256 6f6c 756d 6522   df_new["Volume"
+00023850: 5d20 2a3d 2072 6174 696f 5f72 6370 0a20  ] *= ratio_rcp. 
+00023860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023870: 2020 2064 665f 6e65 775b 2256 6f6c 756d     df_new["Volum
+00023880: 6522 5d20 3d20 6466 5f6e 6577 5b22 566f  e"] = df_new["Vo
+00023890: 6c75 6d65 225d 2e72 6f75 6e64 2830 292e  lume"].round(0).
+000238a0: 6173 7479 7065 2827 696e 7427 290a 0a20  astype('int').. 
+000238b0: 2020 2020 2020 2020 2020 2023 2052 6570             # Rep
+000238c0: 6169 7221 0a20 2020 2020 2020 2020 2020  air!.           
+000238d0: 2062 6164 5f64 7473 203d 2064 665f 626c   bad_dts = df_bl
+000238e0: 6f63 6b2e 696e 6465 785b 2864 665f 626c  ock.index[(df_bl
+000238f0: 6f63 6b5b 7072 6963 655f 636f 6c73 5d20  ock[price_cols] 
+00023900: 3d3d 2074 6167 292e 616e 7928 6178 6973  == tag).any(axis
+00023910: 3d31 295d 0a0a 2020 2020 2020 2020 2020  =1)]..          
+00023920: 2020 666f 7220 6964 7820 696e 2062 6164    for idx in bad
+00023930: 5f64 7473 3a0a 2020 2020 2020 2020 2020  _dts:.          
+00023940: 2020 2020 2020 6966 2069 6478 206e 6f74        if idx not
+00023950: 2069 6e20 6466 5f6e 6577 2e69 6e64 6578   in df_new.index
+00023960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023970: 2020 2020 2020 2320 5961 686f 6f20 6469        # Yahoo di
+00023980: 646e 2774 2072 6574 7572 6e20 6669 6e65  dn't return fine
+00023990: 722d 6772 6169 6e20 6461 7461 2066 6f72  r-grain data for
+000239a0: 2074 6869 7320 696e 7465 7276 616c 2c0a   this interval,.
+000239b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239c0: 2020 2020 2320 736f 2070 726f 6261 626c      # so probabl
+000239d0: 7920 6e6f 2074 7261 6469 6e67 2068 6170  y no trading hap
+000239e0: 7065 6e65 642e 0a20 2020 2020 2020 2020  pened..         
+000239f0: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
+00023a00: 6e74 2822 6e6f 2066 696e 6520 6461 7461  nt("no fine data
+00023a10: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00023a20: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00023a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a40: 6466 5f6e 6577 5f72 6f77 203d 2064 665f  df_new_row = df_
+00023a50: 6e65 772e 6c6f 635b 6964 785d 0a0a 2020  new.loc[idx]..  
+00023a60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00023a70: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
+00023a80: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+00023a90: 5765 656b 3a0a 2020 2020 2020 2020 2020  Week:.          
+00023aa0: 2020 2020 2020 2020 2020 6466 5f6c 6173            df_las
+00023ab0: 745f 7765 656b 203d 2064 665f 6e65 772e  t_week = df_new.
+00023ac0: 696c 6f63 5b64 665f 6e65 772e 696e 6465  iloc[df_new.inde
+00023ad0: 782e 6765 745f 6c6f 6328 6964 7829 2d31  x.get_loc(idx)-1
+00023ae0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00023af0: 2020 2020 2020 6466 5f66 696e 6520 3d20        df_fine = 
+00023b00: 6466 5f66 696e 652e 6c6f 635b 6964 783a  df_fine.loc[idx:
+00023b10: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00023b20: 2020 2064 665f 6261 645f 726f 7720 3d20     df_bad_row = 
+00023b30: 6466 2e6c 6f63 5b69 6478 5d0a 2020 2020  df.loc[idx].    
+00023b40: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
+00023b50: 6669 656c 6473 203d 2064 665f 6261 645f  fields = df_bad_
+00023b60: 726f 772e 696e 6465 785b 6466 5f62 6164  row.index[df_bad
+00023b70: 5f72 6f77 203d 3d20 7461 675d 2e74 6f5f  _row == tag].to_
+00023b80: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
+00023b90: 2020 2020 2020 2020 6966 2022 4869 6768          if "High
+00023ba0: 2220 696e 2062 6164 5f66 6965 6c64 733a  " in bad_fields:
+00023bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023bc0: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
+00023bd0: 6478 2c20 2248 6967 6822 5d20 3d20 6466  dx, "High"] = df
+00023be0: 5f6e 6577 5f72 6f77 5b22 4869 6768 225d  _new_row["High"]
+00023bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023c00: 2069 6620 224c 6f77 2220 696e 2062 6164   if "Low" in bad
+00023c10: 5f66 6965 6c64 733a 0a20 2020 2020 2020  _fields:.       
+00023c20: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00023c30: 7632 2e6c 6f63 5b69 6478 2c20 224c 6f77  v2.loc[idx, "Low
+00023c40: 225d 203d 2064 665f 6e65 775f 726f 775b  "] = df_new_row[
+00023c50: 224c 6f77 225d 0a20 2020 2020 2020 2020  "Low"].         
+00023c60: 2020 2020 2020 2069 6620 224f 7065 6e22         if "Open"
+00023c70: 2069 6e20 6261 645f 6669 656c 6473 3a0a   in bad_fields:.
+00023c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c90: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00023ca0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+00023cb0: 6572 7661 6c2e 5765 656b 2061 6e64 2069  erval.Week and i
+00023cc0: 6478 2021 3d20 6466 5f66 696e 652e 696e  dx != df_fine.in
+00023cd0: 6465 785b 305d 3a0a 2020 2020 2020 2020  dex[0]:.        
+00023ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023cf0: 2320 4578 6368 616e 6765 2063 6c6f 7365  # Exchange close
+00023d00: 6420 4d6f 6e64 6179 2e20 496e 2074 6869  d Monday. In thi
+00023d10: 7320 6361 7365 2c20 5961 686f 6f20 7365  s case, Yahoo se
+00023d20: 7473 204f 7065 6e20 746f 206c 6173 7420  ts Open to last 
+00023d30: 7765 656b 2063 6c6f 7365 0a20 2020 2020  week close.     
+00023d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d50: 2020 2064 665f 7632 2e6c 6f63 5b69 6478     df_v2.loc[idx
+00023d60: 2c20 224f 7065 6e22 5d20 3d20 6466 5f6c  , "Open"] = df_l
+00023d70: 6173 745f 7765 656b 5b22 436c 6f73 6522  ast_week["Close"
+00023d80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00023d90: 2020 2020 2020 2020 2020 6466 5f76 322e            df_v2.
+00023da0: 6c6f 635b 6964 782c 2022 4c6f 7722 5d20  loc[idx, "Low"] 
+00023db0: 3d20 6d69 6e28 6466 5f76 322e 6c6f 635b  = min(df_v2.loc[
+00023dc0: 6964 782c 2022 4f70 656e 225d 2c20 6466  idx, "Open"], df
+00023dd0: 5f76 322e 6c6f 635b 6964 782c 2022 4c6f  _v2.loc[idx, "Lo
+00023de0: 7722 5d29 0a20 2020 2020 2020 2020 2020  w"]).           
+00023df0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00023e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e10: 2020 2020 2020 2064 665f 7632 2e6c 6f63         df_v2.loc
+00023e20: 5b69 6478 2c20 224f 7065 6e22 5d20 3d20  [idx, "Open"] = 
+00023e30: 6466 5f6e 6577 5f72 6f77 5b22 4f70 656e  df_new_row["Open
+00023e40: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00023e50: 2020 2069 6620 2243 6c6f 7365 2220 696e     if "Close" in
+00023e60: 2062 6164 5f66 6965 6c64 733a 0a20 2020   bad_fields:.   
+00023e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e80: 2064 665f 7632 2e6c 6f63 5b69 6478 2c20   df_v2.loc[idx, 
+00023e90: 2243 6c6f 7365 225d 203d 2064 665f 6e65  "Close"] = df_ne
+00023ea0: 775f 726f 775b 2243 6c6f 7365 225d 0a20  w_row["Close"]. 
+00023eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ec0: 2020 2023 2053 686f 756c 6420 6e6f 7420     # Should not 
+00023ed0: 6e65 6564 2074 6f20 636f 7079 206f 7665  need to copy ove
+00023ee0: 7220 4344 4620 2620 4353 462c 2062 6563  r CDF & CSF, bec
+00023ef0: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
+00023f00: 2020 2020 2020 2020 2023 2063 6f72 7265           # corre
+00023f10: 6374 2076 616c 7565 7320 6172 6520 616c  ct values are al
+00023f20: 7265 6164 7920 6d65 7267 6564 2069 6e20  ready merged in 
+00023f30: 6672 6f6d 2064 6169 6c79 0a20 2020 2020  from daily.     
+00023f40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00023f50: 2064 665f 7632 2e6c 6f63 5b69 6478 2c20   df_v2.loc[idx, 
+00023f60: 2243 4446 225d 203d 2064 665f 6e65 775f  "CDF"] = df_new_
+00023f70: 726f 775b 2243 4446 225d 0a20 2020 2020  row["CDF"].     
+00023f80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00023f90: 2064 665f 7632 2e6c 6f63 5b69 6478 2c20   df_v2.loc[idx, 
+00023fa0: 2243 5346 225d 203d 2064 665f 6e65 775f  "CSF"] = df_new_
+00023fb0: 726f 775b 2243 5346 225d 0a20 2020 2020  row["CSF"].     
+00023fc0: 2020 2020 2020 2020 2020 2069 6620 2256             if "V
+00023fd0: 6f6c 756d 6522 2069 6e20 6261 645f 6669  olume" in bad_fi
+00023fe0: 656c 6473 3a0a 2020 2020 2020 2020 2020  elds:.          
+00023ff0: 2020 2020 2020 2020 2020 6466 5f76 322e            df_v2.
+00024000: 6c6f 635b 6964 782c 2022 566f 6c75 6d65  loc[idx, "Volume
+00024010: 225d 203d 2064 665f 6e65 775f 726f 775b  "] = df_new_row[
+00024020: 2256 6f6c 756d 6522 5d0a 2020 2020 2020  "Volume"].      
+00024030: 2020 2020 2020 2020 2020 6466 5f76 322e            df_v2.
+00024040: 6c6f 635b 6964 782c 2022 5265 7061 6972  loc[idx, "Repair
+00024050: 6564 3f22 5d20 3d20 5472 7565 0a20 2020  ed?"] = True.   
+00024060: 2020 2020 2020 2020 2020 2020 206e 5f66               n_f
+00024070: 6978 6564 202b 3d20 310a 0a20 2020 2020  ixed += 1..     
+00024080: 2020 2020 2020 2023 2052 6573 746f 7265         # Restore
+00024090: 2075 6e2d 7265 7061 6972 6564 2062 6164   un-repaired bad
+000240a0: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
+000240b0: 2020 2020 665f 6e61 6e20 3d20 6466 5f76      f_nan = df_v
+000240c0: 325b 7072 6963 655f 636f 6c73 5d2e 6973  2[price_cols].is
+000240d0: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
+000240e0: 2020 2020 2020 2020 2020 2020 665f 6661              f_fa
+000240f0: 696c 6564 203d 2066 5f74 6167 2026 2066  iled = f_tag & f
+00024100: 5f6e 616e 0a20 2020 2020 2020 2020 2020  _nan.           
+00024110: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
+00024120: 6c65 6e28 7072 6963 655f 636f 6c73 2929  len(price_cols))
+00024130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024140: 2020 6620 3d20 665f 6661 696c 6564 5b3a    f = f_failed[:
+00024150: 2c20 6a5d 0a20 2020 2020 2020 2020 2020  , j].           
+00024160: 2020 2020 2069 6620 662e 616e 7928 293a       if f.any():
+00024170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024180: 2020 2020 2063 203d 2070 7269 6365 5f63       c = price_c
+00024190: 6f6c 735b 6a5d 0a20 2020 2020 2020 2020  ols[j].         
+000241a0: 2020 2020 2020 2020 2020 2064 665f 7632             df_v2
+000241b0: 2e6c 6f63 5b66 2c20 635d 203d 2064 662e  .loc[f, c] = df.
+000241c0: 6c6f 635b 662c 2063 5d0a 0a20 2020 2020  loc[f, c]..     
+000241d0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+000241e0: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
+000241f0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00024200: 2020 2020 2320 506f 7020 7374 6163 6b20      # Pop stack 
+00024210: 7472 6163 650a 2020 2020 2020 2020 2020  trace.          
+00024220: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
+00024230: 662e 5f73 7461 636b 5f74 7261 6365 2920  f._stack_trace) 
+00024240: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00024250: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00024260: 4578 6365 7074 696f 6e28 2246 6169 6c69  Exception("Faili
+00024270: 6e67 2074 6f20 636f 7272 6563 746c 7920  ng to correctly 
+00024280: 7075 7368 2f70 6f70 2073 7461 636b 2074  push/pop stack t
+00024290: 7261 6365 2028 6973 2065 6d70 7479 2074  race (is empty t
+000242a0: 6f6f 2065 6172 6c79 2922 290a 2020 2020  oo early)").    
+000242b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000242c0: 6f74 2073 656c 662e 5f73 7461 636b 5f74  ot self._stack_t
+000242d0: 7261 6365 5b2d 315d 203d 3d20 666e 5f74  race[-1] == fn_t
+000242e0: 7570 6c65 3a0a 2020 2020 2020 2020 2020  uple:.          
+000242f0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+00024300: 696e 2072 616e 6765 286c 656e 2873 656c  in range(len(sel
+00024310: 662e 5f73 7461 636b 5f74 7261 6365 2929  f._stack_trace))
+00024320: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024330: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00024340: 2220 2022 2a69 202b 2073 7472 2873 656c  "  "*i + str(sel
+00024350: 662e 5f73 7461 636b 5f74 7261 6365 5b69  f._stack_trace[i
+00024360: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+00024370: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+00024380: 6365 7074 696f 6e28 2246 6169 6c69 6e67  ception("Failing
+00024390: 2074 6f20 636f 7272 6563 746c 7920 7075   to correctly pu
+000243a0: 7368 2f70 6f70 2073 7461 636b 2074 7261  sh/pop stack tra
+000243b0: 6365 2028 7365 6520 6162 6f76 6529 2229  ce (see above)")
+000243c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000243d0: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+000243e0: 6365 2e70 6f70 286c 656e 2873 656c 662e  ce.pop(len(self.
+000243f0: 5f73 7461 636b 5f74 7261 6365 2920 2d20  _stack_trace) - 
+00024400: 3129 0a0a 2020 2020 2020 2020 6c6f 675f  1)..        log_
+00024410: 6d73 6720 3d20 2250 4d3a 3a5f 7265 636f  msg = "PM::_reco
+00024420: 6e73 7472 7563 745f 696e 7465 7276 616c  nstruct_interval
+00024430: 735f 6261 7463 6828 2920 7265 7475 726e  s_batch() return
+00024440: 696e 6722 0a20 2020 2020 2020 2079 6663  ing".        yfc
+00024450: 6c2e 5472 6163 6545 7869 7428 6c6f 675f  l.TraceExit(log_
+00024460: 6d73 6729 0a0a 2020 2020 2020 2020 7265  msg)..        re
+00024470: 7475 726e 2064 665f 7632 0a0a 2020 2020  turn df_v2..    
+00024480: 6465 6620 5f72 6570 6169 7255 6e69 744d  def _repairUnitM
+00024490: 6978 7570 7328 7365 6c66 2c20 6466 2c20  ixups(self, df, 
+000244a0: 7369 6c65 6e74 3d46 616c 7365 293a 0a20  silent=False):. 
+000244b0: 2020 2020 2020 2064 6632 203d 2073 656c         df2 = sel
+000244c0: 662e 5f66 6978 556e 6974 5377 6974 6368  f._fixUnitSwitch
+000244d0: 2864 6629 0a20 2020 2020 2020 2064 6633  (df).        df3
+000244e0: 203d 2073 656c 662e 5f72 6570 6169 7253   = self._repairS
+000244f0: 706f 7261 6469 6355 6e69 744d 6978 7570  poradicUnitMixup
+00024500: 7328 6466 322c 2073 696c 656e 7429 0a20  s(df2, silent). 
+00024510: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+00024520: 330a 0a20 2020 2064 6566 205f 7265 7061  3..    def _repa
+00024530: 6972 5370 6f72 6164 6963 556e 6974 4d69  irSporadicUnitMi
+00024540: 7875 7073 2873 656c 662c 2064 662c 2073  xups(self, df, s
+00024550: 696c 656e 743d 4661 6c73 6529 3a0a 2020  ilent=False):.  
+00024560: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
+00024570: 6865 636b 4461 7461 4672 616d 6528 6466  heckDataFrame(df
+00024580: 2c20 2264 6622 290a 0a20 2020 2020 2020  , "df")..       
+00024590: 2023 2053 6f6d 6574 696d 6573 2059 6168   # Sometimes Yah
+000245a0: 6f6f 2072 6574 7572 6e73 2066 6577 2070  oo returns few p
+000245b0: 7269 6365 7320 696e 2063 656e 7473 2f70  rices in cents/p
+000245c0: 656e 6365 2069 6e73 7465 6164 206f 6620  ence instead of 
+000245d0: 242f c2a3 0a20 2020 2020 2020 2023 2049  $/...        # I
+000245e0: 2e65 2e20 3130 3078 2062 6967 6765 720a  .e. 100x bigger.
+000245f0: 2020 2020 2020 2020 2320 4561 7379 2074          # Easy t
+00024600: 6f20 6465 7465 6374 2061 6e64 2066 6978  o detect and fix
+00024610: 2c20 6a75 7374 206c 6f6f 6b20 666f 7220  , just look for 
+00024620: 6f75 746c 6965 7273 203d 207e 3130 3078  outliers = ~100x
+00024630: 206c 6f63 616c 206d 6564 6961 6e0a 0a20   local median.. 
+00024640: 2020 2020 2020 2069 6620 6466 2e65 6d70         if df.emp
+00024650: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00024660: 7265 7475 726e 2064 660a 2020 2020 2020  return df.      
+00024670: 2020 6966 2064 662e 7368 6170 655b 305d    if df.shape[0]
+00024680: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+00024690: 2020 2023 204e 6565 6420 6d75 6c74 6970     # Need multip
+000246a0: 6c65 2072 6f77 7320 746f 2063 6f6e 6669  le rows to confi
+000246b0: 6465 6e74 6c79 2069 6465 6e74 6966 7920  dently identify 
+000246c0: 6f75 746c 6965 7273 0a20 2020 2020 2020  outliers.       
+000246d0: 2020 2020 2072 6574 7572 6e20 6466 0a0a       return df..
+000246e0: 2020 2020 2020 2020 6c6f 675f 6d73 675f          log_msg_
+000246f0: 656e 7465 7220 3d20 6622 504d 3a3a 5f72  enter = f"PM::_r
+00024700: 6570 6169 7253 706f 7261 6469 6355 6e69  epairSporadicUni
+00024710: 744d 6978 7570 732d 7b73 656c 662e 6973  tMixups-{self.is
+00024720: 7472 7d28 2922 0a20 2020 2020 2020 206c  tr}()".        l
+00024730: 6f67 5f6d 7367 5f65 7869 7420 3d20 6622  og_msg_exit = f"
+00024740: 504d 3a3a 5f72 6570 6169 7253 706f 7261  PM::_repairSpora
+00024750: 6469 6355 6e69 744d 6978 7570 732d 7b73  dicUnitMixups-{s
+00024760: 656c 662e 6973 7472 7d28 2920 7265 7475  elf.istr}() retu
+00024770: 726e 696e 6722 0a20 2020 2020 2020 2079  rning".        y
+00024780: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
+00024790: 6f67 5f6d 7367 5f65 6e74 6572 290a 0a20  og_msg_enter).. 
+000247a0: 2020 2020 2020 2064 6632 203d 2064 662e         df2 = df.
+000247b0: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
+000247c0: 6461 7461 5f63 6f6c 7320 3d20 5b22 4869  data_cols = ["Hi
+000247d0: 6768 222c 2022 4f70 656e 222c 2022 4c6f  gh", "Open", "Lo
+000247e0: 7722 2c20 2243 6c6f 7365 225d 2020 2320  w", "Close"]  # 
+000247f0: 4f72 6465 7220 696d 706f 7274 616e 742c  Order important,
+00024800: 2073 6570 6172 6174 6520 4869 6768 2066   separate High f
+00024810: 726f 6d20 4c6f 770a 2020 2020 2020 2020  rom Low.        
+00024820: 6461 7461 5f63 6f6c 7320 3d20 5b63 2066  data_cols = [c f
+00024830: 6f72 2063 2069 6e20 6461 7461 5f63 6f6c  or c in data_col
+00024840: 7320 6966 2063 2069 6e20 6466 322e 636f  s if c in df2.co
+00024850: 6c75 6d6e 735d 0a20 2020 2020 2020 2066  lumns].        f
+00024860: 5f7a 6572 6f65 7320 3d20 2864 6632 5b64  _zeroes = (df2[d
+00024870: 6174 615f 636f 6c73 5d20 3d3d 2030 292e  ata_cols] == 0).
+00024880: 616e 7928 6178 6973 3d31 290a 2020 2020  any(axis=1).    
+00024890: 2020 2020 6966 2066 5f7a 6572 6f65 732e      if f_zeroes.
+000248a0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+000248b0: 2020 2064 6632 5f7a 6572 6f65 7320 3d20     df2_zeroes = 
+000248c0: 6466 325b 665f 7a65 726f 6573 5d0a 2020  df2[f_zeroes].  
+000248d0: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
+000248e0: 6466 325b 7e66 5f7a 6572 6f65 735d 0a20  df2[~f_zeroes]. 
+000248f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024900: 2020 2020 2020 2020 2064 6632 5f7a 6572           df2_zer
+00024910: 6f65 7320 3d20 4e6f 6e65 0a20 2020 2020  oes = None.     
+00024920: 2020 2069 6620 6466 322e 7368 6170 655b     if df2.shape[
+00024930: 305d 203c 3d20 313a 0a20 2020 2020 2020  0] <= 1:.       
+00024940: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+00024950: 7869 7428 6c6f 675f 6d73 675f 6578 6974  xit(log_msg_exit
+00024960: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00024970: 7475 726e 2064 660a 2020 2020 2020 2020  turn df.        
+00024980: 6466 325f 6461 7461 203d 2064 6632 5b64  df2_data = df2[d
+00024990: 6174 615f 636f 6c73 5d2e 746f 5f6e 756d  ata_cols].to_num
+000249a0: 7079 2829 0a20 2020 2020 2020 206d 6564  py().        med
+000249b0: 6961 6e20 3d20 5f6e 6469 6d61 6765 2e6d  ian = _ndimage.m
+000249c0: 6564 6961 6e5f 6669 6c74 6572 2864 6632  edian_filter(df2
+000249d0: 5f64 6174 612c 2073 697a 653d 2833 2c20  _data, size=(3, 
+000249e0: 3329 2c20 6d6f 6465 3d22 7772 6170 2229  3), mode="wrap")
+000249f0: 0a20 2020 2020 2020 2072 6174 696f 203d  .        ratio =
+00024a00: 2064 6632 5f64 6174 6120 2f20 6d65 6469   df2_data / medi
+00024a10: 616e 0a20 2020 2020 2020 2072 6174 696f  an.        ratio
+00024a20: 5f72 6f75 6e64 6564 203d 2028 7261 7469  _rounded = (rati
+00024a30: 6f20 2f20 3230 292e 726f 756e 6428 2920  o / 20).round() 
+00024a40: 2a20 3230 2020 2320 726f 756e 6420 7261  * 20  # round ra
+00024a50: 7469 6f20 746f 206e 6561 7265 7374 2032  tio to nearest 2
+00024a60: 300a 2020 2020 2020 2020 6620 3d20 7261  0.        f = ra
+00024a70: 7469 6f5f 726f 756e 6465 6420 3d3d 2031  tio_rounded == 1
+00024a80: 3030 0a20 2020 2020 2020 2072 6174 696f  00.        ratio
+00024a90: 5f72 6370 203d 2031 2e30 2f72 6174 696f  _rcp = 1.0/ratio
+00024aa0: 0a20 2020 2020 2020 2072 6174 696f 5f72  .        ratio_r
+00024ab0: 6370 5f72 6f75 6e64 6564 203d 2028 7261  cp_rounded = (ra
+00024ac0: 7469 6f5f 7263 7020 2f20 3230 292e 726f  tio_rcp / 20).ro
+00024ad0: 756e 6428 2920 2a20 3230 2020 2320 726f  und() * 20  # ro
+00024ae0: 756e 6420 7261 7469 6f20 746f 206e 6561  und ratio to nea
+00024af0: 7265 7374 2032 300a 2020 2020 2020 2020  rest 20.        
+00024b00: 665f 7263 7020 3d20 2872 6174 696f 5f72  f_rcp = (ratio_r
+00024b10: 6f75 6e64 6564 203d 3d20 3130 3029 207c  ounded == 100) |
+00024b20: 2028 7261 7469 6f5f 7263 705f 726f 756e   (ratio_rcp_roun
+00024b30: 6465 6420 3d3d 2031 3030 290a 2020 2020  ded == 100).    
+00024b40: 2020 2020 665f 6569 7468 6572 203d 2066      f_either = f
+00024b50: 207c 2066 5f72 6370 0a20 2020 2020 2020   | f_rcp.       
+00024b60: 2069 6620 6e6f 7420 665f 6569 7468 6572   if not f_either
+00024b70: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00024b80: 2020 2020 7966 636c 2e54 7261 6365 4578      yfcl.TraceEx
+00024b90: 6974 286c 6f67 5f6d 7367 5f65 7869 7429  it(log_msg_exit)
+00024ba0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00024bb0: 7572 6e20 6466 0a0a 2020 2020 2020 2020  urn df..        
+00024bc0: 2320 4d61 726b 2076 616c 7565 7320 746f  # Mark values to
+00024bd0: 2073 656e 6420 666f 7220 7265 7061 6972   send for repair
+00024be0: 0a20 2020 2020 2020 2074 6167 203d 202d  .        tag = -
+00024bf0: 312e 300a 2020 2020 2020 2020 666f 7220  1.0.        for 
+00024c00: 6920 696e 2072 616e 6765 286c 656e 2864  i in range(len(d
+00024c10: 6174 615f 636f 6c73 2929 3a0a 2020 2020  ata_cols)):.    
+00024c20: 2020 2020 2020 2020 6669 203d 2066 5f65          fi = f_e
+00024c30: 6974 6865 725b 3a2c 2069 5d0a 2020 2020  ither[:, i].    
+00024c40: 2020 2020 2020 2020 6320 3d20 6461 7461          c = data
+00024c50: 5f63 6f6c 735b 695d 0a20 2020 2020 2020  _cols[i].       
+00024c60: 2020 2020 2064 6632 2e6c 6f63 5b66 692c       df2.loc[fi,
+00024c70: 2063 5d20 3d20 7461 670a 0a20 2020 2020   c] = tag..     
+00024c80: 2020 206e 5f62 6566 6f72 6520 3d20 2864     n_before = (d
+00024c90: 6632 5f64 6174 6120 3d3d 2074 6167 292e  f2_data == tag).
+00024ca0: 7375 6d28 290a 2020 2020 2020 2020 7472  sum().        tr
+00024cb0: 793a 0a20 2020 2020 2020 2020 2020 2064  y:.            d
+00024cc0: 6632 203d 2073 656c 662e 5f72 6563 6f6e  f2 = self._recon
+00024cd0: 7374 7275 6374 5f69 6e74 6572 7661 6c73  struct_intervals
+00024ce0: 5f62 6174 6368 2864 6632 2c20 7461 673d  _batch(df2, tag=
+00024cf0: 7461 6729 0a20 2020 2020 2020 2065 7863  tag).        exc
+00024d00: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
+00024d10: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00024d20: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
+00024d30: 6163 6529 203e 2030 3a0a 2020 2020 2020  ace) > 0:.      
+00024d40: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00024d50: 7374 6163 6b5f 7472 6163 652e 706f 7028  stack_trace.pop(
+00024d60: 6c65 6e28 7365 6c66 2e5f 7374 6163 6b5f  len(self._stack_
+00024d70: 7472 6163 6529 202d 2031 290a 2020 2020  trace) - 1).    
+00024d80: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+00024d90: 2020 2020 2020 6e5f 6166 7465 7220 3d20        n_after = 
+00024da0: 2864 6632 5b64 6174 615f 636f 6c73 5d2e  (df2[data_cols].
+00024db0: 746f 5f6e 756d 7079 2829 203d 3d20 7461  to_numpy() == ta
+00024dc0: 6729 2e73 756d 2829 0a0a 2020 2020 2020  g).sum()..      
+00024dd0: 2020 6966 206e 5f61 6674 6572 203e 2030    if n_after > 0
+00024de0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00024df0: 5468 6973 2073 6563 6f6e 6420 7061 7373  This second pass
+00024e00: 2077 696c 6c20 2a63 7275 6465 6c79 2a20   will *crudely* 
+00024e10: 2266 6978 2220 616e 7920 7265 6d61 696e  "fix" any remain
+00024e20: 696e 6720 6572 726f 7273 2069 6e20 4869  ing errors in Hi
+00024e30: 6768 2f4c 6f77 0a20 2020 2020 2020 2020  gh/Low.         
+00024e40: 2020 2023 2073 696d 706c 7920 6279 2065     # simply by e
+00024e50: 6e73 7572 696e 6720 7468 6579 2064 6f6e  nsuring they don
+00024e60: 2774 2063 6f6e 7472 6164 6963 7420 652e  't contradict e.
+00024e70: 672e 204c 6f77 203d 2031 3030 7820 4869  g. Low = 100x Hi
+00024e80: 6768 2e0a 2020 2020 2020 2020 2020 2020  gh..            
+00024e90: 6620 3d20 2864 6632 5b64 6174 615f 636f  f = (df2[data_co
+00024ea0: 6c73 5d2e 746f 5f6e 756d 7079 2829 203d  ls].to_numpy() =
+00024eb0: 3d20 7461 6729 2026 2066 0a20 2020 2020  = tag) & f.     
+00024ec0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00024ed0: 7261 6e67 6528 662e 7368 6170 655b 305d  range(f.shape[0]
+00024ee0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00024ef0: 2020 2066 6920 3d20 665b 692c 203a 5d0a     fi = f[i, :].
+00024f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024f10: 6966 206e 6f74 2066 692e 616e 7928 293a  if not fi.any():
+00024f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024f30: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00024f40: 2020 2020 2020 2020 2020 2020 2020 6964                id
+00024f50: 7820 3d20 6466 322e 696e 6465 785b 695d  x = df2.index[i]
+00024f60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00024f70: 2020 666f 7220 6320 696e 205b 274f 7065    for c in ['Ope
+00024f80: 6e27 2c20 2743 6c6f 7365 275d 3a0a 2020  n', 'Close']:.  
+00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fa0: 2020 6a20 3d20 6461 7461 5f63 6f6c 732e    j = data_cols.
+00024fb0: 696e 6465 7828 6329 0a20 2020 2020 2020  index(c).       
+00024fc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00024fd0: 6669 5b6a 5d3a 0a20 2020 2020 2020 2020  fi[j]:.         
+00024fe0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00024ff0: 6632 2e6c 6f63 5b69 6478 2c20 635d 203d  f2.loc[idx, c] =
+00025000: 2064 662e 6c6f 635b 6964 782c 2063 5d20   df.loc[idx, c] 
+00025010: 2a20 302e 3031 0a0a 2020 2020 2020 2020  * 0.01..        
+00025020: 2020 2020 2020 2020 6320 3d20 2248 6967          c = "Hig
+00025030: 6822 203b 206a 203d 2064 6174 615f 636f  h" ; j = data_co
+00025040: 6c73 2e69 6e64 6578 2863 290a 2020 2020  ls.index(c).    
+00025050: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00025060: 695b 6a5d 3a0a 2020 2020 2020 2020 2020  i[j]:.          
+00025070: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
+00025080: 635b 6964 782c 2063 5d20 3d20 6466 322e  c[idx, c] = df2.
+00025090: 6c6f 635b 6964 782c 205b 224f 7065 6e22  loc[idx, ["Open"
+000250a0: 2c20 2243 6c6f 7365 225d 5d2e 6d61 7828  , "Close"]].max(
+000250b0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000250c0: 2020 2063 203d 2022 4c6f 7722 203b 206a     c = "Low" ; j
+000250d0: 203d 2064 6174 615f 636f 6c73 2e69 6e64   = data_cols.ind
+000250e0: 6578 2863 290a 2020 2020 2020 2020 2020  ex(c).          
+000250f0: 2020 2020 2020 6966 2066 695b 6a5d 3a0a        if fi[j]:.
+00025100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025110: 2020 2020 6466 322e 6c6f 635b 6964 782c      df2.loc[idx,
+00025120: 2063 5d20 3d20 6466 322e 6c6f 635b 6964   c] = df2.loc[id
+00025130: 782c 205b 224f 7065 6e22 2c20 2243 6c6f  x, ["Open", "Clo
+00025140: 7365 225d 5d2e 6d69 6e28 290a 0a20 2020  se"]].min()..   
+00025150: 2020 2020 2020 2020 2066 5f72 6370 203d           f_rcp =
+00025160: 2028 6466 325b 6461 7461 5f63 6f6c 735d   (df2[data_cols]
+00025170: 2e74 6f5f 6e75 6d70 7928 2920 3d3d 2074  .to_numpy() == t
+00025180: 6167 2920 2620 665f 7263 700a 2020 2020  ag) & f_rcp.    
+00025190: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+000251a0: 2072 616e 6765 2866 5f72 6370 2e73 6861   range(f_rcp.sha
+000251b0: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
+000251c0: 2020 2020 2020 2020 6669 203d 2066 5f72          fi = f_r
+000251d0: 6370 5b69 2c20 3a5d 0a20 2020 2020 2020  cp[i, :].       
+000251e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000251f0: 6669 2e61 6e79 2829 3a0a 2020 2020 2020  fi.any():.      
+00025200: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00025210: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00025220: 2020 2020 2020 2069 6478 203d 2064 6632         idx = df2
+00025230: 2e69 6e64 6578 5b69 5d0a 0a20 2020 2020  .index[i]..     
+00025240: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00025250: 2069 6e20 5b27 4f70 656e 272c 2027 436c   in ['Open', 'Cl
+00025260: 6f73 6527 5d3a 0a20 2020 2020 2020 2020  ose']:.         
+00025270: 2020 2020 2020 2020 2020 206a 203d 2064             j = d
+00025280: 6174 615f 636f 6c73 2e69 6e64 6578 2863  ata_cols.index(c
+00025290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000252a0: 2020 2020 2020 6966 2066 695b 6a5d 3a0a        if fi[j]:.
+000252b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252c0: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
+000252d0: 6964 782c 2063 5d20 3d20 6466 2e6c 6f63  idx, c] = df.loc
+000252e0: 5b69 6478 2c20 635d 202a 2031 3030 2e30  [idx, c] * 100.0
+000252f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00025300: 2020 6320 3d20 2248 6967 6822 203b 206a    c = "High" ; j
+00025310: 203d 2064 6174 615f 636f 6c73 2e69 6e64   = data_cols.ind
+00025320: 6578 2863 290a 2020 2020 2020 2020 2020  ex(c).          
+00025330: 2020 2020 2020 6966 2066 695b 6a5d 3a0a        if fi[j]:.
+00025340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025350: 2020 2020 6466 322e 6c6f 635b 6964 782c      df2.loc[idx,
+00025360: 2063 5d20 3d20 6466 322e 6c6f 635b 6964   c] = df2.loc[id
+00025370: 782c 205b 224f 7065 6e22 2c20 2243 6c6f  x, ["Open", "Clo
+00025380: 7365 225d 5d2e 6d61 7828 290a 0a20 2020  se"]].max()..   
+00025390: 2020 2020 2020 2020 2020 2020 2063 203d               c =
+000253a0: 2022 4c6f 7722 203b 206a 203d 2064 6174   "Low" ; j = dat
+000253b0: 615f 636f 6c73 2e69 6e64 6578 2863 290a  a_cols.index(c).
+000253c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253d0: 6966 2066 695b 6a5d 3a0a 2020 2020 2020  if fi[j]:.      
+000253e0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+000253f0: 322e 6c6f 635b 6964 782c 2063 5d20 3d20  2.loc[idx, c] = 
+00025400: 6466 322e 6c6f 635b 6964 782c 205b 224f  df2.loc[idx, ["O
+00025410: 7065 6e22 2c20 2243 6c6f 7365 225d 5d2e  pen", "Close"]].
+00025420: 6d69 6e28 290a 0a20 2020 2020 2020 206e  min()..        n
+00025430: 5f61 6674 6572 5f63 7275 6465 203d 2028  _after_crude = (
+00025440: 6466 325b 6461 7461 5f63 6f6c 735d 2e74  df2[data_cols].t
+00025450: 6f5f 6e75 6d70 7928 2920 3d3d 2074 6167  o_numpy() == tag
+00025460: 292e 7375 6d28 290a 0a20 2020 2020 2020  ).sum()..       
+00025470: 206e 5f66 6978 6564 203d 206e 5f62 6566   n_fixed = n_bef
+00025480: 6f72 6520 2d20 6e5f 6166 7465 725f 6372  ore - n_after_cr
+00025490: 7564 650a 2020 2020 2020 2020 6e5f 6669  ude.        n_fi
+000254a0: 7865 645f 6372 7564 656c 7920 3d20 6e5f  xed_crudely = n_
+000254b0: 6166 7465 7220 2d20 6e5f 6166 7465 725f  after - n_after_
+000254c0: 6372 7564 650a 2020 2020 2020 2020 6966  crude.        if
+000254d0: 206e 6f74 2073 696c 656e 7420 616e 6420   not silent and 
+000254e0: 6e5f 6669 7865 6420 3e20 303a 0a20 2020  n_fixed > 0:.   
+000254f0: 2020 2020 2020 2020 2072 6570 6f72 745f           report_
+00025500: 6d73 6720 3d20 6622 7b73 656c 662e 7469  msg = f"{self.ti
+00025510: 636b 6572 7d3a 2066 6978 6564 207b 6e5f  cker}: fixed {n_
+00025520: 6669 7865 647d 2f7b 6e5f 6265 666f 7265  fixed}/{n_before
+00025530: 7d20 6375 7272 656e 6379 2075 6e69 7420  } currency unit 
+00025540: 6d69 7875 7073 2022 0a20 2020 2020 2020  mixups ".       
+00025550: 2020 2020 2069 6620 6e5f 6669 7865 645f       if n_fixed_
+00025560: 6372 7564 656c 7920 3e20 303a 0a20 2020  crudely > 0:.   
+00025570: 2020 2020 2020 2020 2020 2020 2072 6570               rep
+00025580: 6f72 745f 6d73 6720 2b3d 2066 2228 7b6e  ort_msg += f"({n
+00025590: 5f66 6978 6564 5f63 7275 6465 6c79 7d20  _fixed_crudely} 
+000255a0: 6372 7564 656c 7929 2022 0a20 2020 2020  crudely) ".     
+000255b0: 2020 2020 2020 2072 6570 6f72 745f 6d73         report_ms
+000255c0: 6720 2b3d 2066 2269 6e20 7b73 656c 662e  g += f"in {self.
+000255d0: 696e 7465 7276 616c 7d20 7072 6963 6520  interval} price 
+000255e0: 6461 7461 220a 2020 2020 2020 2020 2020  data".          
+000255f0: 2020 7072 696e 7428 7265 706f 7274 5f6d    print(report_m
+00025600: 7367 290a 0a20 2020 2020 2020 2023 2052  sg)..        # R
+00025610: 6573 746f 7265 206f 7269 6769 6e61 6c20  estore original 
+00025620: 7661 6c75 6573 2077 6865 7265 2072 6570  values where rep
+00025630: 6169 7220 6661 696c 6564 0a20 2020 2020  air failed.     
+00025640: 2020 2066 5f65 6974 6865 7220 3d20 6466     f_either = df
+00025650: 325b 6461 7461 5f63 6f6c 735d 2e74 6f5f  2[data_cols].to_
+00025660: 6e75 6d70 7928 2920 3d3d 2074 6167 0a20  numpy() == tag. 
+00025670: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+00025680: 7261 6e67 6528 6c65 6e28 6461 7461 5f63  range(len(data_c
+00025690: 6f6c 7329 293a 0a20 2020 2020 2020 2020  ols)):.         
+000256a0: 2020 2066 6a20 3d20 665f 6569 7468 6572     fj = f_either
+000256b0: 5b3a 2c20 6a5d 0a20 2020 2020 2020 2020  [:, j].         
+000256c0: 2020 2069 6620 666a 2e61 6e79 2829 3a0a     if fj.any():.
+000256d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000256e0: 6320 3d20 6461 7461 5f63 6f6c 735b 6a5d  c = data_cols[j]
+000256f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025700: 2064 6632 2e6c 6f63 5b66 6a2c 2063 5d20   df2.loc[fj, c] 
+00025710: 3d20 6466 2e6c 6f63 5b66 6a2c 2063 5d0a  = df.loc[fj, c].
+00025720: 2020 2020 2020 2020 6966 2064 6632 5f7a          if df2_z
+00025730: 6572 6f65 7320 6973 206e 6f74 204e 6f6e  eroes is not Non
+00025740: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00025750: 6632 203d 2070 642e 636f 6e63 6174 285b  f2 = pd.concat([
+00025760: 6466 322c 2064 6632 5f7a 6572 6f65 735d  df2, df2_zeroes]
+00025770: 292e 736f 7274 5f69 6e64 6578 2829 0a20  ).sort_index(). 
+00025780: 2020 2020 2020 2020 2020 2064 6632 2e69             df2.i
+00025790: 6e64 6578 203d 2070 642e 746f 5f64 6174  ndex = pd.to_dat
+000257a0: 6574 696d 6528 290a 0a20 2020 2020 2020  etime()..       
+000257b0: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
+000257c0: 6c6f 675f 6d73 675f 6578 6974 290a 0a20  log_msg_exit).. 
+000257d0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+000257e0: 320a 0a20 2020 2064 6566 205f 6669 7855  2..    def _fixU
+000257f0: 6e69 7453 7769 7463 6828 7365 6c66 2c20  nitSwitch(self, 
+00025800: 6466 293a 0a20 2020 2020 2020 2023 2053  df):.        # S
+00025810: 6f6d 6574 696d 6573 2059 6168 6f6f 2072  ometimes Yahoo r
+00025820: 6574 7572 6e73 2066 6577 2070 7269 6365  eturns few price
+00025830: 7320 696e 2063 656e 7473 2f70 656e 6365  s in cents/pence
+00025840: 2069 6e73 7465 6164 206f 6620 242f c2a3   instead of $/..
+00025850: 0a20 2020 2020 2020 2023 2049 2e65 2e20  .        # I.e. 
+00025860: 3130 3078 2062 6967 6765 720a 2020 2020  100x bigger.    
+00025870: 2020 2020 2320 3220 7761 7973 2074 6869      # 2 ways thi
+00025880: 7320 6d61 6e69 6665 7374 733a 0a20 2020  s manifests:.   
+00025890: 2020 2020 2023 202d 2072 616e 646f 6d20       # - random 
+000258a0: 3130 3078 2065 7272 6f72 7320 7370 7265  100x errors spre
+000258b0: 6164 2074 6872 6f75 6768 6f75 7420 7461  ad throughout ta
+000258c0: 626c 650a 2020 2020 2020 2020 2320 2d20  ble.        # - 
+000258d0: 6120 7375 6464 656e 2073 7769 7463 6820  a sudden switch 
+000258e0: 6265 7477 6565 6e20 243c 2d3e 6365 6e74  between $<->cent
+000258f0: 7320 6174 2073 6f6d 6520 6461 7465 0a20  s at some date. 
+00025900: 2020 2020 2020 2023 2054 6869 7320 6675         # This fu
+00025910: 6e63 7469 6f6e 2066 6978 6573 2074 6865  nction fixes the
+00025920: 2073 6563 6f6e 642e 0a20 2020 2020 2020   second..       
+00025930: 2023 2045 7665 6e74 7561 6c6c 7920 5961   # Eventually Ya
+00025940: 686f 6f20 6669 7865 7320 6275 7420 636f  hoo fixes but co
+00025950: 756c 6420 7461 6b65 2074 6865 6d20 3220  uld take them 2 
+00025960: 7765 656b 732e 0a0a 2020 2020 2020 2020  weeks...        
+00025970: 7265 7475 726e 2073 656c 662e 5f66 6978  return self._fix
+00025980: 5072 6963 6573 5375 6464 656e 4368 616e  PricesSuddenChan
+00025990: 6765 2864 662c 2031 3030 2e30 290a 0a20  ge(df, 100.0).. 
+000259a0: 2020 2064 6566 205f 6669 7842 6164 5374     def _fixBadSt
+000259b0: 6f63 6b53 706c 6974 7328 7365 6c66 2c20  ockSplits(self, 
+000259c0: 6466 293a 0a20 2020 2020 2020 2023 204f  df):.        # O
+000259d0: 7269 6769 6e61 6c20 6c6f 6769 6320 6f6e  riginal logic on
+000259e0: 6c79 2063 6f6e 7369 6465 7265 6420 6c61  ly considered la
+000259f0: 7465 7374 2073 706c 6974 2061 646a 7573  test split adjus
+00025a00: 746d 656e 7420 636f 756c 6420 6265 206d  tment could be m
+00025a10: 6973 7369 6e67 2c20 6275 7420 0a20 2020  issing, but .   
+00025a20: 2020 2020 2023 2061 6374 7561 6c6c 7920       # actually 
+00025a30: 2a2a 616e 792a 2a20 7370 6c69 7420 6164  **any** split ad
+00025a40: 6a75 7374 6d65 6e74 2063 616e 2062 6520  justment can be 
+00025a50: 6d69 7373 696e 672e 2053 6f20 6368 6563  missing. So chec
+00025a60: 6b20 616c 6c20 7370 6c69 7473 2069 6e20  k all splits in 
+00025a70: 6466 2e0a 2020 2020 2020 2020 230a 2020  df..        #.  
+00025a80: 2020 2020 2020 2320 496d 7072 6f76 6564        # Improved
+00025a90: 206c 6f67 6963 206c 6f6f 6b73 2066 6f72   logic looks for
+00025aa0: 2042 4947 2064 6169 6c79 2070 7269 6365   BIG daily price
+00025ab0: 2063 6861 6e67 6573 2074 6861 7420 636c   changes that cl
+00025ac0: 6f73 656c 7920 6d61 7463 6820 7468 650a  osely match the.
+00025ad0: 2020 2020 2020 2020 2320 2a2a 6e65 6172          # **near
+00025ae0: 6573 7420 6675 7475 7265 2a2a 2073 746f  est future** sto
+00025af0: 636b 2073 706c 6974 2072 6174 696f 2e20  ck split ratio. 
+00025b00: 5468 6973 2069 6e64 6963 6174 6573 2059  This indicates Y
+00025b10: 6168 6f6f 2066 6169 6c65 6420 746f 2061  ahoo failed to a
+00025b20: 7070 6c79 2061 206e 6577 0a20 2020 2020  pply a new.     
+00025b30: 2020 2023 2073 746f 636b 2073 706c 6974     # stock split
+00025b40: 2074 6f20 6f6c 6420 7072 6963 6520 6461   to old price da
+00025b50: 7461 2e0a 2020 2020 2020 2020 230a 2020  ta..        #.  
+00025b60: 2020 2020 2020 2320 5468 6572 6520 6973        # There is
+00025b70: 2061 2073 6c69 6768 7420 636f 6d70 6c69   a slight compli
+00025b80: 6361 7469 6f6e 2c20 6265 6361 7573 6520  cation, because 
+00025b90: 5961 686f 6f20 646f 6573 2061 6e6f 7468  Yahoo does anoth
+00025ba0: 6572 2073 7475 7069 6420 7468 696e 672e  er stupid thing.
+00025bb0: 0a20 2020 2020 2020 2023 2053 6f6d 6574  .        # Somet
+00025bc0: 696d 6573 2074 6865 206f 6c64 2064 6174  imes the old dat
+00025bd0: 6120 6973 2061 646a 7573 7465 6420 7477  a is adjusted tw
+00025be0: 6963 652e 2053 6f20 6361 6e6e 6f74 2073  ice. So cannot s
+00025bf0: 696d 706c 7920 6173 7375 6d65 0a20 2020  imply assume.   
+00025c00: 2020 2020 2023 2077 6869 6368 2064 6972       # which dir
+00025c10: 6563 7469 6f6e 2074 6f20 7265 7665 7273  ection to revers
+00025c20: 6520 6164 6a75 7374 6d65 6e74 202d 2068  e adjustment - h
+00025c30: 6176 6520 746f 2061 6e61 6c79 7365 2070  ave to analyse p
+00025c40: 7269 6365 7320 616e 6420 6465 7465 6374  rices and detect
+00025c50: 2e0a 2020 2020 2020 2020 2320 4e6f 7420  ..        # Not 
+00025c60: 6469 6666 6963 756c 742e 0a0a 2020 2020  difficult...    
+00025c70: 2020 2020 6966 2064 662e 656d 7074 793a      if df.empty:
+00025c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00025c90: 7572 6e20 6466 0a0a 2020 2020 2020 2020  urn df..        
+00025ca0: 6966 206e 6f74 2073 656c 662e 696e 7465  if not self.inte
+00025cb0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00025cc0: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
+00025cd0: 2020 2020 2064 6620 3d20 6466 2e73 6f72       df = df.sor
+00025ce0: 745f 696e 6465 7828 2920 2020 2320 7363  t_index()   # sc
+00025cf0: 616e 2073 706c 6974 7320 6f6c 6465 7374  an splits oldest
+00025d00: 202d 3e20 6e65 7765 7374 0a20 2020 2020   -> newest.     
+00025d10: 2020 2073 706c 6974 5f66 203d 2064 665b     split_f = df[
+00025d20: 2753 746f 636b 2053 706c 6974 7327 5d2e  'Stock Splits'].
+00025d30: 746f 5f6e 756d 7079 2829 2021 3d20 300a  to_numpy() != 0.
+00025d40: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00025d50: 706c 6974 5f66 2e61 6e79 2829 3a0a 2020  plit_f.any():.  
+00025d60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00025d70: 2064 660a 0a20 2020 2020 2020 2066 6f72   df..        for
+00025d80: 2073 706c 6974 5f69 6478 2069 6e20 6e70   split_idx in np
+00025d90: 2e77 6865 7265 2873 706c 6974 5f66 295b  .where(split_f)[
+00025da0: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
+00025db0: 7370 6c69 745f 6474 203d 2064 662e 696e  split_dt = df.in
+00025dc0: 6465 785b 7370 6c69 745f 6964 785d 0a20  dex[split_idx]. 
+00025dd0: 2020 2020 2020 2020 2020 2073 706c 6974             split
+00025de0: 203d 2064 662e 6c6f 635b 7370 6c69 745f   = df.loc[split_
+00025df0: 6474 2c20 2753 746f 636b 2053 706c 6974  dt, 'Stock Split
+00025e00: 7327 5d0a 2020 2020 2020 2020 2020 2020  s'].            
+00025e10: 6966 2073 706c 6974 5f64 7420 3d3d 2064  if split_dt == d
+00025e20: 662e 696e 6465 785b 305d 3a0a 2020 2020  f.index[0]:.    
+00025e30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00025e40: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00025e50: 2020 2320 6c6f 6767 6572 2e64 6562 7567    # logger.debug
+00025e60: 2866 2770 7269 6365 2d72 6570 6169 722d  (f'price-repair-
+00025e70: 7370 6c69 743a 2043 6865 636b 696e 6720  split: Checking 
+00025e80: 7370 6c69 7420 7b73 706c 6974 3a2e 3466  split {split:.4f
+00025e90: 7d20 4020 7b73 706c 6974 5f64 742e 6461  } @ {split_dt.da
+00025ea0: 7465 2829 7d20 666f 7220 706f 7373 6962  te()} for possib
+00025eb0: 6c65 2072 6570 6169 7227 290a 0a20 2020  le repair')..   
+00025ec0: 2020 2020 2020 2020 2063 7574 6f66 665f           cutoff_
+00025ed0: 6964 7820 3d20 6d69 6e28 6466 2e73 6861  idx = min(df.sha
+00025ee0: 7065 5b30 5d2c 2073 706c 6974 5f69 6478  pe[0], split_idx
+00025ef0: 2b31 2920 2023 2061 6464 206f 6e65 2072  +1)  # add one r
+00025f00: 6f77 2061 6674 6572 2074 6f20 6465 7465  ow after to dete
+00025f10: 6374 2062 6967 2063 6861 6e67 650a 2020  ct big change.  
+00025f20: 2020 2020 2020 2020 2020 6466 5f70 7265            df_pre
+00025f30: 5f73 706c 6974 203d 2064 662e 696c 6f63  _split = df.iloc
+00025f40: 5b30 3a63 7574 6f66 665f 6964 782b 315d  [0:cutoff_idx+1]
+00025f50: 0a0a 2020 2020 2020 2020 2020 2020 6466  ..            df
+00025f60: 5f70 7265 5f73 706c 6974 5f72 6570 6169  _pre_split_repai
+00025f70: 7265 6420 3d20 7365 6c66 2e5f 6669 7850  red = self._fixP
+00025f80: 7269 6365 7353 7564 6465 6e43 6861 6e67  ricesSuddenChang
+00025f90: 6528 6466 5f70 7265 5f73 706c 6974 2c20  e(df_pre_split, 
+00025fa0: 7370 6c69 742c 2063 6f72 7265 6374 5f76  split, correct_v
+00025fb0: 6f6c 756d 653d 5472 7565 290a 2020 2020  olume=True).    
+00025fc0: 2020 2020 2020 2020 2320 4d65 7267 6520          # Merge 
+00025fd0: 6261 636b 2069 6e3a 0a20 2020 2020 2020  back in:.       
+00025fe0: 2020 2020 2069 6620 6375 746f 6666 5f69       if cutoff_i
+00025ff0: 6478 203d 3d20 6466 2e73 6861 7065 5b30  dx == df.shape[0
+00026000: 5d2d 313a 0a20 2020 2020 2020 2020 2020  ]-1:.           
+00026010: 2020 2020 2064 6620 3d20 6466 5f70 7265       df = df_pre
+00026020: 5f73 706c 6974 5f72 6570 6169 7265 640a  _split_repaired.
+00026030: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00026040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026050: 2020 6466 203d 2070 642e 636f 6e63 6174    df = pd.concat
+00026060: 285b 6466 5f70 7265 5f73 706c 6974 5f72  ([df_pre_split_r
+00026070: 6570 6169 7265 642e 736f 7274 5f69 6e64  epaired.sort_ind
+00026080: 6578 2829 2c20 6466 2e69 6c6f 635b 6375  ex(), df.iloc[cu
+00026090: 746f 6666 5f69 6478 2b31 3a5d 5d29 0a20  toff_idx+1:]]). 
+000260a0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+000260b0: 0a0a 2020 2020 6465 6620 5f66 6978 5072  ..    def _fixPr
+000260c0: 6963 6573 5375 6464 656e 4368 616e 6765  icesSuddenChange
+000260d0: 2873 656c 662c 2064 662c 2063 6861 6e67  (self, df, chang
+000260e0: 652c 2063 6f72 7265 6374 5f76 6f6c 756d  e, correct_volum
+000260f0: 653d 4661 6c73 6529 3a0a 2020 2020 2020  e=False):.      
+00026100: 2020 6c6f 675f 6675 6e63 203d 2066 2250    log_func = f"P
+00026110: 4d3a 3a5f 6669 7850 7269 6365 7353 7564  M::_fixPricesSud
+00026120: 6465 6e43 6861 6e67 652d 7b73 656c 662e  denChange-{self.
+00026130: 6973 7472 7d28 6368 616e 6765 3d7b 6368  istr}(change={ch
+00026140: 616e 6765 3a2e 3266 7d29 220a 2020 2020  ange:.2f})".    
+00026150: 2020 2020 7966 636c 2e54 7261 6365 456e      yfcl.TraceEn
+00026160: 7465 7228 6c6f 675f 6675 6e63 290a 0a20  ter(log_func).. 
+00026170: 2020 2020 2020 2064 6632 203d 2064 662e         df2 = df.
+00026180: 736f 7274 5f69 6e64 6578 2861 7363 656e  sort_index(ascen
+00026190: 6469 6e67 3d46 616c 7365 290a 2020 2020  ding=False).    
+000261a0: 2020 2020 7370 6c69 7420 3d20 6368 616e      split = chan
+000261b0: 6765 0a20 2020 2020 2020 2073 706c 6974  ge.        split
+000261c0: 5f72 6370 203d 2031 2e30 202f 2073 706c  _rcp = 1.0 / spl
+000261d0: 6974 0a0a 2020 2020 2020 2020 6966 2063  it..        if c
+000261e0: 6861 6e67 6520 696e 205b 3130 302e 302c  hange in [100.0,
+000261f0: 2030 2e30 315d 3a0a 2020 2020 2020 2020   0.01]:.        
+00026200: 2020 2020 6669 785f 7479 7065 203d 2027      fix_type = '
+00026210: 3130 3078 2065 7272 6f72 270a 2020 2020  100x error'.    
+00026220: 2020 2020 2020 2020 7374 6172 745f 6d69          start_mi
+00026230: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
+00026240: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00026250: 2020 2066 6978 5f74 7970 6520 3d20 2762     fix_type = 'b
+00026260: 6164 2073 706c 6974 270a 2020 2020 2020  ad split'.      
+00026270: 2020 2020 2020 6620 3d20 6466 325b 2753        f = df2['S
+00026280: 746f 636b 2053 706c 6974 7327 5d2e 746f  tock Splits'].to
+00026290: 5f6e 756d 7079 2829 2021 3d20 302e 300a  _numpy() != 0.0.
+000262a0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+000262b0: 745f 6d69 6e20 3d20 2864 6632 2e69 6e64  t_min = (df2.ind
+000262c0: 6578 5b66 5d2e 6d69 6e28 2920 2d20 6461  ex[f].min() - da
+000262d0: 7465 7574 696c 2e72 656c 6174 6976 6564  teutil.relatived
+000262e0: 656c 7461 2e72 656c 6174 6976 6564 656c  elta.relativedel
+000262f0: 7461 2879 6561 7273 3d31 2929 2e64 6174  ta(years=1)).dat
+00026300: 6528 290a 0a20 2020 2020 2020 204f 484c  e()..        OHL
+00026310: 4320 3d20 5b27 4f70 656e 272c 2027 4869  C = ['Open', 'Hi
+00026320: 6768 272c 2027 4c6f 7727 2c20 2743 6c6f  gh', 'Low', 'Clo
+00026330: 7365 275d 0a0a 2020 2020 2020 2020 2320  se']..        # 
+00026340: 446f 206e 6f74 2061 7474 656d 7074 2072  Do not attempt r
+00026350: 6570 6169 7220 6f66 2074 6865 2073 706c  epair of the spl
+00026360: 6974 2069 7320 736d 616c 6c2c 200a 2020  it is small, .  
+00026370: 2020 2020 2020 2320 636f 756c 6420 6265        # could be
+00026380: 206d 6973 7461 6b65 6e20 666f 7220 6e6f   mistaken for no
+00026390: 726d 616c 2070 7269 6365 2076 6172 6961  rmal price varia
+000263a0: 6e63 650a 2020 2020 2020 2020 6966 2030  nce.        if 0
+000263b0: 2e38 203c 2073 706c 6974 203c 2031 2e32  .8 < split < 1.2
+000263c0: 353a 0a20 2020 2020 2020 2020 2020 2079  5:.            y
+000263d0: 6663 6c2e 5472 6163 6545 7869 7428 6c6f  fcl.TraceExit(lo
+000263e0: 675f 6675 6e63 202b 2022 3a20 6162 6f72  g_func + ": abor
+000263f0: 7469 6e67 2c20 7370 6c69 7420 746f 6f20  ting, split too 
+00026400: 6e65 6172 2031 2e30 2229 0a20 2020 2020  near 1.0").     
+00026410: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+00026420: 0a0a 2020 2020 2020 2020 6e20 3d20 6466  ..        n = df
+00026430: 322e 7368 6170 655b 305d 0a0a 2020 2020  2.shape[0]..    
+00026440: 2020 2020 6466 5f64 6562 7567 203d 2064      df_debug = d
+00026450: 6632 2e63 6f70 7928 290a 2020 2020 2020  f2.copy().      
+00026460: 2020 6466 5f64 6562 7567 203d 2064 665f    df_debug = df_
+00026470: 6465 6275 672e 6472 6f70 285b 2756 6f6c  debug.drop(['Vol
+00026480: 756d 6527 2c20 2744 6976 6964 656e 6473  ume', 'Dividends
+00026490: 272c 2027 5265 7061 6972 6564 3f27 5d2c  ', 'Repaired?'],
+000264a0: 2061 7869 733d 312c 2065 7272 6f72 733d   axis=1, errors=
+000264b0: 2769 676e 6f72 6527 290a 2020 2020 2020  'ignore').      
+000264c0: 2020 6466 5f64 6562 7567 203d 2064 665f    df_debug = df_
+000264d0: 6465 6275 672e 6472 6f70 285b 2743 4446  debug.drop(['CDF
+000264e0: 272c 2027 4353 4627 2c20 2743 2d43 6865  ', 'CSF', 'C-Che
+000264f0: 636b 3f27 2c20 274c 6173 7444 6976 4164  ck?', 'LastDivAd
+00026500: 6a75 7374 4474 272c 2027 4c61 7374 5370  justDt', 'LastSp
+00026510: 6c69 7441 646a 7573 7444 7427 5d2c 2061  litAdjustDt'], a
+00026520: 7869 733d 312c 2065 7272 6f72 733d 2769  xis=1, errors='i
+00026530: 676e 6f72 6527 290a 2020 2020 2020 2020  gnore').        
+00026540: 6465 6275 675f 636f 6c73 203d 205b 274f  debug_cols = ['O
+00026550: 7065 6e27 2c20 2743 6c6f 7365 275d 0a20  pen', 'Close']. 
+00026560: 2020 2020 2020 2064 665f 6465 6275 6720         df_debug 
+00026570: 3d20 6466 5f64 6562 7567 2e64 726f 7028  = df_debug.drop(
+00026580: 5b63 2066 6f72 2063 2069 6e20 4f48 4c43  [c for c in OHLC
+00026590: 2069 6620 6320 6e6f 7420 696e 2064 6562   if c not in deb
+000265a0: 7567 5f63 6f6c 735d 2c20 6178 6973 3d31  ug_cols], axis=1
+000265b0: 2c20 6572 726f 7273 3d27 6967 6e6f 7265  , errors='ignore
+000265c0: 2729 0a0a 2020 2020 2020 2020 2320 4361  ')..        # Ca
+000265d0: 6c63 756c 6174 6520 6461 696c 7920 7072  lculate daily pr
+000265e0: 6963 6520 2520 6368 616e 6765 2e20 546f  ice % change. To
+000265f0: 2072 6564 7563 6520 6566 6665 6374 206f   reduce effect o
+00026600: 6620 7072 6963 6520 766f 6c61 7469 6c69  f price volatili
+00026610: 7479 2c20 0a20 2020 2020 2020 2023 2063  ty, .        # c
+00026620: 616c 6375 6c61 7465 2063 6861 6e67 6520  alculate change 
+00026630: 666f 7220 6561 6368 204f 484c 4320 636f  for each OHLC co
+00026640: 6c75 6d6e 2e0a 2020 2020 2020 2020 6966  lumn..        if
+00026650: 2073 656c 662e 696e 7465 7264 6179 2061   self.interday a
+00026660: 6e64 2073 656c 662e 696e 7465 7276 616c  nd self.interval
+00026670: 2021 3d20 7966 6364 2e49 6e74 6572 7661   != yfcd.Interva
+00026680: 6c2e 4461 7973 3120 616e 6420 7370 6c69  l.Days1 and spli
+00026690: 7420 6e6f 7420 696e 205b 3130 302e 302c  t not in [100.0,
+000266a0: 2031 3030 2c20 302e 3030 315d 3a0a 2020   100, 0.001]:.  
+000266b0: 2020 2020 2020 2020 2020 2320 4176 6f69            # Avoi
+000266c0: 6420 7573 696e 6720 274c 6f77 2720 616e  d using 'Low' an
+000266d0: 6420 2748 6967 6827 2e20 466f 7220 6d75  d 'High'. For mu
+000266e0: 6c74 6964 6179 2069 6e74 6572 7661 6c73  ltiday intervals
+000266f0: 2c20 7468 6573 6520 6361 6e20 6265 200a  , these can be .
+00026700: 2020 2020 2020 2020 2020 2020 2320 7665              # ve
+00026710: 7279 2076 6f6c 6174 696c 6520 736f 2072  ry volatile so r
+00026720: 6564 7563 6520 6162 696c 6974 7920 746f  educe ability to
+00026730: 2064 6574 6563 7420 6765 6e75 696e 6520   detect genuine 
+00026740: 7374 6f63 6b20 7370 6c69 7420 6572 726f  stock split erro
+00026750: 7273 0a20 2020 2020 2020 2020 2020 205f  rs.            _
+00026760: 3164 5f63 6861 6e67 655f 7820 3d20 6e70  1d_change_x = np
+00026770: 2e66 756c 6c28 286e 2c20 3229 2c20 312e  .full((n, 2), 1.
+00026780: 3029 0a20 2020 2020 2020 2020 2020 2070  0).            p
+00026790: 7269 6365 5f64 6174 6120 3d20 6466 325b  rice_data = df2[
+000267a0: 5b27 4f70 656e 272c 2743 6c6f 7365 275d  ['Open','Close']
+000267b0: 5d2e 746f 5f6e 756d 7079 2829 0a20 2020  ].to_numpy().   
+000267c0: 2020 2020 2020 2020 2066 5f7a 6572 6f20           f_zero 
+000267d0: 3d20 7072 6963 655f 6461 7461 203d 3d20  = price_data == 
+000267e0: 302e 300a 2020 2020 2020 2020 656c 7365  0.0.        else
+000267f0: 3a0a 2020 2020 2020 2020 2020 2020 5f31  :.            _1
+00026800: 645f 6368 616e 6765 5f78 203d 206e 702e  d_change_x = np.
+00026810: 6675 6c6c 2828 6e2c 2034 292c 2031 2e30  full((n, 4), 1.0
+00026820: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+00026830: 6963 655f 6461 7461 203d 2064 6632 5b4f  ice_data = df2[O
+00026840: 484c 435d 2e74 6f5f 6e75 6d70 7928 290a  HLC].to_numpy().
+00026850: 2020 2020 2020 2020 2020 2020 665f 7a65              f_ze
+00026860: 726f 203d 2070 7269 6365 5f64 6174 6120  ro = price_data 
+00026870: 3d3d 2030 2e30 0a20 2020 2020 2020 2069  == 0.0.        i
+00026880: 6620 665f 7a65 726f 2e61 6e79 2829 3a0a  f f_zero.any():.
+00026890: 2020 2020 2020 2020 2020 2020 7072 6963              pric
+000268a0: 655f 6461 7461 5b66 5f7a 6572 6f5d 203d  e_data[f_zero] =
+000268b0: 2031 2e30 0a0a 2020 2020 2020 2020 2320   1.0..        # 
+000268c0: 5570 6461 7465 3a20 6966 2061 2056 4552  Update: if a VER
+000268d0: 5920 6c61 7267 6520 6469 7669 6465 6e64  Y large dividend
+000268e0: 2069 7320 7061 6964 206f 7574 2c20 7468   is paid out, th
+000268f0: 656e 2063 616e 2062 6520 6d69 7374 616b  en can be mistak
+00026900: 656e 2066 6f72 2061 2031 3a32 2073 746f  en for a 1:2 sto
+00026910: 636b 2073 706c 6974 2e0a 2020 2020 2020  ck split..      
+00026920: 2020 2320 4669 7820 3d20 7573 6520 6164    # Fix = use ad
+00026930: 6a75 7374 6564 2070 7269 6365 730a 2020  justed prices.  
+00026940: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+00026950: 616e 6765 2870 7269 6365 5f64 6174 612e  ange(price_data.
+00026960: 7368 6170 655b 315d 293a 0a20 2020 2020  shape[1]):.     
+00026970: 2020 2020 2020 2070 7269 6365 5f64 6174         price_dat
+00026980: 615b 3a2c 6a5d 202a 3d20 6466 325b 2743  a[:,j] *= df2['C
+00026990: 4446 275d 0a0a 2020 2020 2020 2020 5f31  DF']..        _1
+000269a0: 645f 6368 616e 6765 5f78 5b31 3a5d 203d  d_change_x[1:] =
+000269b0: 2070 7269 6365 5f64 6174 615b 313a 2c20   price_data[1:, 
+000269c0: 5d20 2f20 7072 6963 655f 6461 7461 5b3a  ] / price_data[:
+000269d0: 2d31 2c20 5d0a 2020 2020 2020 2020 665f  -1, ].        f_
+000269e0: 7a65 726f 5f6e 756d 5f64 656e 6f6d 203d  zero_num_denom =
+000269f0: 2066 5f7a 6572 6f20 7c20 6e70 2e72 6f6c   f_zero | np.rol
+00026a00: 6c28 665f 7a65 726f 2c20 312c 2061 7869  l(f_zero, 1, axi
+00026a10: 733d 3029 0a20 2020 2020 2020 2069 6620  s=0).        if 
+00026a20: 665f 7a65 726f 5f6e 756d 5f64 656e 6f6d  f_zero_num_denom
+00026a30: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00026a40: 2020 2020 5f31 645f 6368 616e 6765 5f78      _1d_change_x
+00026a50: 5b66 5f7a 6572 6f5f 6e75 6d5f 6465 6e6f  [f_zero_num_deno
+00026a60: 6d5d 203d 2031 2e30 0a20 2020 2020 2020  m] = 1.0.       
+00026a70: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+00026a80: 7920 616e 6420 7365 6c66 2e69 6e74 6572  y and self.inter
+00026a90: 7661 6c20 213d 2079 6663 642e 496e 7465  val != yfcd.Inte
+00026aa0: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
+00026ab0: 2020 2020 2020 2020 2320 6176 6572 6167          # averag
+00026ac0: 6520 6368 616e 6765 0a20 2020 2020 2020  e change.       
+00026ad0: 2020 2020 205f 3164 5f63 6861 6e67 655f       _1d_change_
+00026ae0: 6d69 6e78 203d 206e 702e 6176 6572 6167  minx = np.averag
+00026af0: 6528 5f31 645f 6368 616e 6765 5f78 2c20  e(_1d_change_x, 
+00026b00: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
+00026b10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00026b20: 2020 2320 2320 6368 616e 6765 206e 6561    # # change nea
+00026b30: 7265 7374 2074 6f20 312e 300a 2020 2020  rest to 1.0.    
+00026b40: 2020 2020 2020 2020 2320 6469 6666 203d          # diff =
+00026b50: 206e 702e 6162 7328 5f31 645f 6368 616e   np.abs(_1d_chan
+00026b60: 6765 5f78 202d 2031 2e30 290a 2020 2020  ge_x - 1.0).    
+00026b70: 2020 2020 2020 2020 2320 6a5f 696e 6469          # j_indi
+00026b80: 6365 7320 3d20 6e70 2e61 7267 6d69 6e28  ces = np.argmin(
+00026b90: 6469 6666 2c20 6178 6973 3d31 290a 2020  diff, axis=1).  
+00026ba0: 2020 2020 2020 2020 2020 2320 5f31 645f            # _1d_
+00026bb0: 6368 616e 6765 5f6d 696e 7820 3d20 5f31  change_minx = _1
+00026bc0: 645f 6368 616e 6765 5f78 5b6e 702e 6172  d_change_x[np.ar
+00026bd0: 616e 6765 286e 292c 206a 5f69 6e64 6963  ange(n), j_indic
+00026be0: 6573 5d0a 2020 2020 2020 2020 2020 2020  es].            
+00026bf0: 2320 5374 696c 6c20 6469 7374 6f72 7465  # Still distorte
+00026c00: 6420 6279 2065 7874 7265 6d65 2d6c 6f77  d by extreme-low
+00026c10: 2068 6967 682f 6c6f 772e 2053 6f20 7472   high/low. So tr
+00026c20: 7920 6d65 6469 616e 3a0a 2020 2020 2020  y median:.      
+00026c30: 2020 2020 2020 5f31 645f 6368 616e 6765        _1d_change
+00026c40: 5f6d 696e 7820 3d20 6e70 2e6d 6564 6961  _minx = np.media
+00026c50: 6e28 5f31 645f 6368 616e 6765 5f78 2c20  n(_1d_change_x, 
+00026c60: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
+00026c70: 665f 6e61 203d 206e 702e 6973 6e61 6e28  f_na = np.isnan(
+00026c80: 5f31 645f 6368 616e 6765 5f6d 696e 7829  _1d_change_minx)
+00026c90: 0a20 2020 2020 2020 2069 6620 665f 6e61  .        if f_na
+00026ca0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00026cb0: 2020 2020 2320 506f 7373 6962 6c65 2069      # Possible i
+00026cc0: 6620 6461 7461 2077 6173 2074 6f6f 206f  f data was too o
+00026cd0: 6c64 2066 6f72 2072 6563 6f6e 7374 7275  ld for reconstru
+00026ce0: 6374 696f 6e2e 0a20 2020 2020 2020 2020  ction..         
+00026cf0: 2020 205f 3164 5f63 6861 6e67 655f 6d69     _1d_change_mi
+00026d00: 6e78 5b66 5f6e 615d 203d 2031 2e30 0a20  nx[f_na] = 1.0. 
+00026d10: 2020 2020 2020 2064 665f 6465 6275 675b         df_debug[
+00026d20: 2731 4420 6368 616e 6765 2058 275d 203d  '1D change X'] =
+00026d30: 205f 3164 5f63 6861 6e67 655f 6d69 6e78   _1d_change_minx
+00026d40: 0a20 2020 2020 2020 2064 665f 6465 6275  .        df_debu
+00026d50: 675b 2731 4420 6368 616e 6765 2058 275d  g['1D change X']
+00026d60: 203d 2064 665f 6465 6275 675b 2731 4420   = df_debug['1D 
+00026d70: 6368 616e 6765 2058 275d 2e72 6f75 6e64  change X'].round
+00026d80: 2832 292e 6173 7479 7065 2827 7374 7227  (2).astype('str'
+00026d90: 290a 0a20 2020 2020 2020 2023 2049 6620  )..        # If 
+00026da0: 616c 6c20 3144 2063 6861 6e67 6573 2061  all 1D changes a
+00026db0: 7265 2063 6c6f 7365 7220 746f 2031 2e30  re closer to 1.0
+00026dc0: 2074 6861 6e20 7370 6c69 742c 2065 7869   than split, exi
+00026dd0: 740a 2020 2020 2020 2020 7370 6c69 745f  t.        split_
+00026de0: 6d61 7820 3d20 6d61 7828 7370 6c69 742c  max = max(split,
+00026df0: 2073 706c 6974 5f72 6370 290a 2020 2020   split_rcp).    
+00026e00: 2020 2020 6966 206e 702e 6d61 7828 5f31      if np.max(_1
+00026e10: 645f 6368 616e 6765 5f6d 696e 7829 203c  d_change_minx) <
+00026e20: 2028 7370 6c69 745f 6d61 7820 2d20 3129   (split_max - 1)
+00026e30: 202a 2030 2e35 202b 2031 2061 6e64 206e   * 0.5 + 1 and n
+00026e40: 702e 6d69 6e28 5f31 645f 6368 616e 6765  p.min(_1d_change
+00026e50: 5f6d 696e 7829 203e 2031 2e30 202f 2028  _minx) > 1.0 / (
+00026e60: 2873 706c 6974 5f6d 6178 202d 2031 2920  (split_max - 1) 
+00026e70: 2a20 302e 3520 2b20 3129 3a0a 2020 2020  * 0.5 + 1):.    
+00026e80: 2020 2020 2020 2020 7265 6173 6f6e 203d          reason =
+00026e90: 2022 6368 616e 6765 7320 746f 6f20 6e65   "changes too ne
+00026ea0: 6172 2031 2e30 220a 2020 2020 2020 2020  ar 1.0".        
+00026eb0: 2020 2020 7265 6173 6f6e 202b 3d20 6622      reason += f"
+00026ec0: 2028 5f31 645f 6368 616e 6765 5f6d 696e   (_1d_change_min
+00026ed0: 7820 3d20 7b6e 702e 6d69 6e28 5f31 645f  x = {np.min(_1d_
+00026ee0: 6368 616e 6765 5f6d 696e 7829 3a2e 3266  change_minx):.2f
+00026ef0: 7d20 2d3e 207b 6e70 2e6d 6178 285f 3164  } -> {np.max(_1d
+00026f00: 5f63 6861 6e67 655f 6d69 6e78 293a 2e32  _change_minx):.2
+00026f10: 667d 2922 0a20 2020 2020 2020 2020 2020  f})".           
+00026f20: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+00026f30: 2872 6561 736f 6e29 0a20 2020 2020 2020  (reason).       
+00026f40: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+00026f50: 7869 7428 6c6f 675f 6675 6e63 202b 2022  xit(log_func + "
+00026f60: 2061 626f 7274 696e 6722 290a 2020 2020   aborting").    
+00026f70: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00026f80: 660a 0a20 2020 2020 2020 2023 2043 616c  f..        # Cal
+00026f90: 6375 6c61 7465 2074 6865 2074 7275 6520  culate the true 
+00026fa0: 7072 6963 6520 7661 7269 616e 6365 2c20  price variance, 
+00026fb0: 692e 652e 2072 656d 6f76 6520 6566 6665  i.e. remove effe
+00026fc0: 6374 206f 6620 6261 6420 7370 6c69 742d  ct of bad split-
+00026fd0: 6164 6a75 7374 6d65 6e74 732e 0a20 2020  adjustments..   
+00026fe0: 2020 2020 2023 204b 6579 203d 2069 676e       # Key = ign
+00026ff0: 6f72 6520 3144 2063 6861 6e67 6573 206f  ore 1D changes o
+00027000: 7574 7369 6465 206f 6620 696e 7465 7271  utside of interq
+00027010: 7561 7274 696c 6520 7261 6e67 650a 2020  uartile range.  
+00027020: 2020 2020 2020 7131 2c20 7133 203d 206e        q1, q3 = n
+00027030: 702e 7065 7263 656e 7469 6c65 285f 3164  p.percentile(_1d
+00027040: 5f63 6861 6e67 655f 6d69 6e78 2c20 5b32  _change_minx, [2
+00027050: 352c 2037 355d 290a 2020 2020 2020 2020  5, 75]).        
+00027060: 6971 7220 3d20 7133 202d 2071 310a 2020  iqr = q3 - q1.  
+00027070: 2020 2020 2020 6c6f 7765 725f 626f 756e        lower_boun
+00027080: 6420 3d20 7131 202d 2031 2e35 202a 2069  d = q1 - 1.5 * i
+00027090: 7172 0a20 2020 2020 2020 2075 7070 6572  qr.        upper
+000270a0: 5f62 6f75 6e64 203d 2071 3320 2b20 312e  _bound = q3 + 1.
+000270b0: 3520 2a20 6971 720a 2020 2020 2020 2020  5 * iqr.        
+000270c0: 6620 3d20 285f 3164 5f63 6861 6e67 655f  f = (_1d_change_
+000270d0: 6d69 6e78 203e 3d20 6c6f 7765 725f 626f  minx >= lower_bo
+000270e0: 756e 6429 2026 2028 5f31 645f 6368 616e  und) & (_1d_chan
+000270f0: 6765 5f6d 696e 7820 3c3d 2075 7070 6572  ge_minx <= upper
+00027100: 5f62 6f75 6e64 290a 2020 2020 2020 2020  _bound).        
+00027110: 6176 6720 3d20 6e70 2e6d 6561 6e28 5f31  avg = np.mean(_1
+00027120: 645f 6368 616e 6765 5f6d 696e 785b 665d  d_change_minx[f]
+00027130: 290a 2020 2020 2020 2020 7364 203d 206e  ).        sd = n
+00027140: 702e 7374 6428 5f31 645f 6368 616e 6765  p.std(_1d_change
+00027150: 5f6d 696e 785b 665d 290a 2020 2020 2020  _minx[f]).      
+00027160: 2020 2320 4e6f 7720 6361 6e20 6361 6c63    # Now can calc
+00027170: 756c 6174 6520 5344 2061 7320 2520 6f66  ulate SD as % of
+00027180: 206d 6561 6e0a 2020 2020 2020 2020 7364   mean.        sd
+00027190: 5f70 6374 203d 2073 6420 2f20 6176 670a  _pct = sd / avg.
+000271a0: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
+000271b0: 4573 7469 6d61 7469 6f6e 206f 6620 7472  Estimation of tr
+000271c0: 7565 2031 4420 6368 616e 6765 2073 7461  ue 1D change sta
+000271d0: 7473 3a20 6d65 616e 203d 207b 6176 673a  ts: mean = {avg:
+000271e0: 2e32 667d 2c20 5374 6444 6576 203d 207b  .2f}, StdDev = {
+000271f0: 7364 3a2e 3466 7d20 287b 7364 5f70 6374  sd:.4f} ({sd_pct
+00027200: 2a31 3030 2e30 3a2e 3166 7d25 206f 6620  *100.0:.1f}% of 
+00027210: 6d65 616e 2922 0a20 2020 2020 2020 2073  mean)".        s
+00027220: 656c 662e 6d61 6e61 6765 722e 4c6f 6745  elf.manager.LogE
+00027230: 7665 6e74 2827 6465 6275 6727 2c20 2770  vent('debug', 'p
+00027240: 7269 6365 2d72 6570 6169 722d 7370 6c69  rice-repair-spli
+00027250: 742d 272b 7365 6c66 2e69 7374 722c 206d  t-'+self.istr, m
+00027260: 7367 290a 0a20 2020 2020 2020 2023 204f  sg)..        # O
+00027270: 6e6c 7920 7072 6f63 6565 6420 6966 2073  nly proceed if s
+00027280: 706c 6974 2061 646a 7573 746d 656e 7420  plit adjustment 
+00027290: 6661 7220 6578 6365 6564 7320 6e6f 726d  far exceeds norm
+000272a0: 616c 2031 4420 6368 616e 6765 730a 2020  al 1D changes.  
+000272b0: 2020 2020 2020 6c61 7267 6573 745f 6368        largest_ch
+000272c0: 616e 6765 5f70 6374 203d 2035 202a 2073  ange_pct = 5 * s
+000272d0: 645f 7063 740a 2020 2020 2020 2020 6966  d_pct.        if
+000272e0: 2073 656c 662e 696e 7465 7264 6179 2061   self.interday a
+000272f0: 6e64 2073 656c 662e 696e 7465 7276 616c  nd self.interval
+00027300: 2021 3d20 7966 6364 2e49 6e74 6572 7661   != yfcd.Interva
+00027310: 6c2e 4461 7973 313a 0a20 2020 2020 2020  l.Days1:.       
+00027320: 2020 2020 206c 6172 6765 7374 5f63 6861       largest_cha
+00027330: 6e67 655f 7063 7420 2a3d 2033 0a20 2020  nge_pct *= 3.   
+00027340: 2020 2020 2020 2020 2023 2069 6620 7365           # if se
+00027350: 6c66 2e69 6e74 6572 7661 6c20 696e 205b  lf.interval in [
+00027360: 7966 6364 2e49 6e74 6572 7661 6c2e 4d6f  yfcd.Interval.Mo
+00027370: 6e74 6873 312c 2079 6663 642e 496e 7465  nths1, yfcd.Inte
+00027380: 7276 616c 2e4d 6f6e 7468 7333 5d3a 0a20  rval.Months3]:. 
+00027390: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+000273a0: 206c 6172 6765 7374 5f63 6861 6e67 655f   largest_change_
+000273b0: 7063 7420 2a3d 2032 0a20 2020 2020 2020  pct *= 2.       
+000273c0: 2069 6620 6d61 7828 7370 6c69 742c 2073   if max(split, s
+000273d0: 706c 6974 5f72 6370 2920 3c20 312e 3020  plit_rcp) < 1.0 
+000273e0: 2b20 6c61 7267 6573 745f 6368 616e 6765  + largest_change
+000273f0: 5f70 6374 3a0a 2020 2020 2020 2020 2020  _pct:.          
+00027400: 2020 6d73 6720 3d20 2253 706c 6974 2072    msg = "Split r
+00027410: 6174 696f 2074 6f6f 2063 6c6f 7365 2074  atio too close t
+00027420: 6f20 6e6f 726d 616c 2070 7269 6365 2076  o normal price v
+00027430: 6f6c 6174 696c 6974 792e 2057 6f6e 2774  olatility. Won't
+00027440: 2072 6570 6169 7222 0a20 2020 2020 2020   repair".       
+00027450: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
+00027460: 722e 4c6f 6745 7665 6e74 2827 6465 6275  r.LogEvent('debu
+00027470: 6727 2c20 2770 7269 6365 2d72 6570 6169  g', 'price-repai
+00027480: 722d 7370 6c69 742d 272b 7365 6c66 2e69  r-split-'+self.i
+00027490: 7374 722c 206d 7367 290a 2020 2020 2020  str, msg).      
+000274a0: 2020 2020 2020 2320 6d73 6720 3d20 6622        # msg = f"
+000274b0: 7072 6963 652d 7265 7061 6972 2d73 706c  price-repair-spl
+000274c0: 6974 3a20 6d79 2077 6f72 6b69 6e67 733a  it: my workings:
+000274d0: 2220 2b20 275c 6e27 202b 2073 7472 2864  " + '\n' + str(d
+000274e0: 665f 6465 6275 6729 0a20 2020 2020 2020  f_debug).       
+000274f0: 2020 2020 2023 2073 656c 662e 6d61 6e61       # self.mana
+00027500: 6765 722e 4c6f 6745 7665 6e74 2827 6465  ger.LogEvent('de
+00027510: 6275 6727 2c20 2770 7269 6365 2d72 6570  bug', 'price-rep
+00027520: 6169 722d 7370 6c69 742d 272b 7365 6c66  air-split-'+self
+00027530: 2e69 7374 722c 206d 7367 290a 2020 2020  .istr, msg).    
+00027540: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00027550: 6365 4578 6974 286c 6f67 5f66 756e 6320  ceExit(log_func 
+00027560: 2b20 223a 2061 626f 7274 696e 672c 2063  + ": aborting, c
+00027570: 6861 6e67 6573 2074 6f20 6e65 6172 206e  hanges to near n
+00027580: 6f72 6d61 6c20 7072 6963 6520 766f 6c61  ormal price vola
+00027590: 7469 6c69 7479 2229 0a20 2020 2020 2020  tility").       
+000275a0: 2020 2020 2072 6574 7572 6e20 6466 0a0a       return df..
+000275b0: 2020 2020 2020 2020 2320 4e6f 7720 6361          # Now ca
+000275c0: 6e20 6465 7465 6374 2062 6164 2073 706c  n detect bad spl
+000275d0: 6974 2061 646a 7573 746d 656e 7473 0a20  it adjustments. 
+000275e0: 2020 2020 2020 2023 2053 6574 2074 6872         # Set thr
+000275f0: 6573 686f 6c64 2074 6f20 6861 6c66 7761  eshold to halfwa
+00027600: 7920 6265 7477 6565 6e20 7370 6c69 7420  y between split 
+00027610: 7261 7469 6f20 616e 6420 6c61 7267 6573  ratio and larges
+00027620: 7420 6578 7065 6374 6564 206e 6f72 6d61  t expected norma
+00027630: 6c20 7072 6963 6520 6368 616e 6765 0a20  l price change. 
+00027640: 2020 2020 2020 2072 203d 205f 3164 5f63         r = _1d_c
+00027650: 6861 6e67 655f 6d69 6e78 202f 2073 706c  hange_minx / spl
+00027660: 6974 5f72 6370 0a20 2020 2020 2020 2073  it_rcp.        s
+00027670: 706c 6974 5f6d 6178 203d 206d 6178 2873  plit_max = max(s
+00027680: 706c 6974 2c20 7370 6c69 745f 7263 7029  plit, split_rcp)
+00027690: 0a20 2020 2020 2020 2074 6872 6573 686f  .        thresho
+000276a0: 6c64 203d 2028 7370 6c69 745f 6d61 7820  ld = (split_max 
+000276b0: 2b20 312e 3020 2b20 6c61 7267 6573 745f  + 1.0 + largest_
+000276c0: 6368 616e 6765 5f70 6374 2920 2a20 302e  change_pct) * 0.
+000276d0: 350a 2020 2020 2020 2020 6d73 6720 3d20  5.        msg = 
+000276e0: 6622 7370 6c69 745f 6d61 783d 7b73 706c  f"split_max={spl
+000276f0: 6974 5f6d 6178 3a2e 3366 7d20 6c61 7267  it_max:.3f} larg
+00027700: 6573 745f 6368 616e 6765 5f70 6374 3d7b  est_change_pct={
+00027710: 6c61 7267 6573 745f 6368 616e 6765 5f70  largest_change_p
+00027720: 6374 3a2e 3466 7d20 7468 7265 7368 6f6c  ct:.4f} threshol
+00027730: 643d 7b74 6872 6573 686f 6c64 3a2e 3366  d={threshold:.3f
+00027740: 7d22 0a20 2020 2020 2020 2073 656c 662e  }".        self.
+00027750: 6d61 6e61 6765 722e 4c6f 6745 7665 6e74  manager.LogEvent
+00027760: 2827 6465 6275 6727 2c20 2770 7269 6365  ('debug', 'price
+00027770: 2d72 6570 6169 722d 7370 6c69 742d 272b  -repair-split-'+
+00027780: 7365 6c66 2e69 7374 722c 206d 7367 290a  self.istr, msg).
+00027790: 0a20 2020 2020 2020 2069 6620 2752 6570  .        if 'Rep
+000277a0: 6169 7265 643f 2720 6e6f 7420 696e 2064  aired?' not in d
+000277b0: 6632 2e63 6f6c 756d 6e73 3a0a 2020 2020  f2.columns:.    
+000277c0: 2020 2020 2020 2020 6466 325b 2752 6570          df2['Rep
+000277d0: 6169 7265 643f 275d 203d 2046 616c 7365  aired?'] = False
+000277e0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000277f0: 662e 696e 7465 7264 6179 2061 6e64 2073  f.interday and s
+00027800: 656c 662e 696e 7465 7276 616c 2021 3d20  elf.interval != 
+00027810: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
+00027820: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
+00027830: 2023 2059 6168 6f6f 2063 7265 6174 6573   # Yahoo creates
+00027840: 206d 756c 7469 2d64 6179 2069 6e74 6572   multi-day inter
+00027850: 7661 6c73 2075 7369 6e67 2070 6f74 656e  vals using poten
+00027860: 7469 616c 6c20 636f 7272 7570 7420 6461  tiall corrupt da
+00027870: 7461 2c20 652e 672e 0a20 2020 2020 2020  ta, e.g..       
+00027880: 2020 2020 2023 2074 6865 2043 6c6f 7365       # the Close
+00027890: 2063 6f75 6c64 2062 6520 3130 3078 204f   could be 100x O
+000278a0: 7065 6e2e 2054 6869 7320 6d65 616e 7320  pen. This means 
+000278b0: 6861 7665 2074 6f20 636f 7272 6563 7420  have to correct 
+000278c0: 6561 6368 204f 484c 4320 636f 6c75 6d6e  each OHLC column
+000278d0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+000278e0: 6e64 6976 6964 7561 6c6c 790a 2020 2020  ndividually.    
+000278f0: 2020 2020 2020 2020 636f 7272 6563 745f          correct_
+00027900: 636f 6c75 6d6e 735f 696e 6469 7669 6475  columns_individu
+00027910: 616c 6c79 203d 2054 7275 650a 2020 2020  ally = True.    
+00027920: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00027930: 2020 2020 2020 636f 7272 6563 745f 636f        correct_co
+00027940: 6c75 6d6e 735f 696e 6469 7669 6475 616c  lumns_individual
+00027950: 6c79 203d 2046 616c 7365 0a0a 2020 2020  ly = False..    
+00027960: 2020 2020 6966 2063 6f72 7265 6374 5f63      if correct_c
+00027970: 6f6c 756d 6e73 5f69 6e64 6976 6964 7561  olumns_individua
+00027980: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+00027990: 205f 3164 5f63 6861 6e67 655f 7820 3d20   _1d_change_x = 
+000279a0: 6e70 2e66 756c 6c28 286e 2c20 3429 2c20  np.full((n, 4), 
+000279b0: 312e 3029 0a20 2020 2020 2020 2020 2020  1.0).           
+000279c0: 2070 7269 6365 5f64 6174 6120 3d20 6466   price_data = df
+000279d0: 325b 4f48 4c43 5d2e 7265 706c 6163 6528  2[OHLC].replace(
+000279e0: 302e 302c 2031 2e30 292e 746f 5f6e 756d  0.0, 1.0).to_num
+000279f0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+00027a00: 205f 3164 5f63 6861 6e67 655f 785b 313a   _1d_change_x[1:
+00027a10: 5d20 3d20 7072 6963 655f 6461 7461 5b31  ] = price_data[1
+00027a20: 3a2c 205d 202f 2070 7269 6365 5f64 6174  :, ] / price_dat
+00027a30: 615b 3a2d 312c 205d 0a20 2020 2020 2020  a[:-1, ].       
+00027a40: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00027a50: 2020 205f 3164 5f63 6861 6e67 655f 7820     _1d_change_x 
+00027a60: 3d20 5f31 645f 6368 616e 6765 5f6d 696e  = _1d_change_min
+00027a70: 780a 0a20 2020 2020 2020 2072 203d 205f  x..        r = _
+00027a80: 3164 5f63 6861 6e67 655f 7820 2f20 7370  1d_change_x / sp
+00027a90: 6c69 745f 7263 700a 2020 2020 2020 2020  lit_rcp.        
+00027aa0: 665f 646f 776e 203d 205f 3164 5f63 6861  f_down = _1d_cha
+00027ab0: 6e67 655f 7820 3c20 312e 3020 2f20 7468  nge_x < 1.0 / th
+00027ac0: 7265 7368 6f6c 640a 2020 2020 2020 2020  reshold.        
+00027ad0: 665f 7570 203d 205f 3164 5f63 6861 6e67  f_up = _1d_chang
+00027ae0: 655f 7820 3e20 7468 7265 7368 6f6c 640a  e_x > threshold.
+00027af0: 2020 2020 2020 2020 6620 3d20 665f 646f          f = f_do
+00027b00: 776e 207c 2066 5f75 700a 2020 2020 2020  wn | f_up.      
+00027b10: 2020 6966 206e 6f74 2063 6f72 7265 6374    if not correct
+00027b20: 5f63 6f6c 756d 6e73 5f69 6e64 6976 6964  _columns_individ
+00027b30: 7561 6c6c 793a 0a20 2020 2020 2020 2020  ually:.         
+00027b40: 2020 2064 665f 6465 6275 675b 2772 275d     df_debug['r']
+00027b50: 203d 2072 0a20 2020 2020 2020 2020 2020   = r.           
+00027b60: 2064 665f 6465 6275 675b 2766 5f64 6f77   df_debug['f_dow
+00027b70: 6e27 5d20 3d20 665f 646f 776e 0a20 2020  n'] = f_down.   
+00027b80: 2020 2020 2020 2020 2064 665f 6465 6275           df_debu
+00027b90: 675b 2766 5f75 7027 5d20 3d20 665f 7570  g['f_up'] = f_up
+00027ba0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+00027bb0: 6465 6275 675b 2772 275d 203d 2064 665f  debug['r'] = df_
+00027bc0: 6465 6275 675b 2772 275d 2e72 6f75 6e64  debug['r'].round
+00027bd0: 2832 292e 6173 7479 7065 2827 7374 7227  (2).astype('str'
+00027be0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00027bf0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00027c00: 6a20 696e 2072 616e 6765 286c 656e 284f  j in range(len(O
+00027c10: 484c 4329 293a 0a20 2020 2020 2020 2020  HLC)):.         
+00027c20: 2020 2020 2020 2063 203d 204f 484c 435b         c = OHLC[
+00027c30: 6a5d 0a20 2020 2020 2020 2020 2020 2020  j].             
+00027c40: 2020 2069 6620 6320 696e 2064 6562 7567     if c in debug
+00027c50: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
+00027c60: 2020 2020 2020 2020 2020 2064 665f 6465             df_de
+00027c70: 6275 675b 6320 2b20 275f 7227 5d20 3d20  bug[c + '_r'] = 
+00027c80: 725b 3a2c 206a 5d0a 2020 2020 2020 2020  r[:, j].        
+00027c90: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
+00027ca0: 6562 7567 5b63 202b 2027 5f66 5f64 6f77  ebug[c + '_f_dow
+00027cb0: 6e27 5d20 3d20 665f 646f 776e 5b3a 2c20  n'] = f_down[:, 
+00027cc0: 6a5d 0a20 2020 2020 2020 2020 2020 2020  j].             
+00027cd0: 2020 2020 2020 2064 665f 6465 6275 675b         df_debug[
+00027ce0: 6320 2b20 275f 665f 7570 275d 203d 2066  c + '_f_up'] = f
+00027cf0: 5f75 705b 3a2c 206a 5d0a 2020 2020 2020  _up[:, j].      
+00027d00: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00027d10: 5f64 6562 7567 5b63 202b 2027 5f72 275d  _debug[c + '_r']
+00027d20: 203d 2064 665f 6465 6275 675b 6320 2b20   = df_debug[c + 
+00027d30: 275f 7227 5d2e 726f 756e 6428 3229 2e61  '_r'].round(2).a
+00027d40: 7374 7970 6528 2773 7472 2729 0a0a 2020  stype('str')..  
+00027d50: 2020 2020 2020 6966 206e 6f74 2066 2e61        if not f.a
+00027d60: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+00027d70: 2020 7966 636c 2e54 7261 6365 4578 6974    yfcl.TraceExit
+00027d80: 286c 6f67 5f66 756e 6320 2b20 223a 2061  (log_func + ": a
+00027d90: 626f 7274 696e 672c 2064 6964 206e 6f74  borting, did not
+00027da0: 2064 6574 6563 7420 7370 6c69 7420 6572   detect split er
+00027db0: 726f 7273 2229 0a20 2020 2020 2020 2020  rors").         
+00027dc0: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
+00027dd0: 2020 2020 2020 2320 4966 2073 746f 636b        # If stock
+00027de0: 2069 7320 6375 7272 656e 746c 7920 7375   is currently su
+00027df0: 7370 656e 6465 6420 616e 6420 6e6f 7420  spended and not 
+00027e00: 696e 2055 5341 2c20 7468 656e 2075 7375  in USA, then usu
+00027e10: 616c 6c79 2059 6168 6f6f 2069 6e74 726f  ally Yahoo intro
+00027e20: 6475 6365 730a 2020 2020 2020 2020 2320  duces.        # 
+00027e30: 3130 3078 2065 7272 6f72 7320 696e 746f  100x errors into
+00027e40: 2073 7573 7065 6e64 6564 2069 6e74 6572   suspended inter
+00027e50: 7661 6c73 2e20 436c 7565 2069 7320 6e6f  vals. Clue is no
+00027e60: 2070 7269 6365 2063 6861 6e67 6520 616e   price change an
+00027e70: 6420 3020 766f 6c75 6d65 2e0a 2020 2020  d 0 volume..    
+00027e80: 2020 2020 2320 4265 7474 6572 2074 6f20      # Better to 
+00027e90: 7573 6520 6c61 7374 2061 6374 6976 6520  use last active 
+00027ea0: 7472 6164 696e 6720 696e 7465 7276 616c  trading interval
+00027eb0: 2061 7320 6261 7365 6c69 6e65 2e0a 2020   as baseline..  
+00027ec0: 2020 2020 2020 665f 6e6f 5f61 6374 6976        f_no_activ
+00027ed0: 6974 7920 3d20 2864 6632 5b27 4c6f 7727  ity = (df2['Low'
+00027ee0: 5d20 3d3d 2064 6632 5b27 4869 6768 275d  ] == df2['High']
+00027ef0: 2920 2620 2864 6632 5b27 566f 6c75 6d65  ) & (df2['Volume
+00027f00: 275d 3d3d 3029 0a20 2020 2020 2020 2066  ']==0).        f
+00027f10: 5f6e 6f5f 6163 7469 7669 7479 203d 2066  _no_activity = f
+00027f20: 5f6e 6f5f 6163 7469 7669 7479 207c 2064  _no_activity | d
+00027f30: 6632 5b4f 484c 435d 2e69 736e 6128 292e  f2[OHLC].isna().
+00027f40: 616c 6c28 6178 6973 3d31 290a 2020 2020  all(axis=1).    
+00027f50: 2020 2020 6170 7065 6172 735f 7375 7370      appears_susp
+00027f60: 656e 6465 6420 3d20 665f 6e6f 5f61 6374  ended = f_no_act
+00027f70: 6976 6974 792e 616e 7928 2920 616e 6420  ivity.any() and 
+00027f80: 6e70 2e77 6865 7265 2866 5f6e 6f5f 6163  np.where(f_no_ac
+00027f90: 7469 7669 7479 295b 305d 5b30 5d3d 3d30  tivity)[0][0]==0
+00027fa0: 0a20 2020 2020 2020 2066 5f61 6374 6976  .        f_activ
+00027fb0: 6520 3d20 7e66 5f6e 6f5f 6163 7469 7669  e = ~f_no_activi
+00027fc0: 7479 0a20 2020 2020 2020 2023 2046 6972  ty.        # Fir
+00027fd0: 7374 2c20 6964 6561 6c6c 792c 206c 6f6f  st, ideally, loo
+00027fe0: 6b20 666f 7220 3220 636f 6e73 6563 7574  k for 2 consecut
+00027ff0: 6976 6520 696e 7465 7276 616c 7320 6f66  ive intervals of
+00028000: 2061 6374 6976 6974 7920 7468 6174 2061   activity that a
+00028010: 7265 206e 6f74 0a20 2020 2020 2020 2023  re not.        #
+00028020: 2061 6666 6563 7465 6420 6279 2063 6861   affected by cha
+00028030: 6e67 6520 6572 726f 7273 0a20 2020 2020  nge errors.     
+00028040: 2020 2069 6620 662e 6e64 696d 203d 3d20     if f.ndim == 
+00028050: 313a 0a20 2020 2020 2020 2020 2020 2066  1:.            f
+00028060: 5f61 6374 6976 6520 3d20 665f 6163 7469  _active = f_acti
+00028070: 7665 2026 2028 7e66 290a 2020 2020 2020  ve & (~f).      
+00028080: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00028090: 2020 2020 665f 6163 7469 7665 203d 2066      f_active = f
+000280a0: 5f61 6374 6976 6520 2620 287e 662e 616e  _active & (~f.an
+000280b0: 7928 6178 6973 3d31 2929 0a20 2020 2020  y(axis=1)).     
+000280c0: 2020 2066 5f61 6374 6976 6520 3d20 665f     f_active = f_
+000280d0: 6163 7469 7665 2026 206e 702e 726f 6c6c  active & np.roll
+000280e0: 2866 5f61 6374 6976 652c 2031 290a 2020  (f_active, 1).  
+000280f0: 2020 2020 2020 6966 206e 6f74 2066 5f61        if not f_a
+00028100: 6374 6976 652e 616e 7928 293a 0a20 2020  ctive.any():.   
+00028110: 2020 2020 2020 2020 2023 2046 6972 7374           # First
+00028120: 2070 6c61 6e20 6661 696c 6564 2c20 7769   plan failed, wi
+00028130: 6c6c 2068 6176 6520 746f 2073 6574 746c  ll have to settl
+00028140: 6520 666f 7220 6d6f 7374 2072 6563 656e  e for most recen
+00028150: 7420 6163 7469 7665 2069 6e74 6572 7661  t active interva
+00028160: 6c0a 2020 2020 2020 2020 2020 2020 665f  l.            f_
+00028170: 6163 7469 7665 203d 207e 665f 6e6f 5f61  active = ~f_no_a
+00028180: 6374 6976 6974 790a 2020 2020 2020 2020  ctivity.        
+00028190: 2020 2020 665f 6163 7469 7665 203d 2066      f_active = f
+000281a0: 5f61 6374 6976 6520 2620 6e70 2e72 6f6c  _active & np.rol
+000281b0: 6c28 665f 6163 7469 7665 2c20 3129 0a20  l(f_active, 1). 
+000281c0: 2020 2020 2020 2069 6478 5f6c 6174 6573         idx_lates
+000281d0: 745f 6163 7469 7665 203d 206e 702e 7768  t_active = np.wh
+000281e0: 6572 6528 665f 6163 7469 7665 295b 305d  ere(f_active)[0]
+000281f0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00028200: 6964 785f 6c61 7465 7374 5f61 6374 6976  idx_latest_activ
+00028210: 6529 203d 3d20 303a 0a20 2020 2020 2020  e) == 0:.       
+00028220: 2020 2020 2069 6478 5f6c 6174 6573 745f       idx_latest_
+00028230: 6163 7469 7665 203d 204e 6f6e 650a 2020  active = None.  
+00028240: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00028250: 2020 2020 2020 2020 6964 785f 6c61 7465          idx_late
+00028260: 7374 5f61 6374 6976 6520 3d20 696e 7428  st_active = int(
+00028270: 6964 785f 6c61 7465 7374 5f61 6374 6976  idx_latest_activ
+00028280: 655b 305d 290a 2020 2020 2020 2020 6d73  e[0]).        ms
+00028290: 6720 3d20 6627 6170 7065 6172 735f 7375  g = f'appears_su
+000282a0: 7370 656e 6465 643d 7b61 7070 6561 7273  spended={appears
+000282b0: 5f73 7573 7065 6e64 6564 7d20 6964 785f  _suspended} idx_
+000282c0: 6c61 7465 7374 5f61 6374 6976 653d 7b69  latest_active={i
+000282d0: 6478 5f6c 6174 6573 745f 6163 7469 7665  dx_latest_active
+000282e0: 7d27 0a20 2020 2020 2020 2069 6620 6964  }'.        if id
+000282f0: 785f 6c61 7465 7374 5f61 6374 6976 6520  x_latest_active 
+00028300: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00028310: 2020 2020 2020 2020 206d 7367 202b 3d20           msg += 
+00028320: 6627 2028 7b64 6632 2e69 6e64 6578 5b69  f' ({df2.index[i
+00028330: 6478 5f6c 6174 6573 745f 6163 7469 7665  dx_latest_active
+00028340: 5d2e 6461 7465 2829 7d29 270a 2020 2020  ].date()})'.    
+00028350: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
+00028360: 2e4c 6f67 4576 656e 7428 2764 6562 7567  .LogEvent('debug
+00028370: 272c 2027 7072 6963 652d 7265 7061 6972  ', 'price-repair
+00028380: 2d73 706c 6974 2d27 2b73 656c 662e 6973  -split-'+self.is
+00028390: 7472 2c20 6d73 6729 0a0a 2020 2020 2020  tr, msg)..      
+000283a0: 2020 2320 5570 6461 7465 3a20 6966 2061    # Update: if a
+000283b0: 6e79 2031 3030 7820 6368 616e 6765 7320  ny 100x changes 
+000283c0: 6172 6520 736f 6f6e 2061 6674 6572 2061  are soon after a
+000283d0: 2073 746f 636b 2073 706c 6974 2c20 736f   stock split, so
+000283e0: 2063 6f75 6c64 2062 6520 636f 6e66 7573   could be confus
+000283f0: 6564 2077 6974 6820 7370 6c69 7420 6572  ed with split er
+00028400: 726f 722c 2074 6865 6e20 6162 6f72 740a  ror, then abort.
+00028410: 2020 2020 2020 2020 7468 7265 7368 6f6c          threshol
+00028420: 645f 6461 7973 203d 2033 300a 2020 2020  d_days = 30.    
+00028430: 2020 2020 665f 7370 6c69 7473 203d 2064      f_splits = d
+00028440: 6632 5b27 5374 6f63 6b20 5370 6c69 7473  f2['Stock Splits
+00028450: 275d 2e74 6f5f 6e75 6d70 7928 2920 213d  '].to_numpy() !=
+00028460: 2030 2e30 0a20 2020 2020 2020 2069 6620   0.0.        if 
+00028470: 6368 616e 6765 2069 6e20 5b31 3030 2e30  change in [100.0
+00028480: 2c20 302e 3031 5d20 616e 6420 665f 7370  , 0.01] and f_sp
+00028490: 6c69 7473 2e61 6e79 2829 3a0a 2020 2020  lits.any():.    
+000284a0: 2020 2020 2020 2020 696e 6469 6365 735f          indices_
+000284b0: 4120 3d20 6e70 2e77 6865 7265 2866 5f73  A = np.where(f_s
+000284c0: 706c 6974 7329 5b30 5d0a 2020 2020 2020  plits)[0].      
+000284d0: 2020 2020 2020 696e 6469 6365 735f 4220        indices_B 
+000284e0: 3d20 6e70 2e77 6865 7265 2866 295b 305d  = np.where(f)[0]
+000284f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028500: 6e6f 7420 6c65 6e28 696e 6469 6365 735f  not len(indices_
+00028510: 4129 206f 7220 6e6f 7420 6c65 6e28 696e  A) or not len(in
+00028520: 6469 6365 735f 4229 3a0a 2020 2020 2020  dices_B):.      
+00028530: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00028540: 7261 6365 4578 6974 286c 6f67 5f66 756e  raceExit(log_fun
+00028550: 6329 0a20 2020 2020 2020 2020 2020 2020  c).             
+00028560: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+00028570: 2020 2020 2020 2020 2020 2067 6170 7320             gaps 
+00028580: 3d20 696e 6469 6365 735f 425b 3a2c 204e  = indices_B[:, N
+00028590: 6f6e 655d 202d 2069 6e64 6963 6573 5f41  one] - indices_A
+000285a0: 0a20 2020 2020 2020 2020 2020 2023 2042  .            # B
+000285b0: 6563 6175 7365 2064 6174 6120 6973 2073  ecause data is s
+000285c0: 6f72 7465 6420 696e 2044 4573 6365 6e64  orted in DEscend
+000285d0: 696e 6720 6f72 6465 722c 206e 6565 6420  ing order, need 
+000285e0: 746f 2066 6c69 7020 6761 7073 0a20 2020  to flip gaps.   
+000285f0: 2020 2020 2020 2020 2067 6170 7320 2a3d           gaps *=
+00028600: 202d 310a 2020 2020 2020 2020 2020 2020   -1.            
+00028610: 665f 706f 7320 3d20 6761 7073 203e 2030  f_pos = gaps > 0
+00028620: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028630: 665f 706f 732e 616e 7928 293a 0a20 2020  f_pos.any():.   
+00028640: 2020 2020 2020 2020 2020 2020 2067 6170               gap
+00028650: 5f6d 696e 203d 2067 6170 735b 665f 706f  _min = gaps[f_po
+00028660: 735d 2e6d 696e 2829 0a20 2020 2020 2020  s].min().       
+00028670: 2020 2020 2020 2020 2067 6170 5f74 6420           gap_td 
+00028680: 3d20 7365 6c66 2e69 7464 202a 2067 6170  = self.itd * gap
+00028690: 5f6d 696e 0a20 2020 2020 2020 2020 2020  _min.           
+000286a0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000286b0: 6365 2867 6170 5f74 642c 2064 6174 6575  ce(gap_td, dateu
+000286c0: 7469 6c2e 7265 6c61 7469 7665 6465 6c74  til.relativedelt
+000286d0: 612e 7265 6c61 7469 7665 6465 6c74 6129  a.relativedelta)
+000286e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000286f0: 2020 2020 2020 7468 7265 7368 6f6c 6420        threshold 
+00028700: 3d20 6461 7465 7574 696c 2e72 656c 6174  = dateutil.relat
+00028710: 6976 6564 656c 7461 2e72 656c 6174 6976  ivedelta.relativ
+00028720: 6564 656c 7461 2864 6179 733d 7468 7265  edelta(days=thre
+00028730: 7368 6f6c 645f 6461 7973 290a 2020 2020  shold_days).    
+00028740: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00028750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028760: 2020 2020 2020 7468 7265 7368 6f6c 6420        threshold 
+00028770: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
+00028780: 3d74 6872 6573 686f 6c64 5f64 6179 7329  =threshold_days)
+00028790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000287a0: 2069 6620 6761 705f 7464 203c 2074 6872   if gap_td < thr
+000287b0: 6573 686f 6c64 3a0a 2020 2020 2020 2020  eshold:.        
+000287c0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+000287d0: 3d20 2770 7269 6365 2d72 6570 6169 722d  = 'price-repair-
+000287e0: 7370 6c69 743a 2031 3030 7820 6368 616e  split: 100x chan
+000287f0: 6765 7320 6172 6520 746f 6f20 736f 6f6e  ges are too soon
+00028800: 2061 6674 6572 2073 746f 636b 2073 706c   after stock spl
+00028810: 6974 2065 7665 6e74 732c 2061 626f 7274  it events, abort
+00028820: 696e 6727 0a20 2020 2020 2020 2020 2020  ing'.           
+00028830: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00028840: 6e61 6765 722e 4c6f 6745 7665 6e74 2827  nager.LogEvent('
+00028850: 696e 666f 272c 2027 7072 6963 652d 7265  info', 'price-re
+00028860: 7061 6972 2d73 706c 6974 2d27 2b73 656c  pair-split-'+sel
+00028870: 662e 6973 7472 2c20 6d73 6729 0a20 2020  f.istr, msg).   
+00028880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028890: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
+000288a0: 6c6f 675f 6675 6e63 290a 2020 2020 2020  log_func).      
+000288b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000288c0: 7475 726e 2064 660a 0a20 2020 2020 2020  turn df..       
+000288d0: 2023 2069 6620 7365 6c66 2e69 6e74 6572   # if self.inter
+000288e0: 6461 793a 0a20 2020 2020 2020 2023 2020  day:.        #  
+000288f0: 2020 2064 665f 6465 6275 672e 696e 6465     df_debug.inde
+00028900: 7820 3d20 6466 5f64 6562 7567 2e69 6e64  x = df_debug.ind
+00028910: 6578 2e64 6174 650a 2020 2020 2020 2020  ex.date.        
+00028920: 2320 666f 7220 6320 696e 205b 2746 6574  # for c in ['Fet
+00028930: 6368 4461 7465 275d 3a0a 2020 2020 2020  chDate']:.      
+00028940: 2020 2320 2020 2020 6466 5f64 6562 7567    #     df_debug
+00028950: 5b63 5d20 3d20 6466 5f64 6562 7567 5b63  [c] = df_debug[c
+00028960: 5d2e 6474 2e73 7472 6674 696d 6528 2725  ].dt.strftime('%
+00028970: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+00028980: 257a 2729 0a20 2020 2020 2020 2023 2023  %z').        # #
+00028990: 2066 5f63 6861 6e67 655f 6861 7070 656e   f_change_happen
+000289a0: 6564 203d 2064 665f 6465 6275 675b 2766  ed = df_debug['f
+000289b0: 5f64 6f77 6e27 5d20 7c20 6466 5f64 6562  _down'] | df_deb
+000289c0: 7567 5b27 665f 7570 275d 0a20 2020 2020  ug['f_up'].     
+000289d0: 2020 2023 2066 5f63 6861 6e67 655f 6861     # f_change_ha
+000289e0: 7070 656e 6564 203d 2064 665f 6465 6275  ppened = df_debu
+000289f0: 675b 2748 6967 685f 665f 646f 776e 275d  g['High_f_down']
+00028a00: 207c 2064 665f 6465 6275 675b 2748 6967   | df_debug['Hig
+00028a10: 685f 665f 7570 275d 207c 2064 665f 6465  h_f_up'] | df_de
+00028a20: 6275 675b 274c 6f77 5f66 5f64 6f77 6e27  bug['Low_f_down'
+00028a30: 5d20 7c20 6466 5f64 6562 7567 5b27 4c6f  ] | df_debug['Lo
+00028a40: 775f 665f 7570 275d 0a20 2020 2020 2020  w_f_up'].       
+00028a50: 2023 2066 5f63 6861 6e67 655f 6861 7070   # f_change_happ
+00028a60: 656e 6564 203d 2066 5f63 6861 6e67 655f  ened = f_change_
+00028a70: 6861 7070 656e 6564 207c 206e 702e 726f  happened | np.ro
+00028a80: 6c6c 2866 5f63 6861 6e67 655f 6861 7070  ll(f_change_happ
+00028a90: 656e 6564 2c20 3129 207c 206e 702e 726f  ened, 1) | np.ro
+00028aa0: 6c6c 2866 5f63 6861 6e67 655f 6861 7070  ll(f_change_happ
+00028ab0: 656e 6564 2c20 2d31 2920 7c20 6e70 2e72  ened, -1) | np.r
+00028ac0: 6f6c 6c28 665f 6368 616e 6765 5f68 6170  oll(f_change_hap
+00028ad0: 7065 6e65 642c 2032 2920 7c20 6e70 2e72  pened, 2) | np.r
+00028ae0: 6f6c 6c28 665f 6368 616e 6765 5f68 6170  oll(f_change_hap
+00028af0: 7065 6e65 642c 202d 3229 0a20 2020 2020  pened, -2).     
+00028b00: 2020 2023 2066 5f63 6861 6e67 655f 6861     # f_change_ha
+00028b10: 7070 656e 6564 5b30 5d20 3d20 5472 7565  ppened[0] = True
+00028b20: 203b 2066 5f63 6861 6e67 655f 6861 7070   ; f_change_happ
+00028b30: 656e 6564 5b2d 315d 203d 2054 7275 650a  ened[-1] = True.
+00028b40: 2020 2020 2020 2020 2320 6466 5f64 6562          # df_deb
+00028b50: 7567 203d 2064 665f 6465 6275 675b 665f  ug = df_debug[f_
+00028b60: 6368 616e 6765 5f68 6170 7065 6e65 645d  change_happened]
+00028b70: 0a20 2020 2020 2020 2023 2023 2023 2064  .        # # # d
+00028b80: 665f 6465 6275 6720 3d20 6466 5f64 6562  f_debug = df_deb
+00028b90: 7567 2e6c 6f63 5b64 662e 696e 6465 782e  ug.loc[df.index.
+00028ba0: 6461 7465 203c 3d20 6461 7465 2832 3032  date <= date(202
+00028bb0: 332c 2032 2c20 3133 295d 5b27 436c 6f73  3, 2, 13)]['Clos
+00028bc0: 6527 5d2e 746f 5f6e 756d 7079 2829 0a20  e'].to_numpy(). 
+00028bd0: 2020 2020 2020 2023 2023 2023 2064 665f         # # # df_
+00028be0: 6465 6275 6720 3d20 6466 5f64 6562 7567  debug = df_debug
+00028bf0: 2e69 6c6f 635b 3432 2a35 203a 2034 362a  .iloc[42*5 : 46*
+00028c00: 355d 0a20 2020 2020 2020 2023 2023 2023  5].        # # #
+00028c10: 2064 665f 6465 6275 6720 3d20 6466 2e73   df_debug = df.s
+00028c20: 6f72 745f 696e 6465 7828 292e 6c6f 635b  ort_index().loc[
+00028c30: 2732 3032 332d 3036 2d32 3927 3a27 3230  '2023-06-29':'20
+00028c40: 3233 2d30 372d 3034 275d 5b4f 484c 435d  23-07-04'][OHLC]
+00028c50: 2e73 6f72 745f 696e 6465 7828 6173 6365  .sort_index(asce
+00028c60: 6e64 696e 673d 4661 6c73 6529 0a20 2020  nding=False).   
+00028c70: 2020 2020 2023 206d 7367 203d 2066 2270       # msg = f"p
+00028c80: 7269 6365 2d72 6570 6169 722d 7370 6c69  rice-repair-spli
+00028c90: 743a 206d 7920 776f 726b 696e 6773 3a22  t: my workings:"
+00028ca0: 202b 2027 5c6e 2720 2b20 7374 7228 6466   + '\n' + str(df
+00028cb0: 5f64 6562 7567 290a 2020 2020 2020 2020  _debug).        
+00028cc0: 2320 7365 6c66 2e6d 616e 6167 6572 2e4c  # self.manager.L
+00028cd0: 6f67 4576 656e 7428 2764 6562 7567 272c  ogEvent('debug',
+00028ce0: 2027 7072 6963 652d 7265 7061 6972 2d73   'price-repair-s
+00028cf0: 706c 6974 2d27 2b73 656c 662e 6973 7472  plit-'+self.istr
+00028d00: 2c20 6d73 6729 0a20 2020 2020 2020 2023  , msg).        #
+00028d10: 2071 7569 7428 290a 0a20 2020 2020 2020   quit()..       
+00028d20: 2064 6566 206d 6170 5f73 6967 6e61 6c73   def map_signals
+00028d30: 5f74 6f5f 7261 6e67 6573 2866 2c20 665f  _to_ranges(f, f_
+00028d40: 7570 2c20 665f 646f 776e 293a 0a20 2020  up, f_down):.   
+00028d50: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00028d60: 6520 3074 6820 656c 656d 656e 7420 6973  e 0th element is
+00028d70: 2046 616c 7365 2c20 6265 6361 7573 6520   False, because 
+00028d80: 5472 7565 2069 7320 6e6f 6e73 656e 7365  True is nonsense
+00028d90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028da0: 665b 305d 3a0a 2020 2020 2020 2020 2020  f[0]:.          
+00028db0: 2020 2020 2020 6620 3d20 6e70 2e63 6f70        f = np.cop
+00028dc0: 7928 6629 203b 2066 5b30 5d20 3d20 4661  y(f) ; f[0] = Fa
+00028dd0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00028de0: 2020 2020 665f 7570 203d 206e 702e 636f      f_up = np.co
+00028df0: 7079 2866 5f75 7029 203b 2066 5f75 705b  py(f_up) ; f_up[
+00028e00: 305d 203d 2046 616c 7365 0a20 2020 2020  0] = False.     
+00028e10: 2020 2020 2020 2020 2020 2066 5f64 6f77             f_dow
+00028e20: 6e20 3d20 6e70 2e63 6f70 7928 665f 646f  n = np.copy(f_do
+00028e30: 776e 2920 3b20 665f 646f 776e 5b30 5d20  wn) ; f_down[0] 
+00028e40: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+00028e50: 2020 2020 2069 6620 6e6f 7420 662e 616e       if not f.an
+00028e60: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+00028e70: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+00028e80: 2020 2020 2020 2020 2020 2020 7472 7565              true
+00028e90: 5f69 6e64 6963 6573 203d 206e 702e 7768  _indices = np.wh
+00028ea0: 6572 6528 6629 5b30 5d0a 2020 2020 2020  ere(f)[0].      
+00028eb0: 2020 2020 2020 7261 6e67 6573 203d 205b        ranges = [
+00028ec0: 5d0a 0a20 2020 2020 2020 2020 2020 2066  ]..            f
+00028ed0: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00028ee0: 6e28 7472 7565 5f69 6e64 6963 6573 2920  n(true_indices) 
+00028ef0: 2d20 3129 3a0a 2020 2020 2020 2020 2020  - 1):.          
+00028f00: 2020 2020 2020 6966 2069 2025 2032 203d        if i % 2 =
+00028f10: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00028f20: 2020 2020 2020 2020 2069 6620 7370 6c69           if spli
+00028f30: 7420 3e20 312e 303a 0a20 2020 2020 2020  t > 1.0:.       
+00028f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f50: 2061 646a 203d 2027 7370 6c69 7427 2069   adj = 'split' i
+00028f60: 6620 665f 646f 776e 5b74 7275 655f 696e  f f_down[true_in
+00028f70: 6469 6365 735b 695d 5d20 656c 7365 2027  dices[i]] else '
+00028f80: 312e 302f 7370 6c69 7427 0a20 2020 2020  1.0/split'.     
+00028f90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00028fa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00028fb0: 2020 2020 2020 2020 2020 2020 2061 646a               adj
+00028fc0: 203d 2027 312e 302f 7370 6c69 7427 2069   = '1.0/split' i
+00028fd0: 6620 665f 646f 776e 5b74 7275 655f 696e  f f_down[true_in
+00028fe0: 6469 6365 735b 695d 5d20 656c 7365 2027  dices[i]] else '
+00028ff0: 7370 6c69 7427 0a20 2020 2020 2020 2020  split'.         
+00029000: 2020 2020 2020 2020 2020 2072 616e 6765             range
+00029010: 732e 6170 7065 6e64 2828 7472 7565 5f69  s.append((true_i
+00029020: 6e64 6963 6573 5b69 5d2c 2074 7275 655f  ndices[i], true_
+00029030: 696e 6469 6365 735b 6920 2b20 315d 2c20  indices[i + 1], 
+00029040: 6164 6a29 290a 0a20 2020 2020 2020 2020  adj))..         
+00029050: 2020 2069 6620 6c65 6e28 7472 7565 5f69     if len(true_i
+00029060: 6e64 6963 6573 2920 2520 3220 213d 2030  ndices) % 2 != 0
+00029070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029080: 2020 6966 2073 706c 6974 203e 2031 2e30    if split > 1.0
+00029090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000290a0: 2020 2020 2020 6164 6a20 3d20 2773 706c        adj = 'spl
+000290b0: 6974 2720 6966 2066 5f64 6f77 6e5b 7472  it' if f_down[tr
+000290c0: 7565 5f69 6e64 6963 6573 5b2d 315d 5d20  ue_indices[-1]] 
+000290d0: 656c 7365 2027 312e 302f 7370 6c69 7427  else '1.0/split'
+000290e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000290f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00029100: 2020 2020 2020 2020 2020 2061 646a 203d             adj =
+00029110: 2027 312e 302f 7370 6c69 7427 2069 6620   '1.0/split' if 
+00029120: 665f 646f 776e 5b74 7275 655f 696e 6469  f_down[true_indi
+00029130: 6365 735b 2d31 5d5d 2065 6c73 6520 2773  ces[-1]] else 's
+00029140: 706c 6974 270a 2020 2020 2020 2020 2020  plit'.          
+00029150: 2020 2020 2020 7261 6e67 6573 2e61 7070        ranges.app
+00029160: 656e 6428 2874 7275 655f 696e 6469 6365  end((true_indice
+00029170: 735b 2d31 5d2c 206c 656e 2866 292c 2061  s[-1], len(f), a
+00029180: 646a 2929 0a0a 2020 2020 2020 2020 2020  dj))..          
+00029190: 2020 7265 7475 726e 2072 616e 6765 730a    return ranges.
+000291a0: 0a20 2020 2020 2020 2069 6620 6964 785f  .        if idx_
+000291b0: 6c61 7465 7374 5f61 6374 6976 6520 6973  latest_active is
+000291c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000291d0: 2020 2020 2020 2069 6478 5f72 6576 5f6c         idx_rev_l
+000291e0: 6174 6573 745f 6163 7469 7665 203d 2064  atest_active = d
+000291f0: 662e 7368 6170 655b 305d 202d 2031 202d  f.shape[0] - 1 -
+00029200: 2069 6478 5f6c 6174 6573 745f 6163 7469   idx_latest_acti
+00029210: 7665 0a20 2020 2020 2020 2020 2020 206d  ve.            m
+00029220: 7367 203d 2066 2769 6478 5f6c 6174 6573  sg = f'idx_lates
+00029230: 745f 6163 7469 7665 3d7b 6964 785f 6c61  t_active={idx_la
+00029240: 7465 7374 5f61 6374 6976 657d 2c20 6964  test_active}, id
+00029250: 785f 7265 765f 6c61 7465 7374 5f61 6374  x_rev_latest_act
+00029260: 6976 653d 7b69 6478 5f72 6576 5f6c 6174  ive={idx_rev_lat
+00029270: 6573 745f 6163 7469 7665 7d27 0a20 2020  est_active}'.   
+00029280: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00029290: 6e61 6765 722e 4c6f 6745 7665 6e74 2827  nager.LogEvent('
+000292a0: 6465 6275 6727 2c20 2770 7269 6365 2d72  debug', 'price-r
+000292b0: 6570 6169 722d 7370 6c69 742d 272b 7365  epair-split-'+se
+000292c0: 6c66 2e69 7374 722c 206d 7367 290a 2020  lf.istr, msg).  
+000292d0: 2020 2020 2020 6966 2063 6f72 7265 6374        if correct
+000292e0: 5f63 6f6c 756d 6e73 5f69 6e64 6976 6964  _columns_individ
+000292f0: 7561 6c6c 793a 0a20 2020 2020 2020 2020  ually:.         
+00029300: 2020 2066 5f63 6f72 7265 6374 6564 203d     f_corrected =
+00029310: 206e 702e 6675 6c6c 286e 2c20 4661 6c73   np.full(n, Fals
+00029320: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+00029330: 6620 636f 7272 6563 745f 766f 6c75 6d65  f correct_volume
+00029340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029350: 2020 2320 4966 204f 7065 6e20 6f72 2043    # If Open or C
+00029360: 6c6f 7365 2069 7320 7265 7061 6972 6564  lose is repaired
+00029370: 2062 7574 206e 6f74 2062 6f74 682c 200a   but not both, .
+00029380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029390: 2320 7468 656e 2074 6869 7320 6d65 616e  # then this mean
+000293a0: 7320 7468 6520 696e 7465 7276 616c 2068  s the interval h
+000293b0: 6173 2061 206d 6978 206f 6620 636f 7272  as a mix of corr
+000293c0: 6563 740a 2020 2020 2020 2020 2020 2020  ect.            
+000293d0: 2020 2020 2320 616e 6420 6572 726f 7273      # and errors
+000293e0: 2e20 4120 7072 6f62 6c65 6d20 666f 7220  . A problem for 
+000293f0: 636f 7272 6563 7469 6e67 2056 6f6c 756d  correcting Volum
+00029400: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
+00029410: 2020 2020 2320 736f 2075 7365 2061 2068      # so use a h
+00029420: 6575 7269 7374 6963 3a0a 2020 2020 2020  euristic:.      
+00029430: 2020 2020 2020 2020 2020 2320 2d20 6966            # - if
+00029440: 2062 6f74 6820 4f70 656e 2026 2043 6c6f   both Open & Clo
+00029450: 7365 2077 6572 6520 4e78 2062 6164 203d  se were Nx bad =
+00029460: 3e20 566f 6c75 6d65 2069 7320 4e78 2062  > Volume is Nx b
+00029470: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
+00029480: 2020 2023 202d 2069 6620 6f6e 6c79 206f     # - if only o
+00029490: 6e65 206f 6620 4f70 656e 2026 2043 6c6f  ne of Open & Clo
+000294a0: 7365 2061 7265 204e 7820 6261 6420 3d3e  se are Nx bad =>
+000294b0: 2056 6f6c 756d 6520 6973 2030 2e35 2a4e   Volume is 0.5*N
+000294c0: 7820 6261 640a 2020 2020 2020 2020 2020  x bad.          
+000294d0: 2020 2020 2020 665f 6f70 656e 5f66 6978        f_open_fix
+000294e0: 6564 203d 206e 702e 6675 6c6c 286e 2c20  ed = np.full(n, 
+000294f0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+00029500: 2020 2020 2020 2066 5f63 6c6f 7365 5f66         f_close_f
+00029510: 6978 6564 203d 206e 702e 6675 6c6c 286e  ixed = np.full(n
+00029520: 2c20 4661 6c73 6529 0a0a 2020 2020 2020  , False)..      
+00029530: 2020 2020 2020 4f48 4c43 5f63 6f72 7265        OHLC_corre
+00029540: 6374 5f72 616e 6765 7320 3d20 5b4e 6f6e  ct_ranges = [Non
+00029550: 652c 204e 6f6e 652c 204e 6f6e 652c 204e  e, None, None, N
+00029560: 6f6e 655d 0a20 2020 2020 2020 2020 2020  one].           
+00029570: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
+00029580: 6c65 6e28 4f48 4c43 2929 3a0a 2020 2020  len(OHLC)):.    
+00029590: 2020 2020 2020 2020 2020 2020 6320 3d20              c = 
+000295a0: 4f48 4c43 5b6a 5d0a 2020 2020 2020 2020  OHLC[j].        
+000295b0: 2020 2020 2020 2020 6964 785f 6669 7273          idx_firs
+000295c0: 745f 6620 3d20 6e70 2e77 6865 7265 2866  t_f = np.where(f
+000295d0: 295b 305d 5b30 5d0a 2020 2020 2020 2020  )[0][0].        
+000295e0: 2020 2020 2020 2020 6966 2061 7070 6561          if appea
+000295f0: 7273 5f73 7573 7065 6e64 6564 2061 6e64  rs_suspended and
+00029600: 2028 6964 785f 6c61 7465 7374 5f61 6374   (idx_latest_act
+00029610: 6976 6520 6973 206e 6f74 204e 6f6e 6520  ive is not None 
+00029620: 616e 6420 6964 785f 6c61 7465 7374 5f61  and idx_latest_a
+00029630: 6374 6976 6520 3e3d 2069 6478 5f66 6972  ctive >= idx_fir
+00029640: 7374 5f66 293a 0a20 2020 2020 2020 2020  st_f):.         
+00029650: 2020 2020 2020 2020 2020 2023 2053 7573             # Sus
+00029660: 7065 6e64 6564 206d 6964 7761 7920 6475  pended midway du
+00029670: 7269 6e67 2064 6174 6120 6461 7465 2072  ring data date r
+00029680: 616e 6765 2e0a 2020 2020 2020 2020 2020  ange..          
+00029690: 2020 2020 2020 2020 2020 2320 313a 2070            # 1: p
+000296a0: 726f 6365 7373 2064 6174 6120 6265 666f  rocess data befo
+000296b0: 7265 2073 7573 7065 6e73 696f 6e20 696e  re suspension in
+000296c0: 2069 6e64 6578 2d61 7363 656e 6469 6e67   index-ascending
+000296d0: 2028 6461 7465 2d64 6573 6365 6e64 696e   (date-descendin
+000296e0: 6729 206f 7264 6572 2e0a 2020 2020 2020  g) order..      
+000296f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00029700: 323a 2070 726f 6365 7373 2064 6174 6120  2: process data 
+00029710: 6166 7465 7220 7375 7370 656e 7369 6f6e  after suspension
+00029720: 2069 6e20 696e 6465 782d 6465 7363 656e   in index-descen
+00029730: 6469 6e67 206f 7264 6572 2e20 5265 7175  ding order. Requ
+00029740: 6972 6573 2073 6967 6e61 6c73 2074 6f20  ires signals to 
+00029750: 6265 2072 6576 6572 7365 642c 200a 2020  be reversed, .  
+00029760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029770: 2020 2320 2020 2074 6865 6e20 7265 7475    #    then retu
+00029780: 726e 6564 2072 616e 6765 7320 746f 2061  rned ranges to a
+00029790: 6c73 6f20 6265 2072 6576 6572 7365 642c  lso be reversed,
+000297a0: 2062 6563 6175 7365 2074 6869 7320 6c6f   because this lo
+000297b0: 6769 6320 7761 7320 6f72 6967 696e 616c  gic was original
+000297c0: 6c79 2077 7269 7474 656e 2066 6f72 0a20  ly written for. 
+000297d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000297e0: 2020 2023 2020 2020 696e 6465 782d 6173     #    index-as
+000297f0: 6365 6e64 696e 6720 2864 6174 652d 6465  cending (date-de
+00029800: 7363 656e 6469 6e67 2920 6f72 6465 722e  scending) order.
+00029810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029820: 2020 2020 2066 6a20 3d20 665b 3a2c 206a       fj = f[:, j
+00029830: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00029840: 2020 2020 2020 665f 7570 6a20 3d20 665f        f_upj = f_
+00029850: 7570 5b3a 2c20 6a5d 0a20 2020 2020 2020  up[:, j].       
+00029860: 2020 2020 2020 2020 2020 2020 2066 5f64               f_d
+00029870: 6f77 6e6a 203d 2066 5f64 6f77 6e5b 3a2c  ownj = f_down[:,
+00029880: 206a 5d0a 2020 2020 2020 2020 2020 2020   j].            
+00029890: 2020 2020 2020 2020 7261 6e67 6573 5f62          ranges_b
+000298a0: 6566 6f72 6520 3d20 6d61 705f 7369 676e  efore = map_sign
+000298b0: 616c 735f 746f 5f72 616e 6765 7328 666a  als_to_ranges(fj
+000298c0: 5b69 6478 5f6c 6174 6573 745f 6163 7469  [idx_latest_acti
+000298d0: 7665 3a5d 2c20 665f 7570 6a5b 6964 785f  ve:], f_upj[idx_
+000298e0: 6c61 7465 7374 5f61 6374 6976 653a 5d2c  latest_active:],
+000298f0: 2066 5f64 6f77 6e6a 5b69 6478 5f6c 6174   f_downj[idx_lat
+00029900: 6573 745f 6163 7469 7665 3a5d 290a 2020  est_active:]).  
+00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029920: 2020 6966 206c 656e 2872 616e 6765 735f    if len(ranges_
+00029930: 6265 666f 7265 2920 3e20 303a 0a20 2020  before) > 0:.   
+00029940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029950: 2020 2020 2023 2053 6869 6674 2065 6163       # Shift eac
+00029960: 6820 7261 6e67 6520 6261 636b 2074 6f20  h range back to 
+00029970: 676c 6f62 616c 2069 6e64 6578 696e 670a  global indexing.
+00029980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029990: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+000299a0: 2072 616e 6765 286c 656e 2872 616e 6765   range(len(range
+000299b0: 735f 6265 666f 7265 2929 3a0a 2020 2020  s_before)):.    
+000299c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299d0: 2020 2020 2020 2020 7220 3d20 7261 6e67          r = rang
+000299e0: 6573 5f62 6566 6f72 655b 695d 0a20 2020  es_before[i].   
 000299f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a00: 2320 5375 7370 656e 6465 6420 6d69 6477  # Suspended midw
-00029a10: 6179 2064 7572 696e 6720 6461 7461 2064  ay during data d
-00029a20: 6174 6520 7261 6e67 652e 0a20 2020 2020  ate range..     
-00029a30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00029a40: 2031 3a20 7072 6f63 6573 7320 6461 7461   1: process data
-00029a50: 2062 6566 6f72 6520 7375 7370 656e 7369   before suspensi
-00029a60: 6f6e 2069 6e20 696e 6465 782d 6173 6365  on in index-asce
-00029a70: 6e64 696e 6720 2864 6174 652d 6465 7363  nding (date-desc
-00029a80: 656e 6469 6e67 2920 6f72 6465 722e 0a20  ending) order.. 
-00029a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029aa0: 2020 2023 2032 3a20 7072 6f63 6573 7320     # 2: process 
-00029ab0: 6461 7461 2061 6674 6572 2073 7573 7065  data after suspe
-00029ac0: 6e73 696f 6e20 696e 2069 6e64 6578 2d64  nsion in index-d
-00029ad0: 6573 6365 6e64 696e 6720 6f72 6465 722e  escending order.
-00029ae0: 2052 6571 7569 7265 7320 7369 676e 616c   Requires signal
-00029af0: 7320 746f 2062 6520 7265 7665 7273 6564  s to be reversed
-00029b00: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00029b10: 2020 2020 2020 2023 2020 2020 7468 656e         #    then
-00029b20: 2072 6574 7572 6e65 6420 7261 6e67 6573   returned ranges
-00029b30: 2074 6f20 616c 736f 2062 6520 7265 7665   to also be reve
-00029b40: 7273 6564 2c20 6265 6361 7573 6520 7468  rsed, because th
-00029b50: 6973 206c 6f67 6963 2077 6173 206f 7269  is logic was ori
-00029b60: 6769 6e61 6c6c 7920 7772 6974 7465 6e20  ginally written 
-00029b70: 666f 720a 2020 2020 2020 2020 2020 2020  for.            
-00029b80: 2020 2020 2020 2020 2320 2020 2069 6e64          #    ind
-00029b90: 6578 2d61 7363 656e 6469 6e67 2028 6461  ex-ascending (da
-00029ba0: 7465 2d64 6573 6365 6e64 696e 6729 206f  te-descending) o
-00029bb0: 7264 6572 2e0a 2020 2020 2020 2020 2020  rder..          
-00029bc0: 2020 2020 2020 2020 2020 666a 203d 2066            fj = f
-00029bd0: 5b3a 2c20 6a5d 0a20 2020 2020 2020 2020  [:, j].         
-00029be0: 2020 2020 2020 2020 2020 2066 5f75 706a             f_upj
-00029bf0: 203d 2066 5f75 705b 3a2c 206a 5d0a 2020   = f_up[:, j].  
-00029c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029c10: 2020 665f 646f 776e 6a20 3d20 665f 646f    f_downj = f_do
-00029c20: 776e 5b3a 2c20 6a5d 0a20 2020 2020 2020  wn[:, j].       
-00029c30: 2020 2020 2020 2020 2020 2020 2072 616e               ran
-00029c40: 6765 735f 6265 666f 7265 203d 206d 6170  ges_before = map
-00029c50: 5f73 6967 6e61 6c73 5f74 6f5f 7261 6e67  _signals_to_rang
-00029c60: 6573 2866 6a5b 6964 785f 6c61 7465 7374  es(fj[idx_latest
-00029c70: 5f61 6374 6976 653a 5d2c 2066 5f75 706a  _active:], f_upj
-00029c80: 5b69 6478 5f6c 6174 6573 745f 6163 7469  [idx_latest_acti
-00029c90: 7665 3a5d 2c20 665f 646f 776e 6a5b 6964  ve:], f_downj[id
-00029ca0: 785f 6c61 7465 7374 5f61 6374 6976 653a  x_latest_active:
-00029cb0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00029cc0: 2020 2020 2020 2069 6620 6c65 6e28 7261         if len(ra
-00029cd0: 6e67 6573 5f62 6566 6f72 6529 203e 2030  nges_before) > 0
-00029ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029cf0: 2020 2020 2020 2020 2020 2320 5368 6966            # Shif
-00029d00: 7420 6561 6368 2072 616e 6765 2062 6163  t each range bac
-00029d10: 6b20 746f 2067 6c6f 6261 6c20 696e 6465  k to global inde
-00029d20: 7869 6e67 0a20 2020 2020 2020 2020 2020  xing.           
-00029d30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00029d40: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00029d50: 7261 6e67 6573 5f62 6566 6f72 6529 293a  ranges_before)):
-00029d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029d70: 2020 2020 2020 2020 2020 2020 2072 203d               r =
-00029d80: 2072 616e 6765 735f 6265 666f 7265 5b69   ranges_before[i
-00029d90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00029da0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00029db0: 6e67 6573 5f62 6566 6f72 655b 695d 203d  nges_before[i] =
-00029dc0: 2028 725b 305d 202b 2069 6478 5f6c 6174   (r[0] + idx_lat
-00029dd0: 6573 745f 6163 7469 7665 2c20 725b 315d  est_active, r[1]
-00029de0: 202b 2069 6478 5f6c 6174 6573 745f 6163   + idx_latest_ac
-00029df0: 7469 7665 2c20 725b 325d 290a 2020 2020  tive, r[2]).    
-00029e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029e10: 665f 7265 765f 646f 776e 6a20 3d20 6e70  f_rev_downj = np
-00029e20: 2e66 6c69 7028 6e70 2e72 6f6c 6c28 665f  .flip(np.roll(f_
-00029e30: 7570 6a2c 202d 3129 2920 2023 2063 6f72  upj, -1))  # cor
-00029e40: 7265 6374 0a20 2020 2020 2020 2020 2020  rect.           
-00029e50: 2020 2020 2020 2020 2066 5f72 6576 5f75           f_rev_u
-00029e60: 706a 203d 206e 702e 666c 6970 286e 702e  pj = np.flip(np.
-00029e70: 726f 6c6c 2866 5f64 6f77 6e6a 2c20 2d31  roll(f_downj, -1
-00029e80: 2929 2020 2320 636f 7272 6563 740a 2020  ))  # correct.  
-00029e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ea0: 2020 665f 7265 766a 203d 2066 5f72 6576    f_revj = f_rev
-00029eb0: 5f75 706a 207c 2066 5f72 6576 5f64 6f77  _upj | f_rev_dow
-00029ec0: 6e6a 0a20 2020 2020 2020 2020 2020 2020  nj.             
-00029ed0: 2020 2020 2020 2072 616e 6765 735f 6166         ranges_af
-00029ee0: 7465 7220 3d20 6d61 705f 7369 676e 616c  ter = map_signal
-00029ef0: 735f 746f 5f72 616e 6765 7328 665f 7265  s_to_ranges(f_re
-00029f00: 766a 5b69 6478 5f72 6576 5f6c 6174 6573  vj[idx_rev_lates
-00029f10: 745f 6163 7469 7665 3a5d 2c20 665f 7265  t_active:], f_re
-00029f20: 765f 7570 6a5b 6964 785f 7265 765f 6c61  v_upj[idx_rev_la
-00029f30: 7465 7374 5f61 6374 6976 653a 5d2c 2066  test_active:], f
-00029f40: 5f72 6576 5f64 6f77 6e6a 5b69 6478 5f72  _rev_downj[idx_r
-00029f50: 6576 5f6c 6174 6573 745f 6163 7469 7665  ev_latest_active
-00029f60: 3a5d 290a 2020 2020 2020 2020 2020 2020  :]).            
-00029f70: 2020 2020 2020 2020 6966 206c 656e 2872          if len(r
-00029f80: 616e 6765 735f 6166 7465 7229 203e 2030  anges_after) > 0
-00029f90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029fa0: 2020 2020 2020 2020 2020 2320 5368 6966            # Shif
-00029fb0: 7420 6561 6368 2072 616e 6765 2062 6163  t each range bac
-00029fc0: 6b20 746f 2067 6c6f 6261 6c20 696e 6465  k to global inde
-00029fd0: 7869 6e67 3a0a 2020 2020 2020 2020 2020  xing:.          
-00029fe0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00029ff0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-0002a000: 2872 616e 6765 735f 6166 7465 7229 293a  (ranges_after)):
-0002a010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a020: 2020 2020 2020 2020 2020 2020 2072 203d               r =
-0002a030: 2072 616e 6765 735f 6166 7465 725b 695d   ranges_after[i]
-0002a040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a050: 2020 2020 2020 2020 2020 2020 2072 616e               ran
-0002a060: 6765 735f 6166 7465 725b 695d 203d 2028  ges_after[i] = (
-0002a070: 725b 305d 202b 2069 6478 5f72 6576 5f6c  r[0] + idx_rev_l
-0002a080: 6174 6573 745f 6163 7469 7665 2c20 725b  atest_active, r[
-0002a090: 315d 202b 2069 6478 5f72 6576 5f6c 6174  1] + idx_rev_lat
-0002a0a0: 6573 745f 6163 7469 7665 2c20 725b 325d  est_active, r[2]
-0002a0b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002a0c0: 2020 2020 2020 2020 2020 2320 466c 6970            # Flip
-0002a0d0: 2072 616e 6765 2074 6f20 6e6f 726d 616c   range to normal
-0002a0e0: 206f 7264 6572 696e 670a 2020 2020 2020   ordering.      
-0002a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a100: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0002a110: 286c 656e 2872 616e 6765 735f 6166 7465  (len(ranges_afte
-0002a120: 7229 293a 0a20 2020 2020 2020 2020 2020  r)):.           
-0002a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a140: 2072 203d 2072 616e 6765 735f 6166 7465   r = ranges_afte
-0002a150: 725b 695d 0a20 2020 2020 2020 2020 2020  r[i].           
-0002a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a170: 2072 616e 6765 735f 6166 7465 725b 695d   ranges_after[i]
-0002a180: 203d 2028 6e2d 725b 315d 2c20 6e2d 725b   = (n-r[1], n-r[
-0002a190: 305d 2c20 725b 325d 290a 2020 2020 2020  0], r[2]).      
-0002a1a0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0002a1b0: 6e67 6573 203d 2072 616e 6765 735f 6265  nges = ranges_be
-0002a1c0: 666f 7265 203b 2072 616e 6765 732e 6578  fore ; ranges.ex
-0002a1d0: 7465 6e64 2872 616e 6765 735f 6166 7465  tend(ranges_afte
-0002a1e0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0002a1f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002a200: 2020 2020 2020 2020 2020 2020 2072 616e               ran
-0002a210: 6765 7320 3d20 6d61 705f 7369 676e 616c  ges = map_signal
-0002a220: 735f 746f 5f72 616e 6765 7328 665b 3a2c  s_to_ranges(f[:,
-0002a230: 206a 5d2c 2066 5f75 705b 3a2c 206a 5d2c   j], f_up[:, j],
-0002a240: 2066 5f64 6f77 6e5b 3a2c 206a 5d29 0a0a   f_down[:, j])..
-0002a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a260: 6966 2073 7461 7274 5f6d 696e 2069 7320  if start_min is 
-0002a270: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0002a280: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002a290: 5072 756e 6520 7261 6e67 6573 2074 6861  Prune ranges tha
-0002a2a0: 7420 6172 6520 6f6c 6465 7220 7468 616e  t are older than
-0002a2b0: 2073 7461 7274 5f6d 696e 0a20 2020 2020   start_min.     
-0002a2c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002a2d0: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-0002a2e0: 6e28 7261 6e67 6573 292d 312c 202d 312c  n(ranges)-1, -1,
-0002a2f0: 202d 3129 3a0a 2020 2020 2020 2020 2020   -1):.          
-0002a300: 2020 2020 2020 2020 2020 2020 2020 7220                r 
-0002a310: 3d20 7261 6e67 6573 5b69 5d0a 2020 2020  = ranges[i].    
-0002a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a330: 2020 2020 6966 2064 662e 696e 6465 785b      if df.index[
-0002a340: 725b 305d 5d2e 6461 7465 2829 203c 2073  r[0]].date() < s
-0002a350: 7461 7274 5f6d 696e 3a0a 2020 2020 2020  tart_min:.      
-0002a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a370: 2020 2020 2020 6d73 6720 3d20 6627 7072        msg = f'pr
-0002a380: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
-0002a390: 3a20 5072 756e 696e 6720 7b63 7d20 7261  : Pruning {c} ra
-0002a3a0: 6e67 6520 7b64 662e 696e 6465 785b 725b  nge {df.index[r[
-0002a3b0: 305d 5d7d 2d3e 7b64 662e 696e 6465 785b  0]]}->{df.index[
-0002a3c0: 725b 315d 2d31 5d7d 2062 6563 6175 7365  r[1]-1]} because
-0002a3d0: 2074 6f6f 206f 6c64 2e27 0a20 2020 2020   too old.'.     
-0002a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3f0: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
-0002a400: 6765 722e 4c6f 6745 7665 6e74 2827 696e  ger.LogEvent('in
-0002a410: 666f 272c 2027 7072 6963 652d 7265 7061  fo', 'price-repa
-0002a420: 6972 2d73 706c 6974 2d27 2b73 656c 662e  ir-split-'+self.
-0002a430: 6973 7472 2c20 6d73 6729 0a20 2020 2020  istr, msg).     
-0002a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a450: 2020 2020 2020 2064 656c 2072 616e 6765         del range
-0002a460: 735b 695d 0a0a 2020 2020 2020 2020 2020  s[i]..          
-0002a470: 2020 2020 2020 6966 206c 656e 2872 616e        if len(ran
-0002a480: 6765 7329 203e 2030 3a0a 2020 2020 2020  ges) > 0:.      
-0002a490: 2020 2020 2020 2020 2020 2020 2020 4f48                OH
-0002a4a0: 4c43 5f63 6f72 7265 6374 5f72 616e 6765  LC_correct_range
-0002a4b0: 735b 6a5d 203d 2072 616e 6765 730a 0a20  s[j] = ranges.. 
-0002a4c0: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
-0002a4d0: 203d 2073 756d 285b 3120 6966 2078 2069   = sum([1 if x i
-0002a4e0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-0002a4f0: 3020 666f 7220 7820 696e 204f 484c 435f  0 for x in OHLC_
-0002a500: 636f 7272 6563 745f 7261 6e67 6573 5d29  correct_ranges])
-0002a510: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002a520: 636f 756e 7420 3d3d 2030 3a0a 2020 2020  count == 0:.    
-0002a530: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0002a540: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0002a550: 6620 636f 756e 7420 3d3d 2031 3a0a 2020  f count == 1:.  
-0002a560: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002a570: 4966 206f 6e6c 7920 3120 636f 6c75 6d6e  If only 1 column
-0002a580: 2074 6865 6e20 6173 7375 6d65 2066 616c   then assume fal
-0002a590: 7365 2070 6f73 6974 6976 650a 2020 2020  se positive.    
-0002a5a0: 2020 2020 2020 2020 2020 2020 6964 7873              idxs
-0002a5b0: 203d 205b 6920 6966 204f 484c 435f 636f   = [i if OHLC_co
-0002a5c0: 7272 6563 745f 7261 6e67 6573 5b69 5d20  rrect_ranges[i] 
-0002a5d0: 656c 7365 202d 3120 666f 7220 6920 696e  else -1 for i in
-0002a5e0: 2072 616e 6765 286c 656e 284f 484c 4329   range(len(OHLC)
-0002a5f0: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
-0002a600: 2020 2069 6478 203d 206e 702e 7768 6572     idx = np.wher
-0002a610: 6528 6e70 2e61 7272 6179 2869 6478 7329  e(np.array(idxs)
-0002a620: 2021 3d20 2d31 295b 305d 5b30 5d0a 2020   != -1)[0][0].  
-0002a630: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002a640: 6c20 3d20 4f48 4c43 5b69 6478 5d0a 2020  l = OHLC[idx].  
-0002a650: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-0002a660: 6720 3d20 6627 7072 6963 652d 7265 7061  g = f'price-repa
-0002a670: 6972 2d73 706c 6974 3a20 506f 7465 6e74  ir-split: Potent
-0002a680: 6961 6c20 7b66 6978 5f74 7970 657d 2064  ial {fix_type} d
-0002a690: 6574 6563 7465 6420 6f6e 6c79 2069 6e20  etected only in 
-0002a6a0: 636f 6c75 6d6e 207b 636f 6c7d 2c20 736f  column {col}, so
-0002a6b0: 2074 7265 6174 696e 6720 6173 2066 616c   treating as fal
-0002a6c0: 7365 2070 6f73 6974 6976 6520 2869 676e  se positive (ign
-0002a6d0: 6f72 6529 270a 2020 2020 2020 2020 2020  ore)'.          
-0002a6e0: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-0002a6f0: 6572 2e4c 6f67 4576 656e 7428 2769 6e66  er.LogEvent('inf
-0002a700: 6f27 2c20 2770 7269 6365 2d72 6570 6169  o', 'price-repai
-0002a710: 722d 7370 6c69 742d 272b 7365 6c66 2e69  r-split-'+self.i
-0002a720: 7374 722c 206d 7367 290a 2020 2020 2020  str, msg).      
-0002a730: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002a740: 2020 2020 2020 2020 2020 2020 2320 4f6e              # On
-0002a750: 6c79 2063 6f72 7265 6374 2069 6620 6174  ly correct if at
-0002a760: 206c 6561 7374 2032 2063 6f6c 756d 6e73   least 2 columns
-0002a770: 2072 6571 7569 7265 2063 6f72 7265 6374   require correct
-0002a780: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-0002a790: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-0002a7a0: 6e67 6528 6c65 6e28 4f48 4c43 2929 3a0a  nge(len(OHLC)):.
-0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7c0: 2020 2020 6320 3d20 4f48 4c43 5b6a 5d0a      c = OHLC[j].
+00029a00: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
+00029a10: 6265 666f 7265 5b69 5d20 3d20 2872 5b30  before[i] = (r[0
+00029a20: 5d20 2b20 6964 785f 6c61 7465 7374 5f61  ] + idx_latest_a
+00029a30: 6374 6976 652c 2072 5b31 5d20 2b20 6964  ctive, r[1] + id
+00029a40: 785f 6c61 7465 7374 5f61 6374 6976 652c  x_latest_active,
+00029a50: 2072 5b32 5d29 0a20 2020 2020 2020 2020   r[2]).         
+00029a60: 2020 2020 2020 2020 2020 2066 5f72 6576             f_rev
+00029a70: 5f64 6f77 6e6a 203d 206e 702e 666c 6970  _downj = np.flip
+00029a80: 286e 702e 726f 6c6c 2866 5f75 706a 2c20  (np.roll(f_upj, 
+00029a90: 2d31 2929 2020 2320 636f 7272 6563 740a  -1))  # correct.
+00029aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ab0: 2020 2020 665f 7265 765f 7570 6a20 3d20      f_rev_upj = 
+00029ac0: 6e70 2e66 6c69 7028 6e70 2e72 6f6c 6c28  np.flip(np.roll(
+00029ad0: 665f 646f 776e 6a2c 202d 3129 2920 2023  f_downj, -1))  #
+00029ae0: 2063 6f72 7265 6374 0a20 2020 2020 2020   correct.       
+00029af0: 2020 2020 2020 2020 2020 2020 2066 5f72               f_r
+00029b00: 6576 6a20 3d20 665f 7265 765f 7570 6a20  evj = f_rev_upj 
+00029b10: 7c20 665f 7265 765f 646f 776e 6a0a 2020  | f_rev_downj.  
+00029b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b30: 2020 7261 6e67 6573 5f61 6674 6572 203d    ranges_after =
+00029b40: 206d 6170 5f73 6967 6e61 6c73 5f74 6f5f   map_signals_to_
+00029b50: 7261 6e67 6573 2866 5f72 6576 6a5b 6964  ranges(f_revj[id
+00029b60: 785f 7265 765f 6c61 7465 7374 5f61 6374  x_rev_latest_act
+00029b70: 6976 653a 5d2c 2066 5f72 6576 5f75 706a  ive:], f_rev_upj
+00029b80: 5b69 6478 5f72 6576 5f6c 6174 6573 745f  [idx_rev_latest_
+00029b90: 6163 7469 7665 3a5d 2c20 665f 7265 765f  active:], f_rev_
+00029ba0: 646f 776e 6a5b 6964 785f 7265 765f 6c61  downj[idx_rev_la
+00029bb0: 7465 7374 5f61 6374 6976 653a 5d29 0a20  test_active:]). 
+00029bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029bd0: 2020 2069 6620 6c65 6e28 7261 6e67 6573     if len(ranges
+00029be0: 5f61 6674 6572 2920 3e20 303a 0a20 2020  _after) > 0:.   
+00029bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c00: 2020 2020 2023 2053 6869 6674 2065 6163       # Shift eac
+00029c10: 6820 7261 6e67 6520 6261 636b 2074 6f20  h range back to 
+00029c20: 676c 6f62 616c 2069 6e64 6578 696e 673a  global indexing:
+00029c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029c40: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00029c50: 6e20 7261 6e67 6528 6c65 6e28 7261 6e67  n range(len(rang
+00029c60: 6573 5f61 6674 6572 2929 3a0a 2020 2020  es_after)):.    
+00029c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c80: 2020 2020 2020 2020 7220 3d20 7261 6e67          r = rang
+00029c90: 6573 5f61 6674 6572 5b69 5d0a 2020 2020  es_after[i].    
+00029ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029cb0: 2020 2020 2020 2020 7261 6e67 6573 5f61          ranges_a
+00029cc0: 6674 6572 5b69 5d20 3d20 2872 5b30 5d20  fter[i] = (r[0] 
+00029cd0: 2b20 6964 785f 7265 765f 6c61 7465 7374  + idx_rev_latest
+00029ce0: 5f61 6374 6976 652c 2072 5b31 5d20 2b20  _active, r[1] + 
+00029cf0: 6964 785f 7265 765f 6c61 7465 7374 5f61  idx_rev_latest_a
+00029d00: 6374 6976 652c 2072 5b32 5d29 0a20 2020  ctive, r[2]).   
+00029d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d20: 2020 2020 2023 2046 6c69 7020 7261 6e67       # Flip rang
+00029d30: 6520 746f 206e 6f72 6d61 6c20 6f72 6465  e to normal orde
+00029d40: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
+00029d50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00029d60: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+00029d70: 7261 6e67 6573 5f61 6674 6572 2929 3a0a  ranges_after)):.
+00029d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d90: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
+00029da0: 7261 6e67 6573 5f61 6674 6572 5b69 5d0a  ranges_after[i].
+00029db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029dc0: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
+00029dd0: 6573 5f61 6674 6572 5b69 5d20 3d20 286e  es_after[i] = (n
+00029de0: 2d72 5b31 5d2c 206e 2d72 5b30 5d2c 2072  -r[1], n-r[0], r
+00029df0: 5b32 5d29 0a20 2020 2020 2020 2020 2020  [2]).           
+00029e00: 2020 2020 2020 2020 2072 616e 6765 7320           ranges 
+00029e10: 3d20 7261 6e67 6573 5f62 6566 6f72 6520  = ranges_before 
+00029e20: 3b20 7261 6e67 6573 2e65 7874 656e 6428  ; ranges.extend(
+00029e30: 7261 6e67 6573 5f61 6674 6572 290a 2020  ranges_after).  
+00029e40: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00029e50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029e60: 2020 2020 2020 2020 7261 6e67 6573 203d          ranges =
+00029e70: 206d 6170 5f73 6967 6e61 6c73 5f74 6f5f   map_signals_to_
+00029e80: 7261 6e67 6573 2866 5b3a 2c20 6a5d 2c20  ranges(f[:, j], 
+00029e90: 665f 7570 5b3a 2c20 6a5d 2c20 665f 646f  f_up[:, j], f_do
+00029ea0: 776e 5b3a 2c20 6a5d 290a 0a20 2020 2020  wn[:, j])..     
+00029eb0: 2020 2020 2020 2020 2020 2069 6620 7374             if st
+00029ec0: 6172 745f 6d69 6e20 6973 206e 6f74 204e  art_min is not N
+00029ed0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00029ee0: 2020 2020 2020 2020 2023 2050 7275 6e65           # Prune
+00029ef0: 2072 616e 6765 7320 7468 6174 2061 7265   ranges that are
+00029f00: 206f 6c64 6572 2074 6861 6e20 7374 6172   older than star
+00029f10: 745f 6d69 6e0a 2020 2020 2020 2020 2020  t_min.          
+00029f20: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+00029f30: 696e 2072 616e 6765 286c 656e 2872 616e  in range(len(ran
+00029f40: 6765 7329 2d31 2c20 2d31 2c20 2d31 293a  ges)-1, -1, -1):
+00029f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029f60: 2020 2020 2020 2020 2072 203d 2072 616e           r = ran
+00029f70: 6765 735b 695d 0a20 2020 2020 2020 2020  ges[i].         
+00029f80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00029f90: 6620 6466 322e 696e 6465 785b 725b 305d  f df2.index[r[0]
+00029fa0: 5d2e 6461 7465 2829 203c 2073 7461 7274  ].date() < start
+00029fb0: 5f6d 696e 3a0a 2020 2020 2020 2020 2020  _min:.          
+00029fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029fd0: 2020 6d73 6720 3d20 6627 7072 6963 652d    msg = f'price-
+00029fe0: 7265 7061 6972 2d73 706c 6974 3a20 5072  repair-split: Pr
+00029ff0: 756e 696e 6720 7b63 7d20 7261 6e67 6520  uning {c} range 
+0002a000: 7b64 6632 2e69 6e64 6578 5b72 5b30 5d5d  {df2.index[r[0]]
+0002a010: 7d2d 3e7b 6466 322e 696e 6465 785b 725b  }->{df2.index[r[
+0002a020: 315d 2d31 5d7d 2062 6563 6175 7365 2074  1]-1]} because t
+0002a030: 6f6f 206f 6c64 2e27 0a20 2020 2020 2020  oo old.'.       
+0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a050: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
+0002a060: 722e 4c6f 6745 7665 6e74 2827 696e 666f  r.LogEvent('info
+0002a070: 272c 2027 7072 6963 652d 7265 7061 6972  ', 'price-repair
+0002a080: 2d73 706c 6974 2d27 2b73 656c 662e 6973  -split-'+self.is
+0002a090: 7472 2c20 6d73 6729 0a20 2020 2020 2020  tr, msg).       
+0002a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0b0: 2020 2020 2064 656c 2072 616e 6765 735b       del ranges[
+0002a0c0: 695d 0a0a 2020 2020 2020 2020 2020 2020  i]..            
+0002a0d0: 2020 2020 6966 206c 656e 2872 616e 6765      if len(range
+0002a0e0: 7329 203e 2030 3a0a 2020 2020 2020 2020  s) > 0:.        
+0002a0f0: 2020 2020 2020 2020 2020 2020 4f48 4c43              OHLC
+0002a100: 5f63 6f72 7265 6374 5f72 616e 6765 735b  _correct_ranges[
+0002a110: 6a5d 203d 2072 616e 6765 730a 0a20 2020  j] = ranges..   
+0002a120: 2020 2020 2020 2020 2063 6f75 6e74 203d           count =
+0002a130: 2073 756d 285b 3120 6966 2078 2069 7320   sum([1 if x is 
+0002a140: 6e6f 7420 4e6f 6e65 2065 6c73 6520 3020  not None else 0 
+0002a150: 666f 7220 7820 696e 204f 484c 435f 636f  for x in OHLC_co
+0002a160: 7272 6563 745f 7261 6e67 6573 5d29 0a20  rrect_ranges]). 
+0002a170: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+0002a180: 756e 7420 3d3d 2030 3a0a 2020 2020 2020  unt == 0:.      
+0002a190: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+0002a1a0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002a1b0: 636f 756e 7420 3d3d 2031 3a0a 2020 2020  count == 1:.    
+0002a1c0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002a1d0: 206f 6e6c 7920 3120 636f 6c75 6d6e 2074   only 1 column t
+0002a1e0: 6865 6e20 6173 7375 6d65 2066 616c 7365  hen assume false
+0002a1f0: 2070 6f73 6974 6976 650a 2020 2020 2020   positive.      
+0002a200: 2020 2020 2020 2020 2020 6964 7873 203d            idxs =
+0002a210: 205b 6920 6966 204f 484c 435f 636f 7272   [i if OHLC_corr
+0002a220: 6563 745f 7261 6e67 6573 5b69 5d20 656c  ect_ranges[i] el
+0002a230: 7365 202d 3120 666f 7220 6920 696e 2072  se -1 for i in r
+0002a240: 616e 6765 286c 656e 284f 484c 4329 295d  ange(len(OHLC))]
+0002a250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a260: 2069 6478 203d 206e 702e 7768 6572 6528   idx = np.where(
+0002a270: 6e70 2e61 7272 6179 2869 6478 7329 2021  np.array(idxs) !
+0002a280: 3d20 2d31 295b 305d 5b30 5d0a 2020 2020  = -1)[0][0].    
+0002a290: 2020 2020 2020 2020 2020 2020 636f 6c20              col 
+0002a2a0: 3d20 4f48 4c43 5b69 6478 5d0a 2020 2020  = OHLC[idx].    
+0002a2b0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0002a2c0: 3d20 6627 7072 6963 652d 7265 7061 6972  = f'price-repair
+0002a2d0: 2d73 706c 6974 3a20 506f 7465 6e74 6961  -split: Potentia
+0002a2e0: 6c20 7b66 6978 5f74 7970 657d 2064 6574  l {fix_type} det
+0002a2f0: 6563 7465 6420 6f6e 6c79 2069 6e20 636f  ected only in co
+0002a300: 6c75 6d6e 207b 636f 6c7d 2c20 736f 2074  lumn {col}, so t
+0002a310: 7265 6174 696e 6720 6173 2066 616c 7365  reating as false
+0002a320: 2070 6f73 6974 6976 6520 2869 676e 6f72   positive (ignor
+0002a330: 6529 270a 2020 2020 2020 2020 2020 2020  e)'.            
+0002a340: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
+0002a350: 2e4c 6f67 4576 656e 7428 2769 6e66 6f27  .LogEvent('info'
+0002a360: 2c20 2770 7269 6365 2d72 6570 6169 722d  , 'price-repair-
+0002a370: 7370 6c69 742d 272b 7365 6c66 2e69 7374  split-'+self.ist
+0002a380: 722c 206d 7367 290a 2020 2020 2020 2020  r, msg).        
+0002a390: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002a3a0: 2020 2020 2020 2020 2020 2320 4f6e 6c79            # Only
+0002a3b0: 2063 6f72 7265 6374 2069 6620 6174 206c   correct if at l
+0002a3c0: 6561 7374 2032 2063 6f6c 756d 6e73 2072  east 2 columns r
+0002a3d0: 6571 7569 7265 2063 6f72 7265 6374 696f  equire correctio
+0002a3e0: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+0002a3f0: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
+0002a400: 6528 6c65 6e28 4f48 4c43 2929 3a0a 2020  e(len(OHLC)):.  
+0002a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a420: 2020 6320 3d20 4f48 4c43 5b6a 5d0a 2020    c = OHLC[j].  
+0002a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a440: 2020 7261 6e67 6573 203d 204f 484c 435f    ranges = OHLC_
+0002a450: 636f 7272 6563 745f 7261 6e67 6573 5b6a  correct_ranges[j
+0002a460: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0002a470: 2020 2020 2020 6966 2072 616e 6765 7320        if ranges 
+0002a480: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4a0: 2072 616e 6765 7320 3d20 5b5d 0a20 2020   ranges = [].   
+0002a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4c0: 2066 6f72 2072 2069 6e20 7261 6e67 6573   for r in ranges
+0002a4d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a4e0: 2020 2020 2020 2020 2020 6966 2072 5b32            if r[2
+0002a4f0: 5d20 3d3d 2027 7370 6c69 7427 3a0a 2020  ] == 'split':.  
+0002a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a510: 2020 2020 2020 2020 2020 6d20 3d20 7370            m = sp
+0002a520: 6c69 7420 3b20 6d5f 7263 7020 3d20 7370  lit ; m_rcp = sp
+0002a530: 6c69 745f 7263 700a 2020 2020 2020 2020  lit_rcp.        
+0002a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a550: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a570: 2020 6d20 3d20 7370 6c69 745f 7263 7020    m = split_rcp 
+0002a580: 3b20 6d5f 7263 7020 3d20 7370 6c69 740a  ; m_rcp = split.
+0002a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0002a5b0: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
+0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5d0: 2020 2020 2020 6d73 6720 3d20 6622 436f        msg = f"Co
+0002a5e0: 7272 6563 7465 6420 6261 6420 7370 6c69  rrected bad spli
+0002a5f0: 7420 6164 6a75 7374 6d65 6e74 206f 6e20  t adjustment on 
+0002a600: 636f 6c3d 7b63 7d20 7261 6e67 653d 5b7b  col={c} range=[{
+0002a610: 6466 322e 696e 6465 785b 725b 305d 5d2e  df2.index[r[0]].
+0002a620: 6461 7465 2829 7d3a 7b64 6632 2e69 6e64  date()}:{df2.ind
+0002a630: 6578 5b72 5b31 5d2d 315d 2e64 6174 6528  ex[r[1]-1].date(
+0002a640: 297d 5d20 6d3d 7b6d 3a2e 3466 7d22 0a20  )}] m={m:.4f}". 
+0002a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a660: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a680: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+0002a690: 2243 6f72 7265 6374 6564 2062 6164 2073  "Corrected bad s
+0002a6a0: 706c 6974 2061 646a 7573 746d 656e 7420  plit adjustment 
+0002a6b0: 6f6e 2063 6f6c 3d7b 637d 2072 616e 6765  on col={c} range
+0002a6c0: 3d5b 7b64 6632 2e69 6e64 6578 5b72 5b30  =[{df2.index[r[0
+0002a6d0: 5d5d 7d3a 7b64 6632 2e69 6e64 6578 5b72  ]]}:{df2.index[r
+0002a6e0: 5b31 5d2d 315d 7d5d 206d 3d7b 6d3a 2e34  [1]-1]}] m={m:.4
+0002a6f0: 667d 220a 2020 2020 2020 2020 2020 2020  f}".            
+0002a700: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002a710: 2e6d 616e 6167 6572 2e4c 6f67 4576 656e  .manager.LogEven
+0002a720: 7428 2769 6e66 6f27 2c20 2770 7269 6365  t('info', 'price
+0002a730: 2d72 6570 6169 722d 7370 6c69 742d 272b  -repair-split-'+
+0002a740: 7365 6c66 2e69 7374 722c 206d 7367 290a  self.istr, msg).
+0002a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a760: 2020 2020 2020 2020 6466 322e 696c 6f63          df2.iloc
+0002a770: 5b72 5b30 5d3a 725b 315d 2c20 6466 322e  [r[0]:r[1], df2.
+0002a780: 636f 6c75 6d6e 732e 6765 745f 6c6f 6328  columns.get_loc(
+0002a790: 6329 5d20 2a3d 206d 0a20 2020 2020 2020  c)] *= m.       
+0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7b0: 2069 6620 636f 7272 6563 745f 766f 6c75   if correct_volu
+0002a7c0: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
 0002a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7e0: 2020 2020 7261 6e67 6573 203d 204f 484c      ranges = OHL
-0002a7f0: 435f 636f 7272 6563 745f 7261 6e67 6573  C_correct_ranges
-0002a800: 5b6a 5d0a 2020 2020 2020 2020 2020 2020  [j].            
-0002a810: 2020 2020 2020 2020 6966 2072 616e 6765          if range
-0002a820: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0002a7e0: 6966 2063 203d 3d20 274f 7065 6e27 3a0a  if c == 'Open':.
+0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a810: 665f 6f70 656e 5f66 6978 6564 5b72 5b30  f_open_fixed[r[0
+0002a820: 5d3a 725b 315d 5d20 3d20 5472 7565 0a20  ]:r[1]] = True. 
 0002a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a840: 2020 2072 616e 6765 7320 3d20 5b5d 0a20     ranges = []. 
-0002a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a860: 2020 2066 6f72 2072 2069 6e20 7261 6e67     for r in rang
-0002a870: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002a880: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0002a890: 5b32 5d20 3d3d 2027 7370 6c69 7427 3a0a  [2] == 'split':.
+0002a840: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002a850: 6320 3d3d 2027 436c 6f73 6527 3a0a 2020  c == 'Close':.  
+0002a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a870: 2020 2020 2020 2020 2020 2020 2020 665f                f_
+0002a880: 636c 6f73 655f 6669 7865 645b 725b 305d  close_fixed[r[0]
+0002a890: 3a72 5b31 5d5d 203d 2054 7275 650a 2020  :r[1]] = True.  
 0002a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8b0: 2020 2020 2020 2020 2020 2020 6d20 3d20              m = 
-0002a8c0: 7370 6c69 7420 3b20 6d5f 7263 7020 3d20  split ; m_rcp = 
-0002a8d0: 7370 6c69 745f 7263 700a 2020 2020 2020  split_rcp.      
-0002a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a910: 2020 2020 6d20 3d20 7370 6c69 745f 7263      m = split_rc
-0002a920: 7020 3b20 6d5f 7263 7020 3d20 7370 6c69  p ; m_rcp = spli
-0002a930: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0002a940: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0002a950: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
-0002a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a970: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
-0002a980: 436f 7272 6563 7465 6420 6261 6420 7370  Corrected bad sp
-0002a990: 6c69 7420 6164 6a75 7374 6d65 6e74 206f  lit adjustment o
-0002a9a0: 6e20 636f 6c3d 7b63 7d20 7261 6e67 653d  n col={c} range=
-0002a9b0: 5b7b 6466 322e 696e 6465 785b 725b 305d  [{df2.index[r[0]
-0002a9c0: 5d2e 6461 7465 2829 7d3a 7b64 6632 2e69  ].date()}:{df2.i
-0002a9d0: 6e64 6578 5b72 5b31 5d2d 315d 2e64 6174  ndex[r[1]-1].dat
-0002a9e0: 6528 297d 5d20 6d3d 7b6d 3a2e 3466 7d22  e()}] m={m:.4f}"
-0002a9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002aa00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0002aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa20: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0002aa30: 2066 2243 6f72 7265 6374 6564 2062 6164   f"Corrected bad
-0002aa40: 2073 706c 6974 2061 646a 7573 746d 656e   split adjustmen
-0002aa50: 7420 6f6e 2063 6f6c 3d7b 637d 2072 616e  t on col={c} ran
-0002aa60: 6765 3d5b 7b64 6632 2e69 6e64 6578 5b72  ge=[{df2.index[r
-0002aa70: 5b30 5d5d 7d3a 7b64 6632 2e69 6e64 6578  [0]]}:{df2.index
-0002aa80: 5b72 5b31 5d2d 315d 7d5d 206d 3d7b 6d3a  [r[1]-1]}] m={m:
-0002aa90: 2e34 667d 220a 2020 2020 2020 2020 2020  .4f}".          
-0002aaa0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0002aab0: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-0002aac0: 656e 7428 2769 6e66 6f27 2c20 2770 7269  ent('info', 'pri
-0002aad0: 6365 2d72 6570 6169 722d 7370 6c69 742d  ce-repair-split-
-0002aae0: 272b 7365 6c66 2e69 7374 722c 206d 7367  '+self.istr, msg
-0002aaf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002ab00: 2020 2020 2020 2020 2020 6466 322e 696c            df2.il
-0002ab10: 6f63 5b72 5b30 5d3a 725b 315d 2c20 6466  oc[r[0]:r[1], df
-0002ab20: 322e 636f 6c75 6d6e 732e 6765 745f 6c6f  2.columns.get_lo
-0002ab30: 6328 6329 5d20 2a3d 206d 0a20 2020 2020  c(c)] *= m.     
-0002ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab50: 2020 2069 6620 636f 7272 6563 745f 766f     if correct_vo
-0002ab60: 6c75 6d65 3a0a 2020 2020 2020 2020 2020  lume:.          
-0002ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab80: 2020 6966 2063 203d 3d20 274f 7065 6e27    if c == 'Open'
-0002ab90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002abb0: 2020 665f 6f70 656e 5f66 6978 6564 5b72    f_open_fixed[r
-0002abc0: 5b30 5d3a 725b 315d 5d20 3d20 5472 7565  [0]:r[1]] = True
-0002abd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002abe0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0002abf0: 6620 6320 3d3d 2027 436c 6f73 6527 3a0a  f c == 'Close':.
-0002ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac20: 665f 636c 6f73 655f 6669 7865 645b 725b  f_close_fixed[r[
-0002ac30: 305d 3a72 5b31 5d5d 203d 2054 7275 650a  0]:r[1]] = True.
-0002ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac50: 2020 2020 2020 2020 665f 636f 7272 6563          f_correc
-0002ac60: 7465 645b 725b 305d 3a72 5b31 5d5d 203d  ted[r[0]:r[1]] =
-0002ac70: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-0002ac80: 2020 2069 6620 636f 7272 6563 745f 766f     if correct_vo
-0002ac90: 6c75 6d65 3a0a 2020 2020 2020 2020 2020  lume:.          
-0002aca0: 2020 2020 2020 665f 6f70 656e 5f61 6e64        f_open_and
-0002acb0: 5f63 6c6f 7365 645f 6669 7865 6420 3d20  _closed_fixed = 
-0002acc0: 665f 6f70 656e 5f66 6978 6564 2026 2066  f_open_fixed & f
-0002acd0: 5f63 6c6f 7365 5f66 6978 6564 0a20 2020  _close_fixed.   
-0002ace0: 2020 2020 2020 2020 2020 2020 2066 5f6f               f_o
-0002acf0: 7065 6e5f 786f 725f 636c 6f73 6564 5f66  pen_xor_closed_f
-0002ad00: 6978 6564 203d 206e 702e 6c6f 6769 6361  ixed = np.logica
-0002ad10: 6c5f 786f 7228 665f 6f70 656e 5f66 6978  l_xor(f_open_fix
-0002ad20: 6564 2c20 665f 636c 6f73 655f 6669 7865  ed, f_close_fixe
-0002ad30: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0002ad40: 2020 2069 6620 665f 6f70 656e 5f61 6e64     if f_open_and
-0002ad50: 5f63 6c6f 7365 645f 6669 7865 642e 616e  _closed_fixed.an
-0002ad60: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-0002ad70: 2020 2020 2020 2020 2064 6632 2e6c 6f63           df2.loc
-0002ad80: 5b66 5f6f 7065 6e5f 616e 645f 636c 6f73  [f_open_and_clos
-0002ad90: 6564 5f66 6978 6564 2c20 2256 6f6c 756d  ed_fixed, "Volum
-0002ada0: 6522 5d20 2a3d 206d 5f72 6370 0a20 2020  e"] *= m_rcp.   
-0002adb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002adc0: 665f 6f70 656e 5f78 6f72 5f63 6c6f 7365  f_open_xor_close
-0002add0: 645f 6669 7865 642e 616e 7928 293a 0a20  d_fixed.any():. 
-0002ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002adf0: 2020 2064 6632 2e6c 6f63 5b66 5f6f 7065     df2.loc[f_ope
-0002ae00: 6e5f 786f 725f 636c 6f73 6564 5f66 6978  n_xor_closed_fix
-0002ae10: 6564 2c20 2256 6f6c 756d 6522 5d20 2a3d  ed, "Volume"] *=
-0002ae20: 2030 2e35 202a 206d 5f72 6370 0a0a 2020   0.5 * m_rcp..  
-0002ae30: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
-0002ae40: 635b 665f 636f 7272 6563 7465 642c 2027  c[f_corrected, '
-0002ae50: 5265 7061 6972 6564 3f27 5d20 3d20 5472  Repaired?'] = Tr
-0002ae60: 7565 0a0a 2020 2020 2020 2020 656c 7365  ue..        else
-0002ae70: 3a0a 2020 2020 2020 2020 2020 2020 6964  :.            id
-0002ae80: 785f 6669 7273 745f 6620 3d20 6e70 2e77  x_first_f = np.w
-0002ae90: 6865 7265 2866 295b 305d 5b30 5d0a 2020  here(f)[0][0].  
-0002aea0: 2020 2020 2020 2020 2020 6966 2061 7070            if app
-0002aeb0: 6561 7273 5f73 7573 7065 6e64 6564 2061  ears_suspended a
-0002aec0: 6e64 2028 6964 785f 6c61 7465 7374 5f61  nd (idx_latest_a
-0002aed0: 6374 6976 6520 6973 206e 6f74 204e 6f6e  ctive is not Non
-0002aee0: 6520 616e 6420 6964 785f 6c61 7465 7374  e and idx_latest
-0002aef0: 5f61 6374 6976 6520 3e3d 2069 6478 5f66  _active >= idx_f
-0002af00: 6972 7374 5f66 293a 0a20 2020 2020 2020  irst_f):.       
-0002af10: 2020 2020 2020 2020 2023 2053 7573 7065           # Suspe
-0002af20: 6e64 6564 206d 6964 7761 7920 6475 7269  nded midway duri
-0002af30: 6e67 2064 6174 6120 6461 7465 2072 616e  ng data date ran
-0002af40: 6765 2e0a 2020 2020 2020 2020 2020 2020  ge..            
-0002af50: 2020 2020 2320 313a 2070 726f 6365 7373      # 1: process
-0002af60: 2064 6174 6120 6265 666f 7265 2073 7573   data before sus
-0002af70: 7065 6e73 696f 6e20 696e 2069 6e64 6578  pension in index
-0002af80: 2d61 7363 656e 6469 6e67 2028 6461 7465  -ascending (date
-0002af90: 2d64 6573 6365 6e64 696e 6729 206f 7264  -descending) ord
-0002afa0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-0002afb0: 2020 2020 2320 323a 2070 726f 6365 7373      # 2: process
-0002afc0: 2064 6174 6120 6166 7465 7220 7375 7370   data after susp
-0002afd0: 656e 7369 6f6e 2069 6e20 696e 6465 782d  ension in index-
-0002afe0: 6465 7363 656e 6469 6e67 206f 7264 6572  descending order
-0002aff0: 2e20 5265 7175 6972 6573 2073 6967 6e61  . Requires signa
-0002b000: 6c73 2074 6f20 6265 2072 6576 6572 7365  ls to be reverse
-0002b010: 642c 200a 2020 2020 2020 2020 2020 2020  d, .            
-0002b020: 2020 2020 2320 2020 2074 6865 6e20 7265      #    then re
-0002b030: 7475 726e 6564 2072 616e 6765 7320 746f  turned ranges to
-0002b040: 2061 6c73 6f20 6265 2072 6576 6572 7365   also be reverse
-0002b050: 642c 2062 6563 6175 7365 2074 6869 7320  d, because this 
-0002b060: 6c6f 6769 6320 7761 7320 6f72 6967 696e  logic was origin
-0002b070: 616c 6c79 2077 7269 7474 656e 2066 6f72  ally written for
-0002b080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b090: 2023 2020 2020 696e 6465 782d 6173 6365   #    index-asce
-0002b0a0: 6e64 696e 6720 2864 6174 652d 6465 7363  nding (date-desc
-0002b0b0: 656e 6469 6e67 2920 6f72 6465 722e 0a20  ending) order.. 
-0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002b0d0: 616e 6765 735f 6265 666f 7265 203d 206d  anges_before = m
-0002b0e0: 6170 5f73 6967 6e61 6c73 5f74 6f5f 7261  ap_signals_to_ra
-0002b0f0: 6e67 6573 2866 5b69 6478 5f6c 6174 6573  nges(f[idx_lates
-0002b100: 745f 6163 7469 7665 3a5d 2c20 665f 7570  t_active:], f_up
-0002b110: 5b69 6478 5f6c 6174 6573 745f 6163 7469  [idx_latest_acti
-0002b120: 7665 3a5d 2c20 665f 646f 776e 5b69 6478  ve:], f_down[idx
-0002b130: 5f6c 6174 6573 745f 6163 7469 7665 3a5d  _latest_active:]
-0002b140: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002b150: 2020 6966 206c 656e 2872 616e 6765 735f    if len(ranges_
-0002b160: 6265 666f 7265 2920 3e20 303a 0a20 2020  before) > 0:.   
-0002b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b180: 2023 2053 6869 6674 2065 6163 6820 7261   # Shift each ra
-0002b190: 6e67 6520 6261 636b 2074 6f20 676c 6f62  nge back to glob
-0002b1a0: 616c 2069 6e64 6578 696e 670a 2020 2020  al indexing.    
-0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1c0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-0002b1d0: 656e 2872 616e 6765 735f 6265 666f 7265  en(ranges_before
-0002b1e0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002b1f0: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-0002b200: 7261 6e67 6573 5f62 6566 6f72 655b 695d  ranges_before[i]
-0002b210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b220: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
-0002b230: 6265 666f 7265 5b69 5d20 3d20 2872 5b30  before[i] = (r[0
-0002b240: 5d20 2b20 6964 785f 6c61 7465 7374 5f61  ] + idx_latest_a
-0002b250: 6374 6976 652c 2072 5b31 5d20 2b20 6964  ctive, r[1] + id
-0002b260: 785f 6c61 7465 7374 5f61 6374 6976 652c  x_latest_active,
-0002b270: 2072 5b32 5d29 0a20 2020 2020 2020 2020   r[2]).         
-0002b280: 2020 2020 2020 2066 5f72 6576 5f64 6f77         f_rev_dow
-0002b290: 6e20 3d20 6e70 2e66 6c69 7028 6e70 2e72  n = np.flip(np.r
-0002b2a0: 6f6c 6c28 665f 7570 2c20 2d31 2929 0a20  oll(f_up, -1)). 
-0002b2b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002b2c0: 5f72 6576 5f75 7020 3d20 6e70 2e66 6c69  _rev_up = np.fli
-0002b2d0: 7028 6e70 2e72 6f6c 6c28 665f 646f 776e  p(np.roll(f_down
-0002b2e0: 2c20 2d31 2929 0a20 2020 2020 2020 2020  , -1)).         
-0002b2f0: 2020 2020 2020 2066 5f72 6576 203d 2066         f_rev = f
-0002b300: 5f72 6576 5f75 7020 7c20 665f 7265 765f  _rev_up | f_rev_
-0002b310: 646f 776e 0a20 2020 2020 2020 2020 2020  down.           
-0002b320: 2020 2020 2072 616e 6765 735f 6166 7465       ranges_afte
-0002b330: 7220 3d20 6d61 705f 7369 676e 616c 735f  r = map_signals_
-0002b340: 746f 5f72 616e 6765 7328 665f 7265 765b  to_ranges(f_rev[
-0002b350: 6964 785f 7265 765f 6c61 7465 7374 5f61  idx_rev_latest_a
-0002b360: 6374 6976 653a 5d2c 2066 5f72 6576 5f75  ctive:], f_rev_u
-0002b370: 705b 6964 785f 7265 765f 6c61 7465 7374  p[idx_rev_latest
-0002b380: 5f61 6374 6976 653a 5d2c 2066 5f72 6576  _active:], f_rev
-0002b390: 5f64 6f77 6e5b 6964 785f 7265 765f 6c61  _down[idx_rev_la
-0002b3a0: 7465 7374 5f61 6374 6976 653a 5d29 0a20  test_active:]). 
-0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002b3c0: 6620 6c65 6e28 7261 6e67 6573 5f61 6674  f len(ranges_aft
-0002b3d0: 6572 2920 3e20 303a 0a20 2020 2020 2020  er) > 0:.       
-0002b3e0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-0002b3f0: 6869 6674 2065 6163 6820 7261 6e67 6520  hift each range 
-0002b400: 6261 636b 2074 6f20 676c 6f62 616c 2069  back to global i
-0002b410: 6e64 6578 696e 673a 0a20 2020 2020 2020  ndexing:.       
-0002b420: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002b430: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-0002b440: 7261 6e67 6573 5f61 6674 6572 2929 3a0a  ranges_after)):.
-0002b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b460: 2020 2020 2020 2020 7220 3d20 7261 6e67          r = rang
-0002b470: 6573 5f61 6674 6572 5b69 5d0a 2020 2020  es_after[i].    
-0002b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b490: 2020 2020 7261 6e67 6573 5f61 6674 6572      ranges_after
-0002b4a0: 5b69 5d20 3d20 2872 5b30 5d20 2b20 6964  [i] = (r[0] + id
-0002b4b0: 785f 7265 765f 6c61 7465 7374 5f61 6374  x_rev_latest_act
-0002b4c0: 6976 652c 2072 5b31 5d20 2b20 6964 785f  ive, r[1] + idx_
-0002b4d0: 7265 765f 6c61 7465 7374 5f61 6374 6976  rev_latest_activ
-0002b4e0: 652c 2072 5b32 5d29 0a20 2020 2020 2020  e, r[2]).       
-0002b4f0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-0002b500: 6c69 7020 7261 6e67 6520 746f 206e 6f72  lip range to nor
-0002b510: 6d61 6c20 6f72 6465 7269 6e67 0a20 2020  mal ordering.   
-0002b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b530: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0002b540: 6c65 6e28 7261 6e67 6573 5f61 6674 6572  len(ranges_after
-0002b550: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002b560: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
-0002b570: 7261 6e67 6573 5f61 6674 6572 5b69 5d0a  ranges_after[i].
-0002b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b590: 2020 2020 2020 2020 7261 6e67 6573 5f61          ranges_a
-0002b5a0: 6674 6572 5b69 5d20 3d20 286e 2d72 5b31  fter[i] = (n-r[1
-0002b5b0: 5d2c 206e 2d72 5b30 5d2c 2072 5b32 5d29  ], n-r[0], r[2])
-0002b5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b5d0: 2072 616e 6765 7320 3d20 7261 6e67 6573   ranges = ranges
-0002b5e0: 5f62 6566 6f72 6520 3b20 7261 6e67 6573  _before ; ranges
-0002b5f0: 2e65 7874 656e 6428 7261 6e67 6573 5f61  .extend(ranges_a
-0002b600: 6674 6572 290a 2020 2020 2020 2020 2020  fter).          
-0002b610: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002b620: 2020 2020 2020 2020 7261 6e67 6573 203d          ranges =
-0002b630: 206d 6170 5f73 6967 6e61 6c73 5f74 6f5f   map_signals_to_
-0002b640: 7261 6e67 6573 2866 2c20 665f 7570 2c20  ranges(f, f_up, 
-0002b650: 665f 646f 776e 290a 2020 2020 2020 2020  f_down).        
-0002b660: 2020 2020 6966 2073 7461 7274 5f6d 696e      if start_min
-0002b670: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0002b680: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002b690: 5072 756e 6520 7261 6e67 6573 2074 6861  Prune ranges tha
-0002b6a0: 7420 6172 6520 6f6c 6465 7220 7468 616e  t are older than
-0002b6b0: 2073 7461 7274 5f6d 696e 0a20 2020 2020   start_min.     
-0002b6c0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0002b6d0: 2069 6e20 7261 6e67 6528 6c65 6e28 7261   in range(len(ra
-0002b6e0: 6e67 6573 292d 312c 202d 312c 202d 3129  nges)-1, -1, -1)
-0002b6f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b700: 2020 2020 2020 7220 3d20 7261 6e67 6573        r = ranges
-0002b710: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
-0002b720: 2020 2020 2020 2020 6966 2064 662e 696e          if df.in
-0002b730: 6465 785b 725b 305d 5d2e 6461 7465 2829  dex[r[0]].date()
-0002b740: 203c 2073 7461 7274 5f6d 696e 3a0a 2020   < start_min:.  
-0002b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b760: 2020 2020 2020 6d73 6720 3d20 6627 7072        msg = f'pr
-0002b770: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
-0002b780: 3a20 5072 756e 696e 6720 7261 6e67 6520  : Pruning range 
-0002b790: 7b64 662e 696e 6465 785b 725b 305d 5d7d  {df.index[r[0]]}
-0002b7a0: 2d3e 7b64 662e 696e 6465 785b 725b 315d  ->{df.index[r[1]
-0002b7b0: 2d31 5d7d 2062 6563 6175 7365 2074 6f6f  -1]} because too
-0002b7c0: 206f 6c64 2e27 0a20 2020 2020 2020 2020   old.'.         
-0002b7d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002b7e0: 656c 662e 6d61 6e61 6765 722e 4c6f 6745  elf.manager.LogE
-0002b7f0: 7665 6e74 2827 6465 6275 6727 2c20 2770  vent('debug', 'p
-0002b800: 7269 6365 2d72 6570 6169 722d 7370 6c69  rice-repair-spli
-0002b810: 742d 272b 7365 6c66 2e69 7374 722c 206d  t-'+self.istr, m
-0002b820: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-0002b830: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-0002b840: 7261 6e67 6573 5b69 5d0a 2020 2020 2020  ranges[i].      
-0002b850: 2020 2020 2020 666f 7220 7220 696e 2072        for r in r
-0002b860: 616e 6765 733a 0a20 2020 2020 2020 2020  anges:.         
-0002b870: 2020 2020 2020 2069 6620 725b 325d 203d         if r[2] =
-0002b880: 3d20 2773 706c 6974 273a 0a20 2020 2020  = 'split':.     
-0002b890: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002b8a0: 203d 2073 706c 6974 203b 206d 5f72 6370   = split ; m_rcp
-0002b8b0: 203d 2073 706c 6974 5f72 6370 0a20 2020   = split_rcp.   
-0002b8c0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002b8d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002b8e0: 2020 2020 2020 206d 203d 2073 706c 6974         m = split
-0002b8f0: 5f72 6370 203b 206d 5f72 6370 203d 2073  _rcp ; m_rcp = s
-0002b900: 706c 6974 0a20 2020 2020 2020 2020 2020  plit.           
-0002b910: 2020 2020 206d 7367 203d 2066 2270 7269       msg = f"pri
-0002b920: 6365 2d72 6570 6169 722d 7370 6c69 743a  ce-repair-split:
-0002b930: 2072 616e 6765 3d7b 727d 206d 3d7b 6d7d   range={r} m={m}
-0002b940: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002b950: 2020 7365 6c66 2e6d 616e 6167 6572 2e4c    self.manager.L
-0002b960: 6f67 4576 656e 7428 2764 6562 7567 272c  ogEvent('debug',
-0002b970: 2027 7072 6963 652d 7265 7061 6972 2d73   'price-repair-s
-0002b980: 706c 6974 2d27 2b73 656c 662e 6973 7472  plit-'+self.istr
-0002b990: 2c20 6d73 6729 0a20 2020 2020 2020 2020  , msg).         
-0002b9a0: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
-0002b9b0: 5b27 4f70 656e 272c 2027 4869 6768 272c  ['Open', 'High',
-0002b9c0: 2027 4c6f 7727 2c20 2743 6c6f 7365 275d   'Low', 'Close']
-0002b9d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b9e0: 2020 2020 2020 6466 322e 696c 6f63 5b72        df2.iloc[r
-0002b9f0: 5b30 5d3a 725b 315d 2c20 6466 322e 636f  [0]:r[1], df2.co
-0002ba00: 6c75 6d6e 732e 6765 745f 6c6f 6328 6329  lumns.get_loc(c)
-0002ba10: 5d20 2a3d 206d 0a20 2020 2020 2020 2020  ] *= m.         
-0002ba20: 2020 2020 2020 2069 6620 636f 7272 6563         if correc
-0002ba30: 745f 766f 6c75 6d65 3a0a 2020 2020 2020  t_volume:.      
-0002ba40: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0002ba50: 322e 696c 6f63 5b72 5b30 5d3a 725b 315d  2.iloc[r[0]:r[1]
-0002ba60: 2c20 6466 322e 636f 6c75 6d6e 732e 6765  , df2.columns.ge
-0002ba70: 745f 6c6f 6328 2256 6f6c 756d 6522 295d  t_loc("Volume")]
-0002ba80: 202a 3d20 6d5f 7263 700a 2020 2020 2020   *= m_rcp.      
-0002ba90: 2020 2020 2020 2020 2020 6466 322e 696c            df2.il
-0002baa0: 6f63 5b72 5b30 5d3a 725b 315d 2c20 6466  oc[r[0]:r[1], df
-0002bab0: 322e 636f 6c75 6d6e 732e 6765 745f 6c6f  2.columns.get_lo
-0002bac0: 6328 2752 6570 6169 7265 643f 2729 5d20  c('Repaired?')] 
-0002bad0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0002bae0: 2020 2020 2020 2069 6620 725b 305d 203d         if r[0] =
-0002baf0: 3d20 725b 315d 202d 2031 3a0a 2020 2020  = r[1] - 1:.    
-0002bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb10: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
-0002bb20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002bb30: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-0002bb40: 6622 436f 7272 6563 7465 6420 6261 6420  f"Corrected bad 
-0002bb50: 7370 6c69 7420 6164 6a75 7374 6d65 6e74  split adjustment
-0002bb60: 206f 6e20 696e 7465 7276 616c 207b 6466   on interval {df
-0002bb70: 322e 696e 6465 785b 725b 305d 5d2e 6461  2.index[r[0]].da
-0002bb80: 7465 2829 7d20 6d3d 7b6d 3a2e 3466 7d22  te()} m={m:.4f}"
-0002bb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bba0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbc0: 2020 206d 7367 203d 2066 2243 6f72 7265     msg = f"Corre
-0002bbd0: 6374 6564 2062 6164 2073 706c 6974 2061  cted bad split a
-0002bbe0: 646a 7573 746d 656e 7420 6f6e 2069 6e74  djustment on int
-0002bbf0: 6572 7661 6c20 7b64 6632 2e69 6e64 6578  erval {df2.index
-0002bc00: 5b72 5b30 5d5d 7d20 6d3d 7b6d 3a2e 3466  [r[0]]} m={m:.4f
-0002bc10: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-0002bc20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002bc30: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0002bc40: 6f74 653a 2064 6632 2073 6f72 7465 6420  ote: df2 sorted 
-0002bc50: 7769 7468 2069 6e64 6578 2064 6573 6365  with index desce
-0002bc60: 6e64 696e 670a 2020 2020 2020 2020 2020  nding.          
-0002bc70: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-0002bc80: 3d20 6466 322e 696e 6465 785b 725b 315d  = df2.index[r[1]
-0002bc90: 202d 2031 5d0a 2020 2020 2020 2020 2020   - 1].          
-0002bca0: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
-0002bcb0: 6466 322e 696e 6465 785b 725b 305d 5d0a  df2.index[r[0]].
-0002bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bcd0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-0002bce0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
-0002bcf0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-0002bd00: 6720 3d20 6622 436f 7272 6563 7465 6420  g = f"Corrected 
-0002bd10: 6261 6420 7370 6c69 7420 6164 6a75 7374  bad split adjust
-0002bd20: 6d65 6e74 2061 6372 6f73 7320 696e 7465  ment across inte
-0002bd30: 7276 616c 7320 7b73 7461 7274 2e64 6174  rvals {start.dat
-0002bd40: 6528 297d 202d 3e20 7b65 6e64 2e64 6174  e()} -> {end.dat
-0002bd50: 6528 297d 2028 696e 636c 7573 6976 6529  e()} (inclusive)
-0002bd60: 206d 3d7b 6d3a 2e34 667d 220a 2020 2020   m={m:.4f}".    
-0002bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002bd90: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-0002bda0: 6720 3d20 6622 436f 7272 6563 7465 6420  g = f"Corrected 
-0002bdb0: 6261 6420 7370 6c69 7420 6164 6a75 7374  bad split adjust
-0002bdc0: 6d65 6e74 2061 6372 6f73 7320 696e 7465  ment across inte
-0002bdd0: 7276 616c 7320 7b73 7461 7274 7d20 2d3e  rvals {start} ->
-0002bde0: 207b 656e 647d 2028 696e 636c 7573 6976   {end} (inclusiv
-0002bdf0: 6529 206d 3d7b 6d3a 2e34 667d 220a 2020  e) m={m:.4f}".  
-0002be00: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0002be10: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-0002be20: 656e 7428 2769 6e66 6f27 2c20 2770 7269  ent('info', 'pri
-0002be30: 6365 2d72 6570 6169 722d 7370 6c69 742d  ce-repair-split-
-0002be40: 272b 7365 6c66 2e69 7374 722c 206d 7367  '+self.istr, msg
-0002be50: 290a 0a20 2020 2020 2020 2069 6620 636f  )..        if co
-0002be60: 7272 6563 745f 766f 6c75 6d65 3a0a 2020  rrect_volume:.  
-0002be70: 2020 2020 2020 2020 2020 6466 325b 2756            df2['V
-0002be80: 6f6c 756d 6527 5d20 3d20 6466 325b 2756  olume'] = df2['V
-0002be90: 6f6c 756d 6527 5d2e 726f 756e 6428 3029  olume'].round(0)
-0002bea0: 2e61 7374 7970 6528 2769 6e74 2729 0a0a  .astype('int')..
-0002beb0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-0002bec0: 6365 4578 6974 286c 6f67 5f66 756e 6320  ceExit(log_func 
-0002bed0: 2b20 2220 7265 7475 726e 696e 6722 290a  + " returning").
-0002bee0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-0002bef0: 6632 2e73 6f72 745f 696e 6465 7828 290a  f2.sort_index().
-0002bf00: 0a20 2020 2064 6566 205f 7265 7061 6972  .    def _repair
-0002bf10: 5a65 726f 5072 6963 6573 2873 656c 662c  ZeroPrices(self,
-0002bf20: 2064 662c 2073 696c 656e 743d 4661 6c73   df, silent=Fals
-0002bf30: 6529 3a0a 2020 2020 2020 2020 7966 6375  e):.        yfcu
-0002bf40: 2e54 7970 6543 6865 636b 4461 7461 4672  .TypeCheckDataFr
-0002bf50: 616d 6528 6466 2c20 2264 6622 290a 0a20  ame(df, "df").. 
-0002bf60: 2020 2020 2020 2023 2053 6f6d 6574 696d         # Sometim
-0002bf70: 6573 2059 6168 6f6f 2072 6574 7572 6e73  es Yahoo returns
-0002bf80: 2070 7269 6365 733d 3020 7768 656e 206f   prices=0 when o
-0002bf90: 6276 696f 7573 6c79 2077 726f 6e67 2065  bviously wrong e
-0002bfa0: 2e67 2e20 566f 6c75 6d65 203e 2030 2061  .g. Volume > 0 a
-0002bfb0: 6e64 2043 6c6f 7365 203e 2030 2e0a 2020  nd Close > 0..  
-0002bfc0: 2020 2020 2020 2320 4561 7379 2074 6f20        # Easy to 
-0002bfd0: 6465 7465 6374 2061 6e64 2066 6978 0a0a  detect and fix..
-0002bfe0: 2020 2020 2020 2020 6966 2064 662e 656d          if df.em
-0002bff0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-0002c000: 2072 6574 7572 6e20 6466 0a20 2020 2020   return df.     
-0002c010: 2020 2069 6620 6466 2e73 6861 7065 5b30     if df.shape[0
-0002c020: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
-0002c030: 2020 2020 2320 4e65 6564 206d 756c 7469      # Need multi
-0002c040: 706c 6520 726f 7773 2074 6f20 636f 6e66  ple rows to conf
-0002c050: 6964 656e 746c 7920 6964 656e 7469 6679  idently identify
-0002c060: 206f 7574 6c69 6572 730a 2020 2020 2020   outliers.      
-0002c070: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
-0002c080: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
-0002c090: 5f65 6e74 6572 203d 2066 2250 4d3a 3a5f  _enter = f"PM::_
-0002c0a0: 7265 7061 6972 5a65 726f 5072 6963 6573  repairZeroPrices
-0002c0b0: 2d7b 7365 6c66 2e69 7374 727d 2864 6174  -{self.istr}(dat
-0002c0c0: 655f 7261 6e67 653d 7b64 662e 696e 6465  e_range={df.inde
-0002c0d0: 785b 305d 7d2d 3e7b 6466 2e69 6e64 6578  x[0]}->{df.index
-0002c0e0: 5b2d 315d 2b73 656c 662e 6974 647d 2922  [-1]+self.itd})"
-0002c0f0: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
-0002c100: 5f65 7869 7420 3d20 6622 504d 3a3a 5f72  _exit = f"PM::_r
-0002c110: 6570 6169 725a 6572 6f50 7269 6365 732d  epairZeroPrices-
-0002c120: 7b73 656c 662e 6973 7472 7d28 2920 7265  {self.istr}() re
-0002c130: 7475 726e 696e 6722 0a20 2020 2020 2020  turning".       
-0002c140: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
-0002c150: 286c 6f67 5f6d 7367 5f65 6e74 6572 290a  (log_msg_enter).
-0002c160: 0a20 2020 2020 2020 2064 6632 203d 2064  .        df2 = d
-0002c170: 662e 636f 7079 2829 0a0a 2020 2020 2020  f.copy()..      
-0002c180: 2020 7072 6963 655f 636f 6c73 203d 205b    price_cols = [
-0002c190: 6320 666f 7220 6320 696e 205b 224f 7065  c for c in ["Ope
-0002c1a0: 6e22 2c20 2248 6967 6822 2c20 224c 6f77  n", "High", "Low
-0002c1b0: 222c 2022 436c 6f73 6522 2c20 2241 646a  ", "Close", "Adj
-0002c1c0: 2043 6c6f 7365 225d 2069 6620 6320 696e   Close"] if c in
-0002c1d0: 2064 6632 2e63 6f6c 756d 6e73 5d0a 2020   df2.columns].  
-0002c1e0: 2020 2020 2020 665f 7a65 726f 5f6f 725f        f_zero_or_
-0002c1f0: 6e61 6e20 3d20 2864 6632 5b70 7269 6365  nan = (df2[price
-0002c200: 5f63 6f6c 735d 203d 3d20 302e 3029 2e74  _cols] == 0.0).t
-0002c210: 6f5f 6e75 6d70 7928 2920 7c20 6466 325b  o_numpy() | df2[
-0002c220: 7072 6963 655f 636f 6c73 5d2e 6973 6e61  price_cols].isna
-0002c230: 2829 2e74 6f5f 6e75 6d70 7928 290a 2020  ().to_numpy().  
-0002c240: 2020 2020 2020 2320 4368 6563 6b20 7768        # Check wh
-0002c250: 6574 6865 7220 776f 7274 6820 6174 7465  ether worth atte
-0002c260: 6d70 7469 6e67 2072 6570 6169 720a 2020  mpting repair.  
-0002c270: 2020 2020 2020 6966 2066 5f7a 6572 6f5f        if f_zero_
-0002c280: 6f72 5f6e 616e 2e61 6e79 2861 7869 733d  or_nan.any(axis=
-0002c290: 3129 2e73 756d 2829 203d 3d20 303a 0a20  1).sum() == 0:. 
-0002c2a0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
-0002c2b0: 5472 6163 6545 7869 7428 6c6f 675f 6d73  TraceExit(log_ms
-0002c2c0: 675f 6578 6974 202b 2022 2028 6e6f 2062  g_exit + " (no b
-0002c2d0: 6164 2064 6174 6129 2229 0a20 2020 2020  ad data)").     
-0002c2e0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-0002c2f0: 0a20 2020 2020 2020 2069 6620 665f 7a65  .        if f_ze
-0002c300: 726f 5f6f 725f 6e61 6e2e 7375 6d28 2920  ro_or_nan.sum() 
-0002c310: 3d3d 206c 656e 2870 7269 6365 5f63 6f6c  == len(price_col
-0002c320: 7329 2a6c 656e 2864 6632 293a 0a20 2020  s)*len(df2):.   
-0002c330: 2020 2020 2020 2020 2023 204e 6565 6420           # Need 
-0002c340: 736f 6d65 2067 6f6f 6420 6461 7461 2074  some good data t
-0002c350: 6f20 6361 6c69 6272 6174 650a 2020 2020  o calibrate.    
-0002c360: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-0002c370: 6365 4578 6974 286c 6f67 5f6d 7367 5f65  ceExit(log_msg_e
-0002c380: 7869 7420 2b20 2220 2869 6e73 7566 6669  xit + " (insuffi
-0002c390: 6369 656e 7420 6361 6c69 6272 6174 696f  cient calibratio
-0002c3a0: 6e20 6461 7461 2922 290a 2020 2020 2020  n data)").      
-0002c3b0: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
-0002c3c0: 2020 2020 2020 2020 2320 2d20 6176 6f69          # - avoi
-0002c3d0: 6420 7265 7061 6972 2069 6620 6d61 6e79  d repair if many
-0002c3e0: 207a 6572 6f65 732f 4e61 4e73 0a20 2020   zeroes/NaNs.   
-0002c3f0: 2020 2020 2070 6374 5f7a 6572 6f5f 6f72       pct_zero_or
-0002c400: 5f6e 616e 203d 2066 5f7a 6572 6f5f 6f72  _nan = f_zero_or
-0002c410: 5f6e 616e 2e73 756d 2829 202f 2028 6c65  _nan.sum() / (le
-0002c420: 6e28 7072 6963 655f 636f 6c73 292a 6c65  n(price_cols)*le
-0002c430: 6e28 6466 3229 290a 2020 2020 2020 2020  n(df2)).        
-0002c440: 6966 2066 5f7a 6572 6f5f 6f72 5f6e 616e  if f_zero_or_nan
-0002c450: 2e61 6e79 2861 7869 733d 3129 2e73 756d  .any(axis=1).sum
-0002c460: 2829 203e 2032 2061 6e64 2070 6374 5f7a  () > 2 and pct_z
-0002c470: 6572 6f5f 6f72 5f6e 616e 203e 2030 2e30  ero_or_nan > 0.0
-0002c480: 353a 0a20 2020 2020 2020 2020 2020 2079  5:.            y
-0002c490: 6663 6c2e 5472 6163 6545 7869 7428 6c6f  fcl.TraceExit(lo
-0002c4a0: 675f 6d73 675f 6578 6974 202b 2022 2028  g_msg_exit + " (
-0002c4b0: 746f 6f20 6d75 6368 2062 6164 2064 6174  too much bad dat
-0002c4c0: 6129 2229 0a20 2020 2020 2020 2020 2020  a)").           
-0002c4d0: 2072 6574 7572 6e20 6466 0a0a 2020 2020   return df..    
-0002c4e0: 2020 2020 6461 7461 5f63 6f6c 7320 3d20      data_cols = 
-0002c4f0: 7072 6963 655f 636f 6c73 202b 205b 2256  price_cols + ["V
-0002c500: 6f6c 756d 6522 5d0a 0a20 2020 2020 2020  olume"]..       
-0002c510: 2023 204d 6172 6b20 7661 6c75 6573 2074   # Mark values t
-0002c520: 6f20 7365 6e64 2066 6f72 2072 6570 6169  o send for repai
-0002c530: 720a 2020 2020 2020 2020 7461 6720 3d20  r.        tag = 
-0002c540: 2d31 2e30 0a20 2020 2020 2020 2066 6f72  -1.0.        for
-0002c550: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-0002c560: 7072 6963 655f 636f 6c73 2929 3a0a 2020  price_cols)):.  
-0002c570: 2020 2020 2020 2020 2020 6320 3d20 7072            c = pr
-0002c580: 6963 655f 636f 6c73 5b69 5d0a 2020 2020  ice_cols[i].    
-0002c590: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
-0002c5a0: 665f 7a65 726f 5f6f 725f 6e61 6e5b 3a2c  f_zero_or_nan[:,
-0002c5b0: 2069 5d2c 2063 5d20 3d20 7461 670a 2020   i], c] = tag.  
-0002c5c0: 2020 2020 2020 2320 4966 2076 6f6c 756d        # If volum
-0002c5d0: 653d 3020 6f72 204e 614e 2066 6f72 2062  e=0 or NaN for b
-0002c5e0: 6164 2070 7269 6365 732c 2074 6865 6e20  ad prices, then 
-0002c5f0: 7461 6720 766f 6c75 6d65 2066 6f72 2072  tag volume for r
-0002c600: 6570 6169 720a 2020 2020 2020 2020 6466  epair.        df
-0002c610: 322e 6c6f 635b 665f 7a65 726f 5f6f 725f  2.loc[f_zero_or_
-0002c620: 6e61 6e2e 616e 7928 6178 6973 3d31 2920  nan.any(axis=1) 
-0002c630: 2620 2864 6632 5b22 566f 6c75 6d65 225d  & (df2["Volume"]
-0002c640: 203d 3d20 3029 2c20 2256 6f6c 756d 6522   == 0), "Volume"
-0002c650: 5d20 3d20 7461 670a 2020 2020 2020 2020  ] = tag.        
-0002c660: 6466 322e 6c6f 635b 665f 7a65 726f 5f6f  df2.loc[f_zero_o
-0002c670: 725f 6e61 6e2e 616e 7928 6178 6973 3d31  r_nan.any(axis=1
-0002c680: 2920 2620 2864 6632 5b22 566f 6c75 6d65  ) & (df2["Volume
-0002c690: 225d 2e69 736e 6128 2929 2c20 2256 6f6c  "].isna()), "Vol
-0002c6a0: 756d 6522 5d20 3d20 7461 670a 0a20 2020  ume"] = tag..   
-0002c6b0: 2020 2020 2023 2070 7269 6e74 2864 6632       # print(df2
-0002c6c0: 5b66 5f7a 6572 6f5f 6f72 5f6e 616e 2e61  [f_zero_or_nan.a
-0002c6d0: 6e79 2861 7869 733d 3129 5d29 0a20 2020  ny(axis=1)]).   
-0002c6e0: 2020 2020 206e 5f62 6566 6f72 6520 3d20       n_before = 
-0002c6f0: 2864 6632 5b64 6174 615f 636f 6c73 5d2e  (df2[data_cols].
-0002c700: 746f 5f6e 756d 7079 2829 203d 3d20 7461  to_numpy() == ta
-0002c710: 6729 2e73 756d 2829 0a20 2020 2020 2020  g).sum().       
-0002c720: 2023 2070 7269 6e74 2822 6e5f 6265 666f   # print("n_befo
-0002c730: 7265 203d 222c 206e 5f62 6566 6f72 6529  re =", n_before)
-0002c740: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0002c750: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
-0002c760: 7365 6c66 2e5f 7265 636f 6e73 7472 7563  self._reconstruc
-0002c770: 745f 696e 7465 7276 616c 735f 6261 7463  t_intervals_batc
-0002c780: 6828 6466 322c 2074 6167 3d74 6167 290a  h(df2, tag=tag).
-0002c790: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0002c7a0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-0002c7b0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
-0002c7c0: 662e 5f73 7461 636b 5f74 7261 6365 2920  f._stack_trace) 
-0002c7d0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0002c7e0: 2020 2020 2073 656c 662e 5f73 7461 636b       self._stack
-0002c7f0: 5f74 7261 6365 2e70 6f70 286c 656e 2873  _trace.pop(len(s
-0002c800: 656c 662e 5f73 7461 636b 5f74 7261 6365  elf._stack_trace
-0002c810: 2920 2d20 3129 0a20 2020 2020 2020 2020  ) - 1).         
-0002c820: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-0002c830: 206e 5f61 6674 6572 203d 2028 6466 325b   n_after = (df2[
-0002c840: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-0002c850: 6d70 7928 2920 3d3d 2074 6167 292e 7375  mpy() == tag).su
-0002c860: 6d28 290a 2020 2020 2020 2020 6e5f 6669  m().        n_fi
-0002c870: 7865 6420 3d20 6e5f 6265 666f 7265 202d  xed = n_before -
-0002c880: 206e 5f61 6674 6572 0a20 2020 2020 2020   n_after.       
-0002c890: 206d 7367 203d 2066 2246 6978 6564 207b   msg = f"Fixed {
-0002c8a0: 6e5f 6669 7865 647d 2f7b 6e5f 6265 666f  n_fixed}/{n_befo
-0002c8b0: 7265 7d20 7072 6963 653d 302e 3020 6572  re} price=0.0 er
-0002c8c0: 726f 7273 2069 6e20 7b73 656c 662e 6973  rors in {self.is
-0002c8d0: 7472 7d20 7072 6963 6520 6461 7461 220a  tr} price data".
-0002c8e0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0002c8f0: 696c 656e 7420 616e 6420 6e5f 6669 7865  ilent and n_fixe
-0002c900: 6420 3e20 303a 0a20 2020 2020 2020 2020  d > 0:.         
-0002c910: 2020 2070 7269 6e74 2866 227b 7365 6c66     print(f"{self
-0002c920: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-0002c930: 6729 0a20 2020 2020 2020 2065 6c73 653a  g).        else:
-0002c940: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002c950: 662e 6d61 6e61 6765 722e 4c6f 6745 7665  f.manager.LogEve
-0002c960: 6e74 2822 696e 666f 222c 2022 5072 6963  nt("info", "Pric
-0002c970: 654d 616e 6167 6572 222c 206d 7367 290a  eManager", msg).
-0002c980: 0a20 2020 2020 2020 2023 2052 6573 746f  .        # Resto
-0002c990: 7265 206f 7269 6769 6e61 6c20 7661 6c75  re original valu
-0002c9a0: 6573 2077 6865 7265 2072 6570 6169 7220  es where repair 
-0002c9b0: 6661 696c 6564 2028 692e 652e 2072 656d  failed (i.e. rem
-0002c9c0: 6f76 6520 7461 6720 7661 6c75 6573 290a  ove tag values).
-0002c9d0: 2020 2020 2020 2020 6620 3d20 6466 325b          f = df2[
-0002c9e0: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-0002c9f0: 6d70 7928 2920 3d3d 2074 6167 0a20 2020  mpy() == tag.   
-0002ca00: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-0002ca10: 6e67 6528 6c65 6e28 6461 7461 5f63 6f6c  nge(len(data_col
-0002ca20: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-0002ca30: 2066 6a20 3d20 665b 3a2c 206a 5d0a 2020   fj = f[:, j].  
-0002ca40: 2020 2020 2020 2020 2020 6966 2066 6a2e            if fj.
-0002ca50: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-0002ca60: 2020 2020 2020 2063 203d 2064 6174 615f         c = data_
-0002ca70: 636f 6c73 5b6a 5d0a 2020 2020 2020 2020  cols[j].        
-0002ca80: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
-0002ca90: 666a 2c20 635d 203d 2064 662e 6c6f 635b  fj, c] = df.loc[
-0002caa0: 666a 2c20 635d 0a0a 2020 2020 2020 2020  fj, c]..        
-0002cab0: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-0002cac0: 6f67 5f6d 7367 5f65 7869 7429 0a0a 2020  og_msg_exit)..  
-0002cad0: 2020 2020 2020 7265 7475 726e 2064 6632        return df2
-0002cae0: 0a0a 2020 2020 6465 6620 5f72 6576 6572  ..    def _rever
-0002caf0: 7365 5961 686f 6f41 646a 7573 7428 7365  seYahooAdjust(se
-0002cb00: 6c66 2c20 6466 293a 0a20 2020 2020 2020  lf, df):.       
-0002cb10: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
-0002cb20: 6174 6146 7261 6d65 2864 662c 2022 6466  ataFrame(df, "df
-0002cb30: 2229 0a0a 2020 2020 2020 2020 2320 5961  ")..        # Ya
-0002cb40: 686f 6f20 7265 7475 726e 7320 6461 7461  hoo returns data
-0002cb50: 2073 706c 6974 2d61 646a 7573 7465 6420   split-adjusted 
-0002cb60: 736f 2072 6576 6572 7365 2074 6861 742e  so reverse that.
-0002cb70: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
-0002cb80: 2020 2023 2045 7863 6570 7420 666f 7220     # Except for 
-0002cb90: 686f 7572 6c79 2f6d 696e 7574 6520 6461  hourly/minute da
-0002cba0: 7461 2c20 5961 686f 6f20 6973 6e27 7420  ta, Yahoo isn't 
-0002cbb0: 636f 6e73 6973 7465 6e74 2077 6974 6820  consistent with 
-0002cbc0: 6164 6a75 7374 6d65 6e74 3a0a 2020 2020  adjustment:.    
-0002cbd0: 2020 2020 2320 2d20 7072 6963 6573 206f      # - prices o
-0002cbe0: 6e6c 7920 7370 6c69 742d 6164 6a75 7374  nly split-adjust
-0002cbf0: 6564 2069 6620 6461 7465 2072 616e 6765  ed if date range
-0002cc00: 2063 6f6e 7461 696e 7320 6120 7370 6c69   contains a spli
-0002cc10: 740a 2020 2020 2020 2020 2320 2d20 6469  t.        # - di
-0002cc20: 7669 6465 6e64 2061 7070 6561 7273 2073  vidend appears s
-0002cc30: 706c 6974 2d61 646a 7573 7465 640a 2020  plit-adjusted.  
-0002cc40: 2020 2020 2020 2320 4561 7379 2074 6f20        # Easy to 
-0002cc50: 6669 7820 7573 696e 6720 6461 696c 7920  fix using daily 
-0002cc60: 6461 7461 3a0a 2020 2020 2020 2020 2320  data:.        # 
-0002cc70: 2d20 6469 7669 6465 2070 7269 6365 7320  - divide prices 
-0002cc80: 6279 2064 6169 6c79 2074 6f20 6465 7465  by daily to dete
-0002cc90: 726d 696e 6520 6966 2073 706c 6974 2d61  rmine if split-a
-0002cca0: 646a 7573 7465 640a 2020 2020 2020 2020  djusted.        
-0002ccb0: 2320 2d20 636f 7079 2064 6976 6964 656e  # - copy dividen
-0002ccc0: 6473 2066 726f 6d20 6461 696c 790a 0a20  ds from daily.. 
-0002ccd0: 2020 2020 2020 2023 2046 696e 616c 6c79         # Finally
-0002cce0: 2c20 6164 6420 2743 5346 2720 2620 2743  , add 'CSF' & 'C
-0002ccf0: 4446 2720 636f 6c75 6d6e 7320 746f 2061  DF' columns to a
-0002cd00: 6c6c 6f77 2063 6865 6170 206f 6e2d 6465  llow cheap on-de
-0002cd10: 6d61 6e64 2061 646a 7573 746d 656e 740a  mand adjustment.
-0002cd20: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0002cd30: 6973 696e 7374 616e 6365 2864 662c 2070  isinstance(df, p
-0002cd40: 642e 4461 7461 4672 616d 6529 3a0a 2020  d.DataFrame):.  
-0002cd50: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0002cd60: 4578 6365 7074 696f 6e28 2227 6466 2720  Exception("'df' 
-0002cd70: 6d75 7374 2062 6520 7064 2e44 6174 6146  must be pd.DataF
-0002cd80: 7261 6d65 206e 6f74 207b 7d22 2e66 6f72  rame not {}".for
-0002cd90: 6d61 7428 7479 7065 2864 6629 2929 0a0a  mat(type(df)))..
-0002cda0: 2020 2020 2020 2020 6465 6275 6720 3d20          debug = 
-0002cdb0: 4661 6c73 650a 2020 2020 2020 2020 2320  False.        # 
-0002cdc0: 6465 6275 6720 3d20 5472 7565 0a0a 2020  debug = True..  
-0002cdd0: 2020 2020 2020 6c6f 675f 6d73 6720 3d20        log_msg = 
-0002cde0: 6622 504d 3a3a 5f72 6576 6572 7365 5961  f"PM::_reverseYa
-0002cdf0: 686f 6f41 646a 7573 742d 7b73 656c 662e  hooAdjust-{self.
-0002ce00: 6973 7472 7d2c 207b 6466 2e69 6e64 6578  istr}, {df.index
-0002ce10: 5b30 5d7d 2d3e 7b64 662e 696e 6465 785b  [0]}->{df.index[
-0002ce20: 2d31 5d7d 220a 2020 2020 2020 2020 6966  -1]}".        if
-0002ce30: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-0002ce40: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
-0002ce50: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-0002ce60: 456e 7465 7228 6c6f 675f 6d73 6729 0a20  Enter(log_msg). 
-0002ce70: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
-0002ce80: 673a 0a20 2020 2020 2020 2020 2020 2070  g:.            p
-0002ce90: 7269 6e74 2822 2229 0a20 2020 2020 2020  rint("").       
-0002cea0: 2020 2020 2070 7269 6e74 286c 6f67 5f6d       print(log_m
-0002ceb0: 7367 290a 0a20 2020 2020 2020 2069 6620  sg)..        if 
-0002cec0: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-0002ced0: 2020 2070 7269 6e74 2864 665b 5b22 4f70     print(df[["Op
-0002cee0: 656e 222c 2022 4c6f 7722 2c20 2248 6967  en", "Low", "Hig
-0002cef0: 6822 2c20 2243 6c6f 7365 222c 2022 566f  h", "Close", "Vo
-0002cf00: 6c75 6d65 225d 5d29 0a0a 2020 2020 2020  lume"]])..      
-0002cf10: 2020 6364 6620 3d20 4e6f 6e65 0a20 2020    cdf = None.   
-0002cf20: 2020 2020 2063 7366 203d 204e 6f6e 650a       csf = None.
-0002cf30: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0002cf40: 2e69 6e74 6572 7661 6c20 213d 2079 6663  .interval != yfc
-0002cf50: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
-0002cf60: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002cf70: 5472 6967 6765 7220 7570 6461 7465 206f  Trigger update o
-0002cf80: 6620 6461 696c 7920 7072 6963 6520 6461  f daily price da
-0002cf90: 7461 2c20 746f 2067 6574 2061 6c6c 2065  ta, to get all e
-0002cfa0: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
-0002cfb0: 2020 6869 7374 4461 696c 7920 3d20 7365    histDaily = se
-0002cfc0: 6c66 2e6d 616e 6167 6572 2e47 6574 4869  lf.manager.GetHi
-0002cfd0: 7374 6f72 7928 7966 6364 2e49 6e74 6572  story(yfcd.Inter
-0002cfe0: 7661 6c2e 4461 7973 3129 0a20 2020 2020  val.Days1).     
-0002cff0: 2020 2020 2020 2064 665f 6461 696c 795f         df_daily_
-0002d000: 7261 7720 3d20 6869 7374 4461 696c 792e  raw = histDaily.
-0002d010: 6765 7428 7374 6172 743d 6466 2e69 6e64  get(start=df.ind
-0002d020: 6578 5b30 5d2e 6461 7465 2829 2c20 7265  ex[0].date(), re
-0002d030: 7061 6972 3d46 616c 7365 290a 0a20 2020  pair=False)..   
-0002d040: 2020 2020 2023 2053 7465 7020 313a 2065       # Step 1: e
-0002d050: 6e73 7572 6520 696e 7472 6164 6179 2070  nsure intraday p
-0002d060: 7269 6365 2064 6174 6120 6973 2061 6c77  rice data is alw
-0002d070: 6179 7320 7370 6c69 742d 6164 6a75 7374  ays split-adjust
-0002d080: 6564 0a20 2020 2020 2020 2074 645f 3764  ed.        td_7d
-0002d090: 203d 2074 696d 6564 656c 7461 2864 6179   = timedelta(day
-0002d0a0: 733d 3729 0a20 2020 2020 2020 2069 6620  s=7).        if 
-0002d0b0: 6e6f 7420 7365 6c66 2e69 6e74 6572 6461  not self.interda
-0002d0c0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
-0002d0d0: 2047 6574 2064 6169 6c79 2070 7269 6365   Get daily price
-0002d0e0: 2064 6174 6120 6475 7269 6e67 2061 6e64   data during and
-0002d0f0: 2061 6674 6572 2027 6466 270a 0a20 2020   after 'df'..   
-0002d100: 2020 2020 2020 2020 2064 665f 6461 696c           df_dail
-0002d110: 7920 3d20 6466 5f64 6169 6c79 5f72 6177  y = df_daily_raw
-0002d120: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-0002d130: 2020 2020 666f 7220 6320 696e 205b 224f      for c in ["O
-0002d140: 7065 6e22 2c20 2243 6c6f 7365 222c 2022  pen", "Close", "
-0002d150: 4c6f 7722 2c20 2248 6967 6822 5d3a 0a20  Low", "High"]:. 
-0002d160: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002d170: 665f 6461 696c 795b 635d 202a 3d20 6466  f_daily[c] *= df
-0002d180: 5f64 6169 6c79 5b22 4353 4622 5d0a 2020  _daily["CSF"].  
-0002d190: 2020 2020 2020 2020 2020 6466 5f64 6169            df_dai
-0002d1a0: 6c79 5b22 566f 6c75 6d65 225d 202f 3d20  ly["Volume"] /= 
-0002d1b0: 6466 5f64 6169 6c79 5b22 4353 4622 5d0a  df_daily["CSF"].
-0002d1c0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-0002d1d0: 6169 6c79 203d 2064 665f 6461 696c 792e  aily = df_daily.
-0002d1e0: 6472 6f70 2822 4353 4622 2c20 6178 6973  drop("CSF", axis
-0002d1f0: 3d31 290a 0a20 2020 2020 2020 2020 2020  =1)..           
-0002d200: 2069 6620 6466 5f64 6169 6c79 2069 7320   if df_daily is 
-0002d210: 4e6f 6e65 206f 7220 6466 5f64 6169 6c79  None or df_daily
-0002d220: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
-0002d230: 2020 2020 2020 2020 2320 6466 203d 2064          # df = d
-0002d240: 662e 6472 6f70 2822 4164 6a20 436c 6f73  f.drop("Adj Clos
-0002d250: 6522 2c20 6178 6973 3d31 290a 2020 2020  e", axis=1).    
-0002d260: 2020 2020 2020 2020 2020 2020 6466 5b22              df["
-0002d270: 4353 4622 5d20 3d20 312e 300a 2020 2020  CSF"] = 1.0.    
-0002d280: 2020 2020 2020 2020 2020 2020 6466 5b22              df["
-0002d290: 4344 4622 5d20 3d20 312e 300a 2020 2020  CDF"] = 1.0.    
-0002d2a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002d2b0: 726e 2064 660a 0a20 2020 2020 2020 2020  rn df..         
-0002d2c0: 2020 2066 5f70 6f73 7420 3d20 6466 5f64     f_post = df_d
-0002d2d0: 6169 6c79 2e69 6e64 6578 2e64 6174 6520  aily.index.date 
-0002d2e0: 3e20 6466 2e69 6e64 6578 5b2d 315d 2e64  > df.index[-1].d
-0002d2f0: 6174 6528 290a 2020 2020 2020 2020 2020  ate().          
-0002d300: 2020 6466 5f64 6169 6c79 5f64 7572 696e    df_daily_durin
-0002d310: 6720 3d20 6466 5f64 6169 6c79 5b7e 665f  g = df_daily[~f_
-0002d320: 706f 7374 5d2e 636f 7079 2829 0a20 2020  post].copy().   
-0002d330: 2020 2020 2020 2020 2064 665f 6461 696c           df_dail
-0002d340: 795f 706f 7374 203d 2064 665f 6461 696c  y_post = df_dail
-0002d350: 795b 665f 706f 7374 5d2e 636f 7079 2829  y[f_post].copy()
-0002d360: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-0002d370: 6461 696c 795f 6475 7269 6e67 2e69 6e64  daily_during.ind
-0002d380: 6578 203d 2064 665f 6461 696c 795f 6475  ex = df_daily_du
-0002d390: 7269 6e67 2e69 6e64 6578 2e64 6174 6520  ring.index.date 
-0002d3a0: 3b20 6466 5f64 6169 6c79 5f64 7572 696e  ; df_daily_durin
-0002d3b0: 672e 696e 6465 782e 6e61 6d65 203d 2022  g.index.name = "
-0002d3c0: 5f64 6174 6522 0a0a 2020 2020 2020 2020  _date"..        
-0002d3d0: 2020 2020 2320 416c 736f 2067 6574 2072      # Also get r
-0002d3e0: 6177 2064 6169 6c79 2064 6174 6120 6672  aw daily data fr
-0002d3f0: 6f6d 2063 6163 6865 0a20 2020 2020 2020  om cache.       
-0002d400: 2020 2020 2064 665f 6461 696c 795f 7261       df_daily_ra
-0002d410: 7720 3d20 6466 5f64 6169 6c79 5f72 6177  w = df_daily_raw
-0002d420: 5b64 665f 6461 696c 795f 7261 772e 696e  [df_daily_raw.in
-0002d430: 6465 782e 6461 7465 203e 3d20 6466 2e69  dex.date >= df.i
-0002d440: 6e64 6578 5b30 5d2e 6461 7465 2829 5d0a  ndex[0].date()].
-0002d450: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
-0002d460: 2020 2020 2020 2020 2020 665f 706f 7374            f_post
-0002d470: 203d 2064 665f 6461 696c 795f 7261 772e   = df_daily_raw.
-0002d480: 696e 6465 782e 6461 7465 203e 2064 662e  index.date > df.
-0002d490: 696e 6465 785b 2d31 5d2e 6461 7465 2829  index[-1].date()
-0002d4a0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-0002d4b0: 6461 696c 795f 7261 775f 6475 7269 6e67  daily_raw_during
-0002d4c0: 203d 2064 665f 6461 696c 795f 7261 775b   = df_daily_raw[
-0002d4d0: 7e66 5f70 6f73 745d 2e63 6f70 7928 290a  ~f_post].copy().
-0002d4e0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-0002d4f0: 6169 6c79 5f72 6177 5f64 7572 696e 675f  aily_raw_during_
-0002d500: 6420 3d20 6466 5f64 6169 6c79 5f72 6177  d = df_daily_raw
-0002d510: 5f64 7572 696e 672e 636f 7079 2829 0a20  _during.copy(). 
-0002d520: 2020 2020 2020 2020 2020 2064 665f 6461             df_da
-0002d530: 696c 795f 7261 775f 6475 7269 6e67 5f64  ily_raw_during_d
-0002d540: 2e69 6e64 6578 203d 2064 665f 6461 696c  .index = df_dail
-0002d550: 795f 7261 775f 6475 7269 6e67 5f64 2e69  y_raw_during_d.i
-0002d560: 6e64 6578 2e64 6174 6520 3b20 6466 5f64  ndex.date ; df_d
-0002d570: 6169 6c79 5f72 6177 5f64 7572 696e 675f  aily_raw_during_
-0002d580: 642e 696e 6465 782e 6e61 6d65 203d 2022  d.index.name = "
-0002d590: 5f64 6174 6522 0a0a 2020 2020 2020 2020  _date"..        
-0002d5a0: 2020 2020 6966 2064 665f 6461 696c 795f      if df_daily_
-0002d5b0: 706f 7374 2e65 6d70 7479 3a0a 2020 2020  post.empty:.    
-0002d5c0: 2020 2020 2020 2020 2020 2020 6373 665f              csf_
-0002d5d0: 706f 7374 203d 2031 2e30 0a20 2020 2020  post = 1.0.     
-0002d5e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002d5f0: 2020 2020 2020 2020 2020 2020 2063 7366               csf
-0002d600: 5f70 6f73 7420 3d20 7966 6375 2e47 6574  _post = yfcu.Get
-0002d610: 4353 4630 2864 665f 6461 696c 795f 706f  CSF0(df_daily_po
-0002d620: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0002d630: 6578 7065 6374 6564 5261 7469 6f20 3d20  expectedRatio = 
-0002d640: 312e 3020 2f20 6373 665f 706f 7374 0a0a  1.0 / csf_post..
-0002d650: 2020 2020 2020 2020 2020 2020 7373 5f72              ss_r
-0002d660: 6174 696f 203d 2065 7870 6563 7465 6452  atio = expectedR
-0002d670: 6174 696f 0a20 2020 2020 2020 2020 2020  atio.           
-0002d680: 2073 735f 7261 7469 6f52 6370 203d 2031   ss_ratioRcp = 1
-0002d690: 2e30 202f 2073 735f 7261 7469 6f0a 2020  .0 / ss_ratio.  
-0002d6a0: 2020 2020 2020 2020 2020 230a 2020 2020            #.    
-0002d6b0: 2020 2020 2020 2020 7072 6963 655f 6461          price_da
-0002d6c0: 7461 5f63 6f6c 7320 3d20 5b22 4f70 656e  ta_cols = ["Open
-0002d6d0: 222c 2022 436c 6f73 6522 2c20 2241 646a  ", "Close", "Adj
-0002d6e0: 2043 6c6f 7365 222c 2022 4c6f 7722 2c20   Close", "Low", 
-0002d6f0: 2248 6967 6822 5d0a 2020 2020 2020 2020  "High"].        
-0002d700: 2020 2020 6966 2073 735f 7261 7469 6f20      if ss_ratio 
-0002d710: 3e20 312e 3031 3a0a 2020 2020 2020 2020  > 1.01:.        
-0002d720: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-0002d730: 2070 7269 6365 5f64 6174 615f 636f 6c73   price_data_cols
-0002d740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d750: 2020 2020 2020 6466 5b63 5d20 2a3d 2073        df[c] *= s
-0002d760: 735f 7261 7469 6f52 6370 0a20 2020 2020  s_ratioRcp.     
-0002d770: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-0002d780: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-0002d790: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-0002d7a0: 4170 706c 7969 6e67 2031 3a7b 7d20 7374  Applying 1:{} st
-0002d7b0: 6f63 6b2d 7370 6c69 7422 2e66 6f72 6d61  ock-split".forma
-0002d7c0: 7428 726f 756e 6428 7373 5f72 6174 696f  t(round(ss_ratio
-0002d7d0: 2c20 3229 2929 0a20 2020 2020 2020 2020  , 2))).         
-0002d7e0: 2020 2065 6c69 6620 7373 5f72 6174 696f     elif ss_ratio
-0002d7f0: 5263 7020 3e20 312e 3031 3a0a 2020 2020  Rcp > 1.01:.    
-0002d800: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002d810: 6320 696e 2070 7269 6365 5f64 6174 615f  c in price_data_
-0002d820: 636f 6c73 3a0a 2020 2020 2020 2020 2020  cols:.          
-0002d830: 2020 2020 2020 2020 2020 6466 5b63 5d20            df[c] 
-0002d840: 2a3d 2073 735f 7261 7469 6f0a 2020 2020  *= ss_ratio.    
-0002d850: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0002d860: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-0002d870: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002d880: 2241 7070 6c79 696e 6720 7b2e 3266 7d3a  "Applying {.2f}:
-0002d890: 3120 7265 7665 7273 652d 7370 6c69 742d  1 reverse-split-
-0002d8a0: 7370 6c69 7422 2e66 6f72 6d61 7428 7373  split".format(ss
-0002d8b0: 5f72 6174 696f 5263 7029 290a 2020 2020  _ratioRcp)).    
-0002d8c0: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
-0002d8d0: 766f 6c75 6d65 2061 6c77 6179 7320 7265  volume always re
-0002d8e0: 7475 726e 6564 2075 6e61 646a 7573 7465  turned unadjuste
-0002d8f0: 640a 0a20 2020 2020 2020 2020 2020 2023  d..            #
-0002d900: 2059 6168 6f6f 206d 6573 7365 7320 7570   Yahoo messes up
-0002d910: 2064 6976 6964 656e 6420 6164 6a75 7374   dividend adjust
-0002d920: 6d65 6e74 2074 6f6f 2073 6f20 636f 7079  ment too so copy
-0002d930: 2063 6f72 7265 6374 2064 6976 6964 656e   correct dividen
-0002d940: 6420 6672 6f6d 2064 6169 6c79 2c0a 2020  d from daily,.  
-0002d950: 2020 2020 2020 2020 2020 2320 6275 7420            # but 
-0002d960: 6f6e 6c79 2074 6f20 6669 7273 7420 7469  only to first ti
-0002d970: 6d65 2070 6572 696f 6473 206f 6620 6561  me periods of ea
-0002d980: 6368 2064 6179 3a0a 2020 2020 2020 2020  ch day:.        
-0002d990: 2020 2020 6466 5b22 5f64 6174 6522 5d20      df["_date"] 
-0002d9a0: 3d20 6466 2e69 6e64 6578 2e64 6174 650a  = df.index.date.
-0002d9b0: 2020 2020 2020 2020 2020 2020 6466 5b22              df["
-0002d9c0: 5f69 6e64 6578 4261 636b 7570 225d 203d  _indexBackup"] =
-0002d9d0: 2064 662e 696e 6465 780a 2020 2020 2020   df.index.      
-0002d9e0: 2020 2020 2020 2320 436f 7079 206f 7665        # Copy ove
-0002d9f0: 7220 4353 4620 616e 6420 4344 4620 746f  r CSF and CDF to
-0002da00: 6f20 6672 6f6d 2064 6169 6c79 0a20 2020  o from daily.   
-0002da10: 2020 2020 2020 2020 2064 6620 3d20 7064           df = pd
-0002da20: 2e6d 6572 6765 2864 662c 2064 665f 6461  .merge(df, df_da
-0002da30: 696c 795f 7261 775f 6475 7269 6e67 5f64  ily_raw_during_d
-0002da40: 5b5b 2243 4446 222c 2022 4353 4622 5d5d  [["CDF", "CSF"]]
-0002da50: 2c20 686f 773d 226c 6566 7422 2c20 6f6e  , how="left", on
-0002da60: 3d22 5f64 6174 6522 2c20 7661 6c69 6461  ="_date", valida
-0002da70: 7465 3d22 6d61 6e79 5f74 6f5f 6f6e 6522  te="many_to_one"
-0002da80: 290a 2020 2020 2020 2020 2020 2020 6466  ).            df
-0002da90: 2e69 6e64 6578 203d 2064 665b 225f 696e  .index = df["_in
-0002daa0: 6465 7842 6163 6b75 7022 5d20 3b20 6466  dexBackup"] ; df
-0002dab0: 2e69 6e64 6578 2e6e 616d 6520 3d20 4e6f  .index.name = No
-0002dac0: 6e65 203b 2064 6620 3d20 6466 2e64 726f  ne ; df = df.dro
-0002dad0: 7028 5b22 5f69 6e64 6578 4261 636b 7570  p(["_indexBackup
-0002dae0: 222c 2022 5f64 6174 6522 5d2c 2061 7869  ", "_date"], axi
-0002daf0: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
-0002db00: 2063 6466 203d 2064 665b 2243 4446 225d   cdf = df["CDF"]
-0002db10: 0a20 2020 2020 2020 2020 2020 2064 665b  .            df[
-0002db20: 2241 646a 2043 6c6f 7365 225d 203d 2064  "Adj Close"] = d
-0002db30: 665b 2243 6c6f 7365 225d 202a 2063 6466  f["Close"] * cdf
-0002db40: 0a20 2020 2020 2020 2020 2020 2063 7366  .            csf
-0002db50: 203d 2064 665b 2243 5346 225d 0a0a 2020   = df["CSF"]..  
-0002db60: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0002db70: 2064 665f 6461 696c 795f 706f 7374 2e65   df_daily_post.e
-0002db80: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-0002db90: 2020 2020 2020 706f 7374 5f63 7366 203d        post_csf =
-0002dba0: 2079 6663 752e 4765 7443 5346 3028 6466   yfcu.GetCSF0(df
-0002dbb0: 5f64 6169 6c79 5f70 6f73 7429 0a0a 2020  _daily_post)..  
-0002dbc0: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-0002dbd0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0002dbe0: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
-0002dbf0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-0002dc00: 6169 6c79 203d 2068 6973 7444 6169 6c79  aily = histDaily
-0002dc10: 2e67 6574 2873 7461 7274 3d64 662e 696e  .get(start=df.in
-0002dc20: 6465 785b 2d31 5d2e 6461 7465 2829 2b74  dex[-1].date()+t
-0002dc30: 645f 3764 2c20 7265 7061 6972 3d46 616c  d_7d, repair=Fal
-0002dc40: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-0002dc50: 6966 2028 6466 5f64 6169 6c79 2069 7320  if (df_daily is 
-0002dc60: 6e6f 7420 4e6f 6e65 2920 616e 6420 286e  not None) and (n
-0002dc70: 6f74 2064 665f 6461 696c 792e 656d 7074  ot df_daily.empt
-0002dc80: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
-0002dc90: 2020 2020 706f 7374 5f63 7366 203d 2079      post_csf = y
-0002dca0: 6663 752e 4765 7443 5346 3028 6466 5f64  fcu.GetCSF0(df_d
-0002dcb0: 6169 6c79 290a 2020 2020 2020 2020 2020  aily).          
-0002dcc0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
-0002dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dce0: 2020 2020 7072 696e 7428 222d 2070 6f73      print("- pos
-0002dcf0: 745f 6373 6620 6f66 2064 6169 6c79 2064  t_csf of daily d
-0002dd00: 6174 6520 7261 6e67 6520 7b7d 2d3e 7b7d  ate range {}->{}
-0002dd10: 203d 207b 7d22 2e66 6f72 6d61 7428 6466   = {}".format(df
-0002dd20: 5f64 6169 6c79 2e69 6e64 6578 5b30 5d2c  _daily.index[0],
-0002dd30: 2064 665f 6461 696c 792e 696e 6465 785b   df_daily.index[
-0002dd40: 2d31 5d2c 2070 6f73 745f 6373 6629 290a  -1], post_csf)).
-0002dd50: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0002dd60: 6c66 2e69 6e74 6572 7661 6c20 696e 205b  lf.interval in [
-0002dd70: 7966 6364 2e49 6e74 6572 7661 6c2e 4d6f  yfcd.Interval.Mo
-0002dd80: 6e74 6873 312c 2079 6663 642e 496e 7465  nths1, yfcd.Inte
-0002dd90: 7276 616c 2e4d 6f6e 7468 7333 5d3a 0a20  rval.Months3]:. 
-0002dda0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002ddb0: 2045 7863 6570 7469 6f6e 2822 6e6f 7420   Exception("not 
-0002ddc0: 696d 706c 656d 656e 7465 6422 290a 0a20  implemented").. 
-0002ddd0: 2020 2020 2020 2023 2049 6620 2764 6627         # If 'df'
-0002dde0: 2064 6f65 7320 6e6f 7420 636f 6e74 6169   does not contai
-0002ddf0: 6e20 616c 6c20 7374 6f63 6b20 7370 6c69  n all stock spli
-0002de00: 7473 2075 6e74 696c 2070 7265 7365 6e74  ts until present
-0002de10: 2c20 7468 656e 0a20 2020 2020 2020 2023  , then.        #
-0002de20: 2073 6574 2027 706f 7374 5f63 7366 2720   set 'post_csf' 
-0002de30: 746f 2063 756d 756c 6174 6976 6520 7374  to cumulative st
-0002de40: 6f63 6b20 7370 6c69 7420 6661 6374 6f72  ock split factor
-0002de50: 206a 7573 7420 6166 7465 7220 6c61 7374   just after last
-0002de60: 2027 6466 2720 6461 7465 0a20 2020 2020   'df' date.     
-0002de70: 2020 2073 706c 6974 735f 706f 7374 203d     splits_post =
-0002de80: 2073 656c 662e 6d61 6e61 6765 722e 4765   self.manager.Ge
-0002de90: 7448 6973 746f 7279 2822 4576 656e 7473  tHistory("Events
-0002dea0: 2229 2e47 6574 5370 6c69 7473 2873 7461  ").GetSplits(sta
-0002deb0: 7274 3d64 662e 696e 6465 785b 2d31 5d2e  rt=df.index[-1].
-0002dec0: 6461 7465 2829 2b74 696d 6564 656c 7461  date()+timedelta
-0002ded0: 2864 6179 733d 3129 290a 2020 2020 2020  (days=1)).      
-0002dee0: 2020 6966 2073 706c 6974 735f 706f 7374    if splits_post
-0002def0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0002df00: 2020 2020 2020 2020 2020 706f 7374 5f63            post_c
-0002df10: 7366 203d 2031 2e30 2f73 706c 6974 735f  sf = 1.0/splits_
-0002df20: 706f 7374 5b22 5374 6f63 6b20 5370 6c69  post["Stock Spli
-0002df30: 7473 225d 2e70 726f 6428 290a 2020 2020  ts"].prod().    
-0002df40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002df50: 2020 2020 2020 706f 7374 5f63 7366 203d        post_csf =
-0002df60: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
-0002df70: 2043 756d 756c 6174 6976 6520 6469 7669   Cumulative divi
-0002df80: 6465 6e64 2066 6163 746f 720a 2020 2020  dend factor.    
-0002df90: 2020 2020 6966 2063 6466 2069 7320 4e6f      if cdf is No
-0002dfa0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002dfb0: 665f 6e6e 6120 3d20 7e64 665b 2243 6c6f  f_nna = ~df["Clo
-0002dfc0: 7365 225d 2e69 736e 6128 290a 2020 2020  se"].isna().    
-0002dfd0: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
-0002dfe0: 5f6e 6e61 2e61 6e79 2829 3a0a 2020 2020  _nna.any():.    
-0002dff0: 2020 2020 2020 2020 2020 2020 6364 6620              cdf 
-0002e000: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
-0002e010: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002e020: 2020 2020 2020 2020 6364 6620 3d20 6e70          cdf = np
-0002e030: 2e66 756c 6c28 6466 2e73 6861 7065 5b30  .full(df.shape[0
-0002e040: 5d2c 206e 702e 6e61 6e29 0a20 2020 2020  ], np.nan).     
-0002e050: 2020 2020 2020 2020 2020 2063 6466 5b66             cdf[f
-0002e060: 5f6e 6e61 5d20 3d20 6466 2e6c 6f63 5b66  _nna] = df.loc[f
-0002e070: 5f6e 6e61 2c20 2241 646a 2043 6c6f 7365  _nna, "Adj Close
-0002e080: 225d 202f 2064 662e 6c6f 635b 665f 6e6e  "] / df.loc[f_nn
-0002e090: 612c 2022 436c 6f73 6522 5d0a 2020 2020  a, "Close"].    
-0002e0a0: 2020 2020 2020 2020 2020 2020 6364 6620              cdf 
-0002e0b0: 3d20 7064 2e53 6572 6965 7328 6364 6629  = pd.Series(cdf)
-0002e0c0: 2e66 696c 6c6e 6128 6d65 7468 6f64 3d22  .fillna(method="
-0002e0d0: 6266 696c 6c22 292e 6669 6c6c 6e61 286d  bfill").fillna(m
-0002e0e0: 6574 686f 643d 2266 6669 6c6c 2229 2e74  ethod="ffill").t
-0002e0f0: 6f5f 6e75 6d70 7928 290a 0a20 2020 2020  o_numpy()..     
-0002e100: 2020 2023 2049 6e20 7261 7265 2063 6173     # In rare cas
-0002e110: 6573 2c20 5961 686f 6f20 6973 206e 6f74  es, Yahoo is not
-0002e120: 2063 616c 6375 6c61 7469 6e67 2027 4164   calculating 'Ad
-0002e130: 6a20 436c 6f73 6527 2063 6f72 7265 6374  j Close' correct
-0002e140: 6c79 0a20 2020 2020 2020 2069 6620 7365  ly.        if se
-0002e150: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-0002e160: 2020 2020 2020 2020 2064 6976 735f 7369           divs_si
-0002e170: 6e63 6520 3d20 7365 6c66 2e6d 616e 6167  nce = self.manag
-0002e180: 6572 2e47 6574 4869 7374 6f72 7928 2245  er.GetHistory("E
-0002e190: 7665 6e74 7322 292e 4765 7444 6976 7328  vents").GetDivs(
-0002e1a0: 7374 6172 743d 6466 2e69 6e64 6578 5b2d  start=df.index[-
-0002e1b0: 315d 2e64 6174 6528 292b 7365 6c66 2e69  1].date()+self.i
-0002e1c0: 7464 290a 2020 2020 2020 2020 2020 2020  td).            
-0002e1d0: 6966 2064 6976 735f 7369 6e63 6520 6973  if divs_since is
-0002e1e0: 206e 6f74 204e 6f6e 6520 616e 6420 6e6f   not None and no
-0002e1f0: 7420 6469 7673 5f73 696e 6365 2e65 6d70  t divs_since.emp
-0002e200: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-0002e210: 2020 2020 2320 4368 6563 6b20 7468 6174      # Check that
-0002e220: 2027 4164 6a20 436c 6f73 6527 2072 6566   'Adj Close' ref
-0002e230: 6c65 6374 7320 616c 6c20 6675 7475 7265  lects all future
-0002e240: 2064 6976 6964 656e 6473 0a20 2020 2020   dividends.     
-0002e250: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-0002e260: 7465 645f 6164 6a20 3d20 6469 7673 5f73  ted_adj = divs_s
-0002e270: 696e 6365 5b27 4261 636b 2041 646a 2e27  ince['Back Adj.'
-0002e280: 5d2e 7072 6f64 2829 0a20 2020 2020 2020  ].prod().       
-0002e290: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0002e2a0: 2e69 6e74 6572 6461 7920 616e 6420 7365  .interday and se
-0002e2b0: 6c66 2e69 6e74 6572 7661 6c20 213d 2079  lf.interval != y
-0002e2c0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-0002e2d0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-0002e2e0: 2020 2020 2020 2020 6966 2064 665b 2744          if df['D
-0002e2f0: 6976 6964 656e 6473 275d 2e69 6c6f 635b  ividends'].iloc[
-0002e300: 2d31 5d20 213d 2030 2e30 3a0a 2020 2020  -1] != 0.0:.    
-0002e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e320: 2020 2020 6474 203d 2064 662e 696e 6465      dt = df.inde
-0002e330: 785b 2d31 5d0a 2020 2020 2020 2020 2020  x[-1].          
-0002e340: 2020 2020 2020 2020 2020 2020 2020 6869                hi
-0002e350: 7374 5f62 6566 6f72 6520 3d20 7365 6c66  st_before = self
-0002e360: 2e6d 616e 6167 6572 2e47 6574 4869 7374  .manager.GetHist
-0002e370: 6f72 7928 7966 6364 2e49 6e74 6572 7661  ory(yfcd.Interva
-0002e380: 6c2e 4461 7973 3129 2e67 6574 2873 7461  l.Days1).get(sta
-0002e390: 7274 3d64 742e 6461 7465 2829 2d74 696d  rt=dt.date()-tim
-0002e3a0: 6564 656c 7461 2864 6179 733d 3729 2c20  edelta(days=7), 
-0002e3b0: 656e 643d 6474 2e64 6174 6528 292c 2061  end=dt.date(), a
-0002e3c0: 646a 7573 745f 7370 6c69 7473 3d46 616c  djust_splits=Fal
-0002e3d0: 7365 2c20 6164 6a75 7374 5f64 6976 733d  se, adjust_divs=
-0002e3e0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e400: 6c6f 7365 203d 2068 6973 745f 6265 666f  lose = hist_befo
-0002e410: 7265 5b27 436c 6f73 6527 5d2e 696c 6f63  re['Close'].iloc
-0002e420: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
-0002e430: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-0002e440: 6563 7465 645f 6164 6a20 2a3d 2031 202d  ected_adj *= 1 -
-0002e450: 2064 665b 2744 6976 6964 656e 6473 275d   df['Dividends']
-0002e460: 2e69 6c6f 635b 2d31 5d20 2f20 636c 6f73  .iloc[-1] / clos
-0002e470: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0002e480: 2020 6163 7475 616c 5f61 646a 203d 2063    actual_adj = c
-0002e490: 6466 5b2d 315d 0a20 2020 2020 2020 2020  df[-1].         
-0002e4a0: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
-0002e4b0: 2e69 736e 616e 2861 6374 7561 6c5f 6164  .isnan(actual_ad
-0002e4c0: 6a29 3a0a 2020 2020 2020 2020 2020 2020  j):.            
-0002e4d0: 2020 2020 2020 2020 6d73 6720 3d20 6627          msg = f'
-0002e4e0: 6578 7065 6374 6564 5f61 646a 3d7b 6578  expected_adj={ex
-0002e4f0: 7065 6374 6564 5f61 646a 3a2e 3466 7d20  pected_adj:.4f} 
-0002e500: 213d 2061 6374 7561 6c5f 6164 6a3d 7b61  != actual_adj={a
-0002e510: 6374 7561 6c5f 6164 6a3a 2e34 667d 270a  ctual_adj:.4f}'.
-0002e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e530: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
-0002e540: 2e4c 6f67 4576 656e 7428 2269 6e66 6f22  .LogEvent("info"
-0002e550: 2c20 275f 7265 7665 7273 6559 6168 6f6f  , '_reverseYahoo
-0002e560: 4164 6a75 7374 272c 206d 7367 290a 2020  Adjust', msg).  
-0002e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e580: 2020 6469 6666 5f70 6374 203d 2061 6273    diff_pct = abs
-0002e590: 2861 6374 7561 6c5f 6164 6a20 2f20 6578  (actual_adj / ex
-0002e5a0: 7065 6374 6564 5f61 646a 202d 2031 2e30  pected_adj - 1.0
-0002e5b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002e5c0: 2020 2020 2020 6966 2064 6966 665f 7063        if diff_pc
-0002e5d0: 7420 3e20 302e 3030 313a 0a20 2020 2020  t > 0.001:.     
-0002e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5f0: 2020 2023 2042 6164 2e20 4469 7669 6465     # Bad. Divide
-0002e600: 6e64 7320 6861 7665 206f 6363 7572 7265  nds have occurre
-0002e610: 6420 6166 7465 7220 7468 6973 2070 7269  d after this pri
-0002e620: 6365 2064 6174 612c 2062 7574 2027 4164  ce data, but 'Ad
-0002e630: 6a20 436c 6f73 6527 2069 7320 6d69 7373  j Close' is miss
-0002e640: 696e 6720 6164 6a75 7374 6d65 6e74 2873  ing adjustment(s
-0002e650: 292e 0a20 2020 2020 2020 2020 2020 2020  )..             
-0002e660: 2020 2020 2020 2020 2020 2023 2046 6978             # Fix
-0002e670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e680: 2020 2020 2020 2020 2063 6466 202a 3d20           cdf *= 
-0002e690: 6578 7065 6374 6564 5f61 646a 202f 2061  expected_adj / a
-0002e6a0: 6374 7561 6c5f 6164 6a0a 0a20 2020 2020  ctual_adj..     
-0002e6b0: 2020 2023 2043 756d 756c 6174 6976 6520     # Cumulative 
-0002e6c0: 7374 6f63 6b2d 7370 6c69 7420 6661 6374  stock-split fact
-0002e6d0: 6f72 0a20 2020 2020 2020 2069 6620 6373  or.        if cs
-0002e6e0: 6620 6973 204e 6f6e 653a 0a20 2020 2020  f is None:.     
-0002e6f0: 2020 2020 2020 2073 7320 3d20 6466 5b22         ss = df["
-0002e700: 5374 6f63 6b20 5370 6c69 7473 225d 2e63  Stock Splits"].c
-0002e710: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-0002e720: 2020 7373 5b28 7373 203d 3d20 302e 3029    ss[(ss == 0.0)
-0002e730: 207c 2073 732e 6973 6e61 2829 5d20 3d20   | ss.isna()] = 
-0002e740: 312e 300a 2020 2020 2020 2020 2020 2020  1.0.            
-0002e750: 7373 5f72 6370 203d 2031 2e30 202f 2073  ss_rcp = 1.0 / s
-0002e760: 730a 2020 2020 2020 2020 2020 2020 6373  s.            cs
-0002e770: 6620 3d20 7373 5f72 6370 2e73 6f72 745f  f = ss_rcp.sort_
-0002e780: 696e 6465 7828 6173 6365 6e64 696e 673d  index(ascending=
-0002e790: 4661 6c73 6529 2e63 756d 7072 6f64 2829  False).cumprod()
-0002e7a0: 2e73 6f72 745f 696e 6465 7828 6173 6365  .sort_index(asce
-0002e7b0: 6e64 696e 673d 5472 7565 292e 7368 6966  nding=True).shif
-0002e7c0: 7428 2d31 2c20 6669 6c6c 5f76 616c 7565  t(-1, fill_value
-0002e7d0: 3d31 2e30 290a 2020 2020 2020 2020 2020  =1.0).          
-0002e7e0: 2020 6966 2070 6f73 745f 6373 6620 6973    if post_csf is
-0002e7f0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0002e800: 2020 2020 2020 2020 2020 2063 7366 202a             csf *
-0002e810: 3d20 706f 7374 5f63 7366 0a20 2020 2020  = post_csf.     
-0002e820: 2020 2063 7366 5f72 6370 203d 2031 2e30     csf_rcp = 1.0
-0002e830: 202f 2063 7366 0a0a 2020 2020 2020 2020   / csf..        
-0002e840: 2320 5265 7665 7273 6520 5961 686f 6f27  # Reverse Yahoo'
-0002e850: 7320 7370 6c69 7420 6164 6a75 7374 6d65  s split adjustme
-0002e860: 6e74 3a0a 2020 2020 2020 2020 6461 7461  nt:.        data
-0002e870: 5f63 6f6c 7320 3d20 5b22 4f70 656e 222c  _cols = ["Open",
-0002e880: 2022 4869 6768 222c 2022 4c6f 7722 2c20   "High", "Low", 
-0002e890: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
-0002e8a0: 6e64 7322 5d0a 2020 2020 2020 2020 666f  nds"].        fo
-0002e8b0: 7220 6463 2069 6e20 6461 7461 5f63 6f6c  r dc in data_col
-0002e8c0: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-0002e8d0: 665b 6463 5d20 3d20 6466 5b64 635d 202a  f[dc] = df[dc] *
-0002e8e0: 2063 7366 5f72 6370 0a20 2020 2020 2020   csf_rcp.       
-0002e8f0: 2069 6620 6e6f 7420 7365 6c66 2e69 6e74   if not self.int
-0002e900: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
-0002e910: 2020 2023 2044 6f6e 2774 206e 6565 6420     # Don't need 
-0002e920: 746f 2064 652d 7370 6c69 7420 766f 6c75  to de-split volu
-0002e930: 6d65 2064 6174 6120 6265 6361 7573 6520  me data because 
-0002e940: 5961 686f 6f20 616c 7761 7973 2072 6574  Yahoo always ret
-0002e950: 7572 6e73 2069 6e74 6572 6461 7920 766f  urns interday vo
-0002e960: 6c75 6d65 2075 6e61 646a 7573 7465 640a  lume unadjusted.
-0002e970: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0002e980: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0002e990: 2020 2020 2020 2020 2020 2064 665b 2256             df["V
-0002e9a0: 6f6c 756d 6522 5d20 2a3d 2063 7366 0a0a  olume"] *= csf..
-0002e9b0: 2020 2020 2020 2020 6966 2064 665b 2256          if df["V
-0002e9c0: 6f6c 756d 6522 5d2e 6474 7970 6520 213d  olume"].dtype !=
-0002e9d0: 2027 696e 7436 3427 3a0a 2020 2020 2020   'int64':.      
-0002e9e0: 2020 2020 2020 6466 5b22 566f 6c75 6d65        df["Volume
-0002e9f0: 225d 203d 2064 665b 2256 6f6c 756d 6522  "] = df["Volume"
-0002ea00: 5d2e 726f 756e 6428 3029 2e61 7374 7970  ].round(0).astyp
-0002ea10: 6528 2769 6e74 2729 0a0a 2020 2020 2020  e('int')..      
-0002ea20: 2020 2320 4472 6f70 2027 4164 6a20 436c    # Drop 'Adj Cl
-0002ea30: 6f73 6527 2c20 7265 706c 6163 6520 7769  ose', replace wi
-0002ea40: 7468 2073 6361 6c69 6e67 2066 6163 746f  th scaling facto
-0002ea50: 7273 3a0a 2020 2020 2020 2020 6466 203d  rs:.        df =
-0002ea60: 2064 662e 6472 6f70 2822 4164 6a20 436c   df.drop("Adj Cl
-0002ea70: 6f73 6522 2c20 6178 6973 3d31 290a 2020  ose", axis=1).  
-0002ea80: 2020 2020 2020 6466 5b22 4353 4622 5d20        df["CSF"] 
-0002ea90: 3d20 6373 660a 2020 2020 2020 2020 6466  = csf.        df
-0002eaa0: 5b22 4344 4622 5d20 3d20 6364 660a 0a20  ["CDF"] = cdf.. 
-0002eab0: 2020 2020 2020 2068 5f6c 6173 7444 6976         h_lastDiv
-0002eac0: 4164 6a75 7374 4474 203d 2070 642e 5469  AdjustDt = pd.Ti
-0002ead0: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
-0002eae0: 2e74 7a5f 636f 6e76 6572 7428 5a6f 6e65  .tz_convert(Zone
-0002eaf0: 496e 666f 2822 5554 4322 2929 0a20 2020  Info("UTC")).   
-0002eb00: 2020 2020 2068 5f6c 6173 7453 706c 6974       h_lastSplit
-0002eb10: 4164 6a75 7374 4474 203d 2068 5f6c 6173  AdjustDt = h_las
-0002eb20: 7444 6976 4164 6a75 7374 4474 0a20 2020  tDivAdjustDt.   
-0002eb30: 2020 2020 2064 665b 224c 6173 7444 6976       df["LastDiv
-0002eb40: 4164 6a75 7374 4474 225d 203d 2068 5f6c  AdjustDt"] = h_l
-0002eb50: 6173 7444 6976 4164 6a75 7374 4474 0a20  astDivAdjustDt. 
-0002eb60: 2020 2020 2020 2064 665b 224c 6173 7453         df["LastS
-0002eb70: 706c 6974 4164 6a75 7374 4474 225d 203d  plitAdjustDt"] =
-0002eb80: 2068 5f6c 6173 7453 706c 6974 4164 6a75   h_lastSplitAdju
-0002eb90: 7374 4474 0a0a 2020 2020 2020 2020 6966  stDt..        if
-0002eba0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-0002ebb0: 2020 2020 7072 696e 7428 222d 2075 6e61      print("- una
-0002ebc0: 646a 7573 7465 643a 2229 0a20 2020 2020  djusted:").     
-0002ebd0: 2020 2020 2020 2070 7269 6e74 2864 665b         print(df[
-0002ebe0: 5b22 436c 6f73 6522 2c20 2244 6976 6964  ["Close", "Divid
-0002ebf0: 656e 6473 222c 2022 566f 6c75 6d65 222c  ends", "Volume",
-0002ec00: 2022 4353 4622 2c20 2243 4446 225d 5d29   "CSF", "CDF"]])
-0002ec10: 0a20 2020 2020 2020 2020 2020 2066 203d  .            f =
-0002ec20: 2064 665b 2244 6976 6964 656e 6473 225d   df["Dividends"]
-0002ec30: 2021 3d20 302e 300a 2020 2020 2020 2020   != 0.0.        
-0002ec40: 2020 2020 6966 2066 2e61 6e79 2829 3a0a      if f.any():.
-0002ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec60: 7072 696e 7428 222d 2064 6976 6964 656e  print("- dividen
-0002ec70: 6473 3a22 290a 2020 2020 2020 2020 2020  ds:").          
-0002ec80: 2020 2020 2020 7072 696e 7428 6466 2e6c        print(df.l
-0002ec90: 6f63 5b66 2c20 5b22 4f70 656e 222c 2022  oc[f, ["Open", "
-0002eca0: 4c6f 7722 2c20 2248 6967 6822 2c20 2243  Low", "High", "C
-0002ecb0: 6c6f 7365 222c 2022 4469 7669 6465 6e64  lose", "Dividend
-0002ecc0: 7322 2c20 2256 6f6c 756d 6522 2c20 2243  s", "Volume", "C
-0002ecd0: 5346 222c 2022 4344 4622 5d5d 290a 2020  SF", "CDF"]]).  
-0002ece0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002ecf0: 2222 290a 0a20 2020 2020 2020 206c 6f67  "")..        log
-0002ed00: 5f6d 7367 203d 2066 2250 4d3a 3a5f 7265  _msg = f"PM::_re
-0002ed10: 7665 7273 6559 6168 6f6f 4164 6a75 7374  verseYahooAdjust
-0002ed20: 2d7b 7365 6c66 2e69 7374 727d 2829 2072  -{self.istr}() r
-0002ed30: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
-0002ed40: 2020 6966 2079 6663 6c2e 4973 5472 6163    if yfcl.IsTrac
-0002ed50: 696e 6745 6e61 626c 6564 2829 3a0a 2020  ingEnabled():.  
-0002ed60: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-0002ed70: 7261 6365 4578 6974 286c 6f67 5f6d 7367  raceExit(log_msg
-0002ed80: 290a 2020 2020 2020 2020 656c 6966 2064  ).        elif d
-0002ed90: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-0002eda0: 2020 7072 696e 7428 6c6f 675f 6d73 6729    print(log_msg)
-0002edb0: 0a0a 2020 2020 2020 2020 6966 2064 6562  ..        if deb
-0002edc0: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
-0002edd0: 7072 696e 7428 6466 5b5b 224f 7065 6e22  print(df[["Open"
-0002ede0: 2c20 224c 6f77 222c 2022 4869 6768 222c  , "Low", "High",
-0002edf0: 2022 436c 6f73 6522 2c20 2244 6976 6964   "Close", "Divid
-0002ee00: 656e 6473 222c 2022 566f 6c75 6d65 222c  ends", "Volume",
-0002ee10: 2022 4353 4622 5d5d 290a 0a20 2020 2020   "CSF"]])..     
-0002ee20: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
-0002ee30: 2020 6465 6620 5f61 7070 6c79 4e65 7745    def _applyNewE
-0002ee40: 7665 6e74 7328 7365 6c66 293a 0a20 2020  vents(self):.   
-0002ee50: 2020 2020 2069 6620 7365 6c66 2e68 2069       if self.h i
-0002ee60: 7320 4e6f 6e65 206f 7220 7365 6c66 2e68  s None or self.h
-0002ee70: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
-0002ee80: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0002ee90: 2020 2020 2320 6465 6275 6720 3d20 4661      # debug = Fa
-0002eea0: 6c73 650a 2020 2020 2020 2020 2320 6465  lse.        # de
-0002eeb0: 6275 6720 3d20 5472 7565 0a0a 2020 2020  bug = True..    
-0002eec0: 2020 2020 685f 6d6f 6469 6669 6564 203d      h_modified =
-0002eed0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0002eee0: 6c6f 675f 6d73 6720 3d20 6622 504d 3a3a  log_msg = f"PM::
-0002eef0: 5f61 7070 6c79 4e65 7745 7665 6e74 7328  _applyNewEvents(
-0002ef00: 292d 7b73 656c 662e 6973 7472 7d22 0a20  )-{self.istr}". 
-0002ef10: 2020 2020 2020 2069 6620 7966 636c 2e49         if yfcl.I
-0002ef20: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
-0002ef30: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
-0002ef40: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
-0002ef50: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
-0002ef60: 2023 2042 6163 6b70 6f72 7420 6e65 7720   # Backport new 
-0002ef70: 7370 6c69 7473 2061 6372 6f73 7320 656e  splits across en
-0002ef80: 7469 7265 2068 2074 6162 6c65 0a20 2020  tire h table.   
-0002ef90: 2020 2020 206c 6173 7453 706c 6974 4164       lastSplitAd
-0002efa0: 6a75 7374 4474 5f6d 696e 203d 2073 656c  justDt_min = sel
-0002efb0: 662e 685b 224c 6173 7453 706c 6974 4164  f.h["LastSplitAd
-0002efc0: 6a75 7374 4474 225d 2e6d 696e 2829 0a20  justDt"].min(). 
-0002efd0: 2020 2020 2020 2073 706c 6974 735f 7369         splits_si
-0002efe0: 6e63 6520 3d20 7365 6c66 2e6d 616e 6167  nce = self.manag
-0002eff0: 6572 2e47 6574 4869 7374 6f72 7928 2245  er.GetHistory("E
-0002f000: 7665 6e74 7322 292e 4765 7453 706c 6974  vents").GetSplit
-0002f010: 7346 6574 6368 6564 5369 6e63 6528 6c61  sFetchedSince(la
-0002f020: 7374 5370 6c69 7441 646a 7573 7444 745f  stSplitAdjustDt_
-0002f030: 6d69 6e29 0a20 2020 2020 2020 2069 6620  min).        if 
-0002f040: 7370 6c69 7473 5f73 696e 6365 2069 7320  splits_since is 
-0002f050: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
-0002f060: 2073 706c 6974 735f 7369 6e63 652e 656d   splits_since.em
-0002f070: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-0002f080: 2066 5f73 7570 203d 2073 706c 6974 735f   f_sup = splits_
-0002f090: 7369 6e63 655b 2253 7570 6572 7365 6465  since["Supersede
-0002f0a0: 6420 7370 6c69 7422 5d20 213d 2030 2e30  d split"] != 0.0
-0002f0b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002f0c0: 665f 7375 702e 616e 7928 293a 0a20 2020  f_sup.any():.   
-0002f0d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002f0e0: 2064 7420 696e 2073 706c 6974 735f 7369   dt in splits_si
-0002f0f0: 6e63 652e 696e 6465 785b 665f 7375 705d  nce.index[f_sup]
-0002f100: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f110: 2020 2020 2020 7370 6c69 7420 3d20 7370        split = sp
-0002f120: 6c69 7473 5f73 696e 6365 2e6c 6f63 5b64  lits_since.loc[d
-0002f130: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
-0002f140: 2020 2020 2020 2066 3120 3d20 7365 6c66         f1 = self
-0002f150: 2e68 2e69 6e64 6578 203c 2064 740a 2020  .h.index < dt.  
-0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f170: 2020 6469 6666 3120 3d20 2873 656c 662e    diff1 = (self.
-0002f180: 685b 224c 6173 7453 706c 6974 4164 6a75  h["LastSplitAdju
-0002f190: 7374 4474 225d 202d 2073 706c 6974 5b22  stDt"] - split["
-0002f1a0: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
-0002f1b0: 2046 6574 6368 4461 7465 225d 292e 6162   FetchDate"]).ab
-0002f1c0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0002f1d0: 2020 2020 2020 2020 6632 203d 2028 6469          f2 = (di
-0002f1e0: 6666 3120 3c20 7064 2e54 696d 6564 656c  ff1 < pd.Timedel
-0002f1f0: 7461 2822 3135 7322 2929 2e74 6f5f 6e75  ta("15s")).to_nu
-0002f200: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-0002f210: 2020 2020 2020 2020 2020 6469 6666 3220            diff2 
-0002f220: 3d20 2873 656c 662e 685b 2246 6574 6368  = (self.h["Fetch
-0002f230: 4461 7465 225d 202d 2073 706c 6974 5b22  Date"] - split["
-0002f240: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
-0002f250: 2046 6574 6368 4461 7465 225d 292e 6162   FetchDate"]).ab
-0002f260: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0002f270: 2020 2020 2020 2020 6633 203d 2028 6469          f3 = (di
-0002f280: 6666 3220 3c20 7064 2e54 696d 6564 656c  ff2 < pd.Timedel
-0002f290: 7461 2822 3135 7322 2929 2e74 6f5f 6e75  ta("15s")).to_nu
-0002f2a0: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-0002f2b0: 2020 2020 2020 2020 2020 6620 3d20 6631            f = f1
-0002f2c0: 2026 2028 6632 207c 2066 3329 0a20 2020   & (f2 | f3).   
-0002f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2e0: 2069 6620 6e6f 7420 662e 616e 7928 293a   if not f.any():
-0002f2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f300: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0002f310: 2e69 6e74 6572 7661 6c20 213d 2079 6663  .interval != yfc
-0002f320: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
-0002f330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f340: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002f350: 5072 6f62 6162 6c79 206f 6b2c 2061 7373  Probably ok, ass
-0002f360: 756d 696e 6720 7375 7065 7273 6564 6564  uming superseded
-0002f370: 2073 706c 6974 2077 6173 206e 6576 6572   split was never
-0002f380: 2061 7070 6c69 6564 2074 6f20 7468 6973   applied to this
-0002f390: 2070 7269 6365 2064 6174 610a 2020 2020   price data.    
-0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3b0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0002f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f3d0: 2020 2020 2020 2020 2070 7269 6e74 2873           print(s
-0002f3e0: 706c 6974 290a 2020 2020 2020 2020 2020  plit).          
-0002f3f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0002f400: 6973 6520 4578 6365 7074 696f 6e28 2246  ise Exception("F
-0002f410: 6f72 2073 7570 6572 7365 6465 6420 7370  or superseded sp
-0002f420: 6c69 7420 6162 6f76 652c 2066 6169 6c65  lit above, faile
-0002f430: 6420 746f 2069 6465 6e74 6966 7920 726f  d to identify ro
-0002f440: 7773 2074 6f20 756e 646f 2e20 5072 6f62  ws to undo. Prob
-0002f450: 6c65 6d3f 2229 0a20 2020 2020 2020 2020  lem?").         
-0002f460: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002f470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f480: 2020 2020 2020 2020 2023 204e 6578 7420           # Next 
-0002f490: 6368 6563 6b3a 2065 7870 6563 7420 6361  check: expect ca
-0002f4a0: 6368 6564 2043 5346 2021 3d20 312e 300a  ched CSF != 1.0.
-0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4c0: 2020 2020 2020 2020 6631 203d 2073 656c          f1 = sel
-0002f4d0: 662e 682e 6c6f 635b 662c 2022 4353 4622  f.h.loc[f, "CSF"
-0002f4e0: 5d20 3d3d 2031 2e30 0a20 2020 2020 2020  ] == 1.0.       
+0002a8b0: 2020 2020 2020 665f 636f 7272 6563 7465        f_correcte
+0002a8c0: 645b 725b 305d 3a72 5b31 5d5d 203d 2054  d[r[0]:r[1]] = T
+0002a8d0: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
+0002a8e0: 2069 6620 636f 7272 6563 745f 766f 6c75   if correct_volu
+0002a8f0: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
+0002a900: 2020 2020 665f 6f70 656e 5f61 6e64 5f63      f_open_and_c
+0002a910: 6c6f 7365 645f 6669 7865 6420 3d20 665f  losed_fixed = f_
+0002a920: 6f70 656e 5f66 6978 6564 2026 2066 5f63  open_fixed & f_c
+0002a930: 6c6f 7365 5f66 6978 6564 0a20 2020 2020  lose_fixed.     
+0002a940: 2020 2020 2020 2020 2020 2066 5f6f 7065             f_ope
+0002a950: 6e5f 786f 725f 636c 6f73 6564 5f66 6978  n_xor_closed_fix
+0002a960: 6564 203d 206e 702e 6c6f 6769 6361 6c5f  ed = np.logical_
+0002a970: 786f 7228 665f 6f70 656e 5f66 6978 6564  xor(f_open_fixed
+0002a980: 2c20 665f 636c 6f73 655f 6669 7865 6429  , f_close_fixed)
+0002a990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a9a0: 2069 6620 665f 6f70 656e 5f61 6e64 5f63   if f_open_and_c
+0002a9b0: 6c6f 7365 645f 6669 7865 642e 616e 7928  losed_fixed.any(
+0002a9c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002a9d0: 2020 2020 2020 2064 6632 2e6c 6f63 5b66         df2.loc[f
+0002a9e0: 5f6f 7065 6e5f 616e 645f 636c 6f73 6564  _open_and_closed
+0002a9f0: 5f66 6978 6564 2c20 2256 6f6c 756d 6522  _fixed, "Volume"
+0002aa00: 5d20 2a3d 206d 5f72 6370 0a20 2020 2020  ] *= m_rcp.     
+0002aa10: 2020 2020 2020 2020 2020 2069 6620 665f             if f_
+0002aa20: 6f70 656e 5f78 6f72 5f63 6c6f 7365 645f  open_xor_closed_
+0002aa30: 6669 7865 642e 616e 7928 293a 0a20 2020  fixed.any():.   
+0002aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa50: 2064 6632 2e6c 6f63 5b66 5f6f 7065 6e5f   df2.loc[f_open_
+0002aa60: 786f 725f 636c 6f73 6564 5f66 6978 6564  xor_closed_fixed
+0002aa70: 2c20 2256 6f6c 756d 6522 5d20 2a3d 2030  , "Volume"] *= 0
+0002aa80: 2e35 202a 206d 5f72 6370 0a0a 2020 2020  .5 * m_rcp..    
+0002aa90: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
+0002aaa0: 665f 636f 7272 6563 7465 642c 2027 5265  f_corrected, 'Re
+0002aab0: 7061 6972 6564 3f27 5d20 3d20 5472 7565  paired?'] = True
+0002aac0: 0a0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
+0002aad0: 2020 2020 2020 2020 2020 2020 6964 785f              idx_
+0002aae0: 6669 7273 745f 6620 3d20 6e70 2e77 6865  first_f = np.whe
+0002aaf0: 7265 2866 295b 305d 5b30 5d0a 2020 2020  re(f)[0][0].    
+0002ab00: 2020 2020 2020 2020 6966 2061 7070 6561          if appea
+0002ab10: 7273 5f73 7573 7065 6e64 6564 2061 6e64  rs_suspended and
+0002ab20: 2028 6964 785f 6c61 7465 7374 5f61 6374   (idx_latest_act
+0002ab30: 6976 6520 6973 206e 6f74 204e 6f6e 6520  ive is not None 
+0002ab40: 616e 6420 6964 785f 6c61 7465 7374 5f61  and idx_latest_a
+0002ab50: 6374 6976 6520 3e3d 2069 6478 5f66 6972  ctive >= idx_fir
+0002ab60: 7374 5f66 293a 0a20 2020 2020 2020 2020  st_f):.         
+0002ab70: 2020 2020 2020 2023 2053 7573 7065 6e64         # Suspend
+0002ab80: 6564 206d 6964 7761 7920 6475 7269 6e67  ed midway during
+0002ab90: 2064 6174 6120 6461 7465 2072 616e 6765   data date range
+0002aba0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002abb0: 2020 2320 313a 2070 726f 6365 7373 2064    # 1: process d
+0002abc0: 6174 6120 6265 666f 7265 2073 7573 7065  ata before suspe
+0002abd0: 6e73 696f 6e20 696e 2069 6e64 6578 2d61  nsion in index-a
+0002abe0: 7363 656e 6469 6e67 2028 6461 7465 2d64  scending (date-d
+0002abf0: 6573 6365 6e64 696e 6729 206f 7264 6572  escending) order
+0002ac00: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002ac10: 2020 2320 323a 2070 726f 6365 7373 2064    # 2: process d
+0002ac20: 6174 6120 6166 7465 7220 7375 7370 656e  ata after suspen
+0002ac30: 7369 6f6e 2069 6e20 696e 6465 782d 6465  sion in index-de
+0002ac40: 7363 656e 6469 6e67 206f 7264 6572 2e20  scending order. 
+0002ac50: 5265 7175 6972 6573 2073 6967 6e61 6c73  Requires signals
+0002ac60: 2074 6f20 6265 2072 6576 6572 7365 642c   to be reversed,
+0002ac70: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0002ac80: 2020 2320 2020 2074 6865 6e20 7265 7475    #    then retu
+0002ac90: 726e 6564 2072 616e 6765 7320 746f 2061  rned ranges to a
+0002aca0: 6c73 6f20 6265 2072 6576 6572 7365 642c  lso be reversed,
+0002acb0: 2062 6563 6175 7365 2074 6869 7320 6c6f   because this lo
+0002acc0: 6769 6320 7761 7320 6f72 6967 696e 616c  gic was original
+0002acd0: 6c79 2077 7269 7474 656e 2066 6f72 0a20  ly written for. 
+0002ace0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002acf0: 2020 2020 696e 6465 782d 6173 6365 6e64      index-ascend
+0002ad00: 696e 6720 2864 6174 652d 6465 7363 656e  ing (date-descen
+0002ad10: 6469 6e67 2920 6f72 6465 722e 0a20 2020  ding) order..   
+0002ad20: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+0002ad30: 6765 735f 6265 666f 7265 203d 206d 6170  ges_before = map
+0002ad40: 5f73 6967 6e61 6c73 5f74 6f5f 7261 6e67  _signals_to_rang
+0002ad50: 6573 2866 5b69 6478 5f6c 6174 6573 745f  es(f[idx_latest_
+0002ad60: 6163 7469 7665 3a5d 2c20 665f 7570 5b69  active:], f_up[i
+0002ad70: 6478 5f6c 6174 6573 745f 6163 7469 7665  dx_latest_active
+0002ad80: 3a5d 2c20 665f 646f 776e 5b69 6478 5f6c  :], f_down[idx_l
+0002ad90: 6174 6573 745f 6163 7469 7665 3a5d 290a  atest_active:]).
+0002ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002adb0: 6966 206c 656e 2872 616e 6765 735f 6265  if len(ranges_be
+0002adc0: 666f 7265 2920 3e20 303a 0a20 2020 2020  fore) > 0:.     
+0002add0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002ade0: 2053 6869 6674 2065 6163 6820 7261 6e67   Shift each rang
+0002adf0: 6520 6261 636b 2074 6f20 676c 6f62 616c  e back to global
+0002ae00: 2069 6e64 6578 696e 670a 2020 2020 2020   indexing.      
+0002ae10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002ae20: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+0002ae30: 2872 616e 6765 735f 6265 666f 7265 2929  (ranges_before))
+0002ae40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ae50: 2020 2020 2020 2020 2020 7220 3d20 7261            r = ra
+0002ae60: 6e67 6573 5f62 6566 6f72 655b 695d 0a20  nges_before[i]. 
+0002ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae80: 2020 2020 2020 2072 616e 6765 735f 6265         ranges_be
+0002ae90: 666f 7265 5b69 5d20 3d20 2872 5b30 5d20  fore[i] = (r[0] 
+0002aea0: 2b20 6964 785f 6c61 7465 7374 5f61 6374  + idx_latest_act
+0002aeb0: 6976 652c 2072 5b31 5d20 2b20 6964 785f  ive, r[1] + idx_
+0002aec0: 6c61 7465 7374 5f61 6374 6976 652c 2072  latest_active, r
+0002aed0: 5b32 5d29 0a20 2020 2020 2020 2020 2020  [2]).           
+0002aee0: 2020 2020 2066 5f72 6576 5f64 6f77 6e20       f_rev_down 
+0002aef0: 3d20 6e70 2e66 6c69 7028 6e70 2e72 6f6c  = np.flip(np.rol
+0002af00: 6c28 665f 7570 2c20 2d31 2929 0a20 2020  l(f_up, -1)).   
+0002af10: 2020 2020 2020 2020 2020 2020 2066 5f72               f_r
+0002af20: 6576 5f75 7020 3d20 6e70 2e66 6c69 7028  ev_up = np.flip(
+0002af30: 6e70 2e72 6f6c 6c28 665f 646f 776e 2c20  np.roll(f_down, 
+0002af40: 2d31 2929 0a20 2020 2020 2020 2020 2020  -1)).           
+0002af50: 2020 2020 2066 5f72 6576 203d 2066 5f72       f_rev = f_r
+0002af60: 6576 5f75 7020 7c20 665f 7265 765f 646f  ev_up | f_rev_do
+0002af70: 776e 0a20 2020 2020 2020 2020 2020 2020  wn.             
+0002af80: 2020 2072 616e 6765 735f 6166 7465 7220     ranges_after 
+0002af90: 3d20 6d61 705f 7369 676e 616c 735f 746f  = map_signals_to
+0002afa0: 5f72 616e 6765 7328 665f 7265 765b 6964  _ranges(f_rev[id
+0002afb0: 785f 7265 765f 6c61 7465 7374 5f61 6374  x_rev_latest_act
+0002afc0: 6976 653a 5d2c 2066 5f72 6576 5f75 705b  ive:], f_rev_up[
+0002afd0: 6964 785f 7265 765f 6c61 7465 7374 5f61  idx_rev_latest_a
+0002afe0: 6374 6976 653a 5d2c 2066 5f72 6576 5f64  ctive:], f_rev_d
+0002aff0: 6f77 6e5b 6964 785f 7265 765f 6c61 7465  own[idx_rev_late
+0002b000: 7374 5f61 6374 6976 653a 5d29 0a20 2020  st_active:]).   
+0002b010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002b020: 6c65 6e28 7261 6e67 6573 5f61 6674 6572  len(ranges_after
+0002b030: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+0002b040: 2020 2020 2020 2020 2020 2023 2053 6869             # Shi
+0002b050: 6674 2065 6163 6820 7261 6e67 6520 6261  ft each range ba
+0002b060: 636b 2074 6f20 676c 6f62 616c 2069 6e64  ck to global ind
+0002b070: 6578 696e 673a 0a20 2020 2020 2020 2020  exing:.         
+0002b080: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0002b090: 2069 6e20 7261 6e67 6528 6c65 6e28 7261   in range(len(ra
+0002b0a0: 6e67 6573 5f61 6674 6572 2929 3a0a 2020  nges_after)):.  
+0002b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0c0: 2020 2020 2020 7220 3d20 7261 6e67 6573        r = ranges
+0002b0d0: 5f61 6674 6572 5b69 5d0a 2020 2020 2020  _after[i].      
+0002b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0f0: 2020 7261 6e67 6573 5f61 6674 6572 5b69    ranges_after[i
+0002b100: 5d20 3d20 2872 5b30 5d20 2b20 6964 785f  ] = (r[0] + idx_
+0002b110: 7265 765f 6c61 7465 7374 5f61 6374 6976  rev_latest_activ
+0002b120: 652c 2072 5b31 5d20 2b20 6964 785f 7265  e, r[1] + idx_re
+0002b130: 765f 6c61 7465 7374 5f61 6374 6976 652c  v_latest_active,
+0002b140: 2072 5b32 5d29 0a20 2020 2020 2020 2020   r[2]).         
+0002b150: 2020 2020 2020 2020 2020 2023 2046 6c69             # Fli
+0002b160: 7020 7261 6e67 6520 746f 206e 6f72 6d61  p range to norma
+0002b170: 6c20 6f72 6465 7269 6e67 0a20 2020 2020  l ordering.     
+0002b180: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002b190: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+0002b1a0: 6e28 7261 6e67 6573 5f61 6674 6572 2929  n(ranges_after))
+0002b1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b1c0: 2020 2020 2020 2020 2020 7220 3d20 7261            r = ra
+0002b1d0: 6e67 6573 5f61 6674 6572 5b69 5d0a 2020  nges_after[i].  
+0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1f0: 2020 2020 2020 7261 6e67 6573 5f61 6674        ranges_aft
+0002b200: 6572 5b69 5d20 3d20 286e 2d72 5b31 5d2c  er[i] = (n-r[1],
+0002b210: 206e 2d72 5b30 5d2c 2072 5b32 5d29 0a20   n-r[0], r[2]). 
+0002b220: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002b230: 616e 6765 7320 3d20 7261 6e67 6573 5f62  anges = ranges_b
+0002b240: 6566 6f72 6520 3b20 7261 6e67 6573 2e65  efore ; ranges.e
+0002b250: 7874 656e 6428 7261 6e67 6573 5f61 6674  xtend(ranges_aft
+0002b260: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+0002b270: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002b280: 2020 2020 2020 7261 6e67 6573 203d 206d        ranges = m
+0002b290: 6170 5f73 6967 6e61 6c73 5f74 6f5f 7261  ap_signals_to_ra
+0002b2a0: 6e67 6573 2866 2c20 665f 7570 2c20 665f  nges(f, f_up, f_
+0002b2b0: 646f 776e 290a 2020 2020 2020 2020 2020  down).          
+0002b2c0: 2020 6966 2073 7461 7274 5f6d 696e 2069    if start_min i
+0002b2d0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0002b2e0: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
+0002b2f0: 756e 6520 7261 6e67 6573 2074 6861 7420  une ranges that 
+0002b300: 6172 6520 6f6c 6465 7220 7468 616e 2073  are older than s
+0002b310: 7461 7274 5f6d 696e 0a20 2020 2020 2020  tart_min.       
+0002b320: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+0002b330: 6e20 7261 6e67 6528 6c65 6e28 7261 6e67  n range(len(rang
+0002b340: 6573 292d 312c 202d 312c 202d 3129 3a0a  es)-1, -1, -1):.
+0002b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b360: 2020 2020 7220 3d20 7261 6e67 6573 5b69      r = ranges[i
+0002b370: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0002b380: 2020 2020 2020 6966 2064 6632 2e69 6e64        if df2.ind
+0002b390: 6578 5b72 5b30 5d5d 2e64 6174 6528 2920  ex[r[0]].date() 
+0002b3a0: 3c20 7374 6172 745f 6d69 6e3a 0a20 2020  < start_min:.   
+0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3c0: 2020 2020 206d 7367 203d 2066 2770 7269       msg = f'pri
+0002b3d0: 6365 2d72 6570 6169 722d 7370 6c69 743a  ce-repair-split:
+0002b3e0: 2050 7275 6e69 6e67 2072 616e 6765 207b   Pruning range {
+0002b3f0: 6466 322e 696e 6465 785b 725b 305d 5d7d  df2.index[r[0]]}
+0002b400: 2d3e 7b64 6632 2e69 6e64 6578 5b72 5b31  ->{df2.index[r[1
+0002b410: 5d2d 315d 7d20 6265 6361 7573 6520 746f  ]-1]} because to
+0002b420: 6f20 6f6c 642e 270a 2020 2020 2020 2020  o old.'.        
+0002b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b440: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
+0002b450: 4576 656e 7428 2764 6562 7567 272c 2027  Event('debug', '
+0002b460: 7072 6963 652d 7265 7061 6972 2d73 706c  price-repair-spl
+0002b470: 6974 2d27 2b73 656c 662e 6973 7472 2c20  it-'+self.istr, 
+0002b480: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0002b490: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0002b4a0: 2072 616e 6765 735b 695d 0a20 2020 2020   ranges[i].     
+0002b4b0: 2020 2020 2020 2066 6f72 2072 2069 6e20         for r in 
+0002b4c0: 7261 6e67 6573 3a0a 2020 2020 2020 2020  ranges:.        
+0002b4d0: 2020 2020 2020 2020 6966 2072 5b32 5d20          if r[2] 
+0002b4e0: 3d3d 2027 7370 6c69 7427 3a0a 2020 2020  == 'split':.    
+0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b500: 6d20 3d20 7370 6c69 7420 3b20 6d5f 7263  m = split ; m_rc
+0002b510: 7020 3d20 7370 6c69 745f 7263 700a 2020  p = split_rcp.  
+0002b520: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002b530: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002b540: 2020 2020 2020 2020 6d20 3d20 7370 6c69          m = spli
+0002b550: 745f 7263 7020 3b20 6d5f 7263 7020 3d20  t_rcp ; m_rcp = 
+0002b560: 7370 6c69 740a 2020 2020 2020 2020 2020  split.          
+0002b570: 2020 2020 2020 6d73 6720 3d20 6622 7072        msg = f"pr
+0002b580: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
+0002b590: 3a20 7261 6e67 653d 7b72 7d20 6d3d 7b6d  : range={r} m={m
+0002b5a0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0002b5b0: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
+0002b5c0: 4c6f 6745 7665 6e74 2827 6465 6275 6727  LogEvent('debug'
+0002b5d0: 2c20 2770 7269 6365 2d72 6570 6169 722d  , 'price-repair-
+0002b5e0: 7370 6c69 742d 272b 7365 6c66 2e69 7374  split-'+self.ist
+0002b5f0: 722c 206d 7367 290a 2020 2020 2020 2020  r, msg).        
+0002b600: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
+0002b610: 205b 274f 7065 6e27 2c20 2748 6967 6827   ['Open', 'High'
+0002b620: 2c20 274c 6f77 272c 2027 436c 6f73 6527  , 'Low', 'Close'
+0002b630: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0002b640: 2020 2020 2020 2064 6632 2e69 6c6f 635b         df2.iloc[
+0002b650: 725b 305d 3a72 5b31 5d2c 2064 6632 2e63  r[0]:r[1], df2.c
+0002b660: 6f6c 756d 6e73 2e67 6574 5f6c 6f63 2863  olumns.get_loc(c
+0002b670: 295d 202a 3d20 6d0a 2020 2020 2020 2020  )] *= m.        
+0002b680: 2020 2020 2020 2020 6966 2063 6f72 7265          if corre
+0002b690: 6374 5f76 6f6c 756d 653a 0a20 2020 2020  ct_volume:.     
+0002b6a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002b6b0: 6632 2e69 6c6f 635b 725b 305d 3a72 5b31  f2.iloc[r[0]:r[1
+0002b6c0: 5d2c 2064 6632 2e63 6f6c 756d 6e73 2e67  ], df2.columns.g
+0002b6d0: 6574 5f6c 6f63 2822 566f 6c75 6d65 2229  et_loc("Volume")
+0002b6e0: 5d20 2a3d 206d 5f72 6370 0a20 2020 2020  ] *= m_rcp.     
+0002b6f0: 2020 2020 2020 2020 2020 2064 6632 2e69             df2.i
+0002b700: 6c6f 635b 725b 305d 3a72 5b31 5d2c 2064  loc[r[0]:r[1], d
+0002b710: 6632 2e63 6f6c 756d 6e73 2e67 6574 5f6c  f2.columns.get_l
+0002b720: 6f63 2827 5265 7061 6972 6564 3f27 295d  oc('Repaired?')]
+0002b730: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0002b740: 2020 2020 2020 2020 6966 2072 5b30 5d20          if r[0] 
+0002b750: 3d3d 2072 5b31 5d20 2d20 313a 0a20 2020  == r[1] - 1:.   
+0002b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b770: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+0002b780: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002b790: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+0002b7a0: 2066 2243 6f72 7265 6374 6564 2062 6164   f"Corrected bad
+0002b7b0: 2073 706c 6974 2061 646a 7573 746d 656e   split adjustmen
+0002b7c0: 7420 6f6e 2069 6e74 6572 7661 6c20 7b64  t on interval {d
+0002b7d0: 6632 2e69 6e64 6578 5b72 5b30 5d5d 2e64  f2.index[r[0]].d
+0002b7e0: 6174 6528 297d 206d 3d7b 6d3a 2e34 667d  ate()} m={m:.4f}
+0002b7f0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002b800: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b820: 2020 2020 6d73 6720 3d20 6622 436f 7272      msg = f"Corr
+0002b830: 6563 7465 6420 6261 6420 7370 6c69 7420  ected bad split 
+0002b840: 6164 6a75 7374 6d65 6e74 206f 6e20 696e  adjustment on in
+0002b850: 7465 7276 616c 207b 6466 322e 696e 6465  terval {df2.inde
+0002b860: 785b 725b 305d 5d7d 206d 3d7b 6d3a 2e34  x[r[0]]} m={m:.4
+0002b870: 667d 220a 2020 2020 2020 2020 2020 2020  f}".            
+0002b880: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002b890: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0002b8a0: 4e6f 7465 3a20 6466 3220 736f 7274 6564  Note: df2 sorted
+0002b8b0: 2077 6974 6820 696e 6465 7820 6465 7363   with index desc
+0002b8c0: 656e 6469 6e67 0a20 2020 2020 2020 2020  ending.         
+0002b8d0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+0002b8e0: 203d 2064 6632 2e69 6e64 6578 5b72 5b31   = df2.index[r[1
+0002b8f0: 5d20 2d20 315d 0a20 2020 2020 2020 2020  ] - 1].         
+0002b900: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
+0002b910: 2064 6632 2e69 6e64 6578 5b72 5b30 5d5d   df2.index[r[0]]
+0002b920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b930: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+0002b940: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+0002b950: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002b960: 7367 203d 2066 2243 6f72 7265 6374 6564  sg = f"Corrected
+0002b970: 2062 6164 2073 706c 6974 2061 646a 7573   bad split adjus
+0002b980: 746d 656e 7420 6163 726f 7373 2069 6e74  tment across int
+0002b990: 6572 7661 6c73 207b 7374 6172 742e 6461  ervals {start.da
+0002b9a0: 7465 2829 7d20 2d3e 207b 656e 642e 6461  te()} -> {end.da
+0002b9b0: 7465 2829 7d20 2869 6e63 6c75 7369 7665  te()} (inclusive
+0002b9c0: 2920 6d3d 7b6d 3a2e 3466 7d22 0a20 2020  ) m={m:.4f}".   
+0002b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b9e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002b9f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0002ba00: 7367 203d 2066 2243 6f72 7265 6374 6564  sg = f"Corrected
+0002ba10: 2062 6164 2073 706c 6974 2061 646a 7573   bad split adjus
+0002ba20: 746d 656e 7420 6163 726f 7373 2069 6e74  tment across int
+0002ba30: 6572 7661 6c73 207b 7374 6172 747d 202d  ervals {start} -
+0002ba40: 3e20 7b65 6e64 7d20 2869 6e63 6c75 7369  > {end} (inclusi
+0002ba50: 7665 2920 6d3d 7b6d 3a2e 3466 7d22 0a20  ve) m={m:.4f}". 
+0002ba60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002ba70: 656c 662e 6d61 6e61 6765 722e 4c6f 6745  elf.manager.LogE
+0002ba80: 7665 6e74 2827 696e 666f 272c 2027 7072  vent('info', 'pr
+0002ba90: 6963 652d 7265 7061 6972 2d73 706c 6974  ice-repair-split
+0002baa0: 2d27 2b73 656c 662e 6973 7472 2c20 6d73  -'+self.istr, ms
+0002bab0: 6729 0a0a 2020 2020 2020 2020 6966 2063  g)..        if c
+0002bac0: 6f72 7265 6374 5f76 6f6c 756d 653a 0a20  orrect_volume:. 
+0002bad0: 2020 2020 2020 2020 2020 2064 6632 5b27             df2['
+0002bae0: 566f 6c75 6d65 275d 203d 2064 6632 5b27  Volume'] = df2['
+0002baf0: 566f 6c75 6d65 275d 2e72 6f75 6e64 2830  Volume'].round(0
+0002bb00: 292e 6173 7479 7065 2827 696e 7427 290a  ).astype('int').
+0002bb10: 0a20 2020 2020 2020 2079 6663 6c2e 5472  .        yfcl.Tr
+0002bb20: 6163 6545 7869 7428 6c6f 675f 6675 6e63  aceExit(log_func
+0002bb30: 202b 2022 2072 6574 7572 6e69 6e67 2229   + " returning")
+0002bb40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002bb50: 6466 322e 736f 7274 5f69 6e64 6578 2829  df2.sort_index()
+0002bb60: 0a0a 2020 2020 6465 6620 5f72 6570 6169  ..    def _repai
+0002bb70: 725a 6572 6f50 7269 6365 7328 7365 6c66  rZeroPrices(self
+0002bb80: 2c20 6466 2c20 7369 6c65 6e74 3d46 616c  , df, silent=Fal
+0002bb90: 7365 293a 0a20 2020 2020 2020 2079 6663  se):.        yfc
+0002bba0: 752e 5479 7065 4368 6563 6b44 6174 6146  u.TypeCheckDataF
+0002bbb0: 7261 6d65 2864 662c 2022 6466 2229 0a0a  rame(df, "df")..
+0002bbc0: 2020 2020 2020 2020 2320 536f 6d65 7469          # Someti
+0002bbd0: 6d65 7320 5961 686f 6f20 7265 7475 726e  mes Yahoo return
+0002bbe0: 7320 7072 6963 6573 3d30 2077 6865 6e20  s prices=0 when 
+0002bbf0: 6f62 7669 6f75 736c 7920 7772 6f6e 6720  obviously wrong 
+0002bc00: 652e 672e 2056 6f6c 756d 6520 3e20 3020  e.g. Volume > 0 
+0002bc10: 616e 6420 436c 6f73 6520 3e20 302e 0a20  and Close > 0.. 
+0002bc20: 2020 2020 2020 2023 2045 6173 7920 746f         # Easy to
+0002bc30: 2064 6574 6563 7420 616e 6420 6669 780a   detect and fix.
+0002bc40: 0a20 2020 2020 2020 2069 6620 6466 2e65  .        if df.e
+0002bc50: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+0002bc60: 2020 7265 7475 726e 2064 660a 2020 2020    return df.    
+0002bc70: 2020 2020 6966 2064 662e 7368 6170 655b      if df.shape[
+0002bc80: 305d 203d 3d20 313a 0a20 2020 2020 2020  0] == 1:.       
+0002bc90: 2020 2020 2023 204e 6565 6420 6d75 6c74       # Need mult
+0002bca0: 6970 6c65 2072 6f77 7320 746f 2063 6f6e  iple rows to con
+0002bcb0: 6669 6465 6e74 6c79 2069 6465 6e74 6966  fidently identif
+0002bcc0: 7920 6f75 746c 6965 7273 0a20 2020 2020  y outliers.     
+0002bcd0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+0002bce0: 0a0a 2020 2020 2020 2020 6c6f 675f 6d73  ..        log_ms
+0002bcf0: 675f 656e 7465 7220 3d20 6622 504d 3a3a  g_enter = f"PM::
+0002bd00: 5f72 6570 6169 725a 6572 6f50 7269 6365  _repairZeroPrice
+0002bd10: 732d 7b73 656c 662e 6973 7472 7d28 6461  s-{self.istr}(da
+0002bd20: 7465 5f72 616e 6765 3d7b 6466 2e69 6e64  te_range={df.ind
+0002bd30: 6578 5b30 5d7d 2d3e 7b64 662e 696e 6465  ex[0]}->{df.inde
+0002bd40: 785b 2d31 5d2b 7365 6c66 2e69 7464 7d29  x[-1]+self.itd})
+0002bd50: 220a 2020 2020 2020 2020 6c6f 675f 6d73  ".        log_ms
+0002bd60: 675f 6578 6974 203d 2066 2250 4d3a 3a5f  g_exit = f"PM::_
+0002bd70: 7265 7061 6972 5a65 726f 5072 6963 6573  repairZeroPrices
+0002bd80: 2d7b 7365 6c66 2e69 7374 727d 2829 2072  -{self.istr}() r
+0002bd90: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
+0002bda0: 2020 7966 636c 2e54 7261 6365 456e 7465    yfcl.TraceEnte
+0002bdb0: 7228 6c6f 675f 6d73 675f 656e 7465 7229  r(log_msg_enter)
+0002bdc0: 0a0a 2020 2020 2020 2020 6466 3220 3d20  ..        df2 = 
+0002bdd0: 6466 2e63 6f70 7928 290a 0a20 2020 2020  df.copy()..     
+0002bde0: 2020 2070 7269 6365 5f63 6f6c 7320 3d20     price_cols = 
+0002bdf0: 5b63 2066 6f72 2063 2069 6e20 5b22 4f70  [c for c in ["Op
+0002be00: 656e 222c 2022 4869 6768 222c 2022 4c6f  en", "High", "Lo
+0002be10: 7722 2c20 2243 6c6f 7365 222c 2022 4164  w", "Close", "Ad
+0002be20: 6a20 436c 6f73 6522 5d20 6966 2063 2069  j Close"] if c i
+0002be30: 6e20 6466 322e 636f 6c75 6d6e 735d 0a20  n df2.columns]. 
+0002be40: 2020 2020 2020 2066 5f7a 6572 6f5f 6f72         f_zero_or
+0002be50: 5f6e 616e 203d 2028 6466 325b 7072 6963  _nan = (df2[pric
+0002be60: 655f 636f 6c73 5d20 3d3d 2030 2e30 292e  e_cols] == 0.0).
+0002be70: 746f 5f6e 756d 7079 2829 207c 2064 6632  to_numpy() | df2
+0002be80: 5b70 7269 6365 5f63 6f6c 735d 2e69 736e  [price_cols].isn
+0002be90: 6128 292e 746f 5f6e 756d 7079 2829 0a20  a().to_numpy(). 
+0002bea0: 2020 2020 2020 2023 2043 6865 636b 2077         # Check w
+0002beb0: 6865 7468 6572 2077 6f72 7468 2061 7474  hether worth att
+0002bec0: 656d 7074 696e 6720 7265 7061 6972 0a20  empting repair. 
+0002bed0: 2020 2020 2020 2069 6620 665f 7a65 726f         if f_zero
+0002bee0: 5f6f 725f 6e61 6e2e 616e 7928 6178 6973  _or_nan.any(axis
+0002bef0: 3d31 292e 7375 6d28 2920 3d3d 2030 3a0a  =1).sum() == 0:.
+0002bf00: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0002bf10: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+0002bf20: 7367 5f65 7869 7420 2b20 2220 286e 6f20  sg_exit + " (no 
+0002bf30: 6261 6420 6461 7461 2922 290a 2020 2020  bad data)").    
+0002bf40: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+0002bf50: 660a 2020 2020 2020 2020 6966 2066 5f7a  f.        if f_z
+0002bf60: 6572 6f5f 6f72 5f6e 616e 2e73 756d 2829  ero_or_nan.sum()
+0002bf70: 203d 3d20 6c65 6e28 7072 6963 655f 636f   == len(price_co
+0002bf80: 6c73 292a 6c65 6e28 6466 3229 3a0a 2020  ls)*len(df2):.  
+0002bf90: 2020 2020 2020 2020 2020 2320 4e65 6564            # Need
+0002bfa0: 2073 6f6d 6520 676f 6f64 2064 6174 6120   some good data 
+0002bfb0: 746f 2063 616c 6962 7261 7465 0a20 2020  to calibrate.   
+0002bfc0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
+0002bfd0: 6163 6545 7869 7428 6c6f 675f 6d73 675f  aceExit(log_msg_
+0002bfe0: 6578 6974 202b 2022 2028 696e 7375 6666  exit + " (insuff
+0002bff0: 6963 6965 6e74 2063 616c 6962 7261 7469  icient calibrati
+0002c000: 6f6e 2064 6174 6129 2229 0a20 2020 2020  on data)").     
+0002c010: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+0002c020: 0a20 2020 2020 2020 2023 202d 2061 766f  .        # - avo
+0002c030: 6964 2072 6570 6169 7220 6966 206d 616e  id repair if man
+0002c040: 7920 7a65 726f 6573 2f4e 614e 730a 2020  y zeroes/NaNs.  
+0002c050: 2020 2020 2020 7063 745f 7a65 726f 5f6f        pct_zero_o
+0002c060: 725f 6e61 6e20 3d20 665f 7a65 726f 5f6f  r_nan = f_zero_o
+0002c070: 725f 6e61 6e2e 7375 6d28 2920 2f20 286c  r_nan.sum() / (l
+0002c080: 656e 2870 7269 6365 5f63 6f6c 7329 2a6c  en(price_cols)*l
+0002c090: 656e 2864 6632 2929 0a20 2020 2020 2020  en(df2)).       
+0002c0a0: 2069 6620 665f 7a65 726f 5f6f 725f 6e61   if f_zero_or_na
+0002c0b0: 6e2e 616e 7928 6178 6973 3d31 292e 7375  n.any(axis=1).su
+0002c0c0: 6d28 2920 3e20 3220 616e 6420 7063 745f  m() > 2 and pct_
+0002c0d0: 7a65 726f 5f6f 725f 6e61 6e20 3e20 302e  zero_or_nan > 0.
+0002c0e0: 3035 3a0a 2020 2020 2020 2020 2020 2020  05:.            
+0002c0f0: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
+0002c100: 6f67 5f6d 7367 5f65 7869 7420 2b20 2220  og_msg_exit + " 
+0002c110: 2874 6f6f 206d 7563 6820 6261 6420 6461  (too much bad da
+0002c120: 7461 2922 290a 2020 2020 2020 2020 2020  ta)").          
+0002c130: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
+0002c140: 2020 2020 2064 6174 615f 636f 6c73 203d       data_cols =
+0002c150: 2070 7269 6365 5f63 6f6c 7320 2b20 5b22   price_cols + ["
+0002c160: 566f 6c75 6d65 225d 0a0a 2020 2020 2020  Volume"]..      
+0002c170: 2020 2320 4d61 726b 2076 616c 7565 7320    # Mark values 
+0002c180: 746f 2073 656e 6420 666f 7220 7265 7061  to send for repa
+0002c190: 6972 0a20 2020 2020 2020 2074 6167 203d  ir.        tag =
+0002c1a0: 202d 312e 300a 2020 2020 2020 2020 666f   -1.0.        fo
+0002c1b0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+0002c1c0: 2870 7269 6365 5f63 6f6c 7329 293a 0a20  (price_cols)):. 
+0002c1d0: 2020 2020 2020 2020 2020 2063 203d 2070             c = p
+0002c1e0: 7269 6365 5f63 6f6c 735b 695d 0a20 2020  rice_cols[i].   
+0002c1f0: 2020 2020 2020 2020 2064 6632 2e6c 6f63           df2.loc
+0002c200: 5b66 5f7a 6572 6f5f 6f72 5f6e 616e 5b3a  [f_zero_or_nan[:
+0002c210: 2c20 695d 2c20 635d 203d 2074 6167 0a20  , i], c] = tag. 
+0002c220: 2020 2020 2020 2023 2049 6620 766f 6c75         # If volu
+0002c230: 6d65 3d30 206f 7220 4e61 4e20 666f 7220  me=0 or NaN for 
+0002c240: 6261 6420 7072 6963 6573 2c20 7468 656e  bad prices, then
+0002c250: 2074 6167 2076 6f6c 756d 6520 666f 7220   tag volume for 
+0002c260: 7265 7061 6972 0a20 2020 2020 2020 2069  repair.        i
+0002c270: 6620 7365 6c66 2e74 6963 6b65 722e 656e  f self.ticker.en
+0002c280: 6473 7769 7468 2822 3d58 2229 3a0a 2020  dswith("=X"):.  
+0002c290: 2020 2020 2020 2020 2020 2320 4658 2c20            # FX, 
+0002c2a0: 766f 6c75 6d65 2061 6c77 6179 7320 300a  volume always 0.
+0002c2b0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0002c2c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002c2d0: 2020 2020 2020 2020 2020 2064 6632 2e6c             df2.l
+0002c2e0: 6f63 5b66 5f7a 6572 6f5f 6f72 5f6e 616e  oc[f_zero_or_nan
+0002c2f0: 2e61 6e79 2861 7869 733d 3129 2026 2028  .any(axis=1) & (
+0002c300: 6466 325b 2256 6f6c 756d 6522 5d20 3d3d  df2["Volume"] ==
+0002c310: 2030 292c 2022 566f 6c75 6d65 225d 203d   0), "Volume"] =
+0002c320: 2074 6167 0a20 2020 2020 2020 2020 2020   tag.           
+0002c330: 2064 6632 2e6c 6f63 5b66 5f7a 6572 6f5f   df2.loc[f_zero_
+0002c340: 6f72 5f6e 616e 2e61 6e79 2861 7869 733d  or_nan.any(axis=
+0002c350: 3129 2026 2028 6466 325b 2256 6f6c 756d  1) & (df2["Volum
+0002c360: 6522 5d2e 6973 6e61 2829 292c 2022 566f  e"].isna()), "Vo
+0002c370: 6c75 6d65 225d 203d 2074 6167 0a0a 2020  lume"] = tag..  
+0002c380: 2020 2020 2020 2320 7072 696e 7428 6466        # print(df
+0002c390: 325b 665f 7a65 726f 5f6f 725f 6e61 6e2e  2[f_zero_or_nan.
+0002c3a0: 616e 7928 6178 6973 3d31 295d 290a 2020  any(axis=1)]).  
+0002c3b0: 2020 2020 2020 6e5f 6265 666f 7265 203d        n_before =
+0002c3c0: 2028 6466 325b 6461 7461 5f63 6f6c 735d   (df2[data_cols]
+0002c3d0: 2e74 6f5f 6e75 6d70 7928 2920 3d3d 2074  .to_numpy() == t
+0002c3e0: 6167 292e 7375 6d28 290a 2020 2020 2020  ag).sum().      
+0002c3f0: 2020 2320 7072 696e 7428 226e 5f62 6566    # print("n_bef
+0002c400: 6f72 6520 3d22 2c20 6e5f 6265 666f 7265  ore =", n_before
+0002c410: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+0002c420: 2020 2020 2020 2020 2020 2064 6632 203d             df2 =
+0002c430: 2073 656c 662e 5f72 6563 6f6e 7374 7275   self._reconstru
+0002c440: 6374 5f69 6e74 6572 7661 6c73 5f62 6174  ct_intervals_bat
+0002c450: 6368 2864 6632 2c20 7461 673d 7461 6729  ch(df2, tag=tag)
+0002c460: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0002c470: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+0002c480: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
+0002c490: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
+0002c4a0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+0002c4b0: 2020 2020 2020 7365 6c66 2e5f 7374 6163        self._stac
+0002c4c0: 6b5f 7472 6163 652e 706f 7028 6c65 6e28  k_trace.pop(len(
+0002c4d0: 7365 6c66 2e5f 7374 6163 6b5f 7472 6163  self._stack_trac
+0002c4e0: 6529 202d 2031 290a 2020 2020 2020 2020  e) - 1).        
+0002c4f0: 2020 2020 7261 6973 650a 2020 2020 2020      raise.      
+0002c500: 2020 6e5f 6166 7465 7220 3d20 2864 6632    n_after = (df2
+0002c510: 5b64 6174 615f 636f 6c73 5d2e 746f 5f6e  [data_cols].to_n
+0002c520: 756d 7079 2829 203d 3d20 7461 6729 2e73  umpy() == tag).s
+0002c530: 756d 2829 0a20 2020 2020 2020 206e 5f66  um().        n_f
+0002c540: 6978 6564 203d 206e 5f62 6566 6f72 6520  ixed = n_before 
+0002c550: 2d20 6e5f 6166 7465 720a 2020 2020 2020  - n_after.      
+0002c560: 2020 6d73 6720 3d20 6622 4669 7865 6420    msg = f"Fixed 
+0002c570: 7b6e 5f66 6978 6564 7d2f 7b6e 5f62 6566  {n_fixed}/{n_bef
+0002c580: 6f72 657d 2070 7269 6365 3d30 2e30 2065  ore} price=0.0 e
+0002c590: 7272 6f72 7320 696e 207b 7365 6c66 2e69  rrors in {self.i
+0002c5a0: 7374 727d 2070 7269 6365 2064 6174 6122  str} price data"
+0002c5b0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0002c5c0: 7369 6c65 6e74 2061 6e64 206e 5f66 6978  silent and n_fix
+0002c5d0: 6564 203e 2030 3a0a 2020 2020 2020 2020  ed > 0:.        
+0002c5e0: 2020 2020 7072 696e 7428 6622 7b73 656c      print(f"{sel
+0002c5f0: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
+0002c600: 7367 290a 2020 2020 2020 2020 656c 7365  sg).        else
+0002c610: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002c620: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
+0002c630: 656e 7428 2269 6e66 6f22 2c20 2250 7269  ent("info", "Pri
+0002c640: 6365 4d61 6e61 6765 7222 2c20 6d73 6729  ceManager", msg)
+0002c650: 0a0a 2020 2020 2020 2020 2320 5265 7374  ..        # Rest
+0002c660: 6f72 6520 6f72 6967 696e 616c 2076 616c  ore original val
+0002c670: 7565 7320 7768 6572 6520 7265 7061 6972  ues where repair
+0002c680: 2066 6169 6c65 6420 2869 2e65 2e20 7265   failed (i.e. re
+0002c690: 6d6f 7665 2074 6167 2076 616c 7565 7329  move tag values)
+0002c6a0: 0a20 2020 2020 2020 2066 203d 2064 6632  .        f = df2
+0002c6b0: 5b64 6174 615f 636f 6c73 5d2e 746f 5f6e  [data_cols].to_n
+0002c6c0: 756d 7079 2829 203d 3d20 7461 670a 2020  umpy() == tag.  
+0002c6d0: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+0002c6e0: 616e 6765 286c 656e 2864 6174 615f 636f  ange(len(data_co
+0002c6f0: 6c73 2929 3a0a 2020 2020 2020 2020 2020  ls)):.          
+0002c700: 2020 666a 203d 2066 5b3a 2c20 6a5d 0a20    fj = f[:, j]. 
+0002c710: 2020 2020 2020 2020 2020 2069 6620 666a             if fj
+0002c720: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+0002c730: 2020 2020 2020 2020 6320 3d20 6461 7461          c = data
+0002c740: 5f63 6f6c 735b 6a5d 0a20 2020 2020 2020  _cols[j].       
+0002c750: 2020 2020 2020 2020 2064 6632 2e6c 6f63           df2.loc
+0002c760: 5b66 6a2c 2063 5d20 3d20 6466 2e6c 6f63  [fj, c] = df.loc
+0002c770: 5b66 6a2c 2063 5d0a 0a20 2020 2020 2020  [fj, c]..       
+0002c780: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
+0002c790: 6c6f 675f 6d73 675f 6578 6974 290a 0a20  log_msg_exit).. 
+0002c7a0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+0002c7b0: 320a 0a20 2020 2064 6566 205f 7265 7665  2..    def _reve
+0002c7c0: 7273 6559 6168 6f6f 4164 6a75 7374 2873  rseYahooAdjust(s
+0002c7d0: 656c 662c 2064 6629 3a0a 2020 2020 2020  elf, df):.      
+0002c7e0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+0002c7f0: 4461 7461 4672 616d 6528 6466 2c20 2264  DataFrame(df, "d
+0002c800: 6622 290a 0a20 2020 2020 2020 2023 2059  f")..        # Y
+0002c810: 6168 6f6f 2072 6574 7572 6e73 2064 6174  ahoo returns dat
+0002c820: 6120 7370 6c69 742d 6164 6a75 7374 6564  a split-adjusted
+0002c830: 2073 6f20 7265 7665 7273 6520 7468 6174   so reverse that
+0002c840: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
+0002c850: 2020 2020 2320 4578 6365 7074 2066 6f72      # Except for
+0002c860: 2068 6f75 726c 792f 6d69 6e75 7465 2064   hourly/minute d
+0002c870: 6174 612c 2059 6168 6f6f 2069 736e 2774  ata, Yahoo isn't
+0002c880: 2063 6f6e 7369 7374 656e 7420 7769 7468   consistent with
+0002c890: 2061 646a 7573 746d 656e 743a 0a20 2020   adjustment:.   
+0002c8a0: 2020 2020 2023 202d 2070 7269 6365 7320       # - prices 
+0002c8b0: 6f6e 6c79 2073 706c 6974 2d61 646a 7573  only split-adjus
+0002c8c0: 7465 6420 6966 2064 6174 6520 7261 6e67  ted if date rang
+0002c8d0: 6520 636f 6e74 6169 6e73 2061 2073 706c  e contains a spl
+0002c8e0: 6974 0a20 2020 2020 2020 2023 202d 2064  it.        # - d
+0002c8f0: 6976 6964 656e 6420 6170 7065 6172 7320  ividend appears 
+0002c900: 7370 6c69 742d 6164 6a75 7374 6564 0a20  split-adjusted. 
+0002c910: 2020 2020 2020 2023 2045 6173 7920 746f         # Easy to
+0002c920: 2066 6978 2075 7369 6e67 2064 6169 6c79   fix using daily
+0002c930: 2064 6174 613a 0a20 2020 2020 2020 2023   data:.        #
+0002c940: 202d 2064 6976 6964 6520 7072 6963 6573   - divide prices
+0002c950: 2062 7920 6461 696c 7920 746f 2064 6574   by daily to det
+0002c960: 6572 6d69 6e65 2069 6620 7370 6c69 742d  ermine if split-
+0002c970: 6164 6a75 7374 6564 0a20 2020 2020 2020  adjusted.       
+0002c980: 2023 202d 2063 6f70 7920 6469 7669 6465   # - copy divide
+0002c990: 6e64 7320 6672 6f6d 2064 6169 6c79 0a0a  nds from daily..
+0002c9a0: 2020 2020 2020 2020 2320 4669 6e61 6c6c          # Finall
+0002c9b0: 792c 2061 6464 2027 4353 4627 2026 2027  y, add 'CSF' & '
+0002c9c0: 4344 4627 2063 6f6c 756d 6e73 2074 6f20  CDF' columns to 
+0002c9d0: 616c 6c6f 7720 6368 6561 7020 6f6e 2d64  allow cheap on-d
+0002c9e0: 656d 616e 6420 6164 6a75 7374 6d65 6e74  emand adjustment
+0002c9f0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0002ca00: 2069 7369 6e73 7461 6e63 6528 6466 2c20   isinstance(df, 
+0002ca10: 7064 2e44 6174 6146 7261 6d65 293a 0a20  pd.DataFrame):. 
+0002ca20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0002ca30: 2045 7863 6570 7469 6f6e 2822 2764 6627   Exception("'df'
+0002ca40: 206d 7573 7420 6265 2070 642e 4461 7461   must be pd.Data
+0002ca50: 4672 616d 6520 6e6f 7420 7b7d 222e 666f  Frame not {}".fo
+0002ca60: 726d 6174 2874 7970 6528 6466 2929 290a  rmat(type(df))).
+0002ca70: 0a20 2020 2020 2020 2064 6562 7567 203d  .        debug =
+0002ca80: 2046 616c 7365 0a20 2020 2020 2020 2023   False.        #
+0002ca90: 2064 6562 7567 203d 2054 7275 650a 0a20   debug = True.. 
+0002caa0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
+0002cab0: 2066 2250 4d3a 3a5f 7265 7665 7273 6559   f"PM::_reverseY
+0002cac0: 6168 6f6f 4164 6a75 7374 2d7b 7365 6c66  ahooAdjust-{self
+0002cad0: 2e69 7374 727d 2c20 7b64 662e 696e 6465  .istr}, {df.inde
+0002cae0: 785b 305d 7d2d 3e7b 6466 2e69 6e64 6578  x[0]}->{df.index
+0002caf0: 5b2d 315d 7d22 0a20 2020 2020 2020 2069  [-1]}".        i
+0002cb00: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
+0002cb10: 456e 6162 6c65 6428 293a 0a20 2020 2020  Enabled():.     
+0002cb20: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+0002cb30: 6545 6e74 6572 286c 6f67 5f6d 7367 290a  eEnter(log_msg).
+0002cb40: 2020 2020 2020 2020 656c 6966 2064 6562          elif deb
+0002cb50: 7567 3a0a 2020 2020 2020 2020 2020 2020  ug:.            
+0002cb60: 7072 696e 7428 2222 290a 2020 2020 2020  print("").      
+0002cb70: 2020 2020 2020 7072 696e 7428 6c6f 675f        print(log_
+0002cb80: 6d73 6729 0a0a 2020 2020 2020 2020 6966  msg)..        if
+0002cb90: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+0002cba0: 2020 2020 7072 696e 7428 6466 5b5b 224f      print(df[["O
+0002cbb0: 7065 6e22 2c20 224c 6f77 222c 2022 4869  pen", "Low", "Hi
+0002cbc0: 6768 222c 2022 436c 6f73 6522 2c20 2256  gh", "Close", "V
+0002cbd0: 6f6c 756d 6522 5d5d 290a 0a20 2020 2020  olume"]])..     
+0002cbe0: 2020 2063 6466 203d 204e 6f6e 650a 2020     cdf = None.  
+0002cbf0: 2020 2020 2020 6373 6620 3d20 4e6f 6e65        csf = None
+0002cc00: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0002cc10: 662e 696e 7465 7276 616c 2021 3d20 7966  f.interval != yf
+0002cc20: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
+0002cc30: 313a 0a20 2020 2020 2020 2020 2020 2023  1:.            #
+0002cc40: 2054 7269 6767 6572 2075 7064 6174 6520   Trigger update 
+0002cc50: 6f66 2064 6169 6c79 2070 7269 6365 2064  of daily price d
+0002cc60: 6174 612c 2074 6f20 6765 7420 616c 6c20  ata, to get all 
+0002cc70: 6576 656e 7473 0a20 2020 2020 2020 2020  events.         
+0002cc80: 2020 2068 6973 7444 6169 6c79 203d 2073     histDaily = s
+0002cc90: 656c 662e 6d61 6e61 6765 722e 4765 7448  elf.manager.GetH
+0002cca0: 6973 746f 7279 2879 6663 642e 496e 7465  istory(yfcd.Inte
+0002ccb0: 7276 616c 2e44 6179 7331 290a 2020 2020  rval.Days1).    
+0002ccc0: 2020 2020 2020 2020 6466 5f64 6169 6c79          df_daily
+0002ccd0: 5f72 6177 203d 2068 6973 7444 6169 6c79  _raw = histDaily
+0002cce0: 2e67 6574 2873 7461 7274 3d64 662e 696e  .get(start=df.in
+0002ccf0: 6465 785b 305d 2e64 6174 6528 292c 2072  dex[0].date(), r
+0002cd00: 6570 6169 723d 4661 6c73 6529 0a0a 2020  epair=False)..  
+0002cd10: 2020 2020 2020 2320 5374 6570 2031 3a20        # Step 1: 
+0002cd20: 656e 7375 7265 2069 6e74 7261 6461 7920  ensure intraday 
+0002cd30: 7072 6963 6520 6461 7461 2069 7320 616c  price data is al
+0002cd40: 7761 7973 2073 706c 6974 2d61 646a 7573  ways split-adjus
+0002cd50: 7465 640a 2020 2020 2020 2020 7464 5f37  ted.        td_7
+0002cd60: 6420 3d20 7469 6d65 6465 6c74 6128 6461  d = timedelta(da
+0002cd70: 7973 3d37 290a 2020 2020 2020 2020 6966  ys=7).        if
+0002cd80: 206e 6f74 2073 656c 662e 696e 7465 7264   not self.interd
+0002cd90: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+0002cda0: 2320 4765 7420 6461 696c 7920 7072 6963  # Get daily pric
+0002cdb0: 6520 6461 7461 2064 7572 696e 6720 616e  e data during an
+0002cdc0: 6420 6166 7465 7220 2764 6627 0a0a 2020  d after 'df'..  
+0002cdd0: 2020 2020 2020 2020 2020 6466 5f64 6169            df_dai
+0002cde0: 6c79 203d 2064 665f 6461 696c 795f 7261  ly = df_daily_ra
+0002cdf0: 772e 636f 7079 2829 0a20 2020 2020 2020  w.copy().       
+0002ce00: 2020 2020 2066 6f72 2063 2069 6e20 5b22       for c in ["
+0002ce10: 4f70 656e 222c 2022 436c 6f73 6522 2c20  Open", "Close", 
+0002ce20: 224c 6f77 222c 2022 4869 6768 225d 3a0a  "Low", "High"]:.
+0002ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce40: 6466 5f64 6169 6c79 5b63 5d20 2a3d 2064  df_daily[c] *= d
+0002ce50: 665f 6461 696c 795b 2243 5346 225d 0a20  f_daily["CSF"]. 
+0002ce60: 2020 2020 2020 2020 2020 2064 665f 6461             df_da
+0002ce70: 696c 795b 2256 6f6c 756d 6522 5d20 2f3d  ily["Volume"] /=
+0002ce80: 2064 665f 6461 696c 795b 2243 5346 225d   df_daily["CSF"]
+0002ce90: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+0002cea0: 6461 696c 7920 3d20 6466 5f64 6169 6c79  daily = df_daily
+0002ceb0: 2e64 726f 7028 2243 5346 222c 2061 7869  .drop("CSF", axi
+0002cec0: 733d 3129 0a0a 2020 2020 2020 2020 2020  s=1)..          
+0002ced0: 2020 6966 2064 665f 6461 696c 7920 6973    if df_daily is
+0002cee0: 204e 6f6e 6520 6f72 2064 665f 6461 696c   None or df_dail
+0002cef0: 792e 656d 7074 793a 0a20 2020 2020 2020  y.empty:.       
+0002cf00: 2020 2020 2020 2020 2023 2064 6620 3d20           # df = 
+0002cf10: 6466 2e64 726f 7028 2241 646a 2043 6c6f  df.drop("Adj Clo
+0002cf20: 7365 222c 2061 7869 733d 3129 0a20 2020  se", axis=1).   
+0002cf30: 2020 2020 2020 2020 2020 2020 2064 665b               df[
+0002cf40: 2243 5346 225d 203d 2031 2e30 0a20 2020  "CSF"] = 1.0.   
+0002cf50: 2020 2020 2020 2020 2020 2020 2064 665b               df[
+0002cf60: 2243 4446 225d 203d 2031 2e30 0a20 2020  "CDF"] = 1.0.   
+0002cf70: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002cf80: 7572 6e20 6466 0a0a 2020 2020 2020 2020  urn df..        
+0002cf90: 2020 2020 665f 706f 7374 203d 2064 665f      f_post = df_
+0002cfa0: 6461 696c 792e 696e 6465 782e 6461 7465  daily.index.date
+0002cfb0: 203e 2064 662e 696e 6465 785b 2d31 5d2e   > df.index[-1].
+0002cfc0: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
+0002cfd0: 2020 2064 665f 6461 696c 795f 6475 7269     df_daily_duri
+0002cfe0: 6e67 203d 2064 665f 6461 696c 795b 7e66  ng = df_daily[~f
+0002cff0: 5f70 6f73 745d 2e63 6f70 7928 290a 2020  _post].copy().  
+0002d000: 2020 2020 2020 2020 2020 6466 5f64 6169            df_dai
+0002d010: 6c79 5f70 6f73 7420 3d20 6466 5f64 6169  ly_post = df_dai
+0002d020: 6c79 5b66 5f70 6f73 745d 2e63 6f70 7928  ly[f_post].copy(
+0002d030: 290a 2020 2020 2020 2020 2020 2020 6466  ).            df
+0002d040: 5f64 6169 6c79 5f64 7572 696e 672e 696e  _daily_during.in
+0002d050: 6465 7820 3d20 6466 5f64 6169 6c79 5f64  dex = df_daily_d
+0002d060: 7572 696e 672e 696e 6465 782e 6461 7465  uring.index.date
+0002d070: 203b 2064 665f 6461 696c 795f 6475 7269   ; df_daily_duri
+0002d080: 6e67 2e69 6e64 6578 2e6e 616d 6520 3d20  ng.index.name = 
+0002d090: 225f 6461 7465 220a 0a20 2020 2020 2020  "_date"..       
+0002d0a0: 2020 2020 2023 2041 6c73 6f20 6765 7420       # Also get 
+0002d0b0: 7261 7720 6461 696c 7920 6461 7461 2066  raw daily data f
+0002d0c0: 726f 6d20 6361 6368 650a 2020 2020 2020  rom cache.      
+0002d0d0: 2020 2020 2020 6466 5f64 6169 6c79 5f72        df_daily_r
+0002d0e0: 6177 203d 2064 665f 6461 696c 795f 7261  aw = df_daily_ra
+0002d0f0: 775b 6466 5f64 6169 6c79 5f72 6177 2e69  w[df_daily_raw.i
+0002d100: 6e64 6578 2e64 6174 6520 3e3d 2064 662e  ndex.date >= df.
+0002d110: 696e 6465 785b 305d 2e64 6174 6528 295d  index[0].date()]
+0002d120: 0a20 2020 2020 2020 2020 2020 2023 0a20  .            #. 
+0002d130: 2020 2020 2020 2020 2020 2066 5f70 6f73             f_pos
+0002d140: 7420 3d20 6466 5f64 6169 6c79 5f72 6177  t = df_daily_raw
+0002d150: 2e69 6e64 6578 2e64 6174 6520 3e20 6466  .index.date > df
+0002d160: 2e69 6e64 6578 5b2d 315d 2e64 6174 6528  .index[-1].date(
+0002d170: 290a 2020 2020 2020 2020 2020 2020 6466  ).            df
+0002d180: 5f64 6169 6c79 5f72 6177 5f64 7572 696e  _daily_raw_durin
+0002d190: 6720 3d20 6466 5f64 6169 6c79 5f72 6177  g = df_daily_raw
+0002d1a0: 5b7e 665f 706f 7374 5d2e 636f 7079 2829  [~f_post].copy()
+0002d1b0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+0002d1c0: 6461 696c 795f 7261 775f 6475 7269 6e67  daily_raw_during
+0002d1d0: 5f64 203d 2064 665f 6461 696c 795f 7261  _d = df_daily_ra
+0002d1e0: 775f 6475 7269 6e67 2e63 6f70 7928 290a  w_during.copy().
+0002d1f0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
+0002d200: 6169 6c79 5f72 6177 5f64 7572 696e 675f  aily_raw_during_
+0002d210: 642e 696e 6465 7820 3d20 6466 5f64 6169  d.index = df_dai
+0002d220: 6c79 5f72 6177 5f64 7572 696e 675f 642e  ly_raw_during_d.
+0002d230: 696e 6465 782e 6461 7465 203b 2064 665f  index.date ; df_
+0002d240: 6461 696c 795f 7261 775f 6475 7269 6e67  daily_raw_during
+0002d250: 5f64 2e69 6e64 6578 2e6e 616d 6520 3d20  _d.index.name = 
+0002d260: 225f 6461 7465 220a 0a20 2020 2020 2020  "_date"..       
+0002d270: 2020 2020 2069 6620 6466 5f64 6169 6c79       if df_daily
+0002d280: 5f70 6f73 742e 656d 7074 793a 0a20 2020  _post.empty:.   
+0002d290: 2020 2020 2020 2020 2020 2020 2063 7366               csf
+0002d2a0: 5f70 6f73 7420 3d20 312e 300a 2020 2020  _post = 1.0.    
+0002d2b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002d2c0: 2020 2020 2020 2020 2020 2020 2020 6373                cs
+0002d2d0: 665f 706f 7374 203d 2079 6663 752e 4765  f_post = yfcu.Ge
+0002d2e0: 7443 5346 3028 6466 5f64 6169 6c79 5f70  tCSF0(df_daily_p
+0002d2f0: 6f73 7429 0a20 2020 2020 2020 2020 2020  ost).           
+0002d300: 2065 7870 6563 7465 6452 6174 696f 203d   expectedRatio =
+0002d310: 2031 2e30 202f 2063 7366 5f70 6f73 740a   1.0 / csf_post.
+0002d320: 0a20 2020 2020 2020 2020 2020 2073 735f  .            ss_
+0002d330: 7261 7469 6f20 3d20 6578 7065 6374 6564  ratio = expected
+0002d340: 5261 7469 6f0a 2020 2020 2020 2020 2020  Ratio.          
+0002d350: 2020 7373 5f72 6174 696f 5263 7020 3d20    ss_ratioRcp = 
+0002d360: 312e 3020 2f20 7373 5f72 6174 696f 0a20  1.0 / ss_ratio. 
+0002d370: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+0002d380: 2020 2020 2020 2020 2070 7269 6365 5f64           price_d
+0002d390: 6174 615f 636f 6c73 203d 205b 224f 7065  ata_cols = ["Ope
+0002d3a0: 6e22 2c20 2243 6c6f 7365 222c 2022 4164  n", "Close", "Ad
+0002d3b0: 6a20 436c 6f73 6522 2c20 224c 6f77 222c  j Close", "Low",
+0002d3c0: 2022 4869 6768 225d 0a20 2020 2020 2020   "High"].       
+0002d3d0: 2020 2020 2069 6620 7373 5f72 6174 696f       if ss_ratio
+0002d3e0: 203e 2031 2e30 313a 0a20 2020 2020 2020   > 1.01:.       
+0002d3f0: 2020 2020 2020 2020 2066 6f72 2063 2069           for c i
+0002d400: 6e20 7072 6963 655f 6461 7461 5f63 6f6c  n price_data_col
+0002d410: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002d420: 2020 2020 2020 2064 665b 635d 202a 3d20         df[c] *= 
+0002d430: 7373 5f72 6174 696f 5263 700a 2020 2020  ss_ratioRcp.    
+0002d440: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0002d450: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+0002d460: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0002d470: 2241 7070 6c79 696e 6720 313a 7b7d 2073  "Applying 1:{} s
+0002d480: 746f 636b 2d73 706c 6974 222e 666f 726d  tock-split".form
+0002d490: 6174 2872 6f75 6e64 2873 735f 7261 7469  at(round(ss_rati
+0002d4a0: 6f2c 2032 2929 290a 2020 2020 2020 2020  o, 2))).        
+0002d4b0: 2020 2020 656c 6966 2073 735f 7261 7469      elif ss_rati
+0002d4c0: 6f52 6370 203e 2031 2e30 313a 0a20 2020  oRcp > 1.01:.   
+0002d4d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002d4e0: 2063 2069 6e20 7072 6963 655f 6461 7461   c in price_data
+0002d4f0: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
+0002d500: 2020 2020 2020 2020 2020 2064 665b 635d             df[c]
+0002d510: 202a 3d20 7373 5f72 6174 696f 0a20 2020   *= ss_ratio.   
+0002d520: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002d530: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
+0002d540: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0002d550: 2822 4170 706c 7969 6e67 207b 2e32 667d  ("Applying {.2f}
+0002d560: 3a31 2072 6576 6572 7365 2d73 706c 6974  :1 reverse-split
+0002d570: 2d73 706c 6974 222e 666f 726d 6174 2873  -split".format(s
+0002d580: 735f 7261 7469 6f52 6370 2929 0a20 2020  s_ratioRcp)).   
+0002d590: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
+0002d5a0: 2076 6f6c 756d 6520 616c 7761 7973 2072   volume always r
+0002d5b0: 6574 7572 6e65 6420 756e 6164 6a75 7374  eturned unadjust
+0002d5c0: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
+0002d5d0: 2320 5961 686f 6f20 6d65 7373 6573 2075  # Yahoo messes u
+0002d5e0: 7020 6469 7669 6465 6e64 2061 646a 7573  p dividend adjus
+0002d5f0: 746d 656e 7420 746f 6f20 736f 2063 6f70  tment too so cop
+0002d600: 7920 636f 7272 6563 7420 6469 7669 6465  y correct divide
+0002d610: 6e64 2066 726f 6d20 6461 696c 792c 0a20  nd from daily,. 
+0002d620: 2020 2020 2020 2020 2020 2023 2062 7574             # but
+0002d630: 206f 6e6c 7920 746f 2066 6972 7374 2074   only to first t
+0002d640: 696d 6520 7065 7269 6f64 7320 6f66 2065  ime periods of e
+0002d650: 6163 6820 6461 793a 0a20 2020 2020 2020  ach day:.       
+0002d660: 2020 2020 2064 665b 225f 6461 7465 225d       df["_date"]
+0002d670: 203d 2064 662e 696e 6465 782e 6461 7465   = df.index.date
+0002d680: 0a20 2020 2020 2020 2020 2020 2064 665b  .            df[
+0002d690: 225f 696e 6465 7842 6163 6b75 7022 5d20  "_indexBackup"] 
+0002d6a0: 3d20 6466 2e69 6e64 6578 0a20 2020 2020  = df.index.     
+0002d6b0: 2020 2020 2020 2023 2043 6f70 7920 6f76         # Copy ov
+0002d6c0: 6572 2043 5346 2061 6e64 2043 4446 2074  er CSF and CDF t
+0002d6d0: 6f6f 2066 726f 6d20 6461 696c 790a 2020  oo from daily.  
+0002d6e0: 2020 2020 2020 2020 2020 6466 203d 2070            df = p
+0002d6f0: 642e 6d65 7267 6528 6466 2c20 6466 5f64  d.merge(df, df_d
+0002d700: 6169 6c79 5f72 6177 5f64 7572 696e 675f  aily_raw_during_
+0002d710: 645b 5b22 4344 4622 2c20 2243 5346 225d  d[["CDF", "CSF"]
+0002d720: 5d2c 2068 6f77 3d22 6c65 6674 222c 206f  ], how="left", o
+0002d730: 6e3d 225f 6461 7465 222c 2076 616c 6964  n="_date", valid
+0002d740: 6174 653d 226d 616e 795f 746f 5f6f 6e65  ate="many_to_one
+0002d750: 2229 0a20 2020 2020 2020 2020 2020 2064  ").            d
+0002d760: 662e 696e 6465 7820 3d20 6466 5b22 5f69  f.index = df["_i
+0002d770: 6e64 6578 4261 636b 7570 225d 203b 2064  ndexBackup"] ; d
+0002d780: 662e 696e 6465 782e 6e61 6d65 203d 204e  f.index.name = N
+0002d790: 6f6e 6520 3b20 6466 203d 2064 662e 6472  one ; df = df.dr
+0002d7a0: 6f70 285b 225f 696e 6465 7842 6163 6b75  op(["_indexBacku
+0002d7b0: 7022 2c20 225f 6461 7465 225d 2c20 6178  p", "_date"], ax
+0002d7c0: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
+0002d7d0: 2020 6364 6620 3d20 6466 5b22 4344 4622    cdf = df["CDF"
+0002d7e0: 5d0a 2020 2020 2020 2020 2020 2020 6466  ].            df
+0002d7f0: 5b22 4164 6a20 436c 6f73 6522 5d20 3d20  ["Adj Close"] = 
+0002d800: 6466 5b22 436c 6f73 6522 5d20 2a20 6364  df["Close"] * cd
+0002d810: 660a 2020 2020 2020 2020 2020 2020 6373  f.            cs
+0002d820: 6620 3d20 6466 5b22 4353 4622 5d0a 0a20  f = df["CSF"].. 
+0002d830: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002d840: 7420 6466 5f64 6169 6c79 5f70 6f73 742e  t df_daily_post.
+0002d850: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
+0002d860: 2020 2020 2020 2070 6f73 745f 6373 6620         post_csf 
+0002d870: 3d20 7966 6375 2e47 6574 4353 4630 2864  = yfcu.GetCSF0(d
+0002d880: 665f 6461 696c 795f 706f 7374 290a 0a20  f_daily_post).. 
+0002d890: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+0002d8a0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0002d8b0: 642e 496e 7465 7276 616c 2e57 6565 6b3a  d.Interval.Week:
+0002d8c0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+0002d8d0: 6461 696c 7920 3d20 6869 7374 4461 696c  daily = histDail
+0002d8e0: 792e 6765 7428 7374 6172 743d 6466 2e69  y.get(start=df.i
+0002d8f0: 6e64 6578 5b2d 315d 2e64 6174 6528 292b  ndex[-1].date()+
+0002d900: 7464 5f37 642c 2072 6570 6169 723d 4661  td_7d, repair=Fa
+0002d910: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+0002d920: 2069 6620 2864 665f 6461 696c 7920 6973   if (df_daily is
+0002d930: 206e 6f74 204e 6f6e 6529 2061 6e64 2028   not None) and (
+0002d940: 6e6f 7420 6466 5f64 6169 6c79 2e65 6d70  not df_daily.emp
+0002d950: 7479 293a 0a20 2020 2020 2020 2020 2020  ty):.           
+0002d960: 2020 2020 2070 6f73 745f 6373 6620 3d20       post_csf = 
+0002d970: 7966 6375 2e47 6574 4353 4630 2864 665f  yfcu.GetCSF0(df_
+0002d980: 6461 696c 7929 0a20 2020 2020 2020 2020  daily).         
+0002d990: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
+0002d9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d9b0: 2020 2020 2070 7269 6e74 2822 2d20 706f       print("- po
+0002d9c0: 7374 5f63 7366 206f 6620 6461 696c 7920  st_csf of daily 
+0002d9d0: 6461 7465 2072 616e 6765 207b 7d2d 3e7b  date range {}->{
+0002d9e0: 7d20 3d20 7b7d 222e 666f 726d 6174 2864  } = {}".format(d
+0002d9f0: 665f 6461 696c 792e 696e 6465 785b 305d  f_daily.index[0]
+0002da00: 2c20 6466 5f64 6169 6c79 2e69 6e64 6578  , df_daily.index
+0002da10: 5b2d 315d 2c20 706f 7374 5f63 7366 2929  [-1], post_csf))
+0002da20: 0a0a 2020 2020 2020 2020 2320 656c 6966  ..        # elif
+0002da30: 2073 656c 662e 696e 7465 7276 616c 2069   self.interval i
+0002da40: 6e20 5b79 6663 642e 496e 7465 7276 616c  n [yfcd.Interval
+0002da50: 2e4d 6f6e 7468 7331 2c20 7966 6364 2e49  .Months1, yfcd.I
+0002da60: 6e74 6572 7661 6c2e 4d6f 6e74 6873 335d  nterval.Months3]
+0002da70: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
+0002da80: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+0002da90: 226e 6f74 2069 6d70 6c65 6d65 6e74 6564  "not implemented
+0002daa0: 2229 0a0a 2020 2020 2020 2020 2320 4966  ")..        # If
+0002dab0: 2027 6466 2720 646f 6573 206e 6f74 2063   'df' does not c
+0002dac0: 6f6e 7461 696e 2061 6c6c 2073 746f 636b  ontain all stock
+0002dad0: 2073 706c 6974 7320 756e 7469 6c20 7072   splits until pr
+0002dae0: 6573 656e 742c 2074 6865 6e0a 2020 2020  esent, then.    
+0002daf0: 2020 2020 2320 7365 7420 2770 6f73 745f      # set 'post_
+0002db00: 6373 6627 2074 6f20 6375 6d75 6c61 7469  csf' to cumulati
+0002db10: 7665 2073 746f 636b 2073 706c 6974 2066  ve stock split f
+0002db20: 6163 746f 7220 6a75 7374 2061 6674 6572  actor just after
+0002db30: 206c 6173 7420 2764 6627 2064 6174 650a   last 'df' date.
+0002db40: 2020 2020 2020 2020 7370 6c69 7473 5f70          splits_p
+0002db50: 6f73 7420 3d20 7365 6c66 2e6d 616e 6167  ost = self.manag
+0002db60: 6572 2e47 6574 4869 7374 6f72 7928 2245  er.GetHistory("E
+0002db70: 7665 6e74 7322 292e 4765 7453 706c 6974  vents").GetSplit
+0002db80: 7328 7374 6172 743d 6466 2e69 6e64 6578  s(start=df.index
+0002db90: 5b2d 315d 2e64 6174 6528 292b 7469 6d65  [-1].date()+time
+0002dba0: 6465 6c74 6128 6461 7973 3d31 2929 0a20  delta(days=1)). 
+0002dbb0: 2020 2020 2020 2069 6620 7370 6c69 7473         if splits
+0002dbc0: 5f70 6f73 7420 6973 206e 6f74 204e 6f6e  _post is not Non
+0002dbd0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0002dbe0: 6f73 745f 6373 6620 3d20 312e 302f 7370  ost_csf = 1.0/sp
+0002dbf0: 6c69 7473 5f70 6f73 745b 2253 746f 636b  lits_post["Stock
+0002dc00: 2053 706c 6974 7322 5d2e 7072 6f64 2829   Splits"].prod()
+0002dc10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002dc20: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
+0002dc30: 6373 6620 3d20 4e6f 6e65 0a0a 2020 2020  csf = None..    
+0002dc40: 2020 2020 2320 4375 6d75 6c61 7469 7665      # Cumulative
+0002dc50: 2064 6976 6964 656e 6420 6661 6374 6f72   dividend factor
+0002dc60: 0a20 2020 2020 2020 2069 6620 6364 6620  .        if cdf 
+0002dc70: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002dc80: 2020 2020 2066 5f6e 6e61 203d 207e 6466       f_nna = ~df
+0002dc90: 5b22 436c 6f73 6522 5d2e 6973 6e61 2829  ["Close"].isna()
+0002dca0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002dcb0: 6e6f 7420 665f 6e6e 612e 616e 7928 293a  not f_nna.any():
+0002dcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dcd0: 2063 6466 203d 2031 2e30 0a20 2020 2020   cdf = 1.0.     
+0002dce0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002dcf0: 2020 2020 2020 2020 2020 2020 2063 6466               cdf
+0002dd00: 203d 206e 702e 6675 6c6c 2864 662e 7368   = np.full(df.sh
+0002dd10: 6170 655b 305d 2c20 6e70 2e6e 616e 290a  ape[0], np.nan).
+0002dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd30: 6364 665b 665f 6e6e 615d 203d 2064 662e  cdf[f_nna] = df.
+0002dd40: 6c6f 635b 665f 6e6e 612c 2022 4164 6a20  loc[f_nna, "Adj 
+0002dd50: 436c 6f73 6522 5d20 2f20 6466 2e6c 6f63  Close"] / df.loc
+0002dd60: 5b66 5f6e 6e61 2c20 2243 6c6f 7365 225d  [f_nna, "Close"]
+0002dd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dd80: 2063 6466 203d 2070 642e 5365 7269 6573   cdf = pd.Series
+0002dd90: 2863 6466 292e 6669 6c6c 6e61 286d 6574  (cdf).fillna(met
+0002dda0: 686f 643d 2262 6669 6c6c 2229 2e66 696c  hod="bfill").fil
+0002ddb0: 6c6e 6128 6d65 7468 6f64 3d22 6666 696c  lna(method="ffil
+0002ddc0: 6c22 292e 746f 5f6e 756d 7079 2829 0a0a  l").to_numpy()..
+0002ddd0: 2020 2020 2020 2020 2320 496e 2072 6172          # In rar
+0002dde0: 6520 6361 7365 732c 2059 6168 6f6f 2069  e cases, Yahoo i
+0002ddf0: 7320 6e6f 7420 6361 6c63 756c 6174 696e  s not calculatin
+0002de00: 6720 2741 646a 2043 6c6f 7365 2720 636f  g 'Adj Close' co
+0002de10: 7272 6563 746c 790a 2020 2020 2020 2020  rrectly.        
+0002de20: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
+0002de30: 3a0a 2020 2020 2020 2020 2020 2020 6469  :.            di
+0002de40: 7673 5f73 696e 6365 203d 2073 656c 662e  vs_since = self.
+0002de50: 6d61 6e61 6765 722e 4765 7448 6973 746f  manager.GetHisto
+0002de60: 7279 2822 4576 656e 7473 2229 2e47 6574  ry("Events").Get
+0002de70: 4469 7673 2873 7461 7274 3d64 662e 696e  Divs(start=df.in
+0002de80: 6465 785b 2d31 5d2e 6461 7465 2829 2b73  dex[-1].date()+s
+0002de90: 656c 662e 6974 6429 0a20 2020 2020 2020  elf.itd).       
+0002dea0: 2020 2020 2069 6620 6469 7673 5f73 696e       if divs_sin
+0002deb0: 6365 2069 7320 6e6f 7420 4e6f 6e65 2061  ce is not None a
+0002dec0: 6e64 206e 6f74 2064 6976 735f 7369 6e63  nd not divs_sinc
+0002ded0: 652e 656d 7074 793a 0a20 2020 2020 2020  e.empty:.       
+0002dee0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
+0002def0: 2074 6861 7420 2741 646a 2043 6c6f 7365   that 'Adj Close
+0002df00: 2720 7265 666c 6563 7473 2061 6c6c 2066  ' reflects all f
+0002df10: 7574 7572 6520 6469 7669 6465 6e64 730a  uture dividends.
+0002df20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df30: 6578 7065 6374 6564 5f61 646a 203d 2064  expected_adj = d
+0002df40: 6976 735f 7369 6e63 655b 2742 6163 6b20  ivs_since['Back 
+0002df50: 4164 6a2e 275d 2e70 726f 6428 290a 2020  Adj.'].prod().  
+0002df60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002df70: 2073 656c 662e 696e 7465 7264 6179 2061   self.interday a
+0002df80: 6e64 2073 656c 662e 696e 7465 7276 616c  nd self.interval
+0002df90: 2021 3d20 7966 6364 2e49 6e74 6572 7661   != yfcd.Interva
+0002dfa0: 6c2e 4461 7973 313a 0a20 2020 2020 2020  l.Days1:.       
+0002dfb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002dfc0: 6466 5b27 4469 7669 6465 6e64 7327 5d2e  df['Dividends'].
+0002dfd0: 696c 6f63 5b2d 315d 2021 3d20 302e 303a  iloc[-1] != 0.0:
+0002dfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dff0: 2020 2020 2020 2020 2064 7420 3d20 6466           dt = df
+0002e000: 2e69 6e64 6578 5b2d 315d 0a20 2020 2020  .index[-1].     
+0002e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e020: 2020 2023 204e 6f74 653a 2064 6620 6861     # Note: df ha
+0002e030: 736e 2774 2062 6565 6e20 6465 2d73 706c  sn't been de-spl
+0002e040: 6974 7465 6420 7965 740a 2020 2020 2020  itted yet.      
+0002e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e060: 2020 6869 7374 5f62 6566 6f72 6520 3d20    hist_before = 
+0002e070: 7365 6c66 2e6d 616e 6167 6572 2e47 6574  self.manager.Get
+0002e080: 4869 7374 6f72 7928 7966 6364 2e49 6e74  History(yfcd.Int
+0002e090: 6572 7661 6c2e 4461 7973 3129 2e67 6574  erval.Days1).get
+0002e0a0: 2873 7461 7274 3d64 742e 6461 7465 2829  (start=dt.date()
+0002e0b0: 2d74 696d 6564 656c 7461 2864 6179 733d  -timedelta(days=
+0002e0c0: 3729 2c20 656e 643d 6474 2e64 6174 6528  7), end=dt.date(
+0002e0d0: 292c 2061 646a 7573 745f 7370 6c69 7473  ), adjust_splits
+0002e0e0: 3d54 7275 652c 2061 646a 7573 745f 6469  =True, adjust_di
+0002e0f0: 7673 3d46 616c 7365 290a 2020 2020 2020  vs=False).      
+0002e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e110: 2020 636c 6f73 6520 3d20 6869 7374 5f62    close = hist_b
+0002e120: 6566 6f72 655b 2743 6c6f 7365 275d 2e69  efore['Close'].i
+0002e130: 6c6f 635b 2d31 5d0a 2020 2020 2020 2020  loc[-1].        
+0002e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e150: 6164 6a5f 6164 6a20 3d20 3120 2d20 6466  adj_adj = 1 - df
+0002e160: 5b27 4469 7669 6465 6e64 7327 5d2e 696c  ['Dividends'].il
+0002e170: 6f63 5b2d 315d 202f 2063 6c6f 7365 0a20  oc[-1] / close. 
+0002e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e190: 2020 2020 2020 2069 6620 6164 6a5f 6164         if adj_ad
+0002e1a0: 6a20 3c20 312e 303a 0a20 2020 2020 2020  j < 1.0:.       
+0002e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e1c0: 2020 2020 206d 7367 203d 2066 2241 646a       msg = f"Adj
+0002e1d0: 7573 7469 6e67 2065 7870 6563 7465 645f  usting expected_
+0002e1e0: 6164 6a3d 7b65 7870 6563 7465 645f 6164  adj={expected_ad
+0002e1f0: 6a3a 2e33 667d 2062 7920 6c61 7374 2d72  j:.3f} by last-r
+0002e200: 6f77 2064 6976 3d7b 6466 5b27 4469 7669  ow div={df['Divi
+0002e210: 6465 6e64 7327 5d2e 696c 6f63 5b2d 315d  dends'].iloc[-1]
+0002e220: 7d20 6164 6a3d 7b61 646a 5f61 646a 3a2e  } adj={adj_adj:.
+0002e230: 3366 7d20 4020 7b64 742e 6461 7465 2829  3f} @ {dt.date()
+0002e240: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0002e250: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002e260: 656c 662e 6d61 6e61 6765 722e 4c6f 6745  elf.manager.LogE
+0002e270: 7665 6e74 2822 696e 666f 222c 2027 5f72  vent("info", '_r
+0002e280: 6576 6572 7365 5961 686f 6f41 646a 7573  everseYahooAdjus
+0002e290: 7427 2c20 6d73 6729 0a20 2020 2020 2020  t', msg).       
+0002e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e2b0: 2020 2020 2065 7870 6563 7465 645f 6164       expected_ad
+0002e2c0: 6a20 2a3d 2061 646a 5f61 646a 0a20 2020  j *= adj_adj.   
+0002e2d0: 2020 2020 2020 2020 2020 2020 2061 6374               act
+0002e2e0: 7561 6c5f 6164 6a20 3d20 6364 665b 2d31  ual_adj = cdf[-1
+0002e2f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0002e300: 2020 6966 206e 6f74 206e 702e 6973 6e61    if not np.isna
+0002e310: 6e28 6163 7475 616c 5f61 646a 293a 0a20  n(actual_adj):. 
+0002e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e330: 2020 2064 6966 665f 7063 7420 3d20 6162     diff_pct = ab
+0002e340: 7328 6163 7475 616c 5f61 646a 202f 2065  s(actual_adj / e
+0002e350: 7870 6563 7465 645f 6164 6a20 2d20 312e  xpected_adj - 1.
+0002e360: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0002e370: 2020 2020 2020 2069 6620 6469 6666 5f70         if diff_p
+0002e380: 6374 203e 2030 2e30 3035 3a0a 2020 2020  ct > 0.005:.    
+0002e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3a0: 2020 2020 6d73 6720 3d20 6627 6578 7065      msg = f'expe
+0002e3b0: 6374 6564 5f61 646a 3d7b 6578 7065 6374  cted_adj={expect
+0002e3c0: 6564 5f61 646a 3a2e 3466 7d20 213d 2061  ed_adj:.4f} != a
+0002e3d0: 6374 7561 6c5f 6164 6a3d 7b61 6374 7561  ctual_adj={actua
+0002e3e0: 6c5f 6164 6a3a 2e34 667d 2c20 636f 7272  l_adj:.4f}, corr
+0002e3f0: 6563 7469 6e67 2028 6c61 7374 2064 7420  ecting (last dt 
+0002e400: 3d20 7b64 662e 696e 6465 785b 2d31 5d2e  = {df.index[-1].
+0002e410: 6461 7465 2829 7d29 270a 2020 2020 2020  date()})'.      
+0002e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e430: 2020 7365 6c66 2e6d 616e 6167 6572 2e4c    self.manager.L
+0002e440: 6f67 4576 656e 7428 2269 6e66 6f22 2c20  ogEvent("info", 
+0002e450: 275f 7265 7665 7273 6559 6168 6f6f 4164  '_reverseYahooAd
+0002e460: 6a75 7374 272c 206d 7367 290a 2020 2020  just', msg).    
+0002e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e480: 2020 2020 6469 7673 5f73 696e 6365 2e69      divs_since.i
+0002e490: 6e64 6578 203d 2064 6976 735f 7369 6e63  ndex = divs_sinc
+0002e4a0: 652e 696e 6465 782e 6461 7465 0a20 2020  e.index.date.   
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2020 2020 2023 2042 6164 2e20 4469 7669       # Bad. Divi
+0002e4d0: 6465 6e64 7320 6861 7665 206f 6363 7572  dends have occur
+0002e4e0: 7265 6420 6166 7465 7220 7468 6973 2070  red after this p
+0002e4f0: 7269 6365 2064 6174 612c 2062 7574 2027  rice data, but '
+0002e500: 4164 6a20 436c 6f73 6527 2069 7320 6d69  Adj Close' is mi
+0002e510: 7373 696e 6720 6164 6a75 7374 6d65 6e74  ssing adjustment
+0002e520: 2873 292e 0a20 2020 2020 2020 2020 2020  (s)..           
+0002e530: 2020 2020 2020 2020 2020 2020 2023 2046               # F
+0002e540: 6978 0a20 2020 2020 2020 2020 2020 2020  ix.             
+0002e550: 2020 2020 2020 2020 2020 2063 6466 202a             cdf *
+0002e560: 3d20 6578 7065 6374 6564 5f61 646a 202f  = expected_adj /
+0002e570: 2061 6374 7561 6c5f 6164 6a0a 0a20 2020   actual_adj..   
+0002e580: 2020 2020 2023 2043 756d 756c 6174 6976       # Cumulativ
+0002e590: 6520 7374 6f63 6b2d 7370 6c69 7420 6661  e stock-split fa
+0002e5a0: 6374 6f72 0a20 2020 2020 2020 2069 6620  ctor.        if 
+0002e5b0: 6373 6620 6973 204e 6f6e 653a 0a20 2020  csf is None:.   
+0002e5c0: 2020 2020 2020 2020 2073 7320 3d20 6466           ss = df
+0002e5d0: 5b22 5374 6f63 6b20 5370 6c69 7473 225d  ["Stock Splits"]
+0002e5e0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+0002e5f0: 2020 2020 7373 5b28 7373 203d 3d20 302e      ss[(ss == 0.
+0002e600: 3029 207c 2073 732e 6973 6e61 2829 5d20  0) | ss.isna()] 
+0002e610: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
+0002e620: 2020 7373 5f72 6370 203d 2031 2e30 202f    ss_rcp = 1.0 /
+0002e630: 2073 730a 2020 2020 2020 2020 2020 2020   ss.            
+0002e640: 6373 6620 3d20 7373 5f72 6370 2e73 6f72  csf = ss_rcp.sor
+0002e650: 745f 696e 6465 7828 6173 6365 6e64 696e  t_index(ascendin
+0002e660: 673d 4661 6c73 6529 2e63 756d 7072 6f64  g=False).cumprod
+0002e670: 2829 2e73 6f72 745f 696e 6465 7828 6173  ().sort_index(as
+0002e680: 6365 6e64 696e 673d 5472 7565 292e 7368  cending=True).sh
+0002e690: 6966 7428 2d31 2c20 6669 6c6c 5f76 616c  ift(-1, fill_val
+0002e6a0: 7565 3d31 2e30 290a 2020 2020 2020 2020  ue=1.0).        
+0002e6b0: 2020 2020 6966 2070 6f73 745f 6373 6620      if post_csf 
+0002e6c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0002e6d0: 2020 2020 2020 2020 2020 2020 2063 7366               csf
+0002e6e0: 202a 3d20 706f 7374 5f63 7366 0a20 2020   *= post_csf.   
+0002e6f0: 2020 2020 2063 7366 5f72 6370 203d 2031       csf_rcp = 1
+0002e700: 2e30 202f 2063 7366 0a0a 2020 2020 2020  .0 / csf..      
+0002e710: 2020 2320 5265 7665 7273 6520 5961 686f    # Reverse Yaho
+0002e720: 6f27 7320 7370 6c69 7420 6164 6a75 7374  o's split adjust
+0002e730: 6d65 6e74 3a0a 2020 2020 2020 2020 6461  ment:.        da
+0002e740: 7461 5f63 6f6c 7320 3d20 5b22 4f70 656e  ta_cols = ["Open
+0002e750: 222c 2022 4869 6768 222c 2022 4c6f 7722  ", "High", "Low"
+0002e760: 2c20 2243 6c6f 7365 222c 2022 4469 7669  , "Close", "Divi
+0002e770: 6465 6e64 7322 5d0a 2020 2020 2020 2020  dends"].        
+0002e780: 666f 7220 6463 2069 6e20 6461 7461 5f63  for dc in data_c
+0002e790: 6f6c 733a 0a20 2020 2020 2020 2020 2020  ols:.           
+0002e7a0: 2064 665b 6463 5d20 3d20 6466 5b64 635d   df[dc] = df[dc]
+0002e7b0: 202a 2063 7366 5f72 6370 0a20 2020 2020   * csf_rcp.     
+0002e7c0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+0002e7d0: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
+0002e7e0: 2020 2020 2023 2044 6f6e 2774 206e 6565       # Don't nee
+0002e7f0: 6420 746f 2064 652d 7370 6c69 7420 766f  d to de-split vo
+0002e800: 6c75 6d65 2064 6174 6120 6265 6361 7573  lume data becaus
+0002e810: 6520 5961 686f 6f20 616c 7761 7973 2072  e Yahoo always r
+0002e820: 6574 7572 6e73 2069 6e74 6572 6461 7920  eturns interday 
+0002e830: 766f 6c75 6d65 2075 6e61 646a 7573 7465  volume unadjuste
+0002e840: 640a 2020 2020 2020 2020 2020 2020 7061  d.            pa
+0002e850: 7373 0a20 2020 2020 2020 2065 6c73 653a  ss.        else:
+0002e860: 0a20 2020 2020 2020 2020 2020 2064 665b  .            df[
+0002e870: 2256 6f6c 756d 6522 5d20 2a3d 2063 7366  "Volume"] *= csf
+0002e880: 0a0a 2020 2020 2020 2020 6966 2064 665b  ..        if df[
+0002e890: 2256 6f6c 756d 6522 5d2e 6474 7970 6520  "Volume"].dtype 
+0002e8a0: 213d 2027 696e 7436 3427 3a0a 2020 2020  != 'int64':.    
+0002e8b0: 2020 2020 2020 2020 6466 5b22 566f 6c75          df["Volu
+0002e8c0: 6d65 225d 203d 2064 665b 2256 6f6c 756d  me"] = df["Volum
+0002e8d0: 6522 5d2e 726f 756e 6428 3029 2e61 7374  e"].round(0).ast
+0002e8e0: 7970 6528 2769 6e74 2729 0a0a 2020 2020  ype('int')..    
+0002e8f0: 2020 2020 2320 4472 6f70 2027 4164 6a20      # Drop 'Adj 
+0002e900: 436c 6f73 6527 2c20 7265 706c 6163 6520  Close', replace 
+0002e910: 7769 7468 2073 6361 6c69 6e67 2066 6163  with scaling fac
+0002e920: 746f 7273 3a0a 2020 2020 2020 2020 6466  tors:.        df
+0002e930: 203d 2064 662e 6472 6f70 2822 4164 6a20   = df.drop("Adj 
+0002e940: 436c 6f73 6522 2c20 6178 6973 3d31 290a  Close", axis=1).
+0002e950: 2020 2020 2020 2020 6466 5b22 4353 4622          df["CSF"
+0002e960: 5d20 3d20 6373 660a 2020 2020 2020 2020  ] = csf.        
+0002e970: 6466 5b22 4344 4622 5d20 3d20 6364 660a  df["CDF"] = cdf.
+0002e980: 0a20 2020 2020 2020 2068 5f6c 6173 7444  .        h_lastD
+0002e990: 6976 4164 6a75 7374 4474 203d 2070 642e  ivAdjustDt = pd.
+0002e9a0: 5469 6d65 7374 616d 702e 7574 636e 6f77  Timestamp.utcnow
+0002e9b0: 2829 2e74 7a5f 636f 6e76 6572 7428 5a6f  ().tz_convert(Zo
+0002e9c0: 6e65 496e 666f 2822 5554 4322 2929 0a20  neInfo("UTC")). 
+0002e9d0: 2020 2020 2020 2068 5f6c 6173 7453 706c         h_lastSpl
+0002e9e0: 6974 4164 6a75 7374 4474 203d 2068 5f6c  itAdjustDt = h_l
+0002e9f0: 6173 7444 6976 4164 6a75 7374 4474 0a20  astDivAdjustDt. 
+0002ea00: 2020 2020 2020 2064 665b 224c 6173 7444         df["LastD
+0002ea10: 6976 4164 6a75 7374 4474 225d 203d 2068  ivAdjustDt"] = h
+0002ea20: 5f6c 6173 7444 6976 4164 6a75 7374 4474  _lastDivAdjustDt
+0002ea30: 0a20 2020 2020 2020 2064 665b 224c 6173  .        df["Las
+0002ea40: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+0002ea50: 203d 2068 5f6c 6173 7453 706c 6974 4164   = h_lastSplitAd
+0002ea60: 6a75 7374 4474 0a0a 2020 2020 2020 2020  justDt..        
+0002ea70: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+0002ea80: 2020 2020 2020 7072 696e 7428 222d 2075        print("- u
+0002ea90: 6e61 646a 7573 7465 643a 2229 0a20 2020  nadjusted:").   
+0002eaa0: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
+0002eab0: 665b 5b22 436c 6f73 6522 2c20 2244 6976  f[["Close", "Div
+0002eac0: 6964 656e 6473 222c 2022 566f 6c75 6d65  idends", "Volume
+0002ead0: 222c 2022 4353 4622 2c20 2243 4446 225d  ", "CSF", "CDF"]
+0002eae0: 5d29 0a20 2020 2020 2020 2020 2020 2066  ]).            f
+0002eaf0: 203d 2064 665b 2244 6976 6964 656e 6473   = df["Dividends
+0002eb00: 225d 2021 3d20 302e 300a 2020 2020 2020  "] != 0.0.      
+0002eb10: 2020 2020 2020 6966 2066 2e61 6e79 2829        if f.any()
+0002eb20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002eb30: 2020 7072 696e 7428 222d 2064 6976 6964    print("- divid
+0002eb40: 656e 6473 3a22 290a 2020 2020 2020 2020  ends:").        
+0002eb50: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
+0002eb60: 2e6c 6f63 5b66 2c20 5b22 4f70 656e 222c  .loc[f, ["Open",
+0002eb70: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
+0002eb80: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
+0002eb90: 6e64 7322 2c20 2256 6f6c 756d 6522 2c20  nds", "Volume", 
+0002eba0: 2243 5346 222c 2022 4344 4622 5d5d 290a  "CSF", "CDF"]]).
+0002ebb0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0002ebc0: 7428 2222 290a 0a20 2020 2020 2020 206c  t("")..        l
+0002ebd0: 6f67 5f6d 7367 203d 2066 2250 4d3a 3a5f  og_msg = f"PM::_
+0002ebe0: 7265 7665 7273 6559 6168 6f6f 4164 6a75  reverseYahooAdju
+0002ebf0: 7374 2d7b 7365 6c66 2e69 7374 727d 2829  st-{self.istr}()
+0002ec00: 2072 6574 7572 6e69 6e67 220a 2020 2020   returning".    
+0002ec10: 2020 2020 6966 2079 6663 6c2e 4973 5472      if yfcl.IsTr
+0002ec20: 6163 696e 6745 6e61 626c 6564 2829 3a0a  acingEnabled():.
+0002ec30: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0002ec40: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+0002ec50: 7367 290a 2020 2020 2020 2020 656c 6966  sg).        elif
+0002ec60: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+0002ec70: 2020 2020 7072 696e 7428 6c6f 675f 6d73      print(log_ms
+0002ec80: 6729 0a0a 2020 2020 2020 2020 6966 2064  g)..        if d
+0002ec90: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+0002eca0: 2020 7072 696e 7428 6466 5b5b 224f 7065    print(df[["Ope
+0002ecb0: 6e22 2c20 224c 6f77 222c 2022 4869 6768  n", "Low", "High
+0002ecc0: 222c 2022 436c 6f73 6522 2c20 2244 6976  ", "Close", "Div
+0002ecd0: 6964 656e 6473 222c 2022 566f 6c75 6d65  idends", "Volume
+0002ece0: 222c 2022 4353 4622 5d5d 290a 0a20 2020  ", "CSF"]])..   
+0002ecf0: 2020 2020 2072 6574 7572 6e20 6466 0a0a       return df..
+0002ed00: 2020 2020 6465 6620 5f61 7070 6c79 4e65      def _applyNe
+0002ed10: 7745 7665 6e74 7328 7365 6c66 293a 0a20  wEvents(self):. 
+0002ed20: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+0002ed30: 2069 7320 4e6f 6e65 206f 7220 7365 6c66   is None or self
+0002ed40: 2e68 2e65 6d70 7479 3a0a 2020 2020 2020  .h.empty:.      
+0002ed50: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0002ed60: 2020 2020 2020 2320 6465 6275 6720 3d20        # debug = 
+0002ed70: 4661 6c73 650a 2020 2020 2020 2020 2320  False.        # 
+0002ed80: 6465 6275 6720 3d20 5472 7565 0a0a 2020  debug = True..  
+0002ed90: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
+0002eda0: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0002edb0: 2020 6c6f 675f 6d73 6720 3d20 6622 504d    log_msg = f"PM
+0002edc0: 3a3a 5f61 7070 6c79 4e65 7745 7665 6e74  ::_applyNewEvent
+0002edd0: 7328 292d 7b73 656c 662e 6973 7472 7d22  s()-{self.istr}"
+0002ede0: 0a20 2020 2020 2020 2069 6620 7966 636c  .        if yfcl
+0002edf0: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+0002ee00: 6428 293a 0a20 2020 2020 2020 2020 2020  d():.           
+0002ee10: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
+0002ee20: 286c 6f67 5f6d 7367 290a 0a20 2020 2020  (log_msg)..     
+0002ee30: 2020 2023 2042 6163 6b70 6f72 7420 6e65     # Backport ne
+0002ee40: 7720 7370 6c69 7473 2061 6372 6f73 7320  w splits across 
+0002ee50: 656e 7469 7265 2068 2074 6162 6c65 0a20  entire h table. 
+0002ee60: 2020 2020 2020 206c 6173 7453 706c 6974         lastSplit
+0002ee70: 4164 6a75 7374 4474 5f6d 696e 203d 2073  AdjustDt_min = s
+0002ee80: 656c 662e 685b 224c 6173 7453 706c 6974  elf.h["LastSplit
+0002ee90: 4164 6a75 7374 4474 225d 2e6d 696e 2829  AdjustDt"].min()
+0002eea0: 0a20 2020 2020 2020 2073 706c 6974 735f  .        splits_
+0002eeb0: 7369 6e63 6520 3d20 7365 6c66 2e6d 616e  since = self.man
+0002eec0: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
+0002eed0: 2245 7665 6e74 7322 292e 4765 7453 706c  "Events").GetSpl
+0002eee0: 6974 7346 6574 6368 6564 5369 6e63 6528  itsFetchedSince(
+0002eef0: 6c61 7374 5370 6c69 7441 646a 7573 7444  lastSplitAdjustD
+0002ef00: 745f 6d69 6e29 0a20 2020 2020 2020 2069  t_min).        i
+0002ef10: 6620 7370 6c69 7473 5f73 696e 6365 2069  f splits_since i
+0002ef20: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206e  s not None and n
+0002ef30: 6f74 2073 706c 6974 735f 7369 6e63 652e  ot splits_since.
+0002ef40: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
+0002ef50: 2020 204c 6173 7453 706c 6974 4164 6a75     LastSplitAdju
+0002ef60: 7374 4474 5f6e 6577 203d 2073 656c 662e  stDt_new = self.
+0002ef70: 685b 224c 6173 7453 706c 6974 4164 6a75  h["LastSplitAdju
+0002ef80: 7374 4474 225d 2e63 6f70 7928 290a 0a20  stDt"].copy().. 
+0002ef90: 2020 2020 2020 2020 2020 2066 5f73 7570             f_sup
+0002efa0: 203d 2073 706c 6974 735f 7369 6e63 655b   = splits_since[
+0002efb0: 2253 7570 6572 7365 6465 6420 7370 6c69  "Superseded spli
+0002efc0: 7422 5d20 213d 2030 2e30 0a20 2020 2020  t"] != 0.0.     
+0002efd0: 2020 2020 2020 2069 6620 665f 7375 702e         if f_sup.
+0002efe0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0002eff0: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+0002f000: 2073 706c 6974 735f 7369 6e63 652e 696e   splits_since.in
+0002f010: 6465 785b 665f 7375 705d 3a0a 2020 2020  dex[f_sup]:.    
+0002f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f030: 7370 6c69 7420 3d20 7370 6c69 7473 5f73  split = splits_s
+0002f040: 696e 6365 2e6c 6f63 5b64 745d 0a20 2020  ince.loc[dt].   
+0002f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f060: 2066 3120 3d20 7365 6c66 2e68 2e69 6e64   f1 = self.h.ind
+0002f070: 6578 203c 2064 740a 2020 2020 2020 2020  ex < dt.        
+0002f080: 2020 2020 2020 2020 2020 2020 6469 6666              diff
+0002f090: 3120 3d20 2873 656c 662e 685b 224c 6173  1 = (self.h["Las
+0002f0a0: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+0002f0b0: 202d 2073 706c 6974 5b22 5375 7065 7273   - split["Supers
+0002f0c0: 6564 6564 2073 706c 6974 2046 6574 6368  eded split Fetch
+0002f0d0: 4461 7465 225d 292e 6162 7328 290a 2020  Date"]).abs().  
+0002f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0f0: 2020 6632 203d 2028 6469 6666 3120 3c20    f2 = (diff1 < 
+0002f100: 7064 2e54 696d 6564 656c 7461 2822 3135  pd.Timedelta("15
+0002f110: 7322 2929 2e74 6f5f 6e75 6d70 7928 290a  s")).to_numpy().
+0002f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f130: 2020 2020 6469 6666 3220 3d20 2873 656c      diff2 = (sel
+0002f140: 662e 685b 2246 6574 6368 4461 7465 225d  f.h["FetchDate"]
+0002f150: 202d 2073 706c 6974 5b22 5375 7065 7273   - split["Supers
+0002f160: 6564 6564 2073 706c 6974 2046 6574 6368  eded split Fetch
+0002f170: 4461 7465 225d 292e 6162 7328 290a 2020  Date"]).abs().  
+0002f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f190: 2020 6633 203d 2028 6469 6666 3220 3c20    f3 = (diff2 < 
+0002f1a0: 7064 2e54 696d 6564 656c 7461 2822 3135  pd.Timedelta("15
+0002f1b0: 7322 2929 2e74 6f5f 6e75 6d70 7928 290a  s")).to_numpy().
+0002f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1d0: 2020 2020 6620 3d20 6631 2026 2028 6632      f = f1 & (f2
+0002f1e0: 207c 2066 3329 0a20 2020 2020 2020 2020   | f3).         
+0002f1f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002f200: 7420 662e 616e 7928 293a 0a20 2020 2020  t f.any():.     
+0002f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f220: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+0002f230: 7661 6c20 213d 2079 6663 642e 496e 7465  val != yfcd.Inte
+0002f240: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
+0002f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f260: 2020 2020 2020 2020 2320 5072 6f62 6162          # Probab
+0002f270: 6c79 206f 6b2c 2061 7373 756d 696e 6720  ly ok, assuming 
+0002f280: 7375 7065 7273 6564 6564 2073 706c 6974  superseded split
+0002f290: 2077 6173 206e 6576 6572 2061 7070 6c69   was never appli
+0002f2a0: 6564 2074 6f20 7468 6973 2070 7269 6365  ed to this price
+0002f2b0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+0002f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2d0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0002f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2f0: 2020 2070 7269 6e74 2873 706c 6974 290a     print(split).
+0002f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f310: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0002f320: 6365 7074 696f 6e28 2246 6f72 2073 7570  ception("For sup
+0002f330: 6572 7365 6465 6420 7370 6c69 7420 6162  erseded split ab
+0002f340: 6f76 652c 2066 6169 6c65 6420 746f 2069  ove, failed to i
+0002f350: 6465 6e74 6966 7920 726f 7773 2074 6f20  dentify rows to 
+0002f360: 756e 646f 2e20 5072 6f62 6c65 6d3f 2229  undo. Problem?")
+0002f370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f380: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3a0: 2020 2023 204e 6578 7420 6368 6563 6b3a     # Next check:
+0002f3b0: 2065 7870 6563 7420 6361 6368 6564 2043   expect cached C
+0002f3c0: 5346 2021 3d20 312e 300a 0a20 2020 2020  SF != 1.0..     
+0002f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3e0: 2020 206c 6f67 5f6d 7367 203d 2066 227b     log_msg = f"{
+0002f3f0: 7365 6c66 2e69 7374 727d 3a20 5265 7665  self.istr}: Reve
+0002f400: 7273 696e 6720 7370 6c69 7420 5b64 743d  rsing split [dt=
+0002f410: 7b64 742e 6461 7465 2829 7d20 7b73 706c  {dt.date()} {spl
+0002f420: 6974 5b27 5375 7065 7273 6564 6564 2073  it['Superseded s
+0002f430: 706c 6974 275d 7d20 6665 7463 683d 7b73  plit']} fetch={s
+0002f440: 706c 6974 5b27 5375 7065 7273 6564 6564  plit['Superseded
+0002f450: 2073 706c 6974 2046 6574 6368 4461 7465   split FetchDate
+0002f460: 275d 2e73 7472 6674 696d 6528 2725 592d  '].strftime('%Y-
+0002f470: 256d 2d25 6420 2548 3a25 4d3a 2553 257a  %m-%d %H:%M:%S%z
+0002f480: 2729 7d5d 220a 2020 2020 2020 2020 2020  ')}]".          
+0002f490: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0002f4a0: 6469 6365 7320 3d20 6e70 2e77 6865 7265  dices = np.where
+0002f4b0: 2866 295b 305d 0a20 2020 2020 2020 2020  (f)[0].         
+0002f4c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002f4d0: 6f67 5f6d 7367 202b 3d20 2220 6672 6f6d  og_msg += " from
+0002f4e0: 2069 6e74 6572 7661 6c73 2022 0a20 2020   intervals ".   
 0002f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f500: 2069 6620 6631 2e61 6e79 2829 3a0a 2020   if f1.any():.  
-0002f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f520: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002f530: 7370 6c69 7429 0a20 2020 2020 2020 2020  split).         
-0002f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f550: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-0002f560: 6f6e 2822 466f 7220 7375 7065 7273 6564  on("For supersed
-0002f570: 6564 2073 706c 6974 2061 626f 7665 2c20  ed split above, 
-0002f580: 6174 7465 6d70 7469 6e67 2074 6f20 756e  attempting to un
-0002f590: 646f 2073 706c 6974 2d61 646a 7573 7420  do split-adjust 
-0002f5a0: 6672 6f6d 2072 6f77 7320 7768 6572 6520  from rows where 
-0002f5b0: 4353 463d 312e 2049 6e76 6573 7469 6761  CSF=1. Investiga
-0002f5c0: 7465 2e22 290a 0a20 2020 2020 2020 2020  te.")..         
-0002f5d0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002f5e0: 6f67 5f6d 7367 203d 2066 227b 7365 6c66  og_msg = f"{self
-0002f5f0: 2e69 7374 727d 3a20 5265 7665 7273 696e  .istr}: Reversin
-0002f600: 6720 7370 6c69 7420 5b64 743d 7b64 742e  g split [dt={dt.
-0002f610: 6461 7465 2829 7d20 7b73 706c 6974 5b27  date()} {split['
-0002f620: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
-0002f630: 275d 7d20 6665 7463 683d 7b73 706c 6974  ']} fetch={split
-0002f640: 5b27 5375 7065 7273 6564 6564 2073 706c  ['Superseded spl
-0002f650: 6974 2046 6574 6368 4461 7465 275d 2e73  it FetchDate'].s
-0002f660: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
-0002f670: 6420 2548 3a25 4d3a 2553 257a 2729 7d5d  d %H:%M:%S%z')}]
-0002f680: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002f690: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-0002f6a0: 7320 3d20 6e70 2e77 6865 7265 2866 295b  s = np.where(f)[
-0002f6b0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-0002f6c0: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
-0002f6d0: 7367 202b 3d20 2220 6672 6f6d 2069 6e74  sg += " from int
-0002f6e0: 6572 7661 6c73 2022 0a20 2020 2020 2020  ervals ".       
+0002f500: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+0002f510: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+0002f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f530: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
+0002f540: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
+0002f550: 6469 6365 735b 305d 5d2e 6461 7465 2829  dices[0]].date()
+0002f560: 7d20 2d3e 207b 7365 6c66 2e68 2e69 6e64  } -> {self.h.ind
+0002f570: 6578 5b69 6e64 6963 6573 5b2d 315d 5d2e  ex[indices[-1]].
+0002f580: 6461 7465 2829 7d20 2869 6e63 2922 0a20  date()} (inc)". 
+0002f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5c0: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+0002f5d0: 202b 3d20 6622 7b73 656c 662e 682e 696e   += f"{self.h.in
+0002f5e0: 6465 785b 696e 6469 6365 735b 305d 5d7d  dex[indices[0]]}
+0002f5f0: 202d 3e20 7b73 656c 662e 682e 696e 6465   -> {self.h.inde
+0002f600: 785b 696e 6469 6365 735b 2d31 5d5d 7d22  x[indices[-1]]}"
+0002f610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f620: 2020 2020 2020 2020 2068 5f6c 6173 7452           h_lastR
+0002f630: 6f77 203d 2073 656c 662e 682e 6c6f 635b  ow = self.h.loc[
+0002f640: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
+0002f650: 6963 6573 5b2d 315d 5d5d 0a20 2020 2020  ices[-1]]].     
+0002f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f670: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
+0002f680: 2e20 4c61 7374 2043 5346 203d 207b 685f  . Last CSF = {h_
+0002f690: 6c61 7374 526f 775b 2743 5346 275d 3a2e  lastRow['CSF']:.
+0002f6a0: 3566 7d20 4020 7b68 5f6c 6173 7452 6f77  5f} @ {h_lastRow
+0002f6b0: 5b27 4c61 7374 5370 6c69 7441 646a 7573  ['LastSplitAdjus
+0002f6c0: 7444 7427 5d2e 7374 7266 7469 6d65 2827  tDt'].strftime('
+0002f6d0: 2559 2d25 6d2d 2564 2025 483a 254d 3a25  %Y-%m-%d %H:%M:%
+0002f6e0: 5325 7a27 297d 220a 2020 2020 2020 2020  S%z')}".        
 0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f700: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
-0002f710: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0002f720: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002f730: 6f67 5f6d 7367 202b 3d20 6622 7b73 656c  og_msg += f"{sel
-0002f740: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
-0002f750: 735b 305d 5d2e 6461 7465 2829 7d20 2d3e  s[0]].date()} ->
-0002f760: 207b 7365 6c66 2e68 2e69 6e64 6578 5b69   {self.h.index[i
-0002f770: 6e64 6963 6573 5b2d 315d 5d2e 6461 7465  ndices[-1]].date
-0002f780: 2829 7d20 2869 6e63 2922 0a20 2020 2020  ()} (inc)".     
-0002f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7c0: 2020 2020 206c 6f67 5f6d 7367 202b 3d20       log_msg += 
-0002f7d0: 6622 7b73 656c 662e 682e 696e 6465 785b  f"{self.h.index[
-0002f7e0: 696e 6469 6365 735b 305d 5d7d 202d 3e20  indices[0]]} -> 
-0002f7f0: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
-0002f800: 6469 6365 735b 2d31 5d5d 7d22 0a20 2020  dices[-1]]}".   
-0002f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f820: 2020 2020 2068 5f6c 6173 7452 6f77 203d       h_lastRow =
-0002f830: 2073 656c 662e 682e 6c6f 635b 7365 6c66   self.h.loc[self
-0002f840: 2e68 2e69 6e64 6578 5b69 6e64 6963 6573  .h.index[indices
-0002f850: 5b2d 315d 5d5d 0a20 2020 2020 2020 2020  [-1]]].         
-0002f860: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002f870: 6f67 5f6d 7367 202b 3d20 6622 2e20 4c61  og_msg += f". La
-0002f880: 7374 2043 5346 203d 207b 685f 6c61 7374  st CSF = {h_last
-0002f890: 526f 775b 2743 5346 275d 3a2e 3566 7d20  Row['CSF']:.5f} 
-0002f8a0: 4020 7b68 5f6c 6173 7452 6f77 5b27 4c61  @ {h_lastRow['La
-0002f8b0: 7374 5370 6c69 7441 646a 7573 7444 7427  stSplitAdjustDt'
-0002f8c0: 5d2e 7374 7266 7469 6d65 2827 2559 2d25  ].strftime('%Y-%
-0002f8d0: 6d2d 2564 2025 483a 254d 3a25 5325 7a27  m-%d %H:%M:%S%z'
-0002f8e0: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-0002f8f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002f900: 2e6d 616e 6167 6572 2e4c 6f67 4576 656e  .manager.LogEven
-0002f910: 7428 2269 6e66 6f22 2c20 2250 7269 6365  t("info", "Price
-0002f920: 4d61 6e61 6765 7222 2c20 6c6f 675f 6d73  Manager", log_ms
-0002f930: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0002f940: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-0002f950: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-0002f960: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
-0002f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f980: 2023 2020 2020 2079 6663 6c2e 5472 6163   #     yfcl.Trac
-0002f990: 6550 7269 6e74 286c 6f67 5f6d 7367 290a  ePrint(log_msg).
-0002f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9b0: 2020 2020 2020 2020 2320 656c 6966 2064          # elif d
-0002f9c0: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-0002f9d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002f9e0: 2020 2020 7072 696e 7428 6622 556e 646f      print(f"Undo
-0002f9f0: 6e65 2073 7570 6572 7365 6465 6420 7370  ne superseded sp
-0002fa00: 6c69 7420 4020 7b64 747d 3a22 290a 2020  lit @ {dt}:").  
+0002f700: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
+0002f710: 4576 656e 7428 2269 6e66 6f22 2c20 2250  Event("info", "P
+0002f720: 7269 6365 4d61 6e61 6765 7222 2c20 6c6f  riceManager", lo
+0002f730: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
+0002f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f750: 7365 6c66 2e68 2e6c 6f63 5b66 2c20 2243  self.h.loc[f, "C
+0002f760: 5346 225d 202a 3d20 7370 6c69 745b 2253  SF"] *= split["S
+0002f770: 746f 636b 2053 706c 6974 7322 5d0a 2020  tock Splits"].  
+0002f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f790: 2020 2020 2020 4c61 7374 5370 6c69 7441        LastSplitA
+0002f7a0: 646a 7573 7444 745f 6e65 775b 665d 203d  djustDt_new[f] =
+0002f7b0: 206e 702e 6d61 7869 6d75 6d28 7370 6c69   np.maximum(spli
+0002f7c0: 745b 2746 6574 6368 4461 7465 275d 2c20  t['FetchDate'], 
+0002f7d0: 4c61 7374 5370 6c69 7441 646a 7573 7444  LastSplitAdjustD
+0002f7e0: 745f 6e65 775b 665d 290a 0a20 2020 2020  t_new[f])..     
+0002f7f0: 2020 2020 2020 2066 6f72 2064 7420 696e         for dt in
+0002f800: 2073 706c 6974 735f 7369 6e63 652e 696e   splits_since.in
+0002f810: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
+0002f820: 2020 2020 2073 706c 6974 203d 2073 706c       split = spl
+0002f830: 6974 735f 7369 6e63 652e 6c6f 635b 6474  its_since.loc[dt
+0002f840: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0002f850: 2020 6631 203d 2073 656c 662e 682e 696e    f1 = self.h.in
+0002f860: 6465 7820 3c20 6474 0a20 2020 2020 2020  dex < dt.       
+0002f870: 2020 2020 2020 2020 2066 3220 3d20 7365           f2 = se
+0002f880: 6c66 2e68 5b22 4c61 7374 5370 6c69 7441  lf.h["LastSplitA
+0002f890: 646a 7573 7444 7422 5d20 3c20 7370 6c69  djustDt"] < spli
+0002f8a0: 745b 2246 6574 6368 4461 7465 225d 0a20  t["FetchDate"]. 
+0002f8b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002f8c0: 203d 2066 3120 2620 6632 0a20 2020 2020   = f1 & f2.     
+0002f8d0: 2020 2020 2020 2020 2020 2069 6620 662e             if f.
+0002f8e0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0002f8f0: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
+0002f900: 7367 203d 2066 227b 7365 6c66 2e69 7374  sg = f"{self.ist
+0002f910: 727d 3a20 4170 706c 7969 6e67 2073 706c  r}: Applying spl
+0002f920: 6974 205b 6474 3d7b 6474 2e64 6174 6528  it [dt={dt.date(
+0002f930: 297d 207b 7370 6c69 745b 2753 746f 636b  )} {split['Stock
+0002f940: 2053 706c 6974 7327 5d7d 2066 6574 6368   Splits']} fetch
+0002f950: 3d7b 7370 6c69 745b 2746 6574 6368 4461  ={split['FetchDa
+0002f960: 7465 275d 2e73 7472 6674 696d 6528 2725  te'].strftime('%
+0002f970: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+0002f980: 257a 2729 7d5d 220a 2020 2020 2020 2020  %z')}]".        
+0002f990: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+0002f9a0: 6365 7320 3d20 6e70 2e77 6865 7265 2866  ces = np.where(f
+0002f9b0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0002f9c0: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+0002f9d0: 202b 3d20 2220 6163 726f 7373 2069 6e74   += " across int
+0002f9e0: 6572 7661 6c73 2022 0a20 2020 2020 2020  ervals ".       
+0002f9f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002fa00: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
 0002fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa20: 2020 2020 2020 2320 2020 2020 7072 696e        #     prin
-0002fa30: 7428 7365 6c66 2e68 2e6c 6f63 5b66 2c20  t(self.h.loc[f, 
-0002fa40: 5b22 4353 4622 2c20 2246 6574 6368 4461  ["CSF", "FetchDa
-0002fa50: 7465 222c 2022 4c61 7374 5370 6c69 7441  te", "LastSplitA
-0002fa60: 646a 7573 7444 7422 5d5d 290a 2020 2020  djustDt"]]).    
-0002fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa80: 2020 2020 2320 2020 2020 7072 696e 7428      #     print(
-0002fa90: 2222 290a 0a20 2020 2020 2020 2020 2020  "")..           
-0002faa0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002fab0: 662e 682e 6c6f 635b 662c 2022 4353 4622  f.h.loc[f, "CSF"
-0002fac0: 5d20 2a3d 2073 706c 6974 5b22 5374 6f63  ] *= split["Stoc
-0002fad0: 6b20 5370 6c69 7473 225d 0a0a 2020 2020  k Splits"]..    
-0002fae0: 2020 2020 2020 2020 4c61 7374 5370 6c69          LastSpli
-0002faf0: 7441 646a 7573 7444 745f 6e65 7720 3d20  tAdjustDt_new = 
-0002fb00: 7365 6c66 2e68 5b22 4c61 7374 5370 6c69  self.h["LastSpli
-0002fb10: 7441 646a 7573 7444 7422 5d2e 636f 7079  tAdjustDt"].copy
-0002fb20: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
-0002fb30: 6f72 2064 7420 696e 2073 706c 6974 735f  or dt in splits_
-0002fb40: 7369 6e63 652e 696e 6465 783a 0a20 2020  since.index:.   
-0002fb50: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-0002fb60: 6974 203d 2073 706c 6974 735f 7369 6e63  it = splits_sinc
-0002fb70: 652e 6c6f 635b 6474 5d0a 2020 2020 2020  e.loc[dt].      
-0002fb80: 2020 2020 2020 2020 2020 6631 203d 2073            f1 = s
-0002fb90: 656c 662e 682e 696e 6465 7820 3c20 6474  elf.h.index < dt
-0002fba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fbb0: 2066 3220 3d20 7365 6c66 2e68 5b22 4c61   f2 = self.h["La
-0002fbc0: 7374 5370 6c69 7441 646a 7573 7444 7422  stSplitAdjustDt"
-0002fbd0: 5d20 3c20 7370 6c69 745b 2246 6574 6368  ] < split["Fetch
-0002fbe0: 4461 7465 225d 0a20 2020 2020 2020 2020  Date"].         
-0002fbf0: 2020 2020 2020 2066 203d 2066 3120 2620         f = f1 & 
-0002fc00: 6632 0a20 2020 2020 2020 2020 2020 2020  f2.             
-0002fc10: 2020 2069 6620 662e 616e 7928 293a 0a20     if f.any():. 
-0002fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc30: 2020 2023 206d 7367 203d 2066 227b 7365     # msg = f"{se
-0002fc40: 6c66 2e74 6963 6b65 727d 3a20 7b73 656c  lf.ticker}: {sel
-0002fc50: 662e 6973 7472 7d3a 2041 7070 6c79 696e  f.istr}: Applyin
-0002fc60: 6720 7370 6c69 7420 7b73 706c 6974 5b27  g split {split['
-0002fc70: 5374 6f63 6b20 5370 6c69 7473 275d 7d20  Stock Splits']} 
-0002fc80: 4020 7b64 742e 6461 7465 2829 7d22 0a20  @ {dt.date()}". 
-0002fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fca0: 2020 2023 2069 6e64 6963 6573 203d 206e     # indices = n
-0002fcb0: 702e 7768 6572 6528 6629 5b30 5d0a 2020  p.where(f)[0].  
-0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fcd0: 2020 2320 6d73 6720 2b3d 2066 2220 6163    # msg += f" ac
-0002fce0: 726f 7373 2069 6e74 6572 7661 6c73 2022  ross intervals "
-0002fcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fd00: 2020 2020 2023 2069 6620 7365 6c66 2e69       # if self.i
-0002fd10: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
-0002fd20: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0002fd30: 2020 206d 7367 202b 3d20 6622 7b73 656c     msg += f"{sel
-0002fd40: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
-0002fd50: 735b 305d 5d2e 6461 7465 2829 7d20 2d3e  s[0]].date()} ->
-0002fd60: 207b 7365 6c66 2e68 2e69 6e64 6578 5b69   {self.h.index[i
-0002fd70: 6e64 6963 6573 5b2d 315d 5d2e 6461 7465  ndices[-1]].date
-0002fd80: 2829 7d20 2869 6e63 2922 0a20 2020 2020  ()} (inc)".     
-0002fd90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002fda0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002fdb0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0002fdc0: 206d 7367 202b 3d20 6622 7b73 656c 662e   msg += f"{self.
-0002fdd0: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
-0002fde0: 305d 5d7d 202d 3e20 7b73 656c 662e 682e  0]]} -> {self.h.
-0002fdf0: 696e 6465 785b 696e 6469 6365 735b 2d31  index[indices[-1
-0002fe00: 5d5d 7d22 0a20 2020 2020 2020 2020 2020  ]]}".           
-0002fe10: 2020 2020 2020 2020 2023 206d 7367 202b           # msg +
-0002fe20: 3d20 6622 206c 6173 7420 4353 4620 3d20  = f" last CSF = 
-0002fe30: 7b73 656c 662e 685b 2743 5346 275d 2e69  {self.h['CSF'].i
-0002fe40: 6c6f 635b 696e 6469 6365 735b 2d31 5d5d  loc[indices[-1]]
-0002fe50: 3a2e 3566 7d22 0a20 2020 2020 2020 2020  :.5f}".         
-0002fe60: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-0002fe70: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-0002fe80: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
-0002fe90: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0002fea0: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-0002feb0: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
-0002fec0: 2020 2020 2020 2020 2020 2020 2320 656c              # el
-0002fed0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-0002fee0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002fef0: 2020 2020 7072 696e 7428 6622 7b73 656c      print(f"{sel
-0002ff00: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-0002ff10: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-0002ff20: 2020 2020 2020 2020 6c6f 675f 6d73 6720          log_msg 
-0002ff30: 3d20 6622 7b73 656c 662e 6973 7472 7d3a  = f"{self.istr}:
-0002ff40: 2041 7070 6c79 696e 6720 7370 6c69 7420   Applying split 
-0002ff50: 5b64 743d 7b64 742e 6461 7465 2829 7d20  [dt={dt.date()} 
-0002ff60: 7b73 706c 6974 5b27 5374 6f63 6b20 5370  {split['Stock Sp
-0002ff70: 6c69 7473 275d 7d20 6665 7463 683d 7b73  lits']} fetch={s
-0002ff80: 706c 6974 5b27 4665 7463 6844 6174 6527  plit['FetchDate'
-0002ff90: 5d2e 7374 7266 7469 6d65 2827 2559 2d25  ].strftime('%Y-%
-0002ffa0: 6d2d 2564 2025 483a 254d 3a25 5325 7a27  m-%d %H:%M:%S%z'
-0002ffb0: 297d 5d22 0a20 2020 2020 2020 2020 2020  )}]".           
-0002ffc0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-0002ffd0: 203d 206e 702e 7768 6572 6528 6629 5b30   = np.where(f)[0
-0002ffe0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0002fff0: 2020 2020 2020 6c6f 675f 6d73 6720 2b3d        log_msg +=
-00030000: 2022 2061 6372 6f73 7320 696e 7465 7276   " across interv
-00030010: 616c 7320 220a 2020 2020 2020 2020 2020  als ".          
-00030020: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00030030: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
-00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030050: 2020 2020 6c6f 675f 6d73 6720 2b3d 2066      log_msg += f
-00030060: 227b 7365 6c66 2e68 2e69 6e64 6578 5b69  "{self.h.index[i
-00030070: 6e64 6963 6573 5b30 5d5d 2e64 6174 6528  ndices[0]].date(
-00030080: 297d 202d 3e20 7b73 656c 662e 682e 696e  )} -> {self.h.in
-00030090: 6465 785b 696e 6469 6365 735b 2d31 5d5d  dex[indices[-1]]
-000300a0: 2e64 6174 6528 297d 2028 696e 6329 220a  .date()} (inc)".
-000300b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000300d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300e0: 2020 6c6f 675f 6d73 6720 2b3d 2066 227b    log_msg += f"{
-000300f0: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
-00030100: 6963 6573 5b30 5d5d 7d20 2d3e 207b 7365  ices[0]]} -> {se
-00030110: 6c66 2e68 2e69 6e64 6578 5b69 6e64 6963  lf.h.index[indic
-00030120: 6573 5b2d 315d 5d7d 220a 2020 2020 2020  es[-1]]}".      
-00030130: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00030140: 6c61 7374 526f 7720 3d20 7365 6c66 2e68  lastRow = self.h
-00030150: 2e6c 6f63 5b73 656c 662e 682e 696e 6465  .loc[self.h.inde
-00030160: 785b 696e 6469 6365 735b 2d31 5d5d 5d0a  x[indices[-1]]].
-00030170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030180: 2020 2020 6c6f 675f 6d73 6720 2b3d 2066      log_msg += f
-00030190: 222e 204c 6173 7420 4353 4620 3d20 7b68  ". Last CSF = {h
-000301a0: 5f6c 6173 7452 6f77 5b27 4353 4627 5d3a  _lastRow['CSF']:
-000301b0: 2e35 667d 2040 207b 685f 6c61 7374 526f  .5f} @ {h_lastRo
-000301c0: 775b 274c 6173 7453 706c 6974 4164 6a75  w['LastSplitAdju
-000301d0: 7374 4474 275d 2e73 7472 6674 696d 6528  stDt'].strftime(
-000301e0: 2725 592d 256d 2d25 6420 2548 3a25 4d3a  '%Y-%m-%d %H:%M:
-000301f0: 2553 257a 2729 7d22 0a20 2020 2020 2020  %S%z')}".       
-00030200: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00030210: 662e 6d61 6e61 6765 722e 4c6f 6745 7665  f.manager.LogEve
-00030220: 6e74 2822 696e 666f 222c 2022 5072 6963  nt("info", "Pric
-00030230: 654d 616e 6167 6572 222c 206c 6f67 5f6d  eManager", log_m
-00030240: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-00030250: 2020 2020 2020 2020 2320 6966 2079 6663          # if yfc
-00030260: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
-00030270: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
-00030280: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00030290: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-000302a0: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
-000302b0: 2020 2020 2020 2020 2020 2020 2023 2065               # e
-000302c0: 6c69 6620 6465 6275 673a 0a20 2020 2020  lif debug:.     
-000302d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000302e0: 2020 2020 2070 7269 6e74 2866 227b 7365       print(f"{se
-000302f0: 6c66 2e74 6963 6b65 727d 3a20 222b 6c6f  lf.ticker}: "+lo
-00030300: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
-00030310: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00030320: 7369 6e73 7461 6e63 6528 7365 6c66 2e68  sinstance(self.h
-00030330: 5b22 4353 4622 5d2e 696c 6f63 5b30 5d2c  ["CSF"].iloc[0],
-00030340: 2028 696e 742c 206e 702e 696e 7436 3429   (int, np.int64)
-00030350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00030360: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00030370: 685b 2243 5346 225d 203d 2073 656c 662e  h["CSF"] = self.
-00030380: 685b 2243 5346 225d 2e61 7374 7970 6528  h["CSF"].astype(
-00030390: 666c 6f61 7429 0a20 2020 2020 2020 2020  float).         
-000303a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000303b0: 682e 6c6f 635b 662c 2022 4353 4622 5d20  h.loc[f, "CSF"] 
-000303c0: 2f3d 2073 706c 6974 5b22 5374 6f63 6b20  /= split["Stock 
-000303d0: 5370 6c69 7473 225d 0a20 2020 2020 2020  Splits"].       
-000303e0: 2020 2020 2020 2020 2020 2020 204c 6173               Las
-000303f0: 7453 706c 6974 4164 6a75 7374 4474 5f6e  tSplitAdjustDt_n
-00030400: 6577 2e6c 6f63 5b66 5d20 3d20 6e70 2e6d  ew.loc[f] = np.m
-00030410: 6178 696d 756d 284c 6173 7453 706c 6974  aximum(LastSplit
-00030420: 4164 6a75 7374 4474 5f6e 6577 5b66 5d2c  AdjustDt_new[f],
-00030430: 2073 706c 6974 5b22 4665 7463 6844 6174   split["FetchDat
-00030440: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
-00030450: 2073 656c 662e 685b 224c 6173 7453 706c   self.h["LastSpl
-00030460: 6974 4164 6a75 7374 4474 225d 203d 204c  itAdjustDt"] = L
-00030470: 6173 7453 706c 6974 4164 6a75 7374 4474  astSplitAdjustDt
-00030480: 5f6e 6577 0a0a 2020 2020 2020 2020 2020  _new..          
-00030490: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
-000304a0: 7275 650a 0a20 2020 2020 2020 2023 2042  rue..        # B
-000304b0: 6163 6b70 6f72 7420 6e65 7720 6469 7673  ackport new divs
-000304c0: 2061 6372 6f73 7320 656e 7469 7265 2068   across entire h
-000304d0: 2074 6162 6c65 0a20 2020 2020 2020 206c   table.        l
-000304e0: 6173 7444 6976 4164 6a75 7374 4474 5f6d  astDivAdjustDt_m
-000304f0: 696e 203d 2073 656c 662e 685b 224c 6173  in = self.h["Las
-00030500: 7444 6976 4164 6a75 7374 4474 225d 2e6d  tDivAdjustDt"].m
-00030510: 696e 2829 0a20 2020 2020 2020 2069 6620  in().        if 
-00030520: 6973 696e 7374 616e 6365 286c 6173 7444  isinstance(lastD
-00030530: 6976 4164 6a75 7374 4474 5f6d 696e 2e74  ivAdjustDt_min.t
-00030540: 7a69 6e66 6f2c 2070 7974 7a2e 4261 7365  zinfo, pytz.Base
-00030550: 547a 496e 666f 293a 0a20 2020 2020 2020  TzInfo):.       
-00030560: 2020 2020 2073 656c 662e 685b 224c 6173       self.h["Las
-00030570: 7444 6976 4164 6a75 7374 4474 225d 203d  tDivAdjustDt"] =
-00030580: 2073 656c 662e 685b 224c 6173 7444 6976   self.h["LastDiv
-00030590: 4164 6a75 7374 4474 225d 2e64 742e 747a  AdjustDt"].dt.tz
-000305a0: 5f63 6f6e 7665 7274 2873 656c 662e 682e  _convert(self.h.
-000305b0: 696e 6465 782e 747a 290a 2020 2020 2020  index.tz).      
-000305c0: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
-000305d0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-000305e0: 2020 2020 6c61 7374 4469 7641 646a 7573      lastDivAdjus
-000305f0: 7444 745f 6d69 6e20 3d20 7365 6c66 2e68  tDt_min = self.h
-00030600: 5b22 4c61 7374 4469 7641 646a 7573 7444  ["LastDivAdjustD
-00030610: 7422 5d2e 6d69 6e28 290a 2020 2020 2020  t"].min().      
-00030620: 2020 6469 7673 5f73 696e 6365 203d 2073    divs_since = s
-00030630: 656c 662e 6d61 6e61 6765 722e 4765 7448  elf.manager.GetH
-00030640: 6973 746f 7279 2822 4576 656e 7473 2229  istory("Events")
-00030650: 2e47 6574 4469 7673 4665 7463 6865 6453  .GetDivsFetchedS
-00030660: 696e 6365 286c 6173 7444 6976 4164 6a75  ince(lastDivAdju
-00030670: 7374 4474 5f6d 696e 290a 2020 2020 2020  stDt_min).      
-00030680: 2020 6966 2064 6976 735f 7369 6e63 6520    if divs_since 
-00030690: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-000306a0: 6e6f 7420 6469 7673 5f73 696e 6365 2e65  not divs_since.e
-000306b0: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-000306c0: 2020 665f 7375 7020 3d20 6469 7673 5f73    f_sup = divs_s
-000306d0: 696e 6365 5b22 5375 7065 7273 6564 6564  ince["Superseded
-000306e0: 2062 6163 6b20 6164 6a2e 225d 2021 3d20   back adj."] != 
-000306f0: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-00030700: 6966 2066 5f73 7570 2e61 6e79 2829 3a0a  if f_sup.any():.
-00030710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030720: 666f 7220 6474 2069 6e20 6469 7673 5f73  for dt in divs_s
-00030730: 696e 6365 2e69 6e64 6578 5b66 5f73 7570  ince.index[f_sup
-00030740: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00030750: 2020 2020 2020 2064 6976 203d 2064 6976         div = div
-00030760: 735f 7369 6e63 652e 6c6f 635b 6474 5d0a  s_since.loc[dt].
-00030770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030780: 2020 2020 6631 203d 2073 656c 662e 682e      f1 = self.h.
-00030790: 696e 6465 7820 3c20 6474 0a20 2020 2020  index < dt.     
-000307a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000307b0: 2055 7064 6174 653a 206e 6577 2073 7472   Update: new str
-000307c0: 6174 6567 790a 2020 2020 2020 2020 2020  ategy.          
-000307d0: 2020 2020 2020 2020 2020 2320 496e 7374            # Inst
-000307e0: 6561 6420 6f66 206c 6173 7420 6164 6a75  ead of last adju
-000307f0: 7374 2062 6569 6e67 2074 6865 2073 7570  st being the sup
-00030800: 6572 7365 6465 6420 6469 7669 6465 6e64  erseded dividend
-00030810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00030820: 2020 2020 2020 2320 7365 7420 636f 6e64        # set cond
-00030830: 6974 696f 6e20 6173 206c 6173 7420 6164  ition as last ad
-00030840: 6a75 7374 2062 6569 6e67 2062 6566 6f72  just being befor
-00030850: 6520 7468 6973 206e 6577 2064 6976 6964  e this new divid
-00030860: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
-00030870: 2020 2020 2020 2020 6632 203d 2028 2864          f2 = ((d
-00030880: 6976 5b22 4665 7463 6844 6174 6522 5d20  iv["FetchDate"] 
-00030890: 2d20 7365 6c66 2e68 5b22 4c61 7374 4469  - self.h["LastDi
-000308a0: 7641 646a 7573 7444 7422 5d29 203e 2070  vAdjustDt"]) > p
-000308b0: 642e 5469 6d65 6465 6c74 6128 2731 6d27  d.Timedelta('1m'
-000308c0: 2929 2e74 6f5f 6e75 6d70 7928 290a 2020  )).to_numpy().  
-000308d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308e0: 2020 6633 203d 2028 2864 6976 5b22 4665    f3 = ((div["Fe
-000308f0: 7463 6844 6174 6522 5d20 2d20 7365 6c66  tchDate"] - self
-00030900: 2e68 5b22 4665 7463 6844 6174 6522 5d29  .h["FetchDate"])
-00030910: 203e 2070 642e 5469 6d65 6465 6c74 6128   > pd.Timedelta(
-00030920: 2731 6d27 2929 2e74 6f5f 6e75 6d70 7928  '1m')).to_numpy(
-00030930: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00030940: 2020 2020 2020 6620 3d20 6631 2026 2028        f = f1 & (
-00030950: 6632 2026 2066 3329 0a20 2020 2020 2020  f2 & f3).       
-00030960: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00030970: 6e6f 7420 662e 616e 7928 293a 0a20 2020  not f.any():.   
-00030980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030990: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-000309a0: 6572 7661 6c20 213d 2079 6663 642e 496e  erval != yfcd.In
-000309b0: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
+0002fa20: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
+0002fa30: 3d20 6622 7b73 656c 662e 682e 696e 6465  = f"{self.h.inde
+0002fa40: 785b 696e 6469 6365 735b 305d 5d2e 6461  x[indices[0]].da
+0002fa50: 7465 2829 7d20 2d3e 207b 7365 6c66 2e68  te()} -> {self.h
+0002fa60: 2e69 6e64 6578 5b69 6e64 6963 6573 5b2d  .index[indices[-
+0002fa70: 315d 5d2e 6461 7465 2829 7d20 2869 6e63  1]].date()} (inc
+0002fa80: 2922 0a20 2020 2020 2020 2020 2020 2020  )".             
+0002fa90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fab0: 2020 2020 206c 6f67 5f6d 7367 202b 3d20       log_msg += 
+0002fac0: 6622 7b73 656c 662e 682e 696e 6465 785b  f"{self.h.index[
+0002fad0: 696e 6469 6365 735b 305d 5d7d 202d 3e20  indices[0]]} -> 
+0002fae0: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
+0002faf0: 6469 6365 735b 2d31 5d5d 7d22 0a20 2020  dices[-1]]}".   
+0002fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fb10: 2068 5f6c 6173 7452 6f77 203d 2073 656c   h_lastRow = sel
+0002fb20: 662e 682e 6c6f 635b 7365 6c66 2e68 2e69  f.h.loc[self.h.i
+0002fb30: 6e64 6578 5b69 6e64 6963 6573 5b2d 315d  ndex[indices[-1]
+0002fb40: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+0002fb50: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
+0002fb60: 3d20 6622 2e20 4c61 7374 2043 5346 203d  = f". Last CSF =
+0002fb70: 207b 685f 6c61 7374 526f 775b 2743 5346   {h_lastRow['CSF
+0002fb80: 275d 3a2e 3566 7d20 4020 7b68 5f6c 6173  ']:.5f} @ {h_las
+0002fb90: 7452 6f77 5b27 4c61 7374 5370 6c69 7441  tRow['LastSplitA
+0002fba0: 646a 7573 7444 7427 5d2e 7374 7266 7469  djustDt'].strfti
+0002fbb0: 6d65 2827 2559 2d25 6d2d 2564 2025 483a  me('%Y-%m-%d %H:
+0002fbc0: 254d 3a25 5325 7a27 297d 220a 2020 2020  %M:%S%z')}".    
+0002fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fbe0: 7365 6c66 2e6d 616e 6167 6572 2e4c 6f67  self.manager.Log
+0002fbf0: 4576 656e 7428 2269 6e66 6f22 2c20 2250  Event("info", "P
+0002fc00: 7269 6365 4d61 6e61 6765 7222 2c20 6c6f  riceManager", lo
+0002fc10: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
+0002fc20: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0002fc30: 7369 6e73 7461 6e63 6528 7365 6c66 2e68  sinstance(self.h
+0002fc40: 5b22 4353 4622 5d2e 696c 6f63 5b30 5d2c  ["CSF"].iloc[0],
+0002fc50: 2028 696e 742c 206e 702e 696e 7436 3429   (int, np.int64)
+0002fc60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002fc70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002fc80: 685b 2243 5346 225d 203d 2073 656c 662e  h["CSF"] = self.
+0002fc90: 685b 2243 5346 225d 2e61 7374 7970 6528  h["CSF"].astype(
+0002fca0: 666c 6f61 7429 0a20 2020 2020 2020 2020  float).         
+0002fcb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002fcc0: 682e 6c6f 635b 662c 2022 4353 4622 5d20  h.loc[f, "CSF"] 
+0002fcd0: 2f3d 2073 706c 6974 5b22 5374 6f63 6b20  /= split["Stock 
+0002fce0: 5370 6c69 7473 225d 0a20 2020 2020 2020  Splits"].       
+0002fcf0: 2020 2020 2020 2020 2020 2020 204c 6173               Las
+0002fd00: 7453 706c 6974 4164 6a75 7374 4474 5f6e  tSplitAdjustDt_n
+0002fd10: 6577 2e6c 6f63 5b66 5d20 3d20 6e70 2e6d  ew.loc[f] = np.m
+0002fd20: 6178 696d 756d 284c 6173 7453 706c 6974  aximum(LastSplit
+0002fd30: 4164 6a75 7374 4474 5f6e 6577 5b66 5d2c  AdjustDt_new[f],
+0002fd40: 2073 706c 6974 5b22 4665 7463 6844 6174   split["FetchDat
+0002fd50: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0002fd60: 2073 656c 662e 685b 224c 6173 7453 706c   self.h["LastSpl
+0002fd70: 6974 4164 6a75 7374 4474 225d 203d 204c  itAdjustDt"] = L
+0002fd80: 6173 7453 706c 6974 4164 6a75 7374 4474  astSplitAdjustDt
+0002fd90: 5f6e 6577 0a0a 2020 2020 2020 2020 2020  _new..          
+0002fda0: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
+0002fdb0: 7275 650a 0a20 2020 2020 2020 2023 2042  rue..        # B
+0002fdc0: 6163 6b70 6f72 7420 6e65 7720 6469 7673  ackport new divs
+0002fdd0: 2061 6372 6f73 7320 656e 7469 7265 2068   across entire h
+0002fde0: 2074 6162 6c65 0a20 2020 2020 2020 206c   table.        l
+0002fdf0: 6173 7444 6976 4164 6a75 7374 4474 5f6d  astDivAdjustDt_m
+0002fe00: 696e 203d 2073 656c 662e 685b 224c 6173  in = self.h["Las
+0002fe10: 7444 6976 4164 6a75 7374 4474 225d 2e6d  tDivAdjustDt"].m
+0002fe20: 696e 2829 0a20 2020 2020 2020 2069 6620  in().        if 
+0002fe30: 6973 696e 7374 616e 6365 286c 6173 7444  isinstance(lastD
+0002fe40: 6976 4164 6a75 7374 4474 5f6d 696e 2e74  ivAdjustDt_min.t
+0002fe50: 7a69 6e66 6f2c 2070 7974 7a2e 4261 7365  zinfo, pytz.Base
+0002fe60: 547a 496e 666f 293a 0a20 2020 2020 2020  TzInfo):.       
+0002fe70: 2020 2020 2073 656c 662e 685b 224c 6173       self.h["Las
+0002fe80: 7444 6976 4164 6a75 7374 4474 225d 203d  tDivAdjustDt"] =
+0002fe90: 2073 656c 662e 685b 224c 6173 7444 6976   self.h["LastDiv
+0002fea0: 4164 6a75 7374 4474 225d 2e64 742e 747a  AdjustDt"].dt.tz
+0002feb0: 5f63 6f6e 7665 7274 2873 656c 662e 682e  _convert(self.h.
+0002fec0: 696e 6465 782e 747a 290a 2020 2020 2020  index.tz).      
+0002fed0: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
+0002fee0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0002fef0: 2020 2020 6c61 7374 4469 7641 646a 7573      lastDivAdjus
+0002ff00: 7444 745f 6d69 6e20 3d20 7365 6c66 2e68  tDt_min = self.h
+0002ff10: 5b22 4c61 7374 4469 7641 646a 7573 7444  ["LastDivAdjustD
+0002ff20: 7422 5d2e 6d69 6e28 290a 2020 2020 2020  t"].min().      
+0002ff30: 2020 6469 7673 5f73 696e 6365 203d 2073    divs_since = s
+0002ff40: 656c 662e 6d61 6e61 6765 722e 4765 7448  elf.manager.GetH
+0002ff50: 6973 746f 7279 2822 4576 656e 7473 2229  istory("Events")
+0002ff60: 2e47 6574 4469 7673 4665 7463 6865 6453  .GetDivsFetchedS
+0002ff70: 696e 6365 286c 6173 7444 6976 4164 6a75  ince(lastDivAdju
+0002ff80: 7374 4474 5f6d 696e 290a 2020 2020 2020  stDt_min).      
+0002ff90: 2020 6966 2064 6976 735f 7369 6e63 6520    if divs_since 
+0002ffa0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0002ffb0: 6e6f 7420 6469 7673 5f73 696e 6365 2e65  not divs_since.e
+0002ffc0: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+0002ffd0: 2020 4c61 7374 4469 7641 646a 7573 7444    LastDivAdjustD
+0002ffe0: 745f 6e65 7720 3d20 7365 6c66 2e68 5b22  t_new = self.h["
+0002fff0: 4c61 7374 4469 7641 646a 7573 7444 7422  LastDivAdjustDt"
+00030000: 5d2e 636f 7079 2829 0a0a 2020 2020 2020  ].copy()..      
+00030010: 2020 2020 2020 665f 7375 7020 3d20 6469        f_sup = di
+00030020: 7673 5f73 696e 6365 5b22 5375 7065 7273  vs_since["Supers
+00030030: 6564 6564 2062 6163 6b20 6164 6a2e 225d  eded back adj."]
+00030040: 2021 3d20 302e 300a 2020 2020 2020 2020   != 0.0.        
+00030050: 2020 2020 6966 2066 5f73 7570 2e61 6e79      if f_sup.any
+00030060: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00030070: 2020 2020 666f 7220 6474 2069 6e20 6469      for dt in di
+00030080: 7673 5f73 696e 6365 2e69 6e64 6578 5b66  vs_since.index[f
+00030090: 5f73 7570 5d3a 0a20 2020 2020 2020 2020  _sup]:.         
+000300a0: 2020 2020 2020 2020 2020 2064 6976 203d             div =
+000300b0: 2064 6976 735f 7369 6e63 652e 6c6f 635b   divs_since.loc[
+000300c0: 6474 5d0a 2020 2020 2020 2020 2020 2020  dt].            
+000300d0: 2020 2020 2020 2020 6631 203d 2073 656c          f1 = sel
+000300e0: 662e 682e 696e 6465 7820 3c20 6474 0a20  f.h.index < dt. 
+000300f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030100: 2020 2023 2055 7064 6174 653a 206e 6577     # Update: new
+00030110: 2073 7472 6174 6567 790a 2020 2020 2020   strategy.      
+00030120: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00030130: 496e 7374 6561 6420 6f66 206c 6173 7420  Instead of last 
+00030140: 6164 6a75 7374 2062 6569 6e67 2074 6865  adjust being the
+00030150: 2073 7570 6572 7365 6465 6420 6469 7669   superseded divi
+00030160: 6465 6e64 2c0a 2020 2020 2020 2020 2020  dend,.          
+00030170: 2020 2020 2020 2020 2020 2320 7365 7420            # set 
+00030180: 636f 6e64 6974 696f 6e20 6173 206c 6173  condition as las
+00030190: 7420 6164 6a75 7374 2062 6569 6e67 2062  t adjust being b
+000301a0: 6566 6f72 6520 7468 6973 206e 6577 2064  efore this new d
+000301b0: 6976 6964 656e 640a 2020 2020 2020 2020  ividend.        
+000301c0: 2020 2020 2020 2020 2020 2020 6632 203d              f2 =
+000301d0: 2028 2864 6976 5b22 4665 7463 6844 6174   ((div["FetchDat
+000301e0: 6522 5d20 2d20 7365 6c66 2e68 5b22 4c61  e"] - self.h["La
+000301f0: 7374 4469 7641 646a 7573 7444 7422 5d29  stDivAdjustDt"])
+00030200: 203e 2070 642e 5469 6d65 6465 6c74 6128   > pd.Timedelta(
+00030210: 2731 6d27 2929 2e74 6f5f 6e75 6d70 7928  '1m')).to_numpy(
+00030220: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00030230: 2020 2020 2020 6633 203d 2028 2864 6976        f3 = ((div
+00030240: 5b22 4665 7463 6844 6174 6522 5d20 2d20  ["FetchDate"] - 
+00030250: 7365 6c66 2e68 5b22 4665 7463 6844 6174  self.h["FetchDat
+00030260: 6522 5d29 203e 2070 642e 5469 6d65 6465  e"]) > pd.Timede
+00030270: 6c74 6128 2731 6d27 2929 2e74 6f5f 6e75  lta('1m')).to_nu
+00030280: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
+00030290: 2020 2020 2020 2020 2020 6620 3d20 6631            f = f1
+000302a0: 2026 2028 6632 2026 2066 3329 0a20 2020   & (f2 & f3).   
+000302b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302c0: 2069 6620 6e6f 7420 662e 616e 7928 293a   if not f.any():
+000302d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000302e0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000302f0: 2e69 6e74 6572 7661 6c20 213d 2079 6663  .interval != yfc
+00030300: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
+00030310: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030320: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00030330: 5072 6f62 6162 6c79 206f 6b2c 2061 7373  Probably ok, ass
+00030340: 756d 696e 6720 7375 7065 7273 6564 6564  uming superseded
+00030350: 2064 6976 2077 6173 206e 6576 6572 2061   div was never a
+00030360: 7070 6c69 6564 2074 6f20 7468 6973 2070  pplied to this p
+00030370: 7269 6365 2064 6174 610a 2020 2020 2020  rice data.      
+00030380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030390: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+000303a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000303b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000303c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000303d0: 2020 2020 2020 2020 2064 6966 6620 3d20           diff = 
+000303e0: 2873 656c 662e 685b 2246 6574 6368 4461  (self.h["FetchDa
+000303f0: 7465 225d 202d 2064 6976 5b22 4665 7463  te"] - div["Fetc
+00030400: 6844 6174 6522 5d29 2e61 6273 2829 0a20  hDate"]).abs(). 
+00030410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030420: 2020 2020 2020 2020 2020 2066 5f72 6563             f_rec
+00030430: 656e 7420 3d20 2864 6966 6620 3c20 7064  ent = (diff < pd
+00030440: 2e54 696d 6564 656c 7461 2822 3135 7322  .Timedelta("15s"
+00030450: 2929 2e74 6f5f 6e75 6d70 7928 290a 2020  )).to_numpy().  
+00030460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030470: 2020 2020 2020 2020 2020 6966 2066 5f72            if f_r
+00030480: 6563 656e 745b 6631 5d2e 616c 6c28 293a  ecent[f1].all():
+00030490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304b0: 2023 2041 6c6c 2070 7269 6365 2064 6174   # All price dat
+000304c0: 6120 7468 6174 2063 6f75 6c64 2062 6520  a that could be 
+000304d0: 6166 6665 6374 6564 2062 7920 6e65 7720  affected by new 
+000304e0: 6469 7669 6465 6e64 2c20 7761 7320 6a75  dividend, was ju
+000304f0: 7374 0a20 2020 2020 2020 2020 2020 2020  st.             
+00030500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030510: 2020 2023 2066 6574 6368 6564 2077 6974     # fetched wit
+00030520: 6820 7468 6174 2064 6976 6964 656e 642e  h that dividend.
+00030530: 2053 6f20 6361 6e20 7361 6665 6c79 2069   So can safely i
+00030540: 676e 6f72 652e 0a20 2020 2020 2020 2020  gnore..         
+00030550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030560: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00030570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030580: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00030590: 6469 7629 0a20 2020 2020 2020 2020 2020  div).           
+000305a0: 2020 2020 2020 2020 2020 2020 2023 2072               # r
+000305b0: 6169 7365 2045 7863 6570 7469 6f6e 2866  aise Exception(f
+000305c0: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+000305d0: 7b73 656c 662e 6973 7472 7d3a 2046 6f72  {self.istr}: For
+000305e0: 2073 7570 6572 7365 6465 6420 6469 7620   superseded div 
+000305f0: 6162 6f76 652c 2066 6169 6c65 6420 746f  above, failed to
+00030600: 2069 6465 6e74 6966 7920 726f 7773 2074   identify rows t
+00030610: 6f20 756e 646f 2e20 5072 6f62 6c65 6d3f  o undo. Problem?
+00030620: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00030630: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00030640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030650: 2020 2020 2023 204e 6578 7420 6368 6563       # Next chec
+00030660: 6b3a 2065 7870 6563 7420 6361 6368 6564  k: expect cached
+00030670: 2043 4446 203c 2031 2e30 3a0a 2020 2020   CDF < 1.0:.    
+00030680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030690: 2020 2020 6631 203d 2073 656c 662e 682e      f1 = self.h.
+000306a0: 6c6f 635b 662c 2022 4344 4622 5d20 3e3d  loc[f, "CDF"] >=
+000306b0: 2031 2e30 0a20 2020 2020 2020 2020 2020   1.0.           
+000306c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000306d0: 6631 2e61 6e79 2829 3a0a 2020 2020 2020  f1.any():.      
+000306e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306f0: 2020 2020 2020 2320 5468 6973 2063 616e        # This can
+00030700: 2068 6170 7065 6e20 7769 7468 2072 6563   happen with rec
+00030710: 656e 7420 6d75 6c74 6964 6179 2069 6e74  ent multiday int
+00030720: 6572 7661 6c73 2061 6e64 2074 6861 7427  ervals and that'
+00030730: 7320 6f6b 2c20 616e 6420 7769 6c6c 2063  s ok, and will c
+00030740: 6f72 7265 6374 206d 616e 7561 6c6c 792e  orrect manually.
+00030750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030760: 2020 2020 2020 2020 2020 2020 2066 315f               f1_
+00030770: 6f6c 6465 7374 5f69 6478 203d 206e 702e  oldest_idx = np.
+00030780: 7768 6572 6528 6631 295b 305d 5b2d 315d  where(f1)[0][-1]
+00030790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000307a0: 2020 2020 2020 2020 2020 2020 2066 315f               f1_
+000307b0: 6f6c 6465 7374 5f64 7420 3d20 7365 6c66  oldest_dt = self
+000307c0: 2e68 2e69 6e64 6578 5b66 315f 6f6c 6465  .h.index[f1_olde
+000307d0: 7374 5f69 6478 5d0a 2020 2020 2020 2020  st_idx].        
+000307e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000307f0: 2020 2020 6973 5f66 315f 6f6c 6465 7374      is_f1_oldest
+00030800: 5f64 745f 7265 6365 6e74 203d 2028 7064  _dt_recent = (pd
+00030810: 2e54 696d 6573 7461 6d70 2e75 7463 6e6f  .Timestamp.utcno
+00030820: 7728 2920 2d20 6631 5f6f 6c64 6573 745f  w() - f1_oldest_
+00030830: 6474 2920 3c20 2831 2e35 2a73 656c 662e  dt) < (1.5*self.
+00030840: 6974 6429 0a20 2020 2020 2020 2020 2020  itd).           
+00030850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030860: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+00030870: 7920 616e 6420 7365 6c66 2e69 6e74 6572  y and self.inter
+00030880: 7661 6c20 213d 2079 6663 642e 496e 7465  val != yfcd.Inte
+00030890: 7276 616c 2e44 6179 7331 2061 6e64 2069  rval.Days1 and i
+000308a0: 735f 6631 5f6f 6c64 6573 745f 6474 5f72  s_f1_oldest_dt_r
+000308b0: 6563 656e 743a 0a20 2020 2020 2020 2020  ecent:.         
+000308c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000308d0: 2020 2020 2020 2023 2059 7570 2c20 7468         # Yup, th
+000308e0: 6174 2773 2077 6861 7420 6861 7070 656e  at's what happen
+000308f0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+00030900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030910: 2020 2066 5b66 315f 6f6c 6465 7374 5f69     f[f1_oldest_i
+00030920: 6478 3a5d 203d 2046 616c 7365 0a20 2020  dx:] = False.   
+00030930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030940: 2020 2020 2020 2020 2020 2020 2066 3120               f1 
+00030950: 3d20 7365 6c66 2e68 2e6c 6f63 5b66 2c20  = self.h.loc[f, 
+00030960: 2243 4446 225d 203e 3d20 312e 300a 2020  "CDF"] >= 1.0.  
+00030970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030980: 2020 2020 2020 6966 2066 312e 616e 7928        if f1.any(
+00030990: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000309a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000309b0: 7269 6e74 2864 6976 290a 2020 2020 2020  rint(div).      
 000309c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309d0: 2020 2020 2020 2020 2020 2320 5072 6f62            # Prob
-000309e0: 6162 6c79 206f 6b2c 2061 7373 756d 696e  ably ok, assumin
-000309f0: 6720 7375 7065 7273 6564 6564 2064 6976  g superseded div
-00030a00: 2077 6173 206e 6576 6572 2061 7070 6c69   was never appli
-00030a10: 6564 2074 6f20 7468 6973 2070 7269 6365  ed to this price
-00030a20: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-00030a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a40: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00030a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00030a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a80: 2020 2020 2064 6966 6620 3d20 2873 656c       diff = (sel
-00030a90: 662e 685b 2246 6574 6368 4461 7465 225d  f.h["FetchDate"]
-00030aa0: 202d 2064 6976 5b22 4665 7463 6844 6174   - div["FetchDat
-00030ab0: 6522 5d29 2e61 6273 2829 0a20 2020 2020  e"]).abs().     
-00030ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ad0: 2020 2020 2020 2066 5f72 6563 656e 7420         f_recent 
-00030ae0: 3d20 2864 6966 6620 3c20 7064 2e54 696d  = (diff < pd.Tim
-00030af0: 6564 656c 7461 2822 3135 7322 2929 2e74  edelta("15s")).t
-00030b00: 6f5f 6e75 6d70 7928 290a 2020 2020 2020  o_numpy().      
-00030b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b20: 2020 2020 2020 6966 2066 5f72 6563 656e        if f_recen
-00030b30: 745b 6631 5d2e 616c 6c28 293a 0a20 2020  t[f1].all():.   
+000309d0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+000309e0: 7074 696f 6e28 6622 7b73 656c 662e 7469  ption(f"{self.ti
+000309f0: 636b 6572 7d3a 207b 7365 6c66 2e69 7374  cker}: {self.ist
+00030a00: 727d 3a20 466f 7220 7375 7065 7273 6564  r}: For supersed
+00030a10: 6564 2064 6976 2061 626f 7665 2c20 6174  ed div above, at
+00030a20: 7465 6d70 7469 6e67 2074 6f20 756e 646f  tempting to undo
+00030a30: 2064 6976 2d61 646a 7573 7420 6672 6f6d   div-adjust from
+00030a40: 2072 6f77 7320 7768 6572 6520 4344 463d   rows where CDF=
+00030a50: 312e 2049 6e76 6573 7469 6761 7465 2e22  1. Investigate."
+00030a60: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00030a70: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
+00030a80: 7367 203d 2066 227b 7365 6c66 2e69 7374  sg = f"{self.ist
+00030a90: 727d 3a20 5265 7665 7273 696e 6720 6469  r}: Reversing di
+00030aa0: 7620 5b64 743d 7b64 742e 6461 7465 2829  v [dt={dt.date()
+00030ab0: 7d20 7b64 6976 5b27 5375 7065 7273 6564  } {div['Supersed
+00030ac0: 6564 2064 6976 275d 7d20 6164 6a3d 7b64  ed div']} adj={d
+00030ad0: 6976 5b27 5375 7065 7273 6564 6564 2062  iv['Superseded b
+00030ae0: 6163 6b20 6164 6a2e 275d 3a2e 3566 7d20  ack adj.']:.5f} 
+00030af0: 6665 7463 683d 7b64 6976 5b27 5375 7065  fetch={div['Supe
+00030b00: 7273 6564 6564 2064 6976 2046 6574 6368  rseded div Fetch
+00030b10: 4461 7465 275d 2e73 7472 6674 696d 6528  Date'].strftime(
+00030b20: 2725 592d 256d 2d25 6420 2548 3a25 4d3a  '%Y-%m-%d %H:%M:
+00030b30: 2553 257a 2729 7d5d 220a 2020 2020 2020  %S%z')}]".      
 00030b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b50: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-00030b60: 6c6c 2070 7269 6365 2064 6174 6120 7468  ll price data th
-00030b70: 6174 2063 6f75 6c64 2062 6520 6166 6665  at could be affe
-00030b80: 6374 6564 2062 7920 6e65 7720 6469 7669  cted by new divi
-00030b90: 6465 6e64 2c20 7761 7320 6a75 7374 0a20  dend, was just. 
-00030ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030bb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00030bc0: 2066 6574 6368 6564 2077 6974 6820 7468   fetched with th
-00030bd0: 6174 2064 6976 6964 656e 642e 2053 6f20  at dividend. So 
-00030be0: 6361 6e20 7361 6665 6c79 2069 676e 6f72  can safely ignor
-00030bf0: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
-00030c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c10: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-00030c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c30: 2020 2020 2320 7072 696e 7428 6469 7629      # print(div)
-00030c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030c50: 2020 2020 2020 2020 2023 2072 6169 7365           # raise
-00030c60: 2045 7863 6570 7469 6f6e 2866 227b 7365   Exception(f"{se
-00030c70: 6c66 2e74 6963 6b65 727d 3a20 7b73 656c  lf.ticker}: {sel
-00030c80: 662e 6973 7472 7d3a 2046 6f72 2073 7570  f.istr}: For sup
-00030c90: 6572 7365 6465 6420 6469 7620 6162 6f76  erseded div abov
-00030ca0: 652c 2066 6169 6c65 6420 746f 2069 6465  e, failed to ide
-00030cb0: 6e74 6966 7920 726f 7773 2074 6f20 756e  ntify rows to un
-00030cc0: 646f 2e20 5072 6f62 6c65 6d3f 2229 0a20  do. Problem?"). 
-00030cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ce0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d00: 2023 204e 6578 7420 6368 6563 6b3a 2065   # Next check: e
-00030d10: 7870 6563 7420 6361 6368 6564 2043 4446  xpect cached CDF
-00030d20: 203c 2031 2e30 3a0a 2020 2020 2020 2020   < 1.0:.        
-00030d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d40: 6631 203d 2073 656c 662e 682e 6c6f 635b  f1 = self.h.loc[
-00030d50: 662c 2022 4344 4622 5d20 3d3d 2031 2e30  f, "CDF"] == 1.0
-00030d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030d70: 2020 2020 2020 2020 2069 6620 6631 2e61           if f1.a
-00030d80: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00030d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030da0: 2020 2320 5468 6973 2063 616e 2068 6170    # This can hap
-00030db0: 7065 6e20 7769 7468 2072 6563 656e 7420  pen with recent 
-00030dc0: 6d75 6c74 6964 6179 2069 6e74 6572 7661  multiday interva
-00030dd0: 6c73 2061 6e64 2074 6861 7427 7320 6f6b  ls and that's ok
-00030de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030df0: 2020 2020 2020 2020 2020 2020 2066 315f               f1_
-00030e00: 6f6c 6465 7374 203d 206e 702e 7768 6572  oldest = np.wher
-00030e10: 6528 6631 295b 305d 5b2d 315d 0a20 2020  e(f1)[0][-1].   
-00030e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e30: 2020 2020 2020 2020 2066 315f 6f6c 6465           f1_olde
-00030e40: 7374 5f64 7420 3d20 7365 6c66 2e68 2e69  st_dt = self.h.i
-00030e50: 6e64 6578 5b66 315f 6f6c 6465 7374 5d0a  ndex[f1_oldest].
-00030e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e70: 2020 2020 2020 2020 2020 2020 6631 5f6f              f1_o
-00030e80: 6c64 6573 745f 6474 5f72 6563 656e 7420  ldest_dt_recent 
-00030e90: 3d20 2870 642e 5469 6d65 7374 616d 702e  = (pd.Timestamp.
-00030ea0: 7574 636e 6f77 2829 202d 2066 315f 6f6c  utcnow() - f1_ol
-00030eb0: 6465 7374 5f64 7429 203c 2028 312e 352a  dest_dt) < (1.5*
-00030ec0: 7365 6c66 2e69 7464 290a 2020 2020 2020  self.itd).      
-00030ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ee0: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
-00030ef0: 7465 7264 6179 2061 6e64 2073 656c 662e  terday and self.
-00030f00: 696e 7465 7276 616c 2021 3d20 7966 6364  interval != yfcd
-00030f10: 2e49 6e74 6572 7661 6c2e 4461 7973 3120  .Interval.Days1 
-00030f20: 616e 6420 6631 5f6f 6c64 6573 745f 6474  and f1_oldest_dt
-00030f30: 5f72 6563 656e 743a 0a20 2020 2020 2020  _recent:.       
-00030f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030f50: 2020 2020 2020 2020 2023 2059 7570 2c20           # Yup, 
-00030f60: 7468 6174 2773 2077 6861 7420 6861 7070  that's what happ
-00030f70: 656e 6564 0a20 2020 2020 2020 2020 2020  ened.           
-00030f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030f90: 2020 2020 2066 5b66 315f 6f6c 6465 7374       f[f1_oldest
-00030fa0: 3a5d 203d 2046 616c 7365 0a0a 2020 2020  :] = False..    
-00030fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fc0: 2020 2020 6631 203d 2073 656c 662e 682e      f1 = self.h.
-00030fd0: 6c6f 635b 662c 2022 4344 4622 5d20 3d3d  loc[f, "CDF"] ==
-00030fe0: 2031 2e30 0a20 2020 2020 2020 2020 2020   1.0.           
-00030ff0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00031000: 6631 2e61 6e79 2829 3a0a 2020 2020 2020  f1.any():.      
-00031010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031020: 2020 2020 2020 7072 696e 7428 6469 7629        print(div)
-00031030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031040: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00031050: 7365 2045 7863 6570 7469 6f6e 2866 227b  se Exception(f"{
-00031060: 7365 6c66 2e74 6963 6b65 727d 3a20 7b73  self.ticker}: {s
-00031070: 656c 662e 6973 7472 7d3a 2046 6f72 2073  elf.istr}: For s
-00031080: 7570 6572 7365 6465 6420 6469 7620 6162  uperseded div ab
-00031090: 6f76 652c 2061 7474 656d 7074 696e 6720  ove, attempting 
-000310a0: 746f 2075 6e64 6f20 6469 762d 6164 6a75  to undo div-adju
-000310b0: 7374 2066 726f 6d20 726f 7773 2077 6865  st from rows whe
-000310c0: 7265 2043 4446 3d31 2e20 496e 7665 7374  re CDF=1. Invest
-000310d0: 6967 6174 652e 2229 0a0a 2020 2020 2020  igate.")..      
-000310e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310f0: 2020 6c6f 675f 6d73 6720 3d20 6622 7b73    log_msg = f"{s
-00031100: 656c 662e 6973 7472 7d3a 2052 6576 6572  elf.istr}: Rever
-00031110: 7369 6e67 2064 6976 205b 6474 3d7b 6474  sing div [dt={dt
-00031120: 2e64 6174 6528 297d 207b 6469 765b 2753  .date()} {div['S
-00031130: 7570 6572 7365 6465 6420 6469 7627 5d7d  uperseded div']}
-00031140: 2061 646a 3d7b 6469 765b 2753 7570 6572   adj={div['Super
-00031150: 7365 6465 6420 6261 636b 2061 646a 2e27  seded back adj.'
-00031160: 5d3a 2e35 667d 2066 6574 6368 3d7b 6469  ]:.5f} fetch={di
-00031170: 765b 2753 7570 6572 7365 6465 6420 6469  v['Superseded di
-00031180: 7620 4665 7463 6844 6174 6527 5d2e 7374  v FetchDate'].st
-00031190: 7266 7469 6d65 2827 2559 2d25 6d2d 2564  rftime('%Y-%m-%d
-000311a0: 2025 483a 254d 3a25 5325 7a27 297d 5d22   %H:%M:%S%z')}]"
-000311b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000311c0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-000311d0: 203d 206e 702e 7768 6572 6528 6629 5b30   = np.where(f)[0
-000311e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000311f0: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
-00031200: 6720 2b3d 2022 2066 726f 6d20 696e 7465  g += " from inte
-00031210: 7276 616c 7320 220a 2020 2020 2020 2020  rvals ".        
-00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031230: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
-00031240: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031250: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00031260: 675f 6d73 6720 2b3d 2066 227b 7365 6c66  g_msg += f"{self
-00031270: 2e68 2e69 6e64 6578 5b69 6e64 6963 6573  .h.index[indices
-00031280: 5b30 5d5d 2e64 6174 6528 297d 202d 3e20  [0]].date()} -> 
-00031290: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
-000312a0: 6469 6365 735b 2d31 5d5d 2e64 6174 6528  dices[-1]].date(
-000312b0: 297d 2028 696e 6329 220a 2020 2020 2020  )} (inc)".      
-000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000312e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312f0: 2020 2020 6c6f 675f 6d73 6720 2b3d 2066      log_msg += f
-00031300: 227b 7365 6c66 2e68 2e69 6e64 6578 5b69  "{self.h.index[i
-00031310: 6e64 6963 6573 5b30 5d5d 7d20 2d3e 207b  ndices[0]]} -> {
-00031320: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
-00031330: 6963 6573 5b2d 315d 5d7d 220a 2020 2020  ices[-1]]}".    
-00031340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031350: 2020 2020 685f 6c61 7374 526f 7720 3d20      h_lastRow = 
-00031360: 7365 6c66 2e68 2e6c 6f63 5b73 656c 662e  self.h.loc[self.
-00031370: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
-00031380: 2d31 5d5d 5d0a 2020 2020 2020 2020 2020  -1]]].          
-00031390: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000313a0: 675f 6d73 6720 2b3d 2066 222e 204c 6173  g_msg += f". Las
-000313b0: 7420 4344 4620 3d20 7b68 5f6c 6173 7452  t CDF = {h_lastR
-000313c0: 6f77 5b27 4344 4627 5d3a 2e35 667d 2040  ow['CDF']:.5f} @
-000313d0: 207b 685f 6c61 7374 526f 775b 274c 6173   {h_lastRow['Las
-000313e0: 7444 6976 4164 6a75 7374 4474 275d 2e73  tDivAdjustDt'].s
-000313f0: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
-00031400: 6420 2548 3a25 4d3a 2553 257a 2729 7d22  d %H:%M:%S%z')}"
-00031410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031420: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
-00031430: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
-00031440: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
-00031450: 6167 6572 222c 206c 6f67 5f6d 7367 290a  ager", log_msg).
-00031460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031470: 2020 2020 2020 2020 2320 6966 2079 6663          # if yfc
-00031480: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
-00031490: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
-000314a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000314b0: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
-000314c0: 696e 7428 6c6f 675f 6d73 6729 0a20 2020  int(log_msg).   
-000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314e0: 2020 2020 2023 2065 6c69 6620 6465 6275       # elif debu
-000314f0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00031500: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00031510: 2070 7269 6e74 2866 2255 6e64 6f6e 6520   print(f"Undone 
-00031520: 7375 7065 7273 6564 6564 2064 6976 6964  superseded divid
-00031530: 656e 6420 4020 7b64 747d 3a22 290a 2020  end @ {dt}:").  
-00031540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031550: 2020 2020 2020 2320 2020 2020 7072 696e        #     prin
-00031560: 7428 7365 6c66 2e68 2e6c 6f63 5b66 2c20  t(self.h.loc[f, 
-00031570: 5b22 4344 4622 2c20 2246 6574 6368 4461  ["CDF", "FetchDa
-00031580: 7465 222c 2022 4c61 7374 4469 7641 646a  te", "LastDivAdj
-00031590: 7573 7444 7422 5d5d 290a 2020 2020 2020  ustDt"]]).      
-000315a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315b0: 2020 2320 2020 2020 7072 696e 7428 2222    #     print(""
-000315c0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-000315d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000315e0: 682e 6c6f 635b 662c 2022 4344 4622 5d20  h.loc[f, "CDF"] 
-000315f0: 2f3d 2064 6976 5b22 5375 7065 7273 6564  /= div["Supersed
-00031600: 6564 2062 6163 6b20 6164 6a2e 225d 0a0a  ed back adj."]..
-00031610: 2020 2020 2020 2020 2020 2020 4c61 7374              Last
-00031620: 4469 7641 646a 7573 7444 745f 6e65 7720  DivAdjustDt_new 
-00031630: 3d20 7365 6c66 2e68 5b22 4c61 7374 4469  = self.h["LastDi
-00031640: 7641 646a 7573 7444 7422 5d2e 636f 7079  vAdjustDt"].copy
-00031650: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
-00031660: 6f72 2064 7420 696e 2064 6976 735f 7369  or dt in divs_si
-00031670: 6e63 652e 696e 6465 783a 0a20 2020 2020  nce.index:.     
-00031680: 2020 2020 2020 2020 2020 2064 6976 203d             div =
-00031690: 2064 6976 735f 7369 6e63 652e 6c6f 635b   divs_since.loc[
-000316a0: 6474 5d0a 2020 2020 2020 2020 2020 2020  dt].            
-000316b0: 2020 2020 6631 203d 2073 656c 662e 682e      f1 = self.h.
-000316c0: 696e 6465 7820 3c20 6474 0a20 2020 2020  index < dt.     
-000316d0: 2020 2020 2020 2020 2020 2066 3220 3d20             f2 = 
-000316e0: 7365 6c66 2e68 5b22 4c61 7374 4469 7641  self.h["LastDivA
-000316f0: 646a 7573 7444 7422 5d20 3c20 6469 765b  djustDt"] < div[
-00031700: 2246 6574 6368 4461 7465 225d 0a20 2020  "FetchDate"].   
-00031710: 2020 2020 2020 2020 2020 2020 2066 203d               f =
-00031720: 2066 3120 2620 6632 0a20 2020 2020 2020   f1 & f2.       
-00031730: 2020 2020 2020 2020 2069 6620 662e 616e           if f.an
-00031740: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-00031750: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
-00031760: 203d 2066 227b 7365 6c66 2e69 7374 727d   = f"{self.istr}
-00031770: 3a20 4170 706c 7969 6e67 2064 6976 205b  : Applying div [
-00031780: 6474 3d7b 6474 2e64 6174 6528 297d 207b  dt={dt.date()} {
-00031790: 6469 765b 2744 6976 6964 656e 6473 275d  div['Dividends']
-000317a0: 7d20 6164 6a3d 7b64 6976 5b27 4261 636b  } adj={div['Back
-000317b0: 2041 646a 2e27 5d3a 2e35 667d 2066 6574   Adj.']:.5f} fet
-000317c0: 6368 3d7b 6469 765b 2746 6574 6368 4461  ch={div['FetchDa
-000317d0: 7465 275d 2e73 7472 6674 696d 6528 2725  te'].strftime('%
-000317e0: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
-000317f0: 257a 2729 7d5d 220a 2020 2020 2020 2020  %z')}]".        
-00031800: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-00031810: 6365 7320 3d20 6e70 2e77 6865 7265 2866  ces = np.where(f
-00031820: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-00031830: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
-00031840: 202b 3d20 2220 6163 726f 7373 2069 6e74   += " across int
-00031850: 6572 7661 6c73 2022 0a20 2020 2020 2020  ervals ".       
-00031860: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00031870: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-00031880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031890: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
-000318a0: 3d20 6622 7b73 656c 662e 682e 696e 6465  = f"{self.h.inde
-000318b0: 785b 696e 6469 6365 735b 305d 5d2e 6461  x[indices[0]].da
-000318c0: 7465 2829 7d20 2d3e 207b 7365 6c66 2e68  te()} -> {self.h
-000318d0: 2e69 6e64 6578 5b69 6e64 6963 6573 5b2d  .index[indices[-
-000318e0: 315d 5d2e 6461 7465 2829 7d20 2869 6e63  1]].date()} (inc
-000318f0: 2922 0a20 2020 2020 2020 2020 2020 2020  )".             
-00031900: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00031910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031920: 2020 2020 206c 6f67 5f6d 7367 202b 3d20       log_msg += 
-00031930: 6622 7b73 656c 662e 682e 696e 6465 785b  f"{self.h.index[
-00031940: 696e 6469 6365 735b 305d 5d7d 202d 3e20  indices[0]]} -> 
-00031950: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
-00031960: 6469 6365 735b 2d31 5d5d 7d22 0a20 2020  dices[-1]]}".   
-00031970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031980: 2068 5f6c 6173 7452 6f77 203d 2073 656c   h_lastRow = sel
-00031990: 662e 682e 6c6f 635b 7365 6c66 2e68 2e69  f.h.loc[self.h.i
-000319a0: 6e64 6578 5b69 6e64 6963 6573 5b2d 315d  ndex[indices[-1]
-000319b0: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
-000319c0: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
-000319d0: 3d20 6622 2e20 4c61 7374 2043 4446 203d  = f". Last CDF =
-000319e0: 207b 685f 6c61 7374 526f 775b 2743 4446   {h_lastRow['CDF
-000319f0: 275d 3a2e 3566 7d20 4020 7b68 5f6c 6173  ']:.5f} @ {h_las
-00031a00: 7452 6f77 5b27 4c61 7374 4469 7641 646a  tRow['LastDivAdj
-00031a10: 7573 7444 7427 5d2e 7374 7266 7469 6d65  ustDt'].strftime
-00031a20: 2827 2559 2d25 6d2d 2564 2025 483a 254d  ('%Y-%m-%d %H:%M
-00031a30: 3a25 5325 7a27 297d 220a 2020 2020 2020  :%S%z')}".      
-00031a40: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00031a50: 6c66 2e6d 616e 6167 6572 2e4c 6f67 4576  lf.manager.LogEv
-00031a60: 656e 7428 2269 6e66 6f22 2c20 2250 7269  ent("info", "Pri
-00031a70: 6365 4d61 6e61 6765 7222 2c20 6c6f 675f  ceManager", log_
-00031a80: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00031a90: 2020 2020 2020 2020 2023 2069 6620 7966           # if yf
-00031aa0: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00031ab0: 6c65 6428 293a 0a20 2020 2020 2020 2020  led():.         
-00031ac0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00031ad0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-00031ae0: 286c 6f67 5f6d 7367 290a 2020 2020 2020  (log_msg).      
-00031af0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00031b00: 656c 6966 2064 6562 7567 3a0a 2020 2020  elif debug:.    
-00031b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b20: 2320 2020 2020 7072 696e 7428 6622 7b73  #     print(f"{s
-00031b30: 656c 662e 7469 636b 6572 7d3a 2022 2b6c  elf.ticker}: "+l
-00031b40: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
-00031b50: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00031b60: 662e 682e 6c6f 635b 662c 2022 4344 4622  f.h.loc[f, "CDF"
-00031b70: 5d20 2a3d 2064 6976 5b22 4261 636b 2041  ] *= div["Back A
-00031b80: 646a 2e22 5d0a 2020 2020 2020 2020 2020  dj."].          
-00031b90: 2020 2020 2020 2020 2020 4c61 7374 4469            LastDi
-00031ba0: 7641 646a 7573 7444 745f 6e65 775b 665d  vAdjustDt_new[f]
-00031bb0: 203d 206e 702e 6d61 7869 6d75 6d28 4c61   = np.maximum(La
-00031bc0: 7374 4469 7641 646a 7573 7444 745f 6e65  stDivAdjustDt_ne
-00031bd0: 775b 665d 2c20 6469 765b 2246 6574 6368  w[f], div["Fetch
-00031be0: 4461 7465 225d 290a 2020 2020 2020 2020  Date"]).        
-00031bf0: 2020 2020 7365 6c66 2e68 5b22 4c61 7374      self.h["Last
-00031c00: 4469 7641 646a 7573 7444 7422 5d20 3d20  DivAdjustDt"] = 
-00031c10: 4c61 7374 4469 7641 646a 7573 7444 745f  LastDivAdjustDt_
-00031c20: 6e65 770a 0a20 2020 2020 2020 2020 2020  new..           
-00031c30: 2068 5f6d 6f64 6966 6965 6420 3d20 5472   h_modified = Tr
-00031c40: 7565 0a0a 2020 2020 2020 2020 6966 2068  ue..        if h
-00031c50: 5f6d 6f64 6966 6965 643a 0a20 2020 2020  _modified:.     
-00031c60: 2020 2020 2020 2073 656c 662e 5f75 7064         self._upd
-00031c70: 6174 6564 4361 6368 6564 5072 6963 6573  atedCachedPrices
-00031c80: 2873 656c 662e 6829 0a0a 2020 2020 2020  (self.h)..      
-00031c90: 2020 6c6f 675f 6d73 6720 3d20 2250 4d3a    log_msg = "PM:
-00031ca0: 3a5f 6170 706c 794e 6577 4576 656e 7473  :_applyNewEvents
-00031cb0: 2829 2072 6574 7572 6e69 6e67 220a 2020  () returning".  
-00031cc0: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
-00031cd0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-00031ce0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-00031cf0: 636c 2e54 7261 6365 4578 6974 286c 6f67  cl.TraceExit(log
-00031d00: 5f6d 7367 290a                           _msg).
+00030b50: 2020 696e 6469 6365 7320 3d20 6e70 2e77    indices = np.w
+00030b60: 6865 7265 2866 295b 305d 0a20 2020 2020  here(f)[0].     
+00030b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b80: 2020 206c 6f67 5f6d 7367 202b 3d20 2220     log_msg += " 
+00030b90: 6672 6f6d 2069 6e74 6572 7661 6c73 2022  from intervals "
+00030ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030bb0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00030bc0: 2e69 6e74 6572 6461 793a 0a20 2020 2020  .interday:.     
+00030bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030be0: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
+00030bf0: 3d20 6622 7b73 656c 662e 682e 696e 6465  = f"{self.h.inde
+00030c00: 785b 696e 6469 6365 735b 305d 5d2e 6461  x[indices[0]].da
+00030c10: 7465 2829 7d20 2d3e 207b 7365 6c66 2e68  te()} -> {self.h
+00030c20: 2e69 6e64 6578 5b69 6e64 6963 6573 5b2d  .index[indices[-
+00030c30: 315d 5d2e 6461 7465 2829 7d20 2869 6e63  1]].date()} (inc
+00030c40: 2922 0a20 2020 2020 2020 2020 2020 2020  )".             
+00030c50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00030c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c70: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00030c80: 5f6d 7367 202b 3d20 6622 7b73 656c 662e  _msg += f"{self.
+00030c90: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
+00030ca0: 305d 5d7d 202d 3e20 7b73 656c 662e 682e  0]]} -> {self.h.
+00030cb0: 696e 6465 785b 696e 6469 6365 735b 2d31  index[indices[-1
+00030cc0: 5d5d 7d22 0a20 2020 2020 2020 2020 2020  ]]}".           
+00030cd0: 2020 2020 2020 2020 2020 2020 2068 5f6c               h_l
+00030ce0: 6173 7452 6f77 203d 2073 656c 662e 682e  astRow = self.h.
+00030cf0: 6c6f 635b 7365 6c66 2e68 2e69 6e64 6578  loc[self.h.index
+00030d00: 5b69 6e64 6963 6573 5b2d 315d 5d5d 0a20  [indices[-1]]]. 
+00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d20: 2020 2020 2020 206c 6f67 5f6d 7367 202b         log_msg +
+00030d30: 3d20 6622 2e20 4c61 7374 2043 4446 203d  = f". Last CDF =
+00030d40: 207b 685f 6c61 7374 526f 775b 2743 4446   {h_lastRow['CDF
+00030d50: 275d 3a2e 3566 7d20 4020 7b68 5f6c 6173  ']:.5f} @ {h_las
+00030d60: 7452 6f77 5b27 4c61 7374 4469 7641 646a  tRow['LastDivAdj
+00030d70: 7573 7444 7427 5d2e 7374 7266 7469 6d65  ustDt'].strftime
+00030d80: 2827 2559 2d25 6d2d 2564 2025 483a 254d  ('%Y-%m-%d %H:%M
+00030d90: 3a25 5325 7a27 297d 220a 2020 2020 2020  :%S%z')}".      
+00030da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030db0: 2020 7365 6c66 2e6d 616e 6167 6572 2e4c    self.manager.L
+00030dc0: 6f67 4576 656e 7428 2269 6e66 6f22 2c20  ogEvent("info", 
+00030dd0: 2250 7269 6365 4d61 6e61 6765 7222 2c20  "PriceManager", 
+00030de0: 6c6f 675f 6d73 6729 0a0a 2020 2020 2020  log_msg)..      
+00030df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e00: 2020 7365 6c66 2e68 2e6c 6f63 5b66 2c20    self.h.loc[f, 
+00030e10: 2243 4446 225d 202f 3d20 6469 765b 2253  "CDF"] /= div["S
+00030e20: 7570 6572 7365 6465 6420 6261 636b 2061  uperseded back a
+00030e30: 646a 2e22 5d0a 2020 2020 2020 2020 2020  dj."].          
+00030e40: 2020 2020 2020 2020 2020 2020 2020 4c61                La
+00030e50: 7374 4469 7641 646a 7573 7444 745f 6e65  stDivAdjustDt_ne
+00030e60: 775b 665d 203d 206e 702e 6d61 7869 6d75  w[f] = np.maximu
+00030e70: 6d28 6469 765b 2746 6574 6368 4461 7465  m(div['FetchDate
+00030e80: 275d 2c20 4c61 7374 4469 7641 646a 7573  '], LastDivAdjus
+00030e90: 7444 745f 6e65 775b 665d 290a 0a20 2020  tDt_new[f])..   
+00030ea0: 2020 2020 2020 2020 2066 6f72 2064 7420           for dt 
+00030eb0: 696e 2064 6976 735f 7369 6e63 652e 696e  in divs_since.in
+00030ec0: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
+00030ed0: 2020 2020 2064 6976 203d 2064 6976 735f       div = divs_
+00030ee0: 7369 6e63 652e 6c6f 635b 6474 5d0a 2020  since.loc[dt].  
+00030ef0: 2020 2020 2020 2020 2020 2020 2020 6631                f1
+00030f00: 203d 2073 656c 662e 682e 696e 6465 7820   = self.h.index 
+00030f10: 3c20 6474 0a20 2020 2020 2020 2020 2020  < dt.           
+00030f20: 2020 2020 2066 3220 3d20 7365 6c66 2e68       f2 = self.h
+00030f30: 5b22 4c61 7374 4469 7641 646a 7573 7444  ["LastDivAdjustD
+00030f40: 7422 5d20 3c20 6469 765b 2246 6574 6368  t"] < div["Fetch
+00030f50: 4461 7465 225d 0a20 2020 2020 2020 2020  Date"].         
+00030f60: 2020 2020 2020 2066 203d 2066 3120 2620         f = f1 & 
+00030f70: 6632 0a20 2020 2020 2020 2020 2020 2020  f2.             
+00030f80: 2020 2069 6620 662e 616e 7928 293a 0a20     if f.any():. 
+00030f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030fa0: 2020 206c 6f67 5f6d 7367 203d 2066 227b     log_msg = f"{
+00030fb0: 7365 6c66 2e69 7374 727d 3a20 4170 706c  self.istr}: Appl
+00030fc0: 7969 6e67 2064 6976 205b 6474 3d7b 6474  ying div [dt={dt
+00030fd0: 2e64 6174 6528 297d 207b 6469 765b 2744  .date()} {div['D
+00030fe0: 6976 6964 656e 6473 275d 7d20 6164 6a3d  ividends']} adj=
+00030ff0: 7b64 6976 5b27 4261 636b 2041 646a 2e27  {div['Back Adj.'
+00031000: 5d3a 2e35 667d 2066 6574 6368 3d7b 6469  ]:.5f} fetch={di
+00031010: 765b 2746 6574 6368 4461 7465 275d 2e73  v['FetchDate'].s
+00031020: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
+00031030: 6420 2548 3a25 4d3a 2553 257a 2729 7d5d  d %H:%M:%S%z')}]
+00031040: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00031050: 2020 2020 2020 696e 6469 6365 7320 3d20        indices = 
+00031060: 6e70 2e77 6865 7265 2866 295b 305d 0a20  np.where(f)[0]. 
+00031070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031080: 2020 206c 6f67 5f6d 7367 202b 3d20 2220     log_msg += " 
+00031090: 6163 726f 7373 2069 6e74 6572 7661 6c73  across intervals
+000310a0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+000310b0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+000310c0: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
+000310d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310e0: 206c 6f67 5f6d 7367 202b 3d20 6622 7b73   log_msg += f"{s
+000310f0: 656c 662e 682e 696e 6465 785b 696e 6469  elf.h.index[indi
+00031100: 6365 735b 305d 5d2e 6461 7465 2829 7d20  ces[0]].date()} 
+00031110: 2d3e 207b 7365 6c66 2e68 2e69 6e64 6578  -> {self.h.index
+00031120: 5b69 6e64 6963 6573 5b2d 315d 5d2e 6461  [indices[-1]].da
+00031130: 7465 2829 7d20 2869 6e63 2922 0a20 2020  te()} (inc)".   
+00031140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00031160: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00031170: 6f67 5f6d 7367 202b 3d20 6622 7b73 656c  og_msg += f"{sel
+00031180: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
+00031190: 735b 305d 5d7d 202d 3e20 7b73 656c 662e  s[0]]} -> {self.
+000311a0: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
+000311b0: 2d31 5d5d 7d22 0a20 2020 2020 2020 2020  -1]]}".         
+000311c0: 2020 2020 2020 2020 2020 2068 5f6c 6173             h_las
+000311d0: 7452 6f77 203d 2073 656c 662e 682e 6c6f  tRow = self.h.lo
+000311e0: 635b 7365 6c66 2e68 2e69 6e64 6578 5b69  c[self.h.index[i
+000311f0: 6e64 6963 6573 5b2d 315d 5d5d 0a20 2020  ndices[-1]]].   
+00031200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031210: 206c 6f67 5f6d 7367 202b 3d20 6622 2e20   log_msg += f". 
+00031220: 4c61 7374 2043 4446 203d 207b 685f 6c61  Last CDF = {h_la
+00031230: 7374 526f 775b 2743 4446 275d 3a2e 3566  stRow['CDF']:.5f
+00031240: 7d20 4020 7b68 5f6c 6173 7452 6f77 5b27  } @ {h_lastRow['
+00031250: 4c61 7374 4469 7641 646a 7573 7444 7427  LastDivAdjustDt'
+00031260: 5d2e 7374 7266 7469 6d65 2827 2559 2d25  ].strftime('%Y-%
+00031270: 6d2d 2564 2025 483a 254d 3a25 5325 7a27  m-%d %H:%M:%S%z'
+00031280: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
+00031290: 2020 2020 2020 2020 7365 6c66 2e6d 616e          self.man
+000312a0: 6167 6572 2e4c 6f67 4576 656e 7428 2269  ager.LogEvent("i
+000312b0: 6e66 6f22 2c20 2250 7269 6365 4d61 6e61  nfo", "PriceMana
+000312c0: 6765 7222 2c20 6c6f 675f 6d73 6729 0a0a  ger", log_msg)..
+000312d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312e0: 2020 2020 7365 6c66 2e68 2e6c 6f63 5b66      self.h.loc[f
+000312f0: 2c20 2243 4446 225d 202a 3d20 6469 765b  , "CDF"] *= div[
+00031300: 2242 6163 6b20 4164 6a2e 225d 0a20 2020  "Back Adj."].   
+00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031320: 204c 6173 7444 6976 4164 6a75 7374 4474   LastDivAdjustDt
+00031330: 5f6e 6577 5b66 5d20 3d20 6e70 2e6d 6178  _new[f] = np.max
+00031340: 696d 756d 284c 6173 7444 6976 4164 6a75  imum(LastDivAdju
+00031350: 7374 4474 5f6e 6577 5b66 5d2c 2064 6976  stDt_new[f], div
+00031360: 5b22 4665 7463 6844 6174 6522 5d29 0a20  ["FetchDate"]). 
+00031370: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00031380: 685b 224c 6173 7444 6976 4164 6a75 7374  h["LastDivAdjust
+00031390: 4474 225d 203d 204c 6173 7444 6976 4164  Dt"] = LastDivAd
+000313a0: 6a75 7374 4474 5f6e 6577 0a0a 2020 2020  justDt_new..    
+000313b0: 2020 2020 2020 2020 685f 6d6f 6469 6669          h_modifi
+000313c0: 6564 203d 2054 7275 650a 0a20 2020 2020  ed = True..     
+000313d0: 2020 2069 6620 685f 6d6f 6469 6669 6564     if h_modified
+000313e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000313f0: 6c66 2e5f 7570 6461 7465 6443 6163 6865  lf._updatedCache
+00031400: 6450 7269 6365 7328 7365 6c66 2e68 290a  dPrices(self.h).
+00031410: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
+00031420: 203d 2022 504d 3a3a 5f61 7070 6c79 4e65   = "PM::_applyNe
+00031430: 7745 7665 6e74 7328 2920 7265 7475 726e  wEvents() return
+00031440: 696e 6722 0a20 2020 2020 2020 2069 6620  ing".        if 
+00031450: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00031460: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
+00031470: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+00031480: 7869 7428 6c6f 675f 6d73 6729 0a         xit(log_msg).
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_ticker.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_ticker.py`

 * *Files 1% similar despite different names*

```diff
@@ -124,15 +124,15 @@
                 raise Exception("'interval' if str must be one of: {}".format(yfcd.intervalStrToEnum.keys()))
             interval = yfcd.intervalStrToEnum[interval]
         if not isinstance(interval, yfcd.Interval):
             raise Exception("'interval' must be yfcd.Interval")
 
         start_d = None ; end_d = None
         start_dt = None ; end_dt = None
-        interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
+        interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week]#, yfcd.Interval.Months1, yfcd.Interval.Months3]
         if start is not None:
             start_dt, start_d = self._process_user_dt(start)
             if start_dt > dt_now:
                 return None
             if interval == yfcd.Interval.Week:
                 # Note: if start is on weekend then Yahoo can return weekly data starting
                 #       on Saturday. This breaks YFC, start must be Monday! So fix here:
@@ -159,18 +159,18 @@
             return None
 
         if max_age is None:
             if interval == yfcd.Interval.Days1:
                 max_age = datetime.timedelta(hours=4)
             elif interval == yfcd.Interval.Week:
                 max_age = datetime.timedelta(hours=60)
-            elif interval == yfcd.Interval.Months1:
-                max_age = datetime.timedelta(days=15)
-            elif interval == yfcd.Interval.Months3:
-                max_age = datetime.timedelta(days=45)
+            # elif interval == yfcd.Interval.Months1:
+            #     max_age = datetime.timedelta(days=15)
+            # elif interval == yfcd.Interval.Months3:
+            #     max_age = datetime.timedelta(days=45)
             else:
                 max_age = 0.5*yfcd.intervalToTimedelta[interval]
             if start is not None:
                 max_age = min(max_age, dt_now-start_dt)
 
         if period is not None:
             if isinstance(period, (datetime.timedelta, pd.Timedelta)):
@@ -357,15 +357,15 @@
 
         if exchange is None or tz_name is None:
             raise Exception(f"{self.ticker}: exchange and timezone not available")
         self._tz = tz_name
         self._exchange = exchange
         return self._exchange, self._tz
 
-    def verify_cached_prices(self, rtol=0.0001, vol_rtol=0.005, correct=False, discard_old=False, quiet=True, debug=False, debug_interval=None):
+    def verify_cached_prices(self, rtol=0.0001, vol_rtol=0.005, correct='none', discard_old=False, quiet=True, debug=False, debug_interval=None):
         if debug:
             quiet = False
         if debug_interval is not None and isinstance(debug_interval, str):
             debug_interval = yfcd.intervalStrToEnum[debug_interval]
 
         fn_locals = locals()
         del fn_locals["self"]
@@ -390,15 +390,15 @@
         if debug_interval == yfcd.Interval.Days1:
             yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v} (1st pass)")
             return v
         if not v:
             if debug or not correct:
                 yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v} (1st pass)")
                 return v
-        if correct:
+        if correct in ['one', 'all']:
             # Rows were removed so re-fetch. Only do for 1d data
             self.history(start=dt0.date(), quiet=quiet)
 
             # repeat verification, because 'fetch backporting' may be buggy
             v2 = self._verify_cached_prices_interval(interval, rtol, vol_rtol, correct, discard_old, quiet, debug)
             if not v2 and debug:
                 yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v2} (post-correction)")
@@ -426,15 +426,15 @@
             istr = yfcd.intervalToString[interval]
             cache_key = "history-"+istr
             if not yfcm.IsDatumCached(self.ticker, cache_key):
                 continue
             vi = self._verify_cached_prices_interval(interval, rtol, vol_rtol, correct, discard_old, quiet, debug)
             yfcl.TracePrint(f"{istr}: vi={vi}")
 
-            if not vi and correct:
+            if not vi and correct != 'all':
                 # Stop after correcting first problem, because user won't have been shown the next problem yet
                 yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {vi}")
                 return vi
 
             v = v and vi
 
         yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v}")
@@ -498,15 +498,15 @@
                 self._info['FetchDate'] = mod_dt
                 md['LastCheck'] = mod_dt
                 yfcm.StoreCacheDatum(self.ticker, "info", self._info, metadata=md)
 
             if self._info is not None:
                 if md is None:
                     md = {}
-                if not 'LastCheck' in md.keys():
+                if 'LastCheck' not in md.keys():
                     # Old bug meant this could happen
                     md['LastCheck'] = self._info['FetchDate']
                     yfcm.WriteCacheMetadata(self.ticker, "info", 'LastCheck', md['LastCheck'])
                 if max(self._info['FetchDate'], md['LastCheck']) + max_age > pd.Timestamp.now():
                     return self._info
 
         i = self.dat.info
@@ -777,15 +777,15 @@
     def quarterly_cashflow(self):
         return self._financials_manager.get_quarterly_cashflow()
 
     def get_earnings_dates(self, limit=12):
         return self._financials_manager.get_earnings_dates(limit)
 
     def get_release_dates(self, period='quarterly', as_df=False, check=True):
-        if not period in ['annual', 'quarterly']:
+        if period not in ['annual', 'quarterly']:
             raise ValueError(f'period argument must be "annual" or "quarterly", not "{period}"')
         if period == 'annual':
             period = yfcd.ReportingPeriod.Full
         else:
             period = yfcd.ReportingPeriod.Interim
 
         releases = self._financials_manager.get_release_dates(period, as_df, refresh=True, check=check)
@@ -905,14 +905,16 @@
 
 def verify_cached_tickers_prices(session=None, rtol=0.0001, vol_rtol=0.005, correct=False, halt_on_fail=True, resume_from_tkr=None, debug_tkr=None, debug_interval=None):
     """
     :Parameters:
         session:
             Recommend providing a 'requests_cache' session, in case
             you have to abort and resume verification (likely).
+        correct:
+            False, 'one', 'all'
         resume_from_tkr: str
             Resume verification from this ticker (alphabetical order).
             Because maybe you had to abort verification partway.
         debug_tkr: str
             Only verify this ticker.
             Because maybe you want to investigate a difference.
     """
@@ -920,17 +922,14 @@
     if debug_interval is not None and isinstance(debug_interval, str):
         if debug_interval not in yfcd.intervalStrToEnum.keys():
             raise Exception("'debug_interval' if str must be one of: {}".format(yfcd.intervalStrToEnum.keys()))
         debug_interval = yfcd.intervalStrToEnum[debug_interval]
 
     d = yfcm.GetCacheDirpath()
     tkrs = [x for x in os.listdir(d) if not x.startswith("exchange-") and os.path.isdir(os.path.join(d, x)) and '_' not in x]
-    # tkrs = tkrs[:5]
-    # tkrs = tkrs[:20]
-    # tkrs = tkrs[tkrs.index("DDOG"):]
 
     debug = debug_tkr is not None
     if debug_tkr is not None:
         debug_tkr = debug_tkr.upper()
         tkrs = [debug_tkr]
     else:
         tkrs = sorted(tkrs)
@@ -961,23 +960,24 @@
             t.set_description("Verifying " + tkr)
         else:
             print(f"{tkr} : {i+1}/{len(tkrs)}")
 
         dat = Ticker(tkr, session=session)
 
         try:
-            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=correct, quiet=not debug, debug=debug, debug_interval=debug_interval)
+            discard_old = correct in ['one', 'all']
+            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=discard_old, quiet=not debug, debug=debug, debug_interval=debug_interval)
         except yfcd.NoPriceDataInRangeException as e:
             print(str(e) + " - is it delisted? Aborting verification so you can investigate.")
             return
         if debug:
             return
 
-        if correct:
-            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=False, quiet=not debug, debug=debug, debug_interval=debug_interval)
+        if correct in ['one', 'all']:
+            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=False, quiet=True, debug=debug, debug_interval=debug_interval)
 
-        if not v:
+        if not v and correct != 'all':
             v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=False, discard_old=False, quiet=False, debug=True, debug_interval=debug_interval)
             if halt_on_fail:
                 raise Exception(f"{tkr}: verify failing")
             else:
                 print(f"{tkr}: verify failing")
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_time.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_time.py`

 * *Files 2% similar despite different names*

```diff
@@ -73,14 +73,43 @@
 
     d = yfcm.ReadCacheDatum("exchange-"+exchange, "yf_lag")
     if d is None:
         d = yfcd.exchangeToYfLag[exchange]
     return d
 
 
+def Simple247xcal(opens, closes):
+    yfcu.TypeCheckDatetimeIndex(opens, 'opens')
+    yfcu.TypeCheckDatetimeIndex(closes, 'closes')
+
+    # Use any xcal calendar as base
+    cal = xcal.get_calendar('NYSE')
+
+    cal._opens = opens
+    cal._closes = closes
+
+    cal.schedule = pd.DataFrame(data={"open":opens, "close":closes}, index=opens)
+    cal.schedule.index = cal.schedule.index.tz_localize(None)
+    cal.schedule['break_start'] = pd.NaT
+    cal.schedule['break_end'] = pd.NaT
+
+    cal.opens_nanos = np.array([x.value for x in opens])
+    cal.closes_nanos = np.array([x.value for x in closes])
+
+    cal._late_opens = []
+    cal._early_closes = []
+
+    cal._break_starts = None
+    cal._break_ends = None
+    cal.break_starts_nanos = cal.schedule['break_start'].values.astype(np.int64)
+    cal.break_ends_nanos = cal.schedule['break_end'].values.astype(np.int64)
+
+    return cal
+
+
 def JoinTwoXcals(cal1, cal2):
     # TODO: Check no overlap, and also they are close together implying no business days between
 
     if cal1.schedule.index[0] > cal2.schedule.index[0]:
         # Flip
         tmp = cal1
         cal1 = cal2
@@ -102,16 +131,14 @@
     cal12._closes = _safeAppend(cal1._closes, cal2._closes)
     #
     cal12.opens_nanos = _safeAppend(cal1.opens_nanos, cal2.opens_nanos)
     cal12.break_starts_nanos = _safeAppend(cal1.break_starts_nanos, cal2.break_starts_nanos)
     cal12.break_ends_nanos = _safeAppend(cal1.break_ends_nanos, cal2.break_ends_nanos)
     cal12.closes_nanos = _safeAppend(cal1.closes_nanos, cal2.closes_nanos)
     #
-    cal12.sessions_nanos = _safeAppend(cal1.sessions_nanos, cal2.sessions_nanos)
-    #
     cal12._late_opens = _safeAppend(cal1._late_opens, cal2._late_opens)
     cal12._early_closes = _safeAppend(cal1._early_closes, cal2._early_closes)
     #
     cal12.schedule = pd.concat([cal1.schedule, cal2.schedule])
 
     return cal12
 
@@ -137,15 +164,21 @@
     yfcu.TypeCheckYear(start, "start")
     if end is not None:
         yfcu.TypeCheckYear(end, "end")
     if end is None:
         end = date.today().year
 
     cache_key = "exchange-"+exchange
-    cal_name = yfcd.exchangeToXcalExchange[exchange]
+    if exchange == 'CCC':
+        # Binance, 24/7
+        cal_name = exchange
+    else:
+        if exchange not in yfcd.exchangeToXcalExchange:
+            raise Exception("Need to add mapping of exchange {} to xcal".format(exchange))
+        cal_name = yfcd.exchangeToXcalExchange[exchange]
 
     cal = None
 
     with exchanges_lock:
         if exchange not in exchange_locks:
             exchange_locks[exchange] = manager.Lock()
         exchange_lock = exchange_locks[exchange]
@@ -191,24 +224,34 @@
         else:
             pre_range = (start, end)
 
         # Fetch missing data
         if pre_range is not None:
             start = date(pre_range[0], 1, 1)
             end = date(pre_range[1], 12, 31)
-            pre_cal = xcal.get_calendar(cal_name, start=start, end=end)
+            if exchange == 'CCC':
+                opens = pd.date_range(start=start, end=end, freq='1d').tz_localize(ZoneInfo(GetExchangeTzName(exchange)))
+                ends = opens + pd.Timedelta('1d')
+                pre_cal = Simple247xcal(opens, ends)
+            else:
+                pre_cal = xcal.get_calendar(cal_name, start=start, end=end)
             pre_cal = _customModSchedule(pre_cal)
             if cal is None:
                 cal = pre_cal
             else:
                 cal = JoinTwoXcals(pre_cal, cal)
         if post_range is not None:
             start = date(post_range[0], 1, 1)
             end = date(post_range[1], 12, 31)
-            post_cal = xcal.get_calendar(cal_name, start=start, end=end)
+            if exchange == 'CCC':
+                opens = pd.date_range(start=start, end=end, freq='1d').tz_localize(ZoneInfo(GetExchangeTzName(exchange)))
+                ends = opens + pd.Timedelta('1d')
+                post_cal = Simple247xcal(opens, ends)
+            else:
+                post_cal = xcal.get_calendar(cal_name, start=start, end=end)
             post_cal = _customModSchedule(post_cal)
             if cal is None:
                 cal = post_cal
             else:
                 cal = JoinTwoXcals(cal, post_cal)
 
         # Write to cache
@@ -219,16 +262,14 @@
     return cal
 
 
 def ExchangeOpenOnDay(exchange, d):
     yfcu.TypeCheckStr(exchange, "exchange")
     yfcu.TypeCheckDateStrict(d, "d")
 
-    if exchange not in yfcd.exchangeToXcalExchange:
-        raise Exception("Need to add mapping of exchange {} to xcal".format(exchange))
     cal = GetCalendarViaCache(exchange, d)
 
     return d.isoformat() in cal.schedule.index
 
 
 # @lru_cache(maxsize=1000)  # changes index of returned dataframe from datetimeindex to index
 def GetExchangeSchedule(exchange, start_d, end_d):
@@ -240,17 +281,14 @@
 
     debug = False
     # debug = True
 
     if debug:
         print("GetExchangeSchedule(exchange={}, start_d={}, end_d={}".format(exchange, start_d, end_d))
 
-    if exchange not in yfcd.exchangeToXcalExchange:
-        raise Exception("Need to add mapping of exchange {} to xcal".format(exchange))
-
     end_d_sub1 = end_d - timedelta(days=1)
 
     # num_years = end_d.year - start_d.year + 1
     num_years = end_d_sub1.year - start_d.year + 1
     if num_years <= 2:
         # Cache
         cache_key = (exchange, start_d.year, num_years)
@@ -471,15 +509,15 @@
         print(f"MapPeriodToDates(exchange={exchange}, period={period}, interval={interval})")
 
     tz_name = GetExchangeTzName(exchange)
     tz_exchange = ZoneInfo(tz_name)
 
     # Map period to start->end range so logic can intelligently fetch missing data
     td_1d = timedelta(days=1)
-    dt_now = datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+    dt_now = pd.Timestamp.utcnow().replace(tzinfo=ZoneInfo("UTC"))
     d_now = dt_now.astimezone(tz_exchange).date()
     sched = GetExchangeSchedule(exchange, d_now-(7*td_1d), d_now+td_1d)
     yf_lag = yfcd.exchangeToYfLag[exchange]
     dt_now_sub_lag = dt_now - yf_lag
     if sched["open"].iloc[-1] > dt_now_sub_lag:
         # Discard days that haven't opened yet
         opens = pd.DatetimeIndex(sched["open"])
@@ -584,16 +622,14 @@
     if debug:
         print("- start_d={}, end_d={}".format(start_d, end_d))
 
     week_starts_sunday = (exchange in ["TLV"]) and (not week7days)
     if debug:
         print("- week_starts_sunday =", week_starts_sunday)
 
-    if exchange not in yfcd.exchangeToXcalExchange:
-        raise Exception("Need to add mapping of exchange {} to xcal".format(exchange))
     cal = GetCalendarViaCache(exchange, start_d, end_d)
 
     # When calculating intervals use dates not datetimes. Cache the result, and then
     # apply datetime limits.
     intervals = None
     istr = yfcd.intervalToString[interval]
     if istr.endswith('h') or istr.endswith('m'):
@@ -1435,15 +1471,15 @@
     yfcu.TypeCheckNpArray(ts, "ts")
     if len(ts) > 0:
         yfcu.TypeCheckIntervalDt(ts[0], interval, "ts", strict=False)
     yfcu.TypeCheckInterval(interval, "interval")
 
     n = len(ts)
 
-    interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
+    interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week]#, yfcd.Interval.Months1, yfcd.Interval.Months3]
     if interday:
         return np.full(n, False)
 
     itd = yfcd.intervalToTimedelta[interval]
     tss = pd.to_datetime(ts)
     df = pd.DataFrame(data={"_date": tss.date}, index=tss)
     cal = GetCalendarViaCache(exchange, df["_date"].iloc[0], df["_date"].iloc[-1])
@@ -1504,14 +1540,20 @@
     # For daily intervals, Yahoo data is updating until midnight. I guess aftermarket.
     if not intraday:
         # lastDataDt = start of next trading session, even if next day (or later)
         next_sesh = GetTimestampNextSession(exchange, intervalSched["close"].iloc[-1]-timedelta(minutes=1))
         if debug:
             print("- next_sesh:")
             print(next_sesh)
+        if i_td > timedelta(days=1):
+            # start of second trading day in next interval
+            next_sesh = GetTimestampNextSession(exchange, next_sesh['market_close']-timedelta(minutes=1))
+            if debug:
+                print("- next_sesh:")
+                print(next_sesh)
         lastDataDt = next_sesh["market_open"] + yf_lag
 
         # Attempt to handle Yahoo changing weekly interval data after the last market update.
         # Yes this also happens with daily but less often.
         # Also, I never see this happen on USA exchanges, but everywhere else.
         # if not intraday and interval != yfcd.Interval.Days1 and '.' in exchange:
         # Update: I've seen this happen to 1d interval on USA
@@ -1630,23 +1672,25 @@
     i_td = yfcd.intervalToTimedelta[interval]
     if i_td >= timedelta(days=1):
         # lastDataDt = start of next interval, even if next day (or later)
         next_intervals = GetTimestampNextInterval_batch(exchange, mcloses.to_numpy(), yfcd.Interval.Days1, discardTimes=False, ignore_breaks=ignore_breaks)
         if debug:
             print("- next_intervals:")
             print(next_intervals)
+
+        # Handle Yahoo changing weekly interval data after the last market update.
+        # Also happens with daily but less often.
+        if i_td > timedelta(days=1):
+            # Get next trading day after next
+            next_intervals = GetTimestampNextInterval_batch(exchange, (next_intervals['interval_close']-pd.Timedelta('1m')).to_numpy(), yfcd.Interval.Days1, discardTimes=False, ignore_breaks=ignore_breaks)
+
         lastDataDt = next_intervals["interval_open"].to_numpy() + yf_lag
         if f_na.any():
             lastDataDt[f_na] = pd.NaT
 
-        # Attempt to handle Yahoo changing weekly interval data after the last market update.
-        # Yes this also happens with daily but less often.
-        # Also, I never see this happen on USA exchanges, but everywhere else.
-        # if not intraday and interval != yfcd.Interval.Days1 and '.' in exchange:
-        # Update: I've seen this happen to 1d interval on USA
         lastDataDt += timedelta(hours=4)
 
         if debug:
             print("CalcIntervalLastDataDt_batch() returning")
         return lastDataDt
 
     # lastDataDt = start of next interval, even if next day (or later)
@@ -1962,17 +2006,7 @@
     elif period == yfcd.Period.Max:
         raise Exception("Codepath not implemented")
 
     else:
         # 'period' should be type Timedelta
         return dt - period
 
-
-def GetSystemTz():
-    dt = datetime.utcnow().astimezone()
-
-    tzn = dt.tzname()
-    if tzn == "BST":
-        # Confirmed that ZoneInfo figures out DST
-        tzn = "GB"
-    tz = ZoneInfo(tzn)
-    return tz
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_upgrade.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_upgrade.py`

 * *Files 26% similar despite different names*

```diff
@@ -21,7 +21,33 @@
         o.max_ages.calendar = '7d'
         o.max_ages.info = '180d'
 
     if not os.path.isdir(yfc_dp):
         os.makedirs(yfc_dp)
     with open(state_fp, 'w'):
         pass
+
+def _reset_cached_cals():
+    d = yfcm.GetCacheDirpath()
+    yfc_dp = os.path.join(d, "_YFC_")
+    state_fp = os.path.join(yfc_dp, "have-reset-cals")
+    if os.path.isfile(state_fp):
+        return
+
+    if not os.path.isdir(d):
+        if not os.path.isdir(yfc_dp):
+            os.makedirs(yfc_dp)
+        with open(state_fp, 'w'):
+            pass
+        return
+
+    import shutil
+    dp = yfcm.GetCacheDirpath()
+    for d in os.listdir(dp):
+        if d.startswith("exchange-"):
+            shutil.rmtree(os.path.join(dp, d))
+
+    if not os.path.isdir(yfc_dp):
+        os.makedirs(yfc_dp)
+    with open(state_fp, 'w'):
+        pass
+
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache/yfc_utils.py` & `yfinance_cache-0.6.3/yfinance_cache/yfc_utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -193,20 +193,30 @@
     elif isinstance(dt, date) and not isinstance(dt, datetime):
         d = dt
         dt = datetime.combine(dt, time(0), tz)
     elif not isinstance(dt, datetime):
         raise Exception("Argument 'dt' must be str, date or datetime")
     dt = dt.replace(tzinfo=tz) if dt.tzinfo is None else dt.astimezone(tz)
 
-    if d is None and dt.time() == datetime.time(0):
+    if d is None and dt.time() == time(0):
         d = dt.date()
 
     return dt, d
 
 
+def RDtoDO(rd):
+    # Convert a relativedelta to Pandas.DateOffset
+    return pd.DateOffset(years=rd.years,
+                         months=rd.months,
+                         days=rd.days,
+                         hours=rd.hours,
+                         minutes=rd.minutes,
+                         seconds=rd.seconds)
+
+
 def GetCSF0(df):
     if "Stock Splits" not in df:
         raise Exception("DataFrame does not contain column 'Stock Splits")
     if df.shape[0] == 0:
         raise Exception("DataFrame is empty")
 
     ss = df["Stock Splits"].copy()
@@ -333,21 +343,21 @@
             g["core end"] = s.index[groupEnds[i]-1].tz_localize(tz)
             g["fetch end"] = s.index[groupEnds[i]].tz_localize(tz)
         groups.append(g)
 
     return groups
 
 
-def VerifyPricesDf(h, df_yf, interval, rtol=0.0001, vol_rtol=0.005, quiet=False, debug=False):
+def VerifyPricesDf(h, df_yf, interval, rtol=0.0001, vol_rtol=0.005, exit_first_error=False, quiet=False, debug=False):
     if df_yf.empty:
         raise Exception("VerifyPricesDf() has been given empty df_yf")
 
     f_diff_all = pd.Series(np.full(h.shape[0], False), h.index)
 
-    interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
+    interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week]#, yfcd.Interval.Months1, yfcd.Interval.Months3]
     istr = yfcd.intervalToString[interval]
 
 
     # Test: no NaNs in dividends & stock splits
     f_na = h[["Dividends", "Stock Splits"]].isna().any(axis=1)
     if f_na.any():
         if not quiet:
@@ -387,18 +397,23 @@
     divs_bad = False
     if len(dts_missing_from_cache) > 0:
         if not quiet:
             print("WARNING: Dividends missing from cache:")
             print("- ", dts_missing_from_cache)
         for dt in dts_missing_from_cache:
             f_diff_all.loc[dt] = True
-        divs_bad = True
+        if exit_first_error:
+            return f_diff_all
     if len(dts_missing_from_yf) > 0 and not quiet:
         print("ERROR: Cache contains dividends missing from Yahoo:")
         print(dts_missing_from_yf)
+        for dt in dts_missing_from_yf:
+            f_diff_all.loc[dt] = True
+        if exit_first_error:
+            return f_diff_all
     # - now compare values
     h_divs = h_divs[h_divs.index.isin(yf_divs.index)]
     yf_divs = yf_divs[yf_divs.index.isin(h_divs.index)]
     f_close = np.isclose(h_divs[c].to_numpy(), yf_divs.to_numpy(), rtol=rtol)
     f_close = pd.Series(f_close, h_divs.index)
     f_diff = ~f_close
     if f_diff.any():
@@ -407,15 +422,16 @@
             print(f"WARNING: {istr}: {n_diff}/{n} differences in column {c}")
         df_diffs = h_divs[f_diff].join(yf_divs[f_diff], lsuffix="_cache", rsuffix="_yf")
         df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_yf"]
         df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_yf"]).round(1).astype(str) + '%'
         if not quiet:
             print(df_diffs)
         f_diff_all = f_diff_all | f_diff
-        divs_bad = True
+        if exit_first_error:
+            return f_diff_all
 
     # Verify stock splits
     # - first compare dates
     c = "Stock Splits"
     h_ss = h.loc[h[c] != 0.0, [c, "FetchDate"]].copy().dropna()
     yf_ss = df_yf.loc[df_yf[c] != 0.0, c]
     dts_missing_from_cache = yf_ss.index[~yf_ss.index.isin(h_ss.index)]
@@ -463,14 +479,16 @@
                     loose_tol = 0.1
                 f_diff[f_repair_mismatch] = ~np.isclose(df[c].to_numpy()[f_repair_mismatch], df_yf[c].to_numpy()[f_repair_mismatch], rtol=loose_tol)
 
         if f_diff.any():
             cols = ["FetchDate"]
             if "Adj" in column:
                 cols.append("LastDivAdjustDt")
+            else:
+                cols.append("LastSplitAdjustDt")
             cols.append("Repaired?")
             cols.append(c)
             # yahoo_cols = [c]
             yahoo_cols = [c, "Repaired?"]
             df_diffs = df.loc[f_diff, cols].join(df_yf.loc[f_diff, yahoo_cols], lsuffix="_cache", rsuffix="_yf")
             df_diffs.index = df_diffs.index.tz_convert(df.index[0].tz)
 
@@ -488,15 +506,18 @@
             df_diffs.loc[~f,"Repaired?"] += 'N'
             df_diffs = df_diffs.drop(["Repaired?_cache", "Repaired?_yf"], axis=1)
 
             df_diffs["FetchDate"] = df_diffs["FetchDate"].dt.tz_convert(df.index.tz)
             df_diffs["FetchDate"] = df_diffs["FetchDate"].dt.strftime("%Y-%m-%d %H:%M:%S%z")
             if "LastDivAdjustDt" in df_diffs.columns:
                 df_diffs["LastDivAdjustDt"] = df_diffs["LastDivAdjustDt"].dt.tz_convert(df.index.tz)
-                df_diffs["LastDivAdjustDt"] = df_diffs["LastDivAdjustDt"].dt.strftime("%Y-%m-%d %H:%M:%S%z")
+                df_diffs["LastDivAdjustDt"] = df_diffs["LastDivAdjustDt"].dt.strftime("%Y-%m-%d %H:%M:%S")
+            if "LastSplitAdjustDt" in df_diffs.columns:
+                df_diffs["LastSplitAdjustDt"] = df_diffs["LastSplitAdjustDt"].dt.tz_convert(df.index.tz)
+                df_diffs["LastSplitAdjustDt"] = df_diffs["LastSplitAdjustDt"].dt.strftime("%Y-%m-%d %H:%M:%S")
             if interday:
                 df_diffs.index = df_diffs.index.date
             f_diff_n = sum(f_diff)
             msg = f"WARNING: {istr}: {f_diff_n}/{n} sig. diffs in column {c} with rtol={rtol}"
             print(msg)
             print(df_diffs)
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache.egg-info/PKG-INFO` & `yfinance_cache-0.6.3/yfinance_cache.egg-info/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: yfinance-cache
-Version: 0.6.2
+Version: 0.6.3
 Summary: Smart caching wrapper for 'yfinance' module
 Home-page: https://github.com/ValueRaider/yfinance-cache
 Author: ValueRaider
 Author-email: ValueRaider@protonmail.com
 Project-URL: Bug Tracker, https://github.com/ValueRaider/yfinance-cache/issues
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
@@ -32,14 +32,18 @@
 Everything else cached once but never updated (unless you delete their files).
 
 Persistent cache stored in your user cache folder:
 - Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
 - Linux = /home/\<USER\>/.cache/py-yfinance-cache
 - MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
 
+## Install
+
+Available via PIP: `pip install yfinance_cache`
+
 ## Interface
 
 Interaction almost identical to yfinance, listed is attributes with auto-update:
 
 ```python
 import yfinance_cache as yfc
 
@@ -124,51 +128,59 @@
 Instead, YFC analyses earnings dates to determine exactly when next earnings will be, 
 or if Yahoo data is incomplete then YFC will predict.
 You can inspect this schedule in new function `dat.get_release_dates()`.
 
 ## Verifying cache
 
 Cached prices can be compared against latest Yahoo Finance data, and correct differences:
+
 ```python
 # Verify prices of one ticker symbol
 msft.verify_cached_prices(
 	rtol=0.0001,  # relative tolerance for differences
 	vol_rtol=0.005,  # relative tolerance specifically for Volume
-	correct=False,  # delete incorrect cached data?
+	correct=[False|'one'|'all'],  # delete incorrect cached data? 'one' = stop after correcting first incorrect prices table ; 'all' = correct all tickers & intervals
 	discard_old=False,  # if cached data too old to check (e.g. 30m), assume incorrect and delete?
 	quiet=True,  # enable to print nothing, disable to print summary detail of why cached data wrong
 	debug=False,  # enable even more detail for debugging 
 	debug_interval=None)  # only verify this interval (note: 1d always verified)
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
-	session=None,  # recommend you provide a requests_cache here
+	session=None,  # recommend you provide a requests_cache here if debugging
 	rtol=0.0001,
 	vol_rtol=0.005,
-	correct=False,
+	correct=[False|'one'|'all'],
 	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
-With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
+These return `False` if difference detected else `True`, regardless of if difference was corrected.
+
+- to scan for first data mismatch but not correct: `yfc.verify_cached_tickers_prices()`. 
 
-If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
+- to fix all data issues: `yfc.verify_cached_tickers_prices(correct='all', halt_on_fail=False)`
+
+I hope latest version 0.6.2 fixed the last bugs in applying new dividend-adjustments and splits to cached prices (`Adj Close` etc).
+Only genuine differences in not-adjusted prices are Volume differences (~0.5%) - 
+Yahoo sometimes changes Volume over 24 hours after that day ended e.g. updating Monday Volume on Wednesday, 
+sometimes weeks later!
+
+If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong.
+Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience.
+Cross-check against TradingView or stock exchange website.
 
 ## Performance
 
 For each ticker, YFC basically performs 2 tasks:
 
 1 - check if fetch needed
 
 2 - fetch data and integrate into cache
 
 Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
 
-## Installation
-
-Available on PIP: `pip install yfinance_cache`
-
 ## Limitations
 
 - intraday pre/post price data not available
```

### Comparing `yfinance_cache-0.6.2/yfinance_cache.egg-info/SOURCES.txt` & `yfinance_cache-0.6.3/yfinance_cache.egg-info/SOURCES.txt`

 * *Files identical despite different names*

